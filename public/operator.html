<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Touch? ‚Äî Painel Operacional</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#050508;--s1:#12121a;--s2:#1a1a24;--s3:#24243a;--t1:#f5f5f7;--t2:#a0a0b8;--t3:#666680;--ac:#6366f1;--ok:#34d399;--b1:rgba(255,255,255,.06);--b2:rgba(255,255,255,.1)}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;overflow:hidden}

.op-header{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1.2rem;background:rgba(18,18,26,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--b1);z-index:10;position:relative}
.op-logo{font-size:.85rem;font-weight:700;letter-spacing:.08em}.op-logo span{color:var(--ac)}
.op-stats{display:flex;gap:1rem;align-items:center;font-size:.72rem;color:var(--t2)}
.op-stat-num{font-weight:700;color:var(--ok);font-size:1rem}
.op-user{font-size:.68rem;color:var(--t3)}

.op-login{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;z-index:20;background:var(--bg)}
.op-login h1{font-size:1.8rem;font-weight:700;letter-spacing:.06em}.op-login h1 span{color:var(--ac)}
.op-login-sub{font-size:.75rem;color:var(--t3);max-width:300px;text-align:center;line-height:1.6}
.op-login-btn{padding:.8rem 2rem;background:var(--ac);border:none;border-radius:14px;color:#fff;font-size:.85rem;font-weight:600;font-family:inherit;cursor:pointer}

.op-main{display:flex;height:calc(100vh - 52px);position:relative}
.op-canvas-area{flex:1;position:relative;overflow:hidden}
.op-sidebar{width:320px;background:rgba(18,18,26,.95);backdrop-filter:blur(20px);border-left:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden}
@media(max-width:768px){
  .op-sidebar{position:absolute;bottom:0;left:0;right:0;width:100%;height:40vh;border-left:none;border-top:1px solid var(--b1);border-radius:20px 20px 0 0;z-index:5}
  .op-canvas-area{height:60vh}
}

#opCanvas{width:100%;height:100%;display:block}

/* Touch button */
.op-touch-wrap{position:absolute;bottom:2rem;left:50%;transform:translateX(-50%);z-index:5;display:flex;flex-direction:column;align-items:center;gap:.6rem}
.op-touch-btn{width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,var(--ac),#8b5cf6);border:3px solid rgba(255,255,255,.15);color:#fff;font-size:.75rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.1em;display:flex;align-items:center;justify-content:center;box-shadow:0 0 30px rgba(99,102,241,.3);transition:all .3s ease;position:relative;overflow:hidden}
.op-touch-btn:active{transform:scale(.93)}
.op-touch-btn.active{background:linear-gradient(135deg,#34d399,#059669);box-shadow:0 0 40px rgba(52,211,153,.5);border-color:rgba(52,211,153,.3)}
.op-touch-btn.active::after{content:'';position:absolute;inset:-4px;border-radius:50%;border:2px solid rgba(52,211,153,.4);animation:op-ring 2s ease-out infinite}
@keyframes op-ring{0%{transform:scale(1);opacity:.6}100%{transform:scale(1.5);opacity:0}}
.op-touch-status{font-size:.65rem;color:var(--t3);text-align:center;min-height:1.2em}
.op-touch-status.ok{color:var(--ok)}
.op-code{font-size:.85rem;font-weight:600;color:var(--ac);letter-spacing:.12em;background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.2);padding:.2rem .6rem;border-radius:8px}

/* Sidebar */
.op-sb-header{padding:.8rem 1rem;border-bottom:1px solid var(--b1);font-size:.72rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;font-weight:600;display:flex;justify-content:space-between}
.op-sb-list{flex:1;overflow-y:auto;padding:.5rem}
.op-checkin-item{display:flex;align-items:center;gap:.7rem;padding:.6rem .5rem;border-bottom:1px solid rgba(255,255,255,.03);animation:op-slide-in .5s cubic-bezier(.22,1,.36,1)}
@keyframes op-slide-in{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.op-ci-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;color:#fff;flex-shrink:0}
.op-ci-info{flex:1;min-width:0}
.op-ci-name{font-size:.78rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.op-ci-time{font-size:.6rem;color:var(--t3)}
.op-ci-badge{font-size:.55rem;padding:.15rem .4rem;border-radius:6px;font-weight:600}
.op-ci-badge.revealed{background:rgba(52,211,153,.1);color:#34d399;border:1px solid rgba(52,211,153,.2)}
.op-ci-badge.anon{background:rgba(255,255,255,.04);color:var(--t3);border:1px solid var(--b1)}
.op-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:.8rem;color:var(--t3);padding:2rem}
.op-empty-ico{font-size:2.5rem;opacity:.4}
.op-empty-text{font-size:.72rem;text-align:center;line-height:1.6;max-width:240px}
</style>
</head>
<body>

<div class="op-login" id="opLogin">
  <h1>Touch<span>?</span></h1>
  <div class="op-login-sub">Painel Operacional<br>Check-in em tempo real para eventos e estabelecimentos</div>
  <button class="op-login-btn" onclick="opDoLogin()">Entrar com Google</button>
</div>

<div style="display:none" id="opApp">
  <div class="op-header">
    <div class="op-logo">Touch<span>?</span> Operador</div>
    <div class="op-stats">
      <div><span class="op-stat-num" id="opCount">0</span> check-ins</div>
      <div class="op-user" id="opUserName"></div>
    </div>
  </div>
  <div class="op-main">
    <div class="op-canvas-area">
      <canvas id="opCanvas"></canvas>
      <div class="op-touch-wrap">
        <button class="op-touch-btn" id="opTouchBtn" onclick="opToggleTouch()">TOUCH</button>
        <div class="op-touch-status" id="opStatus"></div>
        <div class="op-code" id="opCode" style="display:none"></div>
      </div>
    </div>
    <div class="op-sidebar">
      <div class="op-sb-header"><span>Check-ins</span><span id="opListCount">0</span></div>
      <div class="op-sb-list" id="opList">
        <div class="op-empty" id="opEmpty">
          <div class="op-empty-ico">üì°</div>
          <div class="op-empty-text">Toque em TOUCH para come√ßar a emitir.<br>As pessoas encostam o celular e aparecem aqui.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
const S={userId:null,userName:null,userColor:null,socket:null,checkins:[]};
let sonicOn=false,sonicFreq=0,sonicOsc=null,sonicEmitCtx=null,sonicMicCtx=null,sonicStream=null,sonicAnalyser=null,sonicAnimFrame=null;
let audioCtx=null;
const SONIC_FFT=8192,SONIC_THRESHOLD=80,SONIC_CONFIRMS=3;

// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
(async function(){
  const r=await fetch('/api/firebase-config');const cfg=await r.json();
  firebase.initializeApp(cfg);
  firebase.auth().onAuthStateChanged(async user=>{
    if(user){
      S.userId=user.uid;
      try{const ur=await fetch('/api/user/'+user.uid);const ud=await ur.json();S.userName=ud.nickname||ud.name||user.displayName||'Operador';S.userColor=ud.color||'#6366f1'}
      catch(e){S.userName=user.displayName||'Operador';S.userColor='#6366f1'}
      $('opLogin').style.display='none';$('opApp').style.display='';
      $('opUserName').textContent=S.userName;
      initSocket();initCanvas();loadExisting();
    }else{$('opLogin').style.display='';$('opApp').style.display='none'}
  });
})();
function opDoLogin(){firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert('Erro: '+e.message))}
function $(id){return document.getElementById(id)}

// ‚ïê‚ïê‚ïê SOCKET ‚ïê‚ïê‚ïê
function initSocket(){
  S.socket=io({reconnection:true,reconnectionDelay:1000});
  S.socket.on('connect',()=>{if(S.userId)S.socket.emit('identify',S.userId)});
  S.socket.on('checkin-created',d=>{addCheckin(d);playBeep()});
  S.socket.on('relation-created',d=>{
    if(d.isCheckin){
      const other=d.userA.id===S.userId?d.userB:d.userA;
      addCheckin({userId:other.id,nickname:other.name,color:other.color,profilePhoto:other.profilePhoto||other.photoURL,timestamp:Date.now()});
      playBeep();
    }
  });
}

// ‚ïê‚ïê‚ïê SONIC TOUCH ‚Äî TOGGLE ON/OFF ‚ïê‚ïê‚ïê
async function opToggleTouch(){
  if(sonicOn){stopSonic();return}
  const btn=$('opTouchBtn'),status=$('opStatus'),code=$('opCode');
  btn.textContent='...';status.textContent='Pedindo microfone...';status.className='op-touch-status';

  try{
    // 1. Request microphone (triggers browser permission dialog)
    sonicStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
    status.textContent='Microfone OK. Conectando...';

    // 2. Ask server for frequency
    S.socket.emit('sonic-start',{userId:S.userId,isCheckin:true});
    sonicFreq=await new Promise((resolve,reject)=>{
      const t=setTimeout(()=>reject(new Error('Server timeout')),5000);
      S.socket.once('sonic-assigned',({freq})=>{clearTimeout(t);resolve(freq)});
    });

    // 3. Start emitting ultrasonic tone
    sonicEmitCtx=new(window.AudioContext||window.webkitAudioContext)();
    sonicOsc=sonicEmitCtx.createOscillator();
    sonicOsc.type='sine';
    sonicOsc.frequency.setValueAtTime(sonicFreq,sonicEmitCtx.currentTime);
    const gain=sonicEmitCtx.createGain();
    gain.gain.setValueAtTime(0.8,sonicEmitCtx.currentTime);
    sonicOsc.connect(gain);gain.connect(sonicEmitCtx.destination);
    sonicOsc.start();

    // 4. Start listening for other devices
    sonicMicCtx=new(window.AudioContext||window.webkitAudioContext)();
    const source=sonicMicCtx.createMediaStreamSource(sonicStream);
    sonicAnalyser=sonicMicCtx.createAnalyser();
    sonicAnalyser.fftSize=SONIC_FFT;
    sonicAnalyser.smoothingTimeConstant=0.3;
    source.connect(sonicAnalyser);
    const bufLen=sonicAnalyser.frequencyBinCount;
    const dataArr=new Uint8Array(bufLen);
    const sampleRate=sonicMicCtx.sampleRate;
    const freqPerBin=sampleRate/SONIC_FFT;

    sonicOn=true;
    btn.classList.add('active');btn.textContent='ON';
    status.textContent='Emitindo... aguardando celulares';status.className='op-touch-status ok';
    code.style.display='';code.textContent='Freq: '+sonicFreq+'Hz';

    // Also create a manual session as fallback
    try{
      const r=await fetch('/api/session/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:S.userId,isCheckin:true})});
      const d=await r.json();
      S.socket.emit('join-session',d.sessionId);
      code.textContent=d.code+' ¬∑ '+sonicFreq+'Hz';
    }catch(e){}

    // 5. Detection loop
    let confirmHits=0,lastSnapped=0;
    function detect(){
      if(!sonicOn)return;
      sonicAnalyser.getByteFrequencyData(dataArr);
      const minBin=Math.floor(18000/freqPerBin),maxBin=Math.ceil(20000/freqPerBin);
      let peakVal=0,peakBin=0;
      for(let i=minBin;i<=maxBin&&i<bufLen;i++){if(dataArr[i]>peakVal){peakVal=dataArr[i];peakBin=i}}
      if(peakVal>=SONIC_THRESHOLD){
        const det=Math.round(peakBin*freqPerBin);
        const snapped=Math.round(det/100)*100;
        if(snapped!==sonicFreq&&snapped>=18000&&snapped<=19900){
          if(snapped===lastSnapped)confirmHits++;else{confirmHits=1;lastSnapped=snapped}
          if(confirmHits>=SONIC_CONFIRMS){
            S.socket.emit('sonic-detected',{userId:S.userId,detectedFreq:snapped});
            confirmHits=0;lastSnapped=0;
            // Flash the button
            btn.style.boxShadow='0 0 60px rgba(52,211,153,.8)';
            setTimeout(()=>{if(sonicOn)btn.style.boxShadow=''},800);
          }
        }
      }else{if(confirmHits>0)confirmHits=Math.max(0,confirmHits-1)}
      sonicAnimFrame=requestAnimationFrame(detect);
    }
    detect();

  }catch(e){
    console.error('Sonic error:',e);
    status.textContent=e.name==='NotAllowedError'?'Permiss√£o do microfone negada':'Erro: '+e.message;
    status.className='op-touch-status';
    btn.textContent='TOUCH';
    stopSonic();
  }
}

function stopSonic(){
  sonicOn=false;
  if(sonicOsc)try{sonicOsc.stop()}catch(e){}
  if(sonicEmitCtx)try{sonicEmitCtx.close()}catch(e){}
  if(sonicMicCtx)try{sonicMicCtx.close()}catch(e){}
  if(sonicStream)sonicStream.getTracks().forEach(t=>t.stop());
  if(sonicAnimFrame)cancelAnimationFrame(sonicAnimFrame);
  sonicOsc=null;sonicEmitCtx=null;sonicMicCtx=null;sonicStream=null;sonicAnalyser=null;sonicAnimFrame=null;sonicFreq=0;
  if(S.socket&&S.socket.connected)S.socket.emit('sonic-stop',{userId:S.userId});
  const btn=$('opTouchBtn');
  btn.classList.remove('active');btn.textContent='TOUCH';btn.style.boxShadow='';
  $('opStatus').textContent='Desligado';$('opStatus').className='op-touch-status';
  $('opCode').style.display='none';
}

// ‚ïê‚ïê‚ïê CHECK-INS ‚ïê‚ïê‚ïê
function addCheckin(d){
  S.checkins.unshift(d);
  $('opCount').textContent=S.checkins.length;
  $('opListCount').textContent=S.checkins.length;
  $('opEmpty').style.display='none';
  // Flash status
  const st=$('opStatus');
  st.textContent='‚úì '+d.nickname+' fez check-in!';st.className='op-touch-status ok';
  setTimeout(()=>{if(sonicOn)st.textContent='Emitindo... aguardando celulares'},3000);
  // Sidebar item
  const list=$('opList');
  const item=document.createElement('div');
  item.className='op-checkin-item';
  const time=new Date(d.timestamp);
  const ts=time.getHours().toString().padStart(2,'0')+':'+time.getMinutes().toString().padStart(2,'0');
  const col=d.color||nickColor(d.nickname||'?');
  item.innerHTML='<div class="op-ci-avatar" style="background:'+col+'">'+ini(d.nickname||'?')+'</div>'
    +'<div class="op-ci-info"><div class="op-ci-name">'+esc(d.nickname||'Visitante')+'</div><div class="op-ci-time">'+ts+'</div></div>'
    +'<div class="op-ci-badge anon">check-in</div>';
  list.prepend(item);
  addNode(d);
}

async function loadExisting(){
  try{
    const r=await fetch('/api/operator/checkins/'+S.userId);const d=await r.json();
    if(d.checkins&&d.checkins.length>0){
      $('opEmpty').style.display='none';
      d.checkins.forEach(c=>{
        S.checkins.push(c);
        const list=$('opList');const item=document.createElement('div');
        item.className='op-checkin-item';item.style.animation='none';
        const time=new Date(c.timestamp);
        const ts=time.getHours().toString().padStart(2,'0')+':'+time.getMinutes().toString().padStart(2,'0');
        const col=c.withColor||nickColor(c.withName||'?');
        item.innerHTML='<div class="op-ci-avatar" style="background:'+col+'">'+ini(c.withName||'?')+'</div>'
          +'<div class="op-ci-info"><div class="op-ci-name">'+esc(c.withName||'Visitante')+'</div><div class="op-ci-time">'+ts+'</div></div>'
          +'<div class="op-ci-badge '+(c.revealed?'revealed':'anon')+'">'+(c.revealed?'revelado':'check-in')+'</div>';
        list.appendChild(item);
        addNode({nickname:c.withName,color:c.withColor,timestamp:c.timestamp},true);
      });
      $('opCount').textContent=S.checkins.length;
      $('opListCount').textContent=S.checkins.length;
    }
  }catch(e){}
}

// ‚ïê‚ïê‚ïê CANVAS ‚ïê‚ïê‚ïê
let ctx=null,W=0,H=0,cAnim=null;
const nodes=[],particles=[];

function initCanvas(){
  const cv=$('opCanvas');
  const rect=cv.parentElement.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  W=rect.width;H=rect.height;
  cv.width=W*dpr;cv.height=H*dpr;
  cv.style.width=W+'px';cv.style.height=H+'px';
  ctx=cv.getContext('2d');ctx.scale(dpr,dpr);
  // Seed ambient particles
  for(let i=0;i<40;i++)particles.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.5+.5,vx:(Math.random()-.5)*.15,vy:(Math.random()-.5)*.15,a:Math.random()*.3+.05});
  render();
}

function addNode(d,instant){
  // Arrange in a spiral from center
  const idx=nodes.length;
  const goldenAngle=2.399963;
  const angle=idx*goldenAngle;
  const maxR=Math.min(W,H)*0.35;
  const dist=30+Math.sqrt(idx)*maxR*0.12;
  const cx=W/2,cy=H/2-40;
  nodes.push({
    x:cx+Math.cos(angle)*dist,y:cy+Math.sin(angle)*dist,
    r:instant?10:0,targetR:8+Math.random()*5,
    color:d.color||nickColor(d.nickname||'?'),
    name:d.nickname||'?',
    phase:Math.random()*Math.PI*2,
    born:instant?0:Date.now(),
    glow:instant?0:1
  });
  // Burst particles on new checkin
  if(!instant){
    const nx=cx+Math.cos(angle)*dist,ny=cy+Math.sin(angle)*dist;
    for(let i=0;i<12;i++){
      const a=Math.random()*Math.PI*2;
      particles.push({x:nx,y:ny,r:2+Math.random()*2,vx:Math.cos(a)*(1+Math.random()*2),vy:Math.sin(a)*(1+Math.random()*2),a:1,decay:.02,color:d.color||nickColor(d.nickname||'?')});
    }
  }
}

function render(){
  if(!ctx)return;
  ctx.clearRect(0,0,W,H);
  const t=Date.now()/1000;
  const cx=W/2,cy=H/2-40;

  // Ambient particles
  particles.forEach((p,i)=>{
    p.x+=p.vx;p.y+=p.vy;
    if(p.decay){p.a-=p.decay;if(p.a<=0){particles.splice(i,1);return}}
    else{if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0}
    ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    const c=p.color||'255,255,255';
    ctx.fillStyle=p.color?p.color.replace(')',','+p.a+')').replace('hsl','hsla'):'rgba(255,255,255,'+p.a+')';
    ctx.fill();
  });

  // Connection lines (subtle)
  nodes.forEach(n=>{
    if(n.r<1)return;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(n.x,n.y);
    const grad=ctx.createLinearGradient(cx,cy,n.x,n.y);
    grad.addColorStop(0,'rgba(99,102,241,.08)');grad.addColorStop(1,n.color.includes('hsl')?n.color.replace(')',',0.12)').replace('hsl','hsla'):'rgba(255,255,255,.06)');
    ctx.strokeStyle=grad;ctx.lineWidth=1;ctx.stroke();
  });

  // Center node (operator) with pulse rings
  if(sonicOn){
    const ringScale=1+Math.sin(t*3)*.15;
    ctx.beginPath();ctx.arc(cx,cy,24*ringScale,0,Math.PI*2);
    ctx.strokeStyle='rgba(52,211,153,.12)';ctx.lineWidth=1;ctx.stroke();
    ctx.beginPath();ctx.arc(cx,cy,32*ringScale,0,Math.PI*2);
    ctx.strokeStyle='rgba(52,211,153,.06)';ctx.stroke();
  }
  ctx.beginPath();ctx.arc(cx,cy,20,0,Math.PI*2);
  ctx.fillStyle=sonicOn?'#34d399':(S.userColor||'#6366f1');ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,.2)';ctx.lineWidth=2;ctx.stroke();
  ctx.fillStyle='#fff';ctx.font='600 9px Inter';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(ini(S.userName||'OP'),cx,cy);

  // Nodes
  nodes.forEach(n=>{
    // Animate grow
    if(n.r<n.targetR)n.r=Math.min(n.targetR,n.r+.4);
    const pulse=1+Math.sin(t*1.2+n.phase)*0.05;
    const r=n.r*pulse;

    // Glow on new nodes
    if(n.glow>0){
      const glowR=r*4*n.glow;
      const g=ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,glowR);
      g.addColorStop(0,n.color.includes('hsl')?n.color.replace(')',',0.3)').replace('hsl','hsla'):'rgba(99,102,241,.3)');
      g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=g;ctx.beginPath();ctx.arc(n.x,n.y,glowR,0,Math.PI*2);ctx.fill();
      n.glow=Math.max(0,n.glow-.008);
    }

    // Circle
    ctx.beginPath();ctx.arc(n.x,n.y,r,0,Math.PI*2);
    ctx.fillStyle=n.color;ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.12)';ctx.lineWidth=1;ctx.stroke();

    // Initials
    if(r>6){
      ctx.fillStyle='#fff';ctx.font='500 '+(r*.65)+'px Inter';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(ini(n.name),n.x,n.y+.5);
    }

    // Name label below
    if(r>8){
      ctx.fillStyle='rgba(255,255,255,.35)';ctx.font='400 6px Inter';
      ctx.fillText(n.name.length>10?n.name.slice(0,10)+'‚Ä¶':n.name,n.x,n.y+r+8);
    }
  });

  cAnim=requestAnimationFrame(render);
}

window.addEventListener('resize',()=>{if($('opApp').style.display!=='none'){if(cAnim)cancelAnimationFrame(cAnim);initCanvas()}});

// ‚ïê‚ïê‚ïê AUDIO ‚ïê‚ïê‚ïê
function playBeep(){
  if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended')audioCtx.resume();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.connect(g);g.connect(audioCtx.destination);o.type='sine';
  const tm=audioCtx.currentTime;
  o.frequency.setValueAtTime(523,tm);o.frequency.linearRampToValueAtTime(659,tm+.1);o.frequency.linearRampToValueAtTime(784,tm+.2);
  g.gain.setValueAtTime(.15,tm);g.gain.linearRampToValueAtTime(0,tm+.4);
  o.start(tm);o.stop(tm+.4);
}

// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function ini(n){if(!n)return'?';const p=n.trim().split(/\s+/);return p.length>1?(p[0][0]+p[1][0]).toUpperCase():n.slice(0,2).toUpperCase()}
function nickColor(n){let h=0;for(let i=0;i<n.length;i++)h=n.charCodeAt(i)+((h<<5)-h);return'hsl('+Math.abs(h%360)+',65%,45%)'}
</script>
</body>
</html>
