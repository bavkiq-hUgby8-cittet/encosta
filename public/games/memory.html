<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jogo da Memória - Touch?</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0a0f;
      --s1: #12121a;
      --s2: #1a1a24;
      --b1: rgba(255,255,255,.08);
      --t1: #f5f5f7;
      --t2: #8888a0;
      --t3: #555568;
      --ac: #ff6b35;
      --ac2: #ff8f65;
      --ok: #34d399;
      --err: #f87171;
      --gap: 12px;
      --card-size: min(80px, 18vw);
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background-color: var(--bg);
      color: var(--t1);
      overflow: hidden;
    }

    .game-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: linear-gradient(135deg, var(--bg) 0%, var(--s1) 100%);
    }

    /* ═════ HEADER ═════ */
    .game-header {
      padding: 16px;
      border-bottom: 1px solid var(--b1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      background-color: var(--s2);
    }

    .g-status {
      font-size: 14px;
      color: var(--t2);
      font-weight: 500;
    }

    .g-status.multiplayer {
      color: var(--ac);
      font-weight: 600;
    }

    .g-score {
      font-size: 18px;
      font-weight: 700;
      color: var(--t1);
      min-width: 100px;
      text-align: right;
    }

    .scores-container {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .player-score {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .player-score-label {
      font-size: 11px;
      color: var(--t3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .player-score-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--t1);
    }

    .player-score.opponent .player-score-value {
      color: var(--t2);
    }

    .player-score.current::before {
      content: '';
      display: block;
      width: 6px;
      height: 6px;
      background-color: var(--ac);
      border-radius: 50%;
      margin-bottom: 4px;
    }

    /* ═════ GAME BOARD ═════ */
    .game-board-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: auto;
    }

    .game-board {
      display: grid;
      grid-template-columns: repeat(4, var(--card-size));
      gap: var(--gap);
      max-width: 100%;
    }

    /* ═════ CARDS ═════ */
    .card {
      width: var(--card-size);
      height: var(--card-size);
      min-width: 44px;
      min-height: 44px;
      cursor: pointer;
      background: none;
      border: none;
      perspective: 1000px;
      position: relative;
      transition: transform 0.2s ease;
    }

    .card:active {
      transform: scale(0.95);
    }

    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      transform-style: preserve-3d;
    }

    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }

    .card.matched .card-inner {
      animation: matched-glow 0.4s ease forwards;
    }

    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 32px;
    }

    .card-back {
      background: linear-gradient(135deg, var(--s2) 0%, var(--s1) 100%);
      border: 2px solid var(--b1);
      color: var(--t2);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      position: relative;
      overflow: hidden;
    }

    .card-back::before {
      content: 'T?';
      position: absolute;
      font-size: 28px;
      font-weight: 900;
      color: var(--ac);
      opacity: 0.15;
      transform: rotate(-20deg);
    }

    .card-front {
      background: linear-gradient(135deg, var(--s1) 0%, var(--s2) 100%);
      border: 2px solid var(--b1);
      color: var(--ac);
      box-shadow: 0 8px 24px rgba(255, 107, 53, 0.2);
      backface-visibility: hidden;
      transform: rotateY(180deg);
    }

    .card.matched .card-front {
      animation: glow-pulse 1.5s ease-in-out infinite;
      border-color: var(--ok);
      color: var(--ok);
    }

    @keyframes matched-glow {
      0% {
        transform: rotateY(180deg) scale(1);
      }
      50% {
        transform: rotateY(180deg) scale(1.08);
      }
      100% {
        transform: rotateY(180deg) scale(1);
      }
    }

    @keyframes glow-pulse {
      0%, 100% {
        box-shadow: 0 8px 24px rgba(52, 211, 153, 0.2);
      }
      50% {
        box-shadow: 0 8px 32px rgba(52, 211, 153, 0.4);
      }
    }

    /* ═════ SVG ICONS ═════ */
    .card-icon {
      width: 100%;
      height: 100%;
    }

    /* ═════ FOOTER ═════ */
    .game-footer {
      padding: 16px;
      border-top: 1px solid var(--b1);
      display: flex;
      gap: 12px;
      background-color: var(--s2);
      justify-content: center;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-primary {
      background-color: var(--ac);
      color: white;
    }

    .btn-primary:active {
      transform: scale(0.98);
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }

    .btn-secondary {
      background-color: var(--s1);
      color: var(--t2);
      border: 1px solid var(--b1);
    }

    .btn-secondary:active {
      background-color: var(--s2);
      transform: scale(0.98);
    }

    /* ═════ WIN MODAL ═════ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
      display: flex;
      animation: modal-fade-in 0.3s ease;
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal {
      background: linear-gradient(135deg, var(--s2) 0%, var(--s1) 100%);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      max-width: 90%;
      width: 320px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      animation: modal-bounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      border: 1px solid var(--b1);
    }

    @keyframes modal-bounce {
      0% {
        transform: scale(0.8) translateY(20px);
        opacity: 0;
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .modal h2 {
      font-size: 28px;
      margin-bottom: 12px;
      color: var(--ok);
      font-weight: 700;
    }

    .modal-stats {
      text-align: left;
      background-color: var(--s1);
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
      border: 1px solid var(--b1);
    }

    .modal-stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 14px;
      color: var(--t2);
    }

    .modal-stat-row strong {
      color: var(--t1);
      font-weight: 600;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .modal-buttons .btn {
      flex: 1;
    }

    /* ═════ RESPONSIVE ═════ */
    @media (max-width: 480px) {
      :root {
        --card-size: min(70px, 20vw);
      }

      .game-header {
        flex-wrap: wrap;
        gap: 12px;
      }

      .scores-container {
        width: 100%;
        gap: 16px;
      }

      .g-status {
        flex: 1;
      }

      .g-score {
        min-width: auto;
      }

      .modal {
        width: 90%;
        padding: 32px 20px;
      }

      .btn {
        padding: 10px 16px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="game-header">
      <div class="g-status">Jogo da Memória</div>
      <div class="scores-container">
        <div class="player-score current" id="player-score">
          <div class="player-score-label">Sua Pontuação</div>
          <div class="player-score-value">0</div>
        </div>
        <div class="player-score opponent" id="opponent-score" style="display: none;">
          <div class="player-score-label">Oponente</div>
          <div class="player-score-value">0</div>
        </div>
      </div>
    </div>

    <div class="game-board-wrapper">
      <div class="game-board" id="game-board"></div>
    </div>

    <div class="game-footer">
      <button class="btn btn-secondary" id="btn-quit">Desistir</button>
      <button class="btn btn-primary" id="btn-new-game">Novo Jogo</button>
    </div>
  </div>

  <div class="modal-overlay" id="win-modal">
    <div class="modal">
      <h2>Parabéns!</h2>
      <p style="color: var(--t2); margin-bottom: 16px;">Você encontrou todos os pares!</p>
      <div class="modal-stats">
        <div class="modal-stat-row">
          <span>Pares encontrados:</span>
          <strong id="modal-pairs">8</strong>
        </div>
        <div class="modal-stat-row">
          <span>Movimentos:</span>
          <strong id="modal-moves">0</strong>
        </div>
        <div class="modal-stat-row">
          <span>Tempo:</span>
          <strong id="modal-time">0s</strong>
        </div>
        <div class="modal-stat-row" style="border-top: 1px solid var(--b1); padding-top: 12px; margin-top: 12px; font-size: 16px;">
          <span>Pontuação:</span>
          <strong style="color: var(--ok); font-size: 18px;" id="modal-score">0</strong>
        </div>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" id="modal-btn-quit">Sair</button>
        <button class="btn btn-primary" id="modal-btn-new">Novo Jogo</button>
      </div>
    </div>
  </div>

  <script src="/games/core/bridge.js"></script>

  <script>
    class MemoryGame {
      constructor() {
        this.cards = [];
        this.flipped = [];
        this.matched = new Set();
        this.moves = 0;
        this.startTime = null;
        this.isProcessing = false;
        this.isMultiplayer = !!touchBridge.opponentId;
        this.isMyTurn = true;
        this.myScore = 0;
        this.opponentScore = 0;

        this.icons = [
          { id: 'star', name: 'Estrela' },
          { id: 'heart', name: 'Coração' },
          { id: 'diamond', name: 'Diamante' },
          { id: 'moon', name: 'Lua' },
          { id: 'sun', name: 'Sol' },
          { id: 'lightning', name: 'Raio' },
          { id: 'leaf', name: 'Folha' },
          { id: 'note', name: 'Nota Musical' }
        ];

        this.initGame();
        this.attachEventListeners();
        this.setupBridge();
      }

      initGame() {
        this.cards = [];
        this.flipped = [];
        this.matched = new Set();
        this.moves = 0;
        this.startTime = Date.now();
        this.isProcessing = false;
        this.isMyTurn = !this.isMultiplayer || true;

        if (!this.isMultiplayer) {
          this.myScore = 0;
          this.opponentScore = 0;
        }

        this.createCards();
        this.shuffle();
        this.render();
      }

      createCards() {
        const deck = [];
        for (let i = 0; i < this.icons.length; i++) {
          deck.push(this.icons[i]);
          deck.push(this.icons[i]);
        }
        this.cards = deck;
      }

      shuffle() {
        for (let i = this.cards.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
        }
      }

      render() {
        const board = document.getElementById('game-board');
        board.innerHTML = '';

        this.cards.forEach((card, index) => {
          const cardEl = document.createElement('button');
          cardEl.className = 'card';
          cardEl.dataset.index = index;

          if (this.flipped.includes(index) || this.matched.has(index)) {
            cardEl.classList.add('flipped');
          }

          if (this.matched.has(index)) {
            cardEl.classList.add('matched');
          }

          const inner = document.createElement('div');
          inner.className = 'card-inner';

          const back = document.createElement('div');
          back.className = 'card-face card-back';
          back.innerHTML = '';

          const front = document.createElement('div');
          front.className = 'card-face card-front';
          front.innerHTML = this.getSVGIcon(card.id);

          inner.appendChild(back);
          inner.appendChild(front);
          cardEl.appendChild(inner);

          board.appendChild(cardEl);
        });

        this.updateStatus();
      }

      getSVGIcon(iconId) {
        const icons = {
          star: `<svg class="card-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>`,
          heart: `<svg class="card-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>`,
          diamond: `<svg class="card-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l8 8-8 12-8-12 8-8z"/>
          </svg>`,
          moon: `<svg class="card-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>`,
          sun: `<svg class="card-icon" viewBox="0 0 24 24" fill="currentColor">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="1" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="21" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>`,
          lightning: `<svg class="card-icon" viewBox="0 0 24 24" fill="currentColor">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
          </svg>`,
          leaf: `<svg class="card-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2c-6.6 0-11 4.4-11 11s4.4 11 11 11 11-4.4 11-11-4.4-11-11-11zm0 20c-4.9 0-9-4.1-9-9s4.1-9 9-9 9 4.1 9 9-4.1 9-9 9zm3.5-9c.8 0 1.5-.7 1.5-1.5S16.3 10 15.5 10 14 10.7 14 11.5s.7 1.5 1.5 1.5zm-7 0c.8 0 1.5-.7 1.5-1.5S9.3 10 8.5 10 7 10.7 7 11.5 7.7 13 8.5 13z"/>
          </svg>`,
          note: `<svg class="card-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 18c0 .55.45 1 1 1s1-.45 1-1-. 45-1-1-1-1-.45-1-1 .45-1 1-1zm0-7h13V9H9v2zm13-5H9v2h13V6zM9 16h13v-2H9v2zm13 5H9v-2h13v2z"/>
            <path d="M5 3.5A2.5 2.5 0 0 1 7.5 6H18v2.5H7.5A2.5 2.5 0 0 1 5 6V3.5z" transform="rotate(-25 11.5 10)"/>
          </svg>`
        };
        return icons[iconId] || '';
      }

      attachEventListeners() {
        document.getElementById('game-board').addEventListener('click', (e) => {
          if (this.isMultiplayer && !this.isMyTurn) return;
          const btn = e.target.closest('.card');
          if (btn) this.clickCard(parseInt(btn.dataset.index));
        });

        document.getElementById('btn-new-game').addEventListener('click', () => this.initGame());
        document.getElementById('btn-quit').addEventListener('click', () => this.quit());
        document.getElementById('modal-btn-new').addEventListener('click', () => this.initGame());
        document.getElementById('modal-btn-quit').addEventListener('click', () => this.quit());
      }

      clickCard(index) {
        if (this.isProcessing || this.matched.has(index) || this.flipped.includes(index)) return;

        this.flipped.push(index);
        this.render();

        if (this.flipped.length === 2) {
          this.isProcessing = true;
          this.moves++;

          setTimeout(() => this.checkMatch(), 800);
        }
      }

      checkMatch() {
        const [idx1, idx2] = this.flipped;
        const match = this.cards[idx1].id === this.cards[idx2].id;

        if (match) {
          this.matched.add(idx1);
          this.matched.add(idx2);
          this.myScore += 100;

          if (this.isMultiplayer) {
            touchBridge.broadcastMove({ type: 'match', indices: [idx1, idx2] });
          }

          if (this.matched.size === this.cards.length) {
            this.gameWon();
          } else {
            this.flipped = [];
            this.isProcessing = false;
            this.render();
          }
        } else {
          this.myScore -= 5;
          if (this.isMultiplayer) {
            this.isMyTurn = false;
            touchBridge.broadcastMove({ type: 'miss', indices: [idx1, idx2] });
          }

          setTimeout(() => {
            this.flipped = [];
            this.isProcessing = false;
            this.render();
          }, 1200);
        }

        this.updateStatus();
      }

      gameWon() {
        const time = Math.floor((Date.now() - this.startTime) / 1000);
        const score = Math.max(0, this.myScore);

        touchBridge.submitResult({
          pairs: this.matched.size,
          moves: this.moves,
          time,
          score
        });

        document.getElementById('modal-pairs').textContent = this.matched.size;
        document.getElementById('modal-moves').textContent = this.moves;
        document.getElementById('modal-time').textContent = `${time}s`;
        document.getElementById('modal-score').textContent = score;

        document.getElementById('win-modal').classList.add('active');
      }

      quit() {
        if (confirm('Deseja sair do jogo?')) {
          touchBridge.requestClose();
        }
      }

      updateStatus() {
        const status = document.querySelector('.g-status');
        const playerScoreEl = document.querySelector('#player-score .player-score-value');
        const opponentScoreEl = document.querySelector('#opponent-score .player-score-value');

        if (this.isMultiplayer) {
          status.classList.add('multiplayer');
          const turn = this.isMyTurn ? 'Sua vez' : 'Vez do oponente';
          status.textContent = turn;
        } else {
          status.textContent = `Movimentos: ${this.moves}`;
        }

        playerScoreEl.textContent = Math.max(0, this.myScore);
        opponentScoreEl.textContent = Math.max(0, this.opponentScore);
      }

      setupBridge() {
        touchBridge.onOpponentMove = (move) => {
          if (move.type === 'match') {
            this.matched.add(move.indices[0]);
            this.matched.add(move.indices[1]);
            this.opponentScore += 100;

            if (this.matched.size === this.cards.length) {
              this.opponentWins();
            }
          } else if (move.type === 'miss') {
            this.isMyTurn = true;
          }

          this.updateStatus();
          this.render();
        };

        touchBridge.onOpponentDisconnected = () => {
          alert('Oponente desconectou!');
          this.initGame();
        };
      }

      opponentWins() {
        alert('Oponente encontrou todos os pares!');
        this.initGame();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      new MemoryGame();
    });
  </script>
</body>
</html>
