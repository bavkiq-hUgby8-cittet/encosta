<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Touch? ‚Äî Painel Operacional</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#050508;--s1:#12121a;--s2:#1a1a24;--t1:#f5f5f7;--t2:#a0a0b8;--t3:#666680;--ac:#6366f1;--ac2:#818cf8;--ok:#34d399;--fire:#ff6b35;--pk:#ff3d71;--gw:rgba(255,107,53,.2);--gw2:rgba(255,107,53,.3);--b1:rgba(255,255,255,.06)}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;overflow:hidden;-webkit-user-select:none;user-select:none}

/* Login */
.op-login{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;z-index:100;background:var(--bg)}
.op-login h1{font-size:2.2rem;font-weight:800;letter-spacing:.06em}.op-login h1 span{color:var(--ac)}
.op-login-sub{font-size:.75rem;color:var(--t3);max-width:300px;text-align:center;line-height:1.6}
.op-login-btn{padding:.8rem 2rem;background:var(--ac);border:none;border-radius:14px;color:#fff;font-size:.85rem;font-weight:600;font-family:inherit;cursor:pointer;transition:transform .2s}
.op-login-btn:active{transform:scale(.95)}
.op-login-divider{display:flex;align-items:center;gap:.8rem;width:260px;color:var(--t3);font-size:.7rem}
.op-login-divider::before,.op-login-divider::after{content:'';flex:1;height:1px;background:var(--b1)}
.op-login-field{display:flex;flex-direction:column;gap:.3rem;width:260px}
.op-login-label{font-size:.65rem;color:var(--t2);text-transform:uppercase;letter-spacing:.08em;font-weight:600}
.op-login-input{padding:.6rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.85rem;font-family:inherit;outline:none;transition:border .2s}
.op-login-input:focus{border-color:var(--ac)}
.op-login-err{font-size:.65rem;color:var(--pk);min-height:1em;text-align:center}
.op-login-toggle{font-size:.7rem;color:var(--ac2);cursor:pointer;text-decoration:underline}

/* Events screen */
.op-events{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;z-index:98;background:var(--bg);display:none;padding:2rem 1rem;overflow-y:auto}
.op-events h2{font-size:1.4rem;font-weight:700;margin-bottom:.3rem}.op-events h2 span{color:var(--ac)}
.op-events-sub{font-size:.7rem;color:var(--t3);text-align:center;max-width:300px;line-height:1.5;margin-bottom:1.2rem}
.op-event-list{width:100%;max-width:360px;display:flex;flex-direction:column;gap:.6rem}
.op-event-card{background:var(--s1);border:1px solid var(--b1);border-radius:14px;padding:.8rem 1rem;cursor:pointer;transition:all .2s}
.op-event-card:hover{border-color:var(--ac);transform:translateY(-1px)}
.op-event-card.active{border-color:var(--ok)}
.op-event-card.ended{opacity:.5}
.op-event-name{font-size:.9rem;font-weight:600;color:var(--t1)}
.op-event-meta{font-size:.65rem;color:var(--t3);margin-top:.2rem}
.op-event-status{font-size:.6rem;font-weight:600;padding:.1rem .4rem;border-radius:6px;display:inline-block;margin-left:.4rem}
.op-event-status.active{background:rgba(52,211,153,.15);color:var(--ok)}
.op-event-status.ended{background:rgba(255,61,113,.1);color:var(--pk)}
.op-event-create{display:flex;flex-direction:column;gap:.6rem;width:100%;max-width:360px;margin-top:1rem}
.op-event-create-btn{padding:.7rem;background:var(--ac);border:none;border-radius:12px;color:#fff;font-size:.8rem;font-weight:600;font-family:inherit;cursor:pointer}
.op-event-create-btn:active{transform:scale(.97)}
.op-event-end-btn{padding:.4rem .8rem;background:rgba(255,61,113,.15);border:1px solid rgba(255,61,113,.3);border-radius:10px;color:var(--pk);font-size:.65rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s}
.op-event-end-btn:hover{background:rgba(255,61,113,.3)}

/* Setup / Cadastro */
.op-setup{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.2rem;z-index:99;background:var(--bg);display:none}
.op-setup h2{font-size:1.4rem;font-weight:700}.op-setup h2 span{color:var(--ac)}
.op-setup-sub{font-size:.7rem;color:var(--t3);text-align:center;max-width:280px;line-height:1.5}
.op-setup-field{display:flex;flex-direction:column;gap:.3rem;width:260px}
.op-setup-label{font-size:.65rem;color:var(--t2);text-transform:uppercase;letter-spacing:.08em;font-weight:600}
.op-setup-input{padding:.6rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.85rem;font-family:inherit;outline:none;transition:border .2s}
.op-setup-input:focus{border-color:var(--ac)}
.op-setup-err{font-size:.65rem;color:var(--pk);min-height:1em}

/* Logoff button */
.op-logoff{font-size:.6rem;color:var(--t3);cursor:pointer;padding:.2rem .5rem;border:1px solid rgba(255,255,255,.08);border-radius:8px;background:none;font-family:inherit;transition:all .2s}
.op-logoff:hover{color:var(--pk);border-color:rgba(255,61,113,.3)}

/* Header */
.op-header{display:flex;align-items:center;justify-content:space-between;padding:.5rem 1rem;background:rgba(18,18,26,.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--b1);z-index:10;position:relative}
.op-logo{font-size:.82rem;font-weight:700;letter-spacing:.08em}.op-logo span{color:var(--ac)}
.op-stats{display:flex;gap:1rem;align-items:center;font-size:.7rem;color:var(--t2)}
.op-stat-num{font-weight:700;color:var(--ok);font-size:1rem}
.op-user{font-size:.65rem;color:var(--t3)}

/* Main layout */
.op-main{display:flex;height:calc(100vh - 40px);position:relative}
.op-canvas-area{flex:1;position:relative;overflow:hidden}
.op-sidebar{width:280px;background:rgba(18,18,26,.92);backdrop-filter:blur(20px);border-left:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden;z-index:5;transition:width .3s,height .3s}
.op-sidebar.collapsed{width:48px}
.op-sidebar.collapsed .op-sb-list,.op-sidebar.collapsed .op-chat{display:none}
@media(max-width:768px){
  .op-sidebar{position:absolute;bottom:0;left:0;right:0;width:100%;height:36vh;border-left:none;border-top:1px solid var(--b1);border-radius:20px 20px 0 0;z-index:5}
  .op-sidebar.collapsed{width:100%;height:42px}
}

/* ‚ïê‚ïê‚ïê TOUCH BUTTON ‚Äî positioned at bottom ‚ïê‚ïê‚ïê */
.op-btn-area{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:.6rem;z-index:3}
@media(max-width:768px){.op-btn-area{bottom:calc(36vh + 30px)}}
.be{width:clamp(130px,36vw,170px);height:clamp(130px,36vw,170px);border-radius:50%;background:radial-gradient(circle at 35% 35%,#ff8f65,#ff6b35 50%,#e05520);border:none;color:#fff;font-size:.85rem;font-weight:800;font-family:inherit;letter-spacing:.25em;cursor:pointer;position:relative;z-index:1;box-shadow:0 0 50px var(--gw),0 0 100px rgba(255,107,53,.08),inset 0 1px 0 rgba(255,255,255,.15);transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.3rem}
.be:active{transform:scale(.92)}
.be .be-text{font-size:.75rem;font-weight:800;letter-spacing:.25em}
.be::before{content:'';position:absolute;inset:-4px;border-radius:50%;background:conic-gradient(from 0deg,var(--ac),var(--pk),#9333ea,var(--ac));z-index:-1;animation:rs 4s linear infinite;opacity:.5;filter:blur(2px)}
.be::after{content:'';position:absolute;inset:-30px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.08),transparent 70%);z-index:-2;animation:bb 3s ease-in-out infinite}
.be.energized{animation:sonic-energy .6s ease-in-out infinite alternate;box-shadow:0 0 60px var(--gw2),0 0 120px rgba(255,107,53,.15),0 0 200px rgba(255,61,113,.06)}
.be.energized::before{animation:rs 1.5s linear infinite;opacity:.8;filter:blur(3px);inset:-8px}
.be.energized::after{animation:sonic-waves 1s ease-out infinite}
.be.energized .be-text{animation:sonic-text .8s ease infinite alternate}
.be.connected{background:radial-gradient(circle at 35% 35%,#34d399,#10b981 50%,#059669)!important;box-shadow:0 0 80px rgba(52,211,153,.5)!important;animation:bump-hit .5s ease!important}
/* Event-mode TOUCH button ‚Äî blue + semi-transparent */
.be.event-mode{background:rgba(96,165,250,.25)!important;backdrop-filter:blur(8px);border:2px solid rgba(96,165,250,.4);box-shadow:0 0 40px rgba(96,165,250,.15),0 0 80px rgba(96,165,250,.06),inset 0 1px 0 rgba(255,255,255,.1)}
.be.event-mode::before{background:conic-gradient(from 0deg,#60a5fa,#818cf8,#a78bfa,#60a5fa)}
.be.event-mode::after{background:radial-gradient(circle,rgba(96,165,250,.08),transparent 70%)}
.be.event-mode.energized{animation:sonic-energy-ev .6s ease-in-out infinite alternate;box-shadow:0 0 50px rgba(96,165,250,.25),0 0 100px rgba(96,165,250,.1),0 0 180px rgba(129,140,248,.06)!important}
@keyframes sonic-energy-ev{0%{transform:scale(1);box-shadow:0 0 50px rgba(96,165,250,.25),0 0 100px rgba(96,165,250,.1)}100%{transform:scale(1.04);box-shadow:0 0 70px rgba(96,165,250,.3),0 0 130px rgba(96,165,250,.15),0 0 220px rgba(129,140,248,.08)}}
@keyframes bb{0%,100%{opacity:.3}50%{opacity:.6}}
@keyframes rs{to{transform:rotate(360deg)}}
@keyframes sonic-energy{0%{transform:scale(1);box-shadow:0 0 60px var(--gw2),0 0 120px rgba(255,107,53,.15)}100%{transform:scale(1.04);box-shadow:0 0 80px var(--gw2),0 0 150px rgba(255,107,53,.2),0 0 250px rgba(255,61,113,.08)}}
@keyframes sonic-waves{0%{inset:-30px;opacity:.5}100%{inset:-80px;opacity:0}}
@keyframes sonic-text{0%{opacity:1}100%{opacity:.6}}
@keyframes bump-hit{0%{transform:scale(1)}30%{transform:scale(1.15)}60%{transform:scale(.95)}100%{transform:scale(1)}}

/* Sound wave bars */
.sonic-bars{position:absolute;top:50%;display:flex;flex-direction:column;gap:3px;transform:translateY(-50%);z-index:0;opacity:0;transition:opacity .3s}
.sonic-bars.active{opacity:1}
.sonic-bars.left{left:-50px}
.sonic-bars.right{right:-50px}
.sonic-bar{height:2px;background:var(--ac);border-radius:2px;opacity:.4}
.sonic-bars.left .sonic-bar{animation:sbar-left .8s ease-in-out infinite alternate}
.sonic-bars.right .sonic-bar{animation:sbar-right .8s ease-in-out infinite alternate}
.sonic-bar:nth-child(1){width:12px;animation-delay:0s}
.sonic-bar:nth-child(2){width:20px;animation-delay:.1s}
.sonic-bar:nth-child(3){width:28px;animation-delay:.2s}
.sonic-bar:nth-child(4){width:20px;animation-delay:.3s}
.sonic-bar:nth-child(5){width:12px;animation-delay:.4s}
@keyframes sbar-left{0%{opacity:.2;transform:translateX(0)}100%{opacity:.7;transform:translateX(-6px)}}
@keyframes sbar-right{0%{opacity:.2;transform:translateX(0)}100%{opacity:.7;transform:translateX(6px)}}

/* FIRE overlay ‚Äî anchored to bottom where button is */
.fire-overlay{position:absolute;bottom:0;left:0;right:0;height:45%;pointer-events:none;z-index:0;opacity:0;transition:opacity .6s}
.fire-overlay.active{opacity:1}
.fire-glow{position:absolute;bottom:-15%;left:50%;transform:translateX(-50%);width:80%;height:55%;background:radial-gradient(ellipse at 50% 100%,rgba(255,107,53,.4) 0%,rgba(255,61,113,.18) 25%,rgba(255,107,53,.06) 50%,transparent 70%);animation:fire-breathe 1s ease-in-out infinite alternate;filter:blur(6px)}
.fire-glow2{position:absolute;bottom:-5%;left:50%;transform:translateX(-50%);width:50%;height:40%;background:radial-gradient(ellipse at 50% 100%,rgba(255,180,80,.3) 0%,rgba(255,107,53,.1) 40%,transparent 65%);animation:fire-breathe .7s ease-in-out infinite alternate-reverse;filter:blur(10px)}
.fire-speaker{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:3px;opacity:0;animation:fire-spk-in .8s ease .3s forwards}
.fire-spk-wave{width:12px;height:12px;border:1.5px solid var(--ac);border-radius:50%;opacity:.5;animation:fire-spk-pulse 1.2s ease infinite}
.fire-spk-wave:nth-child(2){width:20px;height:20px;animation-delay:.2s;opacity:.3}
.fire-spk-wave:nth-child(3){width:28px;height:28px;animation-delay:.4s;opacity:.15}
@keyframes fire-spk-in{to{opacity:1}}
@keyframes fire-spk-pulse{0%,100%{opacity:.2;transform:scale(.9)}50%{opacity:.7;transform:scale(1.1)}}
.fire-particles{position:absolute;bottom:0;left:0;right:0;height:100%;overflow:hidden}
.fire-p{position:absolute;bottom:-8px;border-radius:50%;filter:blur(1.5px);animation:fire-rise linear infinite}
.fire-p:nth-child(1){left:38%;width:5px;height:5px;background:#ff6b35;animation-duration:1.4s;animation-delay:0s}
.fire-p:nth-child(2){left:42%;width:3px;height:3px;background:#ffc060;animation-duration:1.7s;animation-delay:.2s}
.fire-p:nth-child(3){left:48%;width:7px;height:7px;background:#ff6b35;animation-duration:1.2s;animation-delay:.1s}
.fire-p:nth-child(4){left:52%;width:4px;height:4px;background:#ff3d71;animation-duration:1.6s;animation-delay:.35s}
.fire-p:nth-child(5){left:56%;width:5px;height:5px;background:#ffa060;animation-duration:1.3s;animation-delay:.15s}
.fire-p:nth-child(6){left:44%;width:3px;height:3px;background:#ff8f65;animation-duration:1.8s;animation-delay:.5s}
.fire-p:nth-child(7){left:50%;width:8px;height:8px;background:#ff6b35;animation-duration:1.1s;animation-delay:.25s}
.fire-p:nth-child(8){left:46%;width:4px;height:4px;background:#ffc060;animation-duration:1.5s;animation-delay:.4s}
.fire-p:nth-child(9){left:30%;width:3px;height:3px;background:#ff8f65;animation-duration:2s;animation-delay:.6s}
.fire-p:nth-child(10){left:65%;width:4px;height:4px;background:#ff6b35;animation-duration:1.9s;animation-delay:.3s}
.fire-p:nth-child(11){left:35%;width:5px;height:5px;background:#ff3d71;animation-duration:1.7s;animation-delay:.7s}
.fire-p:nth-child(12){left:60%;width:3px;height:3px;background:#ffa060;animation-duration:1.6s;animation-delay:.45s}
@keyframes fire-rise{0%{transform:translateY(0) scale(1);opacity:.9}30%{opacity:1}100%{transform:translateY(-50vh) scale(0);opacity:0}}
@keyframes fire-breathe{0%{opacity:.6;transform:translateX(-50%) scale(.95)}100%{opacity:1;transform:translateX(-50%) scale(1.05)}}
.fire-edge{position:absolute;bottom:0;height:3px;background:linear-gradient(90deg,transparent 20%,var(--ac),#fff,var(--ac),transparent 80%);filter:blur(1px);animation:fire-edge-pulse .8s ease-in-out infinite alternate}
.fire-edge.left{left:0;right:50%;border-radius:0 2px 0 0}
.fire-edge.right{left:50%;right:0;border-radius:2px 0 0 0}
@keyframes fire-edge-pulse{0%{opacity:.3;height:2px}100%{opacity:.9;height:5px}}

/* Sonic instruction ‚Äî above button at bottom */
.sonic-instruct{position:absolute;bottom:220px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:.8rem;opacity:0;transition:opacity .5s;z-index:3}
.sonic-instruct.active{opacity:1}
@media(max-width:768px){.sonic-instruct{bottom:calc(36vh + 200px)}}
.si-scene{position:relative;width:160px;height:80px;display:flex;align-items:center;justify-content:center}
.si-phone{position:absolute;width:50px;height:26px;border:1.5px solid var(--ac);border-radius:5px;background:rgba(255,107,53,.06)}
.si-phone.left{left:0;animation:si-slide-l 2s ease-in-out infinite}
.si-phone.right{right:0;animation:si-slide-r 2s ease-in-out infinite}
.si-phone .si-speaker{position:absolute;top:50%;transform:translateY(-50%);display:flex;gap:2px;align-items:center}
.si-phone.left .si-speaker{right:3px}
.si-phone.right .si-speaker{left:3px}
.si-spk-dot{width:2.5px;height:2.5px;border-radius:50%;background:var(--ac);opacity:.6}
.si-energy{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;gap:3px;align-items:center}
.si-arc{width:3px;height:10px;border-radius:2px;background:var(--ac);opacity:0;animation:si-arc-flash .6s ease infinite}
.si-arc:nth-child(1){height:6px;animation-delay:0s}
.si-arc:nth-child(2){height:12px;animation-delay:.15s}
.si-arc:nth-child(3){height:8px;animation-delay:.3s}
.si-arc:nth-child(4){height:14px;animation-delay:.1s}
.si-arc:nth-child(5){height:6px;animation-delay:.25s}
@keyframes si-arc-flash{0%{opacity:0;transform:scaleY(.5)}30%{opacity:.9;transform:scaleY(1.1)}60%{opacity:.4;transform:scaleY(.8)}100%{opacity:0;transform:scaleY(.3)}}
@keyframes si-slide-l{0%,100%{transform:translateX(0)}50%{transform:translateX(18px)}}
@keyframes si-slide-r{0%,100%{transform:translateX(0)}50%{transform:translateX(-18px)}}
.si-glow{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:20px;height:20px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.4),transparent 70%);animation:si-glow-pulse 1s ease-in-out infinite;filter:blur(4px)}
@keyframes si-glow-pulse{0%,100%{opacity:.3;transform:translate(-50%,-50%) scale(.8)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.5)}}
.si-label{font-size:.5rem;color:var(--t3);letter-spacing:.08em;text-transform:uppercase;opacity:.6}
.si-text{font-size:.72rem;color:var(--ac2);text-align:center;max-width:200px;line-height:1.5;font-weight:600;letter-spacing:.02em}
.si-text em{color:#fff;font-style:normal;font-weight:700}

.sonic-status{font-size:.72rem;color:var(--ac2);min-height:1.2em;transition:all .3s;opacity:0;text-align:center}
.sonic-status.active{opacity:1}

/* Network canvas behind button */
#opCanvas{position:absolute;inset:0;width:100%;height:100%;z-index:0}

/* Sidebar */
.op-sb-header{padding:.6rem .8rem;border-bottom:1px solid var(--b1);font-size:.68rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;font-weight:600;display:flex;justify-content:space-between}
.op-sb-list{flex:1;overflow-y:auto;padding:.4rem}
.op-checkin-item{display:flex;align-items:center;gap:.6rem;padding:.5rem .4rem;border-bottom:1px solid rgba(255,255,255,.03);animation:op-slide-in .6s cubic-bezier(.22,1,.36,1)}
@keyframes op-slide-in{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
.op-ci-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.58rem;font-weight:700;color:#fff;flex-shrink:0}
.op-ci-info{flex:1;min-width:0}
.op-ci-name{font-size:.72rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.op-ci-time{font-size:.55rem;color:var(--t3)}
.op-ci-badge{font-size:.5rem;padding:.1rem .3rem;border-radius:6px;font-weight:600;background:rgba(255,255,255,.04);color:var(--t3);border:1px solid var(--b1)}
.op-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:.8rem;color:var(--t3);padding:2rem}
.op-empty-ico{font-size:2rem;opacity:.4}
.op-empty-text{font-size:.68rem;text-align:center;line-height:1.6;max-width:200px}

/* Toggle switch */
.op-toggle{display:flex;align-items:center;gap:.4rem;font-size:.6rem;color:var(--t3)}
.op-toggle-switch{position:relative;width:32px;height:18px;background:rgba(255,255,255,.1);border-radius:9px;cursor:pointer;transition:background .3s}
.op-toggle-switch.on{background:var(--ok)}
.op-toggle-dot{position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:#fff;transition:transform .3s}
.op-toggle-switch.on .op-toggle-dot{transform:translateX(14px)}

/* Chat panel */
.op-chat{position:absolute;inset:0;background:rgba(18,18,26,.97);backdrop-filter:blur(20px);display:flex;flex-direction:column;z-index:20;transform:translateX(100%);transition:transform .3s cubic-bezier(.22,1,.36,1)}
.op-chat.open{transform:translateX(0)}
.op-chat-head{display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;border-bottom:1px solid var(--b1)}
.op-chat-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:700;color:#fff;flex-shrink:0}
.op-chat-name{flex:1;font-size:.75rem;font-weight:600}
.op-chat-reveal-badge{font-size:.5rem;padding:.15rem .4rem;border-radius:6px;background:rgba(52,211,153,.15);color:var(--ok);font-weight:600;border:1px solid rgba(52,211,153,.2)}
.op-chat-close{background:none;border:none;color:var(--t3);font-size:1rem;cursor:pointer;padding:.2rem .4rem}
.op-chat-close:hover{color:var(--t1)}
.op-chat-info{padding:.4rem .8rem;font-size:.6rem;color:var(--t3);border-bottom:1px solid var(--b1);line-height:1.5}
.op-chat-msgs{flex:1;overflow-y:auto;padding:.6rem .8rem;display:flex;flex-direction:column;gap:.4rem}
.op-chat-msg{max-width:85%;padding:.4rem .6rem;border-radius:10px;font-size:.7rem;line-height:1.4;word-break:break-word}
.op-chat-msg.mine{align-self:flex-end;background:var(--ac);color:#fff;border-bottom-right-radius:3px}
.op-chat-msg.theirs{align-self:flex-start;background:var(--s2);color:var(--t1);border-bottom-left-radius:3px}
.op-chat-msg .msg-time{font-size:.5rem;opacity:.5;margin-top:.15rem}
.op-chat-empty{flex:1;display:flex;align-items:center;justify-content:center;color:var(--t3);font-size:.65rem}
.op-chat-input-area{display:flex;gap:.4rem;padding:.5rem .6rem;border-top:1px solid var(--b1)}
.op-chat-input{flex:1;padding:.4rem .6rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.72rem;font-family:inherit;outline:none}
.op-chat-input:focus{border-color:var(--ac)}
.op-chat-send{background:var(--ac);border:none;color:#fff;border-radius:10px;padding:.3rem .6rem;font-size:.65rem;font-weight:600;cursor:pointer;font-family:inherit}

/* Sidebar revealed badge */
.op-ci-revealed{font-size:.5rem;padding:.1rem .3rem;border-radius:6px;font-weight:600;background:rgba(52,211,153,.12);color:var(--ok);border:1px solid rgba(52,211,153,.2)}

/* Connection flash overlay */
.op-flash{position:fixed;inset:0;z-index:50;pointer-events:none;opacity:0}
</style>
</head>
<body>

<div class="op-login" id="opLogin">
  <h1>Touch<span>?</span></h1>
  <div class="op-login-sub">Painel Operacional<br>Check-in em tempo real para eventos e estabelecimentos</div>
  <button class="op-login-btn" onclick="opDoLogin()">Entrar com Google</button>
  <div class="op-login-divider">ou</div>
  <div class="op-login-field">
    <label class="op-login-label">Email</label>
    <input class="op-login-input" id="opLoginEmail" type="email" placeholder="seu@email.com">
  </div>
  <div class="op-login-field">
    <label class="op-login-label">Senha</label>
    <input class="op-login-input" id="opLoginPass" type="password" placeholder="M√≠nimo 6 caracteres">
  </div>
  <div class="op-login-err" id="opLoginErr"></div>
  <button class="op-login-btn" id="opLoginEmailBtn" onclick="opDoEmailLogin()">Entrar</button>
  <div class="op-login-toggle" id="opLoginToggle" onclick="opToggleCreateAccount()">N√£o tem conta? Criar conta</div>
</div>

<div class="op-events" id="opEvents">
  <h2>Touch<span>?</span> Eventos</h2>
  <div class="op-events-sub">Selecione um evento ativo ou crie um novo.</div>
  <div class="op-event-list" id="opEventList"></div>
  <div class="op-event-create">
    <div class="op-login-field">
      <label class="op-login-label">Nome do novo evento</label>
      <input class="op-login-input" id="opNewEventName" type="text" placeholder="Ex: Festa de Ver√£o, Happy Hour" maxlength="40">
    </div>
    <div class="op-login-field">
      <label class="op-login-label">Tipo de servi√ßo (opcional)</label>
      <select class="op-login-input" id="opServiceType" style="cursor:pointer">
        <option value="">Sem servi√ßo</option>
        <option value="bar">üç∫ Bar / Drinks</option>
        <option value="dj">üéµ DJ / M√∫sica</option>
        <option value="food">üçï Comida</option>
        <option value="photo">üì∏ Fotografia</option>
        <option value="custom">‚úèÔ∏è Outro</option>
      </select>
    </div>
    <div class="op-login-field" id="opServiceCustomWrap" style="display:none">
      <label class="op-login-label">Descreva o servi√ßo</label>
      <input class="op-login-input" id="opServiceCustom" type="text" placeholder="Ex: Decora√ß√£o, Seguran√ßa..." maxlength="30">
    </div>
    <div class="op-login-field">
      <label class="op-login-label">Valor do ingresso (opcional)</label>
      <div style="display:flex;align-items:center;gap:.4rem">
        <span style="font-size:.8rem;color:var(--t2);font-weight:600">R$</span>
        <input class="op-login-input" id="opEntryPrice" type="number" placeholder="0,00" min="0" max="500" step="0.01" style="flex:1">
      </div>
      <div style="font-size:.55rem;color:var(--t3);margin-top:.2rem">Deixe em branco ou 0 para entrada gratuita. 10% de taxa Touch?.</div>
    </div>
    <div style="display:flex;align-items:center;gap:.6rem;padding:.3rem 0">
      <input type="checkbox" id="opAcceptsTips" style="accent-color:var(--ok);width:16px;height:16px;cursor:pointer">
      <label for="opAcceptsTips" style="font-size:.72rem;color:var(--t2);cursor:pointer">Aceitar gorjetas neste evento üí∞</label>
    </div>
    <button class="op-event-create-btn" onclick="opCreateEvent()">+ Criar Evento</button>
    <div class="op-login-err" id="opEventErr"></div>
  </div>
  <div style="margin-top:1.5rem">
    <button class="op-logoff" onclick="opLogoff()">Sair da conta</button>
  </div>
</div>

<div class="op-setup" id="opSetup">
  <h2>Touch<span>?</span> Operador</h2>
  <div class="op-setup-sub">Configure o nome do seu estabelecimento ou evento. Este nome aparecer√° para as pessoas que fizerem check-in.</div>
  <div class="op-setup-field">
    <label class="op-setup-label">Nome do estabelecimento</label>
    <input class="op-setup-input" id="opSetupNick" type="text" placeholder="Ex: Bar do Jo√£o, Festa XYZ" maxlength="20">
  </div>
  <div class="op-setup-field">
    <label class="op-setup-label">Data de nascimento (respons√°vel)</label>
    <input class="op-setup-input" id="opSetupBirth" type="date">
  </div>
  <div class="op-setup-err" id="opSetupErr"></div>
  <button class="op-login-btn" onclick="opFinishSetup()">Salvar e continuar</button>
</div>

<div style="display:none" id="opApp">
  <div class="op-header">
    <div class="op-logo" style="display:flex;flex-direction:column;line-height:1.2">
      <span>Touch<span style="color:var(--ac)">?</span></span>
      <span id="opEventTitle" style="color:#60a5fa;font-size:.7rem;font-weight:600;letter-spacing:.04em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px"></span>
    </div>
    <div class="op-stats">
      <div><span class="op-stat-num" id="opCount">0</span> check-ins</div>
      <div class="op-toggle">
        <span>Somente revelados</span>
        <div class="op-toggle-switch" id="opToggleReveal" onclick="toggleRequireReveal()"><div class="op-toggle-dot"></div></div>
      </div>
      <div class="op-toggle">
        <span>Nomes reais</span>
        <div class="op-toggle-switch on" id="opToggleNames" onclick="toggleShowRealNames()"><div class="op-toggle-dot"></div></div>
      </div>
      <div class="op-user" id="opUserName"></div>
      <button class="op-event-end-btn" onclick="opEndEvent()">Encerrar Evento</button>
      <button class="op-logoff" onclick="opBackToEvents()">‚Üê Eventos</button>
    </div>
  </div>
  <div class="op-main">
    <div class="op-canvas-area">
      <canvas id="opCanvas"></canvas>
      <!-- FIRE OVERLAY ‚Äî exact copy from main app -->
      <div class="fire-overlay" id="fireOverlay">
        <div class="fire-glow"></div><div class="fire-glow2"></div>
        <div class="fire-particles"><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div></div>
        <div class="fire-edge left"></div><div class="fire-edge right"></div>
        <div class="fire-speaker"><div class="fire-spk-wave"></div><div class="fire-spk-wave"></div><div class="fire-spk-wave"></div></div>
      </div>
      <!-- PHONES TOUCHING INSTRUCTION -->
      <div class="sonic-instruct" id="sonicInstruct">
        <div class="si-scene">
          <div class="si-phone left"><div class="si-speaker"><div class="si-spk-dot"></div><div class="si-spk-dot"></div><div class="si-spk-dot"></div></div></div>
          <div class="si-energy"><div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div></div>
          <div class="si-glow"></div>
          <div class="si-phone right"><div class="si-speaker"><div class="si-spk-dot"></div><div class="si-spk-dot"></div><div class="si-spk-dot"></div></div></div>
        </div>
        <div class="si-label">üîä alto-falante ‚Üî alto-falante üîä</div>
        <div class="si-text">Encoste o <em>celular</em> no<br><em>alto-falante</em> do computador</div>
      </div>
      <!-- TOUCH BUTTON ‚Äî exact copy from main app -->
      <div class="op-btn-area">
        <div style="position:relative;display:flex;align-items:center;justify-content:center">
          <div class="sonic-bars left" id="sonicBarsL"><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div></div>
          <button class="be" id="opTouchBtn" onclick="opToggleTouch()">
            <span class="be-text" id="opBtnText">TOUCH</span>
          </button>
          <div class="sonic-bars right" id="sonicBarsR"><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div></div>
        </div>
        <div class="sonic-status" id="opStatus"></div>
      </div>
    </div>
    <div class="op-sidebar" id="opSidebar" style="position:relative">
      <div class="op-sb-header" style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:.4rem">
          <button onclick="toggleSidebar()" style="background:none;border:none;color:var(--t2);font-size:.9rem;cursor:pointer;padding:0;line-height:1" id="opSidebarArrow">‚ñ∏</button>
          <span>Check-ins</span><span id="opListCount">0</span>
        </div>
        <button onclick="showFinancialPanel()" style="background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.2);border-radius:8px;color:var(--ok);font-size:.6rem;font-weight:600;padding:.2rem .5rem;cursor:pointer;font-family:inherit">üí∞ Financeiro</button>
      </div>
      <div class="op-sb-list" id="opList">
        <div class="op-empty" id="opEmpty">
          <div class="op-empty-ico">üì°</div>
          <div class="op-empty-text">Ative o TOUCH para come√ßar.<br>As pessoas encostam o celular e aparecem aqui.</div>
        </div>
      </div>
      <!-- Chat panel slides over sidebar -->
      <div class="op-chat" id="opChat">
        <div class="op-chat-head">
          <div class="op-chat-avatar" id="opChatAvatar">?</div>
          <div class="op-chat-name" id="opChatName">Visitante</div>
          <span class="op-chat-reveal-badge" id="opChatRevealBadge" style="display:none">Revelado ‚úì</span>
          <button class="op-chat-close" onclick="closeChat()">‚úï</button>
        </div>
        <div class="op-chat-info" id="opChatInfo"></div>
        <div class="op-chat-msgs" id="opChatMsgs"><div class="op-chat-empty">Nenhuma mensagem ainda</div></div>
        <div class="op-chat-input-area">
          <input class="op-chat-input" id="opChatInput" placeholder="Mensagem..." onkeydown="if(event.key==='Enter')sendChatMsg()">
          <button class="op-chat-send" onclick="sendChatMsg()">Enviar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Financial Panel Overlay -->
  <div id="opFinPanel" style="display:none;position:absolute;inset:0;z-index:50;background:rgba(5,5,8,.95);backdrop-filter:blur(20px);overflow-y:auto;padding:1.5rem">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
      <h2 style="font-size:1.1rem;font-weight:700">üí∞ Financeiro</h2>
      <button onclick="$('opFinPanel').style.display='none'" style="background:none;border:none;color:var(--t2);font-size:1.2rem;cursor:pointer">‚úï</button>
    </div>
    <div id="opFinSummary" style="display:flex;gap:.8rem;margin-bottom:1rem;flex-wrap:wrap"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem">
      <span style="font-size:.75rem;font-weight:600;color:var(--t2)">Transa√ß√µes recentes</span>
      <span style="font-size:.6rem;color:var(--t3)" id="opFinCount">0 transa√ß√µes</span>
    </div>
    <div id="opFinList" style="display:flex;flex-direction:column;gap:.4rem"></div>
    <div style="margin-top:1.5rem;padding:.8rem;background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.2);border-radius:12px">
      <div style="font-size:.7rem;font-weight:600;color:var(--ac2);margin-bottom:.3rem">Mercado Pago</div>
      <div style="font-size:.6rem;color:var(--t3);line-height:1.5" id="opMpStatus">Verificando...</div>
      <button onclick="connectMercadoPago()" style="margin-top:.5rem;padding:.4rem .8rem;background:rgba(0,158,227,.15);border:1px solid rgba(0,158,227,.3);border-radius:8px;color:#009ee3;font-size:.65rem;font-weight:600;font-family:inherit;cursor:pointer" id="opMpConnectBtn">Conectar Mercado Pago</button>
    </div>
  </div>
</div>

<canvas class="op-flash" id="opFlash"></canvas>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
const S={userId:null,userName:null,userColor:null,socket:null,checkins:[],requireReveal:false,showRealNames:true,currentEventId:null,currentEventName:null};
let opIsCreateAccount=false;
let homeSonicActive=false,sonicActive=false,sonicMyFreq=0;
let sonicEmitCtx=null,sonicOsc=null,sonicStream=null,sonicMicCtx=null,sonicAnalyser=null,sonicAnimFrame=null;
let sonicKeepAlive=null,audioCtx=null;
const SONIC_FFT_SIZE=8192,SONIC_DETECT_THRESHOLD=80,SONIC_CONFIRM_COUNT=3;

function $(id){return document.getElementById(id)}

// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
(async function(){
  const r=await fetch('/api/firebase-config');const cfg=await r.json();
  firebase.initializeApp(cfg);
  firebase.auth().onAuthStateChanged(async user=>{
    if(user){
      // CRITICAL: Ensure user exists in database via /api/auth/link
      // Without this, sonic-start is rejected because db.users[userId] is null
      try{
        const linkRes=await fetch('/api/auth/link',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({firebaseUid:user.uid,email:user.email,displayName:user.displayName,photoURL:user.photoURL})});
        const linkData=await linkRes.json();
        S.userId=linkData.userId; // Use the ENCOSTA userId (not Firebase uid)
        S.userName=linkData.user?.nickname||linkData.user?.name||user.displayName||'Operador';
        S.userColor=linkData.user?.color||'#6366f1';
        console.log('[operator] Auth linked:',S.userId,'name:',S.userName,'linked:',linkData.linked);
      }catch(e){
        console.error('[operator] Auth link failed:',e);
        // Fallback: try GET
        S.userId=user.uid;
        try{const ur=await fetch('/api/user/'+user.uid);const ud=await ur.json();S.userName=ud.nickname||ud.name||user.displayName||'Operador';S.userColor=ud.color||'#6366f1'}
        catch(e2){S.userName=user.displayName||'Operador';S.userColor='#6366f1'}
      }
      $('opLogin').style.display='none';
      // Check if user needs to complete setup (no nickname or auto-generated)
      const needsSetup=!S.userName||S.userName==='Operador'||S.userName===user.displayName;
      if(needsSetup){
        $('opSetup').style.display='flex';$('opApp').style.display='none';$('opEvents').style.display='none';
      }else{
        $('opSetup').style.display='none';$('opApp').style.display='none';
        // Show events screen instead of going directly to dashboard
        showEventsScreen();
      }
    }else{$('opLogin').style.display='';$('opApp').style.display='none';$('opSetup').style.display='none';$('opEvents').style.display='none'}
  });
})();
function opDoLogin(){firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert('Erro: '+e.message))}

// ‚ïê‚ïê‚ïê EMAIL/PASSWORD LOGIN ‚ïê‚ïê‚ïê
function opToggleCreateAccount(){
  opIsCreateAccount=!opIsCreateAccount;
  $('opLoginEmailBtn').textContent=opIsCreateAccount?'Criar conta':'Entrar';
  $('opLoginToggle').textContent=opIsCreateAccount?'J√° tem conta? Entrar':'N√£o tem conta? Criar conta';
  $('opLoginErr').textContent='';
}
async function opDoEmailLogin(){
  const email=$('opLoginEmail').value.trim();
  const pass=$('opLoginPass').value;
  const err=$('opLoginErr');
  if(!email){err.textContent='Informe o email.';return}
  if(!pass||pass.length<6){err.textContent='Senha deve ter pelo menos 6 caracteres.';return}
  err.textContent='Aguarde...';
  try{
    if(opIsCreateAccount){
      await firebase.auth().createUserWithEmailAndPassword(email,pass);
    }else{
      await firebase.auth().signInWithEmailAndPassword(email,pass);
    }
    err.textContent='';
  }catch(e){
    const msgs={'auth/email-already-in-use':'Este email j√° est√° em uso.','auth/invalid-email':'Email inv√°lido.','auth/user-not-found':'Usu√°rio n√£o encontrado.','auth/wrong-password':'Senha incorreta.','auth/weak-password':'Senha muito fraca (m√≠n. 6 caracteres).'};
    err.textContent=msgs[e.code]||e.message;
  }
}

// ‚ïê‚ïê‚ïê EVENTS SCREEN ‚ïê‚ïê‚ïê
async function showEventsScreen(){
  $('opEvents').style.display='flex';$('opApp').style.display='none';
  $('opEventList').innerHTML='<div style="text-align:center;color:var(--t3);font-size:.7rem">Carregando...</div>';
  try{
    const r=await fetch('/api/operator/events/'+S.userId);const d=await r.json();
    const list=$('opEventList');list.innerHTML='';
    if(d.events&&d.events.length>0){
      d.events.forEach(ev=>{
        const card=document.createElement('div');
        card.className='op-event-card'+(ev.active?' active':' ended');
        const dt=new Date(ev.createdAt);
        const dateStr=dt.toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'numeric'});
        const statusBadge=ev.active?'<span class="op-event-status active">Ativo</span>':'<span class="op-event-status ended">Encerrado</span>';
        const priceTag=ev.entryPrice>0?' ¬∑ üé´ R$'+ev.entryPrice.toFixed(2).replace('.',','):'';
        const revTag=ev.revenue>0?' ¬∑ üí∞ R$'+ev.revenue.toFixed(2).replace('.',','):'';
        card.innerHTML='<div class="op-event-name">'+esc(ev.name)+' '+statusBadge+'</div><div class="op-event-meta">'+dateStr+' ¬∑ '+((ev.participants||[]).length)+' participantes'+priceTag+revTag+'</div>';
        if(ev.active){card.onclick=()=>opSelectEvent(ev.id,ev.name)}
        list.appendChild(card);
      });
    }else{
      list.innerHTML='<div style="text-align:center;color:var(--t3);font-size:.75rem;padding:1rem">Nenhum evento criado ainda.<br>Crie seu primeiro evento abaixo!</div>';
    }
  }catch(e){$('opEventList').innerHTML='<div style="color:var(--pk);text-align:center;font-size:.7rem">Erro ao carregar eventos</div>'}
}

// Toggle custom service field
if($('opServiceType')){$('opServiceType').onchange=function(){$('opServiceCustomWrap').style.display=this.value==='custom'?'':'none'}}

async function opCreateEvent(){
  const name=$('opNewEventName').value.trim();
  const err=$('opEventErr');
  if(!name||name.length<2){err.textContent='Nome deve ter pelo menos 2 caracteres.';return}
  const serviceType=$('opServiceType').value;
  const serviceLabel=serviceType==='custom'?($('opServiceCustom').value.trim()||''):serviceType;
  const acceptsTips=$('opAcceptsTips').checked;
  const entryPrice=parseFloat($('opEntryPrice').value)||0;
  err.textContent='Criando...';
  try{
    const r=await fetch('/api/operator/event/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:S.userId,name,serviceLabel,acceptsTips,entryPrice})});
    const d=await r.json();
    if(!r.ok){err.textContent=d.error||'Erro ao criar.';return}
    err.textContent='';$('opNewEventName').value='';$('opServiceType').value='';$('opServiceCustom').value='';$('opAcceptsTips').checked=false;$('opServiceCustomWrap').style.display='none';$('opEntryPrice').value='';
    opSelectEvent(d.event.id,d.event.name);
  }catch(e){err.textContent='Erro: '+e.message}
}

function opSelectEvent(eventId,eventName){
  S.currentEventId=eventId;S.currentEventName=eventName;
  $('opEvents').style.display='none';$('opApp').style.display='';
  $('opEventTitle').textContent=eventName;
  $('opUserName').textContent=S.userName;
  // Apply event-mode styling to TOUCH button
  const btn=$('opTouchBtn');
  if(btn){btn.classList.add('event-mode');$('opBtnText').textContent='üìç TOUCH'}
  S.checkins=[];nodes.length=0;
  $('opCount').textContent='0';$('opListCount').textContent='0';
  // Recreate list with empty state (opEmpty is inside opList)
  $('opList').innerHTML='<div class="op-empty" id="opEmpty"><div class="op-empty-ico">üì°</div><div class="op-empty-text">Ative o TOUCH para come√ßar.<br>As pessoas encostam o celular e aparecem aqui.</div></div>';
  initSocket();initCanvas();loadExistingEvent();
}

async function loadExistingEvent(){
  loadOperatorSettings();
  try{
    const r=await fetch('/api/operator/event/'+S.currentEventId+'/attendees');const d=await r.json();
    if(d.attendees&&d.attendees.length>0){
      $('opEmpty').style.display='none';
      d.attendees.forEach(a=>{
        const checkinData={userId:a.userId,nickname:a.nickname,color:a.color,profilePhoto:a.profilePhoto,timestamp:Date.now(),relationId:null,revealed:a.revealed,revealData:a.revealData,stars:a.stars,topTag:a.topTag,score:a.score};
        S.checkins.push(checkinData);
        addCheckinToList(checkinData);
        addNodeToCanvas(checkinData,true);
      });
      $('opCount').textContent=S.checkins.length;$('opListCount').textContent=S.checkins.length;
    }
  }catch(e){console.error('[loadExistingEvent]',e)}
}

async function opEndEvent(){
  if(!S.currentEventId)return;
  if(!confirm('Encerrar o evento "'+S.currentEventName+'"? Todos os participantes ser√£o desconectados.'))return;
  try{
    await fetch('/api/operator/event/'+S.currentEventId+'/end',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})});
    if(homeSonicActive)stopHomeSonic();
    if(S.socket){S.socket.disconnect();S.socket=null}
    S.currentEventId=null;S.currentEventName=null;S.checkins=[];nodes.length=0;
    $('opApp').style.display='none';
    showEventsScreen();
  }catch(e){alert('Erro ao encerrar: '+e.message)}
}

function opBackToEvents(){
  if(homeSonicActive)stopHomeSonic();
  if(S.socket){S.socket.disconnect();S.socket=null}
  S.currentEventId=null;S.currentEventName=null;S.checkins=[];nodes.length=0;
  $('opApp').style.display='none';
  showEventsScreen();
}

// ‚ïê‚ïê‚ïê SETUP / CADASTRO ‚ïê‚ïê‚ïê
async function opFinishSetup(){
  const nick=$('opSetupNick').value.trim();
  const birth=$('opSetupBirth').value;
  const err=$('opSetupErr');
  if(!nick||nick.length<2){err.textContent='Nome deve ter pelo menos 2 caracteres.';return}
  if(nick.length>20){err.textContent='Nome deve ter no m√°ximo 20 caracteres.';return}
  if(!birth){err.textContent='Informe a data de nascimento.';return}
  err.textContent='Salvando...';
  try{
    const res=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nickname:nick,birthdate:birth,acceptedTerms:true,userId:S.userId})});
    const data=await res.json();
    if(!res.ok){err.textContent=data.error||'Erro ao salvar.';return}
    S.userName=data.user?.nickname||nick;
    S.userColor=data.user?.color||S.userColor;
    $('opSetup').style.display='none';
    showEventsScreen();
  }catch(e){err.textContent='Erro de conex√£o: '+e.message}
}

// ‚ïê‚ïê‚ïê LOGOFF ‚ïê‚ïê‚ïê
function opLogoff(){
  if(homeSonicActive)stopHomeSonic();
  if(S.socket){S.socket.disconnect();S.socket=null}
  firebase.auth().signOut();
  S.userId=null;S.userName=null;S.userColor=null;S.checkins=[];S.currentEventId=null;S.currentEventName=null;
  nodes.length=0;
  $('opApp').style.display='none';$('opSetup').style.display='none';$('opEvents').style.display='none';$('opLogin').style.display='';
}

// ‚ïê‚ïê‚ïê SOCKET ‚ïê‚ïê‚ïê
function initSocket(){
  S.socket=io({reconnection:true,reconnectionDelay:1000});
  S.socket.on('connect',()=>{
    if(S.userId)S.socket.emit('identify',S.userId);
    // On reconnect: re-register in queue AND update oscillator to new freq
    if(homeSonicActive){
      S.socket.emit('sonic-start',{userId:S.userId,isCheckin:true,eventId:S.currentEventId});
      S.socket.once('sonic-assigned',({freq})=>{
        sonicMyFreq=freq;
        if(sonicOsc&&sonicEmitCtx){try{sonicOsc.frequency.setValueAtTime(freq,sonicEmitCtx.currentTime)}catch(e){}}
      });
    }
  });
  // Use checkin-created as the primary event (avoids duplicates with relation-created)
  S.socket.on('checkin-created',d=>{handleNewCheckin(d)});
  // Entry fee paid notification
  S.socket.on('entry-paid',d=>{
    const toast=document.createElement('div');
    toast.style.cssText='position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(16,185,129,.9);color:#fff;padding:.5rem 1rem;border-radius:12px;font-size:.75rem;font-weight:600;z-index:9999;animation:fadeIn .3s';
    toast.textContent='üé´ '+esc(d.nickname)+' pagou ingresso R$'+d.amount.toFixed(2).replace('.',',');
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(),4000);
  });
  // Chat messages
  S.socket.on('new-message',({relationId,message})=>{
    if(chatOpen&&chatRelationId===relationId)appendChatMsg(message);
  });
  // Identity revealed ‚Äî update sidebar + canvas node
  S.socket.on('identity-revealed',d=>{
    const revUserId=d.fromUserId||d.userId;
    if(!revUserId)return;
    // Update node ‚Äî auto-load photo immediately
    const node=nodes.find(n=>n.userId===revUserId);
    if(node){
      node.revealed=true;node.revealData=d;node.profilePhoto=d.profilePhoto||null;
      // Force load profile photo for canvas
      if(d.profilePhoto){
        node.photoLoaded=false; // reset to force reload
        const img=new Image();img.crossOrigin='anonymous';
        img.onload=()=>{node.photoImg=img;node.photoLoaded=true;console.log('[reveal] Photo loaded for',revUserId.slice(0,8))};
        img.onerror=()=>{console.log('[reveal] Photo load failed for',revUserId.slice(0,8))};
        img.src=d.profilePhoto;
      }
    }
    // Update sidebar item
    const items=document.querySelectorAll('.op-checkin-item');
    items.forEach(item=>{
      if(item.dataset.userId===revUserId){
        const badge=item.querySelector('.op-ci-badge');
        if(badge){badge.outerHTML='<span class="op-ci-revealed">Revelado ‚úì</span>'}
      }
    });
    // Update chat if open for this user
    if(chatOpen&&chatPartnerId===revUserId){
      $('opChatRevealBadge').style.display='';
      let info=$('opChatInfo').innerHTML;
      if(d.realName)info+='<br>Nome: '+esc(d.realName);
      if(d.instagram)info+=' | @'+esc(d.instagram);
      $('opChatInfo').innerHTML=info;
    }
  });
  S.socket.on('event-attendee-left',d=>{
    if(!d||!d.userId)return;
    S.checkins=S.checkins.filter(c=>c.userId!==d.userId);
    const items=document.querySelectorAll('.op-checkin-item');
    items.forEach(it=>{if(it.dataset.userId===d.userId)it.remove()});
    const idx=nodes.findIndex(n=>n.userId===d.userId);
    if(idx>=0)nodes.splice(idx,1);
    $('opCount').textContent=S.checkins.length;
    $('opListCount').textContent=S.checkins.length;
    if(S.checkins.length===0){const e=$('opEmpty');if(e)e.style.display=''}
  });
  S.socket.on('sonic-matched',()=>{
    // Operator STAYS in sonicQueue after connection (server keeps it).
    // Do NOT re-register ‚Äî that would assign a new freq while oscillator plays old freq.
    // Just update joinedAt to prevent timeout cleanup:
    if(homeSonicActive&&S.socket&&S.socket.connected){
      // Re-register with same freq by telling server to keep us alive
      // We DON'T call sonic-start (which would assign new freq)
      // Instead, server already keeps operator in queue. Nothing to do.
      console.log('[operator] sonic-matched: staying in queue, continuing detection');
    }
  });
}

// ‚ïê‚ïê‚ïê SONIC ‚Äî COPIED EXACTLY FROM MAIN APP ‚ïê‚ïê‚ïê
async function requestMic(){
  return navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
}

async function opToggleTouch(){
  if(homeSonicActive){stopHomeSonic();return}
  if(!S.socket||!S.socket.connected){alert('Sem conex√£o. Aguarde...');return}

  // RESET: kill any leftover audio/mic state
  stopSonicMode();

  homeSonicActive=true;
  sonicActive=true;sonicMyFreq=0;
  const btn=$('opTouchBtn'),txt=$('opBtnText'),sts=$('opStatus');
  const barsL=$('sonicBarsL'),barsR=$('sonicBarsR'),fire=$('fireOverlay');
  const si=$('sonicInstruct');
  btn.classList.add('energized');
  txt.textContent='ATIVANDO...';
  // ALWAYS request fresh mic
  if(sonicStream){sonicStream.getTracks().forEach(t=>t.stop());sonicStream=null;}
  if(sonicMicCtx){try{sonicMicCtx.close()}catch(e){} sonicMicCtx=null;}
  if(sonicEmitCtx){try{sonicEmitCtx.close()}catch(e){} sonicEmitCtx=null;}
  sts.textContent='Pedindo microfone...';sts.classList.add('active');
  barsL.classList.add('active');barsR.classList.add('active');
  if(fire)fire.classList.add('active');
  if(si)si.classList.add('active');

  try{
    // 1. Fresh mic permission
    sonicStream=await requestMic();
    if(!homeSonicActive)return;
    sts.textContent='Conectando ao servidor...';

    // 2. Get frequency
    S.socket.emit('sonic-start',{userId:S.userId,isCheckin:true,eventId:S.currentEventId});
    const freq=await new Promise((resolve,reject)=>{
      const t=setTimeout(()=>reject(new Error('Timeout')),8000);
      S.socket.once('sonic-assigned',({freq})=>{clearTimeout(t);resolve(freq)});
    });
    if(!homeSonicActive)return;
    sonicMyFreq=freq;

    // 3. Emit ultrasonic ‚Äî USE SAME AudioContext for BOTH emit and mic
    // (single context avoids Chrome issues with multiple contexts)
    sonicEmitCtx=new(window.AudioContext||window.webkitAudioContext)();
    if(sonicEmitCtx.state==='suspended')await sonicEmitCtx.resume();
    console.log('[operator] EmitCtx state:',sonicEmitCtx.state,'sampleRate:',sonicEmitCtx.sampleRate);

    // Play brief AUDIBLE confirmation beep so user knows speaker works
    const confirmOsc=sonicEmitCtx.createOscillator();
    const confirmGain=sonicEmitCtx.createGain();
    confirmOsc.connect(confirmGain);confirmGain.connect(sonicEmitCtx.destination);
    confirmOsc.type='sine';confirmOsc.frequency.setValueAtTime(880,sonicEmitCtx.currentTime);
    confirmGain.gain.setValueAtTime(0.15,sonicEmitCtx.currentTime);
    confirmGain.gain.linearRampToValueAtTime(0,sonicEmitCtx.currentTime+0.3);
    confirmOsc.start();confirmOsc.stop(sonicEmitCtx.currentTime+0.3);

    // Start ultrasonic oscillator
    sonicOsc=sonicEmitCtx.createOscillator();
    sonicOsc.type='sine';
    sonicOsc.frequency.setValueAtTime(freq,sonicEmitCtx.currentTime);
    const gain=sonicEmitCtx.createGain();
    gain.gain.setValueAtTime(1.0,sonicEmitCtx.currentTime);
    sonicOsc.connect(gain);gain.connect(sonicEmitCtx.destination);
    sonicOsc.start();
    console.log('[operator] Oscillator started at',freq,'Hz, gain:1.0, ctxState:',sonicEmitCtx.state);

    // 4. Start detection ‚Äî use SEPARATE context for mic
    sonicMicCtx=new(window.AudioContext||window.webkitAudioContext)();
    if(sonicMicCtx.state==='suspended')await sonicMicCtx.resume();
    const source=sonicMicCtx.createMediaStreamSource(sonicStream);
    sonicAnalyser=sonicMicCtx.createAnalyser();
    sonicAnalyser.fftSize=SONIC_FFT_SIZE;
    sonicAnalyser.smoothingTimeConstant=0.3;
    source.connect(sonicAnalyser);
    const bufLen=sonicAnalyser.frequencyBinCount;
    const dataArr=new Uint8Array(bufLen);
    const sampleRate=sonicMicCtx.sampleRate;
    const freqPerBin=sampleRate/SONIC_FFT_SIZE;
    console.log('[operator] MicCtx state:',sonicMicCtx.state,'sampleRate:',sampleRate,'freqPerBin:',freqPerBin.toFixed(2),'nyquist:',sampleRate/2);

    txt.textContent='EMITINDO...';
    sts.textContent='Encoste o celular no alto-falante üîä';
    console.log('[operator] Sonic ACTIVE ‚Äî emitting freq:',freq,'Hz, detecting range: 18000-20000Hz');

    // Keep alive
    sonicKeepAlive=setInterval(()=>{
      if(sonicEmitCtx&&sonicEmitCtx.state==='suspended'){sonicEmitCtx.resume();console.log('[operator] Resumed emitCtx')}
      if(sonicMicCtx&&sonicMicCtx.state==='suspended'){sonicMicCtx.resume();console.log('[operator] Resumed micCtx')}
    },3000);

    // 5. Detection loop ‚Äî OPERATOR MODE (different from main app!)
    // On computers, speaker-to-mic feedback makes OUR OWN frequency the loudest peak.
    // Fix: SKIP bins near our frequency, look for OTHER frequencies only.
    const myBinCenter=Math.round(freq/freqPerBin);
    const skipRadius=Math.ceil(200/freqPerBin); // skip ¬±200Hz around our freq
    console.log('[operator] Detection: skipping bins',myBinCenter-skipRadius,'to',myBinCenter+skipRadius,'(our freq zone)');

    let confirmHits=0,lastSnapped=0,cooldown=0,debugCounter=0;
    function detect(){
      if(!sonicActive)return;
      if(cooldown>0){cooldown--;sonicAnimFrame=requestAnimationFrame(detect);return}
      sonicAnalyser.getByteFrequencyData(dataArr);
      const minBin=Math.floor(18000/freqPerBin),maxBin=Math.ceil(20000/freqPerBin);

      // Find peak EXCLUDING bins near our own frequency
      let peakVal=0,peakBin=0;
      for(let i=minBin;i<=maxBin&&i<bufLen;i++){
        // Skip bins around our own emission to avoid self-detection
        if(i>=myBinCenter-skipRadius&&i<=myBinCenter+skipRadius)continue;
        if(dataArr[i]>peakVal){peakVal=dataArr[i];peakBin=i}
      }

      // Also check raw peak (including self) for debug logging
      let rawPeak=0,rawBin=0;
      for(let i=minBin;i<=maxBin&&i<bufLen;i++){if(dataArr[i]>rawPeak){rawPeak=dataArr[i];rawBin=i}}

      debugCounter++;
      if(debugCounter%120===0){
        const rawFreq=Math.round(rawBin*freqPerBin);
        const peakFreq=peakBin>0?Math.round(peakBin*freqPerBin):0;
        console.log('[operator-mic] self:',rawPeak,'@',rawFreq,'Hz | other:',peakVal,'@',peakFreq,'Hz | threshold:',SONIC_DETECT_THRESHOLD);
      }

      if(peakVal>=SONIC_DETECT_THRESHOLD){
        const snapped=Math.round(Math.round(peakBin*freqPerBin)/100)*100;
        if(snapped>=18000&&snapped<=19900&&snapped!==sonicMyFreq){
          if(snapped===lastSnapped)confirmHits++;else{confirmHits=1;lastSnapped=snapped}
          console.log('[operator] Hit! snapped:',snapped,'peak:',peakVal,'confirmHits:',confirmHits,'/',SONIC_CONFIRM_COUNT);
          if(confirmHits>=SONIC_CONFIRM_COUNT){
            console.log('[operator] ‚òÖ DETECTED freq:',snapped,'Hz (peak:',peakVal,') ‚Äî sending sonic-detected');
            S.socket.emit('sonic-detected',{userId:S.userId,detectedFreq:snapped});
            confirmHits=0;lastSnapped=0;
            cooldown=90;
            btn.classList.add('connected');
            setTimeout(()=>{if(homeSonicActive){btn.classList.remove('connected');btn.classList.add('energized')}},1200);
          }
        }
      }else if(confirmHits>0)confirmHits=Math.max(0,confirmHits-1);
      sonicAnimFrame=requestAnimationFrame(detect);
    }
    detect();

  }catch(e){
    console.error('Sonic error:',e);
    sts.textContent=e.name==='NotAllowedError'?'‚ö† Permiss√£o do microfone negada':'Erro: '+e.message;
    btn.classList.remove('energized');
    txt.textContent='TOUCH';
    stopHomeSonic();
  }
}

function stopSonicMode(){
  sonicActive=false;
  if(sonicOsc){try{sonicOsc.stop()}catch(e){}}
  if(sonicEmitCtx){try{sonicEmitCtx.close()}catch(e){}}
  if(sonicMicCtx){try{sonicMicCtx.close()}catch(e){}}
  if(sonicStream){sonicStream.getTracks().forEach(t=>t.stop())}
  if(sonicAnimFrame)cancelAnimationFrame(sonicAnimFrame);
  sonicOsc=null;sonicEmitCtx=null;sonicMicCtx=null;sonicStream=null;sonicAnalyser=null;sonicAnimFrame=null;sonicMyFreq=0;
  if(sonicKeepAlive){clearInterval(sonicKeepAlive);sonicKeepAlive=null}
  if(S.socket&&S.socket.connected)S.socket.emit('sonic-stop',{userId:S.userId});
}

function stopHomeSonic(){
  homeSonicActive=false;
  stopSonicMode();
  const btn=$('opTouchBtn'),txt=$('opBtnText'),sts=$('opStatus');
  const barsL=$('sonicBarsL'),barsR=$('sonicBarsR'),fire=$('fireOverlay');
  const si=$('sonicInstruct');
  btn.classList.remove('energized','connected');
  txt.textContent='TOUCH';
  sts.textContent='';sts.classList.remove('active');
  barsL.classList.remove('active');barsR.classList.remove('active');
  if(fire)fire.classList.remove('active');
  if(si)si.classList.remove('active');
}

// ‚ïê‚ïê‚ïê CHECK-IN HANDLER ‚ïê‚ïê‚ïê
let flashQueue=[],flashRunning=false;
function handleNewCheckin(d){
  addCheckinToList(d);
  addNodeToCanvas(d);
  // Queue connection flash animations
  flashQueue.push(d);
  if(!flashRunning)runNextFlash();
  playBeep();
}
function runNextFlash(){
  if(flashQueue.length===0){flashRunning=false;return}
  flashRunning=true;
  const d=flashQueue.shift();
  playConnectionShow(d);
  setTimeout(runNextFlash,1500); // 1.5s between flashes
}

function addCheckinToList(d){
  S.checkins.unshift(d);
  $('opCount').textContent=S.checkins.length;
  $('opListCount').textContent=S.checkins.length;
  $('opEmpty').style.display='none';
  const sts=$('opStatus');
  sts.textContent='‚úì '+(d.nickname||'Algu√©m')+' conectou!';
  setTimeout(()=>{if(homeSonicActive){sts.textContent='Encoste o celular no alto-falante üîä'}},3000);
  const list=$('opList');
  const item=document.createElement('div');item.className='op-checkin-item';
  item.style.cursor='pointer';
  const time=new Date(d.timestamp||Date.now());
  const ts=time.getHours().toString().padStart(2,'0')+':'+time.getMinutes().toString().padStart(2,'0');
  const col=d.color||nickColor(d.nickname||'?');
  const realName=d.revealed&&d.revealData&&d.revealData.realName?d.revealData.realName:null;
  const displayName=realName||d.nickname||'Visitante';
  const revBadge=d.revealed?'<span class="op-ci-revealed">'+esc(realName||'Revelado ‚úì')+'</span>':'<div class="op-ci-badge">check-in</div>';
  const removeBtn='<button onclick="event.stopPropagation();removeAttendee(\''+esc(d.userId||'')+'\')" style="background:none;border:none;color:var(--pk);font-size:.7rem;cursor:pointer;padding:.15rem .3rem;opacity:.5;transition:opacity .2s" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=.5" title="Remover">‚úï</button>';
  item.innerHTML='<div class="op-ci-avatar" style="background:'+col+'">'+ini(d.nickname||'?')+'</div><div class="op-ci-info"><div class="op-ci-name">'+esc(displayName)+'</div><div class="op-ci-time">'+ts+'</div></div><div style="display:flex;align-items:center;gap:.3rem">'+revBadge+removeBtn+'</div>';
  item.dataset.userId=d.userId||'';
  item.onclick=(e)=>{if(e.target.tagName==='BUTTON')return;openChat(d)};
  list.prepend(item);
}

function toggleSidebar(){
  const sb=$('opSidebar');
  const arrow=$('opSidebarArrow');
  const list=$('opList');
  if(sb.classList.contains('collapsed')){
    sb.classList.remove('collapsed');
    list.style.display='';
    arrow.textContent='‚ñ∏';
  }else{
    sb.classList.add('collapsed');
    list.style.display='none';
    arrow.textContent='‚óÇ';
  }
}

async function removeAttendee(userId){
  if(!userId||!S.currentEventId)return;
  if(!confirm('Remover esta pessoa do evento?'))return;
  try{
    await fetch('/api/operator/event/'+S.currentEventId+'/leave',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId})});
    // Remove from UI
    S.checkins=S.checkins.filter(c=>c.userId!==userId);
    const items=document.querySelectorAll('.op-checkin-item');
    items.forEach(it=>{if(it.dataset.userId===userId)it.remove()});
    // Remove from canvas
    const idx=nodes.findIndex(n=>n.userId===userId);
    if(idx>=0)nodes.splice(idx,1);
    $('opCount').textContent=S.checkins.length;
    $('opListCount').textContent=S.checkins.length;
    if(S.checkins.length===0)$('opEmpty').style.display='';
  }catch(e){alert('Erro ao remover.')}
}

// ‚ïê‚ïê‚ïê FINANCIAL PANEL ‚ïê‚ïê‚ïê
async function showFinancialPanel(){
  $('opFinPanel').style.display='';
  const list=$('opFinList');const summary=$('opFinSummary');
  list.innerHTML='<div style="color:var(--t3);font-size:.7rem;text-align:center;padding:1rem">Carregando...</div>';
  summary.innerHTML='';
  try{
    const tips=await(await fetch('/api/tips/'+S.userId)).json();
    const received=tips.filter(t=>t.receiverId===S.userId);
    const paid=tips.filter(t=>t.payerId===S.userId);
    const totalReceived=received.reduce((s,t)=>s+(t.status==='approved'?t.amount:0),0);
    const totalFees=received.reduce((s,t)=>s+(t.status==='approved'?(t.fee||0):0),0);
    const net=totalReceived-totalFees;
    const pending=received.filter(t=>t.status==='pending'||t.status==='in_process').length;
    // Summary cards
    summary.innerHTML=[
      {label:'Recebido',val:'R$'+totalReceived.toFixed(2).replace('.',','),color:'var(--ok)'},
      {label:'Taxa Touch',val:'R$'+totalFees.toFixed(2).replace('.',','),color:'var(--pk)'},
      {label:'L√≠quido',val:'R$'+net.toFixed(2).replace('.',','),color:'#60a5fa'},
      {label:'Pendentes',val:pending,color:'#f59e0b'}
    ].map(c=>'<div style="flex:1;min-width:70px;padding:.6rem;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:10px"><div style="font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:.2rem">'+c.label+'</div><div style="font-size:.9rem;font-weight:700;color:'+c.color+'">'+c.val+'</div></div>').join('');
    $('opFinCount').textContent=tips.length+' transa√ß'+(tips.length===1?'√£o':'√µes');
    if(!tips.length){list.innerHTML='<div style="color:var(--t3);font-size:.7rem;text-align:center;padding:1.5rem">Nenhuma transa√ß√£o ainda.<br>As gorjetas aparecer√£o aqui.</div>';return}
    list.innerHTML='';
    tips.forEach(t=>{
      const isReceived=t.receiverId===S.userId;
      const dt=new Date(t.createdAt);
      const dateStr=dt.toLocaleDateString('pt-BR',{day:'2-digit',month:'short'})+' '+dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
      const statusColors={approved:'var(--ok)',pending:'#f59e0b',rejected:'var(--pk)',in_process:'#f59e0b'};
      const statusLabels={approved:'‚úì',pending:'‚è≥',rejected:'‚úï',in_process:'‚è≥'};
      const el=document.createElement('div');
      el.style.cssText='display:flex;align-items:center;gap:.6rem;padding:.5rem .6rem;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.04);border-radius:10px';
      el.innerHTML='<div style="font-size:.85rem">'+(isReceived?'üí∞':'üí≥')+'</div><div style="flex:1"><div style="font-size:.7rem;font-weight:600">'+(isReceived?'De: '+esc(t.payerName):'Para: '+esc(t.receiverName))+'</div><div style="font-size:.55rem;color:var(--t3)">'+dateStr+'</div></div><div style="text-align:right"><div style="font-size:.8rem;font-weight:700;color:'+(isReceived?'var(--ok)':'var(--t1)')+'">R$'+t.amount.toFixed(2).replace('.',',')+'</div><div style="font-size:.55rem;color:'+(statusColors[t.status]||'var(--t3)')+'">'+esc(statusLabels[t.status]||t.status)+'</div></div>';
      list.appendChild(el);
    });
    // Check MP connection
    try{
      const u=await(await fetch('/api/user/'+S.userId)).json();
      if(u.mpConnected){
        $('opMpStatus').innerHTML='<span style="color:var(--ok)">‚úì Conectado</span> ‚Äî pagamentos caem direto na sua conta';
        $('opMpConnectBtn').style.display='none';
      }else{
        $('opMpStatus').textContent='N√£o conectado ‚Äî gorjetas ficam retidas at√© conex√£o';
        $('opMpConnectBtn').style.display='';
      }
    }catch(e){}
  }catch(e){list.innerHTML='<div style="color:var(--pk);font-size:.7rem;text-align:center;padding:1rem">Erro ao carregar</div>'}
}

function connectMercadoPago(){
  window.open('/mp/auth/'+S.userId,'_blank');
}

// ‚ïê‚ïê‚ïê CHAT PANEL ‚ïê‚ïê‚ïê
let chatOpen=false,chatRelationId=null,chatPartnerId=null;
function openChat(d){
  if(!d.relationId&&!d.userId){console.log('[chat] no relation/user data');return}
  chatPartnerId=d.userId||d.with||null;
  chatRelationId=d.relationId||null;
  const panel=$('opChat');
  $('opChatAvatar').style.background=d.color||nickColor(d.nickname||'?');
  $('opChatAvatar').textContent=ini(d.nickname||'?');
  $('opChatName').textContent=d.nickname||d.withName||'Visitante';
  const time=new Date(d.timestamp||Date.now());
  const ts=time.getHours().toString().padStart(2,'0')+':'+time.getMinutes().toString().padStart(2,'0');
  let info='Check-in √†s '+ts;
  // Show revealed data if available
  const revBadge=$('opChatRevealBadge');
  if(d.revealed||d.revealData){
    revBadge.style.display='';
    if(d.revealData){info+='<br>Nome: '+esc(d.revealData.realName||'');if(d.revealData.instagram)info+=' | @'+esc(d.revealData.instagram)}
  }else{revBadge.style.display='none'}
  $('opChatInfo').innerHTML=info;
  // Load messages
  $('opChatMsgs').innerHTML='<div class="op-chat-empty">Carregando...</div>';
  if(chatRelationId){loadChatMessages(chatRelationId)}
  else{$('opChatMsgs').innerHTML='<div class="op-chat-empty">Sem chat dispon√≠vel (sem relationId)</div>'}
  panel.classList.add('open');chatOpen=true;
}
function closeChat(){$('opChat').classList.remove('open');chatOpen=false;chatRelationId=null;chatPartnerId=null}
async function loadChatMessages(relId){
  try{
    const r=await fetch('/api/messages/'+relId);const d=await r.json();
    const container=$('opChatMsgs');
    if(!d.messages||d.messages.length===0){container.innerHTML='<div class="op-chat-empty">Nenhuma mensagem ainda</div>';return}
    container.innerHTML='';
    d.messages.forEach(m=>{appendChatMsg(m)});
    container.scrollTop=container.scrollHeight;
  }catch(e){$('opChatMsgs').innerHTML='<div class="op-chat-empty">Erro ao carregar</div>'}
}
function appendChatMsg(m){
  const container=$('opChatMsgs');
  // Remove empty placeholder
  const empty=container.querySelector('.op-chat-empty');if(empty)empty.remove();
  const div=document.createElement('div');
  div.className='op-chat-msg '+(m.userId===S.userId?'mine':'theirs');
  const t=new Date(m.timestamp);
  const ts=t.getHours().toString().padStart(2,'0')+':'+t.getMinutes().toString().padStart(2,'0');
  div.innerHTML=esc(m.text)+'<div class="msg-time">'+ts+'</div>';
  container.appendChild(div);
  container.scrollTop=container.scrollHeight;
}
function sendChatMsg(){
  const input=$('opChatInput');const text=input.value.trim();
  if(!text||!chatRelationId||!S.socket)return;
  S.socket.emit('send-message',{relationId:chatRelationId,userId:S.userId,text});
  appendChatMsg({userId:S.userId,text,timestamp:Date.now()});
  input.value='';
}

// ‚ïê‚ïê‚ïê TOGGLE: SOMENTE REVELADOS ‚ïê‚ïê‚ïê
function toggleRequireReveal(){
  S.requireReveal=!S.requireReveal;
  const sw=$('opToggleReveal');
  if(S.requireReveal)sw.classList.add('on');else sw.classList.remove('on');
  // Save to server
  fetch('/api/operator/settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:S.userId,requireReveal:S.requireReveal})}).catch(e=>console.error('Settings save error:',e));
}
function toggleShowRealNames(){
  S.showRealNames=!S.showRealNames;
  const sw=$('opToggleNames');
  if(S.showRealNames)sw.classList.add('on');else sw.classList.remove('on');
}

async function loadOperatorSettings(){
  try{
    const r=await fetch('/api/operator/settings/'+S.userId);const d=await r.json();
    if(d.requireReveal){S.requireReveal=true;$('opToggleReveal').classList.add('on')}
  }catch(e){}
}

// ‚ïê‚ïê‚ïê CONNECTION SHOW ‚Äî lightning + shockwave ‚ïê‚ïê‚ïê
function playConnectionShow(d){
  const flash=$('opFlash');if(!flash)return;
  const W=window.innerWidth,H=window.innerHeight;
  flash.width=W;flash.height=H;flash.style.width=W+'px';flash.style.height=H+'px';flash.style.opacity='1';
  const c=flash.getContext('2d');
  const t0=performance.now(),dur=2800;
  function bolt(x0,y0,x1,y1){
    const pts=[{x:x0,y:y0}];const segs=5+Math.floor(Math.random()*5);
    for(let i=1;i<segs;i++){const t=i/segs;const spread=(1-Math.abs(t-.5)*2)*50;pts.push({x:x0+(x1-x0)*t+(Math.random()-.5)*spread,y:y0+(y1-y0)*t+(Math.random()-.5)*spread})}
    pts.push({x:x1,y:y1});return pts;
  }
  function drawB(pts,a,w){
    c.beginPath();c.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)c.lineTo(pts[i].x,pts[i].y);
    c.strokeStyle='rgba(52,211,153,'+(a*.4)+')';c.lineWidth=w*3;c.lineCap='round';c.stroke();
    c.beginPath();c.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)c.lineTo(pts[i].x,pts[i].y);
    c.strokeStyle='rgba(52,211,153,'+a+')';c.lineWidth=w;c.stroke();
    c.beginPath();c.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)c.lineTo(pts[i].x,pts[i].y);
    c.strokeStyle='rgba(255,255,255,'+(a*.9)+')';c.lineWidth=Math.max(.5,w*.3);c.stroke();
  }
  const sparks=[];for(let i=0;i<30;i++){const a=Math.random()*Math.PI*2;const sp=2+Math.random()*6;sparks.push({x:W/2,y:H/2,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,r:1+Math.random()*2,life:1})}
  let bolts=[],frame=0;
  function genBolts(){bolts=[];for(let i=0;i<6;i++){const a=Math.random()*Math.PI*2;const l=100+Math.random()*250;bolts.push(bolt(W/2,H/2,W/2+Math.cos(a)*l,H/2+Math.sin(a)*l))}}
  function animate(){
    const p=(performance.now()-t0)/dur;
    if(p>=1){c.clearRect(0,0,W,H);flash.style.opacity='0';return}
    c.clearRect(0,0,W,H);
    if(p<.3){const q=p/.3;c.fillStyle='rgba(255,255,255,'+Math.max(0,(1-q)*.5)+')';c.fillRect(0,0,W,H);
      const rr=q*Math.max(W,H)*.6;const ra=(1-q)*.6;c.beginPath();c.arc(W/2,H/2,rr,0,Math.PI*2);c.strokeStyle='rgba(52,211,153,'+ra+')';c.lineWidth=3+ra*8;c.stroke();
      const ig=c.createRadialGradient(W/2,H/2,0,W/2,H/2,rr*.6);ig.addColorStop(0,'rgba(52,211,153,'+(ra*.3)+')');ig.addColorStop(1,'transparent');c.fillStyle=ig;c.fillRect(0,0,W,H)}
    if(p>.05&&p<.6){if(frame%3===0)genBolts();const a=(1-(p-.05)/.55)*.8;bolts.forEach(b=>{drawB(b,a,1.5+Math.random())})}
    if(p<.8){sparks.forEach(s=>{s.x+=s.vx;s.y+=s.vy;s.vy+=.08;s.vx*=.99;s.life=Math.max(0,1-p/.8);
      if(s.life>0){c.beginPath();c.arc(s.x,s.y,s.r*s.life,0,Math.PI*2);c.fillStyle='rgba(52,211,153,'+s.life+')';c.fill();
        c.beginPath();c.moveTo(s.x,s.y);c.lineTo(s.x-s.vx*3,s.y-s.vy*3);c.strokeStyle='rgba(52,211,153,'+(s.life*.4)+')';c.lineWidth=s.r*.5;c.stroke()}})}
    if(p>.15){const tp=Math.min(1,(p-.15)/.3);const fo=p>.7?Math.max(0,1-(p-.7)/.3):1;
      c.save();c.globalAlpha=tp*fo;c.font='700 '+Math.min(28,W*.04)+'px Inter';c.textAlign='center';c.textBaseline='middle';
      c.fillStyle='#34d399';c.shadowColor='rgba(52,211,153,.6)';c.shadowBlur=20;
      c.fillText((d.nickname||'Visitante')+' ‚úì',W/2,H/2);c.restore()}
    frame++;requestAnimationFrame(animate);
  }
  genBolts();animate();
}

// ‚ïê‚ïê‚ïê LOAD EXISTING ‚ïê‚ïê‚ïê
async function loadExisting(){
  loadOperatorSettings();
  try{
    const r=await fetch('/api/operator/checkins/'+S.userId);const d=await r.json();
    if(d.checkins&&d.checkins.length>0){
      $('opEmpty').style.display='none';
      d.checkins.forEach(ci=>{
        const checkinData={userId:ci.with,nickname:ci.withName,color:ci.withColor,timestamp:ci.timestamp,relationId:ci.relationId,revealed:ci.revealed};
        S.checkins.push(checkinData);
        const list=$('opList');const item=document.createElement('div');
        item.className='op-checkin-item';item.style.animation='none';item.style.cursor='pointer';
        item.onclick=()=>openChat(checkinData);
        item.dataset.userId=ci.with||'';
        const time=new Date(ci.timestamp);
        const ts=time.getHours().toString().padStart(2,'0')+':'+time.getMinutes().toString().padStart(2,'0');
        const col=ci.withColor||nickColor(ci.withName||'?');
        const revBadge=ci.revealed?'<span class="op-ci-revealed">Revelado ‚úì</span>':'<div class="op-ci-badge">check-in</div>';
        item.innerHTML='<div class="op-ci-avatar" style="background:'+col+'">'+ini(ci.withName||'?')+'</div><div class="op-ci-info"><div class="op-ci-name">'+esc(ci.withName||'Visitante')+'</div><div class="op-ci-time">'+ts+'</div></div>'+revBadge;
        list.appendChild(item);
        addNodeToCanvas({nickname:ci.withName,color:ci.withColor,userId:ci.with,relationId:ci.relationId,revealed:ci.revealed},true);
      });
      $('opCount').textContent=S.checkins.length;$('opListCount').textContent=S.checkins.length;
    }
  }catch(e){}
}

// ‚ïê‚ïê‚ïê NETWORK CANVAS ‚ïê‚ïê‚ïê
let cvCtx=null,cvW=0,cvH=0,cvAnim=null;
const nodes=[],ambientP=[],bgStars=[];

function initCanvas(){
  const cv=$('opCanvas');const rect=cv.parentElement.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  cvW=rect.width;cvH=rect.height;
  cv.width=cvW*dpr;cv.height=cvH*dpr;cv.style.width=cvW+'px';cv.style.height=cvH+'px';
  cvCtx=cv.getContext('2d');cvCtx.scale(dpr,dpr);
  ambientP.length=0;bgStars.length=0;
  // Floating dust particles
  for(let i=0;i<30;i++)ambientP.push({x:Math.random()*cvW,y:Math.random()*cvH,r:.5+Math.random()*1.2,vx:(Math.random()-.5)*.08,vy:(Math.random()-.5)*.08,a:.03+Math.random()*.1,phase:Math.random()*Math.PI*2});
  // Fixed background stars ‚Äî constellation feel
  for(let i=0;i<180;i++){
    const sz=Math.random();
    bgStars.push({x:Math.random()*cvW,y:Math.random()*cvH,r:sz<.7?.4+Math.random()*.6:(sz<.92?.8+Math.random()*.8:1.5+Math.random()*1),a:sz<.7?.15+Math.random()*.15:.25+Math.random()*.3,twinkleSpeed:.5+Math.random()*2,phase:Math.random()*Math.PI*2,color:sz>.95?'#b8c0ff':(sz>.9?'#ffd6a5':'#fff')});
  }
  renderCanvas();
}

function addNodeToCanvas(d,instant){
  const stars=d.stars||0;
  const maxStars=Math.max(1,...nodes.map(n=>n.stars||0),stars);
  const maxDist=Math.min(cvW,cvH)*0.38;
  const minDist=40;
  const dist=maxDist-(stars/Math.max(1,maxStars))*(maxDist-minDist);
  const angle=Math.random()*Math.PI*2;
  const cx=cvW/2,cy=cvH/2-20;
  const x=cx+Math.cos(angle)*dist;
  const y=cy+Math.sin(angle)*dist;
  const baseR=16+Math.min(stars*.5,10);
  const n={x,y,vx:0,vy:0,r:instant?baseR:0,targetR:baseR,color:d.color||nickColor(d.nickname||'?'),name:d.nickname||'?',phase:Math.random()*Math.PI*2,glow:instant?0:1,entryAnim:instant?0:1,entryStartX:cvW/2,entryStartY:cvH/2,userId:d.userId||null,relationId:d.relationId||null,revealed:d.revealed||false,revealData:d.revealData||null,profilePhoto:d.profilePhoto||null,stars:stars,topTag:d.topTag||null,score:d.score||0,timestamp:d.timestamp||Date.now(),orbitAngle:angle,orbitDist:dist,orbitSpeed:0.0003+stars*0.00005,photoImg:null,photoLoaded:false};
  // Pre-load profile photo if revealed
  if(n.revealed&&n.profilePhoto){
    const img=new Image();img.crossOrigin='anonymous';
    img.onload=()=>{n.photoImg=img;n.photoLoaded=true};
    img.src=n.profilePhoto;
  }
  nodes.push(n);
}

function renderCanvas(){
  if(!cvCtx)return;const c=cvCtx;c.clearRect(0,0,cvW,cvH);const t=Date.now()/1000;
  const cx=cvW/2,cy=cvH/2-20;
  // ‚îÄ‚îÄ BACKGROUND: deep space with stars ‚îÄ‚îÄ
  // Subtle nebula glow
  const ng=c.createRadialGradient(cx,cy,0,cx,cy,Math.max(cvW,cvH)*.5);
  ng.addColorStop(0,'rgba(30,20,60,.25)');ng.addColorStop(.4,'rgba(15,10,40,.15)');ng.addColorStop(1,'transparent');
  c.fillStyle=ng;c.fillRect(0,0,cvW,cvH);
  // Second nebula accent
  const ng2=c.createRadialGradient(cvW*.3,cvH*.7,0,cvW*.3,cvH*.7,cvW*.35);
  ng2.addColorStop(0,'rgba(99,102,241,.04)');ng2.addColorStop(1,'transparent');
  c.fillStyle=ng2;c.fillRect(0,0,cvW,cvH);
  // Fixed background stars with twinkling
  bgStars.forEach(s=>{
    const twinkle=.5+.5*Math.sin(t*s.twinkleSpeed+s.phase);
    const a=s.a*(.6+twinkle*.4);
    c.beginPath();c.arc(s.x,s.y,s.r,0,Math.PI*2);c.fillStyle=s.color==='#fff'?'rgba(255,255,255,'+a+')':(s.color==='#b8c0ff'?'rgba(184,192,255,'+a+')':'rgba(255,214,165,'+a+')');c.fill();
    // Subtle cross-glow on brighter stars
    if(s.r>1.2){const ga=a*.3;c.beginPath();c.moveTo(s.x-s.r*2.5,s.y);c.lineTo(s.x+s.r*2.5,s.y);c.strokeStyle='rgba(255,255,255,'+ga+')';c.lineWidth=.3;c.stroke();
      c.beginPath();c.moveTo(s.x,s.y-s.r*2.5);c.lineTo(s.x,s.y+s.r*2.5);c.strokeStyle='rgba(255,255,255,'+ga+')';c.lineWidth=.3;c.stroke()}
  });
  // Floating dust particles
  ambientP.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=cvW;if(p.x>cvW)p.x=0;if(p.y<0)p.y=cvH;if(p.y>cvH)p.y=0;
    c.beginPath();c.arc(p.x,p.y,p.r,0,Math.PI*2);c.fillStyle='rgba(255,255,255,'+Math.max(0,p.a+Math.sin(t*1.5+p.phase)*.03)+')';c.fill()});
  // ‚îÄ‚îÄ Calculate center size first to set orbit clearance ‚îÄ‚îÄ
  const _evNamePre=S.currentEventName||'Touch?';
  const _cfs=Math.min(14,Math.max(9,180/(_evNamePre.length+2)));
  c.font='700 '+_cfs+'px Inter';
  const _tw=c.measureText(_evNamePre).width;
  const _centerR=Math.max(30,_tw/2+18)+4; // center radius + small margin
  // ‚îÄ‚îÄ ORBITS ‚îÄ‚îÄ
  const maxStars=Math.max(1,...nodes.map(n=>n.stars||0));
  const maxDist=Math.min(cvW,cvH)*0.38;
  const minDist=Math.max(50,_centerR+20); // orbit never overlaps center
  // Orbit rings (subtle dashed)
  [.2,.4,.6,.8].forEach(f=>{const rd=minDist+(maxDist-minDist)*f;c.beginPath();c.arc(cx,cy,rd,0,Math.PI*2);c.strokeStyle='rgba(99,102,241,.05)';c.lineWidth=.5;c.setLineDash([3,6]);c.stroke();c.setLineDash([])});
  // Orbital node movement + connection lines
  nodes.forEach(n=>{if(n.r<1)return;
    n.orbitDist=maxDist-((n.stars||0)/maxStars)*(maxDist-minDist);
    n.orbitAngle+=n.orbitSpeed;
    n.x=cx+Math.cos(n.orbitAngle)*n.orbitDist;
    n.y=cy+Math.sin(n.orbitAngle)*n.orbitDist;
    // Connection line to center
    const la=.05+Math.sin(t*.8+n.phase)*.025;c.beginPath();c.moveTo(cx,cy);c.lineTo(n.x,n.y);c.strokeStyle='rgba(99,102,241,'+la+')';c.lineWidth=.6;c.stroke();
    // Traveling dot
    const pt=(t*.4+n.phase)%1;c.beginPath();c.arc(cx+(n.x-cx)*pt,cy+(n.y-cy)*pt,1.2,0,Math.PI*2);c.fillStyle='rgba(99,102,241,.2)';c.fill()});
  // ‚îÄ‚îÄ CENTER: Event name ‚Äî adaptive size ‚îÄ‚îÄ
  const evName=S.currentEventName||'Touch?';
  // Measure text to adapt center radius
  const centerFontSize=Math.min(14,Math.max(9,180/(evName.length+2)));
  c.font='700 '+centerFontSize+'px Inter';
  const textW=c.measureText(evName).width;
  const baseCS=Math.max(30,textW/2+18);
  const cs=baseCS+Math.sin(t*1.5)*2;
  // Center glow ‚Äî blue for events
  const evColor=S.currentEventId?'rgba(96,165,250,':'rgba(99,102,241,';
  const activeColor=homeSonicActive?'rgba(255,107,53,':'rgba(99,102,241,';
  const glowColor=S.currentEventId?(homeSonicActive?activeColor:evColor):activeColor;
  const cg=c.createRadialGradient(cx,cy,0,cx,cy,cs*2.5);
  cg.addColorStop(0,glowColor+'.15)');cg.addColorStop(1,'transparent');
  c.fillStyle=cg;c.beginPath();c.arc(cx,cy,cs*2.5,0,Math.PI*2);c.fill();
  // Center circle
  c.beginPath();c.arc(cx,cy,cs,0,Math.PI*2);
  c.fillStyle=S.currentEventId?(homeSonicActive?'rgba(255,107,53,.85)':'rgba(96,165,250,.7)'):(homeSonicActive?'rgba(255,107,53,.9)':'rgba(99,102,241,.8)');
  c.fill();
  c.strokeStyle='rgba(255,255,255,.2)';c.lineWidth=1.5;c.stroke();
  // Subtle inner glow
  const ig=c.createRadialGradient(cx,cy-cs*.3,0,cx,cy,cs);
  ig.addColorStop(0,'rgba(255,255,255,.08)');ig.addColorStop(1,'transparent');
  c.fillStyle=ig;c.beginPath();c.arc(cx,cy,cs,0,Math.PI*2);c.fill();
  // Event name inside center ‚Äî prominent
  c.fillStyle='#fff';c.font='700 '+centerFontSize+'px Inter';c.textAlign='center';c.textBaseline='middle';
  c.shadowColor=S.currentEventId?'rgba(96,165,250,.6)':'rgba(99,102,241,.5)';c.shadowBlur=8;
  c.fillText(evName,cx,cy-4);
  c.shadowBlur=0;
  // Attendee count below name
  c.font='400 8px Inter';c.fillStyle='rgba(255,255,255,.45)';c.fillText(nodes.length+' pessoa'+(nodes.length!==1?'s':''),cx,cy+centerFontSize*.6+4);
  // Small dot separator + pulse effect
  if(homeSonicActive){const pa=.3+Math.sin(t*3)*.2;c.beginPath();c.arc(cx,cy+cs+8,2,0,Math.PI*2);c.fillStyle='rgba(96,165,250,'+pa+')';c.fill()}
  // ‚îÄ‚îÄ PERSON NODES ‚îÄ‚îÄ
  nodes.forEach(n=>{if(n.r<n.targetR)n.r=Math.min(n.targetR,n.r+.4);const pulse=1+Math.sin(t*1.2+n.phase)*.03;const r=n.r*pulse;
    // Entry animation
    if(n.entryAnim>0){
      n.entryAnim=Math.max(0,n.entryAnim-.008);
      const ea=n.entryAnim;
      const tx=n.entryStartX+(n.x-n.entryStartX)*(1-ea);
      const ty=n.entryStartY+(n.y-n.entryStartY)*(1-ea);
      const fontSize=10+ea*18;
      c.save();c.globalAlpha=Math.min(1,ea*2);
      c.font='700 '+fontSize+'px Inter';c.textAlign='center';c.textBaseline='middle';
      c.shadowColor=n.color;c.shadowBlur=25*ea;
      c.fillStyle='#fff';c.fillText(n.name,tx,ty);
      c.restore();
    }
    // Glow effect
    if(n.glow>0){const gr=r*4*n.glow;const g=c.createRadialGradient(n.x,n.y,0,n.x,n.y,gr);g.addColorStop(0,hexA(n.color,.3*n.glow));g.addColorStop(1,'rgba(0,0,0,0)');c.fillStyle=g;c.beginPath();c.arc(n.x,n.y,gr,0,Math.PI*2);c.fill();n.glow=Math.max(0,n.glow-.005)}
    // Top tag badge ABOVE node
    if(n.topTag&&n.entryAnim<=0){
      const tagColors={top1:'#FFD700',top5:'#C0C0C0',top50:'#CD7F32',top100:'#6a5acd'};
      const tagLabels={top1:'TOP 1',top5:'TOP 5',top50:'TOP 50',top100:'TOP 100'};
      const tagCol=tagColors[n.topTag]||'#6a5acd';const tagLbl=tagLabels[n.topTag]||'';
      if(tagLbl){
        c.save();c.font='700 6.5px Inter';c.textAlign='center';c.textBaseline='middle';
        const tw=c.measureText(tagLbl).width+8;const th=12;const tx=n.x;const ty=n.y-r-th/2-3;
        c.fillStyle=tagCol;c.globalAlpha=.9;
        c.beginPath();const br=5;c.moveTo(tx-tw/2+br,ty-th/2);c.lineTo(tx+tw/2-br,ty-th/2);c.quadraticCurveTo(tx+tw/2,ty-th/2,tx+tw/2,ty-th/2+br);c.lineTo(tx+tw/2,ty+th/2-br);c.quadraticCurveTo(tx+tw/2,ty+th/2,tx+tw/2-br,ty+th/2);c.lineTo(tx-tw/2+br,ty+th/2);c.quadraticCurveTo(tx-tw/2,ty+th/2,tx-tw/2,ty+th/2-br);c.lineTo(tx-tw/2,ty-th/2+br);c.quadraticCurveTo(tx-tw/2,ty-th/2,tx-tw/2+br,ty-th/2);c.fill();
        c.globalAlpha=1;c.fillStyle='#000';c.fillText(tagLbl,tx,ty+.5);c.restore();
      }
    }
    // Node circle ‚Äî photo or color
    if(n.revealed&&n.photoLoaded&&n.photoImg){
      c.save();c.beginPath();c.arc(n.x,n.y,r,0,Math.PI*2);c.clip();
      c.drawImage(n.photoImg,n.x-r,n.y-r,r*2,r*2);c.restore();
      c.beginPath();c.arc(n.x,n.y,r,0,Math.PI*2);c.strokeStyle='rgba(52,211,153,.7)';c.lineWidth=2;c.stroke();
    }else{
      c.beginPath();c.arc(n.x,n.y,r,0,Math.PI*2);c.fillStyle=n.color;c.fill();c.strokeStyle='rgba(255,255,255,.12)';c.lineWidth=1;c.stroke();
      if(n.revealed){c.beginPath();c.arc(n.x,n.y,r+2.5,0,Math.PI*2);c.strokeStyle='rgba(52,211,153,.5)';c.lineWidth=1.5;c.stroke()}
      // Initials inside node (bigger now)
      if(r>8){c.fillStyle='#fff';c.font='600 '+(r*.5)+'px Inter';c.textAlign='center';c.textBaseline='middle';c.fillText(ini(n.name),n.x,n.y+.5)}
    }
    // Name + stars below node
    if(r>10&&n.entryAnim<=0){
      const displayName=(S.showRealNames&&n.revealed&&n.revealData&&n.revealData.realName)?n.revealData.realName:n.name;
      c.fillStyle='rgba(255,255,255,.35)';c.font='500 7.5px Inter';c.textAlign='center';
      c.fillText(displayName.length>14?displayName.slice(0,14)+'‚Ä¶':displayName,n.x,n.y+r+11);
      if(n.stars>0){c.fillStyle='rgba(255,215,0,.55)';c.font='400 6.5px Inter';c.fillText('‚≠ê'+n.stars,n.x,n.y+r+20)}
    }});
  cvAnim=requestAnimationFrame(renderCanvas);
}
window.addEventListener('resize',()=>{if($('opApp').style.display!=='none'){if(cvAnim)cancelAnimationFrame(cvAnim);initCanvas()}});

// ‚ïê‚ïê‚ïê AUDIO ‚ïê‚ïê‚ïê
function playBeep(){
  if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended')audioCtx.resume();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sine';
  const tm=audioCtx.currentTime;o.frequency.setValueAtTime(523,tm);o.frequency.linearRampToValueAtTime(659,tm+.08);o.frequency.linearRampToValueAtTime(784,tm+.16);o.frequency.linearRampToValueAtTime(1047,tm+.25);
  g.gain.setValueAtTime(.12,tm);g.gain.linearRampToValueAtTime(.18,tm+.15);g.gain.linearRampToValueAtTime(0,tm+.5);o.start(tm);o.stop(tm+.5);
}

// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function ini(n){if(!n)return'?';const p=n.trim().split(/\s+/);return p.length>1?(p[0][0]+p[1][0]).toUpperCase():n.slice(0,2).toUpperCase()}
function nickColor(n){let h=0;for(let i=0;i<n.length;i++)h=n.charCodeAt(i)+((h<<5)-h);return'hsl('+Math.abs(h%360)+',65%,45%)'}
function hexA(color,alpha){
  if(!color)return'rgba(99,102,241,'+alpha+')';
  if(color.startsWith('hsl'))return color.replace('hsl','hsla').replace(')',','+alpha+')');
  if(color.startsWith('#')){const h=color.replace('#','');return'rgba('+(parseInt(h.substr(0,2),16)||99)+','+(parseInt(h.substr(2,2),16)||102)+','+(parseInt(h.substr(4,2),16)||241)+','+alpha+')'}
  return'rgba(99,102,241,'+alpha+')';
}
</script>
</body>
</html>
