<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#050508">
<title>ENCOSTA — tudo nasce no gesto</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#050508;--s1:#12121a;--s2:#1a1a24;--s3:#24243a;
  --b1:#2a2a3a;--b2:rgba(255,255,255,0.06);
  --t1:#f5f5f7;--t2:#8888a0;--t3:#555568;
  --ac:#ff6b35;--ac2:#ff8f65;--pk:#ff3d71;
  --gw:rgba(255,107,53,0.12);--gw2:rgba(255,107,53,0.25);
  --ok:#34d399;--warn:#fbbf24;--err:#f87171;
}
html,body{height:100%;width:100%;font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--t1);overflow:hidden;-webkit-font-smoothing:antialiased}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;visibility:hidden;opacity:0;transition:opacity 0.4s cubic-bezier(.22,1,.36,1);pointer-events:none}
.screen.active{visibility:visible;opacity:1;pointer-events:auto}

/* SPLASH */
#splash{justify-content:center;align-items:center}
#splash .logo{font-size:2.8rem;font-weight:800;letter-spacing:.35em;color:var(--ac);animation:gp 2s ease-in-out infinite}
#splash .tag{margin-top:1.2rem;font-size:.8rem;color:var(--t3);font-weight:300;letter-spacing:.15em}
@keyframes gp{0%,100%{text-shadow:0 0 20px var(--gw)}50%{text-shadow:0 0 50px var(--gw2),0 0 100px rgba(255,107,53,.08)}}

/* REGISTER */
#register{padding:2rem 1.5rem;overflow-y:auto}
.rh{text-align:center;margin-bottom:2rem;padding-top:env(safe-area-inset-top,1.5rem)}
.rh h1{font-size:1.8rem;font-weight:800;letter-spacing:.2em;color:var(--ac)}
.rh p{margin-top:.5rem;font-size:.8rem;color:var(--t2)}
.fg{margin-bottom:1.5rem}
.fg label{display:block;font-size:.7rem;color:var(--t2);text-transform:uppercase;letter-spacing:.12em;margin-bottom:.5rem;font-weight:600}
.fg input[type="text"],.fg input[type="date"]{width:100%;padding:.85rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;color:var(--t1);font-size:1rem;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s}
.fg input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.avs{display:flex;flex-direction:column;align-items:center;gap:.8rem;margin-bottom:1.5rem}
.avp{width:90px;height:90px;border-radius:50%;background:var(--s2);border:2px solid var(--b1);display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:800;color:#fff;overflow:hidden;letter-spacing:.05em;transition:all .3s}
.nick-hint{font-size:.7rem;color:var(--t3);transition:.3s}
.nick-hint.taken{color:var(--err)}.nick-hint.ok{color:var(--ok)}
.tc{display:flex;align-items:flex-start;gap:.8rem;margin-bottom:2rem;padding:1rem;background:var(--s1);border-radius:14px;border:1px solid var(--b1)}
.tc input[type="checkbox"]{width:20px;height:20px;margin-top:2px;accent-color:var(--ac);flex-shrink:0}
.tc span{font-size:.82rem;color:var(--t2);line-height:1.5}

/* BUTTONS */
.bp{width:100%;padding:.95rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:14px;color:#fff;font-size:.95rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.06em;transition:transform .12s,box-shadow .2s;box-shadow:0 4px 15px rgba(255,107,53,.3)}
.bp:active{transform:scale(.97)}.bp:disabled{opacity:.35}
.bs{padding:.65rem 1.4rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t2);font-size:.85rem;font-family:inherit;cursor:pointer}

/* HOME */
#home{display:flex;flex-direction:column;align-items:center;height:100%;padding:0;position:relative;overflow:hidden}
#home::before{content:'';position:absolute;top:38%;left:50%;width:500px;height:500px;transform:translate(-50%,-50%);border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.05) 0%,rgba(255,61,113,.02) 40%,transparent 70%);pointer-events:none;z-index:0}
/* Top bar — clean header */
.home-top{display:flex;justify-content:space-between;align-items:center;width:100%;position:relative;z-index:2;flex-shrink:0;padding:max(env(safe-area-inset-top),.8rem) 1.2rem .6rem}
.home-user{display:flex;align-items:center;gap:.6rem;cursor:pointer;-webkit-tap-highlight-color:transparent}
.home-user:active{opacity:.7}
.home-avatar{width:40px;height:40px;border-radius:50%;background:var(--s2);border:2px solid var(--ac);display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:800;color:#fff;overflow:hidden;flex-shrink:0}
.home-user-info{display:flex;flex-direction:column;gap:.15rem}
.hg{font-size:1rem;color:var(--t1);font-weight:600;letter-spacing:-.01em;line-height:1.2}
.hg .hg-nick{color:var(--ac);font-weight:700}
.home-user-meta{display:flex;align-items:center;gap:.5rem;font-size:.68rem}
.home-icons{display:flex;gap:.5rem;align-items:center}
/* Center section — takes all available space, centers the button */
.hc{text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.8rem;flex:1;position:relative;z-index:1;width:100%;padding:0 1.2rem}
.hm{font-size:.82rem;color:var(--t3);font-weight:300;font-style:italic;line-height:1.5;max-width:220px}
.daily-counter{font-size:.7rem;color:var(--t2);font-weight:400;padding:.35rem .8rem;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:20px;margin-top:.2rem}
.daily-counter strong{color:var(--ac);font-weight:700}
/* Main ENCOSTAR button */
.be{width:clamp(150px,42vw,190px);height:clamp(150px,42vw,190px);border-radius:50%;background:radial-gradient(circle at 35% 35%,#ff8f65,#ff6b35 50%,#e05520);border:none;color:#fff;font-size:.85rem;font-weight:800;font-family:inherit;letter-spacing:.25em;cursor:pointer;position:relative;z-index:1;box-shadow:0 0 50px var(--gw),0 0 100px rgba(255,107,53,.08),inset 0 1px 0 rgba(255,255,255,.15);transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.4rem}
.be:active{transform:scale(.92)}
.be .be-icon{font-size:2.4rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}
.be .be-text{font-size:.78rem;font-weight:800;letter-spacing:.25em}
.be::before{content:'';position:absolute;inset:-4px;border-radius:50%;background:conic-gradient(from 0deg,var(--ac),var(--pk),#9333ea,var(--ac));z-index:-1;animation:rs 4s linear infinite;opacity:.5;filter:blur(2px)}
.be::after{content:'';position:absolute;inset:-30px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.08),transparent 70%);z-index:-2;animation:bb 3s ease-in-out infinite}
/* Energized state */
.be.energized{animation:sonic-energy .6s ease-in-out infinite alternate;box-shadow:0 0 60px var(--gw2),0 0 120px rgba(255,107,53,.15),0 0 200px rgba(255,61,113,.06)}
.be.energized::before{animation:rs 1.5s linear infinite;opacity:.8;filter:blur(3px);inset:-8px}
.be.energized::after{animation:sonic-waves 1s ease-out infinite}
.be.energized .be-text{animation:sonic-text .8s ease infinite alternate}
@keyframes bb{0%,100%{opacity:.3}50%{opacity:.6}}
@keyframes rs{to{transform:rotate(360deg)}}
@keyframes sonic-energy{0%{transform:scale(1);box-shadow:0 0 60px var(--gw2),0 0 120px rgba(255,107,53,.15)}100%{transform:scale(1.04);box-shadow:0 0 80px var(--gw2),0 0 150px rgba(255,107,53,.2),0 0 250px rgba(255,61,113,.08)}}
@keyframes sonic-waves{0%{inset:-30px;opacity:.5}100%{inset:-80px;opacity:0}}
@keyframes sonic-text{0%{opacity:1}100%{opacity:.6}}
/* Sound wave bars on sides */
.sonic-bars{position:absolute;top:50%;display:flex;flex-direction:column;gap:3px;transform:translateY(-50%);z-index:0;opacity:0;transition:opacity .3s}
.sonic-bars.active{opacity:1}
.sonic-bars.left{left:-50px}
.sonic-bars.right{right:-50px}
.sonic-bar{height:2px;background:var(--ac);border-radius:2px;opacity:.4}
.sonic-bars.left .sonic-bar{animation:sbar-left .8s ease-in-out infinite alternate}
.sonic-bars.right .sonic-bar{animation:sbar-right .8s ease-in-out infinite alternate}
.sonic-bar:nth-child(1){width:12px;animation-delay:0s}
.sonic-bar:nth-child(2){width:20px;animation-delay:.1s}
.sonic-bar:nth-child(3){width:28px;animation-delay:.2s}
.sonic-bar:nth-child(4){width:20px;animation-delay:.3s}
.sonic-bar:nth-child(5){width:12px;animation-delay:.4s}
@keyframes sbar-left{0%{opacity:.2;transform:translateX(0)}100%{opacity:.7;transform:translateX(-6px)}}
@keyframes sbar-right{0%{opacity:.2;transform:translateX(0)}100%{opacity:.7;transform:translateX(6px)}}
.sonic-status{font-size:.72rem;color:var(--ac2);min-height:1.2em;transition:all .3s;opacity:0}
.sonic-status.active{opacity:1}
.sonic-fallback{opacity:0;transition:opacity .3s;pointer-events:none}
.sonic-fallback.active{opacity:1;pointer-events:auto}
/* FIRE — bottom of screen glow, estilo AirDrop */
.fire-overlay{position:absolute;bottom:0;left:0;right:0;height:50%;pointer-events:none;z-index:0;opacity:0;transition:opacity .5s}
.fire-overlay.active{opacity:1}
.fire-glow{position:absolute;bottom:-20%;left:50%;transform:translateX(-50%);width:140%;height:60%;background:radial-gradient(ellipse at 50% 100%,rgba(255,107,53,.35) 0%,rgba(255,61,113,.15) 30%,rgba(255,107,53,.06) 55%,transparent 75%);animation:fire-breathe 1.2s ease-in-out infinite alternate;filter:blur(8px)}
.fire-glow2{position:absolute;bottom:-10%;left:50%;transform:translateX(-50%);width:100%;height:45%;background:radial-gradient(ellipse at 50% 100%,rgba(255,140,50,.25) 0%,rgba(255,80,30,.12) 35%,transparent 65%);animation:fire-breathe 0.8s ease-in-out infinite alternate-reverse;filter:blur(12px)}
.fire-particles{position:absolute;bottom:0;left:0;right:0;height:100%;overflow:hidden}
.fire-p{position:absolute;bottom:-10px;border-radius:50%;filter:blur(2px);animation:fire-rise linear infinite}
.fire-p:nth-child(1){left:15%;width:6px;height:6px;background:#ff6b35;animation-duration:1.8s;animation-delay:0s}
.fire-p:nth-child(2){left:30%;width:4px;height:4px;background:#ff8f65;animation-duration:2.2s;animation-delay:.3s}
.fire-p:nth-child(3){left:45%;width:8px;height:8px;background:#ff6b35;animation-duration:1.5s;animation-delay:.1s}
.fire-p:nth-child(4){left:55%;width:5px;height:5px;background:#ff3d71;animation-duration:2s;animation-delay:.5s}
.fire-p:nth-child(5){left:70%;width:6px;height:6px;background:#ff8f65;animation-duration:1.7s;animation-delay:.2s}
.fire-p:nth-child(6){left:85%;width:4px;height:4px;background:#ff6b35;animation-duration:2.4s;animation-delay:.7s}
.fire-p:nth-child(7){left:25%;width:7px;height:7px;background:#ff3d71;animation-duration:1.6s;animation-delay:.4s}
.fire-p:nth-child(8){left:60%;width:5px;height:5px;background:#ff6b35;animation-duration:1.9s;animation-delay:.6s}
.fire-p:nth-child(9){left:40%;width:3px;height:3px;background:#ffa060;animation-duration:2.1s;animation-delay:.15s}
.fire-p:nth-child(10){left:75%;width:7px;height:7px;background:#ff6b35;animation-duration:1.4s;animation-delay:.35s}
.fire-p:nth-child(11){left:10%;width:5px;height:5px;background:#ff8f65;animation-duration:2.3s;animation-delay:.8s}
.fire-p:nth-child(12){left:50%;width:4px;height:4px;background:#ff3d71;animation-duration:1.6s;animation-delay:.55s}
@keyframes fire-rise{0%{transform:translateY(0) scale(1);opacity:.8}50%{opacity:1}100%{transform:translateY(-45vh) scale(0);opacity:0}}
@keyframes fire-breathe{0%{opacity:.6;transform:translateX(-50%) scale(.95)}100%{opacity:1;transform:translateX(-50%) scale(1.05)}}
/* Edge heat lines — bottom edges glow */
.fire-edge{position:absolute;bottom:0;height:3px;background:linear-gradient(90deg,transparent,var(--ac),var(--pk),var(--ac),transparent);filter:blur(1px);animation:fire-edge-pulse 1s ease-in-out infinite alternate}
.fire-edge.left{left:0;right:50%;border-radius:0 2px 0 0}
.fire-edge.right{left:50%;right:0;border-radius:2px 0 0 0}
@keyframes fire-edge-pulse{0%{opacity:.3;height:2px}100%{opacity:.8;height:4px}}
/* Sonic instruction — phones approaching animation */
.sonic-instruct{position:absolute;bottom:18%;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:.5rem;opacity:0;transition:opacity .5s;z-index:3}
.sonic-instruct.active{opacity:1}
.si-phones{position:relative;width:100px;height:60px;display:flex;align-items:center;justify-content:center}
.si-phone{width:24px;height:44px;border:2px solid var(--ac);border-radius:6px;position:absolute;background:rgba(255,107,53,.08)}
.si-phone.left{left:8px;animation:si-approach-l 2s ease-in-out infinite}
.si-phone.right{right:8px;animation:si-approach-r 2s ease-in-out infinite}
@keyframes si-approach-l{0%,100%{transform:translateX(0)}50%{transform:translateX(14px)}}
@keyframes si-approach-r{0%,100%{transform:translateX(0)}50%{transform:translateX(-14px)}}
.si-text{font-size:.65rem;color:var(--ac2);text-align:center;max-width:160px;line-height:1.4;font-weight:500;letter-spacing:.02em}
/* Screenshot block in chat */
#chat .cms{-webkit-user-select:none;user-select:none}
/* Bottom section — anchored tab bar */
.home-bottom{display:flex;flex-direction:column;align-items:center;width:100%;position:relative;z-index:2;flex-shrink:0;padding:0 1.2rem;padding-bottom:max(env(safe-area-inset-bottom),.6rem)}
.home-nav{display:flex;justify-content:space-around;width:100%;padding:.6rem 0;border-top:1px solid rgba(255,255,255,.04)}
.hn-btn{display:flex;flex-direction:column;align-items:center;gap:.25rem;background:none;border:none;color:var(--t3);font-family:inherit;cursor:pointer;padding:.6rem .6rem;border-radius:12px;transition:.15s;-webkit-tap-highlight-color:transparent;min-width:56px;flex:1;max-width:80px}
.hn-btn:active{background:rgba(255,255,255,.05);color:var(--t1);transform:scale(.95)}
.hn-ico{font-size:1.2rem;line-height:1}
.hn-lbl{font-size:.55rem;font-weight:600;letter-spacing:.04em;text-transform:uppercase;color:var(--t3);white-space:nowrap}
.home-brand-row{display:flex;align-items:center;justify-content:center;gap:.6rem;padding:.2rem 0 .1rem}
.home-brand{font-size:.5rem;font-weight:800;letter-spacing:.35em;color:var(--ac);opacity:.3}
.rb{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;position:relative}
.rb:active{transform:scale(.93)}
.rb .ct{position:absolute;top:-3px;right:-3px;min-width:16px;height:16px;border-radius:50%;background:var(--ac);font-size:.55rem;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
.cd{width:7px;height:7px;border-radius:50%;background:var(--ok);box-shadow:0 0 6px rgba(52,211,153,.5);transition:.3s}
.cd.offline{background:var(--err);box-shadow:0 0 6px rgba(248,113,113,.5)}
.cd.reconnecting{background:var(--warn);animation:bk 1s infinite}
@keyframes bk{0%,100%{opacity:1}50%{opacity:.3}}
.constellation-btn{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;position:relative}
.constellation-btn:active{transform:scale(.93)}

/* ENCOUNTER */
#encounter{padding:2rem 1.5rem;justify-content:center;align-items:center;text-align:center}
.ep{display:none;flex-direction:column;align-items:center;gap:1.5rem;width:100%}.ep.active{display:flex}
.et{font-size:.85rem;color:var(--t2);margin-bottom:.5rem}
.cdsp{font-size:2.8rem;font-weight:800;letter-spacing:.25em;color:var(--ac);font-family:'Courier New',monospace;text-shadow:0 0 20px var(--gw)}
.qb{background:#fff;padding:14px;border-radius:16px;display:inline-block;box-shadow:0 8px 30px rgba(0,0,0,.3)}
.qb canvas{display:block}
.cir{display:flex;gap:.5rem;width:100%;max-width:280px}
.cir input{flex:1;padding:.85rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;color:var(--t1);font-size:1.1rem;font-family:'Courier New',monospace;text-align:center;letter-spacing:.15em;outline:none;text-transform:uppercase}
.cir input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.cir button{padding:0 1.2rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:14px;color:#fff;font-size:1.3rem;cursor:pointer}
.od{display:flex;align-items:center;gap:1rem;color:var(--t3);font-size:.8rem;width:100%;max-width:280px}
.od::before,.od::after{content:'';flex:1;height:1px;background:var(--b1)}
.wd{color:var(--ac);font-size:1.5rem;display:flex;gap:6px;justify-content:center}
.wd span{animation:df 1.4s ease-in-out infinite;opacity:.3}
.wd span:nth-child(2){animation-delay:.2s}.wd span:nth-child(3){animation-delay:.4s}
@keyframes df{0%,100%{opacity:.3}50%{opacity:1}}

/* SONIC ENCOUNTER MODE (kept as phaseBump for compat) */
.bump-circle{width:160px;height:160px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#ff8f65,#ff6b35 50%,#e05520);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:.3rem;position:relative;box-shadow:0 0 60px var(--gw);transition:all .3s}
.bump-circle.listening{animation:sonic-energy .6s ease-in-out infinite alternate}
.bump-circle.bumped{background:radial-gradient(circle at 35% 35%,#34d399,#10b981 50%,#059669);box-shadow:0 0 80px rgba(52,211,153,.4);animation:bump-hit .5s ease}

/* REVEAL — cosmos birth animation */
#reveal{justify-content:center;align-items:center;text-align:center;padding:1.5rem;overflow:hidden;background:#020205}
.rv-cosmos{position:absolute;inset:0;z-index:0;overflow:hidden}
/* Particles / stars field */
.rv-star{position:absolute;border-radius:50%;background:#fff;opacity:0;animation:star-twinkle 4s ease infinite}
@keyframes star-twinkle{0%,100%{opacity:0}20%{opacity:.15}50%{opacity:.4}80%{opacity:.15}}
/* Central birth pulse */
.rv-birth{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:0;height:0;border-radius:50%;z-index:1}
.rv-birth-core{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:4px;height:4px;border-radius:50%;background:#fff;opacity:0;animation:birth-appear .8s ease .3s forwards}
@keyframes birth-appear{0%{width:4px;height:4px;opacity:0;box-shadow:none}50%{width:20px;height:20px;opacity:1;box-shadow:0 0 60px 20px rgba(255,107,53,.6),0 0 120px 40px rgba(255,61,113,.3)}100%{width:12px;height:12px;opacity:1;box-shadow:0 0 40px 10px rgba(255,107,53,.4),0 0 80px 30px rgba(255,61,113,.15)}}
/* Light flows from center to avatars */
.rv-flow{position:absolute;top:50%;left:50%;height:2px;transform-origin:left center;opacity:0;z-index:2}
.rv-flow::after{content:'';position:absolute;right:-4px;top:-4px;width:10px;height:10px;border-radius:50%;background:var(--ac);filter:blur(3px)}
.rv-flow.left{animation:flow-left 1.5s cubic-bezier(.22,1,.36,1) 1.2s forwards}
.rv-flow.right{animation:flow-right 1.5s cubic-bezier(.22,1,.36,1) 1.2s forwards}
@keyframes flow-left{0%{width:0;opacity:0;transform:rotate(180deg) translateY(-50%)}30%{opacity:1}100%{width:120px;opacity:.6;transform:rotate(180deg) translateY(-50%)}}
@keyframes flow-right{0%{width:0;opacity:0;transform:rotate(0deg) translateY(-50%)}30%{opacity:1}100%{width:120px;opacity:.6;transform:rotate(0deg) translateY(-50%)}}
.rv-flow .rv-trail{position:absolute;inset:0;background:linear-gradient(90deg,transparent,var(--ac),var(--pk));border-radius:2px;filter:blur(1px)}
/* Expanding ring ripples from birth */
.rv-ripple{position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;border:1px solid rgba(255,107,53,.2);transform:translate(-50%,-50%);pointer-events:none;animation:ripple-out 3.5s ease-out forwards}
@keyframes ripple-out{0%{width:0;height:0;opacity:.5}100%{width:500px;height:500px;opacity:0}}
/* Nebula glow behind center */
.rv-nebula{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:250px;height:250px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.12) 0%,rgba(255,61,113,.06) 35%,rgba(147,51,234,.03) 60%,transparent 80%);opacity:0;animation:nebula-breathe 4s ease 1s forwards;filter:blur(20px);z-index:0}
@keyframes nebula-breathe{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}30%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:.7;transform:translate(-50%,-50%) scale(1.05)}}
/* Thread connecting both avatars */
.rv-thread{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:0;height:1px;z-index:2;overflow:visible;opacity:0}
.rv-thread-line{height:1px;width:100%;background:linear-gradient(90deg,var(--ac),rgba(255,107,53,.15) 30%,rgba(255,61,113,.15) 70%,var(--ac));filter:blur(.5px)}
.rv-thread.active{animation:thread-grow 2s cubic-bezier(.22,1,.36,1) forwards}
@keyframes thread-grow{0%{width:0;opacity:0}40%{opacity:.8}100%{width:200px;opacity:.4}}
/* Main content wrapper */
.rv-wrap{position:relative;z-index:3;display:flex;flex-direction:column;align-items:center;gap:1rem;width:100%}
/* Avatars row with breathing glow */
.rv-avatars{display:flex;align-items:center;justify-content:center;gap:2.5rem;position:relative;opacity:0;animation:fi 1.2s ease .8s forwards}
.rv-avatar-wrap{position:relative;display:flex;flex-direction:column;align-items:center;gap:.5rem}
.rv-avatar-glow{position:absolute;inset:-8px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.3),transparent 70%);opacity:0;animation:avatar-glow-in 1.5s ease 2.5s forwards;filter:blur(6px)}
@keyframes avatar-glow-in{to{opacity:1}}
.rv-avatar-name{font-size:.72rem;color:var(--t2);font-weight:500;letter-spacing:.03em;opacity:0;animation:fi .8s ease 2.8s forwards}
.rv-connection-symbol{font-size:.6rem;color:var(--t3);opacity:0;letter-spacing:.2em;font-weight:600;animation:fi 1s ease 2s forwards;display:flex;flex-direction:column;align-items:center;gap:.2rem}
.rv-connection-dot{width:6px;height:6px;border-radius:50%;background:var(--ac);box-shadow:0 0 12px var(--ac);animation:dot-pulse 2s ease infinite 2.5s}
@keyframes dot-pulse{0%,100%{opacity:.4;transform:scale(1)}50%{opacity:1;transform:scale(1.3)}}
/* "algo nasceu" moment text */
.rv-moment{font-size:.68rem;color:var(--ac2);letter-spacing:.15em;text-transform:uppercase;opacity:0;animation:moment-in 1.5s ease 3.2s forwards;font-weight:500}
@keyframes moment-in{0%{opacity:0;letter-spacing:.3em}100%{opacity:.7;letter-spacing:.15em}}
/* Phrase — bigger, more cinematic */
.rv-phrase{max-width:300px;min-height:60px;display:flex;flex-wrap:wrap;justify-content:center;gap:.25rem;line-height:2}
.rv-word{display:inline-block;font-size:1.5rem;font-weight:300;color:var(--t1);opacity:0;transform:translateY(12px) scale(.95);animation:wi .7s cubic-bezier(.22,1,.36,1) forwards}
@keyframes wi{to{opacity:1;transform:none}}
/* Thin line */
.rv-line{width:30px;height:1px;background:linear-gradient(90deg,transparent,var(--ac),transparent);opacity:0;animation:fi 1s ease 5.5s forwards}
/* Sub text */
.rv-sub{font-size:.65rem;color:var(--t3);opacity:0;animation:fi 1s ease 5.8s forwards;font-weight:300;letter-spacing:.04em}
/* Renewed badge */
.rv-renewed{font-size:.72rem;color:var(--ac2);opacity:0;animation:fi .8s ease .5s forwards;letter-spacing:.08em}
.rv-last{font-size:.62rem;color:var(--t3);margin-top:.2rem;padding:.25rem .7rem;background:rgba(255,255,255,.03);border-radius:8px;border:1px solid rgba(255,255,255,.05);opacity:0;animation:fi .8s ease 3s forwards}
@keyframes fi{to{opacity:1}}
/* Enter button */
.rv-enter{opacity:0;animation:fi .8s ease 2.5s forwards}

/* CHAT */
#chat{flex-direction:column;background:var(--bg)}
.ch{display:flex;align-items:center;justify-content:space-between;padding:.6rem .8rem;background:rgba(18,18,24,.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06);padding-top:max(env(safe-area-inset-top),.6rem);flex-shrink:0;z-index:2}
.chl{display:flex;align-items:center;gap:.6rem}
.chb{width:34px;height:34px;border-radius:50%;background:transparent;border:none;color:var(--t1);font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.15s}
.chb:active{transform:scale(.9);opacity:.7}
.chn{font-size:.92rem;font-weight:600;letter-spacing:-.01em}
.cht{font-size:.82rem;font-weight:800;font-family:'Courier New',monospace;padding:.25rem .7rem;border-radius:8px;background:var(--gw);color:var(--ac);letter-spacing:.04em;transition:all .3s}
.cht.urg{background:rgba(248,113,113,.15);color:var(--err);animation:urg-pulse 1.5s ease infinite;font-size:.9rem}
@keyframes urg-pulse{0%,100%{opacity:1}50%{opacity:.6}}
.cpb{padding:.55rem 1rem;text-align:center;font-size:.75rem;color:var(--ac2);font-style:italic;background:linear-gradient(180deg,rgba(255,107,53,.06) 0%,transparent 100%);flex-shrink:0;letter-spacing:.01em}
.cms{flex:1;overflow-y:auto;padding:.6rem .8rem;display:flex;flex-direction:column;gap:.35rem;min-height:0;scroll-behavior:smooth}
.msg{max-width:78%;padding:.55rem .85rem;border-radius:18px;font-size:.86rem;line-height:1.45;word-break:break-word;animation:mi .25s ease;position:relative}
.msg.mine{align-self:flex-end;background:linear-gradient(135deg,var(--ac),#e85d2a);color:#fff;border-bottom-right-radius:4px}
.msg.theirs{align-self:flex-start;background:var(--s2);color:var(--t1);border-bottom-left-radius:4px}
.msg.ephemeral{border:1px dashed rgba(255,107,53,.35);background:rgba(255,107,53,.06);color:var(--t1);text-align:center;align-self:center;max-width:85%;font-style:italic;padding:.5rem 1rem;font-size:.8rem}
.msg.ephemeral.mine{background:rgba(255,107,53,.12);border-color:rgba(255,107,53,.4)}
.msg.ephemeral .eph-badge{display:inline-block;font-size:.55rem;text-transform:uppercase;letter-spacing:.1em;opacity:.5;margin-left:.4rem;font-style:normal}
.msg.photo{padding:.25rem}
.msg.photo img{border-radius:14px;max-width:220px;max-height:220px;display:block;object-fit:cover}
.mt{font-size:.55rem;opacity:.4;margin-top:.15rem}
@keyframes mi{from{opacity:0;transform:translateY(6px) scale(.97)}to{opacity:1;transform:none}}
.ti{display:flex;align-items:center;gap:3px;padding:.4rem .8rem;align-self:flex-start;opacity:0;height:0;overflow:hidden;transition:opacity .2s,height .2s}
.ti.vis{opacity:1;height:auto;overflow:visible}
.ti .dot{width:5px;height:5px;border-radius:50%;background:var(--t2);animation:tb 1.4s ease-in-out infinite}
.ti .dot:nth-child(2){animation-delay:.15s}.ti .dot:nth-child(3){animation-delay:.3s}
@keyframes tb{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}
/* System messages */
.msg-system{text-align:center;font-size:.7rem;color:var(--t3);padding:.5rem 1rem;font-style:italic}
/* Quick phrases bar */
.qp-bar{display:flex;gap:.35rem;padding:.4rem .8rem;overflow-x:auto;-webkit-overflow-scrolling:touch;flex-shrink:0;background:transparent;scrollbar-width:none}
.qp-bar::-webkit-scrollbar{display:none}
.qp-chip{padding:.35rem .7rem;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;color:var(--t2);font-size:.72rem;cursor:pointer;flex-shrink:0;font-family:inherit;transition:all .15s;white-space:nowrap}
.qp-chip:active{background:var(--ac);color:#fff;border-color:var(--ac);transform:scale(.95)}
.qp-chip.sent{opacity:.3;pointer-events:none}
/* Chat input area - modern */
.chat-bottom{background:rgba(18,18,24,.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-top:1px solid rgba(255,255,255,.05);flex-shrink:0;padding-bottom:max(env(safe-area-inset-bottom),.5rem)}
.chat-actions{display:flex;gap:.3rem;padding:.4rem .8rem .2rem;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.chat-actions::-webkit-scrollbar{display:none}
.ca-btn{display:flex;align-items:center;gap:.3rem;padding:.3rem .65rem;background:transparent;border:1px solid rgba(255,255,255,.08);border-radius:14px;color:var(--t3);font-size:.68rem;cursor:pointer;font-family:inherit;transition:all .15s;white-space:nowrap;flex-shrink:0}
.ca-btn:active{background:var(--ac);color:#fff;border-color:var(--ac);transform:scale(.95)}
.ca-btn .ca-ico{font-size:.8rem}
.cia{display:flex;align-items:flex-end;gap:.4rem;padding:.35rem .8rem .35rem}
.cia-wrap{flex:1;display:flex;align-items:flex-end;background:var(--s2);border:1px solid rgba(255,255,255,.08);border-radius:22px;transition:border-color .2s;overflow:hidden}
.cia-wrap:focus-within{border-color:var(--ac)}
.cia-plus{width:34px;height:34px;border:none;background:transparent;color:var(--t3);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.15s;padding:0 0 0 .3rem}
.cia-plus:active{color:var(--ac);transform:scale(.9)}
.cia input{flex:1;padding:.6rem .7rem .6rem .2rem;background:transparent;border:none;color:var(--t1);font-size:.86rem;font-family:inherit;outline:none;min-height:20px}
.sb{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--ac),#e85d2a);border:none;color:#fff;font-size:.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;opacity:0;transform:scale(.5);pointer-events:none;flex-shrink:0}
.sb.active{opacity:1;transform:scale(1);pointer-events:auto}
.sb:active{transform:scale(.88)}
/* Plus menu overlay */
.plus-menu{position:absolute;bottom:100%;left:.5rem;right:.5rem;background:rgba(24,24,32,.97);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:.5rem;display:grid;grid-template-columns:repeat(4,1fr);gap:.3rem;transform:translateY(8px);opacity:0;pointer-events:none;transition:all .2s ease;z-index:10;margin-bottom:.4rem}
.plus-menu.open{transform:translateY(0);opacity:1;pointer-events:auto}
.pm-item{display:flex;flex-direction:column;align-items:center;gap:.3rem;padding:.6rem .3rem;border-radius:12px;cursor:pointer;transition:.15s;border:none;background:transparent;font-family:inherit;color:var(--t1)}
.pm-item:active{background:rgba(255,255,255,.06);transform:scale(.95)}
.pm-ico{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.15rem}
.pm-label{font-size:.62rem;color:var(--t2);text-align:center;letter-spacing:.02em}
.selfie-btn{font-size:1rem;cursor:pointer;padding:.25rem;opacity:.5;transition:.2s;background:none;border:none;color:var(--t1)}
.selfie-btn:active{opacity:1;transform:scale(1.15)}

/* RELATIONS */
#relations{flex-direction:column;background:var(--bg)}
.rlh{display:flex;align-items:center;gap:.8rem;padding:1rem 1.2rem;background:linear-gradient(180deg,var(--s1) 0%,var(--bg) 100%);border-bottom:1px solid rgba(255,255,255,.04);padding-top:max(env(safe-area-inset-top),1rem)}
.rlh h2{font-size:1.15rem;font-weight:700;letter-spacing:-.01em}
.rlh-sub{font-size:.7rem;color:var(--t3);font-weight:400;margin-left:auto}
.rll{flex:1;overflow-y:auto;padding:.6rem .8rem}
.rc{display:flex;align-items:center;gap:.9rem;padding:1rem;margin-bottom:.6rem;background:linear-gradient(135deg,var(--s1),rgba(26,26,36,.8));border:1px solid rgba(255,255,255,.06);border-radius:18px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.rc::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--ac);border-radius:3px 0 0 3px;opacity:.5;transition:opacity .2s}
.rc:active{background:var(--s2);transform:scale(.98);border-color:var(--ac)}.rc:active::before{opacity:1}
.rav{display:flex;align-items:center;justify-content:center;flex-shrink:0}
.ri{flex:1;min-width:0}
.rn{font-size:1.05rem;font-weight:600;letter-spacing:-.01em;color:var(--t1)}
.rp{font-size:.8rem;color:var(--t2);margin-top:.25rem;font-style:italic;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.rtm-wrap{display:flex;flex-direction:column;align-items:flex-end;gap:.2rem;flex-shrink:0}
.rtm{font-size:.75rem;font-family:'Courier New',monospace;font-weight:700;flex-shrink:0;padding:.25rem .6rem;border-radius:10px;background:rgba(52,211,153,.08)}
.rtm.ok{color:var(--ok);background:rgba(52,211,153,.08)}.rtm.med{color:var(--warn);background:rgba(251,191,36,.08)}.rtm.low{color:var(--err);background:rgba(248,113,113,.08);animation:urg-pulse 1.5s ease infinite}
.rtm-label{font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em}
.nr{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--t2);text-align:center;padding:2.5rem;font-size:1rem;line-height:1.8}
.nr-icon{font-size:3rem;margin-bottom:1rem;opacity:.3}
.nr-text{font-size:.88rem;color:var(--t3);max-width:240px}

/* STREAK */
.streak-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:10px;font-size:.7rem;color:#fbbf24;font-weight:600}
.streak-badge .streak-fire{font-size:.75rem}
.streak-info{padding:.5rem .8rem;background:linear-gradient(135deg,rgba(251,191,36,.06),rgba(255,107,53,.06));border:1px solid rgba(251,191,36,.12);border-radius:12px;margin:.3rem .8rem;font-size:.75rem;color:var(--t2);display:flex;align-items:center;justify-content:space-between}
.streak-progress{height:3px;background:rgba(255,255,255,.06);border-radius:2px;flex:1;margin:0 .6rem;overflow:hidden}
.streak-bar{height:100%;background:linear-gradient(90deg,#fbbf24,#ff6b35);border-radius:2px;transition:width .3s ease}
/* Streak unlock modal */
.streak-unlock-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;animation:fadeIn .3s ease}
.streak-unlock-card{background:linear-gradient(170deg,#161628,#0c0c18);border:1px solid rgba(251,191,36,.3);border-radius:20px;padding:2rem;text-align:center;max-width:300px;width:90%;animation:mi .4s ease}
.streak-unlock-card .su-emoji{font-size:2.5rem;margin-bottom:.8rem}
.streak-unlock-card .su-title{font-size:1.1rem;font-weight:700;color:#fbbf24;margin-bottom:.4rem}
.streak-unlock-card .su-desc{font-size:.8rem;color:var(--t2);margin-bottom:1rem;line-height:1.5}
.streak-unlock-card .su-content{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:.8rem;margin-bottom:1rem;font-size:.85rem;font-style:italic;color:var(--ac2);line-height:1.5}
/* Touch link */
.touch-link-area{padding:1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin:.8rem;text-align:center}
.touch-link-url{font-size:.65rem;color:var(--t3);word-break:break-all;margin:.5rem 0;padding:.4rem;background:var(--s2);border-radius:8px;font-family:'Courier New',monospace}
.touch-link-actions{display:flex;gap:.4rem;justify-content:center;margin-top:.5rem}
.touch-link-actions button{padding:.4rem .8rem;font-size:.7rem}

/* SCORE + STARS BADGE */
.pts-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;background:var(--gw);border:1px solid rgba(255,107,53,.15);border-radius:12px;font-size:.7rem;color:var(--ac);font-weight:600}
/* score/stars hidden — data preserved internally */
.pts-partner{font-size:.68rem;color:var(--t3);padding:.15rem .5rem;background:var(--s1);border:1px solid var(--b1);border-radius:8px;display:inline-flex;align-items:center;gap:.3rem}
.pts-partner strong{color:var(--ac2)}

/* BOARDING PASS */
#boardingPass{justify-content:center;align-items:center;padding:1.5rem;text-align:center;background:var(--bg)}
.bp-card{width:320px;background:linear-gradient(170deg,#0c0c18,#161628,#0c0c18);border:1px solid var(--b1);border-radius:20px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.6);position:relative}
.bp-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--ac),var(--pk),var(--ac))}
.bp-top{padding:1.2rem 1.5rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed var(--b1)}
.bp-logo{font-size:.7rem;font-weight:800;letter-spacing:.3em;color:var(--ac)}
.bp-type{font-size:.55rem;color:var(--t3);letter-spacing:.15em;text-transform:uppercase}
.bp-body{padding:1.5rem}
.bp-avatar{width:60px;height:60px;border-radius:50%;background:var(--s2);border:2px solid var(--ac);margin:0 auto .8rem;display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:800;color:#fff;letter-spacing:.03em;overflow:hidden}
.bp-name{font-size:1.2rem;font-weight:700;color:var(--t1);margin-bottom:.2rem}
.bp-since{font-size:.65rem;color:var(--t3);margin-bottom:1.2rem}
.bp-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.8rem;margin-bottom:1.2rem}
.bp-stat{text-align:center}
.bp-stat-num{font-size:1.4rem;font-weight:800;color:var(--ac);line-height:1}
.bp-stat-label{font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-top:.3rem}
.bp-barcode{padding:1rem 1.5rem;border-top:1px dashed var(--b1);display:flex;justify-content:center;gap:2px}
.bp-bar{width:2px;background:var(--t3);border-radius:1px}
.bp-footer{padding:.6rem;font-size:.5rem;color:var(--t3);letter-spacing:.15em;text-align:center}
.bp-actions{display:flex;gap:.8rem;margin-top:1.2rem}
.bp-dl{padding:.6rem 1.2rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:12px;color:#fff;font-size:.8rem;font-weight:600;cursor:pointer;font-family:inherit}
.bp-dl:active{transform:scale(.96)}

/* CONSTELLATION / REDE */
#history{flex-direction:column;background:var(--bg);position:relative;overflow:hidden}
.const-header{display:flex;align-items:center;gap:.8rem;padding:.8rem 1.2rem;padding-top:max(env(safe-area-inset-top),.8rem);position:absolute;top:0;left:0;right:0;z-index:10}
.const-header h2{font-size:.9rem;font-weight:500;color:var(--t2);letter-spacing:.05em}
.const-copy{position:absolute;top:0;left:0;right:0;text-align:center;padding-top:calc(max(env(safe-area-inset-top),.8rem) + 3rem);z-index:5;pointer-events:none}
.const-copy p{font-size:.7rem;color:var(--t3);font-weight:300;font-style:italic;line-height:1.7;letter-spacing:.02em}
.const-canvas-wrap{position:absolute;inset:0;z-index:1}
.const-canvas-wrap canvas{width:100%;height:100%;touch-action:none}
/* Node detail overlay */
.const-detail{position:absolute;bottom:0;left:0;right:0;z-index:20;background:linear-gradient(180deg,transparent 0%,rgba(5,5,8,.95) 40%);padding:2rem 1.5rem;padding-bottom:max(env(safe-area-inset-bottom),2rem);display:flex;flex-direction:column;align-items:center;gap:.5rem;opacity:0;transform:translateY(20px);transition:all .35s cubic-bezier(.22,1,.36,1);pointer-events:none}
.const-detail.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.const-detail-avatar{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:800;color:#fff;border:2px solid rgba(255,255,255,.1)}
.const-detail-nick{font-size:1rem;font-weight:600;color:var(--t1)}
.const-detail-text{font-size:.72rem;color:var(--t3);font-style:italic;font-weight:300}
.const-empty{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.8rem;z-index:5;padding:2rem}
.const-empty-icon{font-size:2rem;opacity:.2}
.const-empty-text{font-size:.8rem;color:var(--t3);font-weight:300;text-align:center;line-height:1.7;max-width:220px}
.const-feedback{position:absolute;top:calc(max(env(safe-area-inset-top),.8rem) + 3.5rem);left:50%;transform:translateX(-50%);z-index:15;font-size:.68rem;color:var(--ac2);font-weight:400;font-style:italic;opacity:0;transition:opacity .5s;pointer-events:none;white-space:nowrap}
.const-feedback.show{opacity:1}

/* EXPIRE CARD */
#expireCard{justify-content:center;align-items:center;padding:2rem;text-align:center}
.ev{width:270px;aspect-ratio:9/16;background:linear-gradient(170deg,#0a0a12,#15152a,#0a0a12);border:1px solid var(--b2);border-radius:24px;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:2.5rem;gap:1.5rem;position:relative;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.ev::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg,transparent,rgba(255,107,53,.04),transparent,rgba(255,61,113,.04),transparent);animation:sh 10s linear infinite}
@keyframes sh{to{transform:rotate(360deg)}}
.ev .cl{font-size:.85rem;font-weight:800;letter-spacing:.3em;color:var(--ac);opacity:.5;position:relative}
.ev .cf{font-size:1.15rem;font-weight:300;color:var(--t1);line-height:1.7;position:relative}
.ev .ctm{font-size:.72rem;color:var(--t2);position:relative}
.ev .cft{font-size:.6rem;color:var(--t3);position:absolute;bottom:1.5rem}
.ea{display:flex;gap:1rem;margin-top:1.5rem}

/* PROFILE */
#profile{flex-direction:column;background:var(--bg)}
.pf-header{display:flex;align-items:center;gap:.8rem;padding:1rem;background:var(--s1);border-bottom:1px solid var(--b1);padding-top:max(env(safe-area-inset-top),1rem)}
.pf-header h2{font-size:1.05rem;font-weight:600}
.pf-scroll{flex:1;overflow-y:auto;padding:1rem}
.pf-card{text-align:center;padding:1.5rem;background:var(--s1);border:1px solid var(--b1);border-radius:18px;margin-bottom:1rem}
.pf-stats{display:flex;justify-content:center;gap:1.5rem;margin-top:1rem}
.pf-stat{text-align:center}
.pf-stat-num{font-size:1.3rem;font-weight:800;color:var(--ac)}
.pf-stat-lbl{font-size:.6rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em}
.pf-section{margin-bottom:1.2rem}
.pf-section-title{font-size:.75rem;color:var(--t2);text-transform:uppercase;letter-spacing:.12em;font-weight:600;margin-bottom:.6rem;padding-left:.3rem}
.pf-decl{padding:.7rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;margin-bottom:.5rem;border-left:3px solid var(--ac)}
.pf-decl-text{font-size:.85rem;color:var(--t1);font-style:italic;line-height:1.5;margin-bottom:.3rem}
.pf-decl-from{font-size:.65rem;color:var(--t3)}
.pf-gift{display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;margin-bottom:.5rem}
.pf-gift-emoji{font-size:1.4rem}
.pf-gift-info{flex:1;min-width:0}
.pf-gift-name{font-size:.82rem;color:var(--t1);font-weight:500}
.pf-gift-from{font-size:.65rem;color:var(--t3)}
.pf-gift-msg{font-size:.72rem;color:var(--t2);font-style:italic;margin-top:.1rem}
.pf-actions{display:flex;gap:.5rem;margin-top:1rem;flex-wrap:wrap;justify-content:center}
.pf-act-btn{padding:.5rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t2);font-size:.78rem;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:.4rem;transition:.15s}
.pf-act-btn:active{background:var(--ac);color:#fff;border-color:var(--ac)}
.pf-empty{font-size:.8rem;color:var(--t3);text-align:center;padding:1rem;font-style:italic}

/* GIFT PICKER MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:flex;align-items:flex-end;justify-content:center;animation:mfade .2s ease}
@keyframes mfade{from{opacity:0}to{opacity:1}}
.modal-sheet{width:100%;max-width:420px;max-height:75vh;background:var(--s1);border-radius:20px 20px 0 0;padding:1.2rem;overflow-y:auto;animation:mslide .25s ease}
@keyframes mslide{from{transform:translateY(100%)}to{transform:none}}
.modal-handle{width:36px;height:4px;border-radius:2px;background:var(--b1);margin:0 auto .8rem}
.modal-title{font-size:1rem;font-weight:700;text-align:center;margin-bottom:1rem}
.gift-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:1rem}
.gift-option{padding:.8rem;background:var(--s2);border:1px solid var(--b1);border-radius:14px;text-align:center;cursor:pointer;transition:.15s}
.gift-option:active{border-color:var(--ac);background:var(--gw)}
.gift-option .g-emoji{font-size:1.6rem}
.gift-option .g-name{font-size:.78rem;font-weight:600;color:var(--t1);margin-top:.3rem}
.gift-option .g-desc{font-size:.62rem;color:var(--t3);margin-top:.2rem}
.decl-input{width:100%;padding:.8rem;background:var(--s2);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:.88rem;font-family:inherit;resize:none;outline:none;min-height:80px}
.decl-input:focus{border-color:var(--ac)}
.decl-counter{font-size:.6rem;color:var(--t3);text-align:right;margin-top:.3rem}
.gift-msg-input{width:100%;padding:.6rem;background:var(--s2);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;margin-top:.6rem}
.gift-msg-input:focus{border-color:var(--ac)}

/* ADDRESS REQUEST BANNER */
.addr-request{padding:.8rem 1rem;background:linear-gradient(135deg,rgba(255,107,53,.08),rgba(255,61,113,.05));border:1px solid rgba(255,107,53,.15);border-radius:14px;margin:.5rem .8rem;animation:mi .3s ease}
.addr-request-text{font-size:.82rem;color:var(--t1);line-height:1.5;margin-bottom:.6rem}
.addr-request-note{font-size:.68rem;color:var(--t3);margin-bottom:.6rem;font-style:italic}
.addr-input{width:100%;padding:.6rem;background:var(--s2);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;margin-bottom:.5rem}
.addr-input:focus{border-color:var(--ac)}
.addr-actions{display:flex;gap:.5rem}
.addr-btn{padding:.4rem .8rem;border-radius:10px;font-size:.75rem;font-family:inherit;cursor:pointer;border:none}
.addr-btn.accept{background:var(--ac);color:#fff}
.addr-btn.decline{background:var(--s2);color:var(--t2);border:1px solid var(--b1)}

/* LOCATION / EVENTS */
#locationScreen{flex-direction:column;background:var(--bg)}
#eventDetail{flex-direction:column;background:var(--bg)}
.loc-header{display:flex;align-items:center;gap:.8rem;padding:.8rem 1rem;background:var(--s1);border-bottom:1px solid var(--b1);padding-top:max(env(safe-area-inset-top),1rem)}
.loc-header h2{font-size:1rem;font-weight:600;flex:1}
.loc-header .bs{font-size:.68rem;padding:.3rem .7rem}
.loc-scroll{flex:1;overflow-y:auto;padding:1rem;-webkit-overflow-scrolling:touch}
.loc-status{text-align:center;padding:.7rem;font-size:.75rem;color:var(--t2);background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin-bottom:.8rem;display:flex;align-items:center;justify-content:center;gap:.4rem}
.loc-status.active{border-color:var(--ok);color:var(--ok);background:rgba(52,211,153,.05)}
.loc-status.error{border-color:var(--err);color:var(--err)}
.loc-tabs{display:flex;gap:.3rem;margin-bottom:.8rem;background:var(--s1);border-radius:12px;padding:.25rem;border:1px solid var(--b1)}
.loc-tab{flex:1;padding:.45rem;text-align:center;font-size:.75rem;font-weight:600;background:transparent;border:none;border-radius:10px;color:var(--t3);cursor:pointer;font-family:inherit;transition:.2s}
.loc-tab.active{background:var(--ac);color:#fff;box-shadow:0 2px 8px rgba(255,107,53,.3)}
.loc-person{display:flex;align-items:center;gap:.6rem;padding:.65rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin-bottom:.5rem;transition:.15s;animation:mi .3s ease}
.loc-person:active{background:var(--s2);transform:scale(.98)}
.loc-person-info{flex:1;min-width:0}
.loc-person-nick{font-size:.82rem;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.loc-person-dist{font-size:.62rem;color:var(--t3);margin-top:.1rem}
.loc-person-pts{font-size:.65rem;color:var(--ac);margin-top:.1rem}
.loc-encosta-btn{padding:.35rem .7rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:10px;color:#fff;font-size:.68rem;font-weight:700;cursor:pointer;font-family:inherit;flex-shrink:0;letter-spacing:.03em;box-shadow:0 2px 8px rgba(255,107,53,.2);transition:.15s}
.loc-encosta-btn:active{transform:scale(.94)}
.evt-card{padding:.8rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin-bottom:.5rem;transition:.15s;animation:mi .3s ease}
.evt-card:active{background:var(--s2);transform:scale(.98)}
.evt-card-name{font-size:.88rem;font-weight:700;color:var(--t1);margin-bottom:.25rem}
.evt-card-meta{font-size:.65rem;color:var(--t3);display:flex;gap:.8rem;margin-bottom:.25rem}
.evt-card-desc{font-size:.72rem;color:var(--t2);font-style:italic;line-height:1.4}
.evt-card-people{font-size:.65rem;color:var(--ac);margin-top:.25rem;font-weight:500}
.evt-detail{padding:1.2rem;background:var(--s1);border:1px solid var(--b1);border-radius:16px;margin-bottom:1rem}
.evt-detail-name{font-size:1.05rem;font-weight:700;color:var(--t1);margin-bottom:.4rem}
.evt-detail-desc{font-size:.8rem;color:var(--t2);font-style:italic;margin-bottom:.8rem;line-height:1.5;padding:.5rem .6rem;background:var(--s2);border-radius:10px}
.evt-ppl-title{font-size:.7rem;color:var(--t2);text-transform:uppercase;letter-spacing:.1em;font-weight:600;margin-bottom:.5rem}
.loc-create-form{padding:1.2rem;background:var(--s1);border:1px solid var(--b1);border-radius:16px;margin-bottom:1rem;animation:mi .3s ease}
.loc-create-form .form-title{font-size:.92rem;font-weight:700;color:var(--t1);margin-bottom:.3rem}
.loc-create-form .form-sub{font-size:.68rem;color:var(--t3);margin-bottom:1rem;line-height:1.4}
.loc-fg{margin-bottom:.8rem}
.loc-fg label{display:block;font-size:.65rem;color:var(--t2);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.3rem;font-weight:600}
.loc-fg input,.loc-fg textarea{width:100%;padding:.65rem .8rem;background:var(--s2);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s}
.loc-fg textarea{min-height:60px;resize:none}
.loc-fg input:focus,.loc-fg textarea:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.loc-empty{text-align:center;padding:2.5rem 1rem;color:var(--t3);font-size:.82rem;line-height:1.6}
.loc-empty-icon{font-size:2rem;margin-bottom:.6rem;opacity:.5}

/* REVEAL EXTRAS */
.rv-last{font-size:.68rem;color:var(--t3);margin-top:.4rem;padding:.3rem .8rem;background:var(--s1);border-radius:10px;border:1px solid var(--b1)}

/* CONTACT REQUEST */
.contact-menu{display:flex;gap:.3rem;flex-wrap:wrap;padding:.4rem .8rem;animation:mi .3s ease}
.contact-opt{padding:.3rem .6rem;font-size:.68rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;color:var(--t2);cursor:pointer;font-family:inherit}
.contact-opt:active{background:var(--s2)}
.contact-req-banner{padding:.6rem .8rem;background:linear-gradient(135deg,rgba(255,107,53,.06),rgba(255,61,113,.04));border:1px solid rgba(255,107,53,.12);border-radius:12px;margin:.4rem .8rem;animation:mi .3s ease}
.contact-req-text{font-size:.78rem;color:var(--t1);margin-bottom:.4rem}
.contact-req-actions{display:flex;gap:.4rem}
.contact-req-input{width:100%;padding:.4rem .6rem;background:var(--s2);border:1px solid var(--b1);border-radius:8px;color:var(--t1);font-size:.78rem;font-family:inherit;outline:none;margin-bottom:.4rem}

/* ENCOSTA REQUEST NOTIFICATION */
.encosta-req-banner{position:fixed;top:max(env(safe-area-inset-top),1rem);left:1rem;right:1rem;padding:1rem;background:var(--s1);border:1px solid var(--ac);border-radius:16px;z-index:9000;animation:mi .3s ease;box-shadow:0 8px 30px rgba(0,0,0,.5)}
.encosta-req-title{font-size:.82rem;font-weight:600;color:var(--t1);margin-bottom:.4rem}
.encosta-req-sub{font-size:.68rem;color:var(--t3);margin-bottom:.6rem}
.encosta-req-actions{display:flex;gap:.5rem}

/* LANG SWITCHER */
.lang-sw{display:flex;gap:.25rem}
.lang-btn{padding:.15rem .35rem;background:transparent;border:1px solid rgba(255,255,255,.06);border-radius:6px;color:var(--t3);font-size:.52rem;font-weight:600;cursor:pointer;font-family:inherit;text-transform:uppercase;transition:.15s}
.lang-btn.active{color:var(--ac);border-color:rgba(255,107,53,.3)}

/* ONBOARDING */
#onboarding{padding:0;overflow:hidden;background:var(--bg)}
.onb-slides{display:flex;transition:transform .4s cubic-bezier(.22,1,.36,1);height:100%}
.onb-slide{min-width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2.5rem 2rem;text-align:center;position:relative}
.onb-icon{font-size:3.5rem;margin-bottom:1.5rem;opacity:0;animation:fi .8s ease .3s forwards}
.onb-title{font-size:1.4rem;font-weight:800;color:var(--t1);margin-bottom:.6rem;letter-spacing:-.02em;opacity:0;animation:fi .8s ease .5s forwards}
.onb-desc{font-size:.85rem;color:var(--t2);line-height:1.7;max-width:280px;opacity:0;animation:fi .8s ease .7s forwards}
.onb-dots{position:absolute;bottom:max(env(safe-area-inset-bottom),2rem);left:50%;transform:translateX(-50%);display:flex;gap:.5rem}
.onb-dot{width:8px;height:8px;border-radius:50%;background:var(--b1);transition:all .3s}
.onb-dot.active{background:var(--ac);width:24px;border-radius:4px}
.onb-nav{position:absolute;bottom:calc(max(env(safe-area-inset-bottom),2rem) + 2rem);left:50%;transform:translateX(-50%);display:flex;gap:.8rem;align-items:center}
.onb-skip{padding:.5rem 1rem;background:transparent;border:none;color:var(--t3);font-size:.78rem;font-family:inherit;cursor:pointer}
.onb-next{padding:.6rem 1.8rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:14px;color:#fff;font-size:.85rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.04em}
.onb-next:active{transform:scale(.96)}

/* ZODIAC */
/* Zodiac area — poetic, constellation-style */
.zodiac-area{margin-top:.6rem;opacity:0;animation:fi 1.2s ease 6s forwards;display:flex;flex-direction:column;align-items:center;gap:.8rem}
.zodiac-elements{font-size:.68rem;color:var(--t3);letter-spacing:.2em;text-transform:lowercase;font-weight:300}
.zodiac-elements em{color:var(--ac2);font-style:normal;font-weight:500;letter-spacing:.1em}
/* Constellation glyphs — large, elegant, thin */
.zodiac-constellation{display:flex;align-items:center;gap:1.8rem;justify-content:center}
.zc-sign{display:flex;flex-direction:column;align-items:center;gap:.4rem}
.zc-glyph{width:56px;height:56px;border-radius:50%;background:transparent;border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:1.8rem;color:var(--t1);font-weight:200;position:relative;overflow:hidden}
.zc-glyph::before{content:'';position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.06) 0%,transparent 70%)}
.zc-glyph::after{content:'';position:absolute;inset:-1px;border-radius:50%;border:1px solid transparent;background:conic-gradient(from 0deg,rgba(255,107,53,.15),transparent 30%,transparent 70%,rgba(255,61,113,.15)) border-box;-webkit-mask:linear-gradient(#fff 0 0) padding-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude}
.zc-trait{font-size:.52rem;color:var(--t3);text-transform:uppercase;letter-spacing:.15em;font-weight:500}
.zc-name{font-size:.5rem;color:rgba(255,255,255,.2);letter-spacing:.08em;font-weight:400}
.zc-bridge{display:flex;flex-direction:column;align-items:center;gap:.3rem}
.zc-line{width:30px;height:1px;background:linear-gradient(90deg,rgba(255,107,53,.3),rgba(255,61,113,.3));position:relative}
.zc-line::after{content:'';position:absolute;top:-2px;left:50%;transform:translateX(-50%);width:5px;height:5px;border-radius:50%;background:var(--ac);opacity:.4;box-shadow:0 0 8px var(--ac)}
/* Zodiac phrase — pure poetry, no box */
.zodiac-phrase{font-size:.85rem;color:var(--t2);font-style:italic;line-height:1.7;max-width:260px;text-align:center;font-weight:300;letter-spacing:.01em}

/* REVEAL SELFIE v2 — side by side */
.rv-actions{display:flex;flex-direction:column;gap:.5rem;align-items:center;justify-content:center;opacity:0;animation:fi .8s ease 6.5s forwards;width:100%;max-width:280px}
.rv-btn-enter{width:100%;padding:.9rem 2rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:16px;color:#fff;font-size:.88rem;font-weight:600;font-family:inherit;cursor:pointer;letter-spacing:.06em;box-shadow:0 4px 20px rgba(255,107,53,.25);transition:all .15s}
.rv-btn-enter:active{transform:scale(.97)}
.rv-btn-photo{display:flex;align-items:center;justify-content:center;gap:.4rem;width:100%;padding:.7rem 1.2rem;background:transparent;border:1px solid rgba(255,255,255,.08);border-radius:14px;color:var(--t3);font-size:.75rem;font-family:inherit;cursor:pointer;transition:all .15s;letter-spacing:.03em}
.rv-btn-photo:active{background:rgba(255,255,255,.04);transform:scale(.97)}
.rv-btn-photo .rv-ico{font-size:.9rem}

/* CONNECTING OVERLAY — after sonic match, before reveal */
/* Connecting overlay — organic cosmos birth */
.connecting-overlay{position:fixed;inset:0;z-index:150;background:#020205;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.2rem;opacity:0;pointer-events:none;transition:opacity .4s}
.connecting-overlay.active{opacity:1;pointer-events:auto}
.co-canvas{position:absolute;inset:0;overflow:hidden}
/* Breathing center orb */
.co-orb{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:8px;border-radius:50%;background:#fff;animation:co-orb-birth 3s ease forwards}
@keyframes co-orb-birth{0%{width:4px;height:4px;opacity:0;box-shadow:none}15%{width:12px;height:12px;opacity:1;box-shadow:0 0 40px 15px rgba(255,107,53,.5),0 0 80px 30px rgba(255,61,113,.2)}40%{width:16px;height:16px;box-shadow:0 0 60px 20px rgba(255,107,53,.6),0 0 120px 50px rgba(255,61,113,.3),0 0 200px 80px rgba(147,51,234,.1)}70%{width:10px;height:10px;opacity:.9;box-shadow:0 0 30px 10px rgba(255,107,53,.4),0 0 60px 25px rgba(255,61,113,.15)}100%{width:8px;height:8px;opacity:.8;box-shadow:0 0 20px 8px rgba(255,107,53,.3),0 0 50px 20px rgba(255,61,113,.1)}}
/* Expanding ring waves */
.co-ring{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border-radius:50%;border:1px solid rgba(255,107,53,.15);width:0;height:0;animation:co-ring-expand 2.5s ease-out forwards}
.co-ring:nth-child(2){animation-delay:.3s;border-color:rgba(255,61,113,.12)}
.co-ring:nth-child(3){animation-delay:.6s;border-color:rgba(147,51,234,.08)}
.co-ring:nth-child(4){animation-delay:.9s;border-color:rgba(255,107,53,.06)}
@keyframes co-ring-expand{0%{width:0;height:0;opacity:.6}100%{width:400px;height:400px;opacity:0}}
/* Tiny floating particles */
.co-particle{position:absolute;border-radius:50%;background:var(--ac);opacity:0;filter:blur(1px)}
.co-particle:nth-child(1){top:45%;left:48%;width:3px;height:3px;animation:co-p-float 2s ease .5s forwards}
.co-particle:nth-child(2){top:52%;left:50%;width:2px;height:2px;animation:co-p-float 2.5s ease .7s forwards;background:var(--pk)}
.co-particle:nth-child(3){top:48%;left:52%;width:4px;height:4px;animation:co-p-float 2s ease .9s forwards}
.co-particle:nth-child(4){top:51%;left:47%;width:2px;height:2px;animation:co-p-float 2.3s ease 1.1s forwards;background:#9333ea}
@keyframes co-p-float{0%{opacity:0;transform:translate(0,0) scale(1)}30%{opacity:.8}100%{opacity:0;transform:translate(var(--dx,20px),var(--dy,-30px)) scale(0)}}
.co-particle:nth-child(1){--dx:-40px;--dy:-50px}.co-particle:nth-child(2){--dx:35px;--dy:-45px}.co-particle:nth-child(3){--dx:30px;--dy:40px}.co-particle:nth-child(4){--dx:-35px;--dy:35px}
.connecting-text{font-size:.72rem;color:var(--t3);letter-spacing:.15em;font-weight:300;z-index:2;opacity:0;animation:fi 1s ease .8s forwards}
.connecting-dots{display:flex;gap:4px;z-index:2}
.connecting-dots span{width:4px;height:4px;border-radius:50%;background:var(--ac);opacity:.3;animation:df 1.4s ease-in-out infinite}
.connecting-dots span:nth-child(2){animation-delay:.2s}
.connecting-dots span:nth-child(3){animation-delay:.4s}
.connecting-text{font-size:1rem;color:var(--t2);font-weight:300;letter-spacing:.1em;animation:fi 1s ease .3s both}
.connecting-dots{display:flex;gap:6px}
.connecting-dots span{width:6px;height:6px;border-radius:50%;background:var(--ac);animation:conn-dot 1.2s ease-in-out infinite}
.connecting-dots span:nth-child(2){animation-delay:.2s}
.connecting-dots span:nth-child(3){animation-delay:.4s}
@keyframes conn-dot{0%,100%{opacity:.2;transform:scale(.8)}50%{opacity:1;transform:scale(1.2)}}

/* UTILS */
.hidden{display:none!important}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);padding:.6rem 1.4rem;background:var(--s2);border:1px solid var(--b1);border-radius:20px;color:var(--t1);font-size:.82rem;z-index:9999;animation:tin .3s ease;pointer-events:none;backdrop-filter:blur(10px)}
@keyframes tin{from{opacity:0;transform:translateX(-50%) translateY(12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
::-webkit-scrollbar{width:2px}::-webkit-scrollbar-thumb{background:var(--b1);border-radius:2px}
</style>
</head>
<body>

<div class="connecting-overlay" id="connectingOverlay">
  <div class="co-canvas">
    <div class="co-ring"></div><div class="co-ring"></div><div class="co-ring"></div><div class="co-ring"></div>
    <div class="co-orb"></div>
    <div class="co-particle"></div><div class="co-particle"></div><div class="co-particle"></div><div class="co-particle"></div>
  </div>
  <div class="connecting-text">algo está nascendo...</div>
  <div class="connecting-dots"><span></span><span></span><span></span></div>
</div>

<div id="splash" class="screen active">
  <div class="logo">ENCOSTA</div>
  <div class="tag">tudo nasce no gesto</div>
  <div style="position:absolute;bottom:max(env(safe-area-inset-bottom),2rem);font-size:.55rem;color:var(--t3);letter-spacing:.15em;opacity:.4">v2.1</div>
</div>

<div id="onboarding" class="screen">
  <div class="onb-slides" id="onbSlides">
    <div class="onb-slide">
      <div class="onb-icon">&#x2726;</div>
      <div class="onb-title">Tudo nasce no gesto</div>
      <div class="onb-desc">ENCOSTA transforma encontros em momentos conscientes. Aqui, conexões só existem quando duas pessoas decidem estar presentes.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x1F91D;</div>
      <div class="onb-title">Encoste para conectar</div>
      <div class="onb-desc">Gere um código, mostre o QR ou use NFC. A outra pessoa digita o código e vocês se conectam por 24 horas.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x23F3;</div>
      <div class="onb-title">24 horas, depois se dissolve</div>
      <div class="onb-desc">Cada conexão dura 24h. Conversem, presenteiem, declarem. Se quiserem mais tempo, encostem de novo.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x1F525;</div>
      <div class="onb-title">Streaks e estrelas</div>
      <div class="onb-desc">Encontros seguidos criam streaks com conquistas. Relações especiais geram estrelas que ficam para sempre no seu perfil.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x2648;</div>
      <div class="onb-title">Signos e compatibilidade</div>
      <div class="onb-desc">A cada encontro, os astros falam. Uma frase única baseada nos signos dos dois revela a energia da conexão.</div>
    </div>
  </div>
  <div class="onb-nav">
    <button class="onb-skip" onclick="skipOnboarding()">Pular</button>
    <button class="onb-next" id="onbNextBtn" onclick="nextOnbSlide()">Próximo</button>
  </div>
  <div class="onb-dots" id="onbDots"></div>
</div>

<div id="register" class="screen">
  <div class="rh"><h1>ENCOSTA</h1><p>crie sua presença</p></div>
  <div class="avs">
    <div class="avp" id="avatarPreview" style="background:var(--s2)">?</div>
    <div class="nick-hint" id="nickHint">escolha seu nickname</div>
  </div>
  <div class="fg"><label>Nickname</label><input type="text" id="regNick" placeholder="seu_nick" maxlength="20" autocomplete="off" oninput="checkNick(this.value)"></div>
  <div class="fg"><label>Data de nascimento</label><input type="date" id="regBirth"></div>
  <div class="tc"><input type="checkbox" id="regTerms"><span>Entendo e aceito que <strong>todas as relações aqui são temporárias</strong>. Nada persiste sem encontro.</span></div>
  <button class="bp" onclick="doRegister()">ENTRAR</button>
</div>

<div id="home" class="screen">
  <div class="fire-overlay" id="fireOverlay">
    <div class="fire-glow"></div><div class="fire-glow2"></div>
    <div class="fire-particles"><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div></div>
    <div class="fire-edge left"></div><div class="fire-edge right"></div>
    <div class="sonic-instruct" id="sonicInstruct">
      <div class="si-phones"><div class="si-phone left"></div><div class="si-phone right"></div></div>
      <div class="si-text">Encoste a parte inferior dos celulares</div>
    </div>
  </div>
  <!-- TOP: perfil+nick+estrelas à esquerda, msgs à direita -->
  <div class="home-top">
    <div class="home-user" onclick="showProfile()">
      <div class="home-avatar" id="homeAvatar"></div>
      <div class="home-user-info">
        <div class="hg" id="homeGreeting">Olá</div>
        <div class="home-user-meta"><div class="cd" id="connDot"></div></div>
      </div>
    </div>
    <div class="home-icons">
      <div class="constellation-btn hidden" id="constBtn" onclick="showHistory()">&#x2726;</div>
      <div class="rb hidden" id="relBadge" onclick="showRelations()">&#x1F4AC;<span class="ct" id="relCount">0</span></div>
    </div>
  </div>
  <!-- CENTER: botão encostar grande -->
  <div class="hc">
    <div class="hm" id="homeMotivation">Nada acontece<br>à distância.</div>
    <div style="position:relative;display:flex;align-items:center;justify-content:center">
      <div class="sonic-bars left" id="sonicBarsL"><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div></div>
      <button class="be" id="mainBtn" onclick="handleMainButton()">
        <span class="be-icon">&#x1F91D;</span>
        <span class="be-text" id="mainBtnText">ENCOSTAR</span>
      </button>
      <div class="sonic-bars right" id="sonicBarsR"><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div></div>
    </div>
    <div class="sonic-status" id="sonicHomeStatus"></div>
    <div class="sonic-fallback" id="sonicFallback">
      <button class="bs" onclick="startEncounter()" style="font-size:.75rem">&#x1F511; Conectar por código</button>
    </div>
    <div class="daily-counter hidden" id="dailyCounter">Hoje: <strong id="dailyNum">0</strong> encontros</div>
  </div>
  <!-- BOTTOM: tab bar -->
  <div class="home-bottom">
    <div class="home-nav">
      <button class="hn-btn" onclick="openLocationScreen()"><span class="hn-ico">📍</span><span class="hn-lbl" data-i18n="loc_btn">Local</span></button>
      <button class="hn-btn" onclick="showHistory()"><span class="hn-ico">✦</span><span class="hn-lbl">Rede</span></button>
      <button class="hn-btn" onclick="showBoardingPass()"><span class="hn-ico">🪪</span><span class="hn-lbl">ID</span></button>
      <button class="hn-btn" onclick="showManual()"><span class="hn-ico">❓</span><span class="hn-lbl">Manual</span></button>
    </div>
    <div class="home-brand-row">
      <span class="home-brand" id="homeBrand">ENCOSTA</span>
      <div class="lang-sw"><button class="lang-btn active" onclick="setLang('pt')">PT</button><button class="lang-btn" onclick="setLang('en')">EN</button><button class="lang-btn" onclick="setLang('es')">ES</button></div>
    </div>
  </div>
</div>

<div id="encounter" class="screen">
  <div class="ep active" id="phaseChoose">
    <div class="et">Como vão se encontrar?</div>
    <button class="bp" style="max-width:280px" onclick="createSession()">GERAR CÓDIGO</button>
    <div class="od">ou</div>
    <div class="cir"><input type="text" id="joinCodeInput" placeholder="ENC-000" maxlength="7" autocomplete="off"><button onclick="joinSession()">&#x2192;</button></div>
    <div class="od">ou</div>
    <button class="bp" style="max-width:280px;background:linear-gradient(135deg,#ff6b35,#e05520)" onclick="startSonicMode()">🔊 ENCOSTAR CELULARES</button>
    <button class="bs" style="margin-top:1.5rem" onclick="goHome()">&#x2190; Voltar</button>
  </div>
  <div class="ep" id="phaseBump">
    <div class="et">Encoste seu celular no da outra pessoa</div>
    <div class="bump-circle" id="bumpCircle">
      <span style="font-size:2rem">📳</span>
      <span style="font-size:.7rem;font-weight:600;letter-spacing:.1em;color:rgba(255,255,255,.85)" id="bumpLabel">PREPARANDO...</span>
    </div>
    <div style="font-size:.75rem;color:var(--t3);max-width:240px;text-align:center;line-height:1.6" id="bumpStatus">Ativando sensores...</div>
    <button class="bs" onclick="stopSonicMode();showPhase('phaseChoose')">&#x2190; Cancelar</button>
  </div>
  <div class="ep" id="phaseCode">
    <div class="et">Peça para a outra pessoa digitar:</div>
    <div class="cdsp" id="sessionCode">ENC-000</div>
    <div class="qb"><canvas id="qrCanvas"></canvas></div>
    <div style="font-size:.75rem;color:var(--t3)">Esperando alguém encostar...</div>
    <div class="wd"><span>&#x25CF;</span><span>&#x25CF;</span><span>&#x25CF;</span></div>
    <button class="bs" onclick="goHome()">Cancelar</button>
  </div>
</div>

<div id="reveal" class="screen">
  <div class="rv-cosmos" id="revealCosmos"></div>
  <div class="rv-nebula" id="revealNebula"></div>
  <div class="rv-birth" id="revealBirth">
    <div class="rv-birth-core"></div>
  </div>
  <!-- Flows from center to avatars -->
  <div class="rv-flow left" id="flowLeft"><div class="rv-trail"></div></div>
  <div class="rv-flow right" id="flowRight"><div class="rv-trail"></div></div>
  <!-- Ripples -->
  <div id="revealRipples"></div>
  <!-- Thread connecting avatars -->
  <div class="rv-thread" id="revealThread"><div class="rv-thread-line"></div></div>
  <div class="rv-wrap">
    <!-- Avatars with glow -->
    <div class="rv-avatars" id="revealAvatars">
      <div class="rv-avatar-wrap" id="rvAvatarMe">
        <div class="rv-avatar-glow"></div>
        <div id="rvAvatarMeInner"></div>
        <div class="rv-avatar-name" id="rvNameMe"></div>
      </div>
      <div class="rv-connection-symbol">
        <div class="rv-connection-dot"></div>
      </div>
      <div class="rv-avatar-wrap" id="rvAvatarThem">
        <div class="rv-avatar-glow"></div>
        <div id="rvAvatarThemInner"></div>
        <div class="rv-avatar-name" id="rvNameThem"></div>
      </div>
    </div>
    <div class="rv-renewed hidden" id="revealRenewed">vocês se encontraram de novo</div>
    <div class="rv-last hidden" id="revealLast"></div>
    <div class="rv-moment" id="revealMoment">algo nasceu entre vocês</div>
    <div class="rv-phrase" id="revealPhrase"></div>
    <div class="rv-line"></div>
    <div class="rv-sub">essa é a marca desse encontro</div>
    <div id="zodiacArea" class="zodiac-area hidden"></div>
    <video id="selfieVideo" autoplay playsinline style="width:100px;height:100px;border-radius:50%;object-fit:cover;border:2px solid var(--ac);display:none;margin:0 auto"></video>
    <canvas id="selfieCanvas" style="display:none"></canvas>
    <div id="selfiePreview" style="display:none;margin:0 auto"></div>
    <div class="rv-actions" id="revealActions">
      <button type="button" class="rv-btn-enter" onclick="enterChat()">Abrir a conexão</button>
      <button type="button" class="rv-btn-photo" id="selfieCapBtn" onclick="revealCaptureSelfie()"><span class="rv-ico">✦</span> Guardar esse momento</button>
    </div>
  </div>
</div>

<div id="chat" class="screen">
  <div class="ch">
    <div class="chl"><button class="chb" onclick="goHome()">&#x2190;</button><span class="chn" id="chatPartner">Pessoa</span><span class="pts-partner hidden" id="partnerPts">&#x2B50; <strong id="partnerPtsNum">0</strong></span></div>
    <div style="display:flex;align-items:center;gap:.4rem">
      <button class="selfie-btn" onclick="showPartnerProfile()" title="Perfil">&#x1F464;</button>
      <button class="selfie-btn" onclick="requestSelfie()" title="Selfie">&#x1F4F7;</button>
      <div class="cht" id="chatTimer">23:59:59</div>
    </div>
  </div>
  <div class="cpb" id="chatPhrase"></div>
  <div class="streak-info hidden" id="chatStreak"><span id="chatStreakText"></span><div class="streak-progress"><div class="streak-bar" id="chatStreakBar"></div></div><span id="chatStreakNext" style="font-size:.6rem;color:var(--t3)"></span></div>
  <div id="contactRequestArea"></div>
  <div class="cms" id="chatMessages"><div class="ti" id="typingIndicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
  <div class="qp-bar" id="quickPhrases"></div>
  <div class="chat-bottom" style="position:relative">
    <div class="chat-actions">
      <button class="ca-btn" onclick="openContactMenu()" type="button"><span class="ca-ico">&#x1F4F2;</span> Pedir</button>
      <button class="ca-btn" onclick="openGiftPicker()" type="button"><span class="ca-ico">&#x1F381;</span> Presente</button>
      <button class="ca-btn" onclick="openDeclModal()" type="button"><span class="ca-ico">&#x1F4DD;</span> Declarar</button>
      <button class="ca-btn" onclick="sendPulse()" type="button" id="pulseBtn"><span class="ca-ico">&#x1F49F;</span> Pulsar</button>
      <button class="ca-btn" onclick="getHoroscope()" type="button" id="horoscopeBtn"><span class="ca-ico">&#x2728;</span> Horóscopo</button>
    </div>
    <div class="plus-menu" id="plusMenu">
      <button class="pm-item" onclick="pickPhoto()" type="button"><div class="pm-ico" style="background:rgba(88,166,255,.15);color:#58a6ff">&#x1F4F7;</div><span class="pm-label">Foto</span></button>
      <button class="pm-item" onclick="pickFile()" type="button"><div class="pm-ico" style="background:rgba(255,107,53,.12);color:var(--ac)">&#x1F4CE;</div><span class="pm-label">Arquivo</span></button>
      <button class="pm-item" onclick="openContactMenu();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(163,113,247,.12);color:#a371f7">&#x1F4F2;</div><span class="pm-label">Pedir</span></button>
      <button class="pm-item" onclick="openGiftPicker();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(255,200,87,.12);color:#ffc857">&#x1F381;</div><span class="pm-label">Presente</span></button>
    </div>
    <div class="cia">
      <div class="cia-wrap">
        <button class="cia-plus" onclick="togglePlusMenu()" type="button">+</button>
        <input type="text" id="chatInput" placeholder="Mensagem..." maxlength="500" autocomplete="off">
      </div>
      <button class="sb" id="sendBtn" onclick="sendMessage()" type="button">&#x2191;</button>
    </div>
  </div>
</div>

<div id="relations" class="screen">
  <div class="rlh"><button class="chb" onclick="goHome()">&#x2190;</button><h2>Conexões ativas</h2><span class="rlh-sub" id="relSubtitle"></span></div>
  <div class="rll" id="relationsList"></div>
</div>

<div id="history" class="screen">
  <div class="const-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2>Minha Constelação</h2></div>
  <div class="const-copy"><p>Aqui ficam os encontros.<br>O resto passou.</p></div>
  <div class="const-feedback" id="constFeedback"></div>
  <div class="const-canvas-wrap"><canvas id="constCanvas"></canvas></div>
  <div class="const-empty hidden" id="constEmpty">
    <div class="const-empty-icon">✦</div>
    <div class="const-empty-text">Nenhum encontro ainda.<br>Encoste em alguém para começar sua constelação.</div>
  </div>
  <div class="const-detail" id="constDetail" onclick="hideConstDetail()">
    <div class="const-detail-avatar" id="constDetailAvatar"></div>
    <div class="const-detail-nick" id="constDetailNick"></div>
    <div class="const-detail-text">Vocês estiveram juntos.</div>
  </div>
</div>

<div id="expireCard" class="screen">
  <div class="ev"><div class="cl">ENCOSTA</div><div class="cf" id="cardPhrase"></div><div class="ctm" id="cardTime"></div><div class="cft">tudo nasce no gesto</div></div>
  <div class="ea"><button class="bs" onclick="goHome()">Voltar</button><button class="bp" style="max-width:160px" onclick="shareCard()">Compartilhar</button></div>
</div>

<div id="boardingPass" class="screen">
  <div class="bp-card" id="bpCard">
    <div class="bp-top"><div class="bp-logo">ENCOSTA</div><div class="bp-type">boarding pass</div></div>
    <div class="bp-body">
      <div class="bp-avatar" id="bpAvatar">&#x1F464;</div>
      <div class="bp-name" id="bpName">Nome</div>
      <div class="bp-since" id="bpSince">membro desde jan 2026</div>
      <div class="bp-stats">
        <div class="bp-stat"><div class="bp-stat-num" id="bpScore">0</div><div class="bp-stat-label">score</div></div>
        <div class="bp-stat"><div class="bp-stat-num" id="bpStars" style="color:#fbbf24">0</div><div class="bp-stat-label">estrelas</div></div>
        <div class="bp-stat"><div class="bp-stat-num" id="bpPeople">0</div><div class="bp-stat-label">pessoas</div></div>
        <div class="bp-stat"><div class="bp-stat-num" id="bpTotal">0</div><div class="bp-stat-label">encontros</div></div>
      </div>
    </div>
    <div class="bp-barcode" id="bpBarcode"></div>
    <div class="bp-footer">TUDO NASCE NO GESTO</div>
  </div>
  <div class="touch-link-area" id="touchLinkArea">
    <div style="font-size:.75rem;font-weight:600;margin-bottom:.3rem">Seu link NFC / QR</div>
    <div style="font-size:.65rem;color:var(--t3);margin-bottom:.5rem">Cole no adesivo NFC ou mostre o QR</div>
    <div class="touch-link-url" id="touchLinkUrl">Gerando...</div>
    <div class="touch-link-actions">
      <button class="bs" onclick="copyTouchLink()" type="button">Copiar link</button>
      <button class="bs" onclick="showTouchQR()" type="button">QR Code</button>
    </div>
    <div id="touchQRArea" style="margin-top:.5rem;display:none"></div>
  </div>
  <div class="bp-actions">
    <button class="bs" onclick="goHome()">&#x2190; Voltar</button>
    <button class="bp-dl" onclick="downloadBoardingPass()">&#x1F4F1; Salvar Imagem</button>
  </div>
</div>

<div id="locationScreen" class="screen">
  <div class="loc-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 data-i18n="loc_title">Explorar ao redor</h2><button class="bs" style="font-size:.7rem;padding:.3rem .8rem" onclick="showCreateEvent()" data-i18n="create_event_btn">+ Evento</button></div>
  <div class="loc-scroll" id="locScroll">
    <div class="loc-status" id="locStatus" data-i18n="loc_activate">Ative sua localização para descobrir pessoas e eventos.</div>
    <div class="loc-tabs">
      <div class="loc-tab active" id="tabNearby" onclick="switchLocTab('nearby')" data-i18n="tab_nearby">Pessoas</div>
      <div class="loc-tab" id="tabEvents" onclick="switchLocTab('events')" data-i18n="tab_events">Eventos</div>
    </div>
    <div id="locContent"></div>
  </div>
</div>

<div id="eventDetail" class="screen">
  <div class="loc-header"><button class="chb" onclick="showScreen('locationScreen')">&#x2190;</button><h2 id="evtDetailTitle">Evento</h2></div>
  <div class="loc-scroll" id="evtDetailScroll"></div>
</div>

<div id="profile" class="screen">
  <div class="pf-header"><button class="chb" onclick="closeProfile()">&#x2190;</button><h2 id="pfTitle">Perfil</h2></div>
  <div class="pf-scroll" id="pfScroll"></div>
</div>

<div id="giftModal" class="hidden"></div>
<div id="declModal" class="hidden"></div>

<div id="encostaReqArea"></div>
<div id="toast" class="toast hidden"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
const $=id=>document.getElementById(id);
let socket=null,state={userId:localStorage.getItem('encosta_userId'),userName:localStorage.getItem('encosta_userName'),userColor:localStorage.getItem('encosta_userColor')||'',currentSession:null,currentRelation:null,timerInterval:null};
let typingTimeout=null,lastTypingEmit=0,pulseSent=false;

// ═══ ONBOARDING ═══
let onbSlide = 0;
const ONB_TOTAL = 5;
function initOnboarding() {
  const dots = $('onbDots');
  dots.innerHTML = '';
  for (let i = 0; i < ONB_TOTAL; i++) {
    const dot = document.createElement('div');
    dot.className = 'onb-dot' + (i === 0 ? ' active' : '');
    dots.appendChild(dot);
  }
}
function nextOnbSlide() {
  onbSlide++;
  if (onbSlide >= ONB_TOTAL) { skipOnboarding(); return; }
  $('onbSlides').style.transform = 'translateX(-' + (onbSlide * 100) + '%)';
  updateOnbDots();
  if (onbSlide === ONB_TOTAL - 1) $('onbNextBtn').textContent = 'Começar';
}
function updateOnbDots() {
  const dots = $('onbDots').children;
  for (let i = 0; i < dots.length; i++) dots[i].className = 'onb-dot' + (i === onbSlide ? ' active' : '');
}
function skipOnboarding() {
  localStorage.setItem('encosta_onboarded', '1');
  showScreen('register');
}
function showManual(){
  // Re-show onboarding as manual
  onbSlide=0;
  initOnboarding();
  $('onbSlides').style.transform='translateX(0)';
  $('onbNextBtn').textContent='Próximo';
  // Override skip to go home
  const oldSkip=window.skipOnboarding;
  window.skipOnboarding=function(){ showScreen('home'); window.skipOnboarding=oldSkip; };
  showScreen('onboarding');
}

// ═══ SOCKET ═══
function initSocket(){
  if(socket)return;
  socket=io({reconnection:true,reconnectionDelay:1000,reconnectionAttempts:Infinity});
  socket.on('connect',()=>{if(state.userId)socket.emit('identify',state.userId);updateConn('online')});
  socket.on('disconnect',()=>updateConn('offline'));
  socket.io.on('reconnect_attempt',()=>updateConn('reconnecting'));

  socket.on('relation-created',d=>{
    if(homeSonicActive)stopHomeSonic();
    if(sonicActive)stopSonicMode();
    state.currentRelation=d;haptic([100,50,100,50,100]);playSound('connect');
    // Show connecting animation for 2.5s, then reveal
    const co=$('connectingOverlay');
    if(co){
      co.classList.add('active');
      setTimeout(()=>{
        co.classList.remove('active');
        showScreen('reveal');doReveal(d);
      },3500);
    }else{
      showScreen('reveal');doReveal(d);
    }
  });
  socket.on('new-message',({relationId,message})=>{
    if(state.currentRelation?.relationId===relationId){appendMessage(message);playSound('receive');hideTyping()}
  });
  socket.on('partner-typing',({relationId})=>{
    if(state.currentRelation?.relationId===relationId)showTyping()
  });
  socket.on('pulse-received',({relationId})=>{
    // Heartbeat vibration: lub-dub, lub-dub, lub-dub
    const heartbeat=[120,60,80,300,120,60,80,300,120,60,80];
    if(state.currentRelation?.relationId===relationId){
      haptic(heartbeat);playSound('pulse');
      showToast('Sentiu um pulso...');
    }else{haptic(heartbeat);showToast('Alguém pulsou por você')}
  });
  socket.on('ephemeral-received',({relationId,message})=>{
    if(state.currentRelation?.relationId===relationId){appendEphemeral(message);playSound('receive')}
    else showToast('Nova mensagem!');
    haptic([50,30,50]);
  });
  socket.on('photo-received',({relationId,message})=>{
    if(state.currentRelation?.relationId===relationId){appendPhoto(message);playSound('receive')}
    else showToast('Foto recebida!');
    haptic([50,30,50]);
  });
  socket.on('selfie-request',({relationId})=>{
    if(state.currentRelation?.relationId===relationId)showToast('A outra pessoa quer registrar o encontro!');
  });
  socket.on('gift-received',({relationId,gift})=>{
    haptic([100,50,100]);playSound('connect');
    if(gift.needsAddress&&gift.addressStatus==='pending'){
      if(state.currentRelation?.relationId===relationId)showAddressRequest(gift);
      else showToast(gift.fromName+' te enviou '+gift.emoji+' '+gift.giftName+'!');
    }else{showToast(gift.fromName+' te enviou '+gift.emoji+' '+gift.giftName+'!')}
  });
  socket.on('declaration-received',({relationId,declaration})=>{
    haptic([50,30,50]);showToast(declaration.fromName+' escreveu uma declaração para você!');
  });
  socket.on('gift-address-accepted',({giftName})=>{showToast('Presente aceito! '+giftName+' será entregue.');haptic([50,30,50])});
  socket.on('gift-address-declined',({giftName})=>{showToast('Presente recusado: '+giftName);haptic([30])});
  socket.on('encosta-request',data=>showEncostaRequest(data));
  socket.on('encosta-declined',()=>{showToast('Pedido de encosta recusado.');haptic([30])});
  socket.on('contact-request',data=>showContactRequest(data));
  socket.on('contact-shared',({relationId,contactType,value})=>{
    // Save contact info as persistent message in chat
    const labels={instagram:'📸 Instagram',whatsapp:'💬 WhatsApp',x:'𝕏 X',email:'📧 Email'};
    const text=(labels[contactType]||contactType)+': '+value;
    if(state.currentRelation?.relationId===relationId){
      appendMessage({userId:'system',text,timestamp:Date.now()});
    }
    // Also save as regular message on server
    if(relationId)socket.emit('send-message',{relationId,userId:'system',text});
    showToast(contactType+': '+value);haptic([20,40,20]);
  });
  socket.on('contact-declined',({contactType})=>{showToast('Pedido de '+contactType+' recusado.');haptic([30])});
  socket.on('selfie-taken',({relationId})=>{showToast('Selfie registrado!');haptic([20,40,20])});
  socket.on('star-earned',({star,total})=>{
    haptic([100,50,100,50,100]);playSound('connect');
    const reason=star.reason==='gift'?'Presente de '+(star.fromName||'alguém'):star.reason==='organic'?'Conexão especial com '+(star.withName||'alguém'):star.reason==='streak'?'Streak com '+(star.withName||'alguém'):'Marco alcançado';
    showToast('⭐ Nova estrela! '+reason+' (Total: '+total+')');
  });
  socket.on('streak-unlock',data=>showStreakUnlock(data));
}
function updateConn(s){const d=$('connDot');if(d)d.className='cd'+(s!=='online'?' '+s:'')}

// ═══ NAV ═══
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>{if(s.id!==id)s.classList.remove('active')});
  requestAnimationFrame(()=>$(id).classList.add('active'));
  if(state.timerInterval&&id!=='chat'){clearInterval(state.timerInterval);state.timerInterval=null}
  // Close selfie camera when leaving reveal
  if(id!=='reveal')releaseSelfieCamera();
  // Stop constellation animation when leaving
  if(id!=='history'&&constState.animFrame){cancelAnimationFrame(constState.animFrame);constState.animFrame=null}
}
function showPhase(id){document.querySelectorAll('.ep').forEach(p=>p.classList.remove('active'));$(id).classList.add('active')}
function goHome(){showScreen('home');refreshHome()}

async function refreshHome(){
  refreshRelations();
  setHomeMotivation();
  // Set homeAvatar
  if(state.userName){
    const av=$('homeAvatar');
    if(av){av.textContent=(state.userName||'??').slice(0,2).toUpperCase();av.style.background=state.userColor||nickColor(state.userName)}
  }
  try{
    const [d,cn]=await Promise.all([
      fetch('/api/today/'+state.userId).then(r=>r.json()),
      fetch('/api/constellation/'+state.userId).then(r=>r.json())
    ]);
    const c=$('dailyCounter'),n=$('dailyNum');
    if(d.count>0){c.classList.remove('hidden');n.textContent=d.count}else c.classList.add('hidden');
    if(cn.total>0)$('constBtn').classList.remove('hidden');
  }catch(e){}
}

// ═══ REGISTER ═══
let nickCheckTimer=null;
function checkNick(val){
  const nick=val.trim(),hint=$('nickHint'),preview=$('avatarPreview');
  if(!nick||nick.length<2){hint.textContent='mínimo 2 caracteres';hint.className='nick-hint';preview.textContent='?';preview.style.background='var(--s2)';return}
  if(!/^[a-zA-Z0-9_.-]+$/.test(nick)){hint.textContent='só letras, números, _ . -';hint.className='nick-hint taken';return}
  // Update preview avatar
  const initials=nick.slice(0,2).toUpperCase();
  const color=nickColor(nick);
  preview.textContent=initials;preview.style.background=color;
  // Debounced availability check
  clearTimeout(nickCheckTimer);
  hint.textContent='verificando...';hint.className='nick-hint';
  nickCheckTimer=setTimeout(async()=>{
    try{
      const r=await fetch('/api/check-nick/'+encodeURIComponent(nick));const d=await r.json();
      if(d.available){hint.textContent='disponível!';hint.className='nick-hint ok'}
      else{hint.textContent='já existe';hint.className='nick-hint taken'}
    }catch(e){hint.textContent='';hint.className='nick-hint'}
  },400);
}
function nickColor(nick){let h=0;for(let i=0;i<nick.length;i++)h=nick.charCodeAt(i)+((h<<5)-h);return'hsl('+Math.abs(h)%360+',65%,55%)'}
function makeAvatar(nick,color,size){
  size=size||44;
  const initials=(nick||'??').slice(0,2).toUpperCase();
  return '<div style="width:'+size+'px;height:'+size+'px;border-radius:50%;background:'+color+';display:flex;align-items:center;justify-content:center;font-size:'+(size*.38)+'px;font-weight:800;color:#fff;letter-spacing:.03em;flex-shrink:0">'+esc(initials)+'</div>';
}
async function doRegister(){
  const nick=$('regNick').value.trim(),birth=$('regBirth').value,terms=$('regTerms').checked;
  if(!nick||nick.length<2)return showToast('Escolha um nickname.');if(!birth)return showToast('Data de nascimento.');if(!terms)return showToast('Aceite os termos.');
  if(!/^[a-zA-Z0-9_.-]+$/.test(nick))return showToast('Nickname: só letras, números, _ . -');
  try{
    const r=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nickname:nick,birthdate:birth,acceptedTerms:true})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    if(d.userId){state.userId=d.userId;state.userName=nick;state.userColor=d.user.color;localStorage.setItem('encosta_userId',d.userId);localStorage.setItem('encosta_userName',nick);localStorage.setItem('encosta_userColor',d.user.color||'');initSocket();showScreen('home');$('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(nick)+'</span>';haptic([80])}
  }catch(e){showToast('Erro ao registrar.')}
}

// ═══ ENCOUNTER ═══
function startEncounter(){haptic([40]);showScreen('encounter');showPhase('phaseChoose');$('joinCodeInput').value=''}

// ═══ MAIN BUTTON — sonic first, code fallback ═══
let homeSonicActive=false;
async function handleMainButton(){
  if(!state.userId){showToast('Registre-se primeiro.');showScreen('register');return}
  if(homeSonicActive){stopHomeSonic();return}
  if(!socket||!socket.connected){showToast('Sem conexão. Aguarde...');return}
  haptic([40]);
  homeSonicActive=true;
  sonicActive=true;sonicMyFreq=0;
  const btn=$('mainBtn'),txt=$('mainBtnText'),sts=$('sonicHomeStatus'),fb=$('sonicFallback');
  const barsL=$('sonicBarsL'),barsR=$('sonicBarsR'),fire=$('fireOverlay');
  btn.classList.add('energized');
  txt.textContent='ATIVANDO...';
  sts.textContent='Pedindo microfone...';sts.classList.add('active');
  barsL.classList.add('active');barsR.classList.add('active');
  if(fire)fire.classList.add('active');
  const si=$('sonicInstruct');if(si)si.classList.add('active');

  try{
    // 1. Mic permission
    sonicStream=await requestMic();
    if(!homeSonicActive)return;
    sts.textContent='Conectando ao servidor...';

    // 2. Get frequency from server
    socket.emit('sonic-start',{userId:state.userId});
    const freq=await new Promise((resolve,reject)=>{
      const t=setTimeout(()=>reject(new Error('Timeout')),5000);
      socket.once('sonic-assigned',({freq})=>{clearTimeout(t);resolve(freq)});
    });
    if(!homeSonicActive)return;
    sonicMyFreq=freq;

    // 3. Emit ultrasonic
    sonicEmitCtx=new(window.AudioContext||window.webkitAudioContext)();
    sonicOsc=sonicEmitCtx.createOscillator();
    sonicOsc.type='sine';
    sonicOsc.frequency.setValueAtTime(freq,sonicEmitCtx.currentTime);
    const gain=sonicEmitCtx.createGain();
    gain.gain.setValueAtTime(0.8,sonicEmitCtx.currentTime);
    sonicOsc.connect(gain);gain.connect(sonicEmitCtx.destination);
    sonicOsc.start();

    // 4. Start detection
    sonicMicCtx=new(window.AudioContext||window.webkitAudioContext)();
    const source=sonicMicCtx.createMediaStreamSource(sonicStream);
    sonicAnalyser=sonicMicCtx.createAnalyser();
    sonicAnalyser.fftSize=SONIC_FFT_SIZE;
    sonicAnalyser.smoothingTimeConstant=0.3;
    source.connect(sonicAnalyser);
    const bufLen=sonicAnalyser.frequencyBinCount;
    const dataArr=new Uint8Array(bufLen);
    const sampleRate=sonicMicCtx.sampleRate;
    const freqPerBin=sampleRate/SONIC_FFT_SIZE;

    txt.textContent='ENCOSTANDO...';
    sts.textContent='Aproxime os celulares...';
    setTimeout(()=>{if(homeSonicActive){fb.classList.add('active');sts.textContent='Aproxime ou use código'}},10000);

    let confirmHits=0,lastSnapped=0;
    function detect(){
      if(!sonicActive)return;
      sonicAnalyser.getByteFrequencyData(dataArr);
      const minBin=Math.floor(18000/freqPerBin),maxBin=Math.ceil(20000/freqPerBin);
      let peakVal=0,peakBin=0;
      for(let i=minBin;i<=maxBin&&i<bufLen;i++){if(dataArr[i]>peakVal){peakVal=dataArr[i];peakBin=i}}
      if(peakVal>=SONIC_DETECT_THRESHOLD){
        const snapped=Math.round(Math.round(peakBin*freqPerBin)/100)*100;
        if(snapped!==sonicMyFreq&&snapped>=18000&&snapped<=19900){
          if(snapped===lastSnapped)confirmHits++;else{confirmHits=1;lastSnapped=snapped}
          if(confirmHits>=SONIC_CONFIRM_COUNT){
            haptic([100,30,100]);
            txt.textContent='CONECTOU!';sts.textContent='Encontramos alguém!';
            socket.emit('sonic-detected',{userId:state.userId,detectedFreq:snapped});
            sonicActive=false;return;
          }
        }
      }else if(confirmHits>0)confirmHits=Math.max(0,confirmHits-1);
      sonicAnimFrame=requestAnimationFrame(detect);
    }
    detect();
  }catch(e){
    console.error('Sonic error:',e);
    sts.textContent=e.name==='NotAllowedError'?'Microfone negado.':'Erro: '+e.message;
    fb.classList.add('active');
  }
}

function stopHomeSonic(){
  homeSonicActive=false;
  stopSonicMode();
  const btn=$('mainBtn'),txt=$('mainBtnText'),status=$('sonicHomeStatus'),fb=$('sonicFallback');
  const barsL=$('sonicBarsL'),barsR=$('sonicBarsR'),fire=$('fireOverlay');
  btn.classList.remove('energized');
  txt.textContent='ENCOSTAR';
  status.classList.remove('active');
  fb.classList.remove('active');
  barsL.classList.remove('active');barsR.classList.remove('active');
  if(fire)fire.classList.remove('active');
  const si=$('sonicInstruct');if(si)si.classList.remove('active');
}
async function createSession(){
  if(!state.userId){showToast('Registre-se primeiro.');showScreen('register');return}
  try{
    const r=await fetch('/api/session/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
    const d=await r.json();
    if(d.error){if(d.error.includes('inválido')){showToast('Sessão expirada. Registre novamente.');localStorage.clear();showScreen('register');return}return showToast(d.error)}
    state.currentSession=d.sessionId;$('sessionCode').textContent=d.code;showPhase('phaseCode');generateQR(d.code);socket.emit('join-session',d.sessionId);
  }catch(e){showToast('Erro ao criar sessão.')}
}
async function joinSession(){
  const code=$('joinCodeInput').value.trim().toUpperCase();if(!code)return showToast('Digite o código.');
  if(!state.userId){showToast('Registre-se primeiro.');showScreen('register');return}
  try{
    const r=await fetch('/api/session/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,code})});
    const d=await r.json();
    if(d.error){if(d.error.includes('inválido')){showToast('Registre novamente.');localStorage.clear();showScreen('register');return}return showToast(d.error)}
    if(d.relationId){state.currentRelation=d;haptic([100,50,100,50,100]);playSound('connect');showScreen('reveal');doReveal(d)}
  }catch(e){showToast('Código inválido ou expirado.')}
}
function generateQR(code){
  const canvas=$('qrCanvas'),ctx=canvas.getContext('2d');canvas.width=180;canvas.height=180;ctx.clearRect(0,0,180,180);
  if(typeof QRCode!=='undefined'){const tmp=document.createElement('div');new QRCode(tmp,{text:location.origin+'?code='+code,width:180,height:180,colorDark:'#0a0a0a',colorLight:'#ffffff'});setTimeout(()=>{const src=tmp.querySelector('img')||tmp.querySelector('canvas');if(src){if(src.tagName==='CANVAS')ctx.drawImage(src,0,0,180,180);else{const i=new Image();i.onload=()=>ctx.drawImage(i,0,0,180,180);i.src=src.src}}},200)}
}

// ═══ SONIC — ultrasonic phone-to-phone ═══
let sonicActive=false,sonicEmitCtx=null,sonicOsc=null,sonicStream=null,sonicMicCtx=null,sonicAnalyser=null,sonicAnimFrame=null,sonicMyFreq=0;
const SONIC_FFT_SIZE=8192;
const SONIC_DETECT_THRESHOLD=80; // lowered: phone mics pick up 18kHz weakly
const SONIC_CONFIRM_COUNT=3; // need 3 consecutive detections to confirm (anti false-positive)

// Request mic permission and return stream (reusable)
async function requestMic(){
  return navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
}

function startSonicMode(){
  if(!state.userId){showToast('Registre-se primeiro.');showScreen('register');return}
  if(!socket||!socket.connected){showToast('Sem conexão. Aguarde...');return}
  showPhase('phaseBump');
  const circle=$('bumpCircle'),label=$('bumpLabel'),status=$('bumpStatus');
  circle.className='bump-circle';label.textContent='PREPARANDO...';
  status.textContent='Pedindo microfone...';
  sonicActive=true;sonicMyFreq=0;
  initSonic(label,status,circle);
}

async function initSonic(label,status,circle){
  try{
    // 1. Get mic permission first
    sonicStream=await requestMic();
    if(status)status.textContent='Microfone OK. Conectando...';

    // 2. Ask server for frequency
    socket.emit('sonic-start',{userId:state.userId});
    const freq=await new Promise((resolve,reject)=>{
      const timeout=setTimeout(()=>reject(new Error('Server timeout')),5000);
      socket.once('sonic-assigned',({freq})=>{clearTimeout(timeout);resolve(freq)});
    });
    if(!sonicActive)return; // user may have cancelled
    sonicMyFreq=freq;

    // 3. Start emitting (louder for phone speakers)
    sonicEmitCtx=new(window.AudioContext||window.webkitAudioContext)();
    sonicOsc=sonicEmitCtx.createOscillator();
    sonicOsc.type='sine';
    sonicOsc.frequency.setValueAtTime(freq,sonicEmitCtx.currentTime);
    const gain=sonicEmitCtx.createGain();
    gain.gain.setValueAtTime(0.8,sonicEmitCtx.currentTime); // louder! phones need it
    sonicOsc.connect(gain);
    gain.connect(sonicEmitCtx.destination);
    sonicOsc.start();

    // 4. Start listening with confirmed detection
    sonicMicCtx=new(window.AudioContext||window.webkitAudioContext)();
    const source=sonicMicCtx.createMediaStreamSource(sonicStream);
    sonicAnalyser=sonicMicCtx.createAnalyser();
    sonicAnalyser.fftSize=SONIC_FFT_SIZE;
    sonicAnalyser.smoothingTimeConstant=0.3; // less smoothing = faster response
    source.connect(sonicAnalyser);
    const bufLen=sonicAnalyser.frequencyBinCount;
    const dataArr=new Uint8Array(bufLen);
    const sampleRate=sonicMicCtx.sampleRate;
    const freqPerBin=sampleRate/SONIC_FFT_SIZE;

    if(circle)circle.classList.add('listening');
    if(label)label.textContent='ENCOSTE';
    if(status)status.textContent='Aproxime os celulares...';

    let confirmHits=0,lastSnapped=0;

    function detect(){
      if(!sonicActive)return;
      sonicAnalyser.getByteFrequencyData(dataArr);
      const minBin=Math.floor(18000/freqPerBin);
      const maxBin=Math.ceil(20000/freqPerBin);
      let peakVal=0,peakBin=0;
      for(let i=minBin;i<=maxBin&&i<bufLen;i++){
        if(dataArr[i]>peakVal){peakVal=dataArr[i];peakBin=i}
      }
      if(peakVal>=SONIC_DETECT_THRESHOLD){
        const detectedFreq=Math.round(peakBin*freqPerBin);
        const snapped=Math.round(detectedFreq/100)*100;
        // Ignore own frequency and out-of-range
        if(snapped!==sonicMyFreq&&snapped>=18000&&snapped<=19900){
          if(snapped===lastSnapped){confirmHits++}else{confirmHits=1;lastSnapped=snapped}
          if(confirmHits>=SONIC_CONFIRM_COUNT){
            // Confirmed detection!
            haptic([100,30,100]);
            if(circle){circle.classList.remove('listening');circle.classList.add('bumped')}
            if(label)label.textContent='CONECTOU!';
            if(status)status.textContent='Conectando...';
            socket.emit('sonic-detected',{userId:state.userId,detectedFreq:snapped});
            sonicActive=false;
            return;
          }
        }
      }else{
        // Reset if signal lost
        if(confirmHits>0)confirmHits=Math.max(0,confirmHits-1);
      }
      sonicAnimFrame=requestAnimationFrame(detect);
    }
    detect();

  }catch(e){
    console.error('Sonic init error:',e);
    if(status)status.textContent=e.name==='NotAllowedError'?'Microfone negado. Use código.':'Erro: '+e.message;
    sonicActive=false;
    const fb=$('sonicFallback');if(fb)fb.classList.add('active');
  }
}

function stopSonicMode(){
  sonicActive=false;
  if(sonicOsc){try{sonicOsc.stop()}catch(e){}}
  if(sonicEmitCtx){try{sonicEmitCtx.close()}catch(e){}}
  if(sonicMicCtx){try{sonicMicCtx.close()}catch(e){}}
  if(sonicStream){sonicStream.getTracks().forEach(t=>t.stop())}
  if(sonicAnimFrame)cancelAnimationFrame(sonicAnimFrame);
  sonicOsc=null;sonicEmitCtx=null;sonicMicCtx=null;sonicStream=null;sonicAnalyser=null;sonicAnimFrame=null;sonicMyFreq=0;
  if(socket&&socket.connected)socket.emit('sonic-stop',{userId:state.userId});
}

// ═══ REVEAL — cinematographic ═══
function doReveal(data){
  const a=data.userA,b=data.userB;
  const meIsA=a.id===state.userId;
  const me=meIsA?a:b,them=meIsA?b:a;
  const meColor=me.color||nickColor(me.name||'??'),themColor=them.color||nickColor(them.name||'??');
  const isDigital=data.type==='digital';

  // 1. Generate star field in cosmos
  const cosmos=$('revealCosmos');cosmos.innerHTML='';
  for(let i=0;i<40;i++){
    const s=document.createElement('div');s.className='rv-star';
    s.style.cssText='left:'+Math.random()*100+'%;top:'+Math.random()*100+'%;width:'+(1+Math.random()*2)+'px;height:'+(1+Math.random()*2)+'px;animation-delay:'+(Math.random()*4)+'s;animation-duration:'+(3+Math.random()*3)+'s';
    cosmos.appendChild(s);
  }

  // 2. Generate ripples from birth center
  const ripples=$('revealRipples');ripples.innerHTML='';
  for(let i=0;i<5;i++){
    const r=document.createElement('div');r.className='rv-ripple';
    r.style.animationDelay=(0.8+i*0.5)+'s';
    ripples.appendChild(r);
  }

  // 3. Reset and re-trigger birth core animation
  const birth=$('revealBirth');
  birth.innerHTML='';
  const core=document.createElement('div');core.className='rv-birth-core';
  birth.appendChild(core);

  // 4. Activate thread
  const thread=$('revealThread');
  thread.classList.remove('active');
  requestAnimationFrame(()=>thread.classList.add('active'));

  // 5. Avatars — me and them with glow
  $('rvAvatarMeInner').innerHTML=makeAvatar(me.name,meColor,48);
  $('rvAvatarThemInner').innerHTML=makeAvatar(them.name,themColor,48);
  $('rvNameMe').textContent=me.name||'?';
  $('rvNameThem').textContent=them.name||'?';

  // 6. "algo nasceu" moment text
  const moment=$('revealMoment');
  if(isDigital)moment.textContent='uma conexão nasceu';
  else moment.textContent='algo nasceu entre vocês';

  // 7. Renewed
  data.renewed?$('revealRenewed').classList.remove('hidden'):$('revealRenewed').classList.add('hidden');

  // 8. Last encounter info
  const lastEl=$('revealLast');
  if(data.lastEncounter){
    const ago=Date.now()-data.lastEncounter.timestamp;
    const days=Math.floor(ago/86400000),hrs=Math.floor((ago%86400000)/3600000);
    let agoStr=days>0?days+'d '+hrs+'h atrás':hrs>0?hrs+'h atrás':'agora';
    lastEl.innerHTML='Último encontro: <strong>'+agoStr+'</strong><br><em>"'+esc(data.lastEncounter.phrase)+'"</em>';
    lastEl.classList.remove('hidden');
  }else lastEl.classList.add('hidden');

  // 9. Phrase word by word — delayed for cinematic effect
  const el=$('revealPhrase');el.innerHTML='';
  const baseDelay=3.8; // after avatars, moment text
  data.phrase.split(' ').forEach((w,i)=>{
    const s=document.createElement('span');s.className='rv-word';
    s.textContent=w+'\u00A0';
    s.style.animationDelay=(baseDelay+i*0.25)+'s';
    el.appendChild(s);
  });

  // 10. Zodiac — poetic, element-focused
  const zodiacArea=$('zodiacArea');
  if(data.zodiacPhrase && data.userA?.signInfo && data.userB?.signInfo){
    const sA=meIsA?data.userA.signInfo:data.userB.signInfo;
    const sB=meIsA?data.userB.signInfo:data.userA.signInfo;
    const elA=sA.elementName||sA.element||'?';
    const elB=sB.elementName||sB.element||'?';
    const same=elA===elB;
    const elemText=same?'<em>'+esc(elA)+'</em> encontra <em>'+esc(elA)+'</em>':'<em>'+esc(elA)+'</em> encontra <em>'+esc(elB)+'</em>';
    zodiacArea.classList.remove('hidden');
    zodiacArea.innerHTML=
      '<div class="zodiac-elements">'+elemText+'</div>'+
      '<div class="zodiac-constellation">'+
        '<div class="zc-sign"><div class="zc-glyph">'+(sA.glyph||'✦')+'</div><div class="zc-trait">'+(sA.trait||'')+'</div><div class="zc-name">'+esc(sA.name||'')+'</div></div>'+
        '<div class="zc-bridge"><div class="zc-line"></div></div>'+
        '<div class="zc-sign"><div class="zc-glyph">'+(sB.glyph||'✦')+'</div><div class="zc-trait">'+(sB.trait||'')+'</div><div class="zc-name">'+esc(sB.name||'')+'</div></div>'+
      '</div>'+
      '<div class="zodiac-phrase">'+esc(data.zodiacPhrase)+'</div>';
  } else { zodiacArea.classList.add('hidden'); zodiacArea.innerHTML=''; }

  // 11. Reset selfie UI — release camera if open from previous reveal
  releaseSelfieCamera();
  $('selfiePreview').style.display='none';$('selfiePreview').innerHTML='';
  const capBtn=$('selfieCapBtn');
  if(capBtn){capBtn.innerHTML='<span class="rv-ico">✦</span> Guardar esse momento';capBtn.disabled=false}
  $('revealActions').style.opacity='';
}

// ═══ CHAT ═══
function enterChat(){if(state.currentRelation)openChat(state.currentRelation)}
async function openChat(rel){
  state.currentRelation=rel;pulseSent=false;
  const pb=$('pulseBtn');if(pb)pb.style.opacity='1';
  const partner=(rel.userA?.id===state.userId)?rel.userB:rel.userA;
  const pName=partner?.name||partner?.nickname||rel.partnerName||'Pessoa';
  state.currentPartnerId=partner?.id||rel.partnerId||null;
  $('chatPartner').textContent=pName;
  $('chatPhrase').textContent=rel.phrase;
  closePlusMenu();hideTyping();
  const mc=$('chatMessages'),ti=$('typingIndicator');mc.innerHTML='';mc.appendChild(ti);
  loadQuickPhrases();
  try{(await(await fetch('/api/messages/'+rel.relationId)).json()).forEach(m=>{
    if(m.type==='ephemeral')appendEphemeral(m);
    else if(m.type==='photo')appendPhoto(m);
    else appendMessage(m);
  })}catch(e){}
  // Load partner score + stars
  try{
    const ps=await fetch('/api/partner-score/'+rel.relationId+'/'+state.userId).then(r=>r.json());
    if(ps.score!=null){$('partnerPts').classList.remove('hidden');$('partnerPtsNum').textContent=ps.score+(ps.stars>0?' \u2B50'+ps.stars:'')}
  }catch(e){$('partnerPts').classList.add('hidden')}
  // Load streak
  loadStreak();
  startChatTimer(rel.expiresAt);showScreen('chat');
  // Mark as read
  localStorage.setItem('lastRead_'+rel.relationId,Date.now().toString());
  requestAnimationFrame(()=>{mc.scrollTop=mc.scrollHeight;$('chatInput').focus()});
}
async function loadStreak(){
  if(!state.currentPartnerId)return;
  try{
    const s=await fetch('/api/streak/'+state.userId+'/'+state.currentPartnerId).then(r=>r.json());
    const el=$('chatStreak');
    if(s.currentStreak>0){
      el.classList.remove('hidden');
      $('chatStreakText').innerHTML='<span class="streak-fire">🔥</span> '+s.currentStreak+' dia'+(s.currentStreak>1?'s':'');
      if(s.nextUnlock){
        const pct=Math.min(100,Math.round((s.currentStreak/s.nextUnlock.days)*100));
        $('chatStreakBar').style.width=pct+'%';
        $('chatStreakNext').textContent=s.nextUnlock.label+' em '+(s.nextUnlock.days-s.currentStreak)+'d';
      }else{
        $('chatStreakBar').style.width='100%';
        $('chatStreakNext').textContent='Todas conquistas desbloqueadas!';
      }
    }else el.classList.add('hidden');
  }catch(e){}
}
function appendMessage(msg){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');div.className='msg '+(msg.userId===state.userId?'mine':'theirs');
  const t=new Date(msg.timestamp);div.innerHTML=esc(msg.text)+'<div class="mt">'+pad(t.getHours())+':'+pad(t.getMinutes())+'</div>';
  mc.insertBefore(div,ti);if(near||msg.userId===state.userId)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
}
function sendMessage(){
  const input=$('chatInput'),text=input.value.trim();if(!text||!state.currentRelation)return;
  appendMessage({userId:state.userId,text,timestamp:Date.now()});playSound('send');haptic([30]);
  socket.emit('send-message',{relationId:state.currentRelation.relationId,userId:state.userId,text});
  input.value='';updateSendBtn();
}
function nearBot(){const el=$('chatMessages');return el.scrollHeight-el.scrollTop-el.clientHeight<80}
function startChatTimer(expiresAt){
  if(state.timerInterval)clearInterval(state.timerInterval);const el=$('chatTimer');
  let lastSec=-1;
  function tick(){
    const d=expiresAt-Date.now();
    if(d<=0){el.textContent='Expirado';el.classList.add('urg');clearInterval(state.timerInterval);showExpireCard();return}
    const sec=Math.floor(d/1000);
    el.textContent=pad(Math.floor(d/3600000))+':'+pad(Math.floor((d%3600000)/60000))+':'+pad(Math.floor((d%60000)/1000));
    el.classList.toggle('urg',d<3600000);
    // Pulse animation on second change
    if(sec!==lastSec){lastSec=sec;el.style.transform='scale(1.08)';setTimeout(()=>{el.style.transform='scale(1)'},150)}
  }
  tick();state.timerInterval=setInterval(tick,1000);
}

// ═══ HOROSCOPE ═══
async function getHoroscope(){
  if(!state.currentRelation)return;
  try{
    const r=await fetch('/api/horoscope/'+state.currentRelation.relationId+'/'+state.userId);
    const d=await r.json();
    if(d.error)return showToast(d.error);
    // Show as system message in chat
    const text='✨ '+d.phrase;
    appendMessage({userId:'system',text,timestamp:Date.now()});
    // Also emit so partner sees it
    socket.emit('send-message',{relationId:state.currentRelation.relationId,userId:'system',text});
    haptic([30,20,30]);
  }catch(e){showToast('Erro ao consultar astros.')}
}

// ═══ PULSE ═══
function sendPulse(){
  if(!state.currentRelation||pulseSent)return;
  socket.emit('pulse',{relationId:state.currentRelation.relationId,userId:state.userId});
  pulseSent=true;const pb=$('pulseBtn');if(pb)pb.style.opacity='.35';
  // Heartbeat vibration: lub-dub, lub-dub, lub-dub
  haptic([120,60,80,300,120,60,80,300,120,60,80]);
  showToast('Pulso enviado');
}

// ═══ SELFIE ═══
function requestSelfie(){
  if(!state.currentRelation)return;
  const input=document.createElement('input');input.type='file';input.accept='image/*';input.capture='user';
  input.onchange=async()=>{
    const file=input.files[0];if(!file)return;
    const c=document.createElement('canvas'),ctx=c.getContext('2d'),img=new Image();
    img.onload=async()=>{
      c.width=400;c.height=400;const sc=Math.max(400/img.width,400/img.height);
      ctx.drawImage(img,(400-img.width*sc)/2,(400-img.height*sc)/2,img.width*sc,img.height*sc);
      const data=c.toDataURL('image/jpeg',.6);
      await fetch('/api/selfie/'+state.currentRelation.relationId,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,selfieData:data})});
      showToast('Selfie enviada!');
    };img.src=URL.createObjectURL(file);
  };input.click();
}

// ═══ TYPING ═══
function handleTyping(){if(!state.currentRelation||!socket)return;const now=Date.now();if(now-lastTypingEmit>2000){socket.emit('typing',{relationId:state.currentRelation.relationId,userId:state.userId});lastTypingEmit=now}}
function showTyping(){$('typingIndicator').classList.add('vis');if(nearBot())$('chatMessages').scrollTo({top:99999,behavior:'smooth'});clearTimeout(typingTimeout);typingTimeout=setTimeout(hideTyping,3000)}
function hideTyping(){$('typingIndicator').classList.remove('vis')}

// ═══ QUICK PHRASES (EPHEMERAL) ═══
const QUICK_PHRASES=['Observei','Gostei','Algo ficou','Curioso','Queria te ver','Sem pressa','Sorrindo aqui','Pensando em ti'];
function loadQuickPhrases(){
  const bar=$('quickPhrases');if(!bar)return;bar.innerHTML='';
  QUICK_PHRASES.forEach(p=>{
    const chip=document.createElement('button');chip.className='qp-chip';chip.type='button';chip.textContent=p;
    chip.onclick=()=>{sendEphemeral(p);chip.classList.add('sent')};
    bar.appendChild(chip);
  });
}
function sendEphemeral(text){
  if(!state.currentRelation)return;
  const msg={userId:state.userId,text,type:'ephemeral',timestamp:Date.now()};
  appendEphemeral(msg);haptic([40,20,40]);
  socket.emit('send-ephemeral',{relationId:state.currentRelation.relationId,userId:state.userId,text});
}
function appendEphemeral(msg){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');
  div.className='msg ephemeral'+(msg.userId===state.userId?' mine':'');
  div.innerHTML=esc(msg.text);
  mc.insertBefore(div,ti);
  if(near||msg.userId===state.userId)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
  // Auto-fade after 8 seconds
  setTimeout(()=>{div.style.transition='opacity .6s,transform .6s';div.style.opacity='0';div.style.transform='scale(.95)';setTimeout(()=>div.remove(),700)},8000);
}

// ═══ PHOTO / FILE IN CHAT ═══
function pickPhoto(){
  closePlusMenu();if(!state.currentRelation)return;
  const input=document.createElement('input');input.type='file';input.accept='image/*';
  input.onchange=()=>{const file=input.files[0];if(file)processAndSendPhoto(file)};
  input.click();
}
function pickFile(){
  closePlusMenu();if(!state.currentRelation)return;
  const input=document.createElement('input');input.type='file';input.accept='image/*,.pdf,.doc,.docx,.txt';
  input.onchange=()=>{
    const file=input.files[0];if(!file)return;
    if(file.type.startsWith('image/'))processAndSendPhoto(file);
    else{showToast('Enviado: '+file.name);haptic([30])}
  };input.click();
}
function processAndSendPhoto(file){
  const reader=new FileReader();
  reader.onload=()=>{
    const img=new Image();img.onload=()=>{
      const c=document.createElement('canvas'),ctx=c.getContext('2d');
      const maxW=600,sc=Math.min(maxW/img.width,maxW/img.height,1);
      c.width=img.width*sc;c.height=img.height*sc;
      ctx.drawImage(img,0,0,c.width,c.height);
      const dataUrl=c.toDataURL('image/jpeg',.7);
      const msg={userId:state.userId,type:'photo',photoData:dataUrl,timestamp:Date.now()};
      appendPhoto(msg);haptic([30]);
      socket.emit('send-photo',{relationId:state.currentRelation.relationId,userId:state.userId,photoData:dataUrl});
    };img.src=reader.result;
  };reader.readAsDataURL(file);
}
function appendPhoto(msg){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');div.className='msg photo '+(msg.userId===state.userId?'mine':'theirs');
  const imgEl=document.createElement('img');imgEl.src=msg.photoData;imgEl.loading='lazy';
  imgEl.onclick=()=>{window.open(msg.photoData,'_blank')};
  div.appendChild(imgEl);
  const t=new Date(msg.timestamp);const tm=document.createElement('div');tm.className='mt';
  tm.textContent=pad(t.getHours())+':'+pad(t.getMinutes());div.appendChild(tm);
  mc.insertBefore(div,ti);
  if(near||msg.userId===state.userId)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
}

// ═══ PLUS MENU ═══
function togglePlusMenu(){const m=$('plusMenu');m.classList.toggle('open')}
function closePlusMenu(){const m=$('plusMenu');if(m)m.classList.remove('open')}

// ═══ STREAK UNLOCK ═══
function showStreakUnlock(data){
  const overlay=document.createElement('div');overlay.className='streak-unlock-overlay';
  let contentHtml='';
  if(data.question)contentHtml='<div class="su-content">'+esc(data.question)+'</div>';
  if(data.phrases)contentHtml='<div class="su-content" style="max-height:200px;overflow-y:auto;font-size:.75rem">'+data.phrases.map(p=>'<div style="margin-bottom:.3rem">"'+esc(p.phrase)+'" <span style="opacity:.4;font-size:.6rem">'+p.date+'</span></div>').join('')+'</div>';
  overlay.innerHTML='<div class="streak-unlock-card"><div class="su-emoji">🔥</div><div class="su-title">'+data.streakDays+' dias seguidos!</div><div style="font-size:.75rem;color:var(--t3);margin-bottom:.8rem">Desbloqueado: '+esc(data.unlock.label)+'</div><div class="su-desc">'+esc(data.unlock.description)+'</div>'+contentHtml+'<button class="bp" style="max-width:200px;margin:0 auto" onclick="this.closest(\'.streak-unlock-overlay\').remove()">Incrível!</button></div>';
  document.body.appendChild(overlay);
  haptic([100,50,100,50,100]);playSound('connect');
}

// ═══ TOUCH LINK ═══
let touchLinkData=null;
async function loadTouchLink(){
  try{
    const r=await fetch('/api/touch-link/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
    const d=await r.json();if(d.url){touchLinkData=d;$('touchLinkUrl').textContent=d.url}
  }catch(e){$('touchLinkUrl').textContent='Erro ao gerar link'}
}
function copyTouchLink(){
  if(!touchLinkData)return;
  navigator.clipboard.writeText(touchLinkData.url).then(()=>showToast('Link copiado!')).catch(()=>{
    const ta=document.createElement('textarea');ta.value=touchLinkData.url;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();showToast('Link copiado!');
  });
}
function showTouchQR(){
  const area=$('touchQRArea');
  if(area.style.display!=='none'){area.style.display='none';return}
  area.style.display='block';area.innerHTML='';
  if(touchLinkData&&typeof QRCode!=='undefined'){new QRCode(area,{text:touchLinkData.url,width:160,height:160,colorDark:'#ff6b35',colorLight:'#0a0a10'})}
}

// ═══ RELATIONS ═══
async function refreshRelations(){
  if(!state.userId)return;
  try{
    const rels=await(await fetch('/api/relations/'+state.userId)).json();
    const badge=$('relBadge'),count=$('relCount');
    if(rels.length>0){
      badge.classList.remove('hidden');
      // Count unread messages across all relations
      let unread=0;
      for(const r of rels){
        try{
          const msgs=await(await fetch('/api/messages/'+r.id)).json();
          const lastRead=parseInt(localStorage.getItem('lastRead_'+r.id)||'0');
          unread+=msgs.filter(m=>m.userId!==state.userId&&m.timestamp>lastRead).length;
        }catch(e){}
      }
      count.textContent=unread>0?unread:rels.length;
      if(unread>0){badge.style.background='rgba(255,107,53,.15)';badge.style.borderColor='var(--ac)'}
      else{badge.style.background='rgba(255,255,255,.04)';badge.style.borderColor='rgba(255,255,255,.06)'}
    }else badge.classList.add('hidden');
  }catch(e){}
}
async function showRelations(){
  haptic([30]);
  try{
    const rels=await(await fetch('/api/relations/'+state.userId)).json();const list=$('relationsList');
    if(!rels.length){list.innerHTML='<div class="nr"><div class="nr-icon">✦</div>Nenhuma conexão ativa.<div class="nr-text">Encoste em alguém para criar algo que só existe aqui.</div></div>'}
    else{
      const sub=$('relSubtitle');if(sub)sub.textContent=rels.length+' conex'+(rels.length===1?'ão':'ões');
      list.innerHTML='';rels.forEach((r,idx)=>{
      const h=Math.floor(r.timeLeft/3600000),m=Math.floor((r.timeLeft%3600000)/60000);
      let tc='ok';if(r.timeLeft<3600000)tc='low';else if(r.timeLeft<43200000)tc='med';
      const card=document.createElement('div');card.className='rc';card.style.animationDelay=(idx*0.06)+'s';card.style.animation='mi .35s ease '+(idx*0.06)+'s both';
      const pColor=r.partnerColor||nickColor(r.partnerName||'??');
      const timeLabel=tc==='low'?'expirando':'restante';
      card.innerHTML=makeAvatar(r.partnerName,pColor,48)+'<div class="ri"><div class="rn">'+esc(r.partnerName)+'</div><div class="rp">"'+esc(r.phrase)+'"</div></div><div class="rtm-wrap"><div class="rtm '+tc+'">'+h+'h '+m+'m</div><div class="rtm-label">'+timeLabel+'</div></div>';
      const rpid=r.userA===state.userId?r.userB:r.userA;
      card.addEventListener('click',()=>openChat({relationId:r.id,phrase:r.phrase,expiresAt:r.expiresAt,partnerName:r.partnerName,partnerId:rpid,userA:{id:r.userA},userB:{id:r.userB}}));
      list.appendChild(card);
    })}
    showScreen('relations');
  }catch(e){showToast('Erro ao carregar.')}
}

// ═══ CONSTELLATION ═══
let constState={nodes:[],cam:{x:0,y:0,zoom:1},dragging:false,lastTouch:null,animFrame:null,selectedNode:null};
const CONST_FEEDBACK=['Um novo ponto surgiu.','Sua rede cresceu hoje.','Um encontro deixou rastro.','Um elo foi reforçado.','Algo ficou marcado.','A constelação se expandiu.'];

async function showHistory(){
  haptic([30]);
  try{
    const data=await(await fetch('/api/constellation/'+state.userId)).json();
    const empty=$('constEmpty');
    if(!data.nodes||!data.nodes.length){empty.classList.remove('hidden');constState.nodes=[];showScreen('history');initConstCanvas();return}
    empty.classList.add('hidden');
    // Layout nodes in organic circular pattern around center
    const nodes=data.nodes.map((n,i)=>{
      const angle=(i/data.nodes.length)*Math.PI*2-Math.PI/2;
      const radius=80+Math.random()*60+i*12;
      return{...n,x:Math.cos(angle)*radius+(Math.random()-.5)*30,y:Math.sin(angle)*radius+(Math.random()-.5)*30,
        color:n.color||nickColor(n.nickname||'?'),baseRadius:6+n.intensity*8,pulsePhase:Math.random()*Math.PI*2};
    });
    constState.nodes=nodes;
    constState.cam={x:0,y:0,zoom:1};
    constState.selectedNode=null;
    hideConstDetail();
    showScreen('history');
    initConstCanvas();
    // Show feedback if new nodes since last visit
    const prevCount=parseInt(localStorage.getItem('enc_const_count')||'0');
    if(data.total>prevCount&&prevCount>0){
      const fb=$('constFeedback');
      fb.textContent=CONST_FEEDBACK[Math.floor(Math.random()*CONST_FEEDBACK.length)];
      fb.classList.add('show');
      setTimeout(()=>fb.classList.remove('show'),3500);
    }
    localStorage.setItem('enc_const_count',String(data.total));
  }catch(e){showToast('Erro ao carregar.')}
}

function initConstCanvas(){
  const canvas=$('constCanvas');if(!canvas)return;
  const wrap=canvas.parentElement;
  const dpr=window.devicePixelRatio||1;
  canvas.width=wrap.clientWidth*dpr;
  canvas.height=wrap.clientHeight*dpr;
  canvas.style.width=wrap.clientWidth+'px';
  canvas.style.height=wrap.clientHeight+'px';
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  const W=wrap.clientWidth,H=wrap.clientHeight;

  // Touch/pointer handlers
  let pinchDist=0,pinchZoom=1;
  canvas.onpointerdown=e=>{
    constState.dragging=true;constState.lastTouch={x:e.clientX,y:e.clientY};
  };
  canvas.onpointermove=e=>{
    if(!constState.dragging||!constState.lastTouch)return;
    const dx=e.clientX-constState.lastTouch.x,dy=e.clientY-constState.lastTouch.y;
    constState.cam.x+=dx/constState.cam.zoom;
    constState.cam.y+=dy/constState.cam.zoom;
    constState.lastTouch={x:e.clientX,y:e.clientY};
  };
  canvas.onpointerup=e=>{
    if(constState.dragging&&constState.lastTouch){
      // Check if it was a tap (not drag)
      const tapThresh=8;
      if(Math.abs(e.clientX-constState.lastTouch.x)<tapThresh&&Math.abs(e.clientY-constState.lastTouch.y)<tapThresh){
        handleConstTap(e.clientX-canvas.getBoundingClientRect().left,e.clientY-canvas.getBoundingClientRect().top,W,H);
      }
    }
    constState.dragging=false;constState.lastTouch=null;
  };
  canvas.ontouchstart=e=>{
    if(e.touches.length===2){
      pinchDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      pinchZoom=constState.cam.zoom;
    }
  };
  canvas.ontouchmove=e=>{
    if(e.touches.length===2){
      e.preventDefault();
      const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      constState.cam.zoom=Math.max(.3,Math.min(3,pinchZoom*(d/pinchDist)));
    }
  };
  // Mouse wheel zoom
  canvas.onwheel=e=>{e.preventDefault();constState.cam.zoom=Math.max(.3,Math.min(3,constState.cam.zoom*(e.deltaY>0?.9:1.1)))};

  // Animation loop
  if(constState.animFrame)cancelAnimationFrame(constState.animFrame);
  const bgStars=Array.from({length:60},()=>({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.2+.3,twinkle:Math.random()*Math.PI*2,speed:.3+Math.random()*.5}));
  function draw(){
    constState.animFrame=requestAnimationFrame(draw);
    ctx.clearRect(0,0,W,H);
    const t=Date.now()/1000;
    // Background stars
    bgStars.forEach(s=>{
      const a=.15+Math.sin(t*s.speed+s.twinkle)*.1;
      ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,'+a.toFixed(2)+')';ctx.fill();
    });
    if(!constState.nodes.length)return;
    const cx=W/2+constState.cam.x*constState.cam.zoom;
    const cy=H*0.45+constState.cam.y*constState.cam.zoom;
    const z=constState.cam.zoom;
    // Draw elos (lines from center to each node)
    constState.nodes.forEach(n=>{
      const nx=cx+n.x*z,ny=cy+n.y*z;
      const grad=ctx.createLinearGradient(cx,cy,nx,ny);
      grad.addColorStop(0,'rgba(255,107,53,'+(n.intensity*.15).toFixed(2)+')');
      grad.addColorStop(1,'rgba(255,107,53,'+(n.intensity*.35).toFixed(2)+')');
      ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(nx,ny);ctx.strokeStyle=grad;ctx.lineWidth=.8*z;ctx.stroke();
    });
    // Draw center node (me)
    const myR=10*z;
    const myGlow=ctx.createRadialGradient(cx,cy,0,cx,cy,myR*3);
    myGlow.addColorStop(0,'rgba(255,107,53,.2)');myGlow.addColorStop(1,'transparent');
    ctx.beginPath();ctx.arc(cx,cy,myR*3,0,Math.PI*2);ctx.fillStyle=myGlow;ctx.fill();
    ctx.beginPath();ctx.arc(cx,cy,myR,0,Math.PI*2);
    ctx.fillStyle=state.userColor||'#ff6b35';ctx.fill();
    ctx.fillStyle='#fff';ctx.font='bold '+(8*z)+'px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText((state.userName||'EU').slice(0,2).toUpperCase(),cx,cy);
    // Draw people nodes
    constState.nodes.forEach(n=>{
      const nx=cx+n.x*z,ny=cy+n.y*z;
      const pulse=1+Math.sin(t*1.5+n.pulsePhase)*.08;
      const r=n.baseRadius*z*pulse;
      // Outer glow
      const glow=ctx.createRadialGradient(nx,ny,0,nx,ny,r*2.5);
      glow.addColorStop(0,'rgba(255,255,255,'+(n.intensity*.12).toFixed(2)+')');
      glow.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(nx,ny,r*2.5,0,Math.PI*2);ctx.fillStyle=glow;ctx.fill();
      // Node
      ctx.beginPath();ctx.arc(nx,ny,r,0,Math.PI*2);ctx.fillStyle=n.color;ctx.globalAlpha=.4+n.intensity*.6;ctx.fill();ctx.globalAlpha=1;
      // Border
      ctx.beginPath();ctx.arc(nx,ny,r,0,Math.PI*2);ctx.strokeStyle='rgba(255,255,255,'+(n.intensity*.3).toFixed(2)+')';ctx.lineWidth=1;ctx.stroke();
      // Nickname (only when zoomed enough)
      if(z>.6){
        ctx.fillStyle='rgba(255,255,255,'+(0.4+n.intensity*0.3).toFixed(2)+')';
        ctx.font=(Math.max(8,9*z))+'px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='top';
        ctx.fillText(n.nickname.length>8?n.nickname.slice(0,7)+'…':n.nickname,nx,ny+r+4*z);
      }
    });
    ctx.textBaseline='alphabetic';
  }
  draw();
}

function handleConstTap(tx,ty,W,H){
  const cx=W/2+constState.cam.x*constState.cam.zoom;
  const cy=H*0.45+constState.cam.y*constState.cam.zoom;
  const z=constState.cam.zoom;
  let hit=null,minD=Infinity;
  constState.nodes.forEach(n=>{
    const nx=cx+n.x*z,ny=cy+n.y*z;
    const d=Math.hypot(tx-nx,ty-ny);
    const hitR=n.baseRadius*z*1.8+10;// generous tap target
    if(d<hitR&&d<minD){minD=d;hit=n}
  });
  if(hit){showConstDetail(hit)}else{hideConstDetail()}
}
function showConstDetail(node){
  constState.selectedNode=node;
  const av=$('constDetailAvatar');
  av.textContent=(node.nickname||'??').slice(0,2).toUpperCase();
  av.style.background=node.color;
  $('constDetailNick').textContent=node.nickname;
  $('constDetail').classList.add('visible');
  haptic([15]);
}
function hideConstDetail(){$('constDetail').classList.remove('visible');constState.selectedNode=null}

// ═══ BOARDING PASS ═══
async function showBoardingPass(){
  haptic([30]);
  try{
    const d=await fetch('/api/boarding-pass/'+state.userId).then(r=>r.json());
    $('bpName').textContent=d.name;
    const bpColor=d.color||nickColor(d.name||'??');
    const bpInitials=(d.name||'??').slice(0,2).toUpperCase();
    $('bpAvatar').innerHTML='';$('bpAvatar').textContent=bpInitials;$('bpAvatar').style.background=bpColor;$('bpAvatar').style.fontSize='1.4rem';$('bpAvatar').style.fontWeight='800';$('bpAvatar').style.color='#fff';
    const since=new Date(d.memberSince);
    const months=['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];
    $('bpSince').textContent='membro desde '+months[since.getMonth()]+' '+since.getFullYear();
    $('bpScore').textContent=d.score;
    $('bpStars').textContent=d.stars;
    $('bpPeople').textContent=d.uniquePeople;
    $('bpTotal').textContent=d.totalEncounters;
    // Generate barcode visual
    const bc=$('bpBarcode');bc.innerHTML='';
    for(let i=0;i<40;i++){const bar=document.createElement('div');bar.className='bp-bar';bar.style.height=(8+Math.random()*16)+'px';bar.style.opacity=(.3+Math.random()*.5).toFixed(2);bc.appendChild(bar)}
    loadTouchLink();
    showScreen('boardingPass');
  }catch(e){showToast('Erro ao carregar bilhete.')}
}
function downloadBoardingPass(){
  const card=$('bpCard');
  const c=document.createElement('canvas');c.width=640;c.height=900;
  const ctx=c.getContext('2d');
  // Background
  const grad=ctx.createLinearGradient(0,0,0,900);
  grad.addColorStop(0,'#0c0c18');grad.addColorStop(.5,'#161628');grad.addColorStop(1,'#0c0c18');
  ctx.fillStyle=grad;roundRect(ctx,0,0,640,900,30);ctx.fill();
  // Top accent line
  const acGrad=ctx.createLinearGradient(0,0,640,0);acGrad.addColorStop(0,'#ff6b35');acGrad.addColorStop(.5,'#ff3d71');acGrad.addColorStop(1,'#ff6b35');
  ctx.fillStyle=acGrad;ctx.fillRect(0,0,640,5);
  // Header
  ctx.fillStyle='#ff6b35';ctx.font='bold 16px Inter,sans-serif';ctx.letterSpacing='6px';ctx.fillText('ENCOSTA',30,50);
  ctx.fillStyle='#555568';ctx.font='12px Inter,sans-serif';ctx.letterSpacing='3px';ctx.textAlign='right';ctx.fillText('BOARDING PASS',610,50);ctx.textAlign='left';ctx.letterSpacing='0px';
  // Dashed line
  ctx.setLineDash([6,4]);ctx.strokeStyle='#2a2a3a';ctx.beginPath();ctx.moveTo(20,70);ctx.lineTo(620,70);ctx.stroke();ctx.setLineDash([]);
  // Avatar circle
  const avX=320,avY=160,avR=50;
  ctx.beginPath();ctx.arc(avX,avY,avR+3,0,Math.PI*2);ctx.strokeStyle='#ff6b35';ctx.lineWidth=2;ctx.stroke();
  const bpAv=$('bpAvatar');const avColor=bpAv.style.background||'hsl(200,65%,55%)';
  ctx.beginPath();ctx.arc(avX,avY,avR,0,Math.PI*2);ctx.fillStyle=avColor;ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 32px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(bpAv.textContent||'??',avX,avY);ctx.textBaseline='alphabetic';
  // Name
  ctx.fillStyle='#f5f5f7';ctx.font='bold 28px Inter,sans-serif';ctx.textAlign='center';
  ctx.fillText($('bpName').textContent,320,260);
  // Since
  ctx.fillStyle='#555568';ctx.font='13px Inter,sans-serif';
  ctx.fillText($('bpSince').textContent,320,290);
  // Stats boxes
  const stats=[{n:$('bpScore').textContent,l:'SCORE'},{n:$('bpStars').textContent,l:'ESTRELAS'},{n:$('bpPeople').textContent,l:'PESSOAS'},{n:$('bpTotal').textContent,l:'ENCONTROS'}];
  const sw=120,sy=340;
  stats.forEach((s,i)=>{
    const sx=30+i*(sw+25);
    ctx.fillStyle='rgba(255,107,53,0.08)';roundRect(ctx,sx,sy,sw,90,12);ctx.fill();
    ctx.fillStyle='#ff6b35';ctx.font='bold 36px Inter,sans-serif';ctx.textAlign='center';ctx.fillText(s.n,sx+sw/2,sy+45);
    ctx.fillStyle='#555568';ctx.font='10px Inter,sans-serif';ctx.letterSpacing='2px';ctx.fillText(s.l,sx+sw/2,sy+72);ctx.letterSpacing='0px';
  });
  // Dashed line
  ctx.setLineDash([6,4]);ctx.strokeStyle='#2a2a3a';ctx.beginPath();ctx.moveTo(20,480);ctx.lineTo(620,480);ctx.stroke();ctx.setLineDash([]);
  // Barcode
  for(let i=0;i<60;i++){const bh=15+Math.random()*25,bx=80+i*8;ctx.fillStyle='rgba(85,85,104,'+(0.3+Math.random()*0.4).toFixed(2)+')';ctx.fillRect(bx,520,3,bh)}
  // Footer
  ctx.fillStyle='#555568';ctx.font='11px Inter,sans-serif';ctx.letterSpacing='4px';ctx.textAlign='center';
  ctx.fillText('TUDO NASCE NO GESTO',320,610);ctx.letterSpacing='0px';
  // Corners notch effect
  ctx.fillStyle='#050508';
  [[-1,480],[641-20,480]].forEach(([x,y])=>{ctx.beginPath();ctx.arc(x<0?0:640,y,15,0,Math.PI*2);ctx.fill()});
  // Download
  c.toBlob(blob=>{
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='encosta-pass.png';a.click();URL.revokeObjectURL(url);
    showToast('Bilhete salvo!');haptic([50,30,50]);
  },'image/png');
}
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath()}

// ═══ PROFILE ═══
let profileReturnTo='chat';
async function showPartnerProfile(){
  if(!state.currentRelation)return;
  const pid=state.currentPartnerId;
  if(!pid)return showToast('Parceiro não encontrado.');
  profileReturnTo='chat';
  await loadProfile(pid);
}
async function loadProfile(userId,canAct){
  haptic([30]);
  try{
    const url=canAct===false?'/api/profile/'+userId:'/api/profile/'+userId+'/from/'+state.userId;
    const d=await fetch(url).then(r=>r.json());
    if(d.error)return showToast(d.error);
    renderProfile(d,userId);
    showScreen('profile');
  }catch(e){showToast('Erro ao carregar perfil.')}
}
function renderProfile(d,userId){
  $('pfTitle').textContent=d.nickname;
  const s=$('pfScroll');
  let html='<div class="pf-card">'+makeAvatar(d.nickname,d.color,64);
  html+='<div style="margin-top:.8rem;font-size:1.1rem;font-weight:700">'+esc(d.nickname)+'</div>';
  html+='<div style="font-size:.65rem;color:var(--t3);margin-top:.2rem">membro desde '+new Date(d.memberSince).toLocaleDateString('pt-BR')+'</div>';
  html+='<div class="pf-stats">';
  html+='<div class="pf-stat"><div class="pf-stat-num">'+(d.score||0)+'</div><div class="pf-stat-lbl">score</div></div>';
  html+='<div class="pf-stat"><div class="pf-stat-num" style="color:#fbbf24">'+(d.stars||0)+'</div><div class="pf-stat-lbl">estrelas</div></div>';
  html+='<div class="pf-stat"><div class="pf-stat-num">'+d.uniquePeople+'</div><div class="pf-stat-lbl">pessoas</div></div>';
  html+='<div class="pf-stat"><div class="pf-stat-num">'+d.totalEncounters+'</div><div class="pf-stat-lbl">encontros</div></div>';
  html+='</div>';
  // Star details
  if(d.starDetails&&d.starDetails.length>0){
    html+='<div style="display:flex;flex-wrap:wrap;gap:.3rem;justify-content:center;margin:.5rem 0">';
    d.starDetails.forEach(s=>{
      const tip=s.reason==='gift'?'Presente de '+(s.fromName||'?'):s.reason==='organic'?'Orgânica ('+s.milestone+'x com '+(s.withName||'?')+')':'Marco';
      html+='<div title="'+tip+'" style="font-size:1rem;cursor:help;transition:.15s" onmouseenter="this.style.transform=\'scale(1.3)\'" onmouseleave="this.style.transform=\'none\'">⭐</div>';
    });
    html+='</div>';
  }
  html+='</div>';
  // Actions if active connection
  if(d.canInteract){
    html+='<div class="pf-actions">';
    html+='<button class="pf-act-btn" onclick="openGiftPicker()">&#x1F381; Presentear</button>';
    html+='<button class="pf-act-btn" onclick="openDeclModal()">&#x1F4DD; Declarar</button>';
    html+='</div>';
  }
  // Declarations
  html+='<div class="pf-section"><div class="pf-section-title">Declarações recebidas</div>';
  if(d.declarations&&d.declarations.length>0){
    d.declarations.slice().reverse().forEach(dc=>{
      html+='<div class="pf-decl"><div class="pf-decl-text">"'+esc(dc.text)+'"</div><div class="pf-decl-from">— '+esc(dc.fromName)+'</div></div>';
    });
  }else html+='<div class="pf-empty">Nenhuma declaração ainda.</div>';
  html+='</div>';
  // Gifts
  html+='<div class="pf-section"><div class="pf-section-title">Presentes recebidos</div>';
  if(d.gifts&&d.gifts.length>0){
    d.gifts.slice().reverse().forEach(g=>{
      html+='<div class="pf-gift"><div class="pf-gift-emoji">'+g.emoji+'</div><div class="pf-gift-info"><div class="pf-gift-name">'+esc(g.giftName)+'</div><div class="pf-gift-from">de '+esc(g.fromName)+'</div>'+(g.message?'<div class="pf-gift-msg">"'+esc(g.message)+'"</div>':'')+'</div></div>';
    });
  }else html+='<div class="pf-empty">Nenhum presente ainda.</div>';
  html+='</div>';
  s.innerHTML=html;
}
function closeProfile(){
  if(profileReturnTo==='chat'&&state.currentRelation)showScreen('chat');
  else goHome();
}

// ═══ GIFT PICKER ═══
let giftCatalog=[];
async function openGiftPicker(){
  if(!state.currentRelation)return;
  if(!giftCatalog.length){try{giftCatalog=await fetch('/api/gift-catalog').then(r=>r.json())}catch(e){return showToast('Erro ao carregar presentes.')}}
  let html='<div class="modal-overlay" onclick="closeGiftModal(event)">';
  html+='<div class="modal-sheet" onclick="event.stopPropagation()">';
  html+='<div class="modal-handle"></div>';
  html+='<div class="modal-title">&#x1F381; Escolha um presente</div>';
  html+='<div class="gift-grid">';
  giftCatalog.forEach(g=>{
    html+='<div class="gift-option" onclick="selectGift(\''+g.id+'\')">';
    html+='<div class="g-emoji">'+g.emoji+'</div>';
    html+='<div class="g-name">'+esc(g.name)+'</div>';
    html+='<div class="g-desc">'+esc(g.description)+'</div>';
    html+='</div>';
  });
  html+='</div></div></div>';
  $('giftModal').innerHTML=html;$('giftModal').classList.remove('hidden');
}
function closeGiftModal(e){if(e&&e.target.classList.contains('modal-overlay'))$('giftModal').classList.add('hidden');$('giftModal').innerHTML=''}
function selectGift(giftId){
  const gift=giftCatalog.find(g=>g.id===giftId);if(!gift)return;
  let html='<div class="modal-overlay" onclick="closeGiftModal(event)">';
  html+='<div class="modal-sheet" onclick="event.stopPropagation()">';
  html+='<div class="modal-handle"></div>';
  html+='<div class="modal-title">'+gift.emoji+' '+esc(gift.name)+'</div>';
  html+='<div style="text-align:center;font-size:.8rem;color:var(--t2);margin-bottom:.8rem">'+esc(gift.description)+'</div>';
  if(gift.needsAddress)html+='<div style="text-align:center;font-size:.7rem;color:var(--warn);margin-bottom:.6rem">&#x1F4E6; Requer endereço (pediremos permissão)</div>';
  html+='<input class="gift-msg-input" id="giftMsg" placeholder="Mensagem (opcional)" maxlength="120">';
  html+='<div style="margin-top:.8rem;text-align:center"><button class="bp" style="max-width:200px" onclick="confirmSendGift(\''+giftId+'\')">Enviar presente</button></div>';
  html+='</div></div>';
  $('giftModal').innerHTML=html;
}
async function confirmSendGift(giftId){
  const msg=$('giftMsg')?$('giftMsg').value.trim():'';
  try{
    const r=await fetch('/api/gift/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId:state.currentRelation.relationId,fromUserId:state.userId,giftId,message:msg})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Presente enviado!');haptic([50,30,50,30,50]);
    $('giftModal').classList.add('hidden');$('giftModal').innerHTML='';
  }catch(e){showToast('Erro ao enviar.')}
}

// ═══ DECLARATION MODAL ═══
function openDeclModal(){
  if(!state.currentRelation)return;
  let html='<div class="modal-overlay" onclick="closeDeclModal(event)">';
  html+='<div class="modal-sheet" onclick="event.stopPropagation()">';
  html+='<div class="modal-handle"></div>';
  html+='<div class="modal-title">&#x1F4DD; Declaração</div>';
  html+='<div style="text-align:center;font-size:.78rem;color:var(--t2);margin-bottom:.8rem">Escreva algo para ficar no perfil dessa pessoa. Todos que se conectarem a ela poderão ler.</div>';
  html+='<textarea class="decl-input" id="declText" placeholder="Escreva sua declaração..." maxlength="280" oninput="updateDeclCounter()"></textarea>';
  html+='<div class="decl-counter" id="declCounter">0/280</div>';
  html+='<div style="margin-top:.6rem;text-align:center"><button class="bp" style="max-width:200px" onclick="confirmSendDecl()">Publicar</button></div>';
  html+='</div></div>';
  $('declModal').innerHTML=html;$('declModal').classList.remove('hidden');
}
function closeDeclModal(e){if(e&&e.target.classList.contains('modal-overlay'))$('declModal').classList.add('hidden');$('declModal').innerHTML=''}
function updateDeclCounter(){const t=$('declText');if(t)$('declCounter').textContent=t.value.length+'/280'}
async function confirmSendDecl(){
  const text=$('declText')?$('declText').value.trim():'';
  if(!text||text.length<3)return showToast('Escreva pelo menos 3 caracteres.');
  try{
    const r=await fetch('/api/declaration/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId:state.currentRelation.relationId,fromUserId:state.userId,text})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Declaração publicada!');haptic([50,30,50]);
    $('declModal').classList.add('hidden');$('declModal').innerHTML='';
  }catch(e){showToast('Erro ao publicar.')}
}

// ═══ ADDRESS REQUEST (in chat) ═══
function showAddressRequest(gift){
  const area=$('contactRequestArea');
  let html='<div class="addr-request" id="addrReq-'+gift.id+'">';
  html+='<div class="addr-request-text">'+esc(gift.fromName)+' quer te presentear com <strong>'+gift.emoji+' '+esc(gift.giftName)+'</strong>!'+(gift.message?' "'+esc(gift.message)+'"':'')+'</div>';
  html+='<div class="addr-request-note">Seu endereço NÃO é passado para essa pessoa. A plataforma cuida da entrega.</div>';
  html+='<input class="addr-input" id="addrInput-'+gift.id+'" placeholder="Seu endereço completo para entrega">';
  html+='<div class="addr-actions">';
  html+='<button class="addr-btn accept" onclick="respondAddress(\''+gift.id+'\',true)">Aceitar &#x1F4E6;</button>';
  html+='<button class="addr-btn decline" onclick="respondAddress(\''+gift.id+'\',false)">Não, obrigado</button>';
  html+='</div></div>';
  area.innerHTML+=html;
}
async function respondAddress(giftId,accepted){
  const addrEl=$('addrInput-'+giftId);
  const address=addrEl?addrEl.value.trim():'';
  if(accepted&&!address)return showToast('Digite seu endereço para receber.');
  try{
    await fetch('/api/gift/address-response',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({giftId,userId:state.userId,accepted,address:accepted?address:null})});
    const el=$('addrReq-'+giftId);if(el)el.remove();
    showToast(accepted?'Endereço enviado! Presente a caminho.':'Presente recusado.');haptic([50]);
  }catch(e){showToast('Erro.')}
}

// ═══ HISTORY CARD SAVE/SHARE ═══
function saveHistoryCard(idx){
  const e=window._historyData&&window._historyData[idx];if(!e)return;
  const c=document.createElement('canvas');c.width=600;c.height=400;const ctx=c.getContext('2d');
  // BG
  const grad=ctx.createLinearGradient(0,0,0,400);grad.addColorStop(0,'#0a0a12');grad.addColorStop(.5,'#15152a');grad.addColorStop(1,'#0a0a12');
  ctx.fillStyle=grad;roundRect(ctx,0,0,600,400,20);ctx.fill();
  // Accent top
  const acG=ctx.createLinearGradient(0,0,600,0);acG.addColorStop(0,'#ff6b35');acG.addColorStop(1,'#ff3d71');
  ctx.fillStyle=acG;ctx.fillRect(0,0,600,3);
  // Logo
  ctx.fillStyle='#ff6b35';ctx.font='bold 11px Inter,sans-serif';ctx.letterSpacing='4px';ctx.fillText('ENCOSTA',30,35);ctx.letterSpacing='0px';
  // Avatar circle
  const color=e.withColor||nickColor(e.withName||'??');
  ctx.beginPath();ctx.arc(300,120,35,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 22px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText((e.withName||'??').slice(0,2).toUpperCase(),300,120);ctx.textBaseline='alphabetic';
  // Name
  ctx.fillStyle='#f5f5f7';ctx.font='600 18px Inter,sans-serif';ctx.fillText(e.withName||'Alguém',300,185);
  // Date
  const d=new Date(e.timestamp);
  ctx.fillStyle='#555568';ctx.font='12px Inter,sans-serif';ctx.fillText(pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear()+' '+pad(d.getHours())+':'+pad(d.getMinutes()),300,210);
  // Phrase
  if(e.phrase){ctx.fillStyle='#8888a0';ctx.font='italic 16px Inter,sans-serif';
    const words=e.phrase.split(' ');let line='',y=260;
    words.forEach(w=>{const test=line+w+' ';if(ctx.measureText(test).width>460&&line){ctx.fillText('"'+line.trim()+'"',300,y);y+=24;line=w+' '}else line=test});
    if(line)ctx.fillText(line===e.phrase+' '?'"'+line.trim()+'"':line.trim(),300,y);
  }
  // Footer
  ctx.fillStyle='#555568';ctx.font='9px Inter,sans-serif';ctx.letterSpacing='3px';ctx.fillText('TUDO NASCE NO GESTO',300,375);ctx.letterSpacing='0px';ctx.textAlign='left';
  // Download
  c.toBlob(blob=>{const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='encosta-encontro-'+(idx+1)+'.png';a.click();URL.revokeObjectURL(url);showToast('Card salvo!');haptic([50,30,50])},'image/png');
}
function shareHistoryCard(idx){
  const e=window._historyData&&window._historyData[idx];if(!e)return;
  const text='"'+(e.phrase||'')+'" — encontro com '+e.withName+' via ENCOSTA';
  if(navigator.share){navigator.share({title:'ENCOSTA',text}).catch(()=>{})}
  else{navigator.clipboard.writeText(text).then(()=>showToast('Copiado!')).catch(()=>{})}
}

// ═══ EXPIRE CARD ═══
function showExpireCard(){if(!state.currentRelation)return;$('cardPhrase').textContent=state.currentRelation.phrase;const cr=state.currentRelation.createdAt||(state.currentRelation.expiresAt-86400000);$('cardTime').textContent=Math.round((state.currentRelation.expiresAt-cr)/3600000)+'h juntos';showScreen('expireCard')}
async function shareCard(){const text='"'+state.currentRelation.phrase+'" — ENCOSTA';if(navigator.share){try{await navigator.share({title:'ENCOSTA',text})}catch(e){}}else{try{await navigator.clipboard.writeText(text);showToast('Copiado!')}catch(e){}}}

// ═══ SOUND & HAPTICS ═══
let audioCtx=null;
function playSound(type){
  try{if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')audioCtx.resume();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sine';const t=audioCtx.currentTime;
  if(type==='send'){o.frequency.setValueAtTime(600,t);o.frequency.exponentialRampToValueAtTime(900,t+.08);g.gain.setValueAtTime(.06,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12)}
  else if(type==='receive'){o.frequency.setValueAtTime(500,t);o.frequency.exponentialRampToValueAtTime(700,t+.1);g.gain.setValueAtTime(.05,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.start(t);o.stop(t+.15)}
  else if(type==='connect'){o.frequency.setValueAtTime(523,t);o.frequency.setValueAtTime(659,t+.12);o.frequency.setValueAtTime(784,t+.24);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4)}
  else if(type==='pulse'){o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(200,t+.3);g.gain.setValueAtTime(.08,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4)}
  }catch(e){}
}
function haptic(p){if(navigator.vibrate)navigator.vibrate(p)}

// ═══ HOME MOTIVATION ═══
const HOME_PHRASES=[
  'Nada acontece\nà distância.',
  'Quem encosta\ndescobre.',
  'Presença é\na moeda rara.',
  'O encontro\né o começo.',
  'Hoje é feito\nde gestos.',
  'A conexão\nvive no toque.',
  'Não espere.\nEncosta.',
  'Cada encontro\ndeixa marca.',
  'O melhor momento\né o presente.',
  'Proximidade\nmuda tudo.'
];
function setHomeMotivation(){
  const el=$('homeMotivation');
  if(!el)return;
  const p=HOME_PHRASES[Math.floor(Math.random()*HOME_PHRASES.length)];
  el.innerHTML=p.replace('\n','<br>');
}

// ═══ UTILS ═══
function showToast(msg){const t=$('toast');t.textContent=msg;t.classList.remove('hidden');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.add('hidden'),2500)}
function esc(text){const d=document.createElement('div');d.textContent=text;return d.innerHTML}
function pad(n){return n.toString().padStart(2,'0')}
function updateSendBtn(){$('sendBtn').classList.toggle('active',$('chatInput').value.trim().length>0)}

// ═══ SELFIE AT CONNECTION (v2 — inline, no separate step) ═══
let selfieStream=null;
function releaseSelfieCamera(){
  if(selfieStream){selfieStream.getTracks().forEach(t=>t.stop());selfieStream=null}
  const v=$('selfieVideo');if(v){v.srcObject=null;v.style.display='none'}
}
function releaseAllMedia(){
  // Stop sonic (mic + speaker)
  if(homeSonicActive)stopHomeSonic();
  if(sonicActive)stopSonicMode();
  // Stop selfie camera
  releaseSelfieCamera();
}
function revealCaptureSelfie(){
  const btn=$('selfieCapBtn');
  // If camera already active, capture
  if(selfieStream){
    const v=$('selfieVideo'),c=$('selfieCanvas');
    c.width=400;c.height=400;const ctx=c.getContext('2d');
    const s=Math.min(v.videoWidth,v.videoHeight);const sx=(v.videoWidth-s)/2,sy=(v.videoHeight-s)/2;
    ctx.drawImage(v,sx,sy,s,s,0,0,400,400);
    const dataUrl=c.toDataURL('image/jpeg',0.7);
    if(selfieStream){selfieStream.getTracks().forEach(t=>t.stop());selfieStream=null}
    v.style.display='none';
    $('selfiePreview').innerHTML='<img src="'+dataUrl+'" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--ok)">';
    $('selfiePreview').style.display='block';
    btn.innerHTML='<span class="rv-ico">&#x2714;</span> Salvo';btn.disabled=true;btn.style.borderColor='var(--ok)';btn.style.color='var(--ok)';
    if(state.currentRelation){
      fetch('/api/selfie/'+state.currentRelation.relationId,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,selfieData:dataUrl})}).catch(()=>{});
    }
    haptic([50,30,50]);
    return;
  }
  // Open camera inline
  if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){
    navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false}).then(stream=>{
      selfieStream=stream;const v=$('selfieVideo');v.srcObject=stream;v.style.display='block';
      btn.innerHTML='<span class="rv-ico">&#x1F4F8;</span> Capturar';
    }).catch(()=>{
      // Fallback: file picker
      const input=document.createElement('input');input.type='file';input.accept='image/*';input.capture='user';
      input.onchange=()=>{
        const file=input.files[0];if(!file)return;
        const reader=new FileReader();reader.onload=()=>{
          const img=new Image();img.onload=()=>{
            const c=document.createElement('canvas'),ctx=c.getContext('2d');
            c.width=400;c.height=400;const sc=Math.max(400/img.width,400/img.height);
            ctx.drawImage(img,(400-img.width*sc)/2,(400-img.height*sc)/2,img.width*sc,img.height*sc);
            const dataUrl=c.toDataURL('image/jpeg',.7);
            $('selfiePreview').innerHTML='<img src="'+dataUrl+'" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--ok)">';
            $('selfiePreview').style.display='block';
            btn.innerHTML='<span class="rv-ico">&#x2714;</span> Salvo';btn.disabled=true;btn.style.borderColor='var(--ok)';btn.style.color='var(--ok)';
            if(state.currentRelation)fetch('/api/selfie/'+state.currentRelation.relationId,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,selfieData:dataUrl})}).catch(()=>{});
            haptic([50,30,50]);
          };img.src=reader.result;
        };reader.readAsDataURL(file);
      };input.click();
    });
  }else{
    // No camera API - use file picker
    const input=document.createElement('input');input.type='file';input.accept='image/*';input.capture='user';
    input.onchange=()=>{
      const file=input.files[0];if(!file)return;
      const reader=new FileReader();reader.onload=()=>{
        $('selfiePreview').innerHTML='<img src="'+reader.result+'" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--ok)">';
        $('selfiePreview').style.display='block';
        btn.innerHTML='<span class="rv-ico">&#x2714;</span> Salvo';btn.disabled=true;
        haptic([50,30,50]);
      };reader.readAsDataURL(file);
    };input.click();
  }
}

// ═══ CONTACT REQUESTS ═══
function openContactMenu(){
  const area=$('contactRequestArea');
  if(area.innerHTML){area.innerHTML='';return}
  const types=[
    {id:'instagram',emoji:'📸',label:'Instagram'},
    {id:'whatsapp',emoji:'💬',label:'WhatsApp'},
    {id:'x',emoji:'𝕏',label:'X / Twitter'},
    {id:'email',emoji:'📧',label:'Email'},
    {id:'foto',emoji:'📷',label:'Foto'}
  ];
  let html='<div class="contact-menu">';
  types.forEach(t=>{
    html+='<button type="button" class="contact-opt" onclick="requestContact(\''+t.id+'\')">'+t.emoji+' '+t.label+'</button>';
  });
  html+='</div>';
  area.innerHTML=html;
}
async function requestContact(type){
  if(!state.currentRelation)return;
  $('contactRequestArea').innerHTML='';
  try{
    await fetch('/api/request-contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId:state.currentRelation.relationId,fromUserId:state.userId,contactType:type})});
    showToast('Pedido enviado!');haptic([50]);
  }catch(e){showToast('Erro.')}
}
function showContactRequest(data){
  const area=$('contactRequestArea');
  const labels={instagram:'Instagram',whatsapp:'WhatsApp',x:'X / Twitter',email:'Email',foto:'Foto'};
  const emojis={instagram:'📸',whatsapp:'💬',x:'𝕏',email:'📧',foto:'📷'};
  let html='<div class="contact-req-banner" id="contactReq-'+data.requestId+'">';
  html+='<div class="contact-req-text">'+esc(data.from.name)+' quer seu <strong>'+emojis[data.contactType]+' '+(labels[data.contactType]||data.contactType)+'</strong></div>';
  if(data.contactType!=='foto'){
    html+='<input class="contact-req-input" id="contactVal-'+data.requestId+'" placeholder="Seu '+(labels[data.contactType]||'')+'">';
  }
  html+='<div class="contact-req-actions">';
  html+='<button type="button" class="addr-btn accept" onclick="respondContact(\''+data.requestId+'\',\''+data.relationId+'\',\''+data.contactType+'\',true)">Compartilhar</button>';
  html+='<button type="button" class="addr-btn decline" onclick="respondContact(\''+data.requestId+'\',\''+data.relationId+'\',\''+data.contactType+'\',false)">Não</button>';
  html+='</div></div>';
  area.innerHTML+=html;
}
async function respondContact(reqId,relationId,contactType,accepted){
  const valEl=$('contactVal-'+reqId);
  const value=valEl?valEl.value.trim():'';
  if(accepted&&contactType!=='foto'&&!value)return showToast('Preencha o campo.');
  try{
    await fetch('/api/respond-contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId,toUserId:state.userId,contactType,accepted,value:accepted?value:null})});
    const el=$('contactReq-'+reqId);if(el)el.remove();
    showToast(accepted?'Compartilhado!':'Recusado.');
  }catch(e){showToast('Erro.')}
}

// ═══ ENCOSTA REQUEST (digital - needs acceptance) ═══
function showEncostaRequest(data){
  const area=$('encostaReqArea');
  const color=data.from.color||nickColor(data.from.name||'??');
  let html='<div class="encosta-req-banner" id="encostaReq-'+data.requestId+'">';
  html+='<div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem">'+makeAvatar(data.from.name,color,38);
  html+='<div><div class="encosta-req-title">'+esc(data.from.name)+' quer conectar</div>';
  html+='<div class="encosta-req-sub">📍 '+esc(data.eventName)+'</div></div></div>';
  html+='<div class="encosta-req-actions">';
  html+='<button type="button" class="bp" style="flex:1;font-size:.82rem" onclick="acceptEncostaReq(\''+data.requestId+'\',\''+data.eventId+'\',\''+data.from.id+'\',true)">Aceitar</button>';
  html+='<button type="button" class="bs" style="flex:1;font-size:.82rem" onclick="acceptEncostaReq(\''+data.requestId+'\',\''+data.eventId+'\',\''+data.from.id+'\',false)">Recusar</button>';
  html+='</div></div>';
  area.innerHTML=html;
  haptic([100,50,100]);playSound('receive');
}
async function acceptEncostaReq(reqId,eventId,fromUserId,accepted){
  const el=$('encostaReq-'+reqId);if(el)el.remove();
  if(!accepted){
    try{await fetch('/api/event/encosta-accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,eventId,fromUserId,accepted:false})})}catch(e){}
    showToast('Recusado.');return;
  }
  try{
    const r=await fetch('/api/event/encosta-accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,eventId,fromUserId,accepted:true})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([80,40,80,40,80]);playSound('connect');
    state.currentRelation=d;
    const partner=(d.userA.id===state.userId)?d.userB:d.userA;
    state.currentPartnerId=partner.id;
    showScreen('encounter');showPhase('phaseReveal');
    doReveal(d);
  }catch(e){showToast('Erro ao conectar.')}
}

// ═══ LOCATION / EVENTS ═══
let locWatchId=null,myLat=null,myLng=null,locTab='nearby';
function openLocationScreen(){
  showScreen('locationScreen');
  $('locStatus').className='loc-status';
  $('locStatus').innerHTML='&#x1F50D; '+i18n('loc_searching');
  $('locContent').innerHTML='';
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      myLat=pos.coords.latitude;myLng=pos.coords.longitude;
      onLocationReady('gps');
      if(locWatchId)navigator.geolocation.clearWatch(locWatchId);
      locWatchId=navigator.geolocation.watchPosition(p=>{myLat=p.coords.latitude;myLng=p.coords.longitude;updateLocationOnServer()},{},{enableHighAccuracy:true,maximumAge:30000});
    },()=>fetchApproxLocation(),{enableHighAccuracy:true,timeout:8000});
  }else fetchApproxLocation();
}
function fetchApproxLocation(){
  // Try multiple IP geolocation services
  fetch('https://ipapi.co/json/',{signal:AbortSignal.timeout(5000)}).then(r=>r.json()).then(d=>{
    if(d.latitude&&d.longitude){myLat=d.latitude;myLng=d.longitude;onLocationReady('approx')}
    else return Promise.reject();
  }).catch(()=>{
    // Fallback: ip-api.com
    fetch('http://ip-api.com/json/?fields=lat,lon',{signal:AbortSignal.timeout(5000)}).then(r=>r.json()).then(d=>{
      if(d.lat&&d.lon){myLat=d.lat;myLng=d.lon;onLocationReady('approx')}
      else onLocationFail();
    }).catch(()=>onLocationFail());
  });
}
function onLocationReady(mode){
  $('locStatus').className='loc-status active';
  $('locStatus').innerHTML=mode==='gps'?'&#x1F4CD; '+i18n('loc_active'):'&#x1F4CD; Localização aproximada (via rede)';
  updateLocationOnServer();
  loadLocTab();
}
function onLocationFail(){
  $('locStatus').className='loc-status error';
  $('locStatus').innerHTML='&#x1F6AB; GPS indisponível';
  let html='<div class="loc-empty"><div class="loc-empty-icon">&#x1F4CD;</div>';
  html+='Sem localização disponível.<br><small style="color:var(--t3)">No notebook o GPS pode não funcionar.<br>No celular com HTTPS funcionará.</small>';
  html+='<br><br><button type="button" class="bp" style="font-size:.8rem;max-width:240px;margin:0 auto" onclick="showCreateEventManual()">&#x1F4CD; Criar evento manualmente</button>';
  html+='</div>';
  $('locContent').innerHTML=html;
}
async function updateLocationOnServer(){
  if(!myLat||!state.userId)return;
  try{await fetch('/api/location/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,lat:myLat,lng:myLng})})}catch(e){}
}
function switchLocTab(tab){
  locTab=tab;
  $('tabNearby').classList.toggle('active',tab==='nearby');
  $('tabEvents').classList.toggle('active',tab==='events');
  loadLocTab();
}
function loadLocTab(){if(locTab==='nearby')loadNearbyPeople();else loadNearbyEvents()}
async function loadNearbyPeople(){
  const c=$('locContent');
  if(!myLat){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3)">'+i18n('loc_activate')+'</div>';return}
  c.innerHTML='<div style="text-align:center;padding:1rem;color:var(--t3)">'+i18n('loc_loading')+'</div>';
  try{
    const r=await fetch('/api/nearby/'+state.userId+'?radius=1000');
    const people=await r.json();
    if(!people.length){c.innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x1F465;</div>'+i18n('loc_no_people')+'</div>';return}
    let html='';
    people.forEach(p=>{
      const color=p.color||nickColor(p.nickname||p.name||'??');
      const nick=p.nickname||p.name||'?';
      const dist=p.distance<1000?Math.round(p.distance)+'m':((p.distance/1000).toFixed(1))+'km';
      html+='<div class="loc-person">';
      html+=makeAvatar(nick,color,36);
      html+='<div class="loc-person-info"><div class="loc-person-nick">'+esc(nick)+'</div><div class="loc-person-dist">'+dist+'</div>';
      if(p.score||p.stars)html+='<div class="loc-person-pts">'+(p.score?'&#x26A1;'+p.score:'')+(p.stars?' ⭐'+p.stars:'')+'</div>';
      html+='</div>';
      html+='<button class="loc-encosta-btn" onclick="encostaFromLocation(\''+p.id+'\')">'+i18n('loc_encosta')+'</button>';
      html+='</div>';
    });
    c.innerHTML=html;
  }catch(e){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--err)">Erro ao buscar.</div>'}
}
async function loadNearbyEvents(){
  const c=$('locContent');
  if(!myLat){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3)">'+i18n('loc_activate')+'</div>';return}
  c.innerHTML='<div style="text-align:center;padding:1rem;color:var(--t3)">'+i18n('loc_loading')+'</div>';
  try{
    const r=await fetch('/api/events/nearby?lat='+myLat+'&lng='+myLng+'&radius=5000');
    const events=await r.json();
    if(!events.length){c.innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x1F389;</div>'+i18n('loc_no_events')+'<br><span style="font-size:.72rem;color:var(--ac);cursor:pointer" onclick="showCreateEvent()">'+i18n('create_event_btn')+'</span></div>';return}
    let html='';
    events.forEach(ev=>{
      const dist=ev.distance<1000?Math.round(ev.distance)+'m':((ev.distance/1000).toFixed(1))+'km';
      html+='<div class="evt-card" onclick="openEventDetail(\''+ev.id+'\')">';
      html+='<div class="evt-card-name">'+esc(ev.name)+'</div>';
      html+='<div class="evt-card-meta"><span>📍 '+dist+'</span><span>'+esc(ev.participantCount||0)+' '+i18n('evt_people')+'</span></div>';
      if(ev.description)html+='<div class="evt-card-desc">'+esc(ev.description)+'</div>';
      html+='</div>';
    });
    c.innerHTML=html;
  }catch(e){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--err)">Erro ao buscar.</div>'}
}
function showCreateEvent(){
  _renderEventForm(!!myLat);
}
function showCreateEventManual(){
  _renderEventForm(false);
}
function _renderEventForm(hasLocation){
  let html='<div class="loc-create-form">';
  html+='<div class="form-title">&#x1F4CD; '+i18n('create_event_title')+'</div>';
  html+='<div class="form-sub">Crie um ponto de encontro digital em um local físico. Quem estiver por perto poderá entrar e se conectar.</div>';
  html+='<div class="loc-fg"><label>'+i18n('evt_name')+'</label><input type="text" id="evtName" maxlength="60" placeholder="'+i18n('evt_name_ph')+'"></div>';
  html+='<div class="loc-fg"><label>'+i18n('evt_desc')+'</label><textarea id="evtDesc" maxlength="200" placeholder="'+i18n('evt_desc_ph')+'"></textarea></div>';
  if(!hasLocation){
    html+='<div class="loc-fg"><label>Latitude</label><input type="text" id="evtLat" placeholder="-23.550520"></div>';
    html+='<div class="loc-fg"><label>Longitude</label><input type="text" id="evtLng" placeholder="-46.633308"></div>';
    html+='<div style="font-size:.62rem;color:var(--t3);margin:-.4rem 0 .6rem;line-height:1.4">Dica: busque no Google Maps, clique no local e copie as coordenadas.</div>';
  }
  html+='<div class="loc-fg"><label>&#x1F4E1; '+i18n('evt_radius')+'</label>';
  html+='<div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.3rem">';
  ['50','100','200','500','1000'].forEach(r=>{
    const sel=r==='200'?'background:var(--ac);color:#fff;border-color:var(--ac)':'';
    html+='<button type="button" class="bs radius-opt" style="font-size:.68rem;padding:.3rem .6rem;'+sel+'" onclick="selectRadius(this,'+r+')">'+r+'m</button>';
  });
  html+='</div><input type="hidden" id="evtRadius" value="200"></div>';
  html+='<div style="display:flex;gap:.6rem;margin-top:.3rem"><button type="button" class="bp" style="flex:1" onclick="createEvent()">'+i18n('evt_create')+'</button><button type="button" class="bs" style="flex:1" onclick="loadLocTab()">'+i18n('evt_cancel')+'</button></div>';
  html+='</div>';
  $('locContent').innerHTML=html;
  setTimeout(()=>{const n=$('evtName');if(n)n.focus()},100);
}
function selectRadius(btn,val){
  document.querySelectorAll('.radius-opt').forEach(b=>{b.style.background='';b.style.color='';b.style.borderColor=''});
  btn.style.background='var(--ac)';btn.style.color='#fff';btn.style.borderColor='var(--ac)';
  $('evtRadius').value=val;
}
async function createEvent(){
  const name=$('evtName')?$('evtName').value.trim():'';
  const desc=$('evtDesc')?$('evtDesc').value.trim():'';
  const radius=parseInt($('evtRadius')?$('evtRadius').value:'200')||200;
  if(!name||name.length<3)return showToast(i18n('evt_name_err'));
  // Use GPS coords or manual input
  let lat=myLat,lng=myLng;
  if($('evtLat')){lat=parseFloat($('evtLat').value);lng=parseFloat($('evtLng').value)}
  if(!lat||!lng||isNaN(lat)||isNaN(lng))return showToast('Coordenadas inválidas.');
  try{
    const r=await fetch('/api/event/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,name,description:desc,lat,lng,radius})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast(i18n('evt_created'));haptic([50,30,50]);
    const evtId=d.event?d.event.id:d.id;
    openEventDetail(evtId);
  }catch(e){showToast('Erro ao criar evento.')}
}
async function openEventDetail(eventId){
  showScreen('eventDetail');
  $('evtDetailScroll').innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x23F3;</div>'+i18n('loc_loading')+'</div>';
  try{
    const r=await fetch('/api/event/'+eventId);
    const ev=await r.json();
    if(ev.error){showToast(ev.error);return}
    $('evtDetailTitle').textContent=ev.name;
    const parts=ev.participantsData||ev.participants||[];
    const alreadyIn=parts.some(p=>p.id===state.userId);
    const pCount=parts.length;
    let html='<div class="evt-detail">';
    html+='<div class="evt-detail-name">'+esc(ev.name)+'</div>';
    if(ev.description)html+='<div class="evt-detail-desc">"'+esc(ev.description)+'"</div>';
    html+='<div style="display:flex;gap:.6rem;align-items:center;font-size:.68rem;color:var(--t3);margin-bottom:.8rem">';
    html+='<span>&#x1F4E1; '+ev.radius+'m</span>';
    html+='<span>&#x1F465; '+pCount+' '+i18n('evt_people')+'</span>';
    html+='</div>';
    if(!alreadyIn){
      html+='<button class="bp" style="font-size:.82rem" onclick="joinEvent(\''+eventId+'\')">&#x1F91D; '+i18n('evt_join')+'</button>';
    }else{
      html+='<div style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;color:var(--ok);padding:.5rem .7rem;background:rgba(52,211,153,.06);border-radius:10px;border:1px solid rgba(52,211,153,.15)">&#x2714; '+i18n('evt_joined')+'</div>';
    }
    html+='</div>';
    html+='<div class="evt-ppl-title">'+i18n('evt_participants')+' ('+pCount+')</div>';
    if(pCount>0){
      parts.forEach(p=>{
        const color=p.color||nickColor(p.nickname||p.name||'??');
        const nick=p.nickname||p.name||'?';
        const isMe=p.id===state.userId;
        html+='<div class="loc-person">';
        html+=makeAvatar(nick,color,34);
        html+='<div class="loc-person-info"><div class="loc-person-nick">'+esc(nick)+(isMe?' <span style="font-size:.62rem;color:var(--ok)">('+i18n('evt_you')+')</span>':'')+'</div></div>';
        if(!isMe&&alreadyIn)html+='<button class="loc-encosta-btn" onclick="encostaAtEvent(\''+eventId+'\',\''+esc(nick)+'\')">'+i18n('loc_encosta')+'</button>';
        html+='</div>';
      });
    }else html+='<div class="loc-empty"><div class="loc-empty-icon">&#x1F3C3;</div>'+i18n('evt_nobody')+'</div>';
    $('evtDetailScroll').innerHTML=html;
  }catch(e){$('evtDetailScroll').innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x26A0;</div>Erro ao carregar evento.</div>'}
}
async function joinEvent(eventId){
  try{
    const r=await fetch('/api/event/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId,userId:state.userId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast(i18n('evt_joined_msg'));haptic([50,30,50]);
    openEventDetail(eventId);
  }catch(e){showToast('Erro.')}
}
async function encostaAtEvent(eventId,partnerNick){
  try{
    const r=await fetch('/api/event/encosta-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId,userId:state.userId,targetNickname:partnerNick})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Pedido enviado! Aguardando aceite...');haptic([50,30,50]);
  }catch(e){showToast('Erro ao conectar.')}
}
async function encostaFromLocation(targetId){
  // Start encounter via proximity - create a session and auto-match
  try{
    const r=await fetch('/api/session/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    // now the target joins
    const r2=await fetch('/api/session/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:d.code,userId:targetId})});
    const d2=await r2.json();
    if(d2.error)return showToast(d2.error);
    showToast(i18n('evt_encosta_ok'));haptic([80,40,80,40,80]);
    goHome();refreshHome();
  }catch(e){showToast('Erro ao encostar.')}
}

// ═══ i18n ═══
const LANG={
pt:{
  loc_btn:'Localização',ticket_btn:'Meu Bilhete',loc_title:'Explorar ao redor',
  create_event_btn:'+ Evento',loc_activate:'Ative sua localização para descobrir pessoas e eventos.',
  loc_searching:'Buscando localização...',loc_active:'📍 Localização ativa',
  loc_denied:'Localização negada. Permita no navegador.',tab_nearby:'Pessoas',tab_events:'Eventos',
  loc_loading:'Carregando...',loc_no_people:'Ninguém por perto no momento.',
  loc_no_events:'Nenhum evento por perto.',loc_encosta:'Encostar',loc_need_gps:'Ative o GPS primeiro.',
  create_event_title:'Criar um evento',evt_name:'Nome',evt_name_ph:'Ex: Café no centro',
  evt_desc:'Descrição',evt_desc_ph:'Opcional...',evt_radius:'Raio',evt_create:'Criar',evt_cancel:'Cancelar',
  evt_name_err:'Nome precisa ter pelo menos 3 caracteres.',evt_created:'Evento criado!',
  evt_join:'Entrar neste evento',evt_joined:'Você está aqui',evt_joined_msg:'Você entrou no evento!',
  evt_participants:'Participantes',evt_you:'você',evt_nobody:'Ninguém ainda. Seja o primeiro!',
  evt_people:'pessoas',evt_encosta_ok:'Encostou! Nova conexão criada.',
  // Home
  brand_name:'ENCOSTA',brand_tag:'tudo nasce no gesto',
  home_greeting:'Olá',home_motto:'Nada acontece<br>à distância.',home_btn:'ENCOSTAR',
  home_footer:'Encostar cria algo. Não encostar faz sumir.',
  sonic_searching:'Emitindo som ultrassônico...',sonic_approach:'Aproxime os celulares...',sonic_fallback:'Aproxime os celulares ou use código',
  // Register
  reg_title:'ENCOSTA',reg_sub:'crie sua presença',reg_nick_hint:'escolha seu nickname',
  reg_nick:'Nickname',reg_birth:'Data de nascimento',
  reg_terms:'Entendo e aceito que <strong>todas as relações aqui são temporárias</strong>. Nada persiste sem encontro.',
  reg_btn:'ENTRAR',
  // Encounter
  enc_how:'Como vão se encontrar?',enc_create:'Criar encontro',enc_join:'Entrar com código',
  enc_share:'Compartilhe esse código:',enc_waiting:'Esperando alguém encostar...',
  enc_code_ph:'CÓDIGO',enc_join_btn:'ENCOSTAR',
  // Reveal
  rev_phrase:'Uma frase para começar:',
  // Chat
  chat_msg_ph:'Diga algo que valha 24h...',chat_expired:'Esta conexão expirou.',
  // Profile
  pf_decl:'Declarações',pf_gifts:'Presentes recebidos',pf_empty_decl:'Nenhuma declaração ainda.',
  pf_empty_gift:'Nenhum presente ainda.',
  // Gift
  gift_title:'Escolha um presente',gift_msg_ph:'Mensagem (opcional)',gift_send:'Enviar presente',
  gift_needs_addr:'Requer endereço (pediremos permissão)',gift_sent:'Presente enviado!',
  // Decl
  decl_title:'Declaração',decl_sub:'Escreva algo para ficar no perfil dessa pessoa. Todos que se conectarem a ela poderão ler.',
  decl_ph:'Escreva sua declaração...',decl_publish:'Publicar',decl_min:'Escreva pelo menos 3 caracteres.',
  decl_ok:'Declaração publicada!',
  // Boarding
  bp_title:'Bilhete ENCOSTA',bp_encounters:'encontros',bp_since:'desde',bp_save:'Salvar Imagem',
  // History
  hist_title:'Constelação',hist_empty:'Nenhum encontro ainda.',hist_save:'Salvar',hist_share:'Compartilhar'
},
en:{
  loc_btn:'Location',ticket_btn:'My Ticket',loc_title:'Explore nearby',
  create_event_btn:'+ Event',loc_activate:'Enable your location to discover people and events.',
  loc_searching:'Searching location...',loc_active:'📍 Location active',
  loc_denied:'Location denied. Allow in browser.',tab_nearby:'People',tab_events:'Events',
  loc_loading:'Loading...',loc_no_people:'Nobody nearby right now.',
  loc_no_events:'No events nearby.',loc_encosta:'Touch',loc_need_gps:'Enable GPS first.',
  create_event_title:'Create an event',evt_name:'Name',evt_name_ph:'E.g.: Coffee downtown',
  evt_desc:'Description',evt_desc_ph:'Optional...',evt_radius:'Radius',evt_create:'Create',evt_cancel:'Cancel',
  evt_name_err:'Name must be at least 3 characters.',evt_created:'Event created!',
  evt_join:'Join this event',evt_joined:'You are here',evt_joined_msg:'You joined the event!',
  evt_participants:'Participants',evt_you:'you',evt_nobody:'Nobody yet. Be the first!',
  evt_people:'people',evt_encosta_ok:'Touched! New connection created.',
  brand_name:'LEAN IN',brand_tag:'it all starts with a gesture',
  home_greeting:'Hello',home_motto:'Nothing happens<br>from a distance.',home_btn:'TOUCH',
  home_footer:'Touching creates something. Not touching makes it vanish.',
  sonic_searching:'Emitting ultrasonic sound...',sonic_approach:'Bring phones closer...',sonic_fallback:'Bring phones closer or use code',
  reg_title:'ENCOSTA',reg_sub:'create your presence',reg_nick_hint:'choose your nickname',
  reg_nick:'Nickname',reg_birth:'Date of birth',
  reg_terms:'I understand and accept that <strong>all relationships here are temporary</strong>. Nothing persists without encounter.',
  reg_btn:'ENTER',
  enc_how:'How will you meet?',enc_create:'Create encounter',enc_join:'Join with code',
  enc_share:'Share this code:',enc_waiting:'Waiting for someone to touch...',
  enc_code_ph:'CODE',enc_join_btn:'TOUCH',
  rev_phrase:'A phrase to begin:',
  chat_msg_ph:'Say something worth 24h...',chat_expired:'This connection has expired.',
  pf_decl:'Declarations',pf_gifts:'Gifts received',pf_empty_decl:'No declarations yet.',
  pf_empty_gift:'No gifts yet.',
  gift_title:'Choose a gift',gift_msg_ph:'Message (optional)',gift_send:'Send gift',
  gift_needs_addr:'Requires address (we\'ll ask permission)',gift_sent:'Gift sent!',
  decl_title:'Declaration',decl_sub:'Write something for this person\'s profile. Everyone who connects with them can read it.',
  decl_ph:'Write your declaration...',decl_publish:'Publish',decl_min:'Write at least 3 characters.',
  decl_ok:'Declaration published!',
  bp_title:'ENCOSTA Ticket',bp_encounters:'encounters',bp_since:'since',bp_save:'Save Image',
  hist_title:'Constellation',hist_empty:'No encounters yet.',hist_save:'Save',hist_share:'Share'
},
es:{
  loc_btn:'Ubicación',ticket_btn:'Mi Boleto',loc_title:'Explorar alrededor',
  create_event_btn:'+ Evento',loc_activate:'Activa tu ubicación para descubrir personas y eventos.',
  loc_searching:'Buscando ubicación...',loc_active:'📍 Ubicación activa',
  loc_denied:'Ubicación denegada. Permite en el navegador.',tab_nearby:'Personas',tab_events:'Eventos',
  loc_loading:'Cargando...',loc_no_people:'Nadie cerca por ahora.',
  loc_no_events:'No hay eventos cerca.',loc_encosta:'Tocar',loc_need_gps:'Activa el GPS primero.',
  create_event_title:'Crear un evento',evt_name:'Nombre',evt_name_ph:'Ej: Café en el centro',
  evt_desc:'Descripción',evt_desc_ph:'Opcional...',evt_radius:'Radio',evt_create:'Crear',evt_cancel:'Cancelar',
  evt_name_err:'El nombre debe tener al menos 3 caracteres.',evt_created:'¡Evento creado!',
  evt_join:'Unirse a este evento',evt_joined:'Estás aquí',evt_joined_msg:'¡Te uniste al evento!',
  evt_participants:'Participantes',evt_you:'tú',evt_nobody:'Nadie aún. ¡Sé el primero!',
  evt_people:'personas',evt_encosta_ok:'¡Tocó! Nueva conexión creada.',
  brand_name:'ACÉRCATE',brand_tag:'todo nace en el gesto',
  home_greeting:'Hola',home_motto:'Nada pasa<br>a distancia.',home_btn:'TOCAR',
  home_footer:'Tocar crea algo. No tocar lo hace desaparecer.',
  sonic_searching:'Emitiendo sonido ultrasónico...',sonic_approach:'Acerquen los celulares...',sonic_fallback:'Acerquen los celulares o usen código',
  reg_title:'ENCOSTA',reg_sub:'crea tu presencia',reg_nick_hint:'elige tu nickname',
  reg_nick:'Nickname',reg_birth:'Fecha de nacimiento',
  reg_terms:'Entiendo y acepto que <strong>todas las relaciones aquí son temporales</strong>. Nada persiste sin encuentro.',
  reg_btn:'ENTRAR',
  enc_how:'¿Cómo se van a encontrar?',enc_create:'Crear encuentro',enc_join:'Entrar con código',
  enc_share:'Comparte este código:',enc_waiting:'Esperando que alguien toque...',
  enc_code_ph:'CÓDIGO',enc_join_btn:'TOCAR',
  rev_phrase:'Una frase para empezar:',
  chat_msg_ph:'Di algo que valga 24h...',chat_expired:'Esta conexión expiró.',
  pf_decl:'Declaraciones',pf_gifts:'Regalos recibidos',pf_empty_decl:'Sin declaraciones aún.',
  pf_empty_gift:'Sin regalos aún.',
  gift_title:'Elige un regalo',gift_msg_ph:'Mensaje (opcional)',gift_send:'Enviar regalo',
  gift_needs_addr:'Requiere dirección (pediremos permiso)',gift_sent:'¡Regalo enviado!',
  decl_title:'Declaración',decl_sub:'Escribe algo para el perfil de esta persona. Todos los que se conecten con ella podrán leerlo.',
  decl_ph:'Escribe tu declaración...',decl_publish:'Publicar',decl_min:'Escribe al menos 3 caracteres.',
  decl_ok:'¡Declaración publicada!',
  bp_title:'Boleto ENCOSTA',bp_encounters:'encuentros',bp_since:'desde',bp_save:'Guardar Imagen',
  hist_title:'Constelación',hist_empty:'Sin encuentros aún.',hist_save:'Guardar',hist_share:'Compartir'
}
};
let currentLang=localStorage.getItem('encosta_lang')||'pt';
function i18n(key){return (LANG[currentLang]&&LANG[currentLang][key])||LANG.pt[key]||key}
function setLang(lang){
  currentLang=lang;
  localStorage.setItem('encosta_lang',lang);
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active',b.textContent.trim().toLowerCase()===lang));
  applyLang();
}
function applyLang(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.getAttribute('data-i18n');
    const val=i18n(key);
    if(val)el.innerHTML=val;
  });
  // Update dynamic elements
  const brand=$('homeBrand');if(brand)brand.textContent=i18n('brand_name');
  const btnText=$('mainBtnText');if(btnText&&!homeSonicActive)btnText.textContent=i18n('home_btn');
}

// ═══ EVENTS ═══
$('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();sendMessage()}});
$('chatInput').addEventListener('input',()=>{handleTyping();updateSendBtn()});
$('chatInput').addEventListener('focus',()=>closePlusMenu());
document.addEventListener('click',e=>{const pm=$('plusMenu');if(pm&&pm.classList.contains('open')&&!pm.contains(e.target)&&!e.target.closest('.cia-plus'))closePlusMenu()});
$('joinCodeInput').addEventListener('keydown',e=>{if(e.key==='Enter')joinSession()});
if(window.visualViewport){let ph=window.visualViewport.height;window.visualViewport.addEventListener('resize',()=>{if($('chat').classList.contains('active')&&window.visualViewport.height<ph)requestAnimationFrame(()=>{$('chatMessages').scrollTop=99999});ph=window.visualViewport.height})}

// ═══ RESOURCE CLEANUP + SCREENSHOT PROTECTION ═══
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){
    // Release mic, speaker, camera when app goes to background
    releaseAllMedia();
    // Blur chat for screenshot protection
    if($('chat').classList.contains('active'))$('chatMessages').style.filter='blur(20px)';
  }else{
    $('chatMessages').style.filter='';
  }
});
// Also cleanup on page close/navigate away
window.addEventListener('beforeunload',()=>releaseAllMedia());
window.addEventListener('pagehide',()=>releaseAllMedia());
// Block keyboard screenshot shortcuts (partial - won't work on all platforms)
document.addEventListener('keyup',e=>{
  if(e.key==='PrintScreen'&&$('chat').classList.contains('active')){
    $('chatMessages').style.filter='blur(20px)';
    showToast('Screenshots não permitidos no chat.');
    setTimeout(()=>{$('chatMessages').style.filter=''},1500);
  }
});

// ═══ INIT ═══
async function validateUser(){
  if(!state.userId)return false;
  try{
    const r=await fetch('/api/user/'+state.userId);
    if(!r.ok){localStorage.removeItem('encosta_userId');localStorage.removeItem('encosta_userName');state.userId=null;state.userName=null;return false}
    return true;
  }catch(e){return false}
}
window.addEventListener('load',()=>{
  applyLang();
  const qr=new URLSearchParams(location.search).get('code');
  setTimeout(async()=>{
    if(state.userId&&await validateUser()){
      initSocket();
      // Set home avatar
      const _ha=$('homeAvatar');if(_ha&&state.userName){_ha.textContent=(state.userName||'??').slice(0,2).toUpperCase();_ha.style.background=state.userColor||nickColor(state.userName)}
      if(qr){showScreen('home');$('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(state.userName)+'</span>';setTimeout(()=>{$('joinCodeInput').value=qr;showScreen('encounter');showPhase('phaseChoose');joinSession();history.replaceState({},'','/')},300)}
      else{showScreen('home');$('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(state.userName)+'</span>'}
      refreshHome();
    }else{
      // Show onboarding for first-time users, register for returning
      if(!localStorage.getItem('encosta_onboarded')){
        initOnboarding();
        showScreen('onboarding');
      }else{
        showScreen('register');
      }
    }
  },1800);
});
</script>
</body>
</html>
