<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Touch? ‚Äî Painel Operacional</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#050508;--s1:#12121a;--s2:#1a1a24;--s3:#24243a;--t1:#f5f5f7;--t2:#a0a0b8;--t3:#666680;--ac:#6366f1;--ok:#34d399;--b1:rgba(255,255,255,.06);--b2:rgba(255,255,255,.1)}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;overflow:hidden}

/* Header */
.op-header{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1.2rem;background:rgba(18,18,26,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--b1);z-index:10;position:relative}
.op-logo{font-size:.85rem;font-weight:700;letter-spacing:.08em;color:var(--t1)}
.op-logo span{color:var(--ac)}
.op-stats{display:flex;gap:1rem;align-items:center;font-size:.72rem;color:var(--t2)}
.op-stat-num{font-weight:700;color:var(--ok);font-size:1rem}
.op-user{font-size:.68rem;color:var(--t3)}

/* Login screen */
.op-login{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;z-index:20;background:var(--bg)}
.op-login h1{font-size:1.5rem;font-weight:700;letter-spacing:.06em}
.op-login h1 span{color:var(--ac)}
.op-login-sub{font-size:.75rem;color:var(--t3);max-width:280px;text-align:center;line-height:1.6}
.op-login-btn{padding:.8rem 2rem;background:var(--ac);border:none;border-radius:14px;color:#fff;font-size:.85rem;font-weight:600;font-family:inherit;cursor:pointer;letter-spacing:.04em}

/* Main layout */
.op-main{display:flex;height:calc(100vh - 52px);position:relative}
.op-canvas-area{flex:1;position:relative;overflow:hidden}
.op-sidebar{width:320px;background:rgba(18,18,26,.95);backdrop-filter:blur(20px);border-left:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden}
@media(max-width:768px){
  .op-sidebar{position:absolute;bottom:0;left:0;right:0;width:100%;height:45vh;border-left:none;border-top:1px solid var(--b1);border-radius:20px 20px 0 0}
  .op-canvas-area{height:55vh}
}

/* Canvas */
#opCanvas{width:100%;height:100%;display:block}

/* Touch button (floating) */
.op-touch-wrap{position:absolute;bottom:2rem;left:50%;transform:translateX(-50%);z-index:5;display:flex;flex-direction:column;align-items:center;gap:.5rem}
.op-touch-btn{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,var(--ac),#8b5cf6);border:3px solid rgba(255,255,255,.15);color:#fff;font-size:.7rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.1em;display:flex;align-items:center;justify-content:center;box-shadow:0 0 30px rgba(99,102,241,.4);transition:.15s;position:relative}
.op-touch-btn:active{transform:scale(.92)}
.op-touch-btn.waiting{animation:op-pulse 2s ease infinite}
.op-touch-status{font-size:.62rem;color:var(--t3);text-align:center}
.op-code{font-size:1.1rem;font-weight:700;color:var(--ac);letter-spacing:.15em}
@keyframes op-pulse{0%,100%{box-shadow:0 0 30px rgba(99,102,241,.4)}50%{box-shadow:0 0 50px rgba(99,102,241,.7)}}

/* Sidebar */
.op-sb-header{padding:.8rem 1rem;border-bottom:1px solid var(--b1);font-size:.72rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;font-weight:600;display:flex;justify-content:space-between}
.op-sb-list{flex:1;overflow-y:auto;padding:.5rem}
.op-checkin-item{display:flex;align-items:center;gap:.7rem;padding:.6rem .5rem;border-bottom:1px solid rgba(255,255,255,.03);animation:op-slide-in .4s ease}
@keyframes op-slide-in{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.op-ci-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;color:#fff;flex-shrink:0}
.op-ci-info{flex:1;min-width:0}
.op-ci-name{font-size:.78rem;font-weight:500;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.op-ci-time{font-size:.6rem;color:var(--t3)}
.op-ci-badge{font-size:.55rem;padding:.15rem .4rem;border-radius:6px;font-weight:600}
.op-ci-badge.revealed{background:rgba(52,211,153,.1);color:#34d399;border:1px solid rgba(52,211,153,.2)}
.op-ci-badge.anon{background:rgba(255,255,255,.04);color:var(--t3);border:1px solid var(--b1)}

/* Empty state */
.op-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:.8rem;color:var(--t3);padding:2rem}
.op-empty-ico{font-size:2.5rem;opacity:.4}
.op-empty-text{font-size:.72rem;text-align:center;line-height:1.6;max-width:220px}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="op-login" id="opLogin">
  <h1>Touch<span>?</span></h1>
  <div class="op-login-sub">Painel Operacional<br>Check-in em tempo real para eventos e estabelecimentos</div>
  <button class="op-login-btn" id="opLoginBtn" onclick="opDoLogin()">Entrar com Google</button>
</div>

<!-- MAIN -->
<div style="display:none" id="opApp">
  <div class="op-header">
    <div class="op-logo">Touch<span>?</span> Operador</div>
    <div class="op-stats">
      <div><span class="op-stat-num" id="opCount">0</span> check-ins</div>
      <div class="op-user" id="opUserName"></div>
    </div>
  </div>
  <div class="op-main">
    <div class="op-canvas-area">
      <canvas id="opCanvas"></canvas>
      <div class="op-touch-wrap">
        <button class="op-touch-btn" id="opTouchBtn" onclick="opStartTouch()">TOUCH</button>
        <div class="op-touch-status" id="opTouchStatus"></div>
        <div class="op-code hidden" id="opCode"></div>
      </div>
    </div>
    <div class="op-sidebar">
      <div class="op-sb-header"><span>Check-ins</span><span id="opListCount">0</span></div>
      <div class="op-sb-list" id="opList">
        <div class="op-empty" id="opEmpty">
          <div class="op-empty-ico">üì°</div>
          <div class="op-empty-text">Clique em TOUCH e aguarde as pessoas encostarem seus celulares</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let opState={userId:null,userName:null,userColor:null,socket:null,sessionId:null,checkins:[],nodes:[]};
let audioCtx=null;

// ‚ïê‚ïê‚ïê FIREBASE AUTH ‚ïê‚ïê‚ïê
(async function(){
  const r=await fetch('/api/firebase-config');
  const cfg=await r.json();
  firebase.initializeApp(cfg);
  firebase.auth().onAuthStateChanged(async user=>{
    if(user){
      opState.userId=user.uid;
      // Ensure user exists on server
      try{
        const ur=await fetch('/api/user/'+user.uid);
        const ud=await ur.json();
        opState.userName=ud.nickname||ud.name||user.displayName||'Operador';
        opState.userColor=ud.color||'#6366f1';
      }catch(e){
        opState.userName=user.displayName||'Operador';
        opState.userColor='#6366f1';
      }
      document.getElementById('opLogin').style.display='none';
      document.getElementById('opApp').style.display='';
      document.getElementById('opUserName').textContent=opState.userName;
      initSocket();
      initCanvas();
      loadExistingCheckins();
    }else{
      document.getElementById('opLogin').style.display='';
      document.getElementById('opApp').style.display='none';
    }
  });
})();

function opDoLogin(){
  const provider=new firebase.auth.GoogleAuthProvider();
  firebase.auth().signInWithPopup(provider).catch(e=>alert('Erro: '+e.message));
}

// ‚ïê‚ïê‚ïê SOCKET ‚ïê‚ïê‚ïê
function initSocket(){
  opState.socket=io({reconnection:true,reconnectionDelay:1000});
  opState.socket.on('connect',()=>{
    if(opState.userId)opState.socket.emit('identify',opState.userId);
  });
  opState.socket.on('checkin-created',d=>{
    addCheckin(d);
    playBeep();
  });
  opState.socket.on('relation-created',d=>{
    if(d.isCheckin){
      const other=d.userA.id===opState.userId?d.userB:d.userA;
      addCheckin({userId:other.id,nickname:other.name,color:other.color,profilePhoto:other.profilePhoto||other.photoURL,timestamp:Date.now()});
      playBeep();
    }
  });
}

// ‚ïê‚ïê‚ïê TOUCH SESSION ‚ïê‚ïê‚ïê
async function opStartTouch(){
  const btn=document.getElementById('opTouchBtn');
  const status=document.getElementById('opTouchStatus');
  const codeEl=document.getElementById('opCode');
  if(opState.sessionId){
    // Cancel
    opState.sessionId=null;
    btn.classList.remove('waiting');btn.textContent='TOUCH';
    status.textContent='';codeEl.classList.add('hidden');
    return;
  }
  try{
    const r=await fetch('/api/session/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:opState.userId,isCheckin:true})});
    const d=await r.json();
    opState.sessionId=d.sessionId;
    opState.socket.emit('join-session',d.sessionId);
    btn.classList.add('waiting');btn.textContent='‚è≥';
    status.textContent='Aguardando...';
    codeEl.textContent=d.code;codeEl.classList.remove('hidden');
    // Auto-create new session after 60s
    setTimeout(()=>{
      if(opState.sessionId===d.sessionId){
        opState.sessionId=null;
        btn.classList.remove('waiting');btn.textContent='TOUCH';
        status.textContent='Expirou ‚Äî toque novamente';codeEl.classList.add('hidden');
      }
    },60000);
  }catch(e){status.textContent='Erro ao criar sess√£o'}
}

// ‚ïê‚ïê‚ïê CHECK-INS ‚ïê‚ïê‚ïê
function addCheckin(d){
  opState.checkins.unshift(d);
  opState.sessionId=null; // reset for next touch
  const btn=document.getElementById('opTouchBtn');
  btn.classList.remove('waiting');btn.textContent='TOUCH';
  document.getElementById('opTouchStatus').textContent='‚úì '+d.nickname;
  document.getElementById('opCode').classList.add('hidden');
  // Update counter
  document.getElementById('opCount').textContent=opState.checkins.length;
  document.getElementById('opListCount').textContent=opState.checkins.length;
  // Add to sidebar
  document.getElementById('opEmpty').style.display='none';
  const list=document.getElementById('opList');
  const item=document.createElement('div');
  item.className='op-checkin-item';
  const time=new Date(d.timestamp);
  const timeStr=time.getHours().toString().padStart(2,'0')+':'+time.getMinutes().toString().padStart(2,'0');
  const color=d.color||nickColor(d.nickname||'?');
  item.innerHTML=
    '<div class="op-ci-avatar" style="background:'+color+'">'+initials(d.nickname||'?')+'</div>'+
    '<div class="op-ci-info"><div class="op-ci-name">'+esc(d.nickname||'Visitante')+'</div><div class="op-ci-time">'+timeStr+'</div></div>'+
    '<div class="op-ci-badge anon">check-in</div>';
  list.prepend(item);
  // Add node to canvas
  addCanvasNode(d);
  // Auto-create next session for continuous check-in
  setTimeout(()=>opStartTouch(),1500);
}

async function loadExistingCheckins(){
  try{
    const r=await fetch('/api/operator/checkins/'+opState.userId);
    const d=await r.json();
    if(d.checkins&&d.checkins.length>0){
      document.getElementById('opEmpty').style.display='none';
      d.checkins.forEach(c=>{
        opState.checkins.push(c);
        const list=document.getElementById('opList');
        const item=document.createElement('div');
        item.className='op-checkin-item';
        const time=new Date(c.timestamp);
        const timeStr=time.getHours().toString().padStart(2,'0')+':'+time.getMinutes().toString().padStart(2,'0');
        const color=c.withColor||nickColor(c.withName||'?');
        item.innerHTML=
          '<div class="op-ci-avatar" style="background:'+color+'">'+initials(c.withName||'?')+'</div>'+
          '<div class="op-ci-info"><div class="op-ci-name">'+esc(c.withName||'Visitante')+'</div><div class="op-ci-time">'+timeStr+'</div></div>'+
          '<div class="op-ci-badge '+(c.revealed?'revealed':'anon')+'">'+(c.revealed?'revelado':'check-in')+'</div>';
        list.appendChild(item);
        addCanvasNode({nickname:c.withName,color:c.withColor,timestamp:c.timestamp});
      });
      document.getElementById('opCount').textContent=opState.checkins.length;
      document.getElementById('opListCount').textContent=opState.checkins.length;
    }
  }catch(e){}
}

// ‚ïê‚ïê‚ïê CANVAS (Network Visualization) ‚ïê‚ïê‚ïê
let canvasCtx=null,canvasW=0,canvasH=0,canvasAnim=null;
const canvasNodes=[];

function initCanvas(){
  const cv=document.getElementById('opCanvas');
  const rect=cv.parentElement.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  canvasW=rect.width;canvasH=rect.height;
  cv.width=canvasW*dpr;cv.height=canvasH*dpr;
  cv.style.width=canvasW+'px';cv.style.height=canvasH+'px';
  canvasCtx=cv.getContext('2d');
  canvasCtx.scale(dpr,dpr);
  renderCanvas();
}

function addCanvasNode(d){
  const angle=Math.random()*Math.PI*2;
  const dist=60+Math.random()*Math.min(canvasW,canvasH)*0.3;
  canvasNodes.push({
    x:canvasW/2+Math.cos(angle)*dist,
    y:canvasH/2-80+Math.sin(angle)*dist,
    r:0,targetR:12+Math.random()*6,
    color:d.color||nickColor(d.nickname||'?'),
    name:d.nickname||'?',
    phase:Math.random()*Math.PI*2,
    born:Date.now()
  });
}

function renderCanvas(){
  const ctx=canvasCtx;
  if(!ctx)return;
  ctx.clearRect(0,0,canvasW,canvasH);
  const cx=canvasW/2,cy=canvasH/2-80;
  const t=Date.now()/1000;

  // Center node (operator)
  ctx.beginPath();
  ctx.arc(cx,cy,18,0,Math.PI*2);
  ctx.fillStyle=opState.userColor||'#6366f1';
  ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,.2)';ctx.lineWidth=2;ctx.stroke();
  // Initials
  ctx.fillStyle='#fff';ctx.font='600 10px Inter';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(initials(opState.userName||'OP'),cx,cy);

  // Nodes
  canvasNodes.forEach(n=>{
    // Animate radius
    if(n.r<n.targetR)n.r=Math.min(n.targetR,n.r+0.5);
    const pulse=1+Math.sin(t*1.5+n.phase)*0.06;
    const r=n.r*pulse;

    // Connection line
    ctx.beginPath();
    ctx.moveTo(cx,cy);ctx.lineTo(n.x,n.y);
    ctx.strokeStyle='rgba(255,255,255,.04)';ctx.lineWidth=1;ctx.stroke();

    // Glow
    const age=(Date.now()-n.born)/1000;
    if(age<2){
      const glow=ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,r*3);
      glow.addColorStop(0,n.color+'60');glow.addColorStop(1,n.color+'00');
      ctx.fillStyle=glow;ctx.beginPath();ctx.arc(n.x,n.y,r*3,0,Math.PI*2);ctx.fill();
    }

    // Node circle
    ctx.beginPath();ctx.arc(n.x,n.y,r,0,Math.PI*2);
    ctx.fillStyle=n.color;ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.15)';ctx.lineWidth=1;ctx.stroke();

    // Label
    ctx.fillStyle='#fff';ctx.font='500 7px Inter';ctx.textAlign='center';
    ctx.fillText(initials(n.name),n.x,n.y+2.5);
  });

  canvasAnim=requestAnimationFrame(renderCanvas);
}

window.addEventListener('resize',()=>{
  if(document.getElementById('opApp').style.display!=='none')initCanvas();
});

// ‚ïê‚ïê‚ïê AUDIO ‚ïê‚ïê‚ïê
function playBeep(){
  if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended')audioCtx.resume();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.connect(g);g.connect(audioCtx.destination);o.type='sine';
  const t=audioCtx.currentTime;
  o.frequency.setValueAtTime(523,t);o.frequency.linearRampToValueAtTime(659,t+0.1);o.frequency.linearRampToValueAtTime(784,t+0.2);
  g.gain.setValueAtTime(0.15,t);g.gain.linearRampToValueAtTime(0,t+0.4);
  o.start(t);o.stop(t+0.4);
}

// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function initials(name){if(!name)return'?';const parts=name.trim().split(/\s+/);return parts.length>1?(parts[0][0]+parts[1][0]).toUpperCase():name.slice(0,2).toUpperCase()}
function nickColor(name){let h=0;for(let i=0;i<name.length;i++)h=name.charCodeAt(i)+((h<<5)-h);return'hsl('+Math.abs(h%360)+',65%,45%)'}
</script>
</body>
</html>
