<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#050508">
<title>Touch? — tudo nasce no gesto</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
*::-webkit-scrollbar{width:3px}
*::-webkit-scrollbar-track{background:transparent}
*::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}
*::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.2)}
::selection{background:rgba(255,107,53,.3);color:#fff}
:root{
  --bg:#050508;--s1:#12121a;--s2:#1a1a24;--s3:#24243a;
  --b1:#2a2a3a;--b2:rgba(255,255,255,0.06);
  --t1:#f5f5f7;--t2:#8888a0;--t3:#555568;
  --ac:#ff6b35;--ac2:#ff8f65;--pk:#ff3d71;
  --gw:rgba(255,107,53,0.12);--gw2:rgba(255,107,53,0.25);
  --ok:#34d399;--warn:#fbbf24;--err:#f87171;
}
html,body{height:100%;width:100%;font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--t1);overflow:hidden;-webkit-font-smoothing:antialiased}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;visibility:hidden;opacity:0;transform:translateY(6px);transition:opacity .35s cubic-bezier(.22,1,.36,1),transform .35s cubic-bezier(.22,1,.36,1),visibility 0s .35s;pointer-events:none}
.screen.active{visibility:visible;opacity:1;transform:translateY(0);transition:opacity .35s cubic-bezier(.22,1,.36,1),transform .35s cubic-bezier(.22,1,.36,1),visibility 0s;pointer-events:auto}

/* SPLASH */
#splash{justify-content:center;align-items:center;background:radial-gradient(circle at 50% 50%,rgba(255,107,53,.03),transparent 60%)}
#splash .logo{font-size:2.8rem;font-weight:800;letter-spacing:.35em;color:var(--ac);animation:gp 2s ease-in-out infinite;opacity:0;animation:gp 2s ease-in-out infinite,splash-in .8s ease forwards}
#splash .tag{margin-top:1.2rem;font-size:.78rem;color:var(--t3);font-weight:300;letter-spacing:.2em;opacity:0;animation:splash-tag-in .8s ease .4s forwards}
@keyframes splash-in{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
@keyframes splash-tag-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes gp{0%,100%{text-shadow:0 0 20px var(--gw)}50%{text-shadow:0 0 50px var(--gw2),0 0 100px rgba(255,107,53,.08)}}

/* REGISTER */
#register{padding:2rem 1.5rem;overflow-y:auto}
.rh{text-align:center;margin-bottom:2rem;padding-top:env(safe-area-inset-top,1.5rem)}
.rh h1{font-size:1.8rem;font-weight:800;letter-spacing:.2em;color:var(--ac)}
.rh p{margin-top:.5rem;font-size:.8rem;color:var(--t2)}
.fg{margin-bottom:1.5rem}
.fg label{display:block;font-size:.7rem;color:var(--t2);text-transform:uppercase;letter-spacing:.12em;margin-bottom:.5rem;font-weight:600}
.fg input[type="text"],.fg input[type="date"]{width:100%;padding:.85rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;color:var(--t1);font-size:1rem;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s}
.fg input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.avs{display:flex;flex-direction:column;align-items:center;gap:.8rem;margin-bottom:1.5rem}
.avp{width:90px;height:90px;border-radius:50%;background:var(--s2);border:2px solid var(--b1);display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:800;color:#fff;overflow:hidden;letter-spacing:.05em;transition:all .3s}
.nick-hint{font-size:.7rem;color:var(--t3);transition:.3s}
.nick-hint.taken{color:var(--err)}.nick-hint.ok{color:var(--ok)}
.tc{display:flex;align-items:flex-start;gap:.8rem;margin-bottom:2rem;padding:1rem;background:var(--s1);border-radius:14px;border:1px solid var(--b1)}
.tc input[type="checkbox"]{width:20px;height:20px;margin-top:2px;accent-color:var(--ac);flex-shrink:0}
.tc span{font-size:.82rem;color:var(--t2);line-height:1.5}

/* BUTTONS */
.bp{width:100%;padding:.95rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:14px;color:#fff;font-size:.95rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.06em;transition:transform .15s cubic-bezier(.22,1,.36,1),box-shadow .2s,opacity .2s;box-shadow:0 4px 15px rgba(255,107,53,.3)}
.bp:active{transform:scale(.95)}.bp:disabled{opacity:.35;pointer-events:none}
.bs{padding:.65rem 1.4rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t2);font-size:.85rem;font-family:inherit;cursor:pointer;transition:transform .15s,background .15s}
.bs:active{transform:scale(.95);background:var(--s2)}

/* LOGIN SCREEN */
#login{padding:2rem 1.5rem;justify-content:center;align-items:center;gap:1.2rem;background:radial-gradient(ellipse at 50% 30%,rgba(255,107,53,.04),transparent 60%)}
.login-logo{font-size:2.4rem;font-weight:800;letter-spacing:.3em;color:var(--ac);margin-bottom:.3rem;text-shadow:0 0 40px rgba(255,107,53,.2)}
.login-sub{font-size:.78rem;color:var(--t2);margin-bottom:2rem;text-align:center;line-height:1.5}
.login-form{width:100%;max-width:340px;display:flex;flex-direction:column;gap:1rem}
.login-input{width:100%;padding:.85rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;color:var(--t1);font-size:.95rem;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s}
.login-input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.login-google{width:100%;max-width:340px;padding:.9rem;background:#fff;border:none;border-radius:14px;color:#333;font-size:.9rem;font-weight:600;font-family:inherit;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.6rem;transition:all .15s cubic-bezier(.22,1,.36,1);box-shadow:0 2px 12px rgba(0,0,0,.2)}
.login-google:active{transform:scale(.96);box-shadow:0 1px 6px rgba(0,0,0,.15)}
.login-google img{width:20px;height:20px}
.login-divider{display:flex;align-items:center;gap:1rem;width:100%;max-width:340px;color:var(--t3);font-size:.75rem}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--b1)}
.login-toggle{font-size:.82rem;color:var(--ac);cursor:pointer;text-align:center;margin-top:.5rem}
.login-err{font-size:.78rem;color:var(--err);text-align:center;min-height:1.1rem}
.login-nick-explain{font-size:.7rem;color:var(--t3);text-align:center;line-height:1.5;padding:0 .5rem;font-style:italic}
.reg-nick-info{font-size:.7rem;color:var(--ac2);background:rgba(255,107,53,.06);border:1px solid rgba(255,107,53,.12);border-radius:10px;padding:.6rem .8rem;margin:-.5rem 0 1.2rem;line-height:1.5;text-align:center}

/* PULL TO REFRESH */
.ptr-indicator{position:absolute;top:-50px;left:50%;transform:translateX(-50%);z-index:99;transition:top .3s ease;pointer-events:none}
.ptr-indicator.pulling{top:12px}
.ptr-indicator.refreshing{top:12px}
.ptr-spinner{width:28px;height:28px;border:2.5px solid rgba(255,255,255,.1);border-top-color:var(--ac);border-radius:50%;opacity:.5;transition:opacity .2s}
.ptr-indicator.pulling .ptr-spinner{opacity:1}
.ptr-indicator.refreshing .ptr-spinner{opacity:1;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* HOME */
#home{display:flex;flex-direction:column;align-items:center;height:100%;padding:0;position:relative;overflow:hidden}
#home::before{content:'';position:absolute;top:38%;left:50%;width:500px;height:500px;transform:translate(-50%,-50%);border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.05) 0%,rgba(255,61,113,.02) 40%,transparent 70%);pointer-events:none;z-index:0}
/* Top bar — clean header */
.home-top{display:flex;justify-content:space-between;align-items:center;width:100%;position:relative;z-index:2;flex-shrink:0;padding:max(env(safe-area-inset-top),.8rem) 1.2rem .6rem}
.home-user{display:flex;align-items:center;gap:.6rem;cursor:pointer;-webkit-tap-highlight-color:transparent}
.home-user:active{opacity:.7}
.home-avatar{width:40px;height:40px;border-radius:50%;background:var(--s2);border:2px solid var(--ac);display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:800;color:#fff;overflow:hidden;flex-shrink:0;box-shadow:0 0 12px rgba(255,107,53,.15);transition:transform .2s}
.home-user:active .home-avatar{transform:scale(.9)}
.home-user-info{display:flex;flex-direction:column;gap:.15rem}
.hg{font-size:1rem;color:var(--t1);font-weight:600;letter-spacing:-.01em;line-height:1.2}
.hg .hg-nick{color:var(--ac);font-weight:700}
.home-realname{font-size:.65rem;color:var(--t3);font-weight:400;letter-spacing:.02em;line-height:1}
.home-user-meta{display:flex;align-items:center;gap:.5rem;font-size:.68rem}
.home-icons{display:flex;gap:.5rem;align-items:center}
/* Center section — takes all available space, centers the button */
.hc{text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.8rem;flex:1;position:relative;z-index:1;width:100%;padding:0 1.2rem}
.hm{font-size:.82rem;color:var(--t3);font-weight:300;font-style:italic;line-height:1.6;max-width:220px;letter-spacing:.01em}
.daily-counter{font-size:.7rem;color:var(--t2);font-weight:400;padding:.35rem .8rem;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:20px;margin-top:.2rem}
.daily-counter strong{color:var(--ac);font-weight:700}
/* Main TOUCH button */
.be{width:clamp(150px,42vw,190px);height:clamp(150px,42vw,190px);border-radius:50%;background:radial-gradient(circle at 35% 35%,#ff8f65,#ff6b35 50%,#e05520);border:none;color:#fff;font-size:.85rem;font-weight:800;font-family:inherit;letter-spacing:.25em;cursor:pointer;position:relative;z-index:1;box-shadow:0 0 50px var(--gw),0 0 100px rgba(255,107,53,.08),inset 0 1px 0 rgba(255,255,255,.15);transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.4rem}
.be:active{transform:scale(.92)}
.be .be-icon{font-size:2.4rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3));display:flex;align-items:center;justify-content:center}
.be .be-text{font-size:.78rem;font-weight:800;letter-spacing:.25em}
.be::before{content:'';position:absolute;inset:-4px;border-radius:50%;background:conic-gradient(from 0deg,var(--ac),var(--pk),#9333ea,var(--ac));z-index:-1;animation:rs 4s linear infinite;opacity:.5;filter:blur(2px)}
.be::after{content:'';position:absolute;inset:-30px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.08),transparent 70%);z-index:-2;animation:bb 3s ease-in-out infinite}
/* Energized state */
.be.energized{animation:sonic-energy .6s ease-in-out infinite alternate;box-shadow:0 0 60px var(--gw2),0 0 120px rgba(255,107,53,.15),0 0 200px rgba(255,61,113,.06)}
.be.energized::before{animation:rs 1.5s linear infinite;opacity:.8;filter:blur(3px);inset:-8px}
.be.energized::after{animation:sonic-waves 1s ease-out infinite}
.be.energized .be-text{animation:sonic-text .8s ease infinite alternate}
@keyframes bb{0%,100%{opacity:.3}50%{opacity:.6}}
@keyframes rs{to{transform:rotate(360deg)}}
@keyframes sonic-energy{0%{transform:scale(1);box-shadow:0 0 60px var(--gw2),0 0 120px rgba(255,107,53,.15)}100%{transform:scale(1.04);box-shadow:0 0 80px var(--gw2),0 0 150px rgba(255,107,53,.2),0 0 250px rgba(255,61,113,.08)}}
@keyframes sonic-waves{0%{inset:-30px;opacity:.5}100%{inset:-80px;opacity:0}}
@keyframes sonic-text{0%{opacity:1}100%{opacity:.6}}
/* Sound wave bars on sides */
.sonic-bars{position:absolute;top:50%;display:flex;flex-direction:column;gap:3px;transform:translateY(-50%);z-index:0;opacity:0;transition:opacity .3s}
.sonic-bars.active{opacity:1}
.sonic-bars.left{left:-50px}
.sonic-bars.right{right:-50px}
.sonic-bar{height:2px;background:var(--ac);border-radius:2px;opacity:.4}
.sonic-bars.left .sonic-bar{animation:sbar-left .8s ease-in-out infinite alternate}
.sonic-bars.right .sonic-bar{animation:sbar-right .8s ease-in-out infinite alternate}
.sonic-bar:nth-child(1){width:12px;animation-delay:0s}
.sonic-bar:nth-child(2){width:20px;animation-delay:.1s}
.sonic-bar:nth-child(3){width:28px;animation-delay:.2s}
.sonic-bar:nth-child(4){width:20px;animation-delay:.3s}
.sonic-bar:nth-child(5){width:12px;animation-delay:.4s}
@keyframes sbar-left{0%{opacity:.2;transform:translateX(0)}100%{opacity:.7;transform:translateX(-6px)}}
@keyframes sbar-right{0%{opacity:.2;transform:translateX(0)}100%{opacity:.7;transform:translateX(6px)}}
.sonic-status{font-size:.72rem;color:var(--ac2);min-height:1.2em;transition:all .3s;opacity:0}
.sonic-status.active{opacity:1}
.sonic-fallback{opacity:0;transition:opacity .3s;pointer-events:none}
.sonic-fallback.active{opacity:1;pointer-events:auto}
/* FIRE — energy rising from speaker (bottom of phone) */
.fire-overlay{position:absolute;bottom:0;left:0;right:0;height:55%;pointer-events:none;z-index:0;opacity:0;transition:opacity .6s}
.fire-overlay.active{opacity:1}
/* Main upward glow — concentrated in center bottom like speaker beam */
.fire-glow{position:absolute;bottom:-15%;left:50%;transform:translateX(-50%);width:80%;height:55%;background:radial-gradient(ellipse at 50% 100%,rgba(255,107,53,.4) 0%,rgba(255,61,113,.18) 25%,rgba(255,107,53,.06) 50%,transparent 70%);animation:fire-breathe 1s ease-in-out infinite alternate;filter:blur(6px)}
.fire-glow2{position:absolute;bottom:-5%;left:50%;transform:translateX(-50%);width:50%;height:40%;background:radial-gradient(ellipse at 50% 100%,rgba(255,180,80,.3) 0%,rgba(255,107,53,.1) 40%,transparent 65%);animation:fire-breathe .7s ease-in-out infinite alternate-reverse;filter:blur(10px)}
/* Speaker icon glow at very bottom */
.fire-speaker{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:3px;opacity:0;animation:fire-spk-in .8s ease .3s forwards}
.fire-spk-wave{width:12px;height:12px;border:1.5px solid var(--ac);border-radius:50%;opacity:.5;animation:fire-spk-pulse 1.2s ease infinite}
.fire-spk-wave:nth-child(2){width:20px;height:20px;animation-delay:.2s;opacity:.3}
.fire-spk-wave:nth-child(3){width:28px;height:28px;animation-delay:.4s;opacity:.15}
@keyframes fire-spk-in{to{opacity:1}}
@keyframes fire-spk-pulse{0%,100%{opacity:.2;transform:scale(.9)}50%{opacity:.7;transform:scale(1.1)}}
/* Particles — concentrated from center bottom, shooting up like speaker energy */
.fire-particles{position:absolute;bottom:0;left:0;right:0;height:100%;overflow:hidden}
.fire-p{position:absolute;bottom:-8px;border-radius:50%;filter:blur(1.5px);animation:fire-rise linear infinite}
/* Concentrated near center (35-65% of width) — speaker zone */
.fire-p:nth-child(1){left:38%;width:5px;height:5px;background:#ff6b35;animation-duration:1.4s;animation-delay:0s}
.fire-p:nth-child(2){left:42%;width:3px;height:3px;background:#ffc060;animation-duration:1.7s;animation-delay:.2s}
.fire-p:nth-child(3){left:48%;width:7px;height:7px;background:#ff6b35;animation-duration:1.2s;animation-delay:.1s}
.fire-p:nth-child(4){left:52%;width:4px;height:4px;background:#ff3d71;animation-duration:1.6s;animation-delay:.35s}
.fire-p:nth-child(5){left:56%;width:5px;height:5px;background:#ffa060;animation-duration:1.3s;animation-delay:.15s}
.fire-p:nth-child(6){left:44%;width:3px;height:3px;background:#ff8f65;animation-duration:1.8s;animation-delay:.5s}
.fire-p:nth-child(7){left:50%;width:8px;height:8px;background:#ff6b35;animation-duration:1.1s;animation-delay:.25s}
.fire-p:nth-child(8){left:46%;width:4px;height:4px;background:#ffc060;animation-duration:1.5s;animation-delay:.4s}
/* Some scattered wider for spread effect */
.fire-p:nth-child(9){left:30%;width:3px;height:3px;background:#ff8f65;animation-duration:2s;animation-delay:.6s}
.fire-p:nth-child(10){left:65%;width:4px;height:4px;background:#ff6b35;animation-duration:1.9s;animation-delay:.3s}
.fire-p:nth-child(11){left:35%;width:5px;height:5px;background:#ff3d71;animation-duration:1.7s;animation-delay:.7s}
.fire-p:nth-child(12){left:60%;width:3px;height:3px;background:#ffa060;animation-duration:1.6s;animation-delay:.45s}
@keyframes fire-rise{0%{transform:translateY(0) scale(1);opacity:.9}30%{opacity:1}100%{transform:translateY(-50vh) scale(0);opacity:0}}
@keyframes fire-breathe{0%{opacity:.6;transform:translateX(-50%) scale(.95)}100%{opacity:1;transform:translateX(-50%) scale(1.05)}}
/* Edge heat lines — bottom edges glow */
.fire-edge{position:absolute;bottom:0;height:3px;background:linear-gradient(90deg,transparent 20%,var(--ac),#fff,var(--ac),transparent 80%);filter:blur(1px);animation:fire-edge-pulse .8s ease-in-out infinite alternate}
.fire-edge.left{left:0;right:50%;border-radius:0 2px 0 0}
.fire-edge.right{left:50%;right:0;border-radius:2px 0 0 0}
@keyframes fire-edge-pulse{0%{opacity:.3;height:2px}100%{opacity:.9;height:5px}}
/* Sonic instruction — speakers touching animation */
.sonic-instruct{position:absolute;bottom:22%;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:.8rem;opacity:0;transition:opacity .5s;z-index:3}
.sonic-instruct.active{opacity:1}
/* Phones lying down, bottoms (speakers) facing each other */
.si-scene{position:relative;width:160px;height:80px;display:flex;align-items:center;justify-content:center}
.si-phone{position:absolute;width:50px;height:26px;border:1.5px solid var(--ac);border-radius:5px;background:rgba(255,107,53,.06)}
.si-phone.left{left:0;animation:si-slide-l 2s ease-in-out infinite}
.si-phone.right{right:0;animation:si-slide-r 2s ease-in-out infinite}
/* Speaker grille dots on the inner edge */
.si-phone .si-speaker{position:absolute;top:50%;transform:translateY(-50%);display:flex;gap:2px;align-items:center}
.si-phone.left .si-speaker{right:3px}
.si-phone.right .si-speaker{left:3px}
.si-spk-dot{width:2.5px;height:2.5px;border-radius:50%;background:var(--ac);opacity:.6}
/* Energy arcs between speakers */
.si-energy{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;gap:3px;align-items:center}
.si-arc{width:3px;height:10px;border-radius:2px;background:var(--ac);opacity:0;animation:si-arc-flash .6s ease infinite}
.si-arc:nth-child(1){height:6px;animation-delay:0s}
.si-arc:nth-child(2){height:12px;animation-delay:.15s}
.si-arc:nth-child(3){height:8px;animation-delay:.3s}
.si-arc:nth-child(4){height:14px;animation-delay:.1s}
.si-arc:nth-child(5){height:6px;animation-delay:.25s}
@keyframes si-arc-flash{0%{opacity:0;transform:scaleY(.5)}30%{opacity:.9;transform:scaleY(1.1)}60%{opacity:.4;transform:scaleY(.8)}100%{opacity:0;transform:scaleY(.3)}}
@keyframes si-slide-l{0%,100%{transform:translateX(0)}50%{transform:translateX(18px)}}
@keyframes si-slide-r{0%,100%{transform:translateX(0)}50%{transform:translateX(-18px)}}
/* Speaker label */
.si-label{font-size:.5rem;color:var(--t3);letter-spacing:.08em;text-transform:uppercase;opacity:.6}
.si-text{font-size:.72rem;color:var(--ac2);text-align:center;max-width:200px;line-height:1.5;font-weight:600;letter-spacing:.02em}
.si-text em{color:#fff;font-style:normal;font-weight:700}
/* Pulsing glow from speaker zone */
.si-glow{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:20px;height:20px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.4),transparent 70%);animation:si-glow-pulse 1s ease-in-out infinite;filter:blur(4px)}
@keyframes si-glow-pulse{0%,100%{opacity:.3;transform:translate(-50%,-50%) scale(.8)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.5)}}
/* Screenshot block in chat */
#chat .cms{-webkit-user-select:none;user-select:none}
/* Bottom section — anchored tab bar */
.home-bottom{display:flex;flex-direction:column;align-items:center;width:100%;position:relative;z-index:5;flex-shrink:0;padding:0 1.2rem;padding-bottom:max(env(safe-area-inset-bottom),.6rem)}
.home-nav{display:flex;justify-content:space-around;width:100%;padding:.5rem 0;border-top:1px solid rgba(255,255,255,.04);background:linear-gradient(180deg,transparent,rgba(5,5,8,.3))}
.hn-btn{display:flex;flex-direction:column;align-items:center;gap:.2rem;background:none;border:none;color:var(--t3);font-family:inherit;cursor:pointer;padding:.5rem .5rem;border-radius:12px;transition:all .2s cubic-bezier(.22,1,.36,1);-webkit-tap-highlight-color:transparent;min-width:56px;flex:1;max-width:80px;position:relative}
.hn-btn:active{background:rgba(255,255,255,.06);color:var(--t1);transform:scale(.92)}
.hn-ico{font-size:1.15rem;line-height:1;transition:transform .2s}
.hn-btn:active .hn-ico{transform:scale(1.15)}
.hn-lbl{font-size:.52rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:inherit;white-space:nowrap;opacity:.7}
.home-brand-row{display:flex;align-items:center;justify-content:center;gap:.6rem;padding:.2rem 0 .1rem}
.home-brand{font-size:.5rem;font-weight:800;letter-spacing:.35em;color:var(--ac);opacity:.3}
.rb{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;position:relative}
.rb:active{transform:scale(.93)}
.rb .ct{position:absolute;top:-3px;right:-3px;min-width:16px;height:16px;border-radius:50%;background:var(--ac);font-size:.55rem;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
.cd{width:7px;height:7px;border-radius:50%;background:var(--ok);box-shadow:0 0 8px rgba(52,211,153,.6);transition:all .3s ease}
.cd.offline{background:var(--err);box-shadow:0 0 8px rgba(248,113,113,.6)}
.cd.reconnecting{background:var(--warn);box-shadow:0 0 8px rgba(251,191,36,.5);animation:bk 1s infinite}
@keyframes bk{0%,100%{opacity:1}50%{opacity:.3}}
.constellation-btn{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;position:relative}
.constellation-btn:active{transform:scale(.93)}

/* ENCOUNTER */
#encounter{padding:2rem 1.5rem;justify-content:center;align-items:center;text-align:center}
.ep{display:none;flex-direction:column;align-items:center;gap:1.5rem;width:100%}.ep.active{display:flex}
.et{font-size:.85rem;color:var(--t2);margin-bottom:.5rem}
.cdsp{font-size:2.8rem;font-weight:800;letter-spacing:.25em;color:var(--ac);font-family:'Courier New',monospace;text-shadow:0 0 20px var(--gw)}
.qb{background:#fff;padding:14px;border-radius:16px;display:inline-block;box-shadow:0 8px 30px rgba(0,0,0,.3)}
.qb canvas{display:block}
.cir{display:flex;gap:.5rem;width:100%;max-width:280px}
.cir input{flex:1;padding:.85rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;color:var(--t1);font-size:1.1rem;font-family:'Courier New',monospace;text-align:center;letter-spacing:.15em;outline:none;text-transform:uppercase}
.cir input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.cir button{padding:0 1.2rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:14px;color:#fff;font-size:1.3rem;cursor:pointer}
.od{display:flex;align-items:center;gap:1rem;color:var(--t3);font-size:.8rem;width:100%;max-width:280px}
.od::before,.od::after{content:'';flex:1;height:1px;background:var(--b1)}
.wd{color:var(--ac);font-size:1.5rem;display:flex;gap:6px;justify-content:center}
.wd span{animation:df 1.4s ease-in-out infinite;opacity:.3}
.wd span:nth-child(2){animation-delay:.2s}.wd span:nth-child(3){animation-delay:.4s}
@keyframes df{0%,100%{opacity:.3}50%{opacity:1}}

/* SONIC ENCOUNTER MODE (kept as phaseBump for compat) */
.bump-circle{width:160px;height:160px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#ff8f65,#ff6b35 50%,#e05520);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:.3rem;position:relative;box-shadow:0 0 60px var(--gw);transition:all .3s}
.bump-circle.listening{animation:sonic-energy .6s ease-in-out infinite alternate}
.bump-circle.bumped{background:radial-gradient(circle at 35% 35%,#34d399,#10b981 50%,#059669);box-shadow:0 0 80px rgba(52,211,153,.4);animation:bump-hit .5s ease}

/* REVEAL — next-gen minimal */
#reveal{justify-content:center;align-items:center;text-align:center;padding:0;overflow:hidden;background:#050508}
.rv-light-beam{position:absolute;inset:0;z-index:0;pointer-events:none}
.rv-wrap{position:relative;z-index:3;display:flex;flex-direction:column;align-items:center;width:100%;height:100%;justify-content:center}
.rv-center{display:flex;flex-direction:column;align-items:center;gap:1.2rem;flex:1;justify-content:center;padding:0 1.5rem}
/* Avatars row */
.rv-avatars{display:flex;align-items:center;justify-content:center;gap:1.2rem;position:relative;opacity:0;animation:rv-up .8s ease 3.8s forwards}
.rv-avatar-wrap{position:relative;display:flex;flex-direction:column;align-items:center;gap:.35rem}
.rv-avatar-img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:1.5px solid rgba(255,255,255,.1);box-shadow:0 0 20px rgba(255,107,53,.15)}
.rv-avatar-name{font-size:.65rem;color:rgba(255,255,255,.45);font-weight:400;letter-spacing:.04em;opacity:0;animation:rv-fi .6s ease 4.4s forwards}
.rv-connection-symbol{display:flex;align-items:center;padding:0 .2rem}
.rv-connection-dot{width:4px;height:4px;border-radius:50%;background:rgba(255,107,53,.5);box-shadow:0 0 8px rgba(255,107,53,.3)}
/* Moment label */
.rv-moment{font-size:.6rem;color:rgba(255,255,255,.25);letter-spacing:.25em;text-transform:uppercase;opacity:0;animation:rv-fi 1.2s ease .3s forwards;font-weight:400}
/* Phrase — THE focus */
.rv-phrase{max-width:300px;min-height:50px;display:flex;flex-wrap:wrap;justify-content:center;gap:.25rem;line-height:2}
.rv-word{display:inline-block;font-size:1.5rem;font-weight:200;color:#fff;opacity:0;transform:translateY(8px);animation:rv-word .7s cubic-bezier(.22,1,.36,1) forwards;letter-spacing:-.01em}
@keyframes rv-word{to{opacity:1;transform:none}}
/* Sub */
.rv-sub{font-size:.58rem;color:rgba(255,255,255,.18);opacity:0;animation:rv-fi .8s ease 5.5s forwards;font-weight:300;letter-spacing:.06em}
.rv-line{display:none}
/* Renewed + last */
.rv-renewed{font-size:.62rem;color:rgba(255,107,53,.5);opacity:0;animation:rv-fi .6s ease 4.8s forwards;letter-spacing:.1em}
.rv-last{font-size:.55rem;color:rgba(255,255,255,.2);margin-top:.1rem;padding:.2rem .6rem;background:rgba(255,255,255,.02);border-radius:6px;border:1px solid rgba(255,255,255,.04);opacity:0;animation:rv-fi .6s ease 5s forwards}
@keyframes rv-fi{to{opacity:1}}
@keyframes rv-up{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
/* Bottom actions — two main buttons side by side */
.rv-actions{position:absolute;bottom:0;left:0;right:0;display:flex;flex-direction:column;gap:.6rem;align-items:center;padding:.8rem 1.5rem calc(env(safe-area-inset-bottom,.5rem) + .8rem);opacity:0;animation:rv-fi .6s ease 6s forwards;z-index:5}
.rv-btn-row{display:flex;gap:.5rem;width:100%;max-width:300px}
.rv-btn-enter{flex:1;padding:.65rem 0;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:28px;color:#fff;font-size:.72rem;font-weight:500;font-family:inherit;cursor:pointer;letter-spacing:.06em;transition:all .15s;backdrop-filter:blur(8px)}
.rv-btn-enter:active{transform:scale(.96);background:rgba(255,255,255,.12)}
.rv-btn-skip{flex:1;padding:.65rem 0;background:transparent;border:1px solid rgba(255,255,255,.06);border-radius:28px;color:rgba(255,255,255,.35);font-size:.72rem;font-weight:400;font-family:inherit;cursor:pointer;letter-spacing:.06em;transition:all .15s}
.rv-btn-skip:active{transform:scale(.96);color:rgba(255,255,255,.6)}
.rv-sec-row{display:flex;gap:.5rem;justify-content:center}
.rv-btn-mini{display:flex;align-items:center;gap:.3rem;padding:.3rem .7rem;background:transparent;border:1px solid rgba(255,255,255,.05);border-radius:16px;color:rgba(255,255,255,.25);font-size:.55rem;font-family:inherit;cursor:pointer;transition:all .15s;letter-spacing:.02em}
.rv-btn-mini:active{background:rgba(255,255,255,.06);color:rgba(255,255,255,.5)}
.rv-btn-mini .rv-ico{font-size:.7rem;line-height:1;opacity:.5}

/* CHAT */
#chat{flex-direction:column;background:var(--bg)}
.ch{display:flex;align-items:center;justify-content:space-between;padding:.5rem .8rem;background:rgba(18,18,24,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-bottom:1px solid rgba(255,255,255,.05);padding-top:max(env(safe-area-inset-top),.5rem);flex-shrink:0;z-index:2;box-shadow:0 1px 12px rgba(0,0,0,.15)}
.chl{display:flex;align-items:center;gap:.5rem;flex:1;min-width:0}
.ch-info{cursor:pointer;display:flex;flex-direction:column;min-width:0;gap:.05rem}
.ch-info:active{opacity:.7}
.chb{width:32px;height:32px;border-radius:50%;background:transparent;border:none;color:var(--t1);font-size:1.05rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.15s;flex-shrink:0}
.chb:active{transform:scale(.9);opacity:.7}
.chn{font-size:.88rem;font-weight:600;letter-spacing:-.01em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ch-sub{font-size:.6rem;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cht{font-size:.72rem;font-weight:700;font-family:'Courier New',monospace;padding:.3rem .7rem;border-radius:20px;background:rgba(255,107,53,.08);color:var(--ac);letter-spacing:.04em;transition:all .3s;flex-shrink:0;border:1px solid rgba(255,107,53,.12)}
.cht.urg{background:rgba(248,113,113,.12);color:var(--err);border-color:rgba(248,113,113,.2);animation:urg-pulse 1.5s ease infinite}
@keyframes urg-pulse{0%,100%{opacity:1}50%{opacity:.6}}
/* ID action pills */
.chat-id-bar{display:flex;gap:.4rem;padding:.3rem .8rem;justify-content:center}
.id-pill{padding:.4rem .8rem;border-radius:20px;font-size:.7rem;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .2s;display:inline-flex;align-items:center;gap:.3rem}
.id-pill.request{background:rgba(163,113,247,.1);color:#a371f7;border:1px solid rgba(163,113,247,.2)}
.id-pill.reveal{background:rgba(255,107,53,.1);color:var(--ac);border:1px solid rgba(255,107,53,.2)}
.id-pill:active{transform:scale(.93)}
.cpb{padding:.55rem 1rem;text-align:center;font-size:.75rem;color:var(--ac2);font-style:italic;background:linear-gradient(180deg,rgba(255,107,53,.06) 0%,transparent 100%);flex-shrink:0;letter-spacing:.01em}
.cms{flex:1;overflow-y:auto;padding:.6rem .8rem;display:flex;flex-direction:column;gap:.35rem;min-height:0;scroll-behavior:smooth}
.msg{max-width:78%;padding:.6rem .9rem;border-radius:18px;font-size:.86rem;line-height:1.45;word-break:break-word;animation:mi .3s cubic-bezier(.22,1,.36,1);position:relative}
.msg.mine{align-self:flex-end;background:linear-gradient(135deg,var(--ac),#e85d2a);color:#fff;border-bottom-right-radius:4px;box-shadow:0 2px 8px rgba(255,107,53,.2)}
.msg.theirs{align-self:flex-start;background:var(--s2);color:var(--t1);border-bottom-left-radius:4px;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.msg.ephemeral{border:1px dashed rgba(255,107,53,.35);background:rgba(255,107,53,.06);color:var(--t1);text-align:center;align-self:center;max-width:85%;font-style:italic;padding:.5rem 1rem;font-size:.8rem}
.msg.ephemeral.mine{background:rgba(255,107,53,.12);border-color:rgba(255,107,53,.4)}
.msg.ephemeral .eph-badge{display:inline-block;font-size:.55rem;text-transform:uppercase;letter-spacing:.1em;opacity:.5;margin-left:.4rem;font-style:normal}
.msg.photo{padding:.25rem}
.msg.photo img{border-radius:14px;max-width:220px;max-height:220px;display:block;object-fit:cover}
.mt{font-size:.55rem;opacity:.4;margin-top:.15rem}
@keyframes mi{from{opacity:0;transform:translateY(6px) scale(.97)}to{opacity:1;transform:none}}
.ti{display:flex;align-items:center;gap:3px;padding:.4rem .8rem;align-self:flex-start;opacity:0;height:0;overflow:hidden;transition:opacity .2s,height .2s}
.ti.vis{opacity:1;height:auto;overflow:visible}
.ti .dot{width:5px;height:5px;border-radius:50%;background:var(--t2);animation:tb 1.4s ease-in-out infinite}
.ti .dot:nth-child(2){animation-delay:.15s}.ti .dot:nth-child(3){animation-delay:.3s}
@keyframes tb{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}
/* System messages */
.msg-system{text-align:center;font-size:.7rem;color:var(--t3);padding:.5rem 1rem;font-style:italic}
/* Quick phrases bar */
.qp-bar{display:flex;gap:.35rem;padding:.4rem .8rem;overflow-x:auto;-webkit-overflow-scrolling:touch;flex-shrink:0;background:transparent;scrollbar-width:none}
.qp-bar::-webkit-scrollbar{display:none}
.qp-chip{padding:.4rem .8rem;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:18px;color:var(--t2);font-size:.72rem;cursor:pointer;flex-shrink:0;font-family:inherit;transition:all .2s cubic-bezier(.22,1,.36,1);white-space:nowrap}
.qp-chip:active{background:var(--ac);color:#fff;border-color:var(--ac);transform:scale(.93)}
.qp-chip.sent{opacity:.25;pointer-events:none;transform:scale(.95)}
/* Chat input area - modern */
.chat-bottom{background:rgba(18,18,24,.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-top:1px solid rgba(255,255,255,.05);flex-shrink:0;padding-bottom:max(env(safe-area-inset-bottom),.5rem)}
.cia{display:flex;align-items:flex-end;gap:.4rem;padding:.35rem .8rem .35rem}
.cia-wrap{flex:1;display:flex;align-items:flex-end;background:var(--s2);border:1px solid rgba(255,255,255,.08);border-radius:22px;transition:border-color .2s;overflow:hidden}
.cia-wrap:focus-within{border-color:var(--ac)}
.cia-plus{width:34px;height:34px;border:none;background:transparent;color:var(--t3);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.15s;padding:0 0 0 .3rem}
.cia-plus:active{color:var(--ac);transform:scale(.9)}
.cia input{flex:1;padding:.6rem .7rem .6rem .2rem;background:transparent;border:none;color:var(--t1);font-size:.86rem;font-family:inherit;outline:none;min-height:20px}
.sb{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--ac),#e85d2a);border:none;color:#fff;font-size:.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s cubic-bezier(.22,1,.36,1);opacity:0;transform:scale(.3);pointer-events:none;flex-shrink:0;box-shadow:0 2px 10px rgba(255,107,53,.3)}
.sb.active{opacity:1;transform:scale(1);pointer-events:auto}
.sb:active{transform:scale(.85)}
/* Plus menu overlay */
.plus-menu{position:absolute;bottom:100%;left:.5rem;right:.5rem;background:rgba(24,24,32,.97);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:.5rem;display:grid;grid-template-columns:repeat(4,1fr);gap:.3rem;transform:translateY(8px);opacity:0;pointer-events:none;transition:all .2s ease;z-index:10;margin-bottom:.4rem}
.plus-menu.open{transform:translateY(0);opacity:1;pointer-events:auto}
.pm-item{display:flex;flex-direction:column;align-items:center;gap:.3rem;padding:.6rem .3rem;border-radius:12px;cursor:pointer;transition:.15s;border:none;background:transparent;font-family:inherit;color:var(--t1)}
.pm-item:active{background:rgba(255,255,255,.06);transform:scale(.95)}
.pm-ico{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.15rem}
.pm-label{font-size:.62rem;color:var(--t2);text-align:center;letter-spacing:.02em}
.selfie-btn{display:none}

/* RELATIONS */
#relations{flex-direction:column;background:var(--bg)}
.rlh{display:flex;align-items:center;gap:.8rem;padding:1rem 1.2rem;background:linear-gradient(180deg,var(--s1) 0%,var(--bg) 100%);border-bottom:1px solid rgba(255,255,255,.04);padding-top:max(env(safe-area-inset-top),1rem)}
.rlh h2{font-size:1.15rem;font-weight:700;letter-spacing:-.01em}
.rlh-sub{font-size:.7rem;color:var(--t3);font-weight:400;margin-left:auto}
.rll{flex:1;overflow-y:auto;padding:.6rem .8rem;padding-bottom:5rem}
.float-history-btn{position:absolute;bottom:1.5rem;right:1.2rem;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--p1),var(--p2));color:#fff;font-size:1.4rem;border:none;box-shadow:0 4px 20px rgba(255,107,53,.35);cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center;transition:transform .2s}
.rc{display:flex;align-items:center;gap:.9rem;padding:1rem;margin-bottom:.6rem;background:linear-gradient(135deg,var(--s1),rgba(26,26,36,.8));border:1px solid rgba(255,255,255,.06);border-radius:18px;cursor:pointer;transition:all .2s cubic-bezier(.22,1,.36,1);position:relative;overflow:hidden}
.rc::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,var(--ac),var(--pk));border-radius:3px 0 0 3px;opacity:.4;transition:opacity .2s}
.rc:active{background:var(--s2);transform:scale(.975);border-color:rgba(255,107,53,.25)}.rc:active::before{opacity:1}
.rav{display:flex;align-items:center;justify-content:center;flex-shrink:0}
.ri{flex:1;min-width:0}
.rn{font-size:1.05rem;font-weight:600;letter-spacing:-.01em;color:var(--t1)}
.rp{font-size:.8rem;color:var(--t2);margin-top:.25rem;font-style:italic;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.rp-preview{font-size:.75rem;color:var(--t3);margin-top:.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rc-unread{width:10px;height:10px;border-radius:50%;background:var(--ac);flex-shrink:0;margin-bottom:.3rem;box-shadow:0 0 8px rgba(255,107,53,.5)}
.rtm-wrap{display:flex;flex-direction:column;align-items:flex-end;gap:.2rem;flex-shrink:0}
.rtm{font-size:.75rem;font-family:'Courier New',monospace;font-weight:700;flex-shrink:0;padding:.25rem .6rem;border-radius:10px;background:rgba(52,211,153,.08)}
.rtm.ok{color:var(--ok);background:rgba(52,211,153,.08)}.rtm.med{color:var(--warn);background:rgba(251,191,36,.08)}.rtm.low{color:var(--err);background:rgba(248,113,113,.08);animation:urg-pulse 1.5s ease infinite}
.rtm-label{font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em}
.nr{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--t2);text-align:center;padding:2.5rem;font-size:1rem;line-height:1.8}
.nr-icon{font-size:2.5rem;margin-bottom:1rem;opacity:.25;filter:grayscale(.5)}
.nr-text{font-size:.82rem;color:var(--t3);max-width:240px;line-height:1.6;font-weight:300}

/* STREAK */
.streak-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:10px;font-size:.7rem;color:#fbbf24;font-weight:600}
.streak-badge .streak-fire{font-size:.75rem}
.streak-info{padding:.5rem .8rem;background:linear-gradient(135deg,rgba(251,191,36,.06),rgba(255,107,53,.04));border:1px solid rgba(251,191,36,.1);border-radius:12px;margin:.3rem .8rem;font-size:.72rem;color:var(--t2);display:flex;align-items:center;justify-content:space-between;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.streak-progress{height:3px;background:rgba(255,255,255,.06);border-radius:2px;flex:1;margin:0 .6rem;overflow:hidden}
.streak-bar{height:100%;background:linear-gradient(90deg,#fbbf24,#ff6b35);border-radius:2px;transition:width .3s ease}
/* Streak unlock modal */
.streak-unlock-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;animation:fadeIn .3s ease}
.streak-unlock-card{background:linear-gradient(170deg,#161628,#0c0c18);border:1px solid rgba(251,191,36,.3);border-radius:20px;padding:2rem;text-align:center;max-width:300px;width:90%;animation:mi .4s ease}
.streak-unlock-card .su-emoji{font-size:2.5rem;margin-bottom:.8rem}
.streak-unlock-card .su-title{font-size:1.1rem;font-weight:700;color:#fbbf24;margin-bottom:.4rem}
.streak-unlock-card .su-desc{font-size:.8rem;color:var(--t2);margin-bottom:1rem;line-height:1.5}
.streak-unlock-card .su-content{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:.8rem;margin-bottom:1rem;font-size:.85rem;font-style:italic;color:var(--ac2);line-height:1.5}
/* Touch link */
.touch-link-area{padding:1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin:.8rem;text-align:center}
.touch-link-url{font-size:.65rem;color:var(--t3);word-break:break-all;margin:.5rem 0;padding:.4rem;background:var(--s2);border-radius:8px;font-family:'Courier New',monospace}
.touch-link-actions{display:flex;gap:.4rem;justify-content:center;margin-top:.5rem}
.touch-link-actions button{padding:.4rem .8rem;font-size:.7rem}

/* SCORE + STARS BADGE */
.pts-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;background:var(--gw);border:1px solid rgba(255,107,53,.15);border-radius:12px;font-size:.7rem;color:var(--ac);font-weight:600}
/* score/stars hidden — data preserved internally */
.pts-partner{display:none}

/* BOARDING PASS */
#boardingPass{justify-content:center;align-items:center;padding:1.5rem;text-align:center;background:var(--bg)}
.bp-card{width:320px;background:linear-gradient(170deg,#0c0c18,#161628,#0c0c18);border:1px solid rgba(255,255,255,.08);border-radius:24px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,.03) inset;position:relative}
.bp-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--ac),var(--pk),var(--ac))}
.bp-top{padding:1.2rem 1.5rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed var(--b1)}
.bp-logo{font-size:.7rem;font-weight:800;letter-spacing:.3em;color:var(--ac)}
.bp-type{font-size:.55rem;color:var(--t3);letter-spacing:.15em;text-transform:uppercase}
.bp-body{padding:1.5rem}
.bp-avatar{width:60px;height:60px;border-radius:50%;background:var(--s2);border:2px solid var(--ac);margin:0 auto .8rem;display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:800;color:#fff;letter-spacing:.03em;overflow:hidden}
.bp-name{font-size:1.2rem;font-weight:700;color:var(--t1);margin-bottom:.2rem}
.bp-since{font-size:.65rem;color:var(--t3);margin-bottom:1.2rem}
.bp-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.8rem;margin-bottom:1.2rem}
.bp-stat{text-align:center}
.bp-stat-num{font-size:1.4rem;font-weight:800;color:var(--ac);line-height:1}
.bp-stat-label{font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-top:.3rem}
.bp-barcode{padding:1rem 1.5rem;border-top:1px dashed var(--b1);display:flex;justify-content:center;gap:2px}
.bp-bar{width:2px;background:var(--t3);border-radius:1px}
.bp-footer{padding:.6rem;font-size:.5rem;color:var(--t3);letter-spacing:.15em;text-align:center}
.bp-actions{display:flex;gap:.8rem;margin-top:1.2rem}
.bp-dl{padding:.6rem 1.2rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:12px;color:#fff;font-size:.8rem;font-weight:600;cursor:pointer;font-family:inherit}
.bp-dl:active{transform:scale(.96)}

/* CONSTELLATION / REDE */
#history{flex-direction:column;background:var(--bg);overflow:hidden}
.const-header{display:flex;align-items:center;gap:.8rem;padding:.8rem 1.2rem;padding-top:max(env(safe-area-inset-top),.8rem);position:absolute;top:0;left:0;right:0;z-index:10;background:linear-gradient(180deg,rgba(2,2,5,.9) 0%,transparent 100%)}
.const-header h2{font-size:.82rem;font-weight:500;color:var(--t2);letter-spacing:.08em;text-transform:uppercase}
.const-copy{position:absolute;top:0;left:0;right:0;text-align:center;padding-top:calc(max(env(safe-area-inset-top),.8rem) + 3rem);z-index:5;pointer-events:none}
.const-copy p{font-size:.65rem;color:rgba(255,255,255,.2);font-weight:300;font-style:italic;line-height:1.7;letter-spacing:.05em}
.const-canvas-wrap{position:absolute;inset:0;z-index:1;background:radial-gradient(ellipse at 50% 45%,rgba(15,15,30,1) 0%,rgba(2,2,5,1) 70%)}
.const-canvas-wrap canvas{width:100%;height:100%;touch-action:none}
/* Node detail overlay */
.const-detail{position:absolute;bottom:0;left:0;right:0;z-index:20;background:linear-gradient(180deg,transparent 0%,rgba(5,5,8,.95) 40%);padding:2rem 1.5rem;padding-bottom:max(env(safe-area-inset-bottom),2rem);display:flex;flex-direction:column;align-items:center;gap:.5rem;opacity:0;transform:translateY(20px);transition:all .35s cubic-bezier(.22,1,.36,1);pointer-events:none}
.const-detail.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.const-detail-avatar{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:800;color:#fff;border:2px solid rgba(255,255,255,.15);overflow:hidden;position:relative}
.const-detail-avatar img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0}
.const-detail-nick{font-size:1rem;font-weight:600;color:var(--t1)}
.const-detail-realname{font-size:.78rem;color:var(--ac2);font-weight:400;margin-top:-.15rem}
.const-detail-sub{font-size:.7rem;color:var(--t2);font-weight:400;margin-top:-.1rem}
.const-detail-meta{font-size:.68rem;color:var(--t3);display:flex;gap:1rem;align-items:center}
.const-detail-selfie{width:48px;height:48px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,.1);margin-top:.3rem}
.const-detail-insta{display:inline-flex;align-items:center;gap:.3rem;padding:.35rem .8rem;margin:.3rem 0;background:linear-gradient(135deg,rgba(225,48,108,.15),rgba(131,58,180,.15));border:1px solid rgba(225,48,108,.25);border-radius:20px;color:#e1306c;font-size:.75rem;font-weight:500;text-decoration:none;transition:all .2s}
.const-detail-insta:active{background:linear-gradient(135deg,rgba(225,48,108,.3),rgba(131,58,180,.3));transform:scale(.96)}
.const-detail-text{font-size:.72rem;color:var(--t3);font-style:italic;font-weight:300}
.const-detail-id-actions{display:flex;gap:.5rem;margin-top:.4rem;flex-wrap:wrap;justify-content:center}
.const-detail-tip-btn{margin-top:.5rem;padding:.5rem 1.2rem;background:linear-gradient(135deg,#22c55e,#16a34a);border:none;border-radius:12px;color:#fff;font-size:.75rem;font-weight:600;font-family:inherit;cursor:pointer;letter-spacing:.03em}
.const-detail-tip-btn:active{transform:scale(.97)}

/* ENCOUNTER LOG */
#encounterLog{padding:0;overflow-y:auto}
.elog-header{display:flex;align-items:center;gap:.6rem;padding:max(env(safe-area-inset-top),.8rem) 1.2rem .6rem;border-bottom:1px solid var(--b1)}
.elog-header h2{font-size:1rem;font-weight:700;flex:1}
.elog-list{padding:.8rem 1rem;display:flex;flex-direction:column;gap:.6rem;padding-bottom:3rem}
.elog-item{background:var(--s1);border:1px solid var(--b1);border-radius:14px;padding:.8rem;display:flex;gap:.7rem;align-items:flex-start;transition:all .15s cubic-bezier(.22,1,.36,1);cursor:pointer}
.elog-item:active{transform:scale(.975);background:var(--s2);border-color:rgba(255,107,53,.15)}
.elog-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:800;color:#fff;flex-shrink:0}
.elog-info{flex:1;min-width:0}
.elog-name{font-size:.85rem;font-weight:600;color:var(--t1)}
.elog-phrase{font-size:.7rem;color:var(--t2);font-style:italic;margin-top:.15rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.elog-meta{display:flex;gap:.6rem;font-size:.62rem;color:var(--t3);margin-top:.25rem;flex-wrap:wrap}
.elog-meta span{display:flex;align-items:center;gap:.2rem}
.elog-tip{color:var(--ok);font-weight:600}
.elog-empty{text-align:center;padding:3rem 1.5rem;color:var(--t3);font-size:.82rem;line-height:1.6;font-weight:300}

/* MORE MENU (overlay) */
.more-menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:8000;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .25s ease}
.more-menu-sheet{background:linear-gradient(180deg,var(--s2),var(--s1));border-radius:24px 24px 0 0;width:100%;max-width:420px;padding:1.5rem;padding-bottom:max(env(safe-area-inset-bottom),1.5rem);animation:slideUp .35s cubic-bezier(.22,1,.36,1)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.more-menu-handle{width:32px;height:4px;background:var(--b1);border-radius:2px;margin:0 auto .8rem}
.more-menu-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
.more-menu-item{display:flex;flex-direction:column;align-items:center;gap:.4rem;padding:.8rem .4rem;background:var(--s2);border:1px solid var(--b1);border-radius:14px;cursor:pointer;transition:.15s}
.more-menu-item:active{transform:scale(.95);background:var(--s3)}
.more-menu-item .mm-ico{font-size:1.4rem}
.more-menu-item .mm-lbl{font-size:.68rem;color:var(--t2);font-weight:500;text-align:center}
.my-pf-btn{display:flex;align-items:center;gap:.7rem;width:100%;padding:.7rem .8rem;background:var(--s2);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:.85rem;font-family:inherit;cursor:pointer;transition:all .15s;text-align:left}
.my-pf-btn:active{transform:scale(.98);background:var(--s3)}
.my-pf-ico{font-size:1rem;flex-shrink:0;width:24px;text-align:center}
.my-pf-tag{margin-left:auto;font-size:.6rem;color:var(--t3);font-weight:400;white-space:nowrap}
.my-pf-danger{color:var(--err);border-color:rgba(248,113,113,.15)}

/* COMPLETE PROFILE */
#completeProfile{padding:1.5rem;overflow-y:auto}
.cp-header{text-align:center;margin-bottom:1.5rem;padding-top:env(safe-area-inset-top,1rem)}
.cp-header h2{font-size:1.2rem;font-weight:700;color:var(--t1)}
.cp-header p{font-size:.75rem;color:var(--t2);margin-top:.3rem}
.cp-photo-wrap{display:flex;flex-direction:column;align-items:center;gap:.6rem;margin-bottom:1.5rem}
.cp-photo{width:100px;height:100px;border-radius:50%;background:var(--s2);border:2px solid var(--b1);overflow:hidden;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative}
.cp-photo img{width:100%;height:100%;object-fit:cover}
.cp-photo-label{font-size:.7rem;color:var(--ac);cursor:pointer}
.cp-field{margin-bottom:1.2rem}
.cp-field label{display:block;font-size:.68rem;color:var(--t2);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.4rem;font-weight:600}
.cp-field input,.cp-field textarea{width:100%;padding:.75rem .9rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:.9rem;font-family:inherit;outline:none;transition:border-color .2s}
.cp-field input:focus,.cp-field textarea:focus{border-color:var(--ac)}
.cp-field textarea{resize:none;height:70px}
.cp-note{font-size:.65rem;color:var(--t3);margin-top:.3rem}
.cp-actions{display:flex;gap:.8rem;margin-top:1.5rem;padding-bottom:2rem}
.cp-actions .bp{flex:1}
.cp-actions .bs{flex:0}

/* REVEAL IDENTITY */
/* ID Request/Reveal buttons — eye-catching in chat actions */
@keyframes id-btn-glow{0%,100%{box-shadow:none}50%{box-shadow:0 0 12px rgba(255,107,53,.15)}}
/* Floating ID buttons in constellation detail */
.id-float-btn{display:inline-flex;align-items:center;gap:.4rem;padding:.5rem 1rem;border-radius:20px;font-size:.75rem;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .2s;box-shadow:0 4px 16px rgba(0,0,0,.3)}
.id-float-btn.request{background:linear-gradient(135deg,#7c3aed,#a371f7);color:#fff}
.id-float-btn.reveal{background:linear-gradient(135deg,var(--ac),var(--pk));color:#fff}
.id-float-btn:active{transform:scale(.93)}
.reveal-req-popup{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);width:calc(100% - 2rem);max-width:380px;background:linear-gradient(135deg,var(--s2),var(--s1));border:1px solid rgba(255,107,53,.25);border-radius:20px;padding:1.2rem;z-index:9999;box-shadow:0 8px 40px rgba(0,0,0,.6),0 0 20px rgba(255,107,53,.15);animation:slideUp .35s cubic-bezier(.22,1,.36,1)}
.reveal-req-content{display:flex;align-items:center;gap:.8rem;margin-bottom:1rem}
.reveal-req-actions{display:flex;gap:.5rem}
.id-revealed-card{background:var(--s1);border:1px solid var(--ac);border-radius:14px;padding:.8rem;display:flex;align-items:center;gap:.8rem;margin:.5rem 0}
.id-revealed-card img{width:44px;height:44px;border-radius:50%;object-fit:cover}
.id-revealed-card .id-name{font-size:.9rem;font-weight:600;color:var(--t1)}
.id-revealed-card .id-bio{font-size:.7rem;color:var(--t2)}
.const-empty{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.8rem;z-index:5;padding:2rem}
.const-empty-icon{font-size:2rem;opacity:.2}
.const-empty-text{font-size:.8rem;color:var(--t3);font-weight:300;text-align:center;line-height:1.7;max-width:220px}
.const-feedback{position:absolute;top:calc(max(env(safe-area-inset-top),.8rem) + 3.5rem);left:50%;transform:translateX(-50%);z-index:15;font-size:.68rem;color:var(--ac2);font-weight:400;font-style:italic;opacity:0;transition:opacity .5s;pointer-events:none;white-space:nowrap}
.const-feedback.show{opacity:1}

/* EXPIRE CARD */
#expireCard{justify-content:center;align-items:center;padding:2rem;text-align:center}
.ev{width:270px;aspect-ratio:9/16;background:linear-gradient(170deg,#0a0a12,#15152a,#0a0a12);border:1px solid var(--b2);border-radius:24px;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:2.5rem;gap:1.5rem;position:relative;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.ev::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg,transparent,rgba(255,107,53,.04),transparent,rgba(255,61,113,.04),transparent);animation:sh 10s linear infinite}
@keyframes sh{to{transform:rotate(360deg)}}
.ev .cl{font-size:.85rem;font-weight:800;letter-spacing:.3em;color:var(--ac);opacity:.5;position:relative}
.ev .cf{font-size:1.15rem;font-weight:300;color:var(--t1);line-height:1.7;position:relative}
.ev .ctm{font-size:.72rem;color:var(--t2);position:relative}
.ev .cft{font-size:.6rem;color:var(--t3);position:absolute;bottom:1.5rem}
.ea{display:flex;gap:1rem;margin-top:1.5rem}

/* PROFILE */
#profile{flex-direction:column;background:var(--bg)}
.pf-header{display:flex;align-items:center;gap:.8rem;padding:1rem;background:var(--s1);border-bottom:1px solid var(--b1);padding-top:max(env(safe-area-inset-top),1rem)}
.pf-header h2{font-size:1.05rem;font-weight:600}
.pf-scroll{flex:1;overflow-y:auto;padding:1rem}
.pf-card{text-align:center;padding:1.5rem;background:linear-gradient(170deg,var(--s1),rgba(26,26,36,.6));border:1px solid rgba(255,255,255,.06);border-radius:20px;margin-bottom:1rem;position:relative;overflow:hidden}
.pf-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 50% 0%,rgba(255,107,53,.04),transparent 60%);pointer-events:none}
.pf-stats{display:flex;justify-content:center;gap:1.5rem;margin-top:1rem}
.pf-stat{text-align:center}
.pf-stat-num{font-size:1.3rem;font-weight:800;color:var(--ac)}
.pf-stat-lbl{font-size:.6rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em}
.pf-section{margin-bottom:1.2rem}
.pf-section-title{font-size:.75rem;color:var(--t2);text-transform:uppercase;letter-spacing:.12em;font-weight:600;margin-bottom:.6rem;padding-left:.3rem}
.pf-decl{padding:.7rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;margin-bottom:.5rem;border-left:3px solid var(--ac)}
.pf-decl-text{font-size:.85rem;color:var(--t1);font-style:italic;line-height:1.5;margin-bottom:.3rem}
.pf-decl-from{font-size:.65rem;color:var(--t3)}
.pf-gift{display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;margin-bottom:.5rem}
.pf-gift-emoji{font-size:1.4rem}
.pf-gift-info{flex:1;min-width:0}
.pf-gift-name{font-size:.82rem;color:var(--t1);font-weight:500}
.pf-gift-from{font-size:.65rem;color:var(--t3)}
.pf-gift-msg{font-size:.72rem;color:var(--t2);font-style:italic;margin-top:.1rem}
.pf-actions{display:flex;gap:.5rem;margin-top:1rem;flex-wrap:wrap;justify-content:center}
.pf-act-btn{padding:.5rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t2);font-size:.78rem;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:.4rem;transition:.15s}
.pf-act-btn:active{background:var(--ac);color:#fff;border-color:var(--ac)}
.pf-empty{font-size:.8rem;color:var(--t3);text-align:center;padding:1rem;font-style:italic}

/* GIFT PICKER MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:200;display:flex;align-items:flex-end;justify-content:center;animation:mfade .25s ease;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
@keyframes mfade{from{opacity:0}to{opacity:1}}
.modal-sheet{width:100%;max-width:420px;max-height:75vh;background:linear-gradient(180deg,var(--s2),var(--s1));border-radius:24px 24px 0 0;padding:1.2rem;overflow-y:auto;animation:mslide .3s cubic-bezier(.22,1,.36,1);padding-bottom:max(env(safe-area-inset-bottom),1.2rem)}
@keyframes mslide{from{transform:translateY(100%)}to{transform:none}}
.modal-handle{width:36px;height:4px;border-radius:2px;background:var(--b1);margin:0 auto .8rem}
.modal-title{font-size:1rem;font-weight:700;text-align:center;margin-bottom:1rem}
.gift-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:1rem}
.gift-option{padding:.8rem;background:var(--s2);border:1px solid var(--b1);border-radius:14px;text-align:center;cursor:pointer;transition:.15s}
.gift-option:active{border-color:var(--ac);background:var(--gw)}
.gift-option .g-emoji{font-size:1.6rem}
.gift-option .g-name{font-size:.78rem;font-weight:600;color:var(--t1);margin-top:.3rem}
.gift-option .g-desc{font-size:.62rem;color:var(--t3);margin-top:.2rem}
.decl-input{width:100%;padding:.8rem;background:var(--s2);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:.88rem;font-family:inherit;resize:none;outline:none;min-height:80px}
.decl-input:focus{border-color:var(--ac)}
.decl-counter{font-size:.6rem;color:var(--t3);text-align:right;margin-top:.3rem}
.gift-msg-input{width:100%;padding:.6rem;background:var(--s2);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;margin-top:.6rem}
.gift-msg-input:focus{border-color:var(--ac)}

/* ADDRESS REQUEST BANNER */
.addr-request{padding:.8rem 1rem;background:linear-gradient(135deg,rgba(255,107,53,.08),rgba(255,61,113,.05));border:1px solid rgba(255,107,53,.15);border-radius:14px;margin:.5rem .8rem;animation:mi .3s ease}
.addr-request-text{font-size:.82rem;color:var(--t1);line-height:1.5;margin-bottom:.6rem}
.addr-request-note{font-size:.68rem;color:var(--t3);margin-bottom:.6rem;font-style:italic}
.addr-input{width:100%;padding:.6rem;background:var(--s2);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;margin-bottom:.5rem}
.addr-input:focus{border-color:var(--ac)}
.addr-actions{display:flex;gap:.5rem}
.addr-btn{padding:.4rem .8rem;border-radius:10px;font-size:.75rem;font-family:inherit;cursor:pointer;border:none}
.addr-btn.accept{background:var(--ac);color:#fff}
.addr-btn.decline{background:var(--s2);color:var(--t2);border:1px solid var(--b1)}

/* LOCATION / EVENTS */
#locationScreen{flex-direction:column;background:var(--bg)}
#eventDetail{flex-direction:column;background:var(--bg)}
.loc-header{display:flex;align-items:center;gap:.8rem;padding:.8rem 1rem;background:var(--s1);border-bottom:1px solid var(--b1);padding-top:max(env(safe-area-inset-top),1rem)}
.loc-header h2{font-size:1rem;font-weight:600;flex:1}
.loc-header .bs{font-size:.68rem;padding:.3rem .7rem}
.loc-scroll{flex:1;overflow-y:auto;padding:1rem;-webkit-overflow-scrolling:touch}
.loc-status{text-align:center;padding:.7rem;font-size:.75rem;color:var(--t2);background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin-bottom:.8rem;display:flex;align-items:center;justify-content:center;gap:.4rem}
.loc-status.active{border-color:var(--ok);color:var(--ok);background:rgba(52,211,153,.05)}
.loc-status.error{border-color:var(--err);color:var(--err)}
.loc-tabs{display:flex;gap:.3rem;margin-bottom:.8rem;background:var(--s1);border-radius:12px;padding:.25rem;border:1px solid var(--b1)}
.loc-tab{flex:1;padding:.45rem;text-align:center;font-size:.75rem;font-weight:600;background:transparent;border:none;border-radius:10px;color:var(--t3);cursor:pointer;font-family:inherit;transition:.2s}
.loc-tab.active{background:var(--ac);color:#fff;box-shadow:0 2px 8px rgba(255,107,53,.3)}
.loc-person{display:flex;align-items:center;gap:.6rem;padding:.65rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin-bottom:.5rem;transition:.15s;animation:mi .3s ease}
.loc-person:active{background:var(--s2);transform:scale(.98)}
.loc-person-info{flex:1;min-width:0}
.loc-person-nick{font-size:.82rem;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.loc-person-dist{font-size:.62rem;color:var(--t3);margin-top:.1rem}
.loc-person-pts{font-size:.65rem;color:var(--ac);margin-top:.1rem}
.loc-encosta-btn{padding:.35rem .7rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:10px;color:#fff;font-size:.68rem;font-weight:700;cursor:pointer;font-family:inherit;flex-shrink:0;letter-spacing:.03em;box-shadow:0 2px 8px rgba(255,107,53,.2);transition:.15s}
.loc-encosta-btn:active{transform:scale(.94)}
.evt-card{padding:.8rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin-bottom:.5rem;transition:.15s;animation:mi .3s ease}
.evt-card:active{background:var(--s2);transform:scale(.98)}
.evt-card-name{font-size:.88rem;font-weight:700;color:var(--t1);margin-bottom:.25rem}
.evt-card-meta{font-size:.65rem;color:var(--t3);display:flex;gap:.8rem;margin-bottom:.25rem}
.evt-card-desc{font-size:.72rem;color:var(--t2);font-style:italic;line-height:1.4}
.evt-card-people{font-size:.65rem;color:var(--ac);margin-top:.25rem;font-weight:500}
.evt-detail{padding:1.2rem;background:var(--s1);border:1px solid var(--b1);border-radius:16px;margin-bottom:1rem}
.evt-detail-name{font-size:1.05rem;font-weight:700;color:var(--t1);margin-bottom:.4rem}
.evt-detail-desc{font-size:.8rem;color:var(--t2);font-style:italic;margin-bottom:.8rem;line-height:1.5;padding:.5rem .6rem;background:var(--s2);border-radius:10px}
.evt-ppl-title{font-size:.7rem;color:var(--t2);text-transform:uppercase;letter-spacing:.1em;font-weight:600;margin-bottom:.5rem}
.loc-create-form{padding:1.2rem;background:var(--s1);border:1px solid var(--b1);border-radius:16px;margin-bottom:1rem;animation:mi .3s ease}
.loc-create-form .form-title{font-size:.92rem;font-weight:700;color:var(--t1);margin-bottom:.3rem}
.loc-create-form .form-sub{font-size:.68rem;color:var(--t3);margin-bottom:1rem;line-height:1.4}
.loc-fg{margin-bottom:.8rem}
.loc-fg label{display:block;font-size:.65rem;color:var(--t2);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.3rem;font-weight:600}
.loc-fg input,.loc-fg textarea{width:100%;padding:.65rem .8rem;background:var(--s2);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s}
.loc-fg textarea{min-height:60px;resize:none}
.loc-fg input:focus,.loc-fg textarea:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.loc-empty{text-align:center;padding:2.5rem 1rem;color:var(--t3);font-size:.82rem;line-height:1.6}
.loc-empty-icon{font-size:2rem;margin-bottom:.6rem;opacity:.5}

/* REVEAL EXTRAS */
.rv-last{font-size:.68rem;color:var(--t3);margin-top:.4rem;padding:.3rem .8rem;background:var(--s1);border-radius:10px;border:1px solid var(--b1)}

/* CONTACT REQUEST */
.contact-menu{display:flex;gap:.3rem;flex-wrap:wrap;padding:.4rem .8rem;animation:mi .3s ease}
.contact-opt{padding:.3rem .6rem;font-size:.68rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;color:var(--t2);cursor:pointer;font-family:inherit}
.contact-opt:active{background:var(--s2)}
.contact-req-banner{padding:.6rem .8rem;background:linear-gradient(135deg,rgba(255,107,53,.06),rgba(255,61,113,.04));border:1px solid rgba(255,107,53,.12);border-radius:12px;margin:.4rem .8rem;animation:mi .3s ease}
.contact-req-text{font-size:.78rem;color:var(--t1);margin-bottom:.4rem}
.contact-req-actions{display:flex;gap:.4rem}
.contact-req-input{width:100%;padding:.4rem .6rem;background:var(--s2);border:1px solid var(--b1);border-radius:8px;color:var(--t1);font-size:.78rem;font-family:inherit;outline:none;margin-bottom:.4rem}

/* ENCOSTA REQUEST NOTIFICATION */
.encosta-req-banner{position:fixed;top:max(env(safe-area-inset-top),1rem);left:1rem;right:1rem;padding:1rem;background:var(--s1);border:1px solid var(--ac);border-radius:16px;z-index:9000;animation:mi .3s ease;box-shadow:0 8px 30px rgba(0,0,0,.5)}
.encosta-req-title{font-size:.82rem;font-weight:600;color:var(--t1);margin-bottom:.4rem}
.encosta-req-sub{font-size:.68rem;color:var(--t3);margin-bottom:.6rem}
.encosta-req-actions{display:flex;gap:.5rem}

/* LANG SWITCHER */
.lang-sw{display:flex;gap:.25rem}
.lang-btn{padding:.15rem .35rem;background:transparent;border:1px solid rgba(255,255,255,.06);border-radius:6px;color:var(--t3);font-size:.52rem;font-weight:600;cursor:pointer;font-family:inherit;text-transform:uppercase;transition:.15s}
.lang-btn.active{color:var(--ac);border-color:rgba(255,107,53,.3)}

/* GORJETA / TIP */
#tipScreen{padding:1.5rem;padding-top:max(env(safe-area-inset-top),1rem);overflow-y:auto}
.tip-header{display:flex;align-items:center;gap:.8rem;margin-bottom:1.5rem}
.tip-receiver{display:flex;flex-direction:column;align-items:center;gap:.6rem;text-align:center;margin-bottom:1.5rem}
.tip-receiver-avatar{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:800;color:#fff;border:2px solid var(--ac)}
.tip-receiver-name{font-size:1.1rem;font-weight:600;color:var(--t1)}
.tip-receiver-service{font-size:.72rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;font-weight:500}
.tip-amounts{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin-bottom:1.2rem}
.tip-amount-btn{padding:.8rem .4rem;background:var(--s1);border:1.5px solid rgba(255,255,255,.06);border-radius:14px;color:var(--t1);font-size:1rem;font-weight:700;font-family:inherit;cursor:pointer;transition:.15s;text-align:center}
.tip-amount-btn:active,.tip-amount-btn.selected{background:var(--ac);border-color:var(--ac);color:#fff;transform:scale(.96)}
.tip-custom{display:flex;align-items:center;gap:.6rem;margin-bottom:1.5rem}
.tip-custom label{font-size:.75rem;color:var(--t3);font-weight:500;white-space:nowrap}
.tip-custom input{flex:1;padding:.7rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:1.1rem;font-family:inherit;outline:none;text-align:center}
.tip-custom input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.tip-card-section{margin-bottom:1.5rem}
.tip-card-section h3{font-size:.75rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;font-weight:600;margin-bottom:.8rem}
.tip-card-fields{display:flex;flex-direction:column;gap:.6rem}
.tip-card-row{display:flex;gap:.5rem}
.tip-field{flex:1;padding:.7rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;min-height:42px}
.tip-field iframe{border:none!important;height:24px!important}
.tip-input{width:100%;padding:.7rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:14px;font-family:inherit;outline:none;margin-top:.4rem}
.tip-input::placeholder{color:#555568}
.tip-pay-btn{width:100%;padding:1rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:16px;color:#fff;font-size:.95rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.04em;box-shadow:0 4px 15px rgba(255,107,53,.3);transition:.15s}
.tip-pay-btn:active{transform:scale(.97)}
.tip-pay-btn:disabled{opacity:.4}
.tip-result{display:flex;flex-direction:column;align-items:center;gap:.8rem;text-align:center;padding:2rem 0}
.tip-result-icon{font-size:3rem}
.tip-result-text{font-size:.9rem;color:var(--t2);font-weight:300;line-height:1.6}
/* Prestador register */
#prestadorReg{padding:1.5rem;padding-top:max(env(safe-area-inset-top),1rem);overflow-y:auto}
.preg-title{font-size:1.2rem;font-weight:700;color:var(--ac);margin-bottom:.3rem}
.preg-sub{font-size:.75rem;color:var(--t3);margin-bottom:1.5rem;line-height:1.5}
.preg-services{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:1.5rem}
.preg-svc{padding:.7rem .6rem;background:var(--s1);border:1.5px solid rgba(255,255,255,.06);border-radius:12px;color:var(--t2);font-size:.75rem;font-family:inherit;cursor:pointer;text-align:center;transition:.15s}
.preg-svc:active,.preg-svc.selected{background:var(--ac);border-color:var(--ac);color:#fff}
.preg-mp-status{padding:.8rem 1rem;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.2);border-radius:12px;font-size:.75rem;color:var(--ok);text-align:center;margin-bottom:1rem}
.preg-mp-status.pending{background:rgba(251,191,36,.08);border-color:rgba(251,191,36,.2);color:var(--warn)}

/* ONBOARDING */
#onboarding{padding:0;overflow:hidden;background:var(--bg)}
.onb-slides{display:flex;transition:transform .4s cubic-bezier(.22,1,.36,1);height:100%}
.onb-slide{min-width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2.5rem 2rem;text-align:center;position:relative}
.onb-icon{font-size:3.5rem;margin-bottom:1.5rem;opacity:0;animation:fi .8s ease .3s forwards}
.onb-title{font-size:1.4rem;font-weight:800;color:var(--t1);margin-bottom:.6rem;letter-spacing:-.02em;opacity:0;animation:fi .8s ease .5s forwards}
.onb-desc{font-size:.85rem;color:var(--t2);line-height:1.7;max-width:280px;opacity:0;animation:fi .8s ease .7s forwards}
.onb-dots{position:absolute;bottom:max(env(safe-area-inset-bottom),2rem);left:50%;transform:translateX(-50%);display:flex;gap:.5rem}
.onb-dot{width:8px;height:8px;border-radius:50%;background:var(--b1);transition:all .3s}
.onb-dot.active{background:var(--ac);width:24px;border-radius:4px}
.onb-nav{position:absolute;bottom:calc(max(env(safe-area-inset-bottom),2rem) + 2rem);left:50%;transform:translateX(-50%);display:flex;gap:.8rem;align-items:center}
.onb-skip{padding:.5rem 1rem;background:transparent;border:none;color:var(--t3);font-size:.78rem;font-family:inherit;cursor:pointer}
.onb-next{padding:.6rem 1.8rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:14px;color:#fff;font-size:.85rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.04em}
.onb-next:active{transform:scale(.96)}

/* ZODIAC */
/* Zodiac area — poetic, constellation-style */
.zodiac-area{margin-top:.8rem;opacity:0;animation:fi 1.5s ease 5s forwards;display:flex;flex-direction:column;align-items:center;gap:.8rem}
.zodiac-elements{font-size:.68rem;color:var(--t3);letter-spacing:.2em;text-transform:lowercase;font-weight:300}
.zodiac-elements em{color:var(--ac2);font-style:normal;font-weight:500;letter-spacing:.1em}
/* Constellation glyphs — large, elegant, thin */
.zodiac-constellation{display:flex;align-items:center;gap:1.8rem;justify-content:center}
.zc-sign{display:flex;flex-direction:column;align-items:center;gap:.4rem}
.zc-glyph{width:56px;height:56px;border-radius:50%;background:transparent;border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:1.8rem;color:var(--t1);font-weight:200;position:relative;overflow:hidden}
.zc-glyph::before{content:'';position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.06) 0%,transparent 70%)}
.zc-glyph::after{content:'';position:absolute;inset:-1px;border-radius:50%;border:1px solid transparent;background:conic-gradient(from 0deg,rgba(255,107,53,.15),transparent 30%,transparent 70%,rgba(255,61,113,.15)) border-box;-webkit-mask:linear-gradient(#fff 0 0) padding-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude}
.zc-trait{font-size:.52rem;color:var(--t3);text-transform:uppercase;letter-spacing:.15em;font-weight:500}
.zc-name{font-size:.5rem;color:rgba(255,255,255,.2);letter-spacing:.08em;font-weight:400}
.zc-bridge{display:flex;flex-direction:column;align-items:center;gap:.3rem}
.zc-line{width:30px;height:1px;background:linear-gradient(90deg,rgba(255,107,53,.3),rgba(255,61,113,.3));position:relative}
.zc-line::after{content:'';position:absolute;top:-2px;left:50%;transform:translateX(-50%);width:5px;height:5px;border-radius:50%;background:var(--ac);opacity:.4;box-shadow:0 0 8px var(--ac)}
/* Zodiac phrase — pure poetry, no box */
.zodiac-phrase{font-size:.85rem;color:var(--t2);font-style:italic;line-height:1.7;max-width:260px;text-align:center;font-weight:300;letter-spacing:.01em}

/* REVEAL SELFIE v2 — side by side */

/* CONNECTING OVERLAY — after sonic match, before reveal */
/* Connecting overlay — organic cosmos birth */
/* ═══ CONNECTING OVERLAY — ELECTRIC TOUCH ═══ */
.connecting-overlay{position:fixed;inset:0;z-index:150;background:#020205;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.connecting-overlay.active{opacity:1;pointer-events:auto}
.co-canvas-el{position:absolute;inset:0;z-index:0}
/* Phones container */
.co-phones{position:relative;z-index:2;display:flex;align-items:center;justify-content:center;gap:0;opacity:0;animation:co-phones-in .8s ease .2s forwards}
@keyframes co-phones-in{0%{opacity:0;gap:80px}60%{gap:2px;opacity:1}80%{gap:6px}100%{gap:3px;opacity:1}}
.co-phone{width:52px;height:88px;border-radius:10px;border:2px solid rgba(255,255,255,.5);position:relative;overflow:hidden;background:rgba(10,10,20,.9)}
.co-phone.left{transform:rotate(-8deg);border-color:rgba(255,255,255,.4)}
.co-phone.right{transform:rotate(8deg);border-color:rgba(255,255,255,.4)}
.co-phone-screen{position:absolute;inset:4px 3px;border-radius:6px;overflow:hidden}
.co-phone-notch{position:absolute;top:2px;left:50%;transform:translateX(-50%);width:16px;height:3px;border-radius:2px;background:rgba(255,255,255,.15);z-index:1}
.co-phone-btn{position:absolute;bottom:3px;left:50%;transform:translateX(-50%);width:8px;height:8px;border-radius:50%;border:1px solid rgba(255,255,255,.12)}
/* Electric canvas fills each phone screen */
.co-phone-canvas{width:100%;height:100%;display:block}
/* Center spark point */
.co-spark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:6px;height:6px;border-radius:50%;z-index:3;opacity:0}
.connecting-overlay.active .co-spark{animation:co-spark-pulse 4s ease forwards}
@keyframes co-spark-pulse{0%{opacity:0;width:2px;height:2px}10%{opacity:1;width:10px;height:10px;box-shadow:0 0 30px 15px var(--co-glow,rgba(255,255,255,.7)),0 0 80px 30px var(--co-glow2,rgba(255,255,255,.3))}25%{width:14px;height:14px;box-shadow:0 0 50px 20px var(--co-glow,rgba(255,255,255,.8)),0 0 120px 50px var(--co-glow2,rgba(255,255,255,.4)),0 0 200px 80px var(--co-glow3,rgba(255,255,255,.1))}50%{width:8px;height:8px;opacity:1;box-shadow:0 0 30px 10px var(--co-glow,rgba(255,255,255,.5)),0 0 80px 30px var(--co-glow2,rgba(255,255,255,.2))}100%{width:4px;height:4px;opacity:.6;box-shadow:0 0 20px 8px var(--co-glow,rgba(255,255,255,.3))}}
/* Flash overlay */
.co-flash{position:absolute;inset:0;z-index:4;pointer-events:none;opacity:0}
.connecting-overlay.active .co-flash{animation:co-fullflash 3.5s ease forwards}
@keyframes co-fullflash{0%{opacity:0}8%{opacity:.7}12%{opacity:0}20%{opacity:.4}24%{opacity:0}35%{opacity:.2}38%{opacity:0}55%{opacity:.15}58%{opacity:0}100%{opacity:0}}
/* Text */
.co-text{position:relative;z-index:5;margin-top:2rem;font-size:.88rem;font-weight:300;letter-spacing:.12em;opacity:0;animation:co-text-in 1.5s ease .6s forwards}
@keyframes co-text-in{0%{opacity:0;transform:translateY(10px);filter:blur(4px)}100%{opacity:.8;transform:translateY(0);filter:blur(0)}}
.co-dots{position:relative;z-index:5;display:flex;gap:5px;margin-top:.5rem}
.co-dots span{width:5px;height:5px;border-radius:50%;opacity:.3;animation:co-dot-beat 1.2s ease-in-out infinite}
.co-dots span:nth-child(2){animation-delay:.2s}
.co-dots span:nth-child(3){animation-delay:.4s}
@keyframes co-dot-beat{0%,100%{opacity:.2;transform:scale(.7)}50%{opacity:1;transform:scale(1.3)}}
/* Color themes */
.connecting-overlay.first{--co-color:rgba(255,255,255,.9);--co-glow:rgba(255,255,255,.7);--co-glow2:rgba(200,220,255,.4);--co-glow3:rgba(180,200,255,.15)}
.connecting-overlay.first .co-spark{background:#fff}
.connecting-overlay.first .co-flash{background:radial-gradient(circle at 50% 50%,rgba(255,255,255,.5),rgba(200,220,255,.2),transparent 70%)}
.connecting-overlay.first .co-dots span{background:#fff}
.connecting-overlay.first .co-text{color:rgba(255,255,255,.8)}
.connecting-overlay.renewed{--co-color:rgba(255,200,60,.9);--co-glow:rgba(255,200,60,.7);--co-glow2:rgba(255,170,30,.4);--co-glow3:rgba(255,140,0,.15)}
.connecting-overlay.renewed .co-spark{background:#ffc83c}
.connecting-overlay.renewed .co-flash{background:radial-gradient(circle at 50% 50%,rgba(255,200,60,.4),rgba(255,160,30,.15),transparent 70%)}
.connecting-overlay.renewed .co-dots span{background:#ffc83c}
.connecting-overlay.renewed .co-text{color:rgba(255,210,80,.8)}

/* UTILS */
.hidden{display:none!important}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);padding:.7rem 1.5rem;background:rgba(24,24,36,.92);border:1px solid rgba(255,255,255,.1);border-radius:20px;color:var(--t1);font-size:.82rem;z-index:9999;pointer-events:none;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);box-shadow:0 8px 32px rgba(0,0,0,.4);max-width:85%;text-align:center;font-weight:500}
@keyframes toast-in{0%{opacity:0;transform:translateX(-50%) translateY(12px) scale(.95)}100%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}
@keyframes toast-out{0%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}100%{opacity:0;transform:translateX(-50%) translateY(-8px) scale(.95)}}
@keyframes tin{from{opacity:0;transform:translateX(-50%) translateY(12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
::-webkit-scrollbar{width:2px}::-webkit-scrollbar-thumb{background:var(--b1);border-radius:2px}
</style>
</head>
<body>

<div class="connecting-overlay" id="connectingOverlay">
  <canvas class="co-canvas-el" id="coCanvas"></canvas>
  <div class="co-flash" id="coFlash"></div>
  <div class="co-phones" id="coPhones">
    <div class="co-phone left">
      <div class="co-phone-notch"></div>
      <div class="co-phone-screen"><canvas class="co-phone-canvas" id="coPhoneL" width="92" height="160"></canvas></div>
      <div class="co-phone-btn"></div>
    </div>
    <div class="co-phone right">
      <div class="co-phone-notch"></div>
      <div class="co-phone-screen"><canvas class="co-phone-canvas" id="coPhoneR" width="92" height="160"></canvas></div>
      <div class="co-phone-btn"></div>
    </div>
  </div>
  <div class="co-spark" id="coSpark"></div>
  <div class="co-text" id="coText">algo está nascendo...</div>
  <div class="co-dots"><span></span><span></span><span></span></div>
</div>

<div id="splash" class="screen active">
  <div class="logo">Touch?</div>
  <div class="tag">tudo nasce no gesto</div>
  <div style="position:absolute;bottom:max(env(safe-area-inset-bottom),2rem);font-size:.55rem;color:var(--t3);letter-spacing:.15em;opacity:.4">touchirl v3.0</div>
</div>

<div id="onboarding" class="screen">
  <div class="onb-slides" id="onbSlides">
    <div class="onb-slide">
      <div class="onb-icon">&#x2726;</div>
      <div class="onb-title">Tudo nasce no gesto</div>
      <div class="onb-desc">Touch? transforma encontros em momentos conscientes. Conexões só existem quando duas pessoas decidem estar presentes.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x1F91D;</div>
      <div class="onb-title">Toque para conectar</div>
      <div class="onb-desc">Encoste os celulares, mostre o QR ou use código. Vocês se conectam por 24 horas.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x23F3;</div>
      <div class="onb-title">24 horas, depois se dissolve</div>
      <div class="onb-desc">Cada conexão dura 24h. Conversem, presenteiem, declarem. Se quiserem mais tempo, encostem de novo.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x1F525;</div>
      <div class="onb-title">Streaks e estrelas</div>
      <div class="onb-desc">Encontros seguidos criam streaks com conquistas. Relações especiais geram estrelas que ficam para sempre no seu perfil.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x2648;</div>
      <div class="onb-title">Signos e compatibilidade</div>
      <div class="onb-desc">A cada encontro, os astros falam. Uma frase única baseada nos signos dos dois revela a energia da conexão.</div>
    </div>
  </div>
  <div class="onb-nav">
    <button class="onb-skip" onclick="skipOnboarding()">Pular</button>
    <button class="onb-next" id="onbNextBtn" onclick="nextOnbSlide()">Próximo</button>
  </div>
  <div class="onb-dots" id="onbDots"></div>
</div>

<div id="login" class="screen">
  <div class="login-logo">Touch?</div>
  <div class="login-sub">encontros reais, conexões efêmeras</div>
  <button class="login-google" onclick="loginWithGoogle()">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
    Entrar com Google
  </button>
  <div class="login-divider">ou</div>
  <div class="login-form" id="loginForm">
    <input type="email" class="login-input" id="loginEmail" placeholder="E-mail" autocomplete="email">
    <input type="password" class="login-input" id="loginPass" placeholder="Senha" autocomplete="current-password">
    <input type="text" class="login-input hidden" id="loginNick" placeholder="Nickname (será seu nome anônimo)" maxlength="20" autocomplete="off">
    <div class="login-nick-explain hidden" id="loginNickExplain">Seu nickname é como as pessoas te veem antes de você revelar quem é de verdade.</div>
    <button class="bp" id="loginBtn" onclick="loginWithEmail()">ENTRAR</button>
    <div class="login-err" id="loginErr"></div>
    <div class="login-toggle" id="loginToggle" onclick="toggleLoginMode()">Não tem conta? <strong>Criar agora — é rápido</strong></div>
  </div>
</div>

<div id="register" class="screen">
  <div class="rh"><h1>Touch?</h1><p>complete sua presença</p></div>
  <div class="avs">
    <div class="avp" id="avatarPreview" style="background:var(--s2)">?</div>
    <div class="nick-hint" id="nickHint">escolha seu nickname</div>
  </div>
  <div class="fg"><label>Nickname</label><input type="text" id="regNick" placeholder="seu_nick" maxlength="20" autocomplete="off" oninput="checkNick(this.value)"></div>
  <div class="reg-nick-info">Este é o nome que todos verão. Seu nome real só aparece quando você decide revelar sua identidade para alguém.</div>
  <div class="fg"><label>Data de nascimento</label><input type="date" id="regBirth"></div>
  <div class="tc"><input type="checkbox" id="regTerms"><span>Entendo e aceito que <strong>todas as relações aqui são temporárias</strong>. Nada persiste sem encontro.</span></div>
  <button class="bp" onclick="doRegister()">ENTRAR</button>
</div>

<div id="home" class="screen">
  <canvas id="homeNodesCanvas" style="position:absolute;inset:0;z-index:0;pointer-events:none"></canvas>
  <div class="ptr-indicator" id="ptrIndicator"><div class="ptr-spinner"></div></div>
  <div class="fire-overlay" id="fireOverlay">
    <div class="fire-glow"></div><div class="fire-glow2"></div>
    <div class="fire-particles"><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div></div>
    <div class="fire-edge left"></div><div class="fire-edge right"></div>
    <div class="fire-speaker"><div class="fire-spk-wave"></div><div class="fire-spk-wave"></div><div class="fire-spk-wave"></div></div>
    <div class="sonic-instruct" id="sonicInstruct">
      <div class="si-scene">
        <div class="si-phone left">
          <div class="si-speaker"><div class="si-spk-dot"></div><div class="si-spk-dot"></div><div class="si-spk-dot"></div></div>
        </div>
        <div class="si-energy">
          <div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div>
        </div>
        <div class="si-glow"></div>
        <div class="si-phone right">
          <div class="si-speaker"><div class="si-spk-dot"></div><div class="si-spk-dot"></div><div class="si-spk-dot"></div></div>
        </div>
      </div>
      <div class="si-label">🔊 alto-falante ↔ alto-falante 🔊</div>
      <div class="si-text">Encoste os <em>alto-falantes</em><br>um no outro</div>
    </div>
  </div>
  <!-- TOP: perfil+nick+nome real à esquerda, chat+rede à direita -->
  <div class="home-top">
    <div class="home-user" onclick="showMyProfileSheet()">
      <div class="home-avatar" id="homeAvatar"></div>
      <div class="home-user-info">
        <div class="hg" id="homeGreeting">Olá</div>
        <div class="home-realname" id="homeRealName"></div>
        <div class="home-user-meta"><div class="cd" id="connDot"></div></div>
      </div>
    </div>
    <div class="home-icons">
      <div class="constellation-btn hidden" id="constBtn" onclick="showHistory()">&#x2726;</div>
      <div class="rb hidden" id="relBadge" onclick="showRelations()">&#x1F4AC;<span class="ct" id="relCount">0</span></div>
    </div>
  </div>
  <!-- CENTER: botão TOUCH grande -->
  <div class="hc">
    <div class="hm" id="homeMotivation">Nada acontece<br>à distância.</div>
    <div style="position:relative;display:flex;align-items:center;justify-content:center">
      <div class="sonic-bars left" id="sonicBarsL"><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div></div>
      <button class="be" id="mainBtn" onclick="handleMainButton()">
        <span class="be-icon"><svg width="44" height="44" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="6" width="14" height="24" rx="3" stroke="#fff" stroke-width="1.8" fill="none" transform="rotate(-12 11 18)"/><rect x="26" y="6" width="14" height="24" rx="3" stroke="#fff" stroke-width="1.8" fill="none" transform="rotate(12 33 18)"/><circle cx="11" cy="26" r="1.2" fill="#fff" opacity=".5" transform="rotate(-12 11 26)"/><circle cx="33" cy="26" r="1.2" fill="#fff" opacity=".5" transform="rotate(12 33 26)"/><path d="M18 16 L26 16" stroke="#fff" stroke-width="1.5" stroke-linecap="round" opacity=".6" stroke-dasharray="2 2"/><circle cx="22" cy="16" r="3" fill="rgba(255,255,255,.15)" stroke="#fff" stroke-width="1" opacity=".7"/></svg></span>
        <span class="be-text" id="mainBtnText">TOUCH</span>
      </button>
      <div class="sonic-bars right" id="sonicBarsR"><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div></div>
    </div>
    <div class="sonic-status" id="sonicHomeStatus"></div>
    <div class="sonic-fallback" id="sonicFallback">
      <button class="bs" onclick="startEncounter()" style="font-size:.75rem">&#x1F511; Conectar por código</button>
    </div>
    <div class="daily-counter hidden" id="dailyCounter">Hoje: <strong id="dailyNum">0</strong> encontros</div>
  </div>
  <!-- BOTTOM: minimal — only location + tutorial -->
  <div class="home-bottom">
    <div class="home-nav">
      <button class="hn-btn" onclick="openLocationScreen()"><span class="hn-ico">📍</span><span class="hn-lbl" data-i18n="loc_btn">Local</span></button>
      <button class="hn-btn" onclick="showTutorial()"><span class="hn-ico">❓</span><span class="hn-lbl">Ajuda</span></button>
    </div>
    <div class="home-brand-row">
      <span class="home-brand" id="homeBrand">Touch?</span>
    </div>
  </div>
</div>

<div id="encounter" class="screen">
  <div class="ep active" id="phaseChoose">
    <div class="et">Como vão se encontrar?</div>
    <button class="bp" style="max-width:280px" onclick="createSession()">GERAR CÓDIGO</button>
    <div class="od">ou</div>
    <div class="cir"><input type="text" id="joinCodeInput" placeholder="ENC-000" maxlength="7" autocomplete="off"><button onclick="joinSession()">&#x2192;</button></div>
    <div class="od">ou</div>
    <button class="bp" style="max-width:280px;background:linear-gradient(135deg,#ff6b35,#e05520)" onclick="startSonicMode()">📲 TOUCH — encostar celulares</button>
    <button class="bs" style="margin-top:1.5rem" onclick="goHome()">&#x2190; Voltar</button>
  </div>
  <div class="ep" id="phaseBump">
    <div class="et">Encoste seu celular no da outra pessoa</div>
    <div class="bump-circle" id="bumpCircle">
      <span style="font-size:2rem">📳</span>
      <span style="font-size:.7rem;font-weight:600;letter-spacing:.1em;color:rgba(255,255,255,.85)" id="bumpLabel">PREPARANDO...</span>
    </div>
    <div style="font-size:.75rem;color:var(--t3);max-width:240px;text-align:center;line-height:1.6" id="bumpStatus">Ativando sensores...</div>
    <button class="bs" onclick="stopSonicMode();showPhase('phaseChoose')">&#x2190; Cancelar</button>
  </div>
  <div class="ep" id="phaseCode">
    <div class="et">Peça para a outra pessoa digitar:</div>
    <div class="cdsp" id="sessionCode">ENC-000</div>
    <div class="qb"><canvas id="qrCanvas"></canvas></div>
    <div style="font-size:.75rem;color:var(--t3)">Esperando alguém conectar...</div>
    <div class="wd"><span>&#x25CF;</span><span>&#x25CF;</span><span>&#x25CF;</span></div>
    <button class="bs" onclick="goHome()">Cancelar</button>
  </div>
</div>

<div id="reveal" class="screen">
  <canvas id="rvLightBeam" class="rv-light-beam"></canvas>
  <div class="rv-wrap">
    <div class="rv-center">
      <div class="rv-moment" id="revealMoment">algo nasceu entre vocês</div>
      <div class="rv-phrase" id="revealPhrase"></div>
      <div class="rv-sub">essa é a marca desse encontro</div>
      <div class="rv-avatars" id="revealAvatars">
        <div class="rv-avatar-wrap" id="rvAvatarMe">
          <div id="rvAvatarMeInner"></div>
          <div class="rv-avatar-name" id="rvNameMe"></div>
        </div>
        <div class="rv-connection-symbol">
          <div class="rv-connection-dot"></div>
        </div>
        <div class="rv-avatar-wrap" id="rvAvatarThem">
          <div id="rvAvatarThemInner"></div>
          <div class="rv-avatar-name" id="rvNameThem"></div>
        </div>
      </div>
      <div class="rv-renewed hidden" id="revealRenewed">vocês se encontraram de novo</div>
      <div class="rv-last hidden" id="revealLast"></div>
      <div id="zodiacArea" class="zodiac-area hidden"></div>
    </div>
    <video id="selfieVideo" autoplay playsinline style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:1.5px solid rgba(255,255,255,.15);display:none;margin:0 auto"></video>
    <canvas id="selfieCanvas" style="display:none"></canvas>
    <div id="selfiePreview" style="display:none;margin:0 auto"></div>
    <div class="rv-actions" id="revealActions">
      <div class="rv-btn-row">
        <button type="button" class="rv-btn-enter" onclick="enterChat()">Abrir conexão</button>
        <button type="button" class="rv-btn-skip" onclick="goHome()">Pular</button>
      </div>
      <div class="rv-sec-row">
        <button type="button" class="rv-btn-mini" id="selfieCapBtn" onclick="revealCaptureSelfie()"><span class="rv-ico">📸</span>Selfie</button>
        <button type="button" class="rv-btn-mini hidden" id="revealTipBtn" onclick="openTipFromReveal()"><span class="rv-ico">💲</span><span id="revealTipLabel">Gorjeta</span></button>
      </div>
    </div>
  </div>
</div>

<div id="chat" class="screen">
  <!-- Clean header: back + name + timer pill -->
  <div class="ch">
    <div class="chl">
      <button class="chb" onclick="goHome()">&#x2190;</button>
      <div class="ch-info" onclick="showPartnerProfile()">
        <span class="chn" id="chatPartner">Pessoa</span>
        <span class="ch-sub" id="chatSub"></span>
      </div>
    </div>
    <div class="cht" id="chatTimer">23:59:59</div>
  </div>
  <!-- Phrase banner -->
  <div class="cpb" id="chatPhrase"></div>
  <!-- Streak (collapsible) -->
  <div class="streak-info hidden" id="chatStreak"><span id="chatStreakText"></span><div class="streak-progress"><div class="streak-bar" id="chatStreakBar"></div></div><span id="chatStreakNext" style="font-size:.6rem;color:var(--t3)"></span></div>
  <div id="contactRequestArea"></div>
  <!-- Messages -->
  <div class="cms" id="chatMessages"><div class="ti" id="typingIndicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
  <!-- Quick phrases -->
  <div class="qp-bar" id="quickPhrases"></div>
  <!-- Bottom: input + expandable menu -->
  <div class="chat-bottom" style="position:relative">
    <!-- ID action buttons (only visible when relevant) -->
    <div class="chat-id-bar" id="chatIdBar">
      <button class="id-pill request" onclick="requestIdentity()" type="button" id="requestIdBtn">🔓 Pedir ID</button>
      <button class="id-pill reveal" onclick="revealIdentity(state.currentPartnerId)" type="button" id="revealIdBtn">🪪 Revelar meu ID</button>
    </div>
    <!-- Plus menu (all actions here) -->
    <div class="plus-menu" id="plusMenu">
      <button class="pm-item" onclick="pickPhoto();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(88,166,255,.15);color:#58a6ff">📷</div><span class="pm-label">Foto</span></button>
      <button class="pm-item" onclick="requestSelfie();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(255,200,87,.12);color:#ffc857">🤳</div><span class="pm-label">Selfie</span></button>
      <button class="pm-item" onclick="openContactMenu();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(163,113,247,.12);color:#a371f7">📲</div><span class="pm-label">Contato</span></button>
      <button class="pm-item" onclick="openGiftPicker();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(255,107,53,.12);color:var(--ac)">🎁</div><span class="pm-label">Presente</span></button>
      <button class="pm-item" onclick="openDeclModal();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(52,211,153,.12);color:var(--ok)">📝</div><span class="pm-label">Declarar</span></button>
      <button class="pm-item" onclick="sendPulse();closePlusMenu()" type="button" id="pulseBtn"><div class="pm-ico" style="background:rgba(255,61,113,.12);color:var(--pk)">💗</div><span class="pm-label">Pulsar</span></button>
      <button class="pm-item" onclick="getHoroscope();closePlusMenu()" type="button" id="horoscopeBtn"><div class="pm-ico" style="background:rgba(251,191,36,.12);color:#fbbf24">✨</div><span class="pm-label">Horóscopo</span></button>
      <button class="pm-item" onclick="pickFile();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(255,255,255,.06);color:var(--t2)">📎</div><span class="pm-label">Arquivo</span></button>
    </div>
    <!-- Input row -->
    <div class="cia">
      <div class="cia-wrap">
        <button class="cia-plus" onclick="togglePlusMenu()" type="button">+</button>
        <input type="text" id="chatInput" placeholder="Mensagem..." maxlength="500" autocomplete="off">
      </div>
      <button class="sb" id="sendBtn" onclick="sendMessage()" type="button">&#x2191;</button>
    </div>
  </div>
  <!-- Hidden partner pts for JS reference -->
  <span class="hidden" id="partnerPts"><strong id="partnerPtsNum">0</strong></span>
</div>

<div id="relations" class="screen">
  <div class="rlh"><button class="chb" onclick="goHome()">&#x2190;</button><h2>Conexões ativas</h2><span class="rlh-sub" id="relSubtitle"></span></div>
  <div class="rll" id="relationsList"></div>
  <button class="float-history-btn" onclick="showEncounterLog()" title="Histórico de encontros">📋</button>
</div>

<div id="history" class="screen">
  <div class="const-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2>Minha Constelação</h2></div>
  <div class="const-copy"><p>Aqui ficam os encontros.<br>O resto passou.</p></div>
  <div class="const-feedback" id="constFeedback"></div>
  <div class="const-canvas-wrap"><canvas id="constCanvas"></canvas></div>
  <div class="const-empty hidden" id="constEmpty">
    <div class="const-empty-icon">✦</div>
    <div class="const-empty-text">Nenhum encontro ainda.<br>Dê um touch em alguém para começar sua constelação.</div>
  </div>
  <div class="const-detail" id="constDetail" onclick="hideConstDetail()">
    <div class="const-detail-avatar" id="constDetailAvatar"></div>
    <div class="const-detail-nick" id="constDetailNick"></div>
    <div class="const-detail-realname hidden" id="constDetailRealName"></div>
    <div class="const-detail-sub" id="constDetailSub"></div>
    <div class="const-detail-meta" id="constDetailMeta"></div>
    <img class="const-detail-selfie hidden" id="constDetailSelfie" alt="selfie">
    <a class="const-detail-insta hidden" id="constDetailInsta" onclick="event.stopPropagation()" target="_blank" rel="noopener">📸 Instagram</a>
    <div class="const-detail-text" id="constDetailText">Vocês estiveram juntos.</div>
    <div class="const-detail-id-actions hidden" id="constIdActions" onclick="event.stopPropagation()">
      <button class="id-float-btn reveal" id="constRevealIdBtn" onclick="revealFromConstellation(window._constDetailNodeId)">🪪 Trocar IDs</button>
    </div>
    <button class="const-detail-tip-btn hidden" id="constTipBtn" onclick="event.stopPropagation();constTipAction()">💰 Dar gorjeta</button>
  </div>
</div>

<div id="expireCard" class="screen">
  <div class="ev"><div class="cl">Touch?</div><div class="cf" id="cardPhrase"></div><div class="ctm" id="cardTime"></div><div class="cft">tudo nasce no gesto</div></div>
  <div class="ea"><button class="bs" onclick="goHome()">Voltar</button><button class="bp" style="max-width:160px" onclick="shareCard()">Compartilhar</button></div>
</div>

<div id="boardingPass" class="screen">
  <div class="bp-card" id="bpCard">
    <div class="bp-top"><div class="bp-logo">Touch?</div><div class="bp-type">boarding pass</div></div>
    <div class="bp-body">
      <div class="bp-avatar" id="bpAvatar">&#x1F464;</div>
      <div class="bp-name" id="bpName">Nome</div>
      <div class="bp-since" id="bpSince">membro desde jan 2026</div>
      <div class="bp-stats">
        <div class="bp-stat"><div class="bp-stat-num" id="bpScore">0</div><div class="bp-stat-label">score</div></div>
        <div class="bp-stat"><div class="bp-stat-num" id="bpStars" style="color:#fbbf24">0</div><div class="bp-stat-label">estrelas</div></div>
        <div class="bp-stat"><div class="bp-stat-num" id="bpPeople">0</div><div class="bp-stat-label">pessoas</div></div>
        <div class="bp-stat"><div class="bp-stat-num" id="bpTotal">0</div><div class="bp-stat-label">encontros</div></div>
      </div>
    </div>
    <div class="bp-barcode" id="bpBarcode"></div>
    <div class="bp-footer">TUDO NASCE NO GESTO</div>
  </div>
  <div class="touch-link-area" id="touchLinkArea">
    <div style="font-size:.75rem;font-weight:600;margin-bottom:.3rem">Seu link NFC / QR</div>
    <div style="font-size:.65rem;color:var(--t3);margin-bottom:.5rem">Cole no adesivo NFC ou mostre o QR</div>
    <div class="touch-link-url" id="touchLinkUrl">Gerando...</div>
    <div class="touch-link-actions">
      <button class="bs" onclick="copyTouchLink()" type="button">Copiar link</button>
      <button class="bs" onclick="showTouchQR()" type="button">QR Code</button>
    </div>
    <div id="touchQRArea" style="margin-top:.5rem;display:none"></div>
  </div>
  <div class="bp-actions">
    <button class="bs" onclick="goHome()">&#x2190; Voltar</button>
    <button class="bp-dl" onclick="downloadBoardingPass()">&#x1F4F1; Salvar Imagem</button>
  </div>
</div>

<div id="locationScreen" class="screen">
  <div class="loc-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 data-i18n="loc_title">Explorar ao redor</h2><button class="bs" style="font-size:.7rem;padding:.3rem .8rem" onclick="showCreateEvent()" data-i18n="create_event_btn">+ Evento</button></div>
  <div class="loc-scroll" id="locScroll">
    <div class="loc-status" id="locStatus" data-i18n="loc_activate">Ative sua localização para descobrir pessoas e eventos.</div>
    <div class="loc-tabs">
      <div class="loc-tab active" id="tabNearby" onclick="switchLocTab('nearby')" data-i18n="tab_nearby">Pessoas</div>
      <div class="loc-tab" id="tabEvents" onclick="switchLocTab('events')" data-i18n="tab_events">Eventos</div>
    </div>
    <div id="locContent"></div>
  </div>
</div>

<div id="eventDetail" class="screen">
  <div class="loc-header"><button class="chb" onclick="showScreen('locationScreen')">&#x2190;</button><h2 id="evtDetailTitle">Evento</h2></div>
  <div class="loc-scroll" id="evtDetailScroll"></div>
</div>

<!-- GORJETA SCREEN -->
<div id="tipScreen" class="screen">
  <div class="tip-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 style="font-size:1rem;font-weight:600">Gorjeta</h2></div>
  <div class="tip-receiver" id="tipReceiver"></div>
  <div class="tip-amounts">
    <button class="tip-amount-btn" onclick="selectTipAmount(2)">R$2</button>
    <button class="tip-amount-btn" onclick="selectTipAmount(5)">R$5</button>
    <button class="tip-amount-btn" onclick="selectTipAmount(10)">R$10</button>
    <button class="tip-amount-btn" onclick="selectTipAmount(20)">R$20</button>
  </div>
  <div class="tip-custom">
    <label>Outro valor:</label>
    <input type="number" id="tipCustomAmount" placeholder="R$" min="1" max="500" oninput="selectTipCustom()">
  </div>
  <div class="tip-card-section">
    <h3>Cartão de crédito</h3>
    <div class="tip-card-fields">
      <div class="tip-field" id="mpCardNumber"></div>
      <div class="tip-card-row">
        <div class="tip-field" id="mpExpiry"></div>
        <div class="tip-field" id="mpCVV"></div>
      </div>
      <div class="tip-field" id="mpCardHolder"></div>
      <input type="email" id="tipPayerEmail" class="tip-input" placeholder="Seu e-mail" autocomplete="email">
      <input type="text" id="tipPayerCPF" class="tip-input" placeholder="Seu CPF" inputmode="numeric" maxlength="14" autocomplete="off">
    </div>
  </div>
  <button class="tip-pay-btn" id="tipPayBtn" onclick="processTip()" disabled>Confirmar gorjeta</button>
  <div class="tip-result hidden" id="tipResult">
    <div class="tip-result-icon" id="tipResultIcon"></div>
    <div class="tip-result-text" id="tipResultText"></div>
    <button class="bs" onclick="goHome()" style="margin-top:.8rem">Voltar</button>
  </div>
</div>

<!-- PRESTADOR REGISTER SCREEN -->
<div id="prestadorReg" class="screen">
  <div class="tip-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 style="font-size:1rem;font-weight:600">Cadastro de Prestador</h2></div>
  <div class="preg-title">Receba gorjetas pelo Touch?</div>
  <div class="preg-sub">Cadastre-se como prestador de serviço para receber pagamentos de gorjeta diretamente no seu celular.</div>
  <div class="fg"><label>Nome completo</label><input type="text" id="pregName" placeholder="Seu nome"></div>
  <div class="fg"><label>Nickname</label><input type="text" id="pregNick" placeholder="Como vão te encontrar" maxlength="20" oninput="checkPregNick(this.value)"><div class="nick-hint" id="pregNickHint"></div></div>
  <div class="fg"><label>CPF (opcional)</label><input type="text" id="pregCPF" placeholder="000.000.000-00" maxlength="14"></div>
  <div class="fg"><label>Data de nascimento</label><input type="date" id="pregBirth"></div>
  <div class="fg"><label>Tipo de serviço</label></div>
  <div class="preg-services" id="pregServices"></div>
  <div class="preg-mp-status pending" id="pregMpStatus" style="display:none">
    <span id="pregMpText">Conecte sua conta MercadoPago para receber pagamentos</span>
  </div>
  <button class="bp" id="pregSubmitBtn" onclick="registerPrestador()" style="margin-bottom:.8rem">Criar conta de prestador</button>
  <button class="bs" id="pregMpBtn" onclick="connectMercadoPago()" style="display:none;margin-bottom:.8rem;width:100%">🔗 Conectar MercadoPago</button>
  <button class="bs" onclick="goHome()" style="width:100%;margin-bottom:2rem;opacity:.6">← Voltar</button>
</div>

<div id="encounterLog" class="screen">
  <div class="elog-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2>Histórico de encontros</h2></div>
  <div class="elog-list" id="elogList"></div>
</div>

<div id="completeProfile" class="screen">
  <div class="cp-header">
    <button class="chb" onclick="goHome()" style="position:absolute;left:1rem;top:1.2rem">&#x2190;</button>
    <h2>Perfil completo</h2>
    <p>Opcional — preencha para poder revelar sua identidade</p>
  </div>
  <div class="cp-photo-wrap">
    <div class="cp-photo" id="cpPhotoPreview" onclick="$('cpPhotoInput').click()">
      <span id="cpPhotoPlaceholder" style="font-size:2rem;color:var(--t3)">📷</span>
    </div>
    <div class="cp-photo-label" onclick="$('cpPhotoInput').click()">Adicionar foto real</div>
    <input type="file" id="cpPhotoInput" accept="image/*" style="display:none" onchange="handleProfilePhoto(this)">
  </div>
  <div class="cp-field"><label>Nome real</label><input type="text" id="cpRealName" placeholder="Seu nome completo" maxlength="60"></div>
  <div class="cp-field"><label>Bio</label><textarea id="cpBio" placeholder="Conte algo sobre você..." maxlength="200"></textarea></div>
  <div class="cp-field"><label>Telefone</label><input type="tel" id="cpPhone" placeholder="+55 11 99999-9999" maxlength="20"><div class="cp-note">Opcional — não será mostrado publicamente</div></div>
  <div class="cp-field"><label>Instagram</label><input type="text" id="cpInstagram" placeholder="@seuuser" maxlength="30"></div>
  <div class="cp-field"><label>X (Twitter)</label><input type="text" id="cpTwitter" placeholder="@seuuser" maxlength="30"></div>
  <div class="cp-actions">
    <button class="bs" onclick="goHome()">Voltar</button>
    <button class="bp" onclick="saveCompleteProfile()">Salvar</button>
  </div>
</div>

<div id="profile" class="screen">
  <div class="pf-header"><button class="chb" onclick="closeProfile()">&#x2190;</button><h2 id="pfTitle">Perfil</h2></div>
  <div class="pf-scroll" id="pfScroll"></div>
</div>

<div id="giftModal" class="hidden"></div>
<div id="declModal" class="hidden"></div>

<div id="encostaReqArea"></div>
<div id="toast" class="toast hidden"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
const $=id=>document.getElementById(id);
let socket=null,state={userId:localStorage.getItem('touch_userId'),userName:localStorage.getItem('touch_userName'),userColor:localStorage.getItem('touch_userColor')||'',userPhoto:localStorage.getItem('touch_userPhoto')||null,currentSession:null,currentRelation:null,timerInterval:null};
let typingTimeout=null,lastTypingEmit=0,pulseSent=false;

// ═══ FIREBASE AUTH ═══
let firebaseApp=null, firebaseAuthInstance=null, fbUser=null, loginIsRegister=false;

(async function initFirebase(){
  try{
    const r=await fetch('/api/firebase-config');
    const cfg=await r.json();
    firebaseApp=firebase.initializeApp(cfg);
    firebaseAuthInstance=firebase.auth();
    // Listen for auth state changes
    firebaseAuthInstance.onAuthStateChanged(async(user)=>{
      fbUser=user;
      if(user&&!state.userId){
        // User is signed in via Firebase but not linked to ENCOSTA yet
        await linkFirebaseToEncosta(user);
      }
    });
  }catch(e){console.warn('Firebase init falhou:',e.message)}
})();

async function linkFirebaseToEncosta(user){
  try{
    const token=await user.getIdToken();
    const r=await fetch('/api/auth/link',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body:JSON.stringify({firebaseUid:user.uid,email:user.email,displayName:user.displayName,photoURL:user.photoURL,encUserId:state.userId||null,nickname:window._pendingNickname||null})
    });
    const d=await r.json();
    if(d.userId){
      state.userId=d.userId;
      state.userName=d.user.nickname||d.user.name;
      state.userColor=d.user.color||'';
      state.userPhoto=d.user.profilePhoto||d.user.photoURL||null;
      localStorage.setItem('touch_userId',d.userId);
      localStorage.setItem('touch_userName',state.userName);
      localStorage.setItem('touch_userColor',state.userColor);
      if(state.userPhoto)localStorage.setItem('touch_userPhoto',state.userPhoto);
      // If user still needs to set nickname/birthdate, show register
      if(!d.user.birthdate){
        $('regNick').value=state.userName||'';
        showScreen('register');
        return;
      }
      initSocket();
      showScreen('home');
      $('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(state.userName)+'</span>';
      const _ha=$('homeAvatar');
      if(_ha&&state.userName){
        if(state.userPhoto){_ha.innerHTML='<img src="'+esc(state.userPhoto)+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%" onerror="this.remove();this.parentElement.textContent=\''+esc((state.userName||'??').slice(0,2).toUpperCase())+'\'">';_ha.style.background=state.userColor||nickColor(state.userName);_ha.style.overflow='hidden'}
        else{_ha.textContent=(state.userName||'??').slice(0,2).toUpperCase();_ha.style.background=state.userColor||nickColor(state.userName)}
      }
      refreshHome();
    }
  }catch(e){console.error('Link Firebase erro:',e)}
}

async function loginWithGoogle(){
  try{
    $('loginErr').textContent='';
    const provider=new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({prompt:'select_account'});
    await firebaseAuthInstance.signInWithPopup(provider);
    // onAuthStateChanged will handle the rest
  }catch(e){
    if(e.code==='auth/popup-blocked'){
      // Fallback to redirect
      try{await firebaseAuthInstance.signInWithRedirect(new firebase.auth.GoogleAuthProvider())}catch(e2){$('loginErr').textContent='Erro ao abrir Google. Tente novamente.'}
    }else if(e.code!=='auth/popup-closed-by-user'){
      $('loginErr').textContent='Erro: '+(e.message||'tente novamente');
    }
  }
}

async function loginWithEmail(){
  const email=$('loginEmail').value.trim();
  const pass=$('loginPass').value;
  $('loginErr').textContent='';
  if(!email||!pass)return $('loginErr').textContent='Preencha e-mail e senha.';
  try{
    if(loginIsRegister){
      const nick=$('loginNick')?$('loginNick').value.trim():'';
      if(!nick||nick.length<2)return $('loginErr').textContent='Escolha um nickname (mín. 2 caracteres).';
      if(pass.length<6)return $('loginErr').textContent='Senha precisa ter no mínimo 6 caracteres.';
      window._pendingNickname=nick;
      await firebaseAuthInstance.createUserWithEmailAndPassword(email,pass);
    }else{
      await firebaseAuthInstance.signInWithEmailAndPassword(email,pass);
    }
    // onAuthStateChanged will handle the rest
  }catch(e){
    const msgs={'auth/email-already-in-use':'Este e-mail já está cadastrado.','auth/invalid-email':'E-mail inválido.','auth/user-not-found':'Usuário não encontrado.','auth/wrong-password':'Senha incorreta.','auth/invalid-credential':'E-mail ou senha incorretos.','auth/weak-password':'Senha muito fraca (mínimo 6 caracteres).'};
    $('loginErr').textContent=msgs[e.code]||('Erro: '+(e.message||'tente novamente'));
  }
}

function toggleLoginMode(){
  loginIsRegister=!loginIsRegister;
  $('loginBtn').textContent=loginIsRegister?'CRIAR CONTA':'ENTRAR';
  $('loginToggle').innerHTML=loginIsRegister?'Já tem conta? <strong>Entrar</strong>':'Não tem conta? <strong>Criar agora — é rápido</strong>';
  $('loginErr').textContent='';
  $('loginNick').classList.toggle('hidden',!loginIsRegister);
  $('loginNickExplain').classList.toggle('hidden',!loginIsRegister);
  if(loginIsRegister)$('loginPass').placeholder='Crie uma senha (mín. 6 caracteres)';
  else $('loginPass').placeholder='Senha';
}

async function doLogout(){
  try{
    if(firebaseAuthInstance)await firebaseAuthInstance.signOut();
    localStorage.removeItem('touch_userId');localStorage.removeItem('touch_userName');localStorage.removeItem('touch_userColor');
    state.userId=null;state.userName=null;state.userColor='';fbUser=null;
    if(socket){socket.disconnect();socket=null}
    showScreen('login');
  }catch(e){showToast('Erro ao sair.')}
}

// ═══ ONBOARDING ═══
let onbSlide = 0;
const ONB_TOTAL = 5;
function initOnboarding() {
  const dots = $('onbDots');
  dots.innerHTML = '';
  for (let i = 0; i < ONB_TOTAL; i++) {
    const dot = document.createElement('div');
    dot.className = 'onb-dot' + (i === 0 ? ' active' : '');
    dots.appendChild(dot);
  }
}
function nextOnbSlide() {
  onbSlide++;
  if (onbSlide >= ONB_TOTAL) { skipOnboarding(); return; }
  $('onbSlides').style.transform = 'translateX(-' + (onbSlide * 100) + '%)';
  updateOnbDots();
  if (onbSlide === ONB_TOTAL - 1) $('onbNextBtn').textContent = 'Começar';
}
function updateOnbDots() {
  const dots = $('onbDots').children;
  for (let i = 0; i < dots.length; i++) dots[i].className = 'onb-dot' + (i === onbSlide ? ' active' : '');
}
function skipOnboarding() {
  localStorage.setItem('touch_onboarded', '1');
  showScreen('login');
}
function showTutorial(){showManual()}
function showManual(){
  // Re-show onboarding as manual
  onbSlide=0;
  initOnboarding();
  $('onbSlides').style.transform='translateX(0)';
  $('onbNextBtn').textContent='Próximo';
  // Override skip to go home
  const oldSkip=window.skipOnboarding;
  window.skipOnboarding=function(){ showScreen('home'); window.skipOnboarding=oldSkip; };
  showScreen('onboarding');
}

// ═══ SOCKET ═══
function initSocket(){
  if(socket)return;
  socket=io({reconnection:true,reconnectionDelay:1000,reconnectionAttempts:Infinity});
  socket.on('connect',()=>{if(state.userId)socket.emit('identify',state.userId);updateConn('online')});
  socket.on('disconnect',()=>updateConn('offline'));
  socket.io.on('reconnect_attempt',()=>updateConn('reconnecting'));

  socket.on('relation-created',d=>{
    if(homeSonicActive)stopHomeSonic();
    if(sonicActive)stopSonicMode();
    state.currentRelation=d;playSound('connect');
    // Show epic connecting animation with continuous vibration, then reveal
    const co=$('connectingOverlay');
    if(co){
      const isRenewed=!!d.renewed;
      co.classList.remove('first','renewed');
      co.classList.add(isRenewed?'renewed':'first');
      co.classList.add('active');
      startElectricTouch(isRenewed);
      // Continuous vibration during the electric touch animation (building intensity)
      haptic([80,30,80,30,120,40,120,40,150,30,150,30,200,20,200,20,250,15,250,15,300,10,300,10,400,10,500]);
      setTimeout(()=>{
        stopElectricTouch();
        if(navigator.vibrate)navigator.vibrate(0); // stop vibration
        co.classList.remove('active','first','renewed');
        showScreen('reveal');doReveal(d);
      },4200);
    }else{
      showScreen('reveal');doReveal(d);
    }
  });
  socket.on('new-message',({relationId,message})=>{
    if(state.currentRelation?.relationId===relationId){appendMessage(message);playSound('receive');hideTyping()}
  });
  socket.on('partner-typing',({relationId})=>{
    if(state.currentRelation?.relationId===relationId)showTyping()
  });
  socket.on('pulse-received',({relationId})=>{
    // Heartbeat vibration: lub-dub, lub-dub, lub-dub
    const heartbeat=[120,60,80,300,120,60,80,300,120,60,80];
    if(state.currentRelation?.relationId===relationId){
      haptic(heartbeat);playSound('pulse');
      showToast('Sentiu um pulso...');
    }else{haptic(heartbeat);showToast('Alguém pulsou por você')}
  });
  socket.on('ephemeral-received',({relationId,message})=>{
    if(state.currentRelation?.relationId===relationId){appendEphemeral(message);playSound('receive')}
    else showToast('Nova mensagem!');
    haptic([50,30,50]);
  });
  socket.on('photo-received',({relationId,message})=>{
    if(state.currentRelation?.relationId===relationId){appendPhoto(message);playSound('receive')}
    else showToast('Foto recebida!');
    haptic([50,30,50]);
  });
  socket.on('selfie-request',({relationId})=>{
    if(state.currentRelation?.relationId===relationId)showToast('A outra pessoa quer registrar o encontro!');
  });
  socket.on('gift-received',({relationId,gift})=>{
    haptic([100,50,100]);playSound('connect');
    if(gift.needsAddress&&gift.addressStatus==='pending'){
      if(state.currentRelation?.relationId===relationId)showAddressRequest(gift);
      else showToast(gift.fromName+' te enviou '+gift.emoji+' '+gift.giftName+'!');
    }else{showToast(gift.fromName+' te enviou '+gift.emoji+' '+gift.giftName+'!')}
  });
  socket.on('declaration-received',({relationId,declaration})=>{
    haptic([50,30,50]);showToast(declaration.fromName+' escreveu uma declaração para você!');
  });
  socket.on('gift-address-accepted',({giftName})=>{showToast('Presente aceito! '+giftName+' será entregue.');haptic([50,30,50])});
  socket.on('gift-address-declined',({giftName})=>{showToast('Presente recusado: '+giftName);haptic([30])});
  socket.on('identity-request',({relationId,fromName})=>{
    haptic([60,30,60]);playSound('receive');
    showToast(fromName+' quer ver quem você é de verdade!');
  });
  // New: someone wants to reveal IDs (bilateral exchange request)
  socket.on('identity-reveal-request',({fromUserId,fromName,fromPhoto,relationId})=>{
    haptic([100,50,100]);playSound('receive');
    showRevealRequestPopup(fromUserId,fromName,fromPhoto,relationId);
  });
  // Reveal was declined
  socket.on('identity-reveal-declined',({byUserId,byName})=>{
    haptic([30]);showToast((byName||'A pessoa')+' preferiu não revelar agora.');
  });
  // Bilateral reveal completed — both identities exchanged
  socket.on('identity-revealed',({fromUserId,realName,profilePhoto,instagram,bio})=>{
    haptic([80,40,80]);playSound('connect');
    // Store revealed state — BOTH directions are now revealed
    if(!state.revealedIds)state.revealedIds={};
    state.revealedIds[fromUserId]={realName,profilePhoto,_iRevealed:true};
    // Global UI sync — hide all ID buttons for this person everywhere
    syncRevealUI(fromUserId,realName,profilePhoto);
    // Refresh relations so photos show on home/relations screens
    refreshRelations();
    // Show ID card in chat if open
    if(state.currentPartnerId===fromUserId&&state.currentRelation){
      appendSystemMsg('Identidades reveladas! Agora vocês se conhecem de verdade 🪪');
      const box=$('chatMessages');
      if(box){
        const card=document.createElement('div');card.className='id-revealed-card';
        card.innerHTML=(profilePhoto?'<img src="'+profilePhoto+'" alt="">':'')+'<div><div class="id-name">'+(realName||'?')+'</div>'+(bio?'<div class="id-bio">'+esc(bio)+'</div>':'')+(instagram?'<div class="id-bio">'+esc(instagram)+'</div>':'')+'</div>';
        box.appendChild(card);box.scrollTop=box.scrollHeight;
      }
    }else{
      showToast((realName||'Alguém')+' revelou quem é — abra o chat para ver! 🪪');
    }
  });
  socket.on('encosta-request',data=>showEncostaRequest(data));
  socket.on('encosta-declined',()=>{showToast('Pedido de touch recusado.');haptic([30])});
  socket.on('contact-request',data=>showContactRequest(data));
  socket.on('contact-shared',({relationId,contactType,value})=>{
    // Save contact info as persistent message in chat
    const labels={instagram:'📸 Instagram',whatsapp:'💬 WhatsApp',x:'𝕏 X',email:'📧 Email'};
    const text=(labels[contactType]||contactType)+': '+value;
    if(state.currentRelation?.relationId===relationId){
      appendMessage({userId:'system',text,timestamp:Date.now()});
    }
    // Also save as regular message on server
    if(relationId)socket.emit('send-message',{relationId,userId:'system',text});
    showToast(contactType+': '+value);haptic([20,40,20]);
  });
  socket.on('contact-declined',({contactType})=>{showToast('Pedido de '+contactType+' recusado.');haptic([30])});
  socket.on('selfie-taken',({relationId})=>{showToast('Selfie registrado!');haptic([20,40,20])});
  socket.on('star-earned',({star,total})=>{
    haptic([100,50,100,50,100]);playSound('connect');
    const reason=star.reason==='gift'?'Presente de '+(star.fromName||'alguém'):star.reason==='organic'?'Conexão especial com '+(star.withName||'alguém'):star.reason==='streak'?'Streak com '+(star.withName||'alguém'):'Marco alcançado';
    showToast('⭐ Nova estrela! '+reason+' (Total: '+total+')');
  });
  socket.on('streak-unlock',data=>showStreakUnlock(data));
  socket.on('tip-received',({amount,from,status})=>{
    if(status==='approved'){
      haptic([100,50,100,50,100]);playSound('connect');
      showToast('💰 Gorjeta recebida! R$'+amount.toFixed(2).replace('.',',')+' de '+from);
    }else if(status==='pending'||status==='in_process'){
      showToast('⏳ Gorjeta de R$'+amount.toFixed(2).replace('.',',')+' em processamento.');
    }
  });
}
function updateConn(s){const d=$('connDot');if(d)d.className='cd'+(s!=='online'?' '+s:'')}

// ═══ NAV ═══
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>{if(s.id!==id)s.classList.remove('active')});
  requestAnimationFrame(()=>$(id).classList.add('active'));
  if(id!=='reveal'&&typeof stopRevealLight==='function')stopRevealLight();
  if(state.timerInterval&&id!=='chat'){clearInterval(state.timerInterval);state.timerInterval=null}
  // Close selfie camera when leaving reveal
  if(id!=='reveal')releaseSelfieCamera();
  // Stop constellation animation + gyro when leaving
  if(id!=='history'){
    if(constState.animFrame){cancelAnimationFrame(constState.animFrame);constState.animFrame=null}
    if(constState._cleanGyro)constState._cleanGyro();
  }
  // Stop home nodes animation when leaving home
  if(id!=='home'){
    if(_homeNodesAnim){cancelAnimationFrame(_homeNodesAnim);_homeNodesAnim=null}
    if(_homeNodesGyro){window.removeEventListener('deviceorientation',_homeNodesGyro);_homeNodesGyro=null}
  }
}
function showPhase(id){document.querySelectorAll('.ep').forEach(p=>p.classList.remove('active'));$(id).classList.add('active')}
function goHome(){showScreen('home');refreshHome()}

async function refreshHome(){
  refreshRelations();
  setHomeMotivation();
  // Fetch user profile to get latest photo + real name
  if(state.userId){
    try{
      const mp=await fetch('/api/myprofile/'+state.userId).then(r=>r.json());
      if(mp.profilePhoto){state.userPhoto=mp.profilePhoto;localStorage.setItem('touch_userPhoto',mp.profilePhoto)}
      state.userRealName=mp.realName||null;
      const rnEl=$('homeRealName');
      if(rnEl){rnEl.textContent=mp.realName&&mp.realName!==state.userName?mp.realName:''}
    }catch(e){}
  }
  // Set homeAvatar
  if(state.userName){
    const av=$('homeAvatar');
    if(av){
      if(state.userPhoto){
        av.innerHTML='<img src="'+esc(state.userPhoto)+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%" onerror="this.remove();this.parentElement.textContent=\''+esc((state.userName||'??').slice(0,2).toUpperCase())+'\'">';
        av.style.background=state.userColor||nickColor(state.userName);av.style.overflow='hidden';
      }else{
        av.textContent=(state.userName||'??').slice(0,2).toUpperCase();av.style.background=state.userColor||nickColor(state.userName);
      }
    }
  }
  try{
    const [d,cn]=await Promise.all([
      fetch('/api/today/'+state.userId).then(r=>r.json()),
      fetch('/api/constellation/'+state.userId).then(r=>r.json())
    ]);
    const c=$('dailyCounter'),n=$('dailyNum');
    if(d.count>0){c.classList.remove('hidden');n.textContent=d.count}else c.classList.add('hidden');
    if(cn.total>0)$('constBtn').classList.remove('hidden');
    // Update home background nodes
    initHomeNodes(cn.nodes||[]);
  }catch(e){}
}

// ═══ HOME BACKGROUND NODES — rotating neural web ═══
let _homeNodesAnim=null,_homeNodesGyro=null;
function initHomeNodes(nodes){
  if(_homeNodesAnim){cancelAnimationFrame(_homeNodesAnim);_homeNodesAnim=null}
  if(_homeNodesGyro){window.removeEventListener('deviceorientation',_homeNodesGyro);_homeNodesGyro=null}
  const cv=$('homeNodesCanvas');if(!cv)return;
  const count=nodes.length;
  if(count<1)return;
  const dpr=window.devicePixelRatio||1;
  const W=window.innerWidth,H=window.innerHeight;
  cv.width=W*dpr;cv.height=H*dpr;
  cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');
  ctx.scale(dpr,dpr);
  // Generate node positions in an organic circle
  const pts=[];
  for(let i=0;i<count;i++){
    const angle=(i/count)*Math.PI*2+Math.random()*0.3;
    const radius=60+Math.random()*80+Math.min(count,20)*3;
    pts.push({
      x:Math.cos(angle)*radius+(Math.random()-0.5)*20,
      y:Math.sin(angle)*radius+(Math.random()-0.5)*20,
      r:2+Math.random()*2.5,
      phase:Math.random()*Math.PI*2,
      a:0.06+Math.random()*0.06
    });
  }
  // Generate connections (each node connects to 1-2 neighbors)
  const links=[];
  for(let i=0;i<pts.length;i++){
    const next=(i+1)%pts.length;
    links.push([i,next]);
    if(Math.random()>0.5&&pts.length>3){
      const skip=(i+2)%pts.length;
      links.push([i,skip]);
    }
  }
  let tiltX=0,tiltY=0,rawTX=0,rawTY=0;
  _homeNodesGyro=function(e){
    rawTX=Math.max(-1,Math.min(1,(e.gamma||0)/15));
    rawTY=Math.max(-1,Math.min(1,((e.beta||0)-45)/15));
  };
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(function(p){
      if(p==='granted')window.addEventListener('deviceorientation',_homeNodesGyro);
    }).catch(function(){});
  }else{
    window.addEventListener('deviceorientation',_homeNodesGyro);
  }
  const t0=performance.now();
  function draw(){
    _homeNodesAnim=requestAnimationFrame(draw);
    const t=(performance.now()-t0)/1000;
    tiltX+=(rawTX-tiltX)*0.06;
    tiltY+=(rawTY-tiltY)*0.06;
    ctx.clearRect(0,0,W,H);
    // Slow rotation + tilt offset
    const rot=t*0.08;
    const cx=W/2+tiltX*40;
    const cy=H*0.42+tiltY*30;
    // Draw connections
    ctx.lineWidth=0.5;
    links.forEach(([a,b])=>{
      const pa=pts[a],pb=pts[b];
      const ax=cx+Math.cos(rot)*pa.x-Math.sin(rot)*pa.y;
      const ay=cy+Math.sin(rot)*pa.x+Math.cos(rot)*pa.y;
      const bx=cx+Math.cos(rot)*pb.x-Math.sin(rot)*pb.y;
      const by=cy+Math.sin(rot)*pb.x+Math.cos(rot)*pb.y;
      const avg=(pa.a+pb.a)/2;
      ctx.beginPath();ctx.moveTo(ax,ay);ctx.lineTo(bx,by);
      ctx.strokeStyle='rgba(255,107,53,'+(avg*0.4).toFixed(3)+')';ctx.stroke();
    });
    // Draw nodes
    pts.forEach(p=>{
      const nx=cx+Math.cos(rot)*p.x-Math.sin(rot)*p.y;
      const ny=cy+Math.sin(rot)*p.x+Math.cos(rot)*p.y;
      const pulse=p.a+Math.sin(t*1.5+p.phase)*0.02;
      ctx.beginPath();ctx.arc(nx,ny,p.r,0,Math.PI*2);
      ctx.fillStyle='rgba(255,107,53,'+pulse.toFixed(3)+')';ctx.fill();
      // Tiny glow
      const g=ctx.createRadialGradient(nx,ny,0,nx,ny,p.r*4);
      g.addColorStop(0,'rgba(255,107,53,'+(pulse*0.3).toFixed(3)+')');
      g.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(nx,ny,p.r*4,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
    });
  }
  draw();
}

// ═══ REGISTER ═══
let nickCheckTimer=null;
function checkNick(val){
  const nick=val.trim(),hint=$('nickHint'),preview=$('avatarPreview');
  if(!nick||nick.length<2){hint.textContent='mínimo 2 caracteres';hint.className='nick-hint';preview.textContent='?';preview.style.background='var(--s2)';return}
  if(!/^[a-zA-Z0-9_.-]+$/.test(nick)){hint.textContent='só letras, números, _ . -';hint.className='nick-hint taken';return}
  // Update preview avatar
  const initials=nick.slice(0,2).toUpperCase();
  const color=nickColor(nick);
  preview.textContent=initials;preview.style.background=color;
  // Debounced availability check
  clearTimeout(nickCheckTimer);
  hint.textContent='verificando...';hint.className='nick-hint';
  nickCheckTimer=setTimeout(async()=>{
    try{
      const r=await fetch('/api/check-nick/'+encodeURIComponent(nick));const d=await r.json();
      if(d.available){hint.textContent='disponível!';hint.className='nick-hint ok'}
      else{hint.textContent='já existe';hint.className='nick-hint taken'}
    }catch(e){hint.textContent='';hint.className='nick-hint'}
  },400);
}
function nickColor(nick){let h=0;for(let i=0;i<nick.length;i++)h=nick.charCodeAt(i)+((h<<5)-h);return'hsl('+Math.abs(h)%360+',65%,55%)'}
function makeAvatar(nick,color,size,photo){
  size=size||44;
  if(photo&&photo.length>10){
    return '<div style="width:'+size+'px;height:'+size+'px;border-radius:50%;overflow:hidden;flex-shrink:0;border:1.5px solid rgba(255,255,255,.12);box-shadow:0 2px 8px rgba(0,0,0,.2)"><img src="'+photo+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>';
  }
  const initials=(nick||'??').slice(0,2).toUpperCase();
  return '<div style="width:'+size+'px;height:'+size+'px;border-radius:50%;background:'+color+';display:flex;align-items:center;justify-content:center;font-size:'+(size*.36)+'px;font-weight:800;color:#fff;letter-spacing:.03em;flex-shrink:0;border:1.5px solid rgba(255,255,255,.12);box-shadow:0 2px 8px rgba(0,0,0,.2)">'+esc(initials)+'</div>';
}
async function doRegister(){
  const nick=$('regNick').value.trim(),birth=$('regBirth').value,terms=$('regTerms').checked;
  if(!nick||nick.length<2)return showToast('Escolha um nickname.');if(!birth)return showToast('Data de nascimento.');if(!terms)return showToast('Aceite os termos.');
  if(!/^[a-zA-Z0-9_.-]+$/.test(nick))return showToast('Nickname: só letras, números, _ . -');
  try{
    // If user already has ID (came from Firebase link), use update; else register new
    const endpoint=state.userId?'/api/register':'/api/register';
    const body={nickname:nick,birthdate:birth,acceptedTerms:true};
    if(state.userId)body.userId=state.userId;
    const r=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    if(d.userId){
      state.userId=d.userId;state.userName=nick;state.userColor=d.user.color;
      state.userPhoto=d.user.profilePhoto||d.user.photoURL||null;
      localStorage.setItem('touch_userId',d.userId);localStorage.setItem('touch_userName',nick);localStorage.setItem('touch_userColor',d.user.color||'');
      if(state.userPhoto)localStorage.setItem('touch_userPhoto',state.userPhoto);
      // Link with Firebase if signed in
      if(fbUser&&firebaseAuthInstance){
        try{await linkFirebaseToEncosta(fbUser)}catch(e){}
      }
      initSocket();showScreen('home');
      $('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(nick)+'</span>';
      const _ha=$('homeAvatar');if(_ha){
        if(state.userPhoto){_ha.innerHTML='<img src="'+esc(state.userPhoto)+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%">';_ha.style.background=d.user.color||nickColor(nick);_ha.style.overflow='hidden'}
        else{_ha.textContent=nick.slice(0,2).toUpperCase();_ha.style.background=d.user.color||nickColor(nick)}
      }
      haptic([80]);
    }
  }catch(e){showToast('Erro ao registrar.')}
}

// ═══ ENCOUNTER ═══
function startEncounter(){haptic([40]);showScreen('encounter');showPhase('phaseChoose');$('joinCodeInput').value=''}

// ═══ MAIN BUTTON — sonic first, code fallback ═══
let homeSonicActive=false;
async function handleMainButton(){
  if(!state.userId){showToast('Faça login primeiro.');showScreen('login');return}
  if(homeSonicActive){stopHomeSonic();return}
  if(!socket||!socket.connected){showToast('Sem conexão. Aguarde...');return}
  haptic([40]);

  // RESET: kill any leftover audio/mic state from previous attempt
  stopSonicMode();

  homeSonicActive=true;
  sonicActive=true;sonicMyFreq=0;
  const btn=$('mainBtn'),txt=$('mainBtnText'),sts=$('sonicHomeStatus'),fb=$('sonicFallback');
  const barsL=$('sonicBarsL'),barsR=$('sonicBarsR'),fire=$('fireOverlay');
  btn.classList.add('energized');
  txt.textContent='ATIVANDO...';
  // ALWAYS request fresh mic permission to avoid stuck loops
  if(sonicStream){sonicStream.getTracks().forEach(t=>t.stop());sonicStream=null;}
  if(sonicMicCtx){try{sonicMicCtx.close()}catch(e){} sonicMicCtx=null;}
  if(sonicEmitCtx){try{sonicEmitCtx.close()}catch(e){} sonicEmitCtx=null;}
  sts.textContent='Pedindo microfone...';sts.classList.add('active');
  fb.classList.remove('active'); // reset fallback
  barsL.classList.add('active');barsR.classList.add('active');
  if(fire)fire.classList.add('active');
  const si=$('sonicInstruct');if(si)si.classList.add('active');

  try{
    // 1. Fresh mic permission — always request new stream
    sonicStream=await requestMic();
    if(!homeSonicActive)return;
    sts.textContent='Conectando ao servidor...';

    // 2. Get frequency from server
    socket.emit('sonic-start',{userId:state.userId});
    const freq=await new Promise((resolve,reject)=>{
      const t=setTimeout(()=>reject(new Error('Timeout')),5000);
      socket.once('sonic-assigned',({freq})=>{clearTimeout(t);resolve(freq)});
    });
    if(!homeSonicActive)return;
    sonicMyFreq=freq;

    // 3. Emit ultrasonic — fresh AudioContext
    sonicEmitCtx=new(window.AudioContext||window.webkitAudioContext)();
    if(sonicEmitCtx.state==='suspended')await sonicEmitCtx.resume();
    sonicOsc=sonicEmitCtx.createOscillator();
    sonicOsc.type='sine';
    sonicOsc.frequency.setValueAtTime(freq,sonicEmitCtx.currentTime);
    const gain=sonicEmitCtx.createGain();
    gain.gain.setValueAtTime(0.8,sonicEmitCtx.currentTime);
    sonicOsc.connect(gain);gain.connect(sonicEmitCtx.destination);
    sonicOsc.start();

    // 4. Start detection — fresh AudioContext for mic
    sonicMicCtx=new(window.AudioContext||window.webkitAudioContext)();
    if(sonicMicCtx.state==='suspended')await sonicMicCtx.resume();
    const source=sonicMicCtx.createMediaStreamSource(sonicStream);
    sonicAnalyser=sonicMicCtx.createAnalyser();
    sonicAnalyser.fftSize=SONIC_FFT_SIZE;
    sonicAnalyser.smoothingTimeConstant=0.3;
    source.connect(sonicAnalyser);
    const bufLen=sonicAnalyser.frequencyBinCount;
    const dataArr=new Uint8Array(bufLen);
    const sampleRate=sonicMicCtx.sampleRate;
    const freqPerBin=sampleRate/SONIC_FFT_SIZE;

    txt.textContent='TOUCHING...';
    sts.textContent='Encoste os alto-falantes 🔊';
    setTimeout(()=>{if(homeSonicActive){fb.classList.add('active');sts.textContent='Encoste os alto-falantes ou use código'}},10000);

    let confirmHits=0,lastSnapped=0;
    function detect(){
      if(!sonicActive)return;
      sonicAnalyser.getByteFrequencyData(dataArr);
      const minBin=Math.floor(18000/freqPerBin),maxBin=Math.ceil(20000/freqPerBin);
      let peakVal=0,peakBin=0;
      for(let i=minBin;i<=maxBin&&i<bufLen;i++){if(dataArr[i]>peakVal){peakVal=dataArr[i];peakBin=i}}
      if(peakVal>=SONIC_DETECT_THRESHOLD){
        const snapped=Math.round(Math.round(peakBin*freqPerBin)/100)*100;
        if(snapped!==sonicMyFreq&&snapped>=18000&&snapped<=19900){
          if(snapped===lastSnapped)confirmHits++;else{confirmHits=1;lastSnapped=snapped}
          if(confirmHits>=SONIC_CONFIRM_COUNT){
            haptic([100,30,100]);
            txt.textContent='CONECTOU!';sts.textContent='Encontramos alguém!';
            socket.emit('sonic-detected',{userId:state.userId,detectedFreq:snapped});
            sonicActive=false;return;
          }
        }
      }else if(confirmHits>0)confirmHits=Math.max(0,confirmHits-1);
      sonicAnimFrame=requestAnimationFrame(detect);
    }
    detect();
  }catch(e){
    console.error('Sonic error:',e);
    sts.textContent=e.name==='NotAllowedError'?'Microfone negado.':'Erro: '+e.message;
    fb.classList.add('active');
  }
}

function stopHomeSonic(){
  homeSonicActive=false;
  stopSonicMode();
  const btn=$('mainBtn'),txt=$('mainBtnText'),status=$('sonicHomeStatus'),fb=$('sonicFallback');
  const barsL=$('sonicBarsL'),barsR=$('sonicBarsR'),fire=$('fireOverlay');
  btn.classList.remove('energized');
  txt.textContent='TOUCH';
  status.classList.remove('active');
  fb.classList.remove('active');
  barsL.classList.remove('active');barsR.classList.remove('active');
  if(fire)fire.classList.remove('active');
  const si=$('sonicInstruct');if(si)si.classList.remove('active');
}
async function createSession(){
  if(!state.userId){showToast('Faça login primeiro.');showScreen('login');return}
  try{
    const r=await fetch('/api/session/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
    const d=await r.json();
    if(d.error){if(d.error.includes('inválido')){showToast('Sessão expirada. Faça login novamente.');localStorage.clear();showScreen('login');return}return showToast(d.error)}
    state.currentSession=d.sessionId;$('sessionCode').textContent=d.code;showPhase('phaseCode');generateQR(d.code);socket.emit('join-session',d.sessionId);
  }catch(e){showToast('Erro ao criar sessão.')}
}
async function joinSession(){
  const code=$('joinCodeInput').value.trim().toUpperCase();if(!code)return showToast('Digite o código.');
  if(!state.userId){showToast('Faça login primeiro.');showScreen('login');return}
  try{
    const r=await fetch('/api/session/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,code})});
    const d=await r.json();
    if(d.error){if(d.error.includes('inválido')){showToast('Sessão expirada.');localStorage.clear();showScreen('login');return}return showToast(d.error)}
    if(d.relationId){
      state.currentRelation=d;playSound('connect');
      const co=$('connectingOverlay');
      if(co){
        co.classList.remove('first','renewed');
        co.classList.add(d.renewed?'renewed':'first','active');
        startElectricTouch(!!d.renewed);
        haptic([80,30,80,30,120,40,120,40,150,30,150,30,200,20,200,20,250,15,250,15,300,10,300,10,400,10,500]);
        setTimeout(()=>{stopElectricTouch();if(navigator.vibrate)navigator.vibrate(0);co.classList.remove('active','first','renewed');showScreen('reveal');doReveal(d)},4200);
      }else{showScreen('reveal');doReveal(d)}
    }
  }catch(e){showToast('Código inválido ou expirado.')}
}
function generateQR(code){
  const canvas=$('qrCanvas'),ctx=canvas.getContext('2d');canvas.width=180;canvas.height=180;ctx.clearRect(0,0,180,180);
  if(typeof QRCode!=='undefined'){const tmp=document.createElement('div');new QRCode(tmp,{text:location.origin+'?code='+code,width:180,height:180,colorDark:'#0a0a0a',colorLight:'#ffffff'});setTimeout(()=>{const src=tmp.querySelector('img')||tmp.querySelector('canvas');if(src){if(src.tagName==='CANVAS')ctx.drawImage(src,0,0,180,180);else{const i=new Image();i.onload=()=>ctx.drawImage(i,0,0,180,180);i.src=src.src}}},200)}
}

// ═══ SONIC — ultrasonic phone-to-phone ═══
let sonicActive=false,sonicEmitCtx=null,sonicOsc=null,sonicStream=null,sonicMicCtx=null,sonicAnalyser=null,sonicAnimFrame=null,sonicMyFreq=0;
const SONIC_FFT_SIZE=8192;
const SONIC_DETECT_THRESHOLD=80; // lowered: phone mics pick up 18kHz weakly
const SONIC_CONFIRM_COUNT=3; // need 3 consecutive detections to confirm (anti false-positive)

// Request mic permission and return stream (reusable)
async function requestMic(){
  return navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
}

function startSonicMode(){
  if(!state.userId){showToast('Faça login primeiro.');showScreen('login');return}
  if(!socket||!socket.connected){showToast('Sem conexão. Aguarde...');return}
  showPhase('phaseBump');
  const circle=$('bumpCircle'),label=$('bumpLabel'),status=$('bumpStatus');
  circle.className='bump-circle';label.textContent='PREPARANDO...';
  status.textContent='Pedindo microfone...';
  sonicActive=true;sonicMyFreq=0;
  initSonic(label,status,circle);
}

async function initSonic(label,status,circle){
  try{
    // 1. Get mic permission first
    sonicStream=await requestMic();
    if(status)status.textContent='Microfone OK. Conectando...';

    // 2. Ask server for frequency
    socket.emit('sonic-start',{userId:state.userId});
    const freq=await new Promise((resolve,reject)=>{
      const timeout=setTimeout(()=>reject(new Error('Server timeout')),5000);
      socket.once('sonic-assigned',({freq})=>{clearTimeout(timeout);resolve(freq)});
    });
    if(!sonicActive)return; // user may have cancelled
    sonicMyFreq=freq;

    // 3. Start emitting (louder for phone speakers)
    sonicEmitCtx=new(window.AudioContext||window.webkitAudioContext)();
    sonicOsc=sonicEmitCtx.createOscillator();
    sonicOsc.type='sine';
    sonicOsc.frequency.setValueAtTime(freq,sonicEmitCtx.currentTime);
    const gain=sonicEmitCtx.createGain();
    gain.gain.setValueAtTime(0.8,sonicEmitCtx.currentTime); // louder! phones need it
    sonicOsc.connect(gain);
    gain.connect(sonicEmitCtx.destination);
    sonicOsc.start();

    // 4. Start listening with confirmed detection
    sonicMicCtx=new(window.AudioContext||window.webkitAudioContext)();
    const source=sonicMicCtx.createMediaStreamSource(sonicStream);
    sonicAnalyser=sonicMicCtx.createAnalyser();
    sonicAnalyser.fftSize=SONIC_FFT_SIZE;
    sonicAnalyser.smoothingTimeConstant=0.3; // less smoothing = faster response
    source.connect(sonicAnalyser);
    const bufLen=sonicAnalyser.frequencyBinCount;
    const dataArr=new Uint8Array(bufLen);
    const sampleRate=sonicMicCtx.sampleRate;
    const freqPerBin=sampleRate/SONIC_FFT_SIZE;

    if(circle)circle.classList.add('listening');
    if(label)label.textContent='TOUCH!';
    if(status)status.textContent='Aproxime os celulares...';

    let confirmHits=0,lastSnapped=0;

    function detect(){
      if(!sonicActive)return;
      sonicAnalyser.getByteFrequencyData(dataArr);
      const minBin=Math.floor(18000/freqPerBin);
      const maxBin=Math.ceil(20000/freqPerBin);
      let peakVal=0,peakBin=0;
      for(let i=minBin;i<=maxBin&&i<bufLen;i++){
        if(dataArr[i]>peakVal){peakVal=dataArr[i];peakBin=i}
      }
      if(peakVal>=SONIC_DETECT_THRESHOLD){
        const detectedFreq=Math.round(peakBin*freqPerBin);
        const snapped=Math.round(detectedFreq/100)*100;
        // Ignore own frequency and out-of-range
        if(snapped!==sonicMyFreq&&snapped>=18000&&snapped<=19900){
          if(snapped===lastSnapped){confirmHits++}else{confirmHits=1;lastSnapped=snapped}
          if(confirmHits>=SONIC_CONFIRM_COUNT){
            // Confirmed detection!
            haptic([100,30,100]);
            if(circle){circle.classList.remove('listening');circle.classList.add('bumped')}
            if(label)label.textContent='CONECTOU!';
            if(status)status.textContent='Conectando...';
            socket.emit('sonic-detected',{userId:state.userId,detectedFreq:snapped});
            sonicActive=false;
            return;
          }
        }
      }else{
        // Reset if signal lost
        if(confirmHits>0)confirmHits=Math.max(0,confirmHits-1);
      }
      sonicAnimFrame=requestAnimationFrame(detect);
    }
    detect();

  }catch(e){
    console.error('Sonic init error:',e);
    if(status)status.textContent=e.name==='NotAllowedError'?'Microfone negado. Use código.':'Erro: '+e.message;
    sonicActive=false;
    const fb=$('sonicFallback');if(fb)fb.classList.add('active');
  }
}

function stopSonicMode(){
  sonicActive=false;
  if(sonicOsc){try{sonicOsc.stop()}catch(e){}}
  if(sonicEmitCtx){try{sonicEmitCtx.close()}catch(e){}}
  if(sonicMicCtx){try{sonicMicCtx.close()}catch(e){}}
  if(sonicStream){sonicStream.getTracks().forEach(t=>t.stop())}
  if(sonicAnimFrame)cancelAnimationFrame(sonicAnimFrame);
  sonicOsc=null;sonicEmitCtx=null;sonicMicCtx=null;sonicStream=null;sonicAnalyser=null;sonicAnimFrame=null;sonicMyFreq=0;
  if(socket&&socket.connected)socket.emit('sonic-stop',{userId:state.userId});
}

// ═══ ELECTRIC TOUCH — epic connection animation ═══
let _etAnim=null;
function startElectricTouch(isRenewed){
  const bg=$('coCanvas');if(!bg)return;
  const W=window.innerWidth,H=window.innerHeight;
  bg.width=W;bg.height=H;
  const ctx=bg.getContext('2d');
  // Phone mini canvases
  const cL=$('coPhoneL'),cR=$('coPhoneR');
  const ctxL=cL?cL.getContext('2d'):null;
  const ctxR=cR?cR.getContext('2d'):null;
  // Colors
  const baseR=isRenewed?255:220,baseG=isRenewed?200:230,baseB=isRenewed?60:255;
  const glowR=isRenewed?255:180,glowG=isRenewed?170:200,glowB=isRenewed?0:255;
  const t0=performance.now();
  // Lightning bolt generator
  function bolt(x0,y0,x1,y1,depth,maxD){
    const pts=[{x:x0,y:y0}];
    const segs=4+Math.floor(Math.random()*4);
    for(let i=1;i<segs;i++){
      const t=i/segs;
      const mx=x0+(x1-x0)*t;
      const my=y0+(y1-y0)*t;
      const spread=(1-Math.abs(t-.5)*2)*40*(1-depth/maxD);
      pts.push({x:mx+(Math.random()-.5)*spread,y:my+(Math.random()-.5)*spread});
    }
    pts.push({x:x1,y:y1});
    return pts;
  }
  function drawBolt(c,pts,alpha,width,r,g,b){
    c.beginPath();c.moveTo(pts[0].x,pts[0].y);
    for(let i=1;i<pts.length;i++)c.lineTo(pts[i].x,pts[i].y);
    c.strokeStyle='rgba('+r+','+g+','+b+','+alpha+')';
    c.lineWidth=width;c.lineCap='round';c.lineJoin='round';c.stroke();
    // Core white line
    c.beginPath();c.moveTo(pts[0].x,pts[0].y);
    for(let i=1;i<pts.length;i++)c.lineTo(pts[i].x,pts[i].y);
    c.strokeStyle='rgba(255,255,255,'+(alpha*.8)+')';
    c.lineWidth=Math.max(0.5,width*.3);c.stroke();
  }
  // Background bolts (full screen)
  let bgBolts=[];
  function genBgBolts(count){
    bgBolts=[];
    for(let i=0;i<count;i++){
      const side=Math.random()>.5;
      const x0=W/2+(side?-1:1)*(10+Math.random()*30);
      const y0=H/2+(Math.random()-.5)*40;
      const angle=Math.random()*Math.PI*2;
      const len=80+Math.random()*200;
      const x1=x0+Math.cos(angle)*len;
      const y1=y0+Math.sin(angle)*len;
      const pts=bolt(x0,y0,x1,y1,0,3);
      // Branch
      const branches=[];
      if(Math.random()>.4){
        const bi=1+Math.floor(Math.random()*(pts.length-2));
        const ba=angle+(Math.random()-.5)*1.2;
        const bl=30+Math.random()*80;
        branches.push(bolt(pts[bi].x,pts[bi].y,pts[bi].x+Math.cos(ba)*bl,pts[bi].y+Math.sin(ba)*bl,1,3));
      }
      bgBolts.push({pts,branches,alpha:.3+Math.random()*.5,width:1+Math.random()*2,life:0,maxLife:3+Math.random()*6});
    }
  }
  // Phone screen lightning (mirrored)
  function drawPhoneLightning(c,w,h,t,mirror){
    c.clearRect(0,0,w,h);
    // Radial energy from the touching edge
    const fromX=mirror?0:w;
    const grad=c.createRadialGradient(fromX,h/2,0,fromX,h/2,w*1.5);
    const a=.15+Math.sin(t*3)*.1;
    grad.addColorStop(0,'rgba('+baseR+','+baseG+','+baseB+','+a+')');
    grad.addColorStop(.4,'rgba('+baseR+','+baseG+','+baseB+','+(a*.3)+')');
    grad.addColorStop(1,'transparent');
    c.fillStyle=grad;c.fillRect(0,0,w,h);
    // Mini bolts from the edge
    const count=2+Math.floor(Math.random()*3);
    for(let i=0;i<count;i++){
      const x0=fromX;
      const y0=h*.2+Math.random()*h*.6;
      const x1=mirror?w*.5+Math.random()*w*.4:w*.1+Math.random()*w*.4;
      const y1=y0+(Math.random()-.5)*h*.4;
      const pts=bolt(x0,y0,x1,y1,0,2);
      const la=.4+Math.random()*.4;
      c.beginPath();c.moveTo(pts[0].x,pts[0].y);
      for(let j=1;j<pts.length;j++)c.lineTo(pts[j].x,pts[j].y);
      c.strokeStyle='rgba('+baseR+','+baseG+','+baseB+','+la+')';
      c.lineWidth=.8+Math.random();c.lineCap='round';c.stroke();
      c.beginPath();c.moveTo(pts[0].x,pts[0].y);
      for(let j=1;j<pts.length;j++)c.lineTo(pts[j].x,pts[j].y);
      c.strokeStyle='rgba(255,255,255,'+(la*.6)+')';
      c.lineWidth=.4;c.stroke();
    }
    // Scan line effect
    const scanY=(t*80)%h;
    c.fillStyle='rgba('+baseR+','+baseG+','+baseB+',0.06)';
    c.fillRect(0,scanY,w,2);
  }
  let frame=0;
  function animate(){
    const now=performance.now();
    const t=(now-t0)/1000;
    const progress=Math.min(1,t/4.2);
    // Clear background
    ctx.clearRect(0,0,W,H);
    // Dark vignette
    const vg=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,Math.max(W,H)*.7);
    vg.addColorStop(0,'transparent');
    vg.addColorStop(1,'rgba(0,0,0,.3)');
    ctx.fillStyle=vg;ctx.fillRect(0,0,W,H);
    // Generate new bolts periodically
    if(frame%4===0)genBgBolts(3+Math.floor(progress*5));
    // Draw background bolts
    bgBolts.forEach(b=>{
      const a=b.alpha*(1-b.life/b.maxLife)*(.5+progress*.5);
      if(a<=0)return;
      drawBolt(ctx,b.pts,a,b.width,glowR,glowG,glowB);
      b.branches.forEach(br=>drawBolt(ctx,br,a*.6,b.width*.6,glowR,glowG,glowB));
      b.life+=.5;
    });
    // Center glow pulse
    const gSize=20+Math.sin(t*4)*10+progress*30;
    const cg=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,gSize);
    cg.addColorStop(0,'rgba('+baseR+','+baseG+','+baseB+','+(0.3+progress*.3)+')');
    cg.addColorStop(.5,'rgba('+baseR+','+baseG+','+baseB+',0.08)');
    cg.addColorStop(1,'transparent');
    ctx.fillStyle=cg;ctx.fillRect(W/2-gSize,H/2-gSize,gSize*2,gSize*2);
    // Streaking energy lines radiating outward
    if(progress>.2){
      const lineCount=Math.floor(progress*12);
      for(let i=0;i<lineCount;i++){
        const angle=(i/lineCount)*Math.PI*2+t*.3;
        const len=30+progress*120+Math.sin(t*5+i)*20;
        const x0=W/2+Math.cos(angle)*8;
        const y0=H/2+Math.sin(angle)*8;
        const x1=W/2+Math.cos(angle)*len;
        const y1=H/2+Math.sin(angle)*len;
        ctx.beginPath();ctx.moveTo(x0,y0);ctx.lineTo(x1,y1);
        ctx.strokeStyle='rgba('+baseR+','+baseG+','+baseB+','+(0.1+Math.random()*.15)+')';
        ctx.lineWidth=.5+Math.random();ctx.stroke();
      }
    }
    // Phone screen animations (mirrored — left phone shows energy from right edge, right from left)
    if(ctxL&&ctxR){
      drawPhoneLightning(ctxL,92,160,t,false);
      drawPhoneLightning(ctxR,92,160,t,true);
    }
    frame++;
    _etAnim=requestAnimationFrame(animate);
  }
  _etAnim=requestAnimationFrame(animate);
}
function stopElectricTouch(){
  if(_etAnim){cancelAnimationFrame(_etAnim);_etAnim=null}
  const bg=$('coCanvas');if(bg){const c=bg.getContext('2d');c.clearRect(0,0,bg.width,bg.height)}
  const cL=$('coPhoneL'),cR=$('coPhoneR');
  if(cL)cL.getContext('2d').clearRect(0,0,92,160);
  if(cR)cR.getContext('2d').clearRect(0,0,92,160);
}

// ═══ REVEAL — cinematographic ═══
let _rvLightAnim=null;
let _rvLightHandler=null;
function stopRevealLight(){
  if(_rvLightAnim){cancelAnimationFrame(_rvLightAnim);_rvLightAnim=null}
  if(_rvLightHandler){window.removeEventListener('deviceorientation',_rvLightHandler);_rvLightHandler=null}
}
// beamColor: 'white'=new, 'gold'=known>24h, 'green'=renewed<24h, 'red'=<1h no bonus
function startRevealLight(beamColor){
  stopRevealLight();
  const cv=$('rvLightBeam');if(!cv)return;
  const dpr=window.devicePixelRatio||1;
  // Always use window dimensions to guarantee full coverage
  const W=window.innerWidth;
  const H=window.innerHeight;
  cv.width=W*dpr;cv.height=H*dpr;
  cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');
  ctx.scale(dpr,dpr);
  // Color palettes: [ambient, mid, core, hot, particle, edge]
  const palettes={
    white:{a:'200,210,230',m:'180,190,210',c:'220,230,245',h:'245,248,255',p:'210,220,240',e:'180,200,230'},
    gold:{a:'255,180,60',m:'255,160,50',c:'255,200,100',h:'255,235,180',p:'255,190,100',e:'255,170,50'},
    green:{a:'60,220,130',m:'40,200,110',c:'80,240,150',h:'180,255,210',p:'100,230,160',e:'50,210,120'},
    red:{a:'255,80,80',m:'255,60,60',c:'255,120,100',h:'255,200,180',p:'255,100,90',e:'255,70,70'}
  };
  const C=palettes[beamColor]||palettes.white;
  let tiltY=0,rawTY=0;
  _rvLightHandler=function(e){
    rawTY=Math.max(-1,Math.min(1,(e.gamma||0)/10));
  };
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(function(p){
      if(p==='granted')window.addEventListener('deviceorientation',_rvLightHandler);
    }).catch(function(){});
  }else{
    window.addEventListener('deviceorientation',_rvLightHandler);
  }
  const t0=performance.now();
  const particles=Array.from({length:40},()=>({
    x:Math.random()*W,vx:0.5+Math.random()*1.5,
    yOff:(Math.random()-0.5)*0.5,
    r:0.4+Math.random()*1.2,a:0.08+Math.random()*0.2,
    phase:Math.random()*Math.PI*2
  }));
  function animate(){
    const t=(performance.now()-t0)/1000;
    tiltY+=(rawTY-tiltY)*0.18;
    ctx.clearRect(0,0,W,H);
    const beamCY=H*0.47+tiltY*H*0.35;
    const breathe=1+Math.sin(t*0.9)*0.06;
    const tubeH=45*breathe;
    // Layer 1: Wide ambient — full rect 0 to W
    const g1=ctx.createLinearGradient(0,beamCY-tubeH*3,0,beamCY+tubeH*3);
    g1.addColorStop(0,'transparent');
    g1.addColorStop(0.3,'rgba('+C.a+',.015)');
    g1.addColorStop(0.5,'rgba('+C.a+',.035)');
    g1.addColorStop(0.7,'rgba('+C.a+',.015)');
    g1.addColorStop(1,'transparent');
    ctx.fillStyle=g1;ctx.fillRect(0,0,W,H);
    // Layer 2: Medium band
    const g2=ctx.createLinearGradient(0,beamCY-tubeH*1.2,0,beamCY+tubeH*1.2);
    g2.addColorStop(0,'transparent');
    g2.addColorStop(0.25,'rgba('+C.m+',.025)');
    g2.addColorStop(0.5,'rgba('+C.m+',.06)');
    g2.addColorStop(0.75,'rgba('+C.m+',.025)');
    g2.addColorStop(1,'transparent');
    ctx.fillStyle=g2;ctx.fillRect(0,0,W,H);
    // Layer 3: Narrow core
    const g3=ctx.createLinearGradient(0,beamCY-tubeH*0.35,0,beamCY+tubeH*0.35);
    g3.addColorStop(0,'transparent');
    g3.addColorStop(0.3,'rgba('+C.c+',.04)');
    g3.addColorStop(0.5,'rgba('+C.c+',.08)');
    g3.addColorStop(0.7,'rgba('+C.c+',.04)');
    g3.addColorStop(1,'transparent');
    ctx.fillStyle=g3;ctx.fillRect(0,0,W,H);
    // Layer 4: Hot wire
    const g4=ctx.createLinearGradient(0,beamCY-2,0,beamCY+2);
    g4.addColorStop(0,'transparent');
    g4.addColorStop(0.5,'rgba('+C.h+',.05)');
    g4.addColorStop(1,'transparent');
    ctx.fillStyle=g4;ctx.fillRect(0,0,W,H);
    // Flowing streaks left→right
    for(let i=0;i<5;i++){
      const sx=((t*60+i*W/5)%(W+160))-80;
      const sLen=80+Math.sin(t*0.8+i)*30;
      const sy=beamCY+Math.sin(t*1.2+i*1.3)*tubeH*0.3;
      const sg=ctx.createLinearGradient(sx,sy,sx-sLen,sy);
      sg.addColorStop(0,'rgba('+C.p+',.1)');
      sg.addColorStop(0.6,'rgba('+C.p+',.04)');
      sg.addColorStop(1,'transparent');
      ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx-sLen,sy+Math.sin(t+i)*2);
      ctx.strokeStyle=sg;ctx.lineWidth=1+Math.sin(t*2+i)*0.5;ctx.lineCap='round';ctx.stroke();
    }
    // Particles
    particles.forEach(p=>{
      p.x+=p.vx;
      if(p.x>W+10)p.x=-10;
      const py=beamCY+p.yOff*tubeH+Math.sin(t*0.6+p.phase)*tubeH*0.12;
      const fl=p.a+Math.sin(t*2.5+p.phase)*0.06;
      if(fl>0){
        ctx.beginPath();ctx.arc(p.x,py,p.r,0,Math.PI*2);
        ctx.fillStyle='rgba('+C.p+','+fl.toFixed(3)+')';ctx.fill();
      }
    });
    // Edge lines
    const ea=0.02+Math.sin(t*0.5)*0.008;
    ctx.beginPath();ctx.moveTo(0,beamCY-tubeH*0.5);ctx.lineTo(W,beamCY-tubeH*0.5);
    ctx.strokeStyle='rgba('+C.e+','+ea+')';ctx.lineWidth=0.5;ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,beamCY+tubeH*0.5);ctx.lineTo(W,beamCY+tubeH*0.5);
    ctx.strokeStyle='rgba('+C.e+','+ea+')';ctx.lineWidth=0.5;ctx.stroke();
    _rvLightAnim=requestAnimationFrame(animate);
  }
  _rvLightAnim=requestAnimationFrame(animate);
}

function doReveal(data){
  const a=data.userA,b=data.userB;
  const meIsA=a.id===state.userId;
  const me=meIsA?a:b,them=meIsA?b:a;
  const meColor=me.color||nickColor(me.name||'??'),themColor=them.color||nickColor(them.name||'??');
  const isDigital=data.type==='digital';

  // 0. Determine beam color based on relationship status
  // white=first encounter, gold=known but >24h since last, green=re-encounter <24h, red=<1h no bonus
  let beamColor='white';
  if(data.lastEncounter){
    const sinceMs=Date.now()-data.lastEncounter.timestamp;
    const hrs=sinceMs/3600000;
    if(hrs<1)beamColor='red';
    else if(hrs<24)beamColor='green';
    else beamColor='gold';
  }
  startRevealLight(beamColor);

  // 1. Avatars — always try photo first (profilePhoto, photoURL, state)
  const myPhoto=me.profilePhoto||me.photoURL||state.userPhoto;
  const theirPhoto=them.profilePhoto||them.photoURL;
  if(myPhoto){
    $('rvAvatarMeInner').innerHTML='<img class="rv-avatar-img" src="'+esc(myPhoto)+'" alt="" onerror="this.outerHTML=makeAvatar(\''+esc(me.name||'??').replace(/'/g,"\\'")+'\',\''+esc(meColor)+'\',56)">';
  }else{
    $('rvAvatarMeInner').innerHTML=makeAvatar(me.name,meColor,56);
  }
  if(theirPhoto){
    $('rvAvatarThemInner').innerHTML='<img class="rv-avatar-img" src="'+esc(theirPhoto)+'" alt="" onerror="this.outerHTML=makeAvatar(\''+esc(them.name||'??').replace(/'/g,"\\'")+'\',\''+esc(themColor)+'\',56)">';
  }else{
    $('rvAvatarThemInner').innerHTML=makeAvatar(them.name,themColor,56);
  }
  $('rvNameMe').textContent=me.realName||me.name||'?';
  $('rvNameThem').textContent=them.realName||them.name||'?';

  // 2. Moment label
  const moment=$('revealMoment');
  moment.textContent=isDigital?'uma conexão nasceu':'algo nasceu entre vocês';

  // 3. Renewed
  data.renewed?$('revealRenewed').classList.remove('hidden'):$('revealRenewed').classList.add('hidden');

  // 4. Last encounter
  const lastEl=$('revealLast');
  if(data.lastEncounter){
    const ago=Date.now()-data.lastEncounter.timestamp;
    const days=Math.floor(ago/86400000),hrs=Math.floor((ago%86400000)/3600000);
    let agoStr=days>0?days+'d '+hrs+'h atrás':hrs>0?hrs+'h atrás':'agora';
    lastEl.innerHTML='Último: <strong>'+agoStr+'</strong>';
    lastEl.classList.remove('hidden');
  }else lastEl.classList.add('hidden');

  // 5. Phrase — word by word, THE star
  const el=$('revealPhrase');el.innerHTML='';
  const baseDelay=0.8;
  data.phrase.split(' ').forEach((w,i)=>{
    const s=document.createElement('span');s.className='rv-word';
    s.textContent=w+'\u00A0';
    s.style.animationDelay=(baseDelay+i*0.22)+'s';
    el.appendChild(s);
  });

  // 6. Zodiac (minimal)
  const zodiacArea=$('zodiacArea');
  if(data.zodiacPhrase&&data.userA?.signInfo&&data.userB?.signInfo){
    const sA=meIsA?data.userA.signInfo:data.userB.signInfo;
    const sB=meIsA?data.userB.signInfo:data.userA.signInfo;
    zodiacArea.classList.remove('hidden');
    zodiacArea.innerHTML='<div class="zodiac-phrase">'+esc(data.zodiacPhrase)+'</div>';
  }else{zodiacArea.classList.add('hidden');zodiacArea.innerHTML=''}

  // 7. Reset selfie
  releaseSelfieCamera();
  $('selfiePreview').style.display='none';$('selfiePreview').innerHTML='';
  const capBtn=$('selfieCapBtn');
  if(capBtn){capBtn.innerHTML='<span class="rv-ico">📸</span>Selfie';capBtn.disabled=false}
  $('revealActions').style.opacity='';

  // 12. Gorjeta button — show if the other person is a prestador
  const tipBtn=$('revealTipBtn');
  if(tipBtn){
    if(them.isPrestador){
      tipBtn.classList.remove('hidden');
      tipBtn.dataset.receiverId=them.id;
      const lbl=$('revealTipLabel');
      if(lbl)lbl.textContent='Dar gorjeta'+(them.serviceLabel?' — '+them.serviceLabel:'');
    }else{
      tipBtn.classList.add('hidden');
    }
  }
}

function openTipFromReveal(){
  const btn=$('revealTipBtn');
  if(btn&&btn.dataset.receiverId) showTipScreen(btn.dataset.receiverId);
}

// ═══ CHAT ═══
function enterChat(){if(state.currentRelation)openChat(state.currentRelation)}
async function openChat(rel){
  state.currentRelation=rel;pulseSent=false;
  const pb=$('pulseBtn');if(pb)pb.style.opacity='1';
  const partner=(rel.userA?.id===state.userId)?rel.userB:rel.userA;
  const pNick=partner?.nickname||rel.partnerName||'Pessoa';
  const pRealName=partner?.realName||null;
  const pName=pRealName||pNick;
  state.currentPartnerId=partner?.id||rel.partnerId||null;
  // Show real name with indicator, or just nickname
  if(pRealName&&pRealName!==pNick){
    $('chatPartner').textContent=pRealName;
    $('chatSub').innerHTML='<span style="color:var(--ok)">✓ ID revelado</span> · @'+esc(pNick);
  }else{
    $('chatPartner').textContent=pNick;
    $('chatSub').textContent='nickname';
  }
  // Show/hide ID action buttons — check BOTH directions of reveal
  const idBar=$('chatIdBar');
  if(idBar){
    // Bilateral reveal: if both revealed (partner has realName AND I revealed), hide all
    const partnerRevealed=!!(pRealName&&pRealName!==pNick);
    const iRevealed=!!(rel.iRevealedToPartner||(state.revealedIds&&state.revealedIds[state.currentPartnerId]&&state.revealedIds[state.currentPartnerId]._iRevealed));
    if(partnerRevealed&&iRevealed){
      idBar.style.display='none';
    }else{
      idBar.style.display='flex';
      // Single button: "Trocar IDs" (combines request + reveal)
      const revBtn=$('revealIdBtn');
      const reqBtn=$('requestIdBtn');
      if(reqBtn)reqBtn.style.display='none'; // hide old request button
      if(revBtn){revBtn.style.display='';revBtn.disabled=false;revBtn.style.opacity='1';revBtn.textContent='🪪 Trocar IDs'}
    }
  }
  $('chatPhrase').textContent=rel.phrase;
  closePlusMenu();hideTyping();
  const mc=$('chatMessages'),ti=$('typingIndicator');mc.innerHTML='';mc.appendChild(ti);
  loadQuickPhrases();
  try{(await(await fetch('/api/messages/'+rel.relationId)).json()).forEach(m=>{
    if(m.type==='ephemeral')appendEphemeral(m,true);
    else if(m.type==='photo')appendPhoto(m);
    else appendMessage(m);
  })}catch(e){}
  // Load partner score + stars into subtitle
  try{
    const ps=await fetch('/api/partner-score/'+rel.relationId+'/'+state.userId).then(r=>r.json());
    if(ps.score!=null){
      $('partnerPtsNum').textContent=ps.score;
      const sub=$('chatSub');
      const extra=(ps.stars>0?' · ⭐'+ps.stars:'')+(ps.score>0?' · '+ps.score+'pts':'');
      if(pRealName&&pRealName!==pNick){
        sub.innerHTML='<span style="color:var(--ok)">✓ ID</span> · @'+esc(pNick)+extra;
      }else{
        sub.innerHTML='nickname'+extra;
      }
    }
  }catch(e){}
  // Load streak
  loadStreak();
  startChatTimer(rel.expiresAt);showScreen('chat');
  // Mark as read
  localStorage.setItem('lastRead_'+rel.relationId,Date.now().toString());
  requestAnimationFrame(()=>{mc.scrollTop=mc.scrollHeight;$('chatInput').focus()});
}
async function loadStreak(){
  if(!state.currentPartnerId)return;
  try{
    const s=await fetch('/api/streak/'+state.userId+'/'+state.currentPartnerId).then(r=>r.json());
    const el=$('chatStreak');
    if(s.currentStreak>0){
      el.classList.remove('hidden');
      $('chatStreakText').innerHTML='<span class="streak-fire">🔥</span> '+s.currentStreak+' dia'+(s.currentStreak>1?'s':'');
      if(s.nextUnlock){
        const pct=Math.min(100,Math.round((s.currentStreak/s.nextUnlock.days)*100));
        $('chatStreakBar').style.width=pct+'%';
        $('chatStreakNext').textContent=s.nextUnlock.label+' em '+(s.nextUnlock.days-s.currentStreak)+'d';
      }else{
        $('chatStreakBar').style.width='100%';
        $('chatStreakNext').textContent='Todas conquistas desbloqueadas!';
      }
    }else el.classList.add('hidden');
  }catch(e){}
}
function appendMessage(msg){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');div.className='msg '+(msg.userId===state.userId?'mine':'theirs');
  const t=new Date(msg.timestamp);div.innerHTML=esc(msg.text)+'<div class="mt">'+pad(t.getHours())+':'+pad(t.getMinutes())+'</div>';
  mc.insertBefore(div,ti);if(near||msg.userId===state.userId)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
}
function sendMessage(){
  const input=$('chatInput'),text=input.value.trim();if(!text||!state.currentRelation)return;
  appendMessage({userId:state.userId,text,timestamp:Date.now()});playSound('send');haptic([30]);
  socket.emit('send-message',{relationId:state.currentRelation.relationId,userId:state.userId,text});
  input.value='';updateSendBtn();
}
function nearBot(){const el=$('chatMessages');return el.scrollHeight-el.scrollTop-el.clientHeight<80}
function startChatTimer(expiresAt){
  if(state.timerInterval)clearInterval(state.timerInterval);const el=$('chatTimer');
  let lastSec=-1;
  function tick(){
    const d=expiresAt-Date.now();
    if(d<=0){el.textContent='Expirado';el.classList.add('urg');clearInterval(state.timerInterval);showExpireCard();return}
    const sec=Math.floor(d/1000);
    el.textContent=pad(Math.floor(d/3600000))+':'+pad(Math.floor((d%3600000)/60000))+':'+pad(Math.floor((d%60000)/1000));
    el.classList.toggle('urg',d<3600000);
    // Pulse animation on second change
    if(sec!==lastSec){lastSec=sec;el.style.transform='scale(1.08)';setTimeout(()=>{el.style.transform='scale(1)'},150)}
  }
  tick();state.timerInterval=setInterval(tick,1000);
}

// ═══ HOROSCOPE ═══
async function getHoroscope(){
  if(!state.currentRelation)return;
  try{
    const r=await fetch('/api/horoscope/'+state.currentRelation.relationId+'/'+state.userId);
    const d=await r.json();
    if(d.error)return showToast(d.error);
    // Show as system message in chat
    const text='✨ '+d.phrase;
    appendMessage({userId:'system',text,timestamp:Date.now()});
    // Also emit so partner sees it
    socket.emit('send-message',{relationId:state.currentRelation.relationId,userId:'system',text});
    haptic([30,20,30]);
  }catch(e){showToast('Erro ao consultar astros.')}
}

// ═══ PULSE ═══
function sendPulse(){
  if(!state.currentRelation||pulseSent)return;
  socket.emit('pulse',{relationId:state.currentRelation.relationId,userId:state.userId});
  pulseSent=true;const pb=$('pulseBtn');if(pb)pb.style.opacity='.35';
  // Heartbeat vibration: lub-dub, lub-dub, lub-dub
  haptic([120,60,80,300,120,60,80,300,120,60,80]);
  showToast('Pulso enviado');
}

// ═══ SELFIE ═══
function requestSelfie(){
  if(!state.currentRelation)return;
  const input=document.createElement('input');input.type='file';input.accept='image/*';input.capture='user';
  input.onchange=async()=>{
    const file=input.files[0];if(!file)return;
    const c=document.createElement('canvas'),ctx=c.getContext('2d'),img=new Image();
    img.onload=async()=>{
      c.width=400;c.height=400;const sc=Math.max(400/img.width,400/img.height);
      ctx.drawImage(img,(400-img.width*sc)/2,(400-img.height*sc)/2,img.width*sc,img.height*sc);
      const data=c.toDataURL('image/jpeg',.6);
      await fetch('/api/selfie/'+state.currentRelation.relationId,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,selfieData:data})});
      showToast('Selfie enviada!');
    };img.src=URL.createObjectURL(file);
  };input.click();
}

// ═══ TYPING ═══
function handleTyping(){if(!state.currentRelation||!socket)return;const now=Date.now();if(now-lastTypingEmit>2000){socket.emit('typing',{relationId:state.currentRelation.relationId,userId:state.userId});lastTypingEmit=now}}
function showTyping(){$('typingIndicator').classList.add('vis');if(nearBot())$('chatMessages').scrollTo({top:99999,behavior:'smooth'});clearTimeout(typingTimeout);typingTimeout=setTimeout(hideTyping,3000)}
function hideTyping(){$('typingIndicator').classList.remove('vis')}

// ═══ QUICK PHRASES (EPHEMERAL) ═══
const QUICK_PHRASES=['Observei','Gostei','Algo ficou','Curioso','Queria te ver','Sem pressa','Sorrindo aqui','Pensando em ti'];
function loadQuickPhrases(){
  const bar=$('quickPhrases');if(!bar)return;bar.innerHTML='';
  QUICK_PHRASES.forEach(p=>{
    const chip=document.createElement('button');chip.className='qp-chip';chip.type='button';chip.textContent=p;
    chip.onclick=()=>{sendEphemeral(p);chip.classList.add('sent')};
    bar.appendChild(chip);
  });
}
function sendEphemeral(text){
  if(!state.currentRelation)return;
  const msg={userId:state.userId,text,type:'ephemeral',timestamp:Date.now()};
  appendEphemeral(msg);haptic([40,20,40]);
  socket.emit('send-ephemeral',{relationId:state.currentRelation.relationId,userId:state.userId,text});
}
function appendEphemeral(msg,fromHistory){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');
  div.className='msg ephemeral'+(msg.userId===state.userId?' mine':'');
  div.innerHTML=esc(msg.text)+'<span class="eph-badge">efêmera</span>';
  mc.insertBefore(div,ti);
  if(near||msg.userId===state.userId)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
  // Only auto-fade on real-time receive, not from history
  if(!fromHistory){
    setTimeout(()=>{div.style.transition='opacity .6s,transform .6s';div.style.opacity='0';div.style.transform='scale(.95)';setTimeout(()=>div.remove(),700)},8000);
  }
}

// ═══ PHOTO / FILE IN CHAT ═══
function pickPhoto(){
  closePlusMenu();if(!state.currentRelation)return;
  const input=document.createElement('input');input.type='file';input.accept='image/*';
  input.onchange=()=>{const file=input.files[0];if(file)processAndSendPhoto(file)};
  input.click();
}
function pickFile(){
  closePlusMenu();if(!state.currentRelation)return;
  const input=document.createElement('input');input.type='file';input.accept='image/*,.pdf,.doc,.docx,.txt';
  input.onchange=()=>{
    const file=input.files[0];if(!file)return;
    if(file.type.startsWith('image/'))processAndSendPhoto(file);
    else{showToast('Enviado: '+file.name);haptic([30])}
  };input.click();
}
function processAndSendPhoto(file){
  const reader=new FileReader();
  reader.onload=()=>{
    const img=new Image();img.onload=()=>{
      const c=document.createElement('canvas'),ctx=c.getContext('2d');
      const maxW=600,sc=Math.min(maxW/img.width,maxW/img.height,1);
      c.width=img.width*sc;c.height=img.height*sc;
      ctx.drawImage(img,0,0,c.width,c.height);
      const dataUrl=c.toDataURL('image/jpeg',.7);
      const msg={userId:state.userId,type:'photo',photoData:dataUrl,timestamp:Date.now()};
      appendPhoto(msg);haptic([30]);
      socket.emit('send-photo',{relationId:state.currentRelation.relationId,userId:state.userId,photoData:dataUrl});
    };img.src=reader.result;
  };reader.readAsDataURL(file);
}
function appendPhoto(msg){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');div.className='msg photo '+(msg.userId===state.userId?'mine':'theirs');
  const imgEl=document.createElement('img');imgEl.src=msg.photoData;imgEl.loading='lazy';
  imgEl.onclick=()=>{window.open(msg.photoData,'_blank')};
  div.appendChild(imgEl);
  const t=new Date(msg.timestamp);const tm=document.createElement('div');tm.className='mt';
  tm.textContent=pad(t.getHours())+':'+pad(t.getMinutes());div.appendChild(tm);
  mc.insertBefore(div,ti);
  if(near||msg.userId===state.userId)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
}

// ═══ PLUS MENU ═══
function togglePlusMenu(){const m=$('plusMenu');m.classList.toggle('open')}
function closePlusMenu(){const m=$('plusMenu');if(m)m.classList.remove('open')}

// ═══ STREAK UNLOCK ═══
function showStreakUnlock(data){
  const overlay=document.createElement('div');overlay.className='streak-unlock-overlay';
  let contentHtml='';
  if(data.question)contentHtml='<div class="su-content">'+esc(data.question)+'</div>';
  if(data.phrases)contentHtml='<div class="su-content" style="max-height:200px;overflow-y:auto;font-size:.75rem">'+data.phrases.map(p=>'<div style="margin-bottom:.3rem">"'+esc(p.phrase)+'" <span style="opacity:.4;font-size:.6rem">'+p.date+'</span></div>').join('')+'</div>';
  overlay.innerHTML='<div class="streak-unlock-card"><div class="su-emoji">🔥</div><div class="su-title">'+data.streakDays+' dias seguidos!</div><div style="font-size:.75rem;color:var(--t3);margin-bottom:.8rem">Desbloqueado: '+esc(data.unlock.label)+'</div><div class="su-desc">'+esc(data.unlock.description)+'</div>'+contentHtml+'<button class="bp" style="max-width:200px;margin:0 auto" onclick="this.closest(\'.streak-unlock-overlay\').remove()">Incrível!</button></div>';
  document.body.appendChild(overlay);
  haptic([100,50,100,50,100]);playSound('connect');
}

// ═══ TOUCH LINK ═══
let touchLinkData=null;
async function loadTouchLink(){
  try{
    const r=await fetch('/api/touch-link/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
    const d=await r.json();if(d.url){touchLinkData=d;$('touchLinkUrl').textContent=d.url}
  }catch(e){$('touchLinkUrl').textContent='Erro ao gerar link'}
}
function copyTouchLink(){
  if(!touchLinkData)return;
  navigator.clipboard.writeText(touchLinkData.url).then(()=>showToast('Link copiado!')).catch(()=>{
    const ta=document.createElement('textarea');ta.value=touchLinkData.url;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();showToast('Link copiado!');
  });
}
function showTouchQR(){
  const area=$('touchQRArea');
  if(area.style.display!=='none'){area.style.display='none';return}
  area.style.display='block';area.innerHTML='';
  if(touchLinkData&&typeof QRCode!=='undefined'){new QRCode(area,{text:touchLinkData.url,width:160,height:160,colorDark:'#ff6b35',colorLight:'#0a0a10'})}
}

// ═══ RELATIONS ═══
async function refreshRelations(){
  if(!state.userId)return;
  try{
    const rels=await(await fetch('/api/relations/'+state.userId)).json();
    state._cachedRels=rels; // cache for showRelations
    const badge=$('relBadge'),count=$('relCount');
    if(rels.length>0){
      badge.classList.remove('hidden');
      // Count unread from server data (fast, no extra fetches)
      let unread=0;
      for(const r of rels){
        if(r.lastMessageUserId&&r.lastMessageUserId!==state.userId){
          const lastRead=parseInt(localStorage.getItem('lastRead_'+r.id)||'0');
          if(r.lastMessageTime>lastRead)unread++;
        }
      }
      count.textContent=unread>0?unread:rels.length;
      if(unread>0){badge.style.background='rgba(255,107,53,.15)';badge.style.borderColor='var(--ac)'}
      else{badge.style.background='rgba(255,255,255,.04)';badge.style.borderColor='rgba(255,255,255,.06)'}
    }else badge.classList.add('hidden');
  }catch(e){}
}
async function showRelations(){
  haptic([30]);
  try{
    const rels=await(await fetch('/api/relations/'+state.userId)).json();const list=$('relationsList');
    if(!rels.length){list.innerHTML='<div class="nr"><div class="nr-icon">✦</div>Nenhuma conexão ativa.<div class="nr-text">Encoste em alguém para criar algo que só existe aqui.</div></div>'}
    else{
      const sub=$('relSubtitle');if(sub)sub.textContent=rels.length+' conex'+(rels.length===1?'ão':'ões');
      list.innerHTML='';rels.forEach((r,idx)=>{
      const h=Math.floor(r.timeLeft/3600000),m=Math.floor((r.timeLeft%3600000)/60000);
      let tc='ok';if(r.timeLeft<3600000)tc='low';else if(r.timeLeft<43200000)tc='med';
      const card=document.createElement('div');card.className='rc';card.style.animationDelay=(idx*0.06)+'s';card.style.animation='mi .35s ease '+(idx*0.06)+'s both';
      const pColor=r.partnerColor||nickColor(r.partnerName||'??');
      const timeLabel=tc==='low'?'expirando':'restante';
      const displayName=r.partnerRealName||r.partnerName;
      const isRevealed=r.partnerRealName&&r.partnerRealName!==r.partnerName;
      const photoHtml=r.partnerPhoto?'<div style="width:48px;height:48px;border-radius:50%;overflow:hidden;flex-shrink:0;border:1.5px solid rgba(255,255,255,.12)"><img src="'+r.partnerPhoto+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>':makeAvatar(r.partnerName,pColor,48);
      const nameHtml='<div class="rn">'+esc(displayName)+(isRevealed?' <span style="font-size:.55rem;color:var(--ok)">✓ ID</span>':'')+'</div>'+(isRevealed?'<div style="font-size:.6rem;color:var(--t3);margin-top:.1rem">@'+esc(r.partnerName)+'</div>':'');
      // Unread count for this relation
      const lastRead=parseInt(localStorage.getItem('lastRead_'+r.id)||'0');
      const unreadCount=(r.lastMessageTime&&r.lastMessageUserId&&r.lastMessageUserId!==state.userId&&r.lastMessageTime>lastRead)?1:0;
      // Preview text
      const previewHtml=r.lastMessagePreview?'<div class="rp-preview">'+esc(r.lastMessagePreview)+'</div>':'<div class="rp">"'+esc(r.phrase)+'"</div>';
      const unreadBadge=unreadCount>0?'<div class="rc-unread"></div>':'';
      card.innerHTML=photoHtml+'<div class="ri">'+nameHtml+previewHtml+'</div><div class="rtm-wrap">'+unreadBadge+'<div class="rtm '+tc+'">'+h+'h '+m+'m</div><div class="rtm-label">'+timeLabel+'</div></div>';
      const rpid=r.userA===state.userId?r.userB:r.userA;
      card.addEventListener('click',()=>openChat({relationId:r.id,phrase:r.phrase,expiresAt:r.expiresAt,partnerName:r.partnerName,partnerId:rpid,iRevealedToPartner:r.iRevealedToPartner,partnerRevealedToMe:r.partnerRevealedToMe,userA:{id:r.userA,nickname:r.userA===state.userId?state.userName:r.partnerName,realName:r.userA===state.userId?null:r.partnerRealName},userB:{id:r.userB,nickname:r.userB===state.userId?state.userName:r.partnerName,realName:r.userB===state.userId?null:r.partnerRealName}}));
      list.appendChild(card);
    })}
    showScreen('relations');
  }catch(e){showToast('Erro ao carregar.')}
}

// ═══ CONSTELLATION ═══
let constState={nodes:[],cam:{x:0,y:0,zoom:1},dragging:false,lastTouch:null,animFrame:null,selectedNode:null};
const CONST_FEEDBACK=['Um novo ponto surgiu.','Sua rede cresceu hoje.','Um encontro deixou rastro.','Um elo foi reforçado.','Algo ficou marcado.','A constelação se expandiu.'];

async function showHistory(){
  haptic([30]);
  try{
    const data=await(await fetch('/api/constellation/'+state.userId)).json();
    const empty=$('constEmpty');
    if(!data.nodes||!data.nodes.length){empty.classList.remove('hidden');constState.nodes=[];showScreen('history');requestAnimationFrame(()=>requestAnimationFrame(()=>initConstCanvas()));return}
    empty.classList.add('hidden');
    // Layout nodes in 3D space — z-depth based on time since last encounter
    const now=Date.now();
    const nodes=data.nodes.map((n,i)=>{
      const angle=(i/data.nodes.length)*Math.PI*2-Math.PI/2;
      // Time-based depth: recent=close (z~20), expiring 24h=medium (z~120), old=far (z~250)
      const lastMs=n.lastDate?now-new Date(n.lastDate).getTime():999999999;
      const hrs=lastMs/3600000;
      let zDepth;
      if(hrs<1)zDepth=15+Math.random()*15;          // <1h → very close
      else if(hrs<6)zDepth=35+Math.random()*30;      // <6h → close
      else if(hrs<12)zDepth=70+Math.random()*30;     // <12h → medium-close
      else if(hrs<24)zDepth=110+Math.random()*40;    // <24h → medium-far
      else zDepth=160+Math.min(120,hrs*0.5)+Math.random()*40; // >24h → far, grows with time
      // Spread on X/Y plane proportional to depth for organic feel
      const spread=40+zDepth*0.5;
      const sizeByEnc=Math.min(22,6+Math.log2(1+(n.encounters||1))*5);
      return{...n,
        x3d:Math.cos(angle)*spread+(Math.random()-.5)*30,
        y3d:Math.sin(angle)*spread+(Math.random()-.5)*30,
        z3d:zDepth,
        color:n.color||nickColor(n.nickname||'?'),baseRadius:sizeByEnc,pulsePhase:Math.random()*Math.PI*2};
    });
    // Pre-load images for nodes with photos
    nodes.forEach(n=>{
      const src=n.profilePhoto||n.lastSelfie;
      if(src){
        const img=new Image();
        img.crossOrigin='anonymous';
        img.src=src;
        n._img=img;n._imgLoaded=false;
        img.onload=()=>{n._imgLoaded=true};
      }
    });
    constState.nodes=nodes;
    constState.cam={x:0,y:0,zoom:1};
    constState.selectedNode=null;
    // Pre-load user's own photo for center node
    if(state.userPhoto&&!constState._myImgLoaded){
      const mi=new Image();mi.crossOrigin='anonymous';mi.src=state.userPhoto;
      constState._myImg=mi;constState._myImgLoaded=false;
      mi.onload=()=>{constState._myImgLoaded=true};
    }
    hideConstDetail();
    showScreen('history');
    // Wait for screen to become visible before measuring canvas
    requestAnimationFrame(()=>requestAnimationFrame(()=>initConstCanvas()));
    // Show feedback if new nodes since last visit
    const prevCount=parseInt(localStorage.getItem('touch_const_count')||'0');
    if(data.total>prevCount&&prevCount>0){
      const fb=$('constFeedback');
      fb.textContent=CONST_FEEDBACK[Math.floor(Math.random()*CONST_FEEDBACK.length)];
      fb.classList.add('show');
      setTimeout(()=>fb.classList.remove('show'),3500);
    }
    localStorage.setItem('touch_const_count',String(data.total));
  }catch(e){showToast('Erro ao carregar.')}
}

function initConstCanvas(){
  const canvas=$('constCanvas');if(!canvas)return;
  const wrap=canvas.parentElement;
  const dpr=window.devicePixelRatio||1;
  canvas.width=wrap.clientWidth*dpr;
  canvas.height=wrap.clientHeight*dpr;
  canvas.style.width=wrap.clientWidth+'px';
  canvas.style.height=wrap.clientHeight+'px';
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  const W=wrap.clientWidth,H=wrap.clientHeight;

  // ── 3D Perspective parameters ──
  const FOV=300; // field of view — higher = less extreme perspective

  // ── Accelerometer tilt ──
  let tiltX=0,tiltY=0,rawTX=0,rawTY=0;
  function onDevOri(e){
    rawTX=(e.gamma||0)/25;rawTY=(e.beta||0)/25;
  }
  if(window.DeviceOrientationEvent){
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
      DeviceOrientationEvent.requestPermission().then(p=>{if(p==='granted')window.addEventListener('deviceorientation',onDevOri)}).catch(()=>{});
    }else{window.addEventListener('deviceorientation',onDevOri)}
  }
  constState._cleanGyro=()=>{window.removeEventListener('deviceorientation',onDevOri)};

  // ── Touch: 1 finger drag, 2 finger pinch+pan ──
  let pinchDist=0,pinchZoom=1,pointerStart=null,touches2Start=null;
  canvas.onpointerdown=e=>{
    constState.dragging=true;constState.lastTouch={x:e.clientX,y:e.clientY};pointerStart={x:e.clientX,y:e.clientY};
  };
  canvas.onpointermove=e=>{
    if(!constState.dragging||!constState.lastTouch)return;
    const dx=e.clientX-constState.lastTouch.x,dy=e.clientY-constState.lastTouch.y;
    constState.cam.x+=dx/constState.cam.zoom;constState.cam.y+=dy/constState.cam.zoom;
    constState.lastTouch={x:e.clientX,y:e.clientY};
  };
  canvas.onpointerup=e=>{
    if(constState.dragging&&pointerStart){
      const tapThresh=12;
      if(Math.abs(e.clientX-pointerStart.x)<tapThresh&&Math.abs(e.clientY-pointerStart.y)<tapThresh)
        handleConstTap(e.clientX-canvas.getBoundingClientRect().left,e.clientY-canvas.getBoundingClientRect().top,W,H);
    }
    constState.dragging=false;constState.lastTouch=null;pointerStart=null;
  };
  canvas.ontouchstart=e=>{
    if(e.touches.length===2){
      pinchDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      pinchZoom=constState.cam.zoom;
      touches2Start={mx:(e.touches[0].clientX+e.touches[1].clientX)/2,my:(e.touches[0].clientY+e.touches[1].clientY)/2,cx:constState.cam.x,cy:constState.cam.y};
    }
  };
  canvas.ontouchmove=e=>{
    if(e.touches.length===2){
      e.preventDefault();
      const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      constState.cam.zoom=Math.max(.15,Math.min(20,pinchZoom*(d/pinchDist)));
      if(touches2Start){
        const mx=(e.touches[0].clientX+e.touches[1].clientX)/2,my=(e.touches[0].clientY+e.touches[1].clientY)/2;
        constState.cam.x=touches2Start.cx+(mx-touches2Start.mx)/constState.cam.zoom;
        constState.cam.y=touches2Start.cy+(my-touches2Start.my)/constState.cam.zoom;
      }
    }
  };
  canvas.onwheel=e=>{e.preventDefault();constState.cam.zoom=Math.max(.15,Math.min(20,constState.cam.zoom*(e.deltaY>0?.9:1.1)))};

  // ── Particles system ──
  const particles=Array.from({length:120},()=>({
    x:(Math.random()-.5)*W*2,y:(Math.random()-.5)*H*2,
    vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,
    r:Math.random()*.8+.2,a:Math.random()*.15+.03,
    phase:Math.random()*Math.PI*2
  }));

  // ── Grid lines (subtle tech background) ──
  const gridSpacing=60;

  // ── Helper: project 3D to 2D with perspective ──
  function project(x3d,y3d,z3d,camX,camY,zoom,tOX,tOY){
    const wx=(x3d+camX+tOX)*zoom;
    const wy=(y3d+camY+tOY)*zoom;
    const scale=FOV/(FOV+z3d);
    return{
      sx:W/2+wx*scale,
      sy:H*0.45+wy*scale,
      scale:scale*zoom,
      z3d:z3d
    };
  }

  // ── Helper: draw image with center-crop (no stretching) ──
  function drawCroppedImage(img,cx,cy,r){
    const iw=img.naturalWidth||img.width;
    const ih=img.naturalHeight||img.height;
    if(!iw||!ih)return;
    // Compute center square crop from source
    const side=Math.min(iw,ih);
    const sx=(iw-side)/2;
    const sy=(ih-side)/2;
    ctx.save();
    ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.clip();
    ctx.drawImage(img,sx,sy,side,side,cx-r,cy-r,r*2,r*2);
    ctx.restore();
  }

  if(constState.animFrame)cancelAnimationFrame(constState.animFrame);

  function draw(){
    constState.animFrame=requestAnimationFrame(draw);
    ctx.clearRect(0,0,W,H);
    const t=Date.now()/1000;
    // Lerp tilt
    tiltX+=(rawTX-tiltX)*0.08;tiltY+=(rawTY-tiltY)*0.08;
    const tiltOffX=tiltX*30;const tiltOffY=tiltY*20;

    // ── Subtle hex grid ──
    ctx.save();ctx.globalAlpha=0.03;ctx.strokeStyle='#4488ff';ctx.lineWidth=.5;
    for(let gx=-gridSpacing;gx<W+gridSpacing;gx+=gridSpacing){
      const ox=gx+tiltOffX*.3+(constState.cam.x*constState.cam.zoom*.1)%gridSpacing;
      ctx.beginPath();ctx.moveTo(ox,0);ctx.lineTo(ox,H);ctx.stroke();
    }
    for(let gy=-gridSpacing;gy<H+gridSpacing;gy+=gridSpacing){
      const oy=gy+tiltOffY*.3+(constState.cam.y*constState.cam.zoom*.1)%gridSpacing;
      ctx.beginPath();ctx.moveTo(0,oy);ctx.lineTo(W,oy);ctx.stroke();
    }
    ctx.restore();

    // ── Floating particles ──
    particles.forEach(p=>{
      p.x+=p.vx;p.y+=p.vy;
      if(p.x<-W)p.x=W;if(p.x>W)p.x=-W;if(p.y<-H)p.y=H;if(p.y>H)p.y=-H;
      const sx=W/2+p.x+tiltOffX*(.5+p.r);const sy=H/2+p.y+tiltOffY*(.5+p.r);
      const flicker=p.a+Math.sin(t*2+p.phase)*.02;
      ctx.beginPath();ctx.arc(sx,sy,p.r,0,Math.PI*2);
      ctx.fillStyle='rgba(100,160,255,'+flicker.toFixed(3)+')';ctx.fill();
    });

    if(!constState.nodes.length)return;
    const z=constState.cam.zoom;
    const camX=constState.cam.x+tiltOffX;
    const camY=constState.cam.y+tiltOffY;

    // ── Project center node (me) at z=0 ──
    const meProj=project(0,0,0,camX,camY,z,0,0);
    const mcx=meProj.sx,mcy=meProj.sy;

    // ── Project all nodes and sort by z (back-to-front) ──
    const projected=constState.nodes.map(n=>{
      const p=project(n.x3d,n.y3d,n.z3d,camX,camY,z,0,0);
      // Store projected coords for tap detection
      n._px=p.sx;n._py=p.sy;n._pscale=p.scale;
      return{n,sx:p.sx,sy:p.sy,scale:p.scale,z3d:p.z3d};
    });
    projected.sort((a,b)=>b.z3d-a.z3d); // far first (back-to-front)

    // ── Draw connections — solid LED-glow lines ──
    projected.forEach(({n,sx,sy,scale})=>{
      const lineBothVerified=!!(n.partnerRevealedToMe&&n.iRevealedToPartner)||(!!((n.realName&&n.realName!==n.nickname)&&(n.iRevealedToPartner||(state.revealedIds&&state.revealedIds[n.id]&&state.revealedIds[n.id]._iRevealed))));
      const lineColor=lineBothVerified?'0,220,130':'100,140,255';
      const depthAlpha=Math.max(0.03,scale*0.8);
      const thick=Math.min(2.5,0.3+Math.log2(1+(n.encounters||1))*0.4)*scale;
      const lineAlpha=depthAlpha*(0.1+n.intensity*.2);
      ctx.save();
      // Outer glow layer (wide, soft)
      ctx.beginPath();ctx.moveTo(mcx,mcy);ctx.lineTo(sx,sy);
      ctx.strokeStyle='rgba('+lineColor+','+(lineAlpha*0.3).toFixed(3)+')';
      ctx.lineWidth=Math.max(1,thick*4);ctx.stroke();
      // Mid glow
      ctx.beginPath();ctx.moveTo(mcx,mcy);ctx.lineTo(sx,sy);
      ctx.strokeStyle='rgba('+lineColor+','+(lineAlpha*0.6).toFixed(3)+')';
      ctx.lineWidth=Math.max(0.5,thick*2);ctx.stroke();
      // Core bright line (LED center)
      ctx.beginPath();ctx.moveTo(mcx,mcy);ctx.lineTo(sx,sy);
      ctx.strokeStyle='rgba('+lineColor+','+(lineAlpha*1.2).toFixed(3)+')';
      ctx.lineWidth=Math.max(0.3,thick*0.8);ctx.stroke();
      // Traveling energy pulse
      const pulsePos=(t*0.4+n.pulsePhase)%1;
      const px=mcx+(sx-mcx)*pulsePos,py=mcy+(sy-mcy)*pulsePos;
      const pSize=Math.max(2,6*scale);
      const pg=ctx.createRadialGradient(px,py,0,px,py,pSize);
      pg.addColorStop(0,'rgba('+lineColor+','+(depthAlpha*0.7).toFixed(3)+')');
      pg.addColorStop(0.4,'rgba('+lineColor+','+(depthAlpha*0.3).toFixed(3)+')');
      pg.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(px,py,pSize,0,Math.PI*2);ctx.fillStyle=pg;ctx.fill();
      ctx.restore();
    });

    // ── Draw nodes back-to-front ──
    const MAX_NODE_R=28; // fixed max pixel size — zoom only spreads nodes apart
    projected.forEach(({n,sx,sy,scale,z3d})=>{
      const pulse=1+Math.sin(t*1.5+n.pulsePhase)*.06;
      const rawR=n.baseRadius*scale*pulse;
      const r=Math.min(rawR,MAX_NODE_R);
      if(r<0.5)return; // too small to see
      const bothVerified=!!(n.partnerRevealedToMe&&n.iRevealedToPartner)||(!!((n.realName&&n.realName!==n.nickname)&&(n.iRevealedToPartner||(state.revealedIds&&state.revealedIds[n.id]&&state.revealedIds[n.id]._iRevealed))));
      const ringColor=bothVerified?'#00dc82':'#ff4466';
      const glowRGB=bothVerified?'0,220,130':'255,68,102';
      // Depth-based opacity: close nodes=bright, far nodes=dim
      const depthAlpha=Math.max(0.15,Math.min(1,scale*1.2));

      // Outer glow (capped)
      const glowR=Math.min(r*3,50);
      ctx.save();ctx.globalAlpha=depthAlpha;
      const glow=ctx.createRadialGradient(sx,sy,0,sx,sy,glowR);
      glow.addColorStop(0,'rgba('+glowRGB+','+(0.06+n.intensity*.1).toFixed(2)+')');glow.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(sx,sy,glowR,0,Math.PI*2);ctx.fillStyle=glow;ctx.fill();

      // Node body: photo (center-cropped) or solid
      if(n._imgLoaded&&n._img&&r>4){
        drawCroppedImage(n._img,sx,sy,r);
      }else{
        ctx.beginPath();ctx.arc(sx,sy,r,0,Math.PI*2);
        const nGrad=ctx.createRadialGradient(sx-r*.3,sy-r*.3,0,sx,sy,r);
        nGrad.addColorStop(0,'rgba('+glowRGB+',0.6)');nGrad.addColorStop(1,'rgba('+glowRGB+',0.2)');
        ctx.fillStyle=nGrad;ctx.fill();
      }

      // Ring: GREEN = verified, RED = anonymous
      ctx.beginPath();ctx.arc(sx,sy,r+1,0,Math.PI*2);
      ctx.strokeStyle=ringColor;ctx.lineWidth=Math.max(0.3,Math.min(1,0.8*scale));
      ctx.shadowColor=ringColor;ctx.shadowBlur=Math.max(1,Math.min(8,6*scale));ctx.stroke();ctx.shadowBlur=0;

      // Rotating scan arc for selected node
      if(constState.selectedNode&&constState.selectedNode.id===n.id){
        const sa=(t*2)%(Math.PI*2);
        ctx.beginPath();ctx.arc(sx,sy,r+5,sa,sa+Math.PI*.5);
        ctx.strokeStyle='rgba(255,255,255,.5)';ctx.lineWidth=1.5;ctx.stroke();
      }

      // Label (only if visible enough)
      if(r>3){
        const label=n.realName||n.nickname;
        const fontSize=Math.max(6,Math.min(11,8*scale));
        ctx.fillStyle='rgba(255,255,255,'+(depthAlpha*(0.35+n.intensity*0.35)).toFixed(2)+')';
        ctx.font='500 '+fontSize+'px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='top';
        ctx.fillText(label.length>12?label.slice(0,11)+'…':label,sx,sy+r+4);
        if(n.encounters>1&&r>6){
          ctx.fillStyle='rgba(255,255,255,'+(depthAlpha*0.2).toFixed(2)+')';ctx.font=(Math.max(5,Math.min(9,6*scale)))+'px Inter,sans-serif';
          ctx.fillText(n.encounters+'x',sx,sy+r+4+fontSize+2);
        }
      }
      ctx.restore();
    });
    ctx.textBaseline='alphabetic';

    // ── Center node (me) — drawn LAST so it's always on top ──
    const MAX_MY_R=32; // fixed max size for center node
    const myR=Math.min(16*z,MAX_MY_R);
    // Outer scan ring
    const scanAngle=(t*0.5)%(Math.PI*2);
    ctx.save();ctx.beginPath();ctx.arc(mcx,mcy,myR*2.5,scanAngle,scanAngle+Math.PI*.6);
    ctx.strokeStyle='rgba(255,107,53,.15)';ctx.lineWidth=1;ctx.stroke();ctx.restore();
    // Glow
    const myGlow=ctx.createRadialGradient(mcx,mcy,0,mcx,mcy,myR*3);
    myGlow.addColorStop(0,'rgba(255,107,53,.2)');myGlow.addColorStop(.5,'rgba(255,107,53,.05)');myGlow.addColorStop(1,'transparent');
    ctx.beginPath();ctx.arc(mcx,mcy,myR*3,0,Math.PI*2);ctx.fillStyle=myGlow;ctx.fill();
    // Photo or initials
    if(constState._myImg&&constState._myImgLoaded){
      drawCroppedImage(constState._myImg,mcx,mcy,myR);
    }else{
      ctx.beginPath();ctx.arc(mcx,mcy,myR,0,Math.PI*2);ctx.fillStyle=state.userColor||'#ff6b35';ctx.fill();
      ctx.fillStyle='#fff';ctx.font='bold '+Math.min(9*z,14)+'px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText((state.userName||'EU').slice(0,2).toUpperCase(),mcx,mcy);
    }
    // Orange ring
    ctx.beginPath();ctx.arc(mcx,mcy,myR,0,Math.PI*2);ctx.strokeStyle='rgba(255,107,53,.6)';ctx.lineWidth=Math.min(2*z,3);ctx.stroke();
    // Label
    ctx.fillStyle='rgba(255,255,255,.4)';ctx.font=Math.min(8*z,12)+'px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='top';
    ctx.fillText('VOCÊ',mcx,mcy+myR+4);

    // ── Floating legend pill ──
    const verified=constState.nodes.filter(n=>(n.partnerRevealedToMe&&n.iRevealedToPartner)||((n.realName&&n.realName!==n.nickname)&&(n.iRevealedToPartner||(state.revealedIds&&state.revealedIds[n.id]&&state.revealedIds[n.id]._iRevealed)))).length;
    const anon=constState.nodes.length-verified;
    const pillW=Math.min(W-24,260),pillH=32,pillX=(W-pillW)/2,pillY=H-48;
    ctx.save();
    ctx.beginPath();
    const pillR=pillH/2;
    ctx.moveTo(pillX+pillR,pillY);ctx.lineTo(pillX+pillW-pillR,pillY);
    ctx.arc(pillX+pillW-pillR,pillY+pillR,pillR,-Math.PI/2,Math.PI/2);
    ctx.lineTo(pillX+pillR,pillY+pillH);ctx.arc(pillX+pillR,pillY+pillR,pillR,Math.PI/2,-Math.PI/2);
    ctx.closePath();
    ctx.fillStyle='rgba(10,10,25,.65)';ctx.fill();
    ctx.strokeStyle='rgba(100,160,255,.12)';ctx.lineWidth=0.5;ctx.stroke();
    const midY=pillY+pillH/2;
    let tx=pillX+14;
    ctx.beginPath();ctx.arc(tx,midY,3.5,0,Math.PI*2);ctx.fillStyle='#00dc82';ctx.fill();
    tx+=10;
    ctx.fillStyle='rgba(255,255,255,.55)';ctx.font='500 10px Inter,sans-serif';ctx.textAlign='left';ctx.textBaseline='middle';
    ctx.fillText('Verificados: '+verified,tx,midY);
    tx+=ctx.measureText('Verificados: '+verified).width+16;
    ctx.beginPath();ctx.arc(tx,midY,3.5,0,Math.PI*2);ctx.fillStyle='#ff4466';ctx.fill();
    tx+=10;
    ctx.fillStyle='rgba(255,255,255,.55)';
    ctx.fillText('Anônimos: '+anon,tx,midY);
    ctx.textAlign='right';ctx.fillStyle='rgba(255,255,255,.25)';ctx.font='400 9px Inter,sans-serif';
    ctx.fillText(constState.nodes.length+' conexões',pillX+pillW-14,midY);
    ctx.restore();
    ctx.textBaseline='alphabetic';
  }
  draw();
}

function handleConstTap(tx,ty,W,H){
  // Use pre-computed projected 2D coordinates from draw loop
  let hit=null,minD=Infinity;
  constState.nodes.forEach(n=>{
    if(n._px===undefined)return;
    const d=Math.hypot(tx-n._px,ty-n._py);
    const hitR=n.baseRadius*(n._pscale||1)*1.8+12;// generous tap target
    if(d<hitR&&d<minD){minD=d;hit=n}
  });
  if(hit){showConstDetail(hit)}else{hideConstDetail()}
}
function showConstDetail(node){
  constState.selectedNode=node;
  const av=$('constDetailAvatar');
  // Show profile photo or selfie or initials
  if(node.profilePhoto){
    av.innerHTML='<img src="'+node.profilePhoto+'" alt="">';av.style.background=node.color;
  }else{
    av.innerHTML='';av.textContent=(node.nickname||'??').slice(0,2).toUpperCase();av.style.background=node.color;
  }
  $('constDetailNick').textContent=node.realName||node.nickname;
  // Show real name subtitle if revealed
  const rn=$('constDetailRealName');
  if(node.realName&&node.realName!==node.nickname){rn.textContent='@'+node.nickname;rn.classList.remove('hidden')}
  else rn.classList.add('hidden');
  // Sub: service or encounters count
  const sub=$('constDetailSub');
  if(node.isPrestador&&node.serviceLabel)sub.textContent=node.serviceLabel;
  else sub.textContent=(node.encounters||0)+' encontro'+(node.encounters>1?'s':'');
  // Meta: last encounter date + first date
  const meta=$('constDetailMeta');
  const lastD=node.lastDate?new Date(node.lastDate):null;
  const timeDiff=lastD?timeAgo(lastD):'';
  meta.innerHTML=timeDiff?('Último: '+timeDiff+(node.firstDate&&node.encounters>1?' · Primeiro: '+new Date(node.firstDate).toLocaleDateString('pt-BR'):'')):'' ;
  // Selfie
  const selfieEl=$('constDetailSelfie');
  if(node.lastSelfie){selfieEl.src=node.lastSelfie;selfieEl.classList.remove('hidden')}
  else selfieEl.classList.add('hidden');
  // Instagram link
  const instaEl=$('constDetailInsta');
  if(node.instagram){
    const handle=node.instagram.replace(/^@/,'').trim();
    instaEl.href='https://instagram.com/'+handle;
    instaEl.textContent='📸 @'+handle;
    instaEl.classList.remove('hidden');
  }else{instaEl.classList.add('hidden')}
  // Text: tip info
  const txt=$('constDetailText');
  if(node.tipsTotal>0)txt.textContent='Gorjeta total: R$'+node.tipsTotal.toFixed(2).replace('.',',');
  else txt.textContent='';
  // Tip button
  const tipBtn=$('constTipBtn');
  if(node.isPrestador){tipBtn.classList.remove('hidden');tipBtn.dataset.receiverId=node.id}
  else tipBtn.classList.add('hidden');
  // ID action button — show if active relation AND IDs not yet exchanged BOTH ways
  const idActions=$('constIdActions');
  window._constDetailNodeId=node.id;
  const partnerRevealed=!!(node.partnerRevealedToMe||(node.realName&&node.realName!==node.nickname));
  const iRevealed=!!(node.iRevealedToPartner||(state.revealedIds&&state.revealedIds[node.id]&&state.revealedIds[node.id]._iRevealed));
  const bothRevealed=partnerRevealed&&iRevealed;
  if(node.hasActiveRelation&&!bothRevealed){
    idActions.classList.remove('hidden');
    const cBtn=$('constRevealIdBtn');if(cBtn){cBtn.textContent='🪪 Trocar IDs';cBtn.disabled=false;cBtn.style.opacity='1'}
  }else{
    idActions.classList.add('hidden');
    if(bothRevealed){$('constDetailText').textContent='🪪 IDs trocados'}
  }
  $('constDetail').classList.add('visible');
  haptic([15]);
}
function timeAgo(date){
  const s=Math.floor((Date.now()-date.getTime())/1000);
  if(s<60)return'agora';if(s<3600)return Math.floor(s/60)+'min atrás';
  if(s<86400)return Math.floor(s/3600)+'h atrás';
  const d=Math.floor(s/86400);if(d<7)return d+'d atrás';
  if(d<30)return Math.floor(d/7)+'sem atrás';
  return date.toLocaleDateString('pt-BR');
}
function hideConstDetail(){$('constDetail').classList.remove('visible');constState.selectedNode=null}
function constTipAction(){
  const btn=$('constTipBtn');
  if(btn&&btn.dataset.receiverId){hideConstDetail();showTipScreen(btn.dataset.receiverId)}
}

// ═══ MORE MENU ═══
function showMoreMenu(){
  const existing=document.querySelector('.more-menu-overlay');if(existing){existing.remove();return}
  const overlay=document.createElement('div');
  overlay.className='more-menu-overlay';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
  overlay.innerHTML='<div class="more-menu-sheet"><div class="more-menu-handle"></div><div class="more-menu-grid">'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showRelations()"><div class="mm-ico">💬</div><div class="mm-lbl">Conexões</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showBoardingPass()"><div class="mm-ico">🪪</div><div class="mm-lbl">ID</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showPrestadorRegister()"><div class="mm-ico">💼</div><div class="mm-lbl">Prestador</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showManual()"><div class="mm-ico">❓</div><div class="mm-lbl">Tutorial</div></div>'
    +'</div></div>';
  document.body.appendChild(overlay);
}

// ═══ ENCOUNTER LOG ═══
async function showEncounterLog(){
  haptic([30]);
  showScreen('encounterLog');
  const list=$('elogList');
  list.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3)">Carregando...</div>';
  try{
    const data=await(await fetch('/api/constellation/'+state.userId)).json();
    if(!data.nodes||!data.nodes.length){
      list.innerHTML='<div class="elog-empty">Nenhum encontro ainda.<br>Toque em alguém para começar!</div>';
      return;
    }
    let html='';
    data.nodes.forEach(n=>{
      const lastD=n.lastDate?new Date(n.lastDate):null;
      const displayName=n.realName||n.nickname;
      html+='<div class="elog-item" onclick="showHistory()">';
      if(n.profilePhoto||n.lastSelfie){
        html+='<div class="elog-avatar" style="overflow:hidden"><img src="'+(n.profilePhoto||n.lastSelfie)+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>';
      }else{
        html+='<div class="elog-avatar" style="background:'+(n.color||'var(--ac)')+'">'+(displayName||'??').slice(0,2).toUpperCase()+'</div>';
      }
      html+='<div class="elog-info">';
      html+='<div class="elog-name">'+esc(displayName)+(n.realName&&n.realName!==n.nickname?' <span style="font-size:.55rem;color:var(--ok)">✓ ID</span>':'')+'</div>';
      if(n.realName&&n.realName!==n.nickname)html+='<div style="font-size:.62rem;color:var(--t3)">@'+esc(n.nickname)+' <span style="color:var(--ac2)">— nickname</span></div>';
      else html+='<div style="font-size:.6rem;color:var(--t3);font-style:italic">nickname — ID real não revelado</div>';
      html+='<div class="elog-meta">';
      html+='<span>📲 '+(n.encounters||0)+'x</span>';
      if(lastD)html+='<span>🕐 '+timeAgo(lastD)+'</span>';
      if(n.tipsTotal>0)html+='<span class="elog-tip">💰 R$'+n.tipsTotal.toFixed(2).replace('.',',')+'</span>';
      if(n.isPrestador&&n.serviceLabel)html+='<span>💼 '+esc(n.serviceLabel)+'</span>';
      html+='</div></div></div>';
    });
    list.innerHTML=html;
  }catch(e){list.innerHTML='<div class="elog-empty">Erro ao carregar histórico.</div>'}
}

// ═══ COMPLETE PROFILE ═══
let cpPhotoData=null;
async function openCompleteProfile(){
  haptic([30]);
  showScreen('completeProfile');
  // Load existing data
  try{
    const d=await(await fetch('/api/myprofile/'+state.userId)).json();
    if(d.realName)$('cpRealName').value=d.realName;
    if(d.bio)$('cpBio').value=d.bio;
    if(d.phone)$('cpPhone').value=d.phone;
    if(d.instagram)$('cpInstagram').value=d.instagram;
    if(d.twitter)$('cpTwitter').value=d.twitter;
    if(d.profilePhoto){
      cpPhotoData=d.profilePhoto;
      $('cpPhotoPreview').innerHTML='<img src="'+d.profilePhoto+'" alt="">';
    }
  }catch(e){}
}
function handleProfilePhoto(input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  if(file.size>5*1024*1024)return showToast('Foto muito grande (máx 5MB)');
  const reader=new FileReader();
  reader.onload=function(e){
    // Compress
    const img=new Image();
    img.onload=function(){
      const canvas=document.createElement('canvas');
      const max=400;
      let w=img.width,h=img.height;
      if(w>max||h>max){if(w>h){h=h*(max/w);w=max}else{w=w*(max/h);h=max}}
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      cpPhotoData=canvas.toDataURL('image/jpeg',0.7);
      $('cpPhotoPreview').innerHTML='<img src="'+cpPhotoData+'" alt="">';
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}
async function saveCompleteProfile(){
  const data={
    userId:state.userId,
    realName:$('cpRealName').value.trim(),
    bio:$('cpBio').value.trim(),
    phone:$('cpPhone').value.trim(),
    instagram:$('cpInstagram').value.trim(),
    twitter:$('cpTwitter').value.trim(),
    profilePhoto:cpPhotoData||''
  };
  try{
    const r=await fetch('/api/profile/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    // Update local state with new photo
    if(data.profilePhoto){state.userPhoto=data.profilePhoto;localStorage.setItem('touch_userPhoto',data.profilePhoto);constState._myImgLoaded=false}
    showToast('Perfil salvo!');haptic([40,20,40]);
    goHome();
  }catch(e){showToast('Erro ao salvar.')}
}

// ═══ REVEAL / REQUEST IDENTITY — UNIFIED FLOW ═══
// "Revelar meu ID" sends a request; partner must accept for bilateral exchange
async function revealIdentity(targetUserId){
  if(!state.userId)return;
  // Check if already fully revealed
  if(state.revealedIds&&state.revealedIds[targetUserId]&&state.revealedIds[targetUserId]._iRevealed&&state.revealedIds[targetUserId].realName)return showToast('IDs já foram trocados.');
  try{
    const r=await fetch('/api/identity/reveal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,targetUserId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Pedido de troca de ID enviado! 🪪');haptic([40,20,60]);
    if(state.currentRelation)appendSystemMsg('Você pediu para trocar identidades reais.');
    // Disable all reveal buttons immediately
    const revBtn=$('revealIdBtn');if(revBtn){revBtn.textContent='Enviado...';revBtn.disabled=true;revBtn.style.opacity='.5'}
    const cRevBtn=$('constRevealIdBtn');if(cRevBtn){cRevBtn.textContent='Enviado...';cRevBtn.disabled=true;cRevBtn.style.opacity='.5'}
  }catch(e){showToast('Complete seu perfil antes de revelar.')}
}
async function requestIdentity(){
  // Now this also triggers a reveal request (same flow)
  if(!state.userId)return;
  const pid=state.currentPartnerId;
  if(!pid)return showToast('Sem parceiro.');
  revealIdentity(pid);
}
function requestRevealFromConstellation(nodeId){revealIdentity(nodeId)}
function revealFromConstellation(nodeId){revealIdentity(nodeId)}

// Show popup when someone requests to reveal IDs
function showRevealRequestPopup(fromUserId,fromName,fromPhoto,relationId){
  // Remove existing popup if any
  document.querySelectorAll('.reveal-req-popup').forEach(e=>e.remove());
  const popup=document.createElement('div');
  popup.className='reveal-req-popup';
  const avatarHtml=fromPhoto&&fromPhoto.length>10
    ?'<div style="width:50px;height:50px;border-radius:50%;overflow:hidden;border:2px solid var(--ac);flex-shrink:0"><img src="'+fromPhoto+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>'
    :'<div style="width:50px;height:50px;border-radius:50%;background:var(--ac);display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:800;color:#fff;flex-shrink:0">'+esc((fromName||'??').slice(0,2).toUpperCase())+'</div>';
  popup.innerHTML='<div class="reveal-req-content">'
    +avatarHtml
    +'<div style="flex:1">'
    +'<div style="font-size:.95rem;font-weight:700;color:var(--t1)">'+esc(fromName)+' quer trocar IDs</div>'
    +'<div style="font-size:.7rem;color:var(--t3);margin-top:.15rem">Se aceitar, vocês vão ver o nome real e foto um do outro</div>'
    +'</div></div>'
    +'<div class="reveal-req-actions">'
    +'<button class="bp" style="flex:1" onclick="acceptRevealRequest(\''+fromUserId+'\',this)">Aceitar 🪪</button>'
    +'<button class="bs" style="flex:1" onclick="declineRevealRequest(\''+fromUserId+'\',this)">Agora não</button>'
    +'</div>';
  document.body.appendChild(popup);
  // Auto-remove after 30s
  setTimeout(()=>{if(popup.parentNode)popup.remove()},30000);
}
async function acceptRevealRequest(fromUserId,btn){
  const popup=btn.closest('.reveal-req-popup');
  try{
    const r=await fetch('/api/identity/reveal-accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,fromUserId})});
    const d=await r.json();
    if(d.error){showToast(d.error);return}
    haptic([80,40,80,40,80]);
  }catch(e){showToast('Erro ao aceitar.')}
  if(popup)popup.remove();
}
async function declineRevealRequest(fromUserId,btn){
  const popup=btn.closest('.reveal-req-popup');
  try{await fetch('/api/identity/reveal-decline',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,fromUserId})})}catch(e){}
  if(popup)popup.remove();
  showToast('Pedido recusado.');
}

// Global UI sync — when IDs are revealed, update ALL screens
function syncRevealUI(partnerId,realName,profilePhoto){
  // 1. Hide ALL ID buttons related to this partner
  const idBar=$('chatIdBar');if(idBar)idBar.style.display='none';
  const constActions=$('constIdActions');if(constActions)constActions.classList.add('hidden');
  // 2. Update chat header if open with this person
  if(state.currentPartnerId===partnerId){
    const chatName=$('chatPartner');
    if(chatName&&realName)chatName.textContent=realName;
    const pNick=state.currentRelation?.partnerName||'';
    const sub=$('chatSub');if(sub)sub.innerHTML='<span style="color:var(--ok)">✓ IDs trocados</span>'+(pNick?' · @'+esc(pNick):'');
  }
  // 3. Update constellation node flags in real-time
  if(constState.nodes){
    const cNode=constState.nodes.find(n=>n.id===partnerId);
    if(cNode){cNode.iRevealedToPartner=true;cNode.partnerRevealedToMe=true;if(realName)cNode.realName=realName;if(profilePhoto)cNode.profilePhoto=profilePhoto}
  }
}
function appendSystemMsg(text){
  const box=$('chatMessages');if(!box)return;
  const div=document.createElement('div');
  div.style.cssText='text-align:center;font-size:.7rem;color:var(--ac);padding:.5rem;font-style:italic';
  div.textContent=text;box.appendChild(div);box.scrollTop=box.scrollHeight;
}

// ═══ BOARDING PASS ═══
async function showBoardingPassWithQR(){
  await showBoardingPass();
  // Auto-show QR code
  setTimeout(()=>{const area=$('touchQRArea');if(area&&area.style.display==='none')showTouchQR()},400);
}
async function showBoardingPass(){
  haptic([30]);
  try{
    const d=await fetch('/api/boarding-pass/'+state.userId).then(r=>r.json());
    $('bpName').textContent=d.name;
    const bpColor=d.color||nickColor(d.name||'??');
    const bpInitials=(d.name||'??').slice(0,2).toUpperCase();
    $('bpAvatar').innerHTML='';
    if(state.userPhoto&&state.userPhoto.length>10){$('bpAvatar').style.background='none';$('bpAvatar').innerHTML='<img src="'+state.userPhoto+'" style="width:100%;height:100%;border-radius:50%;object-fit:cover" alt="">'}
    else{$('bpAvatar').textContent=bpInitials;$('bpAvatar').style.background=bpColor;$('bpAvatar').style.fontSize='1.4rem';$('bpAvatar').style.fontWeight='800';$('bpAvatar').style.color='#fff'}
    const since=new Date(d.memberSince);
    const months=['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];
    $('bpSince').textContent='membro desde '+months[since.getMonth()]+' '+since.getFullYear();
    $('bpScore').textContent=d.score;
    $('bpStars').textContent=d.stars;
    $('bpPeople').textContent=d.uniquePeople;
    $('bpTotal').textContent=d.totalEncounters;
    // Generate barcode visual
    const bc=$('bpBarcode');bc.innerHTML='';
    for(let i=0;i<40;i++){const bar=document.createElement('div');bar.className='bp-bar';bar.style.height=(8+Math.random()*16)+'px';bar.style.opacity=(.3+Math.random()*.5).toFixed(2);bc.appendChild(bar)}
    loadTouchLink();
    showScreen('boardingPass');
  }catch(e){showToast('Erro ao carregar bilhete.')}
}
function downloadBoardingPass(){
  const card=$('bpCard');
  const c=document.createElement('canvas');c.width=640;c.height=900;
  const ctx=c.getContext('2d');
  // Background
  const grad=ctx.createLinearGradient(0,0,0,900);
  grad.addColorStop(0,'#0c0c18');grad.addColorStop(.5,'#161628');grad.addColorStop(1,'#0c0c18');
  ctx.fillStyle=grad;roundRect(ctx,0,0,640,900,30);ctx.fill();
  // Top accent line
  const acGrad=ctx.createLinearGradient(0,0,640,0);acGrad.addColorStop(0,'#ff6b35');acGrad.addColorStop(.5,'#ff3d71');acGrad.addColorStop(1,'#ff6b35');
  ctx.fillStyle=acGrad;ctx.fillRect(0,0,640,5);
  // Header
  ctx.fillStyle='#ff6b35';ctx.font='bold 16px Inter,sans-serif';ctx.letterSpacing='6px';ctx.fillText('Touch?',30,50);
  ctx.fillStyle='#555568';ctx.font='12px Inter,sans-serif';ctx.letterSpacing='3px';ctx.textAlign='right';ctx.fillText('BOARDING PASS',610,50);ctx.textAlign='left';ctx.letterSpacing='0px';
  // Dashed line
  ctx.setLineDash([6,4]);ctx.strokeStyle='#2a2a3a';ctx.beginPath();ctx.moveTo(20,70);ctx.lineTo(620,70);ctx.stroke();ctx.setLineDash([]);
  // Avatar circle
  const avX=320,avY=160,avR=50;
  ctx.beginPath();ctx.arc(avX,avY,avR+3,0,Math.PI*2);ctx.strokeStyle='#ff6b35';ctx.lineWidth=2;ctx.stroke();
  const bpAv=$('bpAvatar');const avColor=bpAv.style.background||'hsl(200,65%,55%)';
  ctx.beginPath();ctx.arc(avX,avY,avR,0,Math.PI*2);ctx.fillStyle=avColor;ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 32px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(bpAv.textContent||'??',avX,avY);ctx.textBaseline='alphabetic';
  // Name
  ctx.fillStyle='#f5f5f7';ctx.font='bold 28px Inter,sans-serif';ctx.textAlign='center';
  ctx.fillText($('bpName').textContent,320,260);
  // Since
  ctx.fillStyle='#555568';ctx.font='13px Inter,sans-serif';
  ctx.fillText($('bpSince').textContent,320,290);
  // Stats boxes
  const stats=[{n:$('bpScore').textContent,l:'SCORE'},{n:$('bpStars').textContent,l:'ESTRELAS'},{n:$('bpPeople').textContent,l:'PESSOAS'},{n:$('bpTotal').textContent,l:'ENCONTROS'}];
  const sw=120,sy=340;
  stats.forEach((s,i)=>{
    const sx=30+i*(sw+25);
    ctx.fillStyle='rgba(255,107,53,0.08)';roundRect(ctx,sx,sy,sw,90,12);ctx.fill();
    ctx.fillStyle='#ff6b35';ctx.font='bold 36px Inter,sans-serif';ctx.textAlign='center';ctx.fillText(s.n,sx+sw/2,sy+45);
    ctx.fillStyle='#555568';ctx.font='10px Inter,sans-serif';ctx.letterSpacing='2px';ctx.fillText(s.l,sx+sw/2,sy+72);ctx.letterSpacing='0px';
  });
  // Dashed line
  ctx.setLineDash([6,4]);ctx.strokeStyle='#2a2a3a';ctx.beginPath();ctx.moveTo(20,480);ctx.lineTo(620,480);ctx.stroke();ctx.setLineDash([]);
  // Barcode
  for(let i=0;i<60;i++){const bh=15+Math.random()*25,bx=80+i*8;ctx.fillStyle='rgba(85,85,104,'+(0.3+Math.random()*0.4).toFixed(2)+')';ctx.fillRect(bx,520,3,bh)}
  // Footer
  ctx.fillStyle='#555568';ctx.font='11px Inter,sans-serif';ctx.letterSpacing='4px';ctx.textAlign='center';
  ctx.fillText('TUDO NASCE NO GESTO',320,610);ctx.letterSpacing='0px';
  // Corners notch effect
  ctx.fillStyle='#050508';
  [[-1,480],[641-20,480]].forEach(([x,y])=>{ctx.beginPath();ctx.arc(x<0?0:640,y,15,0,Math.PI*2);ctx.fill()});
  // Download
  c.toBlob(blob=>{
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='touch-pass.png';a.click();URL.revokeObjectURL(url);
    showToast('Bilhete salvo!');haptic([50,30,50]);
  },'image/png');
}
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath()}

// ═══ PROFILE ═══
let profileReturnTo='chat';
function showProfile(){
  if(!state.userId)return;
  profileReturnTo='home';
  loadProfile(state.userId);
}
async function showPartnerProfile(){
  if(!state.currentRelation)return;
  const pid=state.currentPartnerId;
  if(!pid)return showToast('Parceiro não encontrado.');
  profileReturnTo='chat';
  await loadProfile(pid);
}
async function loadProfile(userId,canAct){
  haptic([30]);
  try{
    const url=canAct===false?'/api/profile/'+userId:'/api/profile/'+userId+'/from/'+state.userId;
    const d=await fetch(url).then(r=>r.json());
    if(d.error)return showToast(d.error);
    renderProfile(d,userId);
    showScreen('profile');
  }catch(e){showToast('Erro ao carregar perfil.')}
}
function renderProfile(d,userId){
  const displayName=d.realName||d.nickname;
  $('pfTitle').textContent=displayName;
  const s=$('pfScroll');
  let html='<div class="pf-card">';
  if(d.profilePhoto){
    html+='<div style="width:64px;height:64px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,.1)"><img src="'+d.profilePhoto+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>';
  }else{
    html+=makeAvatar(d.nickname,d.color,64);
  }
  html+='<div style="margin-top:.8rem;font-size:1.1rem;font-weight:700">'+esc(displayName)+'</div>';
  if(d.realName&&d.realName!==d.nickname){
    html+='<div style="font-size:.72rem;color:var(--t2);margin-top:.1rem">@'+esc(d.nickname)+' <span style="font-size:.58rem;color:var(--ok)">✓ ID revelado para você</span></div>';
  }else{
    html+='<div style="font-size:.65rem;color:var(--t3);margin-top:.2rem;display:flex;align-items:center;gap:.3rem;justify-content:center"><span style="opacity:.5">🔒</span> vendo como nickname</div>';
  }
  if(d.bio)html+='<div style="font-size:.75rem;color:var(--t2);margin-top:.4rem;font-style:italic">'+esc(d.bio)+'</div>';
  if(d.instagram)html+='<div style="font-size:.7rem;color:var(--ac);margin-top:.2rem">'+esc(d.instagram)+'</div>';
  html+='<div style="font-size:.65rem;color:var(--t3);margin-top:.2rem">membro desde '+new Date(d.memberSince).toLocaleDateString('pt-BR')+'</div>';
  html+='<div class="pf-stats">';
  html+='<div class="pf-stat"><div class="pf-stat-num">'+(d.score||0)+'</div><div class="pf-stat-lbl">score</div></div>';
  html+='<div class="pf-stat"><div class="pf-stat-num" style="color:#fbbf24">'+(d.stars||0)+'</div><div class="pf-stat-lbl">estrelas</div></div>';
  html+='<div class="pf-stat"><div class="pf-stat-num">'+d.uniquePeople+'</div><div class="pf-stat-lbl">pessoas</div></div>';
  html+='<div class="pf-stat"><div class="pf-stat-num">'+d.totalEncounters+'</div><div class="pf-stat-lbl">encontros</div></div>';
  html+='</div>';
  // Star details
  if(d.starDetails&&d.starDetails.length>0){
    html+='<div style="display:flex;flex-wrap:wrap;gap:.3rem;justify-content:center;margin:.5rem 0">';
    d.starDetails.forEach(s=>{
      const tip=s.reason==='gift'?'Presente de '+(s.fromName||'?'):s.reason==='organic'?'Orgânica ('+s.milestone+'x com '+(s.withName||'?')+')':'Marco';
      html+='<div title="'+tip+'" style="font-size:1rem;cursor:help;transition:.15s" onmouseenter="this.style.transform=\'scale(1.3)\'" onmouseleave="this.style.transform=\'none\'">⭐</div>';
    });
    html+='</div>';
  }
  html+='</div>';
  // Actions if active connection
  if(d.canInteract){
    html+='<div class="pf-actions">';
    html+='<button class="pf-act-btn" onclick="openGiftPicker()">&#x1F381; Presentear</button>';
    html+='<button class="pf-act-btn" onclick="openDeclModal()">&#x1F4DD; Declarar</button>';
    html+='</div>';
  }
  // Declarations
  html+='<div class="pf-section"><div class="pf-section-title">Declarações recebidas</div>';
  if(d.declarations&&d.declarations.length>0){
    d.declarations.slice().reverse().forEach(dc=>{
      html+='<div class="pf-decl"><div class="pf-decl-text">"'+esc(dc.text)+'"</div><div class="pf-decl-from">— '+esc(dc.fromName)+'</div></div>';
    });
  }else html+='<div class="pf-empty">Nenhuma declaração ainda.</div>';
  html+='</div>';
  // Gifts
  html+='<div class="pf-section"><div class="pf-section-title">Presentes recebidos</div>';
  if(d.gifts&&d.gifts.length>0){
    d.gifts.slice().reverse().forEach(g=>{
      html+='<div class="pf-gift"><div class="pf-gift-emoji">'+g.emoji+'</div><div class="pf-gift-info"><div class="pf-gift-name">'+esc(g.giftName)+'</div><div class="pf-gift-from">de '+esc(g.fromName)+'</div>'+(g.message?'<div class="pf-gift-msg">"'+esc(g.message)+'"</div>':'')+'</div></div>';
    });
  }else html+='<div class="pf-empty">Nenhum presente ainda.</div>';
  html+='</div>';
  // Logout button (only on own profile)
  if(userId===state.userId){
    html+='<div style="margin-top:2rem;text-align:center;padding-bottom:2rem">';
    if(fbUser)html+='<div style="font-size:.72rem;color:var(--t3);margin-bottom:.6rem">'+esc(fbUser.email||fbUser.displayName||'')+'</div>';
    html+='<button class="bs" onclick="doLogout()" style="color:var(--err);border-color:var(--err)">Sair da conta</button>';
    html+='</div>';
  }
  s.innerHTML=html;
}
function closeProfile(){
  if(profileReturnTo==='chat'&&state.currentRelation)showScreen('chat');
  else goHome();
}

// ═══ MY PROFILE SHEET (home avatar click) ═══
function showMyProfileSheet(){
  if(!state.userId)return;
  haptic([30]);
  const existing=document.querySelector('.my-profile-overlay');if(existing){existing.remove();return}
  const overlay=document.createElement('div');
  overlay.className='more-menu-overlay my-profile-overlay';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
  const color=state.userColor||nickColor(state.userName||'??');
  const initials=(state.userName||'??').slice(0,2).toUpperCase();
  const email=fbUser?(fbUser.email||fbUser.displayName||''):'';
  // Avatar: use real photo if available
  const hasPhoto=state.userPhoto&&state.userPhoto.length>10;
  const avatarHtml=hasPhoto
    ?'<div style="width:56px;height:56px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,.12);flex-shrink:0"><img src="'+state.userPhoto+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>'
    :'<div style="width:56px;height:56px;border-radius:50%;background:'+color+';display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:800;color:#fff;border:2px solid rgba(255,255,255,.12);flex-shrink:0">'+esc(initials)+'</div>';
  // Cadastro tag: check if profile is mostly complete
  const profileMostlyComplete=hasPhoto&&state.userRealName;
  const cadastroLabel=profileMostlyComplete?'Cadastro':'Cadastro';
  const cadastroTag=profileMostlyComplete?'':'<span class="my-pf-tag">completar</span>';
  // Real name line
  const realNameLine=state.userRealName?'<div style="font-size:.72rem;color:var(--t2);margin-top:.1rem">'+esc(state.userRealName)+'</div>':'';
  overlay.innerHTML='<div class="more-menu-sheet" style="padding:1.8rem 1.5rem">'
    +'<div class="more-menu-handle"></div>'
    +'<div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.2rem">'
    +avatarHtml
    +'<div style="flex:1"><div style="font-size:1.1rem;font-weight:700;color:var(--t1)">'+esc(state.userName||'??')+'</div>'
    +realNameLine
    +(email?'<div style="font-size:.68rem;color:var(--t3);margin-top:.15rem">'+esc(email)+'</div>':'')
    +'<div style="font-size:.62rem;color:var(--ac2);margin-top:.2rem;font-style:italic">nickname — visível para todos</div></div></div>'
    +'<div style="display:flex;flex-direction:column;gap:.5rem">'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showBoardingPassWithQR()"><span class="my-pf-ico">🪪</span>ID</button>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();openCompleteProfile()"><span class="my-pf-ico">✏️</span>'+cadastroLabel+cadastroTag+'</button>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showEncounterLog()"><span class="my-pf-ico">📋</span>Histórico</button>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showManual()"><span class="my-pf-ico">❓</span>Tutorial</button>'
    +'<div style="height:1px;background:var(--b1);margin:.3rem 0"></div>'
    +'<button class="my-pf-btn my-pf-danger" onclick="this.closest(\'.my-profile-overlay\').remove();doLogout()"><span class="my-pf-ico">🚪</span>Sair da conta</button>'
    +'</div></div>';
  document.body.appendChild(overlay);
}

// ═══ GIFT PICKER ═══
let giftCatalog=[];
async function openGiftPicker(){
  if(!state.currentRelation)return;
  if(!giftCatalog.length){try{giftCatalog=await fetch('/api/gift-catalog').then(r=>r.json())}catch(e){return showToast('Erro ao carregar presentes.')}}
  let html='<div class="modal-overlay" onclick="closeGiftModal(event)">';
  html+='<div class="modal-sheet" onclick="event.stopPropagation()">';
  html+='<div class="modal-handle"></div>';
  html+='<div class="modal-title">&#x1F381; Escolha um presente</div>';
  html+='<div class="gift-grid">';
  giftCatalog.forEach(g=>{
    html+='<div class="gift-option" onclick="selectGift(\''+g.id+'\')">';
    html+='<div class="g-emoji">'+g.emoji+'</div>';
    html+='<div class="g-name">'+esc(g.name)+'</div>';
    html+='<div class="g-desc">'+esc(g.description)+'</div>';
    html+='</div>';
  });
  html+='</div></div></div>';
  $('giftModal').innerHTML=html;$('giftModal').classList.remove('hidden');
}
function closeGiftModal(e){if(e&&e.target.classList.contains('modal-overlay'))$('giftModal').classList.add('hidden');$('giftModal').innerHTML=''}
function selectGift(giftId){
  const gift=giftCatalog.find(g=>g.id===giftId);if(!gift)return;
  let html='<div class="modal-overlay" onclick="closeGiftModal(event)">';
  html+='<div class="modal-sheet" onclick="event.stopPropagation()">';
  html+='<div class="modal-handle"></div>';
  html+='<div class="modal-title">'+gift.emoji+' '+esc(gift.name)+'</div>';
  html+='<div style="text-align:center;font-size:.8rem;color:var(--t2);margin-bottom:.8rem">'+esc(gift.description)+'</div>';
  if(gift.needsAddress)html+='<div style="text-align:center;font-size:.7rem;color:var(--warn);margin-bottom:.6rem">&#x1F4E6; Requer endereço (pediremos permissão)</div>';
  html+='<input class="gift-msg-input" id="giftMsg" placeholder="Mensagem (opcional)" maxlength="120">';
  html+='<div style="margin-top:.8rem;text-align:center"><button class="bp" style="max-width:200px" onclick="confirmSendGift(\''+giftId+'\')">Enviar presente</button></div>';
  html+='</div></div>';
  $('giftModal').innerHTML=html;
}
async function confirmSendGift(giftId){
  const msg=$('giftMsg')?$('giftMsg').value.trim():'';
  try{
    const r=await fetch('/api/gift/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId:state.currentRelation.relationId,fromUserId:state.userId,giftId,message:msg})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Presente enviado!');haptic([50,30,50,30,50]);
    $('giftModal').classList.add('hidden');$('giftModal').innerHTML='';
  }catch(e){showToast('Erro ao enviar.')}
}

// ═══ DECLARATION MODAL ═══
function openDeclModal(){
  if(!state.currentRelation)return;
  let html='<div class="modal-overlay" onclick="closeDeclModal(event)">';
  html+='<div class="modal-sheet" onclick="event.stopPropagation()">';
  html+='<div class="modal-handle"></div>';
  html+='<div class="modal-title">&#x1F4DD; Declaração</div>';
  html+='<div style="text-align:center;font-size:.78rem;color:var(--t2);margin-bottom:.8rem">Escreva algo para ficar no perfil dessa pessoa. Todos que se conectarem a ela poderão ler.</div>';
  html+='<textarea class="decl-input" id="declText" placeholder="Escreva sua declaração..." maxlength="280" oninput="updateDeclCounter()"></textarea>';
  html+='<div class="decl-counter" id="declCounter">0/280</div>';
  html+='<div style="margin-top:.6rem;text-align:center"><button class="bp" style="max-width:200px" onclick="confirmSendDecl()">Publicar</button></div>';
  html+='</div></div>';
  $('declModal').innerHTML=html;$('declModal').classList.remove('hidden');
}
function closeDeclModal(e){if(e&&e.target.classList.contains('modal-overlay'))$('declModal').classList.add('hidden');$('declModal').innerHTML=''}
function updateDeclCounter(){const t=$('declText');if(t)$('declCounter').textContent=t.value.length+'/280'}
async function confirmSendDecl(){
  const text=$('declText')?$('declText').value.trim():'';
  if(!text||text.length<3)return showToast('Escreva pelo menos 3 caracteres.');
  try{
    const r=await fetch('/api/declaration/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId:state.currentRelation.relationId,fromUserId:state.userId,text})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Declaração publicada!');haptic([50,30,50]);
    $('declModal').classList.add('hidden');$('declModal').innerHTML='';
  }catch(e){showToast('Erro ao publicar.')}
}

// ═══ ADDRESS REQUEST (in chat) ═══
function showAddressRequest(gift){
  const area=$('contactRequestArea');
  let html='<div class="addr-request" id="addrReq-'+gift.id+'">';
  html+='<div class="addr-request-text">'+esc(gift.fromName)+' quer te presentear com <strong>'+gift.emoji+' '+esc(gift.giftName)+'</strong>!'+(gift.message?' "'+esc(gift.message)+'"':'')+'</div>';
  html+='<div class="addr-request-note">Seu endereço NÃO é passado para essa pessoa. A plataforma cuida da entrega.</div>';
  html+='<input class="addr-input" id="addrInput-'+gift.id+'" placeholder="Seu endereço completo para entrega">';
  html+='<div class="addr-actions">';
  html+='<button class="addr-btn accept" onclick="respondAddress(\''+gift.id+'\',true)">Aceitar &#x1F4E6;</button>';
  html+='<button class="addr-btn decline" onclick="respondAddress(\''+gift.id+'\',false)">Não, obrigado</button>';
  html+='</div></div>';
  area.innerHTML+=html;
}
async function respondAddress(giftId,accepted){
  const addrEl=$('addrInput-'+giftId);
  const address=addrEl?addrEl.value.trim():'';
  if(accepted&&!address)return showToast('Digite seu endereço para receber.');
  try{
    await fetch('/api/gift/address-response',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({giftId,userId:state.userId,accepted,address:accepted?address:null})});
    const el=$('addrReq-'+giftId);if(el)el.remove();
    showToast(accepted?'Endereço enviado! Presente a caminho.':'Presente recusado.');haptic([50]);
  }catch(e){showToast('Erro.')}
}

// ═══ HISTORY CARD SAVE/SHARE ═══
function saveHistoryCard(idx){
  const e=window._historyData&&window._historyData[idx];if(!e)return;
  const c=document.createElement('canvas');c.width=600;c.height=400;const ctx=c.getContext('2d');
  // BG
  const grad=ctx.createLinearGradient(0,0,0,400);grad.addColorStop(0,'#0a0a12');grad.addColorStop(.5,'#15152a');grad.addColorStop(1,'#0a0a12');
  ctx.fillStyle=grad;roundRect(ctx,0,0,600,400,20);ctx.fill();
  // Accent top
  const acG=ctx.createLinearGradient(0,0,600,0);acG.addColorStop(0,'#ff6b35');acG.addColorStop(1,'#ff3d71');
  ctx.fillStyle=acG;ctx.fillRect(0,0,600,3);
  // Logo
  ctx.fillStyle='#ff6b35';ctx.font='bold 11px Inter,sans-serif';ctx.letterSpacing='4px';ctx.fillText('Touch?',30,35);ctx.letterSpacing='0px';
  // Avatar circle
  const color=e.withColor||nickColor(e.withName||'??');
  ctx.beginPath();ctx.arc(300,120,35,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 22px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText((e.withName||'??').slice(0,2).toUpperCase(),300,120);ctx.textBaseline='alphabetic';
  // Name
  ctx.fillStyle='#f5f5f7';ctx.font='600 18px Inter,sans-serif';ctx.fillText(e.withName||'Alguém',300,185);
  // Date
  const d=new Date(e.timestamp);
  ctx.fillStyle='#555568';ctx.font='12px Inter,sans-serif';ctx.fillText(pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear()+' '+pad(d.getHours())+':'+pad(d.getMinutes()),300,210);
  // Phrase
  if(e.phrase){ctx.fillStyle='#8888a0';ctx.font='italic 16px Inter,sans-serif';
    const words=e.phrase.split(' ');let line='',y=260;
    words.forEach(w=>{const test=line+w+' ';if(ctx.measureText(test).width>460&&line){ctx.fillText('"'+line.trim()+'"',300,y);y+=24;line=w+' '}else line=test});
    if(line)ctx.fillText(line===e.phrase+' '?'"'+line.trim()+'"':line.trim(),300,y);
  }
  // Footer
  ctx.fillStyle='#555568';ctx.font='9px Inter,sans-serif';ctx.letterSpacing='3px';ctx.fillText('TUDO NASCE NO GESTO',300,375);ctx.letterSpacing='0px';ctx.textAlign='left';
  // Download
  c.toBlob(blob=>{const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='touch-encontro-'+(idx+1)+'.png';a.click();URL.revokeObjectURL(url);showToast('Card salvo!');haptic([50,30,50])},'image/png');
}
function shareHistoryCard(idx){
  const e=window._historyData&&window._historyData[idx];if(!e)return;
  const text='"'+(e.phrase||'')+'" — encontro com '+e.withName+' via Touch?';
  if(navigator.share){navigator.share({title:'Touch?',text}).catch(()=>{})}
  else{navigator.clipboard.writeText(text).then(()=>showToast('Copiado!')).catch(()=>{})}
}

// ═══ EXPIRE CARD ═══
function showExpireCard(){if(!state.currentRelation)return;$('cardPhrase').textContent=state.currentRelation.phrase;const cr=state.currentRelation.createdAt||(state.currentRelation.expiresAt-86400000);$('cardTime').textContent=Math.round((state.currentRelation.expiresAt-cr)/3600000)+'h juntos';showScreen('expireCard')}
async function shareCard(){const text='"'+state.currentRelation.phrase+'" — Touch?';if(navigator.share){try{await navigator.share({title:'Touch?',text})}catch(e){}}else{try{await navigator.clipboard.writeText(text);showToast('Copiado!')}catch(e){}}}

// ═══ SOUND & HAPTICS ═══
let audioCtx=null;
function playSound(type){
  try{if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')audioCtx.resume();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sine';const t=audioCtx.currentTime;
  if(type==='send'){o.frequency.setValueAtTime(600,t);o.frequency.exponentialRampToValueAtTime(900,t+.08);g.gain.setValueAtTime(.06,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12)}
  else if(type==='receive'){o.frequency.setValueAtTime(500,t);o.frequency.exponentialRampToValueAtTime(700,t+.1);g.gain.setValueAtTime(.05,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.start(t);o.stop(t+.15)}
  else if(type==='connect'){o.frequency.setValueAtTime(523,t);o.frequency.setValueAtTime(659,t+.12);o.frequency.setValueAtTime(784,t+.24);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4)}
  else if(type==='pulse'){o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(200,t+.3);g.gain.setValueAtTime(.08,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4)}
  }catch(e){}
}
function haptic(p){if(navigator.vibrate)navigator.vibrate(p)}

// ═══ HOME MOTIVATION ═══
const HOME_PHRASES=[
  'Nada acontece\nà distância.',
  'Quem toca\ndescobre.',
  'Presença é\na moeda rara.',
  'O encontro\né o começo.',
  'Hoje é feito\nde gestos.',
  'A conexão\nvive no toque.',
  'Não espere.\nTouch.',
  'Cada encontro\ndeixa marca.',
  'O melhor momento\né o presente.',
  'Proximidade\nmuda tudo.'
];
function setHomeMotivation(){
  const el=$('homeMotivation');
  if(!el)return;
  const p=HOME_PHRASES[Math.floor(Math.random()*HOME_PHRASES.length)];
  el.innerHTML=p.replace('\n','<br>');
}

// ═══ UTILS ═══
function showToast(msg){const t=$('toast');t.textContent=msg;t.classList.remove('hidden');t.style.animation='none';t.offsetHeight;t.style.animation='toast-in .35s cubic-bezier(.22,1,.36,1) forwards';clearTimeout(t._t);t._t=setTimeout(()=>{t.style.animation='toast-out .3s ease forwards';setTimeout(()=>t.classList.add('hidden'),300)},2500)}
function esc(text){const d=document.createElement('div');d.textContent=text;return d.innerHTML}
function pad(n){return n.toString().padStart(2,'0')}
function updateSendBtn(){$('sendBtn').classList.toggle('active',$('chatInput').value.trim().length>0)}

// ═══ SELFIE AT CONNECTION (v2 — inline, no separate step) ═══
let selfieStream=null;
function releaseSelfieCamera(){
  if(selfieStream){selfieStream.getTracks().forEach(t=>t.stop());selfieStream=null}
  const v=$('selfieVideo');if(v){v.srcObject=null;v.style.display='none'}
}
function releaseAllMedia(){
  // Stop sonic (mic + speaker)
  if(homeSonicActive)stopHomeSonic();
  if(sonicActive)stopSonicMode();
  // Stop selfie camera
  releaseSelfieCamera();
}
function revealCaptureSelfie(){
  const btn=$('selfieCapBtn');
  // If camera already active, capture
  if(selfieStream){
    const v=$('selfieVideo'),c=$('selfieCanvas');
    c.width=400;c.height=400;const ctx=c.getContext('2d');
    const s=Math.min(v.videoWidth,v.videoHeight);const sx=(v.videoWidth-s)/2,sy=(v.videoHeight-s)/2;
    ctx.drawImage(v,sx,sy,s,s,0,0,400,400);
    const dataUrl=c.toDataURL('image/jpeg',0.7);
    if(selfieStream){selfieStream.getTracks().forEach(t=>t.stop());selfieStream=null}
    v.style.display='none';
    $('selfiePreview').innerHTML='<img src="'+dataUrl+'" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--ok)">';
    $('selfiePreview').style.display='block';
    btn.innerHTML='<span class="rv-ico">&#x2714;</span> Salvo';btn.disabled=true;btn.style.borderColor='var(--ok)';btn.style.color='var(--ok)';
    if(state.currentRelation){
      fetch('/api/selfie/'+state.currentRelation.relationId,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,selfieData:dataUrl})}).catch(()=>{});
    }
    haptic([50,30,50]);
    return;
  }
  // Open camera inline
  if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){
    navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false}).then(stream=>{
      selfieStream=stream;const v=$('selfieVideo');v.srcObject=stream;v.style.display='block';
      btn.innerHTML='<span class="rv-ico">&#x1F4F8;</span> Capturar';
    }).catch(()=>{
      // Fallback: file picker
      const input=document.createElement('input');input.type='file';input.accept='image/*';input.capture='user';
      input.onchange=()=>{
        const file=input.files[0];if(!file)return;
        const reader=new FileReader();reader.onload=()=>{
          const img=new Image();img.onload=()=>{
            const c=document.createElement('canvas'),ctx=c.getContext('2d');
            c.width=400;c.height=400;const sc=Math.max(400/img.width,400/img.height);
            ctx.drawImage(img,(400-img.width*sc)/2,(400-img.height*sc)/2,img.width*sc,img.height*sc);
            const dataUrl=c.toDataURL('image/jpeg',.7);
            $('selfiePreview').innerHTML='<img src="'+dataUrl+'" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--ok)">';
            $('selfiePreview').style.display='block';
            btn.innerHTML='<span class="rv-ico">&#x2714;</span> Salvo';btn.disabled=true;btn.style.borderColor='var(--ok)';btn.style.color='var(--ok)';
            if(state.currentRelation)fetch('/api/selfie/'+state.currentRelation.relationId,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,selfieData:dataUrl})}).catch(()=>{});
            haptic([50,30,50]);
          };img.src=reader.result;
        };reader.readAsDataURL(file);
      };input.click();
    });
  }else{
    // No camera API - use file picker
    const input=document.createElement('input');input.type='file';input.accept='image/*';input.capture='user';
    input.onchange=()=>{
      const file=input.files[0];if(!file)return;
      const reader=new FileReader();reader.onload=()=>{
        $('selfiePreview').innerHTML='<img src="'+reader.result+'" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--ok)">';
        $('selfiePreview').style.display='block';
        btn.innerHTML='<span class="rv-ico">&#x2714;</span> Salvo';btn.disabled=true;
        haptic([50,30,50]);
      };reader.readAsDataURL(file);
    };input.click();
  }
}

// ═══ CONTACT REQUESTS ═══
function openContactMenu(){
  const area=$('contactRequestArea');
  if(area.innerHTML){area.innerHTML='';return}
  const types=[
    {id:'instagram',emoji:'📸',label:'Instagram'},
    {id:'whatsapp',emoji:'💬',label:'WhatsApp'},
    {id:'x',emoji:'𝕏',label:'X / Twitter'},
    {id:'email',emoji:'📧',label:'Email'},
    {id:'foto',emoji:'📷',label:'Foto'}
  ];
  let html='<div class="contact-menu">';
  types.forEach(t=>{
    html+='<button type="button" class="contact-opt" onclick="requestContact(\''+t.id+'\')">'+t.emoji+' '+t.label+'</button>';
  });
  html+='</div>';
  area.innerHTML=html;
}
async function requestContact(type){
  if(!state.currentRelation)return;
  $('contactRequestArea').innerHTML='';
  try{
    await fetch('/api/request-contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId:state.currentRelation.relationId,fromUserId:state.userId,contactType:type})});
    showToast('Pedido enviado!');haptic([50]);
  }catch(e){showToast('Erro.')}
}
function showContactRequest(data){
  const area=$('contactRequestArea');
  const labels={instagram:'Instagram',whatsapp:'WhatsApp',x:'X / Twitter',email:'Email',foto:'Foto'};
  const emojis={instagram:'📸',whatsapp:'💬',x:'𝕏',email:'📧',foto:'📷'};
  let html='<div class="contact-req-banner" id="contactReq-'+data.requestId+'">';
  html+='<div class="contact-req-text">'+esc(data.from.name)+' quer seu <strong>'+emojis[data.contactType]+' '+(labels[data.contactType]||data.contactType)+'</strong></div>';
  if(data.contactType!=='foto'){
    html+='<input class="contact-req-input" id="contactVal-'+data.requestId+'" placeholder="Seu '+(labels[data.contactType]||'')+'">';
  }
  html+='<div class="contact-req-actions">';
  html+='<button type="button" class="addr-btn accept" onclick="respondContact(\''+data.requestId+'\',\''+data.relationId+'\',\''+data.contactType+'\',true)">Compartilhar</button>';
  html+='<button type="button" class="addr-btn decline" onclick="respondContact(\''+data.requestId+'\',\''+data.relationId+'\',\''+data.contactType+'\',false)">Não</button>';
  html+='</div></div>';
  area.innerHTML+=html;
}
async function respondContact(reqId,relationId,contactType,accepted){
  const valEl=$('contactVal-'+reqId);
  const value=valEl?valEl.value.trim():'';
  if(accepted&&contactType!=='foto'&&!value)return showToast('Preencha o campo.');
  try{
    await fetch('/api/respond-contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId,toUserId:state.userId,contactType,accepted,value:accepted?value:null})});
    const el=$('contactReq-'+reqId);if(el)el.remove();
    showToast(accepted?'Compartilhado!':'Recusado.');
  }catch(e){showToast('Erro.')}
}

// ═══ ENCOSTA REQUEST (digital - needs acceptance) ═══
function showEncostaRequest(data){
  const area=$('encostaReqArea');
  const color=data.from.color||nickColor(data.from.name||'??');
  let html='<div class="encosta-req-banner" id="encostaReq-'+data.requestId+'">';
  html+='<div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem">'+makeAvatar(data.from.name,color,38,data.from.photo||null);
  html+='<div><div class="encosta-req-title">'+esc(data.from.name)+' quer conectar</div>';
  html+='<div class="encosta-req-sub">📍 '+esc(data.eventName)+'</div></div></div>';
  html+='<div class="encosta-req-actions">';
  html+='<button type="button" class="bp" style="flex:1;font-size:.82rem" onclick="acceptEncostaReq(\''+data.requestId+'\',\''+data.eventId+'\',\''+data.from.id+'\',true)">Aceitar</button>';
  html+='<button type="button" class="bs" style="flex:1;font-size:.82rem" onclick="acceptEncostaReq(\''+data.requestId+'\',\''+data.eventId+'\',\''+data.from.id+'\',false)">Recusar</button>';
  html+='</div></div>';
  area.innerHTML=html;
  haptic([100,50,100]);playSound('receive');
}
async function acceptEncostaReq(reqId,eventId,fromUserId,accepted){
  const el=$('encostaReq-'+reqId);if(el)el.remove();
  if(!accepted){
    try{await fetch('/api/event/encosta-accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,eventId,fromUserId,accepted:false})})}catch(e){}
    showToast('Recusado.');return;
  }
  try{
    const r=await fetch('/api/event/encosta-accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,eventId,fromUserId,accepted:true})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([80,40,80,40,80]);playSound('connect');
    state.currentRelation=d;
    const partner=(d.userA.id===state.userId)?d.userB:d.userA;
    state.currentPartnerId=partner.id;
    showScreen('encounter');showPhase('phaseReveal');
    doReveal(d);
  }catch(e){showToast('Erro ao conectar.')}
}

// ═══ LOCATION / EVENTS ═══
let locWatchId=null,myLat=null,myLng=null,locTab='nearby';
function openLocationScreen(){
  showScreen('locationScreen');
  $('locStatus').className='loc-status';
  $('locStatus').innerHTML='&#x1F50D; '+i18n('loc_searching');
  $('locContent').innerHTML='';
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      myLat=pos.coords.latitude;myLng=pos.coords.longitude;
      onLocationReady('gps');
      if(locWatchId)navigator.geolocation.clearWatch(locWatchId);
      locWatchId=navigator.geolocation.watchPosition(p=>{myLat=p.coords.latitude;myLng=p.coords.longitude;updateLocationOnServer()},{},{enableHighAccuracy:true,maximumAge:30000});
    },()=>fetchApproxLocation(),{enableHighAccuracy:true,timeout:8000});
  }else fetchApproxLocation();
}
function fetchApproxLocation(){
  // Try multiple IP geolocation services
  fetch('https://ipapi.co/json/',{signal:AbortSignal.timeout(5000)}).then(r=>r.json()).then(d=>{
    if(d.latitude&&d.longitude){myLat=d.latitude;myLng=d.longitude;onLocationReady('approx')}
    else return Promise.reject();
  }).catch(()=>{
    // Fallback: ip-api.com
    fetch('http://ip-api.com/json/?fields=lat,lon',{signal:AbortSignal.timeout(5000)}).then(r=>r.json()).then(d=>{
      if(d.lat&&d.lon){myLat=d.lat;myLng=d.lon;onLocationReady('approx')}
      else onLocationFail();
    }).catch(()=>onLocationFail());
  });
}
function onLocationReady(mode){
  $('locStatus').className='loc-status active';
  $('locStatus').innerHTML=mode==='gps'?'&#x1F4CD; '+i18n('loc_active'):'&#x1F4CD; Localização aproximada (via rede)';
  updateLocationOnServer();
  loadLocTab();
}
function onLocationFail(){
  $('locStatus').className='loc-status error';
  $('locStatus').innerHTML='&#x1F6AB; GPS indisponível';
  let html='<div class="loc-empty"><div class="loc-empty-icon">&#x1F4CD;</div>';
  html+='Sem localização disponível.<br><small style="color:var(--t3)">No notebook o GPS pode não funcionar.<br>No celular com HTTPS funcionará.</small>';
  html+='<br><br><button type="button" class="bp" style="font-size:.8rem;max-width:240px;margin:0 auto" onclick="showCreateEventManual()">&#x1F4CD; Criar evento manualmente</button>';
  html+='</div>';
  $('locContent').innerHTML=html;
}
async function updateLocationOnServer(){
  if(!myLat||!state.userId)return;
  try{await fetch('/api/location/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,lat:myLat,lng:myLng})})}catch(e){}
}
function switchLocTab(tab){
  locTab=tab;
  $('tabNearby').classList.toggle('active',tab==='nearby');
  $('tabEvents').classList.toggle('active',tab==='events');
  loadLocTab();
}
function loadLocTab(){if(locTab==='nearby')loadNearbyPeople();else loadNearbyEvents()}
async function loadNearbyPeople(){
  const c=$('locContent');
  if(!myLat){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3)">'+i18n('loc_activate')+'</div>';return}
  c.innerHTML='<div style="text-align:center;padding:1rem;color:var(--t3)">'+i18n('loc_loading')+'</div>';
  try{
    const r=await fetch('/api/nearby/'+state.userId+'?radius=1000');
    const people=await r.json();
    if(!people.length){c.innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x1F465;</div>'+i18n('loc_no_people')+'</div>';return}
    let html='';
    people.forEach(p=>{
      const color=p.color||nickColor(p.nickname||p.name||'??');
      const nick=p.nickname||p.name||'?';
      const dist=p.distance<1000?Math.round(p.distance)+'m':((p.distance/1000).toFixed(1))+'km';
      html+='<div class="loc-person">';
      html+=makeAvatar(nick,color,36,p.profilePhoto||null);
      html+='<div class="loc-person-info"><div class="loc-person-nick">'+esc(nick)+'</div><div class="loc-person-dist">'+dist+'</div>';
      if(p.score||p.stars)html+='<div class="loc-person-pts">'+(p.score?'&#x26A1;'+p.score:'')+(p.stars?' ⭐'+p.stars:'')+'</div>';
      html+='</div>';
      html+='<button class="loc-encosta-btn" onclick="encostaFromLocation(\''+p.id+'\')">'+i18n('loc_encosta')+'</button>';
      html+='</div>';
    });
    c.innerHTML=html;
  }catch(e){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--err)">Erro ao buscar.</div>'}
}
async function loadNearbyEvents(){
  const c=$('locContent');
  if(!myLat){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3)">'+i18n('loc_activate')+'</div>';return}
  c.innerHTML='<div style="text-align:center;padding:1rem;color:var(--t3)">'+i18n('loc_loading')+'</div>';
  try{
    const r=await fetch('/api/events/nearby?lat='+myLat+'&lng='+myLng+'&radius=5000');
    const events=await r.json();
    if(!events.length){c.innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x1F389;</div>'+i18n('loc_no_events')+'<br><span style="font-size:.72rem;color:var(--ac);cursor:pointer" onclick="showCreateEvent()">'+i18n('create_event_btn')+'</span></div>';return}
    let html='';
    events.forEach(ev=>{
      const dist=ev.distance<1000?Math.round(ev.distance)+'m':((ev.distance/1000).toFixed(1))+'km';
      html+='<div class="evt-card" onclick="openEventDetail(\''+ev.id+'\')">';
      html+='<div class="evt-card-name">'+esc(ev.name)+'</div>';
      html+='<div class="evt-card-meta"><span>📍 '+dist+'</span><span>'+esc(ev.participantCount||0)+' '+i18n('evt_people')+'</span></div>';
      if(ev.description)html+='<div class="evt-card-desc">'+esc(ev.description)+'</div>';
      html+='</div>';
    });
    c.innerHTML=html;
  }catch(e){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--err)">Erro ao buscar.</div>'}
}
function showCreateEvent(){
  _renderEventForm(!!myLat);
}
function showCreateEventManual(){
  _renderEventForm(false);
}
function _renderEventForm(hasLocation){
  let html='<div class="loc-create-form">';
  html+='<div class="form-title">&#x1F4CD; '+i18n('create_event_title')+'</div>';
  html+='<div class="form-sub">Crie um ponto de encontro digital em um local físico. Quem estiver por perto poderá entrar e se conectar.</div>';
  html+='<div class="loc-fg"><label>'+i18n('evt_name')+'</label><input type="text" id="evtName" maxlength="60" placeholder="'+i18n('evt_name_ph')+'"></div>';
  html+='<div class="loc-fg"><label>'+i18n('evt_desc')+'</label><textarea id="evtDesc" maxlength="200" placeholder="'+i18n('evt_desc_ph')+'"></textarea></div>';
  if(!hasLocation){
    html+='<div class="loc-fg"><label>Latitude</label><input type="text" id="evtLat" placeholder="-23.550520"></div>';
    html+='<div class="loc-fg"><label>Longitude</label><input type="text" id="evtLng" placeholder="-46.633308"></div>';
    html+='<div style="font-size:.62rem;color:var(--t3);margin:-.4rem 0 .6rem;line-height:1.4">Dica: busque no Google Maps, clique no local e copie as coordenadas.</div>';
  }
  html+='<div class="loc-fg"><label>&#x1F4E1; '+i18n('evt_radius')+'</label>';
  html+='<div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.3rem">';
  ['50','100','200','500','1000'].forEach(r=>{
    const sel=r==='200'?'background:var(--ac);color:#fff;border-color:var(--ac)':'';
    html+='<button type="button" class="bs radius-opt" style="font-size:.68rem;padding:.3rem .6rem;'+sel+'" onclick="selectRadius(this,'+r+')">'+r+'m</button>';
  });
  html+='</div><input type="hidden" id="evtRadius" value="200"></div>';
  html+='<div style="display:flex;gap:.6rem;margin-top:.3rem"><button type="button" class="bp" style="flex:1" onclick="createEvent()">'+i18n('evt_create')+'</button><button type="button" class="bs" style="flex:1" onclick="loadLocTab()">'+i18n('evt_cancel')+'</button></div>';
  html+='</div>';
  $('locContent').innerHTML=html;
  setTimeout(()=>{const n=$('evtName');if(n)n.focus()},100);
}
function selectRadius(btn,val){
  document.querySelectorAll('.radius-opt').forEach(b=>{b.style.background='';b.style.color='';b.style.borderColor=''});
  btn.style.background='var(--ac)';btn.style.color='#fff';btn.style.borderColor='var(--ac)';
  $('evtRadius').value=val;
}
async function createEvent(){
  const name=$('evtName')?$('evtName').value.trim():'';
  const desc=$('evtDesc')?$('evtDesc').value.trim():'';
  const radius=parseInt($('evtRadius')?$('evtRadius').value:'200')||200;
  if(!name||name.length<3)return showToast(i18n('evt_name_err'));
  // Use GPS coords or manual input
  let lat=myLat,lng=myLng;
  if($('evtLat')){lat=parseFloat($('evtLat').value);lng=parseFloat($('evtLng').value)}
  if(!lat||!lng||isNaN(lat)||isNaN(lng))return showToast('Coordenadas inválidas.');
  try{
    const r=await fetch('/api/event/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,name,description:desc,lat,lng,radius})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast(i18n('evt_created'));haptic([50,30,50]);
    const evtId=d.event?d.event.id:d.id;
    openEventDetail(evtId);
  }catch(e){showToast('Erro ao criar evento.')}
}
async function openEventDetail(eventId){
  showScreen('eventDetail');
  $('evtDetailScroll').innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x23F3;</div>'+i18n('loc_loading')+'</div>';
  try{
    const r=await fetch('/api/event/'+eventId);
    const ev=await r.json();
    if(ev.error){showToast(ev.error);return}
    $('evtDetailTitle').textContent=ev.name;
    const parts=ev.participantsData||ev.participants||[];
    const alreadyIn=parts.some(p=>p.id===state.userId);
    const pCount=parts.length;
    let html='<div class="evt-detail">';
    html+='<div class="evt-detail-name">'+esc(ev.name)+'</div>';
    if(ev.description)html+='<div class="evt-detail-desc">"'+esc(ev.description)+'"</div>';
    html+='<div style="display:flex;gap:.6rem;align-items:center;font-size:.68rem;color:var(--t3);margin-bottom:.8rem">';
    html+='<span>&#x1F4E1; '+ev.radius+'m</span>';
    html+='<span>&#x1F465; '+pCount+' '+i18n('evt_people')+'</span>';
    html+='</div>';
    if(!alreadyIn){
      html+='<button class="bp" style="font-size:.82rem" onclick="joinEvent(\''+eventId+'\')">&#x1F91D; '+i18n('evt_join')+'</button>';
    }else{
      html+='<div style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;color:var(--ok);padding:.5rem .7rem;background:rgba(52,211,153,.06);border-radius:10px;border:1px solid rgba(52,211,153,.15)">&#x2714; '+i18n('evt_joined')+'</div>';
    }
    html+='</div>';
    html+='<div class="evt-ppl-title">'+i18n('evt_participants')+' ('+pCount+')</div>';
    if(pCount>0){
      parts.forEach(p=>{
        const color=p.color||nickColor(p.nickname||p.name||'??');
        const nick=p.nickname||p.name||'?';
        const isMe=p.id===state.userId;
        html+='<div class="loc-person">';
        html+=makeAvatar(nick,color,34,p.profilePhoto||null);
        html+='<div class="loc-person-info"><div class="loc-person-nick">'+esc(nick)+(isMe?' <span style="font-size:.62rem;color:var(--ok)">('+i18n('evt_you')+')</span>':'')+'</div></div>';
        if(!isMe&&alreadyIn)html+='<button class="loc-encosta-btn" onclick="encostaAtEvent(\''+eventId+'\',\''+esc(nick)+'\')">'+i18n('loc_encosta')+'</button>';
        html+='</div>';
      });
    }else html+='<div class="loc-empty"><div class="loc-empty-icon">&#x1F3C3;</div>'+i18n('evt_nobody')+'</div>';
    $('evtDetailScroll').innerHTML=html;
  }catch(e){$('evtDetailScroll').innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x26A0;</div>Erro ao carregar evento.</div>'}
}
async function joinEvent(eventId){
  try{
    const r=await fetch('/api/event/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId,userId:state.userId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast(i18n('evt_joined_msg'));haptic([50,30,50]);
    openEventDetail(eventId);
  }catch(e){showToast('Erro.')}
}
async function encostaAtEvent(eventId,partnerNick){
  try{
    const r=await fetch('/api/event/encosta-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId,userId:state.userId,targetNickname:partnerNick})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Pedido enviado! Aguardando aceite...');haptic([50,30,50]);
  }catch(e){showToast('Erro ao conectar.')}
}
async function encostaFromLocation(targetId){
  // Start encounter via proximity - create a session and auto-match
  try{
    const r=await fetch('/api/session/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    // now the target joins
    const r2=await fetch('/api/session/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:d.code,userId:targetId})});
    const d2=await r2.json();
    if(d2.error)return showToast(d2.error);
    showToast(i18n('evt_encosta_ok'));haptic([80,40,80,40,80]);
    goHome();refreshHome();
  }catch(e){showToast('Erro ao conectar.')}
}

// ═══ i18n ═══
const LANG={
pt:{
  loc_btn:'Localização',ticket_btn:'Meu Bilhete',loc_title:'Explorar ao redor',
  create_event_btn:'+ Evento',loc_activate:'Ative sua localização para descobrir pessoas e eventos.',
  loc_searching:'Buscando localização...',loc_active:'📍 Localização ativa',
  loc_denied:'Localização negada. Permita no navegador.',tab_nearby:'Pessoas',tab_events:'Eventos',
  loc_loading:'Carregando...',loc_no_people:'Ninguém por perto no momento.',
  loc_no_events:'Nenhum evento por perto.',loc_encosta:'Touch',loc_need_gps:'Ative o GPS primeiro.',
  create_event_title:'Criar um evento',evt_name:'Nome',evt_name_ph:'Ex: Café no centro',
  evt_desc:'Descrição',evt_desc_ph:'Opcional...',evt_radius:'Raio',evt_create:'Criar',evt_cancel:'Cancelar',
  evt_name_err:'Nome precisa ter pelo menos 3 caracteres.',evt_created:'Evento criado!',
  evt_join:'Entrar neste evento',evt_joined:'Você está aqui',evt_joined_msg:'Você entrou no evento!',
  evt_participants:'Participantes',evt_you:'você',evt_nobody:'Ninguém ainda. Seja o primeiro!',
  evt_people:'pessoas',evt_encosta_ok:'Touch! Nova conexão criada.',
  // Home
  brand_name:'Touch?',brand_tag:'tudo nasce no gesto',
  home_greeting:'Olá',home_motto:'Nada acontece<br>à distância.',home_btn:'TOUCH',
  home_footer:'Tocar cria algo. Não tocar faz sumir.',
  sonic_searching:'Emitindo som ultrassônico...',sonic_approach:'Aproxime os celulares...',sonic_fallback:'Aproxime os celulares ou use código',
  // Register
  reg_title:'Touch?',reg_sub:'crie sua presença',reg_nick_hint:'escolha seu nickname',
  reg_nick:'Nickname',reg_birth:'Data de nascimento',
  reg_terms:'Entendo e aceito que <strong>todas as relações aqui são temporárias</strong>. Nada persiste sem encontro.',
  reg_btn:'ENTRAR',
  // Encounter
  enc_how:'Como vão se encontrar?',enc_create:'Criar encontro',enc_join:'Entrar com código',
  enc_share:'Compartilhe esse código:',enc_waiting:'Esperando alguém conectar...',
  enc_code_ph:'CÓDIGO',enc_join_btn:'TOUCH',
  // Reveal
  rev_phrase:'Uma frase para começar:',
  // Chat
  chat_msg_ph:'Diga algo que valha 24h...',chat_expired:'Esta conexão expirou.',
  // Profile
  pf_decl:'Declarações',pf_gifts:'Presentes recebidos',pf_empty_decl:'Nenhuma declaração ainda.',
  pf_empty_gift:'Nenhum presente ainda.',
  // Gift
  gift_title:'Escolha um presente',gift_msg_ph:'Mensagem (opcional)',gift_send:'Enviar presente',
  gift_needs_addr:'Requer endereço (pediremos permissão)',gift_sent:'Presente enviado!',
  // Decl
  decl_title:'Declaração',decl_sub:'Escreva algo para ficar no perfil dessa pessoa. Todos que se conectarem a ela poderão ler.',
  decl_ph:'Escreva sua declaração...',decl_publish:'Publicar',decl_min:'Escreva pelo menos 3 caracteres.',
  decl_ok:'Declaração publicada!',
  // Boarding
  bp_title:'Touch? Pass',bp_encounters:'encontros',bp_since:'desde',bp_save:'Salvar Imagem',
  // History
  hist_title:'Constelação',hist_empty:'Nenhum encontro ainda.',hist_save:'Salvar',hist_share:'Compartilhar'
},
en:{
  loc_btn:'Location',ticket_btn:'My Ticket',loc_title:'Explore nearby',
  create_event_btn:'+ Event',loc_activate:'Enable your location to discover people and events.',
  loc_searching:'Searching location...',loc_active:'📍 Location active',
  loc_denied:'Location denied. Allow in browser.',tab_nearby:'People',tab_events:'Events',
  loc_loading:'Loading...',loc_no_people:'Nobody nearby right now.',
  loc_no_events:'No events nearby.',loc_encosta:'Touch',loc_need_gps:'Enable GPS first.',
  create_event_title:'Create an event',evt_name:'Name',evt_name_ph:'E.g.: Coffee downtown',
  evt_desc:'Description',evt_desc_ph:'Optional...',evt_radius:'Radius',evt_create:'Create',evt_cancel:'Cancel',
  evt_name_err:'Name must be at least 3 characters.',evt_created:'Event created!',
  evt_join:'Join this event',evt_joined:'You are here',evt_joined_msg:'You joined the event!',
  evt_participants:'Participants',evt_you:'you',evt_nobody:'Nobody yet. Be the first!',
  evt_people:'people',evt_encosta_ok:'Touched! New connection created.',
  brand_name:'Touch?',brand_tag:'it all starts with a gesture',
  home_greeting:'Hello',home_motto:'Nothing happens<br>from a distance.',home_btn:'TOUCH',
  home_footer:'Touching creates something. Not touching makes it vanish.',
  sonic_searching:'Emitting ultrasonic sound...',sonic_approach:'Bring phones closer...',sonic_fallback:'Bring phones closer or use code',
  reg_title:'Touch?',reg_sub:'create your presence',reg_nick_hint:'choose your nickname',
  reg_nick:'Nickname',reg_birth:'Date of birth',
  reg_terms:'I understand and accept that <strong>all relationships here are temporary</strong>. Nothing persists without encounter.',
  reg_btn:'ENTER',
  enc_how:'How will you meet?',enc_create:'Create encounter',enc_join:'Join with code',
  enc_share:'Share this code:',enc_waiting:'Waiting for someone to connect...',
  enc_code_ph:'CODE',enc_join_btn:'TOUCH',
  rev_phrase:'A phrase to begin:',
  chat_msg_ph:'Say something worth 24h...',chat_expired:'This connection has expired.',
  pf_decl:'Declarations',pf_gifts:'Gifts received',pf_empty_decl:'No declarations yet.',
  pf_empty_gift:'No gifts yet.',
  gift_title:'Choose a gift',gift_msg_ph:'Message (optional)',gift_send:'Send gift',
  gift_needs_addr:'Requires address (we\'ll ask permission)',gift_sent:'Gift sent!',
  decl_title:'Declaration',decl_sub:'Write something for this person\'s profile. Everyone who connects with them can read it.',
  decl_ph:'Write your declaration...',decl_publish:'Publish',decl_min:'Write at least 3 characters.',
  decl_ok:'Declaration published!',
  bp_title:'Touch? Ticket',bp_encounters:'encounters',bp_since:'since',bp_save:'Save Image',
  hist_title:'Constellation',hist_empty:'No encounters yet.',hist_save:'Save',hist_share:'Share'
},
es:{
  loc_btn:'Ubicación',ticket_btn:'Mi Boleto',loc_title:'Explorar alrededor',
  create_event_btn:'+ Evento',loc_activate:'Activa tu ubicación para descubrir personas y eventos.',
  loc_searching:'Buscando ubicación...',loc_active:'📍 Ubicación activa',
  loc_denied:'Ubicación denegada. Permite en el navegador.',tab_nearby:'Personas',tab_events:'Eventos',
  loc_loading:'Cargando...',loc_no_people:'Nadie cerca por ahora.',
  loc_no_events:'No hay eventos cerca.',loc_encosta:'Tocar',loc_need_gps:'Activa el GPS primero.',
  create_event_title:'Crear un evento',evt_name:'Nombre',evt_name_ph:'Ej: Café en el centro',
  evt_desc:'Descripción',evt_desc_ph:'Opcional...',evt_radius:'Radio',evt_create:'Crear',evt_cancel:'Cancelar',
  evt_name_err:'El nombre debe tener al menos 3 caracteres.',evt_created:'¡Evento creado!',
  evt_join:'Unirse a este evento',evt_joined:'Estás aquí',evt_joined_msg:'¡Te uniste al evento!',
  evt_participants:'Participantes',evt_you:'tú',evt_nobody:'Nadie aún. ¡Sé el primero!',
  evt_people:'personas',evt_encosta_ok:'¡Tocó! Nueva conexión creada.',
  brand_name:'Touch?',brand_tag:'todo nace en el gesto',
  home_greeting:'Hola',home_motto:'Nada pasa<br>a distancia.',home_btn:'TOCAR',
  home_footer:'Tocar crea algo. No tocar lo hace desaparecer.',
  sonic_searching:'Emitiendo sonido ultrasónico...',sonic_approach:'Acerquen los celulares...',sonic_fallback:'Acerquen los celulares o usen código',
  reg_title:'Touch?',reg_sub:'crea tu presencia',reg_nick_hint:'elige tu nickname',
  reg_nick:'Nickname',reg_birth:'Fecha de nacimiento',
  reg_terms:'Entiendo y acepto que <strong>todas las relaciones aquí son temporales</strong>. Nada persiste sin encuentro.',
  reg_btn:'ENTRAR',
  enc_how:'¿Cómo se van a encontrar?',enc_create:'Crear encuentro',enc_join:'Entrar con código',
  enc_share:'Comparte este código:',enc_waiting:'Esperando que alguien conecte...',
  enc_code_ph:'CÓDIGO',enc_join_btn:'TOCAR',
  rev_phrase:'Una frase para empezar:',
  chat_msg_ph:'Di algo que valga 24h...',chat_expired:'Esta conexión expiró.',
  pf_decl:'Declaraciones',pf_gifts:'Regalos recibidos',pf_empty_decl:'Sin declaraciones aún.',
  pf_empty_gift:'Sin regalos aún.',
  gift_title:'Elige un regalo',gift_msg_ph:'Mensaje (opcional)',gift_send:'Enviar regalo',
  gift_needs_addr:'Requiere dirección (pediremos permiso)',gift_sent:'¡Regalo enviado!',
  decl_title:'Declaración',decl_sub:'Escribe algo para el perfil de esta persona. Todos los que se conecten con ella podrán leerlo.',
  decl_ph:'Escribe tu declaración...',decl_publish:'Publicar',decl_min:'Escribe al menos 3 caracteres.',
  decl_ok:'¡Declaración publicada!',
  bp_title:'Touch? Pass',bp_encounters:'encuentros',bp_since:'desde',bp_save:'Guardar Imagen',
  hist_title:'Constelación',hist_empty:'Sin encuentros aún.',hist_save:'Guardar',hist_share:'Compartir'
}
};
let currentLang=localStorage.getItem('touch_lang')||'pt';
function i18n(key){return (LANG[currentLang]&&LANG[currentLang][key])||LANG.pt[key]||key}
function setLang(lang){
  currentLang=lang;
  localStorage.setItem('touch_lang',lang);
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active',b.textContent.trim().toLowerCase()===lang));
  applyLang();
}
function applyLang(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.getAttribute('data-i18n');
    const val=i18n(key);
    if(val)el.innerHTML=val;
  });
  // Update dynamic elements
  const brand=$('homeBrand');if(brand)brand.textContent=i18n('brand_name');
  const btnText=$('mainBtnText');if(btnText&&!homeSonicActive)btnText.textContent=i18n('home_btn');
}

// ═══ GORJETA / TIP ═══
let tipState = { receiverId: null, amount: 0, mpInstance: null, cardToken: null };

function showTipScreen(receiverId) {
  const user = null; // will be fetched
  tipState = { receiverId, amount: 0, mpInstance: null, cardToken: null };
  // Reset UI
  document.querySelectorAll('.tip-amount-btn').forEach(b => b.classList.remove('selected'));
  $('tipCustomAmount').value = '';
  $('tipPayBtn').disabled = true;
  $('tipPayBtn').textContent = 'Confirmar gorjeta';
  $('tipResult').classList.add('hidden');
  $('tipScreen').querySelector('.tip-card-section').style.display = '';
  $('tipScreen').querySelector('.tip-amounts').style.display = '';
  $('tipScreen').querySelector('.tip-custom').style.display = '';

  // Fetch receiver info
  fetch('/api/user/' + receiverId).then(r => r.json()).then(u => {
    const color = u.color || nickColor(u.nickname || '?');
    const serviceLabel = u.serviceLabel || '';
    const photo = u.profilePhoto || null;
    const revData = state.revealedIds && state.revealedIds[receiverId];
    const displayPhoto = photo || (revData && revData.profilePhoto) || null;
    const displayName = (revData && revData.realName) || u.nickname || u.name;
    $('tipReceiver').innerHTML =
      makeAvatar(u.nickname || '?', color, 64, displayPhoto) +
      '<div class="tip-receiver-name">' + esc(displayName) + '</div>' +
      (serviceLabel ? '<div class="tip-receiver-service">' + esc(serviceLabel) + '</div>' : '');
  }).catch(() => {});

  showScreen('tipScreen');
  initMPSecureFields();
}

function selectTipAmount(val) {
  tipState.amount = val;
  $('tipCustomAmount').value = '';
  document.querySelectorAll('.tip-amount-btn').forEach(b => {
    b.classList.toggle('selected', b.textContent === 'R$' + val);
  });
  updateTipBtn();
}
function selectTipCustom() {
  const v = parseFloat($('tipCustomAmount').value);
  if (v > 0) {
    tipState.amount = v;
    document.querySelectorAll('.tip-amount-btn').forEach(b => b.classList.remove('selected'));
  }
  updateTipBtn();
}
function updateTipBtn() {
  const btn = $('tipPayBtn');
  if (tipState.amount > 0) {
    btn.disabled = false;
    btn.textContent = 'Pagar R$' + tipState.amount.toFixed(2).replace('.', ',');
  } else {
    btn.disabled = true;
    btn.textContent = 'Confirmar gorjeta';
  }
}

let mpSecureFieldsLoaded = false;
function initMPSecureFields() {
  if (!window.MercadoPago) {
    // Load MP SDK
    if (!mpSecureFieldsLoaded) {
      const script = document.createElement('script');
      script.src = 'https://sdk.mercadopago.com/js/v2';
      script.onload = () => setupMPFields();
      document.head.appendChild(script);
      mpSecureFieldsLoaded = true;
    }
  } else {
    setupMPFields();
  }
}

function setupMPFields() {
  fetch('/api/mp/public-key').then(r => r.json()).then(({ publicKey }) => {
    tipState.mpInstance = new window.MercadoPago(publicKey, { locale: 'pt-BR' });
    const mp = tipState.mpInstance;
    // Clear previous fields
    ['mpCardNumber', 'mpExpiry', 'mpCVV', 'mpCardHolder'].forEach(id => { $(id).innerHTML = ''; });
    const style = { color: '#f5f5f7', 'font-size': '14px', 'font-family': 'Inter, sans-serif', placeholder: { color: '#555568' } };
    const cardNumber = mp.fields.create('cardNumber', { placeholder: 'Número do cartão', style }).mount('mpCardNumber');
    mp.fields.create('expirationDate', { placeholder: 'MM/AA', style }).mount('mpExpiry');
    mp.fields.create('securityCode', { placeholder: 'CVV', style }).mount('mpCVV');
    // Card holder is a regular input
    $('mpCardHolder').innerHTML = '<input type="text" placeholder="Nome no cartão" style="width:100%;background:transparent;border:none;color:var(--t1);font-size:14px;font-family:Inter,sans-serif;outline:none" id="mpCardHolderInput">';
  }).catch(e => console.error('MP setup error:', e));
}

async function processTip() {
  if (!tipState.amount || tipState.amount < 1) return showToast('Escolha um valor.');
  if (!tipState.mpInstance) return showToast('Carregando pagamento...');
  const btn = $('tipPayBtn');
  btn.disabled = true; btn.textContent = 'Processando...';

  try {
    // Create card token via MP SDK
    const holderName = $('mpCardHolderInput') ? $('mpCardHolderInput').value : '';
    const tokenResult = await tipState.mpInstance.fields.createCardToken({
      cardholderName: holderName
    });
    if (!tokenResult || !tokenResult.id) throw new Error('Erro ao tokenizar cartão.');

    // Send to server
    const payerEmail = ($('tipPayerEmail') ? $('tipPayerEmail').value.trim() : '') || 'test@testuser.com';
    const payerCPF = ($('tipPayerCPF') ? $('tipPayerCPF').value.replace(/\D/g,'') : '') || '12345678909';
    const resp = await fetch('/api/tip/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        payerId: state.userId,
        receiverId: tipState.receiverId,
        amount: tipState.amount,
        token: tokenResult.id,
        paymentMethodId: tokenResult.payment_method_id || 'visa',
        installments: 1,
        payerEmail,
        payerCPF
      })
    });
    const result = await resp.json();

    if (result.status === 'approved') {
      showTipResult('✅', 'Gorjeta enviada!<br>R$' + tipState.amount.toFixed(2).replace('.', ',') + ' chegou.');
      haptic([50, 30, 50, 30, 50]);
    } else if (result.status === 'pending' || result.status === 'in_process') {
      showTipResult('⏳', 'Pagamento em processamento.<br>Você será notificado.');
    } else {
      showTipResult('❌', 'Pagamento não aprovado.<br>' + (result.statusDetail || 'Tente outro cartão.'));
    }
  } catch (e) {
    console.error('Tip error:', e);
    showTipResult('❌', 'Erro: ' + (e.message || 'Tente novamente.'));
  }
}

function showTipResult(icon, text) {
  $('tipResult').classList.remove('hidden');
  $('tipResultIcon').textContent = icon;
  $('tipResultText').innerHTML = text;
  // Hide form parts
  $('tipScreen').querySelector('.tip-card-section').style.display = 'none';
  $('tipScreen').querySelector('.tip-amounts').style.display = 'none';
  $('tipScreen').querySelector('.tip-custom').style.display = 'none';
  $('tipPayBtn').style.display = 'none';
}

// ═══ PRESTADOR REGISTER ═══
let pregSelectedService = null;

function showPrestadorRegister() {
  showScreen('prestadorReg');
  // Pre-fill if user already exists
  if (state.userId && state.userName) {
    $('pregNick').value = state.userName;
    $('pregNick').disabled = true; // Can't change nickname of existing user
    // Fetch full user info to pre-fill name
    fetch('/api/user/' + state.userId).then(r => r.json()).then(u => {
      if (u.name) $('pregName').value = u.name;
      if (u.birthdate) $('pregBirth').value = u.birthdate;
      if (u.isPrestador) {
        $('pregSubmitBtn').textContent = 'Atualizar serviço';
        // Show already-prestador status
        $('pregMpStatus').style.display = 'block';
        $('pregMpText').textContent = u.mpConnected ? '✅ MercadoPago conectado' : 'Conecte MercadoPago para receber pagamentos';
        if (!u.mpConnected) { $('pregMpBtn').style.display = 'block'; }
      }
    }).catch(() => {});
  } else {
    $('pregNick').value = '';
    $('pregNick').disabled = false;
    $('pregSubmitBtn').textContent = 'Criar conta de prestador';
    $('pregMpStatus').style.display = 'none';
    $('pregMpBtn').style.display = 'none';
  }
  // Load service types
  const grid = $('pregServices');
  pregSelectedService = null;
  fetch('/api/service-types').then(r => r.json()).then(types => {
    grid.innerHTML = '';
    types.forEach(t => {
      const btn = document.createElement('button');
      btn.className = 'preg-svc';
      btn.textContent = t.label;
      btn.onclick = () => {
        pregSelectedService = t.id;
        grid.querySelectorAll('.preg-svc').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      };
      grid.appendChild(btn);
    });
  });
}

function checkPregNick(val) {
  const hint = $('pregNickHint');
  const nick = val.trim();
  if (!nick || nick.length < 2) { hint.textContent = 'mínimo 2 caracteres'; hint.className = 'nick-hint'; return; }
  if (!/^[a-zA-Z0-9_.-]+$/.test(nick)) { hint.textContent = 'só letras, números, _ . -'; hint.className = 'nick-hint taken'; return; }
  fetch('/api/check-nick/' + encodeURIComponent(nick)).then(r => r.json()).then(d => {
    if (d.available) { hint.textContent = '✓ disponível'; hint.className = 'nick-hint ok'; }
    else { hint.textContent = 'já existe'; hint.className = 'nick-hint taken'; }
  });
}

async function registerPrestador() {
  const name = $('pregName').value.trim();
  const nick = $('pregNick').value.trim();
  const cpf = $('pregCPF').value.trim();
  const birth = $('pregBirth').value;
  if (!name) return showToast('Preencha o nome.');
  if (!pregSelectedService) return showToast('Escolha o tipo de serviço.');

  // If user already has account, convert to prestador (keep same userId)
  const existingId = state.userId || null;
  if (!existingId && (!nick || nick.length < 2)) return showToast('Preencha o nickname.');

  try {
    const body = { serviceType: pregSelectedService, fullName: name, cpf, birthdate: birth || null };
    if (existingId) body.userId = existingId;
    if (nick) body.nickname = nick;
    const resp = await fetch('/api/prestador/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await resp.json();
    if (data.error) return showToast(data.error);
    // Update local state (keep same userId if converting)
    state.userId = data.userId;
    state.userName = data.user.nickname;
    state.userColor = data.user.color;
    localStorage.setItem('touch_userId', data.userId);
    localStorage.setItem('touch_userName', data.user.nickname);
    localStorage.setItem('touch_userColor', data.user.color);
    localStorage.setItem('touch_isPrestador', '1');
    showToast(existingId ? 'Conta atualizada! Agora você é prestador.' : 'Conta criada!');
    // Show MP connect option
    $('pregSubmitBtn').style.display = 'none';
    $('pregMpBtn').style.display = 'block';
    $('pregMpStatus').style.display = 'block';
    $('pregMpText').textContent = 'Agora conecte sua conta MercadoPago para receber pagamentos.';
  } catch (e) { showToast('Erro: ' + e.message); }
}

function connectMercadoPago() {
  if (!state.userId) return showToast('Crie a conta primeiro.');
  window.location.href = '/mp/auth/' + state.userId;
}

// ═══ PULL TO REFRESH (Home) ═══
(function(){
  const home=$('home');if(!home)return;
  let ptrStartY=0,ptrActive=false,ptrTriggered=false;
  const indicator=$('ptrIndicator');
  const threshold=60;
  home.addEventListener('touchstart',e=>{
    if(!home.classList.contains('active'))return;
    ptrStartY=e.touches[0].clientY;ptrActive=true;ptrTriggered=false;
  },{passive:true});
  home.addEventListener('touchmove',e=>{
    if(!ptrActive)return;
    const dy=e.touches[0].clientY-ptrStartY;
    if(dy>20&&dy<150){
      indicator.classList.add('pulling');
      indicator.classList.remove('refreshing');
    }
    if(dy>threshold)ptrTriggered=true;
  },{passive:true});
  home.addEventListener('touchend',()=>{
    if(ptrTriggered){
      indicator.classList.remove('pulling');
      indicator.classList.add('refreshing');
      refreshHome();
      setTimeout(()=>{indicator.classList.remove('refreshing')},1200);
    }else{
      indicator.classList.remove('pulling');
    }
    ptrActive=false;ptrTriggered=false;
  },{passive:true});
})();

// ═══ EVENTS ═══
$('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();sendMessage()}});
$('chatInput').addEventListener('input',()=>{handleTyping();updateSendBtn()});
$('chatInput').addEventListener('focus',()=>closePlusMenu());
document.addEventListener('click',e=>{const pm=$('plusMenu');if(pm&&pm.classList.contains('open')&&!pm.contains(e.target)&&!e.target.closest('.cia-plus'))closePlusMenu()});
$('joinCodeInput').addEventListener('keydown',e=>{if(e.key==='Enter')joinSession()});
if(window.visualViewport){let ph=window.visualViewport.height;window.visualViewport.addEventListener('resize',()=>{if($('chat').classList.contains('active')&&window.visualViewport.height<ph)requestAnimationFrame(()=>{$('chatMessages').scrollTop=99999});ph=window.visualViewport.height})}

// ═══ RESOURCE CLEANUP + SCREENSHOT PROTECTION ═══
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){
    // Release mic, speaker, camera when app goes to background
    releaseAllMedia();
    // Blur chat for screenshot protection
    if($('chat').classList.contains('active'))$('chatMessages').style.filter='blur(20px)';
  }else{
    $('chatMessages').style.filter='';
  }
});
// Also cleanup on page close/navigate away
window.addEventListener('beforeunload',()=>releaseAllMedia());
window.addEventListener('pagehide',()=>releaseAllMedia());
// Block keyboard screenshot shortcuts (partial - won't work on all platforms)
document.addEventListener('keyup',e=>{
  if(e.key==='PrintScreen'&&$('chat').classList.contains('active')){
    $('chatMessages').style.filter='blur(20px)';
    showToast('Screenshots não permitidos no chat.');
    setTimeout(()=>{$('chatMessages').style.filter=''},1500);
  }
});

// ═══ INIT ═══
async function validateUser(){
  if(!state.userId)return false;
  try{
    const r=await fetch('/api/user/'+state.userId);
    if(!r.ok){localStorage.removeItem('touch_userId');localStorage.removeItem('touch_userName');state.userId=null;state.userName=null;return false}
    return true;
  }catch(e){return false}
}
window.addEventListener('load',()=>{
  applyLang();
  const qr=new URLSearchParams(location.search).get('code');
  setTimeout(async()=>{
    if(state.userId&&await validateUser()){
      initSocket();
      // Set home avatar
      const _ha=$('homeAvatar');if(_ha&&state.userName){_ha.textContent=(state.userName||'??').slice(0,2).toUpperCase();_ha.style.background=state.userColor||nickColor(state.userName)}
      if(qr){showScreen('home');$('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(state.userName)+'</span>';setTimeout(()=>{$('joinCodeInput').value=qr;showScreen('encounter');showPhase('phaseChoose');joinSession();history.replaceState({},'','/')},300)}
      else{showScreen('home');$('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(state.userName)+'</span>'}
      refreshHome();
    }else{
      // Show onboarding for first-time users, login for returning
      if(!localStorage.getItem('touch_onboarded')){
        initOnboarding();
        showScreen('onboarding');
      }else{
        showScreen('login');
      }
    }
  },1800);
});
</script>
</body>
</html>
