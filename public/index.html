<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#050508">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Touch? — tudo nasce no gesto</title>
<script>
// Force cache bust v4 — unregister service workers + clear caches (no reload loop)
(function(){
  try{if(navigator.serviceWorker){navigator.serviceWorker.getRegistrations().then(function(r){r.forEach(function(w){w.unregister()})}).catch(function(){})}}catch(e){}
  try{if(window.caches){caches.keys().then(function(k){k.forEach(function(n){caches.delete(n)})}).catch(function(){})}}catch(e){}
})();
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
*::-webkit-scrollbar{width:3px}
*::-webkit-scrollbar-track{background:transparent}
*::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}
*::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.2)}
::selection{background:rgba(255,107,53,.3);color:#fff}
:root{
  --bg:#050508;--s1:#12121a;--s2:#1a1a24;--s3:#24243a;
  --b1:#2a2a3a;--b2:rgba(255,255,255,0.06);
  --t1:#f5f5f7;--t2:#8888a0;--t3:#555568;
  --ac:#ff6b35;--ac2:#ff8f65;--pk:#ff3d71;
  --gw:rgba(255,107,53,0.12);--gw2:rgba(255,107,53,0.25);
  --ok:#34d399;--warn:#fbbf24;--err:#f87171;
}
html,body{height:100%;width:100%;font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--t1);overflow:hidden;-webkit-font-smoothing:antialiased}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;visibility:hidden;opacity:0;transform:translateY(6px);transition:opacity .35s cubic-bezier(.22,1,.36,1),transform .35s cubic-bezier(.22,1,.36,1),visibility 0s .35s;pointer-events:none}
.screen.active{visibility:visible;opacity:1;transform:translateY(0);transition:opacity .35s cubic-bezier(.22,1,.36,1),transform .35s cubic-bezier(.22,1,.36,1),visibility 0s;pointer-events:auto}

/* SPLASH */
#splash{justify-content:center;align-items:center;background:radial-gradient(circle at 50% 50%,rgba(255,107,53,.03),transparent 60%)}
#splash .logo{font-size:2.8rem;font-weight:800;letter-spacing:.35em;color:var(--ac);animation:gp 2s ease-in-out infinite;opacity:0;animation:gp 2s ease-in-out infinite,splash-in .8s ease forwards}
#splash .tag{margin-top:1.2rem;font-size:.78rem;color:var(--t3);font-weight:300;letter-spacing:.2em;opacity:0;animation:splash-tag-in .8s ease .4s forwards}
@keyframes fi{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes splash-in{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
@keyframes splash-tag-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes gp{0%,100%{text-shadow:0 0 20px var(--gw)}50%{text-shadow:0 0 50px var(--gw2),0 0 100px rgba(255,107,53,.08)}}

/* REGISTER */
#register{padding:2rem 1.5rem;overflow-y:auto}
.rh{text-align:center;margin-bottom:2rem;padding-top:env(safe-area-inset-top,1.5rem)}
.rh h1{font-size:1.8rem;font-weight:800;letter-spacing:.2em;color:var(--ac)}
.rh p{margin-top:.5rem;font-size:.8rem;color:var(--t2)}
.fg{margin-bottom:1.5rem}
.fg label{display:block;font-size:.7rem;color:var(--t2);text-transform:uppercase;letter-spacing:.12em;margin-bottom:.5rem;font-weight:600}
.fg input[type="text"],.fg input[type="date"]{width:100%;padding:.85rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;color:var(--t1);font-size:1rem;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s}
.fg input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.avs{display:flex;flex-direction:column;align-items:center;gap:.8rem;margin-bottom:1.5rem}
.avp{width:90px;height:90px;border-radius:50%;background:var(--s2);border:2px solid var(--b1);display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:800;color:#fff;overflow:hidden;letter-spacing:.05em;transition:all .3s}
.nick-hint{font-size:.7rem;color:var(--t3);transition:.3s}
.nick-hint.taken{color:var(--err)}.nick-hint.ok{color:var(--ok)}
/* Nick creativity feedback box */
.nick-feedback{margin:.4rem 0 .2rem;padding:.55rem .7rem;border-radius:10px;font-size:.72rem;line-height:1.5;transition:all .4s ease;opacity:0;max-height:0;overflow:hidden;border:1px solid transparent}
.nick-feedback.visible{opacity:1;max-height:200px;padding:.55rem .7rem}
.nick-feedback.boring{background:rgba(255,180,50,.06);border-color:rgba(255,180,50,.15);color:rgba(255,180,50,.85)}
.nick-feedback.meh{background:rgba(100,180,255,.06);border-color:rgba(100,180,255,.15);color:rgba(100,180,255,.85)}
.nick-feedback.good{background:rgba(52,211,153,.06);border-color:rgba(52,211,153,.15);color:rgba(52,211,153,.85)}
.nick-feedback.great{background:rgba(168,85,247,.06);border-color:rgba(168,85,247,.18);color:rgba(168,85,247,.9)}
.nick-feedback .nf-icon{font-size:.9rem;margin-right:.3rem}
.nick-feedback .nf-suggest{display:inline;cursor:pointer;text-decoration:underline;text-decoration-style:dotted;opacity:.7;transition:.2s}
.nick-feedback .nf-suggest:hover{opacity:1}
.tc{display:flex;align-items:flex-start;gap:.8rem;margin-bottom:2rem;padding:1rem;background:var(--s1);border-radius:14px;border:1px solid var(--b1)}
.tc input[type="checkbox"]{width:20px;height:20px;margin-top:2px;accent-color:var(--ac);flex-shrink:0}
.tc span{font-size:.82rem;color:var(--t2);line-height:1.5}

/* BUTTONS */
.bp{width:100%;padding:.95rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:14px;color:#fff;font-size:.95rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.06em;transition:transform .15s cubic-bezier(.22,1,.36,1),box-shadow .2s,opacity .2s;box-shadow:0 4px 15px rgba(255,107,53,.3)}
.bp:active{transform:scale(.95)}.bp:disabled{opacity:.35;pointer-events:none}
.bs{padding:.65rem 1.4rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t2);font-size:.85rem;font-family:inherit;cursor:pointer;transition:transform .15s,background .15s}
.bs:active{transform:scale(.95);background:var(--s2)}

/* LOGIN SCREEN */
#login{padding:2rem 1.5rem;justify-content:center;align-items:center;gap:1.2rem;background:radial-gradient(ellipse at 50% 30%,rgba(255,107,53,.04),transparent 60%)}
.login-logo{font-size:2.4rem;font-weight:800;letter-spacing:.3em;color:var(--ac);margin-bottom:.3rem;text-shadow:0 0 40px rgba(255,107,53,.2)}
.login-sub{font-size:.78rem;color:var(--t2);margin-bottom:2rem;text-align:center;line-height:1.5}
.login-form{width:100%;max-width:340px;display:flex;flex-direction:column;gap:1rem}
.login-input{width:100%;padding:.85rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;color:var(--t1);font-size:.95rem;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s}
.login-input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.login-social{width:100%;max-width:340px;padding:.85rem;border:none;border-radius:14px;font-size:.85rem;font-weight:600;font-family:inherit;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.6rem;transition:all .15s cubic-bezier(.22,1,.36,1);box-shadow:0 2px 12px rgba(0,0,0,.2)}
.login-social:active{transform:scale(.96);box-shadow:0 1px 6px rgba(0,0,0,.15)}
.login-social img,.login-social svg{width:20px;height:20px;flex-shrink:0}
.login-google{background:#fff;color:#333}
.login-apple{background:#000;color:#fff;border:1px solid rgba(255,255,255,.15)}
.login-phone{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff}
.social-btns{display:flex;flex-direction:column;gap:.5rem;align-items:center;width:100%}
/* Phone auth modal */
.phone-auth-wrap{display:none;width:100%;max-width:340px;margin:0 auto}
.phone-row{display:flex;gap:.4rem;align-items:center}
.phone-row select{padding:.7rem .4rem;border-radius:12px;background:var(--s1);border:1px solid var(--b1);color:var(--t1);font-size:.85rem;font-family:inherit;width:80px}
.phone-row input{flex:1}
#recaptchaBox{margin:.5rem 0;min-height:78px}
.sms-code-wrap{display:none;text-align:center}
.sms-code-wrap input{width:180px;text-align:center;letter-spacing:.5em;font-size:1.3rem;font-weight:700;padding:.7rem}
.login-divider{display:flex;align-items:center;gap:1rem;width:100%;max-width:340px;color:var(--t3);font-size:.75rem}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--b1)}
.auth-tabs{display:flex;width:100%;max-width:340px;background:rgba(255,255,255,.04);border-radius:12px;padding:3px;margin-bottom:1rem;gap:3px}
.auth-tab{flex:1;padding:.55rem;border:none;border-radius:10px;background:transparent;color:var(--t3);font-size:.8rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s}
.auth-tab.active{background:var(--ac);color:#fff}
.login-err{font-size:.78rem;color:var(--err);text-align:center;min-height:1.1rem}
.login-nick-explain{font-size:.7rem;color:var(--t3);text-align:center;line-height:1.5;padding:0 .5rem;font-style:italic}
.reg-nick-info{font-size:.7rem;color:var(--ac2);background:rgba(255,107,53,.06);border:1px solid rgba(255,107,53,.12);border-radius:10px;padding:.6rem .8rem;margin:-.5rem 0 1.2rem;line-height:1.5;text-align:center}

/* PULL TO REFRESH */
.ptr-indicator{position:absolute;top:-50px;left:50%;transform:translateX(-50%);z-index:99;transition:top .3s ease;pointer-events:none}
.ptr-indicator.pulling{top:12px}
.ptr-indicator.refreshing{top:12px}
.ptr-spinner{width:28px;height:28px;border:2.5px solid rgba(255,255,255,.1);border-top-color:var(--ac);border-radius:50%;opacity:.5;transition:opacity .2s}
.ptr-indicator.pulling .ptr-spinner{opacity:1}
.ptr-indicator.refreshing .ptr-spinner{opacity:1;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* HOME */
#home{display:flex;flex-direction:column;align-items:center;height:100%;padding:0;position:relative;overflow:hidden}
#home::before{content:'';position:absolute;top:38%;left:50%;width:500px;height:500px;transform:translate(-50%,-50%);border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.05) 0%,rgba(255,61,113,.02) 40%,transparent 70%);pointer-events:none;z-index:0}
/* Top bar — clean header */
.home-top{display:flex;justify-content:space-between;align-items:center;width:100%;position:relative;z-index:2;flex-shrink:0;padding:max(env(safe-area-inset-top),.8rem) 1.2rem .6rem}
.home-user{display:flex;align-items:center;gap:.6rem;cursor:pointer;-webkit-tap-highlight-color:transparent}
.home-user:active{opacity:.7}
.home-avatar{width:40px;height:40px;border-radius:50%;background:var(--s2);border:2px solid var(--ac);display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:800;color:#fff;overflow:hidden;flex-shrink:0;box-shadow:0 0 12px rgba(255,107,53,.15);transition:transform .2s}
.home-user:active .home-avatar{transform:scale(.9)}
.home-user-info{display:flex;flex-direction:column;gap:.15rem}
.hg{font-size:.75rem;color:var(--t2);font-weight:400;letter-spacing:.01em;line-height:1.2}
.hg .hg-nick{font-size:1.15rem;color:#fff;font-weight:900;letter-spacing:-.02em;display:block;margin-top:.1rem}
.home-realname{font-size:.65rem;color:var(--t3);font-weight:400;letter-spacing:.02em;line-height:1}
.home-user-meta{display:flex;align-items:center;gap:.5rem;font-size:.68rem}
.home-icons{display:flex;gap:.5rem;align-items:center}
/* Verified badge */
.verified-wrap{position:relative;display:inline-flex}
.verified-badge{position:absolute;bottom:-3px;right:-3px;width:20px;height:20px;border-radius:0;background:none;border:none;display:flex;align-items:center;justify-content:center;z-index:3;filter:drop-shadow(0 1px 3px rgba(59,130,246,.6))}
.verified-badge svg{width:20px;height:20px;fill:url(#verifiedGrad)}
.verified-badge-sm{width:16px;height:16px;bottom:-2px;right:-2px}
.verified-badge-sm svg{width:16px;height:16px}
.verified-badge-lg{width:26px;height:26px;bottom:-3px;right:-3px}
.verified-badge-lg svg{width:26px;height:26px}
.home-verified-row{display:flex;align-items:center;gap:.4rem;margin-top:.1rem}
.home-stars-mini{font-size:.7rem;color:#fbbf24;letter-spacing:-.02em}
/* Center section — takes all available space, centers the button */
.hc{text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.8rem;flex:1;position:relative;z-index:1;width:100%;padding:0 1.2rem}
.hm{font-size:.82rem;color:var(--t3);font-weight:300;font-style:italic;line-height:1.6;max-width:220px;letter-spacing:.01em}
.daily-counter{font-size:.7rem;color:var(--t2);font-weight:400;padding:.4rem .9rem;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:20px;margin-top:.6rem;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:.35rem;position:relative;z-index:2}
.daily-counter:active{transform:scale(.96);background:rgba(255,255,255,.08)}
.daily-counter strong{color:var(--ac);font-weight:700}
.daily-counter .dc-arrow{font-size:.55rem;color:var(--t3);margin-left:.1rem;transition:transform .2s}
/* Main TOUCH button */
.be{width:clamp(150px,42vw,190px);height:clamp(150px,42vw,190px);border-radius:50%;background:rgba(255,107,53,.18);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:2px solid rgba(255,107,53,.35);color:#fff;font-size:.85rem;font-weight:800;font-family:inherit;letter-spacing:.25em;cursor:pointer;position:relative;z-index:1;box-shadow:0 0 50px rgba(255,107,53,.12),0 0 100px rgba(255,107,53,.04),inset 0 0 30px rgba(255,107,53,.08),inset 0 1px 0 rgba(255,255,255,.12);transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.4rem}
.be:active{transform:scale(.92)}
.be .be-icon{font-size:2.4rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3));display:flex;align-items:center;justify-content:center}
.be .be-text{font-size:.78rem;font-weight:800;letter-spacing:.25em}
.be::before{content:'';position:absolute;inset:-4px;border-radius:50%;background:conic-gradient(from 0deg,var(--ac),var(--pk),#9333ea,var(--ac));z-index:-1;animation:rs 4s linear infinite;opacity:.3;filter:blur(4px)}
.be.service-mode{background:radial-gradient(circle at 35% 35%,#444,#222 50%,#111)!important;box-shadow:0 0 50px rgba(0,0,0,.5),0 0 100px rgba(0,0,0,.08),inset 0 1px 0 rgba(255,255,255,.1)!important}
.be.service-mode::before{background:conic-gradient(from 0deg,#555,#333,#555)!important;opacity:.3}
.service-toggle{display:flex;align-items:center;gap:.35rem;padding:.35rem .75rem;border-radius:2rem;font-size:.65rem;font-weight:600;color:var(--t3);background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);cursor:pointer;margin-bottom:.5rem;transition:all .25s;letter-spacing:.02em}
.service-toggle.active{background:rgba(99,102,241,.15);color:#a5b4fc;border:1px solid rgba(99,102,241,.3)}
.be::after{content:'';position:absolute;inset:-30px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.08),transparent 70%);z-index:-2;animation:bb 3s ease-in-out infinite}
/* Energized state */
.be.energized{animation:sonic-energy .6s ease-in-out infinite alternate;box-shadow:0 0 60px rgba(255,107,53,.2),0 0 120px rgba(255,107,53,.1),0 0 200px rgba(255,61,113,.04);background:rgba(255,107,53,.25);border-color:rgba(255,107,53,.5)}
.be.energized::before{animation:rs 1.5s linear infinite;opacity:.8;filter:blur(3px);inset:-8px}
.be.energized::after{animation:sonic-waves 1s ease-out infinite}
.be.energized .be-text{animation:sonic-text .8s ease infinite alternate}
@keyframes bb{0%,100%{opacity:.3}50%{opacity:.6}}
@keyframes rs{to{transform:rotate(360deg)}}
@keyframes sonic-energy{0%{transform:scale(1);box-shadow:0 0 60px var(--gw2),0 0 120px rgba(255,107,53,.15)}100%{transform:scale(1.04);box-shadow:0 0 80px var(--gw2),0 0 150px rgba(255,107,53,.2),0 0 250px rgba(255,61,113,.08)}}
@keyframes sonic-waves{0%{inset:-30px;opacity:.5}100%{inset:-80px;opacity:0}}
@keyframes sonic-text{0%{opacity:1}100%{opacity:.6}}
@keyframes touch-shake{0%{transform:scale(1) rotate(0deg)}10%{transform:scale(1.08) rotate(-4deg)}20%{transform:scale(1.1) rotate(3deg)}30%{transform:scale(1.06) rotate(-3deg)}40%{transform:scale(1.08) rotate(2.5deg)}50%{transform:scale(1.04) rotate(-2deg)}60%{transform:scale(1.06) rotate(1.5deg)}70%{transform:scale(1.03) rotate(-1deg)}80%{transform:scale(1.01) rotate(.5deg)}90%{transform:scale(1) rotate(-.3deg)}100%{transform:scale(1) rotate(0deg)}}
.be.shake-activate{animation:touch-shake .7s ease-out!important}
/* Sound wave bars on sides */
.sonic-bars{position:absolute;top:50%;display:flex;flex-direction:column;gap:3px;transform:translateY(-50%);z-index:0;opacity:0;transition:opacity .3s}
.sonic-bars.active{opacity:1}
.sonic-bars.left{left:-50px}
.sonic-bars.right{right:-50px}
.sonic-bar{height:2px;background:var(--ac);border-radius:2px;opacity:.4}
.sonic-bars.left .sonic-bar{animation:sbar-left .8s ease-in-out infinite alternate}
.sonic-bars.right .sonic-bar{animation:sbar-right .8s ease-in-out infinite alternate}
.sonic-bar:nth-child(1){width:12px;animation-delay:0s}
.sonic-bar:nth-child(2){width:20px;animation-delay:.1s}
.sonic-bar:nth-child(3){width:28px;animation-delay:.2s}
.sonic-bar:nth-child(4){width:20px;animation-delay:.3s}
.sonic-bar:nth-child(5){width:12px;animation-delay:.4s}
@keyframes sbar-left{0%{opacity:.2;transform:translateX(0)}100%{opacity:.7;transform:translateX(-6px)}}
@keyframes sbar-right{0%{opacity:.2;transform:translateX(0)}100%{opacity:.7;transform:translateX(6px)}}
.sonic-status{font-size:.72rem;color:var(--ac2);min-height:1.2em;transition:all .3s;opacity:0}
.sonic-status.active{opacity:1}
.sonic-fallback{opacity:0;transition:opacity .3s;pointer-events:none}
.sonic-fallback.active{opacity:1;pointer-events:auto}
/* FIRE — energy rising from speaker (bottom of phone) */
.fire-overlay{position:absolute;bottom:8%;left:0;right:0;height:45%;pointer-events:none;z-index:0;opacity:0;transition:opacity .6s}
.fire-overlay.active{opacity:1}
/* Main upward glow — concentrated in center bottom like speaker beam */
.fire-glow{position:absolute;bottom:-15%;left:50%;transform:translateX(-50%);width:80%;height:55%;background:radial-gradient(ellipse at 50% 100%,rgba(255,107,53,.4) 0%,rgba(255,61,113,.18) 25%,rgba(255,107,53,.06) 50%,transparent 70%);animation:fire-breathe 1s ease-in-out infinite alternate;filter:blur(6px)}
.fire-glow2{position:absolute;bottom:-5%;left:50%;transform:translateX(-50%);width:50%;height:40%;background:radial-gradient(ellipse at 50% 100%,rgba(255,180,80,.3) 0%,rgba(255,107,53,.1) 40%,transparent 65%);animation:fire-breathe .7s ease-in-out infinite alternate-reverse;filter:blur(10px)}
/* Speaker icon glow at very bottom */
.fire-speaker{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:3px;opacity:0;animation:fire-spk-in .8s ease .3s forwards}
.fire-spk-wave{width:12px;height:12px;border:1.5px solid var(--ac);border-radius:50%;opacity:.5;animation:fire-spk-pulse 1.2s ease infinite}
.fire-spk-wave:nth-child(2){width:20px;height:20px;animation-delay:.2s;opacity:.3}
.fire-spk-wave:nth-child(3){width:28px;height:28px;animation-delay:.4s;opacity:.15}
@keyframes fire-spk-in{to{opacity:1}}
@keyframes fire-spk-pulse{0%,100%{opacity:.2;transform:scale(.9)}50%{opacity:.7;transform:scale(1.1)}}
/* Particles — concentrated from center bottom, shooting up like speaker energy */
.fire-particles{position:absolute;bottom:0;left:0;right:0;height:100%;overflow:hidden}
.fire-p{position:absolute;bottom:-8px;border-radius:50%;filter:blur(1.5px);animation:fire-rise linear infinite}
/* Concentrated near center (35-65% of width) — speaker zone */
.fire-p:nth-child(1){left:38%;width:5px;height:5px;background:#ff6b35;animation-duration:1.4s;animation-delay:0s}
.fire-p:nth-child(2){left:42%;width:3px;height:3px;background:#ffc060;animation-duration:1.7s;animation-delay:.2s}
.fire-p:nth-child(3){left:48%;width:7px;height:7px;background:#ff6b35;animation-duration:1.2s;animation-delay:.1s}
.fire-p:nth-child(4){left:52%;width:4px;height:4px;background:#ff3d71;animation-duration:1.6s;animation-delay:.35s}
.fire-p:nth-child(5){left:56%;width:5px;height:5px;background:#ffa060;animation-duration:1.3s;animation-delay:.15s}
.fire-p:nth-child(6){left:44%;width:3px;height:3px;background:#ff8f65;animation-duration:1.8s;animation-delay:.5s}
.fire-p:nth-child(7){left:50%;width:8px;height:8px;background:#ff6b35;animation-duration:1.1s;animation-delay:.25s}
.fire-p:nth-child(8){left:46%;width:4px;height:4px;background:#ffc060;animation-duration:1.5s;animation-delay:.4s}
/* Some scattered wider for spread effect */
.fire-p:nth-child(9){left:30%;width:3px;height:3px;background:#ff8f65;animation-duration:2s;animation-delay:.6s}
.fire-p:nth-child(10){left:65%;width:4px;height:4px;background:#ff6b35;animation-duration:1.9s;animation-delay:.3s}
.fire-p:nth-child(11){left:35%;width:5px;height:5px;background:#ff3d71;animation-duration:1.7s;animation-delay:.7s}
.fire-p:nth-child(12){left:60%;width:3px;height:3px;background:#ffa060;animation-duration:1.6s;animation-delay:.45s}
@keyframes fire-rise{0%{transform:translateY(0) scale(1);opacity:.9}30%{opacity:1}100%{transform:translateY(-50vh) scale(0);opacity:0}}
@keyframes fire-breathe{0%{opacity:.6;transform:translateX(-50%) scale(.95)}100%{opacity:1;transform:translateX(-50%) scale(1.05)}}
/* Edge heat lines — bottom edges glow */
.fire-edge{position:absolute;bottom:0;height:3px;background:linear-gradient(90deg,transparent 20%,var(--ac),#fff,var(--ac),transparent 80%);filter:blur(1px);animation:fire-edge-pulse .8s ease-in-out infinite alternate}
.fire-edge.left{left:0;right:50%;border-radius:0 2px 0 0}
.fire-edge.right{left:50%;right:0;border-radius:2px 0 0 0}
@keyframes fire-edge-pulse{0%{opacity:.3;height:2px}100%{opacity:.9;height:5px}}
/* Sonic instruction — speakers touching animation */
.sonic-instruct{position:absolute;bottom:22%;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:.8rem;opacity:0;transition:opacity .5s;z-index:3}
.sonic-instruct.active{opacity:1}
/* Phones lying down, bottoms (speakers) facing each other */
.si-scene{position:relative;width:160px;height:80px;display:flex;align-items:center;justify-content:center}
.si-phone{position:absolute;width:50px;height:26px;border:1.5px solid var(--ac);border-radius:5px;background:rgba(255,107,53,.06)}
.si-phone.left{left:0;animation:si-slide-l 2s ease-in-out infinite}
.si-phone.right{right:0;animation:si-slide-r 2s ease-in-out infinite}
/* Speaker grille dots on the inner edge */
.si-phone .si-speaker{position:absolute;top:50%;transform:translateY(-50%);display:flex;gap:2px;align-items:center}
.si-phone.left .si-speaker{right:3px}
.si-phone.right .si-speaker{left:3px}
.si-spk-dot{width:2.5px;height:2.5px;border-radius:50%;background:var(--ac);opacity:.6}
/* Energy arcs between speakers */
.si-energy{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;gap:3px;align-items:center}
.si-arc{width:3px;height:10px;border-radius:2px;background:var(--ac);opacity:0;animation:si-arc-flash .6s ease infinite}
.si-arc:nth-child(1){height:6px;animation-delay:0s}
.si-arc:nth-child(2){height:12px;animation-delay:.15s}
.si-arc:nth-child(3){height:8px;animation-delay:.3s}
.si-arc:nth-child(4){height:14px;animation-delay:.1s}
.si-arc:nth-child(5){height:6px;animation-delay:.25s}
@keyframes si-arc-flash{0%{opacity:0;transform:scaleY(.5)}30%{opacity:.9;transform:scaleY(1.1)}60%{opacity:.4;transform:scaleY(.8)}100%{opacity:0;transform:scaleY(.3)}}
@keyframes si-slide-l{0%,100%{transform:translateX(0)}50%{transform:translateX(18px)}}
@keyframes si-slide-r{0%,100%{transform:translateX(0)}50%{transform:translateX(-18px)}}
/* Speaker label */
.si-label{font-size:.5rem;color:var(--t3);letter-spacing:.08em;text-transform:uppercase;opacity:.6}
.si-text{font-size:.72rem;color:var(--ac2);text-align:center;max-width:200px;line-height:1.5;font-weight:600;letter-spacing:.02em}
.si-text em{color:#fff;font-style:normal;font-weight:700}
/* Pulsing glow from speaker zone */
.si-glow{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:20px;height:20px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.4),transparent 70%);animation:si-glow-pulse 1s ease-in-out infinite;filter:blur(4px)}
@keyframes si-glow-pulse{0%,100%{opacity:.3;transform:translate(-50%,-50%) scale(.8)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.5)}}
/* Screenshot block in chat */
#chat .cms{-webkit-user-select:none;user-select:none}
/* Bottom section — anchored tab bar */
.home-bottom{display:flex;flex-direction:column;align-items:center;width:100%;position:relative;z-index:5;flex-shrink:0;padding:0 1.2rem;padding-bottom:max(env(safe-area-inset-bottom),.6rem)}
.home-nav{display:flex;justify-content:space-around;width:100%;padding:.5rem 0;border-top:1px solid rgba(255,255,255,.04);background:linear-gradient(180deg,transparent,rgba(5,5,8,.3))}
.hn-btn{display:flex;flex-direction:column;align-items:center;gap:.2rem;background:none;border:none;color:var(--t3);font-family:inherit;cursor:pointer;padding:.5rem .5rem;border-radius:12px;transition:all .2s cubic-bezier(.22,1,.36,1);-webkit-tap-highlight-color:transparent;min-width:56px;flex:1;max-width:80px;position:relative}
.hn-btn:active{background:rgba(255,255,255,.06);color:var(--t1);transform:scale(.92)}
.hn-ico{font-size:1.15rem;line-height:1;transition:transform .2s}
.hn-btn:active .hn-ico{transform:scale(1.15)}
.hn-lbl{font-size:.52rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:inherit;white-space:nowrap;opacity:.7}
.home-brand-row{display:flex;align-items:center;justify-content:center;gap:.6rem;padding:.2rem 0 .1rem}
.home-brand{font-size:.5rem;font-weight:800;letter-spacing:.35em;color:var(--ac);opacity:.3}
.rb{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;position:relative}
.rb:active{transform:scale(.93)}
.rb .ct{position:absolute;top:-3px;right:-3px;min-width:16px;height:16px;border-radius:50%;background:var(--ac);font-size:.55rem;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
.cd{width:7px;height:7px;border-radius:50%;background:var(--ok);box-shadow:0 0 8px rgba(52,211,153,.6);transition:all .3s ease}
.cd.offline{background:var(--err);box-shadow:0 0 8px rgba(248,113,113,.6)}
.cd.reconnecting{background:var(--warn);box-shadow:0 0 8px rgba(251,191,36,.5);animation:bk 1s infinite}
@keyframes bk{0%,100%{opacity:1}50%{opacity:.3}}
.constellation-btn{width:42px;height:42px;border-radius:50%;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;position:relative;color:#fff;box-shadow:0 0 8px rgba(255,255,255,.12),0 0 16px rgba(255,255,255,.06);animation:constGlow 3s ease-in-out infinite;z-index:10}
.constellation-btn:active{transform:scale(.93)}
@keyframes constGlow{0%,100%{box-shadow:0 0 8px rgba(255,255,255,.12),0 0 16px rgba(255,255,255,.06);border-color:rgba(255,255,255,.25)}50%{box-shadow:0 0 12px rgba(255,255,255,.2),0 0 24px rgba(255,255,255,.1);border-color:rgba(255,255,255,.4)}}

/* ENCOUNTER */
#encounter{padding:2rem 1.5rem;justify-content:center;align-items:center;text-align:center}
.ep{display:none;flex-direction:column;align-items:center;gap:1.5rem;width:100%}.ep.active{display:flex}
.et{font-size:.85rem;color:var(--t2);margin-bottom:.5rem}
.cdsp{font-size:2.8rem;font-weight:800;letter-spacing:.25em;color:var(--ac);font-family:'Courier New',monospace;text-shadow:0 0 20px var(--gw)}
.qb{background:#fff;padding:14px;border-radius:16px;display:inline-block;box-shadow:0 8px 30px rgba(0,0,0,.3)}
.qb canvas{display:block}
.cir{display:flex;gap:.5rem;width:100%;max-width:280px}
.cir input{flex:1;padding:.85rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;color:var(--t1);font-size:1.1rem;font-family:'Courier New',monospace;text-align:center;letter-spacing:.15em;outline:none;text-transform:uppercase}
.cir input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.cir button{padding:0 1.2rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:14px;color:#fff;font-size:1.3rem;cursor:pointer}
.od{display:flex;align-items:center;gap:1rem;color:var(--t3);font-size:.8rem;width:100%;max-width:280px}
.od::before,.od::after{content:'';flex:1;height:1px;background:var(--b1)}
.wd{color:var(--ac);font-size:1.5rem;display:flex;gap:6px;justify-content:center}
.wd span{animation:df 1.4s ease-in-out infinite;opacity:.3}
.wd span:nth-child(2){animation-delay:.2s}.wd span:nth-child(3){animation-delay:.4s}
@keyframes df{0%,100%{opacity:.3}50%{opacity:1}}

/* SONIC ENCOUNTER MODE (kept as phaseBump for compat) */
.bump-circle{width:160px;height:160px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#ff8f65,#ff6b35 50%,#e05520);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:.3rem;position:relative;box-shadow:0 0 60px var(--gw);transition:all .3s}
.bump-circle.listening{animation:sonic-energy .6s ease-in-out infinite alternate}
.bump-circle.bumped{background:radial-gradient(circle at 35% 35%,#34d399,#10b981 50%,#059669);box-shadow:0 0 80px rgba(52,211,153,.4);animation:bump-hit .5s ease}

/* REVEAL — next-gen minimal */
#reveal{justify-content:center;align-items:center;text-align:center;padding:0;overflow:hidden;background:#050508}
.rv-light-beam{position:absolute;inset:0;z-index:0;pointer-events:none}
.rv-wrap{position:relative;z-index:3;display:flex;flex-direction:column;align-items:center;width:100%;height:100%;justify-content:center}
.rv-center{display:flex;flex-direction:column;align-items:center;gap:1.2rem;flex:1;justify-content:center;padding:0 1.5rem}
/* Birth star — bright white star that births the two avatars */
.rv-birth-star{position:absolute;top:15%;left:50%;transform:translate(-50%,-50%) scale(0);width:8px;height:8px;border-radius:50%;background:#fff;z-index:10;pointer-events:none;opacity:0;animation:rv-star-birth 2.8s cubic-bezier(.22,1,.36,1) 2.2s forwards;box-shadow:0 0 20px #fff,0 0 60px rgba(255,255,255,.6),0 0 120px rgba(200,220,255,.3)}
@keyframes rv-star-birth{0%{opacity:0;transform:translate(-50%,-50%) scale(0)}8%{opacity:1;transform:translate(-50%,-50%) scale(3.5);box-shadow:0 0 30px #fff,0 0 80px rgba(255,255,255,.8),0 0 160px rgba(200,220,255,.4)}25%{opacity:1;transform:translate(-50%,-50%) scale(1.5)}50%{opacity:.5;transform:translate(-50%,-50%) scale(.6)}100%{opacity:0;transform:translate(-50%,-50%) scale(0)}}
/* Birth orbs — hidden, no longer used separately */
.rv-birth-orb{display:none}
/* Avatars row — starts at top, animated down by JS */
.rv-avatars{display:flex;align-items:center;justify-content:center;gap:1.2rem;position:relative;opacity:0}
.rv-avatars.birth-anim{animation:none;opacity:1;transform:translateY(-55vh) scale(.3);transition:transform 1.6s cubic-bezier(.22,1,.36,1),opacity .4s ease}
.rv-avatars.birth-landed{transform:translateY(0) scale(1);opacity:1}
.rv-avatar-wrap{position:relative;display:flex;flex-direction:column;align-items:center;gap:.35rem}
.rv-avatar-img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:1.5px solid rgba(255,255,255,.1);box-shadow:0 0 20px rgba(255,107,53,.15)}
.rv-avatar-name{font-size:.65rem;color:rgba(255,255,255,.45);font-weight:400;letter-spacing:.04em;opacity:0;animation:rv-fi .6s ease 4.4s forwards}
.rv-avatar-inner{position:relative;width:56px;height:56px}
.rv-avatar-stars{position:absolute;inset:0;pointer-events:none;opacity:0;animation:rv-fi .6s ease 4.6s forwards}
.rv-star-dot{position:absolute;width:4px;height:4px;border-radius:50%;background:rgba(255,215,0,.8);box-shadow:0 0 6px rgba(255,215,0,.5);animation:rv-star-twinkle 2s ease-in-out infinite alternate}
@keyframes rv-star-twinkle{0%{opacity:.5;transform:translate(-50%,-50%) scale(.8)}100%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}}
.rv-star-count{position:absolute;top:-16px;left:50%;transform:translateX(-50%);font-size:.5rem;color:rgba(255,215,0,.8);white-space:nowrap;opacity:0;animation:rv-fi .6s ease 4.8s forwards;font-weight:700}
.rv-plus-badge{position:absolute;bottom:-1px;right:-1px;width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;z-index:4;box-shadow:0 0 8px rgba(59,130,246,.6);font-size:.55rem;color:#fff;font-weight:800;opacity:0;animation:rv-fi .6s ease 4s forwards}
.rv-connection-symbol{display:flex;align-items:center;padding:0 .2rem}
.rv-connection-dot{width:4px;height:4px;border-radius:50%;background:rgba(255,107,53,.5);box-shadow:0 0 8px rgba(255,107,53,.3)}
/* Moment label */
.rv-moment{font-size:.6rem;color:rgba(255,255,255,.25);letter-spacing:.25em;text-transform:uppercase;opacity:0;animation:rv-fi 1.2s ease .3s forwards;font-weight:400}
.rv-service-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.35rem .8rem;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.25);border-radius:16px;font-size:.75rem;color:#34d399;font-weight:500;margin-top:.5rem;opacity:0;animation:rv-fi .8s ease .6s forwards;letter-spacing:.02em}
/* Phrase — THE focus */
.rv-phrase{max-width:300px;min-height:50px;display:flex;flex-wrap:wrap;justify-content:center;gap:.25rem;line-height:2}
.rv-word{display:inline-block;font-size:1.5rem;font-weight:200;color:#fff;opacity:0;transform:translateY(8px);animation:rv-word .7s cubic-bezier(.22,1,.36,1) forwards;letter-spacing:-.01em}
@keyframes rv-word{to{opacity:1;transform:none}}
/* Sub */
.rv-sub{font-size:.58rem;color:rgba(255,255,255,.18);opacity:0;animation:rv-fi .8s ease 5.5s forwards;font-weight:300;letter-spacing:.06em}
.rv-line{display:none}
/* Renewed + last */
.rv-renewed{font-size:.62rem;color:rgba(255,107,53,.5);opacity:0;animation:rv-fi .6s ease 4.8s forwards;letter-spacing:.1em}
.rv-last{font-size:.55rem;color:rgba(255,255,255,.2);margin-top:.1rem;padding:.2rem .6rem;background:rgba(255,255,255,.02);border-radius:6px;border:1px solid rgba(255,255,255,.04);opacity:0;animation:rv-fi .6s ease 5s forwards}
@keyframes rv-fi{to{opacity:1}}
@keyframes rv-up{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
/* Bottom actions — icon buttons like card profile */
.rv-actions{position:absolute;bottom:0;left:0;right:0;display:flex;flex-direction:column;gap:.4rem;align-items:center;padding:.5rem 1rem calc(env(safe-area-inset-bottom,.5rem) + .6rem);opacity:0;animation:rv-fi .6s ease 6s forwards;z-index:5}
.rv-btn-row{display:flex;gap:.15rem;justify-content:center}
.rv-sec-row{display:flex;gap:.5rem;justify-content:center}
.rv-icon-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:.3rem .5rem;border-radius:10px;border:none;background:none;color:rgba(255,255,255,.5);font-size:.52rem;font-weight:500;font-family:inherit;cursor:pointer;transition:all .15s;min-width:52px}
.rv-icon-btn:active{transform:scale(.93);background:rgba(255,255,255,.06)}
.rv-icon-btn .rv-ic{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);transition:all .15s}
.rv-icon-btn .rv-ic svg{width:18px;height:18px}
.rv-icon-btn.primary .rv-ic{background:rgba(99,102,241,.15);border-color:rgba(99,102,241,.25)}
.rv-icon-btn.primary{color:#a5b4fc}
.rv-icon-btn.tip .rv-ic{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.2)}
.rv-icon-btn.tip{color:#4ade80}
/* ═══ SELFIE MODAL ═══ */
.selfie-modal-bg{position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.85);backdrop-filter:blur(12px);display:none;align-items:center;justify-content:center;animation:sfmIn .3s ease}
@keyframes sfmIn{from{opacity:0}to{opacity:1}}
.selfie-modal{position:relative;width:92%;max-width:380px;border-radius:24px;overflow:hidden;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#1a1a2e 100%)}
.selfie-border{position:absolute;inset:0;border-radius:24px;border:3px solid transparent;background:linear-gradient(135deg,#ff6b35,#f72585,#7209b7,#4361ee,#06d6a0,#ffd166,#ff6b35) border-box;-webkit-mask:linear-gradient(#fff 0 0) padding-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none;animation:sfBorderRotate 4s linear infinite}
@keyframes sfBorderRotate{0%{filter:hue-rotate(0deg)}100%{filter:hue-rotate(360deg)}}
.selfie-header{padding:1.2rem 1rem .6rem;text-align:center}
.selfie-header h3{font-size:1.1rem;font-weight:700;color:#fff;margin:0 0 .3rem}
.selfie-phrase{font-size:.72rem;color:rgba(255,255,255,.6);font-style:italic;line-height:1.4}
.selfie-camera-area{position:relative;width:220px;height:220px;margin:0 auto;border-radius:50%;overflow:hidden;border:3px solid rgba(255,107,53,.4);box-shadow:0 0 30px rgba(255,107,53,.15),inset 0 0 20px rgba(0,0,0,.3)}
.selfie-camera-area video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
.selfie-camera-area .sf-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1a1a2e,#2a2a4e);color:rgba(255,255,255,.3);font-size:3rem}
.selfie-camera-area .sf-captured{width:100%;height:100%;object-fit:cover;border-radius:50%}
.selfie-emojis{display:flex;justify-content:center;gap:.8rem;padding:.8rem 0;font-size:1.5rem;animation:sfEmojiBounce 2s ease infinite}
@keyframes sfEmojiBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.selfie-actions{display:flex;gap:.6rem;justify-content:center;padding:.6rem 1rem 1.2rem}
.sf-btn{padding:.6rem 1.4rem;border-radius:20px;border:none;font-size:.75rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s}
.sf-btn-capture{background:linear-gradient(135deg,#ff6b35,#f72585);color:#fff;box-shadow:0 4px 15px rgba(255,107,53,.3)}
.sf-btn-capture:active{transform:scale(.95)}
.sf-btn-close{background:rgba(255,255,255,.08);color:rgba(255,255,255,.6);border:1px solid rgba(255,255,255,.1)}
.sf-btn-save{background:linear-gradient(135deg,#06d6a0,#34d399);color:#fff;box-shadow:0 4px 15px rgba(6,214,160,.3)}
.sf-confetti{position:absolute;pointer-events:none;font-size:1.2rem;animation:sfConfettiFall 1.5s ease forwards;opacity:0}
@keyframes sfConfettiFall{0%{opacity:1;transform:translateY(0) rotate(0deg) scale(1)}100%{opacity:0;transform:translateY(80px) rotate(360deg) scale(.5)}}
.rv-icon-btn.skip{color:rgba(255,255,255,.45)}
.rv-icon-btn.skip .rv-ic{background:rgba(255,255,255,.03);border-color:rgba(255,255,255,.08)}
.rv-icon-btn.success .rv-ic{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.3)}
.rv-icon-btn.success{color:#86efac}
/* Legacy classes for service/checkin modes */
.rv-btn-enter{flex:1;padding:.65rem 0;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:28px;color:#fff;font-size:.72rem;font-weight:500;font-family:inherit;cursor:pointer;letter-spacing:.06em;transition:all .15s;backdrop-filter:blur(8px)}
.rv-btn-enter:active{transform:scale(.96);background:rgba(255,255,255,.12)}
.rv-btn-skip{flex:1;padding:.65rem 0;background:transparent;border:1px solid rgba(255,255,255,.06);border-radius:28px;color:rgba(255,255,255,.35);font-size:.72rem;font-weight:400;font-family:inherit;cursor:pointer;letter-spacing:.06em;transition:all .15s}
.rv-btn-skip:active{transform:scale(.96);color:rgba(255,255,255,.6)}
.rv-btn-mini{display:flex;align-items:center;gap:.3rem;padding:.3rem .7rem;background:transparent;border:1px solid rgba(255,255,255,.05);border-radius:16px;color:rgba(255,255,255,.25);font-size:.55rem;font-family:inherit;cursor:pointer;transition:all .15s;letter-spacing:.02em}
.rv-btn-mini:active{background:rgba(255,255,255,.06);color:rgba(255,255,255,.5)}
.rv-btn-mini .rv-ico{font-size:.7rem;line-height:1;opacity:.5}

/* CHAT */
#chat{flex-direction:column;background:var(--bg)}
.ch{display:flex;align-items:center;justify-content:space-between;padding:.5rem .8rem;background:rgba(18,18,24,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-bottom:1px solid rgba(255,255,255,.05);padding-top:max(env(safe-area-inset-top),.5rem);flex-shrink:0;z-index:2;box-shadow:0 1px 12px rgba(0,0,0,.15)}
.chl{display:flex;align-items:center;gap:.5rem;flex:1;min-width:0}
.ch-info{cursor:pointer;display:flex;flex-direction:column;min-width:0;gap:.05rem}
.ch-info:active{opacity:.7}
.chb{width:32px;height:32px;border-radius:50%;background:transparent;border:none;color:var(--t1);font-size:1.05rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.15s;flex-shrink:0}
.chb:active{transform:scale(.9);opacity:.7}
.chn{font-size:.88rem;font-weight:600;letter-spacing:-.01em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ch-sub{font-size:.6rem;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cht{font-size:.72rem;font-weight:700;font-family:'Courier New',monospace;padding:.3rem .7rem;border-radius:20px;background:rgba(255,107,53,.08);color:var(--ac);letter-spacing:.04em;transition:all .3s;flex-shrink:0;border:1px solid rgba(255,107,53,.12)}
.cht.urg{background:rgba(248,113,113,.12);color:var(--err);border-color:rgba(248,113,113,.2);animation:urg-pulse 1.5s ease infinite}
@keyframes urg-pulse{0%,100%{opacity:1}50%{opacity:.6}}
/* ID action pills */
.chat-id-bar{display:flex;gap:.4rem;padding:.3rem .8rem;justify-content:center}
.id-bar-btn{padding:.35rem .7rem;border-radius:20px;font-size:.65rem;font-weight:600;font-family:inherit;cursor:pointer;border:1px solid rgba(255,255,255,.1);transition:all .2s;background:rgba(255,255,255,.06);color:var(--t2)}
.id-bar-btn.reveal{background:rgba(0,220,130,.1);color:#00dc82;border-color:rgba(0,220,130,.2)}
.id-bar-btn.request{background:rgba(163,113,247,.1);color:#a371f7;border-color:rgba(163,113,247,.2)}
.id-bar-btn.done{background:rgba(255,255,255,.04);color:var(--t3);border-color:transparent;cursor:default}
.id-pill{padding:.4rem .8rem;border-radius:20px;font-size:.7rem;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .2s;display:inline-flex;align-items:center;gap:.3rem}
.id-pill.request{background:rgba(163,113,247,.1);color:#a371f7;border:1px solid rgba(163,113,247,.2)}
.id-pill.reveal{background:rgba(255,107,53,.1);color:var(--ac);border:1px solid rgba(255,107,53,.2)}
.id-pill:active{transform:scale(.93)}
.cpb{padding:.55rem 1rem;text-align:center;font-size:.75rem;color:var(--ac2);font-style:italic;background:linear-gradient(180deg,rgba(255,107,53,.06) 0%,transparent 100%);flex-shrink:0;letter-spacing:.01em}
.cms{flex:1;overflow-y:auto;padding:.6rem .8rem;display:flex;flex-direction:column;gap:.35rem;min-height:0;scroll-behavior:smooth}
.msg{max-width:78%;padding:.6rem .9rem;border-radius:18px;font-size:.86rem;line-height:1.45;word-break:break-word;animation:mi .3s cubic-bezier(.22,1,.36,1);position:relative}
.msg.mine{align-self:flex-end;background:linear-gradient(135deg,var(--ac),#e85d2a);color:#fff;border-bottom-right-radius:4px;box-shadow:0 2px 8px rgba(255,107,53,.2)}
.msg.theirs{align-self:flex-start;background:var(--s2);color:var(--t1);border-bottom-left-radius:4px;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.msg.ephemeral{border:1px dashed rgba(255,107,53,.35);background:rgba(255,107,53,.06);color:var(--t1);text-align:center;align-self:center;max-width:85%;font-style:italic;padding:.5rem 1rem;font-size:.8rem}
.msg.ephemeral.mine{background:rgba(255,107,53,.12);border-color:rgba(255,107,53,.4)}
.msg.ephemeral .eph-badge{display:inline-block;font-size:.55rem;text-transform:uppercase;letter-spacing:.1em;opacity:.5;margin-left:.4rem;font-style:normal}
.msg.photo{padding:.25rem}
.msg.photo img{border-radius:14px;max-width:220px;max-height:220px;display:block;object-fit:cover}
.mt{font-size:.55rem;opacity:.4;margin-top:.15rem}
@keyframes mi{from{opacity:0;transform:translateY(6px) scale(.97)}to{opacity:1;transform:none}}
.ti{display:flex;align-items:center;gap:3px;padding:.4rem .8rem;align-self:flex-start;opacity:0;height:0;overflow:hidden;transition:opacity .2s,height .2s}
.ti.vis{opacity:1;height:auto;overflow:visible}
.ti .dot{width:5px;height:5px;border-radius:50%;background:var(--t2);animation:tb 1.4s ease-in-out infinite}
.ti .dot:nth-child(2){animation-delay:.15s}.ti .dot:nth-child(3){animation-delay:.3s}
@keyframes tb{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}
/* System messages */
.msg-system{text-align:center;font-size:.7rem;color:var(--t3);padding:.5rem 1rem;font-style:italic}
/* Quick phrases bar */
.qp-bar{display:flex;gap:.35rem;padding:.4rem .8rem;overflow-x:auto;-webkit-overflow-scrolling:touch;flex-shrink:0;background:transparent;scrollbar-width:none}
.qp-bar::-webkit-scrollbar{display:none}
.qp-chip{padding:.4rem .8rem;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:18px;color:var(--t2);font-size:.72rem;cursor:pointer;flex-shrink:0;font-family:inherit;transition:all .2s cubic-bezier(.22,1,.36,1);white-space:nowrap}
.qp-chip:active{background:var(--ac);color:#fff;border-color:var(--ac);transform:scale(.93)}
.qp-chip.sent{opacity:.25;pointer-events:none;transform:scale(.95)}
/* Chat input area - modern */
.chat-bottom{background:rgba(18,18,24,.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-top:1px solid rgba(255,255,255,.05);flex-shrink:0;padding-bottom:max(env(safe-area-inset-bottom),.5rem)}
.cia{display:flex;align-items:flex-end;gap:.4rem;padding:.35rem .8rem .35rem}
.cia-wrap{flex:1;display:flex;align-items:flex-end;background:var(--s2);border:1px solid rgba(255,255,255,.08);border-radius:22px;transition:border-color .2s;overflow:hidden}
.cia-wrap:focus-within{border-color:var(--ac)}
.cia-plus{width:34px;height:34px;border:none;background:transparent;color:var(--t3);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.15s;padding:0 0 0 .3rem}
.cia-plus:active{color:var(--ac);transform:scale(.9)}
.cia input{flex:1;padding:.6rem .7rem .6rem .2rem;background:transparent;border:none;color:var(--t1);font-size:.86rem;font-family:inherit;outline:none;min-height:20px}
.sb{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--ac),#e85d2a);border:none;color:#fff;font-size:.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s cubic-bezier(.22,1,.36,1);opacity:0;transform:scale(.3);pointer-events:none;flex-shrink:0;box-shadow:0 2px 10px rgba(255,107,53,.3)}
.sb.active{opacity:1;transform:scale(1);pointer-events:auto}
.sb:active{transform:scale(.85)}
/* Plus menu overlay */
.plus-menu{position:absolute;bottom:100%;left:.5rem;right:.5rem;background:rgba(24,24,32,.97);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:.5rem;display:grid;grid-template-columns:repeat(4,1fr);gap:.3rem;transform:translateY(8px);opacity:0;pointer-events:none;transition:all .2s ease;z-index:10;margin-bottom:.4rem}
.plus-menu.open{transform:translateY(0);opacity:1;pointer-events:auto}
.pm-item{display:flex;flex-direction:column;align-items:center;gap:.3rem;padding:.6rem .3rem;border-radius:12px;cursor:pointer;transition:.15s;border:none;background:transparent;font-family:inherit;color:var(--t1)}
.pm-item:active{background:rgba(255,255,255,.06);transform:scale(.95)}
.pm-ico{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.15rem}
.pm-label{font-size:.62rem;color:var(--t2);text-align:center;letter-spacing:.02em}
.selfie-btn{display:none}

/* RELATIONS */
#relations{flex-direction:column;background:var(--bg)}
.rlh{display:flex;align-items:center;gap:.8rem;padding:1rem 1.2rem;background:linear-gradient(180deg,var(--s1) 0%,var(--bg) 100%);border-bottom:1px solid rgba(255,255,255,.04);padding-top:max(env(safe-area-inset-top),1rem)}
.rlh h2{font-size:1.15rem;font-weight:700;letter-spacing:-.01em}
.rlh-sub{font-size:.7rem;color:var(--t3);font-weight:400;margin-left:auto}
.rll{flex:1;overflow-y:auto;padding:.6rem .8rem;padding-bottom:5rem}

.rc{display:flex;align-items:center;gap:.9rem;padding:1rem;margin-bottom:.6rem;background:linear-gradient(135deg,var(--s1),rgba(26,26,36,.8));border:1px solid rgba(255,255,255,.06);border-radius:18px;cursor:pointer;transition:all .2s cubic-bezier(.22,1,.36,1);position:relative;overflow:hidden}
.rc::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,var(--ac),var(--pk));border-radius:3px 0 0 3px;opacity:.4;transition:opacity .2s}
.rc:active{background:var(--s2);transform:scale(.975);border-color:rgba(255,107,53,.25)}.rc:active::before{opacity:1}
.rav{display:flex;align-items:center;justify-content:center;flex-shrink:0}
.ri{flex:1;min-width:0}
.rn{font-size:1.05rem;font-weight:600;letter-spacing:-.01em;color:var(--t1)}
.rp{font-size:.8rem;color:var(--t2);margin-top:.25rem;font-style:italic;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.rp-preview{font-size:.75rem;color:var(--t3);margin-top:.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rc-unread{width:10px;height:10px;border-radius:50%;background:var(--ac);flex-shrink:0;margin-bottom:.3rem;box-shadow:0 0 8px rgba(255,107,53,.5)}
.rtm-wrap{display:flex;flex-direction:column;align-items:flex-end;gap:.2rem;flex-shrink:0}
.rtm{font-size:.75rem;font-family:'Courier New',monospace;font-weight:700;flex-shrink:0;padding:.25rem .6rem;border-radius:10px;background:rgba(52,211,153,.08)}
.rtm.ok{color:var(--ok);background:rgba(52,211,153,.08)}.rtm.med{color:var(--warn);background:rgba(251,191,36,.08)}.rtm.low{color:var(--err);background:rgba(248,113,113,.08);animation:urg-pulse 1.5s ease infinite}
.rtm-label{font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em}
.nr{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--t2);text-align:center;padding:2.5rem;font-size:1rem;line-height:1.8}
.nr-icon{font-size:2.5rem;margin-bottom:1rem;opacity:.25;filter:grayscale(.5)}
.nr-text{font-size:.82rem;color:var(--t3);max-width:240px;line-height:1.6;font-weight:300}

/* STREAK */
.streak-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:10px;font-size:.7rem;color:#fbbf24;font-weight:600}
.streak-badge .streak-fire{font-size:.75rem}
.streak-info{padding:.5rem .8rem;background:linear-gradient(135deg,rgba(251,191,36,.06),rgba(255,107,53,.04));border:1px solid rgba(251,191,36,.1);border-radius:12px;margin:.3rem .8rem;font-size:.72rem;color:var(--t2);display:flex;align-items:center;justify-content:space-between;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.streak-progress{height:3px;background:rgba(255,255,255,.06);border-radius:2px;flex:1;margin:0 .6rem;overflow:hidden}
.streak-bar{height:100%;background:linear-gradient(90deg,#fbbf24,#ff6b35);border-radius:2px;transition:width .3s ease}
/* Streak unlock modal */
.streak-unlock-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;animation:fadeIn .3s ease}
.streak-unlock-card{background:linear-gradient(170deg,#161628,#0c0c18);border:1px solid rgba(251,191,36,.3);border-radius:20px;padding:2rem;text-align:center;max-width:300px;width:90%;animation:mi .4s ease}
.streak-unlock-card .su-emoji{font-size:2.5rem;margin-bottom:.8rem}
.streak-unlock-card .su-title{font-size:1.1rem;font-weight:700;color:#fbbf24;margin-bottom:.4rem}
.streak-unlock-card .su-desc{font-size:.8rem;color:var(--t2);margin-bottom:1rem;line-height:1.5}
.streak-unlock-card .su-content{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:.8rem;margin-bottom:1rem;font-size:.85rem;font-style:italic;color:var(--ac2);line-height:1.5}
/* Touch link */
.touch-link-area{padding:1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin:.8rem;text-align:center}
.touch-link-url{font-size:.65rem;color:var(--t3);word-break:break-all;margin:.5rem 0;padding:.4rem;background:var(--s2);border-radius:8px;font-family:'Courier New',monospace}
.touch-link-actions{display:flex;gap:.4rem;justify-content:center;margin-top:.5rem}
.touch-link-actions button{padding:.4rem .8rem;font-size:.7rem}

/* SCORE + STARS BADGE */
.pts-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;background:var(--gw);border:1px solid rgba(255,107,53,.15);border-radius:12px;font-size:.7rem;color:var(--ac);font-weight:600}
/* score/stars hidden — data preserved internally */
.pts-partner{display:none}

/* BOARDING PASS */
#boardingPass{justify-content:center;align-items:center;padding:1.5rem;text-align:center;background:var(--bg)}
.bp-card{width:320px;background:linear-gradient(170deg,#0c0c18,#161628,#0c0c18);border:1px solid rgba(255,255,255,.08);border-radius:24px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,.03) inset;position:relative}
.bp-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--ac),var(--pk),var(--ac))}
.bp-top{padding:1.2rem 1.5rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed var(--b1)}
.bp-logo{font-size:.7rem;font-weight:800;letter-spacing:.3em;color:var(--ac)}
.bp-type{font-size:.55rem;color:var(--t3);letter-spacing:.15em;text-transform:uppercase}
.bp-body{padding:1.5rem}
.bp-avatar{width:60px;height:60px;border-radius:50%;background:var(--s2);border:2px solid var(--ac);margin:0 auto .8rem;display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:800;color:#fff;letter-spacing:.03em;overflow:hidden}
.bp-name{font-size:1.2rem;font-weight:700;color:var(--t1);margin-bottom:.2rem}
.bp-since{font-size:.65rem;color:var(--t3);margin-bottom:1.2rem}
.bp-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.8rem;margin-bottom:1.2rem}
.bp-stat{text-align:center;flex:1}
.bp-stat-ico{font-size:1rem;margin-bottom:.15rem}
.bp-stat-num{font-size:1.3rem;font-weight:800;color:var(--ac);line-height:1}
.bp-stat-label{font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-top:.2rem}
.bp-barcode{padding:1rem 1.5rem;border-top:1px dashed var(--b1);display:flex;justify-content:center;gap:2px}
.bp-bar{width:2px;background:var(--t3);border-radius:1px}
.bp-footer{padding:.6rem;font-size:.5rem;color:var(--t3);letter-spacing:.15em;text-align:center}
.bp-actions{display:flex;gap:.8rem;margin-top:1.2rem}
.bp-dl{padding:.6rem 1.2rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:12px;color:#fff;font-size:.8rem;font-weight:600;cursor:pointer;font-family:inherit}
.bp-dl:active{transform:scale(.96)}

/* CONSTELLATION / REDE */
#history{flex-direction:column;background:var(--bg);overflow:hidden}
.const-header{display:flex;align-items:center;gap:.8rem;padding:.8rem 1.2rem;padding-top:max(env(safe-area-inset-top),.8rem);position:absolute;top:0;left:0;right:0;z-index:10;background:linear-gradient(180deg,rgba(2,2,5,.9) 0%,transparent 100%)}
.const-header h2{font-size:.82rem;font-weight:500;color:var(--t2);letter-spacing:.08em;text-transform:uppercase}
.const-search-overlay{position:absolute;top:calc(max(env(safe-area-inset-top),.8rem) + 2.8rem);left:0;right:0;z-index:12;display:flex;flex-direction:column;align-items:center;pointer-events:auto;animation:constSearchIn .2s ease}
.const-search-overlay.hidden{display:none}
@keyframes constSearchIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.const-copy{position:absolute;top:0;left:0;right:0;text-align:center;padding-top:calc(max(env(safe-area-inset-top),.8rem) + 3rem);z-index:5;pointer-events:none}
.const-copy p{font-size:.65rem;color:rgba(255,255,255,.2);font-weight:300;font-style:italic;line-height:1.7;letter-spacing:.05em}
.const-canvas-wrap{position:absolute;inset:0;z-index:1;background:radial-gradient(ellipse at 50% 45%,rgba(15,15,30,1) 0%,rgba(2,2,5,1) 70%)}
.const-canvas-wrap canvas{width:100%;height:100%;touch-action:none}
.const-loader{position:absolute;inset:0;z-index:10;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at 50% 45%,rgba(15,15,30,.97) 0%,rgba(2,2,5,.98) 70%);transition:opacity .5s ease}
.const-loader.fade-out{opacity:0;pointer-events:none}
.const-loader-inner{display:flex;flex-direction:column;align-items:center;gap:1rem}
.const-loader-svg{animation:constLoaderPulse 2s ease-in-out infinite}
.const-loader-orbit1{transform-origin:40px 40px;animation:constOrbit1 1.8s linear infinite}
.const-loader-orbit2{transform-origin:40px 40px;animation:constOrbit2 2.5s linear infinite}
.const-loader-orbit3{transform-origin:40px 40px;animation:constOrbit3 3.2s linear infinite}
.const-loader-text{color:rgba(255,255,255,.5);font-size:.75rem;font-weight:500;letter-spacing:.05em}
@keyframes constLoaderPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes constOrbit1{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes constOrbit2{from{transform:rotate(120deg)}to{transform:rotate(480deg)}}
@keyframes constOrbit3{from{transform:rotate(240deg)}to{transform:rotate(600deg)}}
/* Node detail overlay */
/* ═══ Profile modal — compact, modern, no emojis ═══ */
.const-detail{position:absolute;bottom:0;left:0;right:0;z-index:20;background:linear-gradient(180deg,rgba(12,12,18,.55) 0%,rgba(8,8,12,.75) 100%);backdrop-filter:blur(32px);-webkit-backdrop-filter:blur(32px);border-top:1px solid rgba(255,255,255,.12);border-left:1px solid rgba(255,255,255,.06);border-right:1px solid rgba(255,255,255,.06);border-radius:20px 20px 0 0;padding:0;padding-bottom:max(env(safe-area-inset-bottom),.6rem);opacity:0;transform:translateY(100%);transition:all .35s cubic-bezier(.22,1,.36,1);pointer-events:none;max-height:60vh;overflow-y:auto;overscroll-behavior:contain;box-shadow:0 -4px 30px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.08)}
.const-detail.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.cd-handle{width:36px;height:4px;background:rgba(255,255,255,.25);border-radius:2px;margin:8px auto 4px;cursor:grab;touch-action:none}
/* Hero: horizontal — avatar left, info right */
.cd-hero{display:flex;flex-direction:row;align-items:center;padding:.6rem 1rem .3rem;gap:.8rem;position:relative}
.cd-hero-info{flex:1;min-width:0;display:flex;flex-direction:column;gap:2px}
.cd-avatar-wrap{position:relative;width:76px;height:76px;flex-shrink:0}
.cd-avatar{width:76px;height:76px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:800;color:#fff;border:2.5px solid rgba(255,255,255,.1);overflow:hidden;position:relative;flex-shrink:0;box-shadow:0 0 20px rgba(99,102,241,.15),0 0 40px rgba(139,92,246,.08)}
.cd-avatar img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0}
.cd-stars-orbit{position:absolute;inset:-10px;pointer-events:none}
.cd-orbit-star{position:absolute;font-size:.7rem;color:#fbbf24;filter:drop-shadow(0 0 6px rgba(251,191,36,.7)) drop-shadow(0 0 12px rgba(251,191,36,.3));animation:cdStarTwinkle 2s ease-in-out infinite alternate}
@keyframes cdStarTwinkle{0%{opacity:.5;transform:scale(.85)}100%{opacity:1;transform:scale(1.15)}}
.cd-name{font-size:1.05rem;font-weight:700;color:var(--t1);text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.cd-alias{font-size:.72rem;color:var(--t3);margin-top:1px;text-align:left}
.cd-tag{display:inline-block;font-size:.55rem;font-weight:800;padding:2px 6px;border-radius:5px;color:#111;vertical-align:middle;margin-left:.3rem;text-transform:uppercase}
.cd-close{position:absolute;top:.5rem;right:.6rem;width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.06);border:none;color:var(--t3);font-size:.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;z-index:5}
.cd-close:active{background:rgba(255,255,255,.12)}
.cd-anon-preview{display:flex;align-items:center;gap:.35rem;margin-top:.2rem}
.cd-anon-ball{width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:800;color:#fff;border:1.5px solid rgba(255,255,255,.1);opacity:.6;flex-shrink:0}
.cd-anon-nick{font-size:.62rem;color:var(--t3);max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cd-anon-label{font-size:.5rem;color:rgba(255,255,255,.25);text-transform:uppercase;letter-spacing:.04em;margin-left:.1rem}
/* Inline stats — flows next to name */
.cd-stats{display:flex;justify-content:flex-start;gap:.15rem;padding:.15rem 0 .05rem;flex-wrap:wrap}
.cd-stat-inline{font-size:.72rem;color:var(--t3);display:inline-flex;align-items:center;gap:.15rem}
.cd-stat-inline b{font-weight:700;color:var(--t1)}
.cd-stat-sep{color:rgba(255,255,255,.12);font-size:.6rem}
.cd-divider{height:1px;background:rgba(255,255,255,.04);margin:0 .8rem}
.cd-section{padding:.3rem .8rem}
.cd-time{font-size:.72rem;color:var(--t3);display:flex;align-items:center;gap:.3rem}
.cd-time span{display:flex;align-items:center;gap:.15rem}
/* Icon action buttons — circular grid */
.cd-actions{display:flex;gap:.2rem;padding:.3rem .8rem .15rem;justify-content:center}
.cd-action-icon{display:flex;flex-direction:column;align-items:center;gap:3px;padding:.3rem .45rem;border-radius:10px;border:none;background:none;color:var(--t3);font-size:.55rem;font-weight:500;font-family:inherit;cursor:pointer;transition:all .15s;min-width:46px}
.cd-action-icon:active{transform:scale(.93);background:rgba(255,255,255,.06)}
.cd-action-icon .cd-icon{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);transition:all .15s}
.cd-action-icon .cd-icon svg{width:18px;height:18px}
.cd-action-icon.active .cd-icon{background:rgba(99,102,241,.15);border-color:rgba(99,102,241,.25)}
.cd-action-icon.active{color:#a5b4fc}
.cd-action-icon.liked .cd-icon{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.2)}
.cd-action-icon.liked{color:#fca5a5}
.cd-action-icon.success .cd-icon{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.2)}
.cd-action-icon.success{color:#86efac}
.cd-action-icon.star .cd-icon{background:rgba(251,191,36,.08);border-color:rgba(251,191,36,.15)}
.cd-action-icon.star{color:#fbbf24}
.cd-action-icon.disabled{opacity:.4;pointer-events:none}
.cd-action-icon.revealed-new .cd-icon{background:rgba(251,191,36,.2);border-color:rgba(251,191,36,.5);animation:cdRevealPulse 1.5s ease-in-out 3}
.cd-action-icon.revealed-new{color:#fbbf24;pointer-events:none}
@keyframes cdRevealPulse{0%{box-shadow:0 0 0 0 rgba(251,191,36,.4)}70%{box-shadow:0 0 0 8px rgba(251,191,36,0)}100%{box-shadow:0 0 0 0 rgba(251,191,36,0)}}
@keyframes cdsStarBurst{0%{opacity:1;transform:translate(-50%,-50%) scale(.5)}60%{opacity:1}100%{opacity:0;transform:translate(calc(-50% + var(--cds-x)),calc(-50% + var(--cds-y))) scale(1.2)}}
/* Declarations — mural style, always visible */
.cd-decl-mural{padding:.25rem 0;display:flex;flex-direction:column;gap:.4rem}
.cd-decl-card{padding:.45rem .6rem;background:rgba(255,255,255,.03);border-radius:10px;border-left:2px solid rgba(139,92,246,.25);position:relative}
.cd-decl-card .cd-decl-text{font-size:.72rem;color:var(--t2);line-height:1.4;font-style:italic}
.cd-decl-card .cd-decl-from{font-size:.6rem;color:var(--t3);margin-top:2px}
.cd-decl-add{display:flex;gap:.4rem;align-items:center;margin-top:.4rem}
.cd-decl-add input{flex:1;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:.35rem .5rem;font-size:.7rem;color:var(--t1);font-family:inherit;outline:none}
.cd-decl-add input:focus{border-color:rgba(139,92,246,.3)}
.cd-decl-add button{padding:.3rem .6rem;border-radius:8px;background:rgba(139,92,246,.15);border:1px solid rgba(139,92,246,.2);color:#c084fc;font-size:.68rem;font-weight:600;font-family:inherit;cursor:pointer}
/* Collapsible (kept for history) */
.cd-collapse-btn{display:flex;align-items:center;gap:.3rem;padding:.3rem 0;font-size:.6rem;font-weight:600;color:var(--t3);cursor:pointer;border:none;background:none;font-family:inherit;width:100%}
.cd-collapse-btn .cd-badge{min-width:16px;height:16px;border-radius:8px;background:rgba(139,92,246,.15);color:#c084fc;font-size:.5rem;font-weight:700;display:inline-flex;align-items:center;justify-content:center;padding:0 3px}
.cd-collapse-btn .cd-arrow{transition:transform .2s;font-size:.45rem;margin-left:auto;color:var(--t3);opacity:.4}
.cd-collapse-btn.open .cd-arrow{transform:rotate(180deg)}
.cd-collapse-body{max-height:0;overflow:hidden;transition:max-height .3s ease}
.cd-collapse-body.open{max-height:400px;overflow-y:auto}
/* History floating panel */
.cd-history-panel{position:fixed;bottom:0;left:0;right:0;z-index:30;background:rgba(10,10,14,.98);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.06);border-radius:16px 16px 0 0;max-height:55vh;transform:translateY(100%);opacity:0;transition:all .3s cubic-bezier(.22,1,.36,1);pointer-events:none;overflow:hidden}
.cd-history-panel.visible{transform:translateY(0);opacity:1;pointer-events:auto}
.cd-history-panel .cd-handle{margin:8px auto 4px}
.cd-history-scroll{overflow-y:auto;max-height:calc(55vh - 40px);padding:.3rem 1rem .8rem;overscroll-behavior:contain}
.cd-insta{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .5rem;background:linear-gradient(135deg,rgba(225,48,108,.08),rgba(131,58,180,.06));border:1px solid rgba(225,48,108,.12);border-radius:14px;color:#e1306c;font-size:.72rem;font-weight:500;text-decoration:none;transition:all .2s}
.cd-insta:active{transform:scale(.96);background:rgba(225,48,108,.15)}
.cd-selfie{width:36px;height:36px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,.05);cursor:pointer;transition:transform .15s}
.cd-selfie:active{transform:scale(.95)}
.cd-selfies-row{display:flex;gap:.25rem;padding:.2rem 0;flex-wrap:wrap}
.cd-selfie-zoom{position:fixed;top:0;left:0;right:0;bottom:0;z-index:500;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;transition:opacity .25s}
.cd-selfie-zoom.visible{opacity:1}
.cd-selfie-zoom img{max-width:85vw;max-height:70vh;border-radius:14px;object-fit:contain}
.cd-selfie-zoom .cd-zoom-delete{position:absolute;bottom:max(env(safe-area-inset-bottom),1.5rem);left:50%;transform:translateX(-50%);padding:.5rem 1.2rem;border-radius:12px;border:1px solid rgba(239,68,68,.3);background:rgba(239,68,68,.12);color:#ef4444;font-size:.7rem;font-weight:600;font-family:inherit;cursor:pointer;opacity:0;transition:opacity .3s}
.cd-selfie-zoom.hold-active .cd-zoom-delete{opacity:1}
/* Legacy .cd-action kept for compatibility but hidden by default */
.cd-action{display:none}
.cd-action-icon.tip .cd-icon{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.2)}
.cd-action-icon.tip{color:#4ade80}
.cd-bio{font-size:.65rem;color:var(--t3);font-style:italic;padding:.15rem 0;line-height:1.4}
/* Notification panel */
.notif-btn{position:absolute;top:max(env(safe-area-inset-top),.6rem);right:.8rem;z-index:15;width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:all .2s}
.notif-btn:active{transform:scale(.9);background:rgba(255,255,255,.12)}
.notif-badge{position:absolute;top:-2px;right:-2px;min-width:16px;height:16px;border-radius:8px;background:#ef4444;font-size:.55rem;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;padding:0 4px;border:2px solid rgba(10,10,14,.95)}
.notif-panel{position:absolute;inset:0;z-index:25;background:rgba(10,10,14,.98);backdrop-filter:blur(16px);padding-top:max(env(safe-area-inset-top),.6rem);opacity:0;transform:translateX(100%);transition:all .3s cubic-bezier(.22,1,.36,1);pointer-events:none;overflow-y:auto}
.notif-panel.visible{opacity:1;transform:translateX(0);pointer-events:auto}
.notif-header{display:flex;align-items:center;gap:.6rem;padding:.6rem 1rem;border-bottom:1px solid rgba(255,255,255,.04)}
.notif-title{flex:1;font-size:.9rem;font-weight:700;color:var(--t1)}
.notif-close{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.06);border:none;color:var(--t3);font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.notif-item{display:flex;align-items:center;gap:.7rem;padding:.65rem 1rem;border-bottom:1px solid rgba(255,255,255,.03);transition:background .15s}
.notif-item:active{background:rgba(255,255,255,.04)}
.notif-ico{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;overflow:hidden;position:relative}
.notif-ico img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0}
.notif-content{flex:1;min-width:0}
.notif-text{font-size:.72rem;color:var(--t1);line-height:1.3}
.notif-text strong{font-weight:600;color:var(--t1)}
.notif-time{font-size:.58rem;color:var(--t3);margin-top:1px}
.notif-empty{text-align:center;padding:3rem 1rem;color:var(--t3);font-size:.8rem}

/* ENCOUNTER LOG */
#encounterLog{padding:0;overflow-y:auto;background:var(--bg)}
.elog-header{display:flex;align-items:center;gap:.6rem;padding:max(env(safe-area-inset-top),.8rem) 1.2rem .5rem;position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg) 80%,transparent)}
.elog-header h2{font-size:.88rem;font-weight:600;flex:1;color:var(--t1);letter-spacing:.02em}
.elog-list{padding:.5rem .8rem;display:flex;flex-direction:column;gap:.25rem;padding-bottom:3rem}
.elog-date-label{font-size:.58rem;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;padding:.65rem 0 .25rem;font-weight:600;opacity:.6}
.elog-item{border-radius:12px;display:flex;align-items:center;position:relative;overflow:hidden;touch-action:pan-y}
.elog-item-inner{display:flex;gap:.65rem;align-items:center;flex:1;min-width:0;transition:transform .2s cubic-bezier(.25,.46,.45,.94);position:relative;z-index:1;background:var(--bg);padding:.55rem .6rem;width:100%;border-radius:12px}
.elog-delete{position:absolute;right:0;top:0;bottom:0;width:56px;display:flex;align-items:center;justify-content:center;z-index:0;background:transparent}
.elog-delete svg{width:15px;height:15px;stroke:rgba(239,68,68,.7);stroke-width:2}
.elog-tip-tag{display:inline-flex;align-items:center;gap:.2rem;background:rgba(34,197,94,.08);color:#4ade80;font-size:.55rem;font-weight:600;padding:.12rem .4rem;border-radius:5px}
.elog-tip-btn{display:inline-flex;align-items:center;gap:.2rem;background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--t3);font-size:.55rem;font-weight:500;padding:.12rem .4rem;border-radius:5px;cursor:pointer;transition:all .2s;font-family:inherit}
.elog-tip-btn:active{background:rgba(34,197,94,.1);color:#4ade80}
.elog-avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:800;color:#fff;flex-shrink:0}
.elog-info{flex:1;min-width:0}
.elog-name{font-size:.78rem;font-weight:600;color:var(--t1)}
.elog-phrase{font-size:.65rem;color:var(--t2);font-style:italic;margin-top:.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.elog-meta{display:flex;gap:.5rem;font-size:.58rem;color:var(--t3);margin-top:.15rem;flex-wrap:wrap;align-items:center}
.elog-meta span{display:flex;align-items:center;gap:.15rem}
.elog-tip{color:var(--ok);font-weight:600}
.elog-empty{text-align:center;padding:3rem 1.5rem;color:var(--t3);font-size:.78rem;line-height:1.7;font-weight:300}
.elog-filter{padding:.4rem .8rem;border-radius:20px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:rgba(255,255,255,.4);font-size:.68rem;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .25s;font-family:inherit;letter-spacing:.02em}
.elog-filter.active{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2);color:rgba(255,255,255,.9)}

/* MORE MENU (overlay) */
.more-menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:8000;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .25s ease}
.more-menu-sheet{background:linear-gradient(180deg,var(--s2),var(--s1));border-radius:24px 24px 0 0;width:100%;max-width:420px;padding:1.5rem;padding-bottom:max(env(safe-area-inset-bottom),1.5rem);animation:slideUp .35s cubic-bezier(.22,1,.36,1)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.more-menu-handle{width:32px;height:4px;background:var(--b1);border-radius:2px;margin:0 auto .8rem}
.more-menu-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
.more-menu-item{display:flex;flex-direction:column;align-items:center;gap:.4rem;padding:.8rem .4rem;background:var(--s2);border:1px solid var(--b1);border-radius:14px;cursor:pointer;transition:.15s}
.more-menu-item:active{transform:scale(.95);background:var(--s3)}
.more-menu-item .mm-ico{font-size:1.4rem}
.more-menu-item .mm-lbl{font-size:.68rem;color:var(--t2);font-weight:500;text-align:center}
.my-pf-btn{display:flex;align-items:center;gap:.7rem;width:100%;padding:.65rem .9rem;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:14px;color:var(--t1);font-size:.8rem;font-weight:500;font-family:inherit;cursor:pointer;transition:all .15s;text-align:left}
.my-pf-btn:active{transform:scale(.98);background:rgba(255,255,255,.06)}
.my-pf-ico{font-size:.7rem;flex-shrink:0;width:20px;text-align:center;color:var(--t3);font-weight:600;letter-spacing:.03em}
.my-pf-tag{margin-left:auto;font-size:.55rem;color:var(--ac);font-weight:600;white-space:nowrap;padding:.15rem .4rem;background:rgba(255,107,53,.1);border-radius:8px}
.my-pf-danger{color:rgba(248,113,113,.7);border-color:rgba(248,113,113,.08)}
.my-pf-divider{height:1px;background:rgba(255,255,255,.04);margin:.25rem 0}

/* COMPLETE PROFILE */
#completeProfile{padding:0;overflow:hidden;display:flex;flex-direction:column}
.cp-top-bar{display:flex;align-items:center;justify-content:space-between;padding:max(env(safe-area-inset-top),.6rem) 1rem .5rem;border-bottom:1px solid rgba(255,255,255,.04)}
.cp-top-bar span{font-size:.82rem;font-weight:600;color:var(--t1)}
.cp-top-bar .chb:last-child{font-size:.7rem;color:var(--ac);font-weight:600;border:none;background:none}
.cp-scroll{flex:1;overflow-y:auto;padding:1rem 1.2rem;-webkit-overflow-scrolling:touch}
.cp-section-title{font-size:.58rem;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;font-weight:700;margin:1.2rem 0 .5rem;padding-bottom:.3rem;border-bottom:1px solid rgba(255,255,255,.04)}
.cp-photo-wrap{display:flex;flex-direction:column;align-items:center;gap:.4rem;margin-bottom:.5rem}
.cp-photo{width:80px;height:80px;border-radius:50%;background:var(--s2);border:1.5px solid var(--b1);overflow:hidden;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative}
.cp-photo img{width:100%;height:100%;object-fit:cover}
.cp-photo-label{font-size:.62rem;color:var(--ac);cursor:pointer;font-weight:500}
.cp-field{margin-bottom:.9rem}
.cp-field label{display:block;font-size:.6rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.3rem;font-weight:600}
.cp-field input,.cp-field textarea{width:100%;padding:.6rem .8rem;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:10px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;transition:border-color .2s}
.cp-field input:focus,.cp-field textarea:focus{border-color:rgba(255,107,53,.4)}
.cp-field textarea{resize:none;height:60px}
.cp-tag-grid{display:flex;flex-wrap:wrap;gap:.35rem}
.cp-tag{padding:.35rem .65rem;border-radius:20px;font-size:.65rem;font-weight:600;border:1.5px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03);color:var(--t2);cursor:pointer;transition:all .2s;user-select:none;font-family:inherit}
.cp-tag.selected{background:rgba(255,107,53,.15);border-color:rgba(255,107,53,.5);color:#ff6b35}
.cp-tag.disabled{opacity:.35;cursor:not-allowed}
.cp-note{font-size:.55rem;color:var(--t3);margin-top:.2rem;opacity:.7}
.cp-field-privacy .cp-input-row{display:flex;gap:.4rem;align-items:center}
.cp-field-privacy .cp-input-row input{flex:1}
.cp-priv-toggle{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.7rem;flex-shrink:0;transition:all .2s}
.cp-priv-toggle.priv-on{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.08)}
.cp-priv-toggle.priv-off{border-color:rgba(239,68,68,.2);background:rgba(239,68,68,.06)}
.cp-verif-row{display:flex;gap:.5rem;margin-bottom:.3rem}
.cp-verif-card{flex:1;padding:.6rem .5rem;border-radius:12px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);cursor:pointer;text-align:center;font-family:inherit;transition:all .15s}
.cp-verif-card:active{transform:scale(.97)}
.cp-verif-card.active{border-color:rgba(6,182,212,.3);background:rgba(6,182,212,.05)}
.cp-verif-card.active-doc{border-color:rgba(168,85,247,.3);background:rgba(168,85,247,.05)}
.cp-verif-ico{font-size:.8rem;margin-bottom:.15rem;opacity:.6}
.cp-verif-label{font-size:.62rem;font-weight:700;color:var(--t1)}
.cp-verif-status{font-size:.48rem;color:var(--t3);margin-top:.1rem}

/* REVEAL IDENTITY */
/* ID Request/Reveal buttons — eye-catching in chat actions */
@keyframes id-btn-glow{0%,100%{box-shadow:none}50%{box-shadow:0 0 12px rgba(255,107,53,.15)}}
/* Floating ID buttons in constellation detail */
.id-float-btn{display:inline-flex;align-items:center;gap:.4rem;padding:.5rem 1rem;border-radius:20px;font-size:.75rem;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .2s;box-shadow:0 4px 16px rgba(0,0,0,.3)}
.id-float-btn.request{background:linear-gradient(135deg,#7c3aed,#a371f7);color:#fff}
.id-float-btn.reveal{background:linear-gradient(135deg,var(--ac),var(--pk));color:#fff}
.id-float-btn:active{transform:scale(.93)}
.reveal-req-popup{display:none}
.reveal-chat-card{margin:.5rem .4rem;padding:0;animation:mi .3s ease}
.rcc-header{display:flex;align-items:center;gap:.6rem;padding:.8rem;background:linear-gradient(135deg,rgba(255,200,87,.06),rgba(255,107,53,.06));border:1px solid rgba(255,200,87,.2);border-radius:14px}
.rcc-icon{font-size:1.3rem}
.rcc-text{font-size:.78rem;color:var(--t2);line-height:1.4}
.rcc-actions{display:flex;gap:.4rem;margin-top:.4rem;padding:0 .8rem .6rem}
.rcc-status{text-align:center;font-size:.72rem;padding:.4rem .8rem;border-radius:10px;margin-top:.3rem}
.rcc-status.pending{color:#fbbf24;background:rgba(251,191,36,.08)}
.rcc-status.accepted{color:var(--ok);background:rgba(52,211,153,.08)}
.rcc-status.declined{color:var(--t3);background:rgba(255,255,255,.03)}
.rcc-revealed{text-align:center;padding:1rem;background:linear-gradient(135deg,rgba(52,211,153,.06),rgba(0,220,130,.04));border:1px solid rgba(52,211,153,.2);border-radius:16px}
.rcc-revealed-title{font-size:.9rem;font-weight:700;color:var(--ok);margin-bottom:.6rem}
.rcc-revealed-pair{display:flex;justify-content:center;align-items:center;gap:.8rem;margin:.5rem 0}
.rcc-photo{width:52px;height:52px;border-radius:50%;object-fit:cover;border:2px solid var(--ok)}
.rcc-photo-placeholder{width:52px;height:52px;border-radius:50%;background:var(--ac);display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:800;color:#fff}
.rcc-heart{font-size:1.2rem}
.rcc-names{display:flex;justify-content:center;gap:2rem;margin:.3rem 0}
.rcc-name{font-size:.8rem;font-weight:600;color:var(--t1)}
.rcc-insta{display:inline-flex;align-items:center;gap:.3rem;padding:.3rem .7rem;margin-top:.4rem;background:linear-gradient(135deg,rgba(225,48,108,.12),rgba(131,58,180,.12));border:1px solid rgba(225,48,108,.2);border-radius:20px;color:#e1306c;font-size:.7rem;font-weight:500;text-decoration:none}
.reveal-req-content{display:flex;align-items:center;gap:.8rem;margin-bottom:1rem}
.reveal-req-actions{display:flex;gap:.5rem}
.id-revealed-card{background:var(--s1);border:1px solid var(--ac);border-radius:14px;padding:.8rem;display:flex;align-items:center;gap:.8rem;margin:.5rem 0}
.id-revealed-card img{width:44px;height:44px;border-radius:50%;object-fit:cover}
.id-revealed-card .id-name{font-size:.9rem;font-weight:600;color:var(--t1)}
.id-revealed-card .id-bio{font-size:.7rem;color:var(--t2)}
.const-empty{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.8rem;z-index:5;padding:2rem}
.const-empty-icon{font-size:2rem;opacity:.2}
.const-empty-text{font-size:.8rem;color:var(--t3);font-weight:300;text-align:center;line-height:1.7;max-width:220px}
.const-feedback{position:absolute;top:calc(max(env(safe-area-inset-top),.8rem) + 3.5rem);left:50%;transform:translateX(-50%);z-index:15;font-size:.68rem;color:var(--ac2);font-weight:400;font-style:italic;opacity:0;transition:opacity .5s;pointer-events:none;white-space:nowrap}
.const-feedback.show{opacity:1}

/* EXPIRE CARD */
#expireCard{justify-content:center;align-items:center;padding:2rem;text-align:center}
.ev{width:270px;aspect-ratio:9/16;background:linear-gradient(170deg,#0a0a12,#15152a,#0a0a12);border:1px solid var(--b2);border-radius:24px;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:2.5rem;gap:1.5rem;position:relative;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.ev::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg,transparent,rgba(255,107,53,.04),transparent,rgba(255,61,113,.04),transparent);animation:sh 10s linear infinite}
@keyframes sh{to{transform:rotate(360deg)}}
.ev .cl{font-size:.85rem;font-weight:800;letter-spacing:.3em;color:var(--ac);opacity:.5;position:relative}
.ev .cf{font-size:1.15rem;font-weight:300;color:var(--t1);line-height:1.7;position:relative}
.ev .ctm{font-size:.72rem;color:var(--t2);position:relative}
.ev .cft{font-size:.6rem;color:var(--t3);position:absolute;bottom:1.5rem}
.ea{display:flex;gap:1rem;margin-top:1.5rem}

/* PROFILE */
#profile{flex-direction:column;background:var(--bg)}
.pf-header{display:flex;align-items:center;gap:.8rem;padding:1rem;background:var(--s1);border-bottom:1px solid var(--b1);padding-top:max(env(safe-area-inset-top),1rem)}
.pf-header h2{font-size:1.05rem;font-weight:600}
.pf-scroll{flex:1;overflow-y:auto;padding:1rem}
.pf-card{text-align:center;padding:1.5rem;background:linear-gradient(170deg,var(--s1),rgba(26,26,36,.6));border:1px solid rgba(255,255,255,.06);border-radius:20px;margin-bottom:1rem;position:relative;overflow:hidden}
.pf-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 50% 0%,rgba(255,107,53,.04),transparent 60%);pointer-events:none}
.pf-stats{display:flex;justify-content:center;gap:1.5rem;margin-top:1rem}
.pf-stat{text-align:center}
.pf-stat-num{font-size:1.3rem;font-weight:800;color:var(--ac)}
.pf-stat-lbl{font-size:.6rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em}
.pf-section{margin-bottom:1.2rem}
.pf-section-title{font-size:.75rem;color:var(--t2);text-transform:uppercase;letter-spacing:.12em;font-weight:600;margin-bottom:.6rem;padding-left:.3rem}
.pf-decl{padding:.7rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;margin-bottom:.5rem;border-left:3px solid var(--ac)}
.pf-decl-text{font-size:.85rem;color:var(--t1);font-style:italic;line-height:1.5;margin-bottom:.3rem}
.pf-decl-from{font-size:.65rem;color:var(--t3)}
.pf-gift{display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;margin-bottom:.5rem}
.pf-gift-emoji{font-size:1.4rem}
.pf-gift-info{flex:1;min-width:0}
.pf-gift-name{font-size:.82rem;color:var(--t1);font-weight:500}
.pf-gift-from{font-size:.65rem;color:var(--t3)}
.pf-gift-msg{font-size:.72rem;color:var(--t2);font-style:italic;margin-top:.1rem}
.pf-actions{display:flex;gap:.5rem;margin-top:1rem;flex-wrap:wrap;justify-content:center}
.pf-act-btn{padding:.5rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t2);font-size:.78rem;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:.4rem;transition:.15s}
.pf-act-btn:active{background:var(--ac);color:#fff;border-color:var(--ac)}
.pf-empty{font-size:.8rem;color:var(--t3);text-align:center;padding:1rem;font-style:italic}

/* GIFT PICKER MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:200;display:flex;align-items:flex-end;justify-content:center;animation:mfade .25s ease;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
@keyframes mfade{from{opacity:0}to{opacity:1}}
.modal-sheet{width:100%;max-width:420px;max-height:75vh;background:linear-gradient(180deg,var(--s2),var(--s1));border-radius:24px 24px 0 0;padding:1.2rem;overflow-y:auto;animation:mslide .3s cubic-bezier(.22,1,.36,1);padding-bottom:max(env(safe-area-inset-bottom),1.2rem)}
@keyframes mslide{from{transform:translateY(100%)}to{transform:none}}
.modal-handle{width:36px;height:4px;border-radius:2px;background:var(--b1);margin:0 auto .8rem}
.modal-title{font-size:1rem;font-weight:700;text-align:center;margin-bottom:1rem}
.gift-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:1rem}
.gift-option{padding:.8rem;background:var(--s2);border:1px solid var(--b1);border-radius:14px;text-align:center;cursor:pointer;transition:.15s}
.gift-option:active{border-color:var(--ac);background:var(--gw)}
.gift-option .g-emoji{font-size:1.6rem}
.gift-option .g-name{font-size:.78rem;font-weight:600;color:var(--t1);margin-top:.3rem}
.gift-option .g-desc{font-size:.62rem;color:var(--t3);margin-top:.2rem}
.decl-input{width:100%;padding:.8rem;background:var(--s2);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:.88rem;font-family:inherit;resize:none;outline:none;min-height:80px}
.decl-input:focus{border-color:var(--ac)}
.decl-counter{font-size:.6rem;color:var(--t3);text-align:right;margin-top:.3rem}
.gift-msg-input{width:100%;padding:.6rem;background:var(--s2);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;margin-top:.6rem}
.gift-msg-input:focus{border-color:var(--ac)}

/* ADDRESS REQUEST BANNER */
.addr-request{padding:.8rem 1rem;background:linear-gradient(135deg,rgba(255,107,53,.08),rgba(255,61,113,.05));border:1px solid rgba(255,107,53,.15);border-radius:14px;margin:.5rem .8rem;animation:mi .3s ease}
.addr-request-text{font-size:.82rem;color:var(--t1);line-height:1.5;margin-bottom:.6rem}
.addr-request-note{font-size:.68rem;color:var(--t3);margin-bottom:.6rem;font-style:italic}
.addr-input{width:100%;padding:.6rem;background:var(--s2);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;margin-bottom:.5rem}
.addr-input:focus{border-color:var(--ac)}
.addr-actions{display:flex;gap:.5rem}
.addr-btn{padding:.4rem .8rem;border-radius:10px;font-size:.75rem;font-family:inherit;cursor:pointer;border:none}
.addr-btn.accept{background:var(--ac);color:#fff}
.addr-btn.decline{background:var(--s2);color:var(--t2);border:1px solid var(--b1)}

/* LOCATION / EVENTS */
#locationScreen{flex-direction:column;background:var(--bg)}
#eventDetail{flex-direction:column;background:var(--bg)}
.loc-header{display:flex;align-items:center;gap:.8rem;padding:.8rem 1rem;background:var(--s1);border-bottom:1px solid var(--b1);padding-top:max(env(safe-area-inset-top),1rem)}
.loc-header h2{font-size:1rem;font-weight:600;flex:1}
.loc-header .bs{font-size:.68rem;padding:.3rem .7rem}
.loc-scroll{flex:1;overflow-y:auto;padding:1rem;-webkit-overflow-scrolling:touch}
.loc-status{text-align:center;padding:.7rem;font-size:.75rem;color:var(--t2);background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin-bottom:.8rem;display:flex;align-items:center;justify-content:center;gap:.4rem}
.loc-status.active{border-color:var(--ok);color:var(--ok);background:rgba(52,211,153,.05)}
.loc-status.error{border-color:var(--err);color:var(--err)}
.loc-tabs{display:flex;gap:.3rem;margin-bottom:.8rem;background:var(--s1);border-radius:12px;padding:.25rem;border:1px solid var(--b1)}
.loc-tab{flex:1;padding:.45rem;text-align:center;font-size:.75rem;font-weight:600;background:transparent;border:none;border-radius:10px;color:var(--t3);cursor:pointer;font-family:inherit;transition:.2s}
.loc-tab.active{background:var(--ac);color:#fff;box-shadow:0 2px 8px rgba(255,107,53,.3)}
.loc-person{display:flex;align-items:center;gap:.6rem;padding:.65rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin-bottom:.5rem;transition:.15s;animation:mi .3s ease}
.loc-person:active{background:var(--s2);transform:scale(.98)}
.loc-person-info{flex:1;min-width:0}
.loc-person-nick{font-size:.82rem;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.loc-person-dist{font-size:.62rem;color:var(--t3);margin-top:.1rem}
.loc-person-pts{font-size:.65rem;color:var(--ac);margin-top:.1rem}
.loc-encosta-btn{padding:.35rem .7rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:10px;color:#fff;font-size:.68rem;font-weight:700;cursor:pointer;font-family:inherit;flex-shrink:0;letter-spacing:.03em;box-shadow:0 2px 8px rgba(255,107,53,.2);transition:.15s}
.loc-encosta-btn:active{transform:scale(.94)}
.evt-card{padding:.8rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin-bottom:.5rem;transition:.15s;animation:mi .3s ease}
.evt-card:active{background:var(--s2);transform:scale(.98)}
.evt-card-name{font-size:.88rem;font-weight:700;color:var(--t1);margin-bottom:.25rem}
.evt-card-meta{font-size:.65rem;color:var(--t3);display:flex;gap:.8rem;margin-bottom:.25rem}
.evt-card-desc{font-size:.72rem;color:var(--t2);font-style:italic;line-height:1.4}
.evt-card-people{font-size:.65rem;color:var(--ac);margin-top:.25rem;font-weight:500}
.evt-detail{padding:1.2rem;background:var(--s1);border:1px solid var(--b1);border-radius:16px;margin-bottom:1rem}
.evt-detail-name{font-size:1.05rem;font-weight:700;color:var(--t1);margin-bottom:.4rem}
.evt-detail-desc{font-size:.8rem;color:var(--t2);font-style:italic;margin-bottom:.8rem;line-height:1.5;padding:.5rem .6rem;background:var(--s2);border-radius:10px}
.evt-ppl-title{font-size:.7rem;color:var(--t2);text-transform:uppercase;letter-spacing:.1em;font-weight:600;margin-bottom:.5rem}
.loc-create-form{padding:1.2rem;background:var(--s1);border:1px solid var(--b1);border-radius:16px;margin-bottom:1rem;animation:mi .3s ease}
.loc-create-form .form-title{font-size:.92rem;font-weight:700;color:var(--t1);margin-bottom:.3rem}
.loc-create-form .form-sub{font-size:.68rem;color:var(--t3);margin-bottom:1rem;line-height:1.4}
.loc-fg{margin-bottom:.8rem}
.loc-fg label{display:block;font-size:.65rem;color:var(--t2);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.3rem;font-weight:600}
.loc-fg input,.loc-fg textarea{width:100%;padding:.65rem .8rem;background:var(--s2);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s}
.loc-fg textarea{min-height:60px;resize:none}
.loc-fg input:focus,.loc-fg textarea:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.loc-empty{text-align:center;padding:2.5rem 1rem;color:var(--t3);font-size:.82rem;line-height:1.6}
.loc-empty-icon{font-size:2rem;margin-bottom:.6rem;opacity:.5}

/* REVEAL EXTRAS */
.rv-last{font-size:.68rem;color:var(--t3);margin-top:.4rem;padding:.3rem .8rem;background:var(--s1);border-radius:10px;border:1px solid var(--b1)}

/* CONTACT REQUEST */
.contact-menu{display:flex;gap:.3rem;flex-wrap:wrap;padding:.4rem .8rem;animation:mi .3s ease}
.contact-opt{padding:.3rem .6rem;font-size:.68rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;color:var(--t2);cursor:pointer;font-family:inherit}
.contact-opt:active{background:var(--s2)}
.contact-req-banner{padding:.6rem .8rem;background:linear-gradient(135deg,rgba(255,107,53,.06),rgba(255,61,113,.04));border:1px solid rgba(255,107,53,.12);border-radius:12px;margin:.4rem .8rem;animation:mi .3s ease}
.contact-req-text{font-size:.78rem;color:var(--t1);margin-bottom:.4rem}
.contact-req-actions{display:flex;gap:.4rem}
.contact-req-input{width:100%;padding:.4rem .6rem;background:var(--s2);border:1px solid var(--b1);border-radius:8px;color:var(--t1);font-size:.78rem;font-family:inherit;outline:none;margin-bottom:.4rem}

/* ENCOSTA REQUEST NOTIFICATION */
.encosta-req-banner{position:fixed;top:max(env(safe-area-inset-top),1rem);left:1rem;right:1rem;padding:1rem;background:var(--s1);border:1px solid var(--ac);border-radius:16px;z-index:9000;animation:mi .3s ease;box-shadow:0 8px 30px rgba(0,0,0,.5)}
.encosta-req-title{font-size:.82rem;font-weight:600;color:var(--t1);margin-bottom:.4rem}
.encosta-req-sub{font-size:.68rem;color:var(--t3);margin-bottom:.6rem}
.encosta-req-actions{display:flex;gap:.5rem}

/* LANG SWITCHER */
.lang-sw{display:flex;gap:.25rem}
.lang-btn{padding:.15rem .35rem;background:transparent;border:1px solid rgba(255,255,255,.06);border-radius:6px;color:var(--t3);font-size:.52rem;font-weight:600;cursor:pointer;font-family:inherit;text-transform:uppercase;transition:.15s}
.lang-btn.active{color:var(--ac);border-color:rgba(255,107,53,.3)}

/* GORJETA / TIP */
#tipScreen{padding:1.5rem;padding-top:max(env(safe-area-inset-top),1rem);overflow-y:auto}
.tip-header{display:flex;align-items:center;gap:.8rem;margin-bottom:1.5rem}
.tip-receiver{display:flex;flex-direction:column;align-items:center;gap:.6rem;text-align:center;margin-bottom:1.5rem}
.tip-receiver-avatar{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:800;color:#fff;border:2px solid var(--ac)}
.tip-receiver-name{font-size:1.1rem;font-weight:600;color:var(--t1)}
.tip-receiver-service{font-size:.72rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;font-weight:500}
.tip-amounts{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin-bottom:1.2rem}
.tip-amount-btn{padding:.8rem .4rem;background:var(--s1);border:1.5px solid rgba(255,255,255,.06);border-radius:14px;color:var(--t1);font-size:1rem;font-weight:700;font-family:inherit;cursor:pointer;transition:.15s;text-align:center}
.tip-amount-btn:active,.tip-amount-btn.selected{background:var(--ac);border-color:var(--ac);color:#fff;transform:scale(.96)}
.tip-custom{display:flex;align-items:center;gap:.6rem;margin-bottom:1.5rem}
.tip-custom label{font-size:.75rem;color:var(--t3);font-weight:500;white-space:nowrap}
.tip-custom input{flex:1;padding:.7rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:1.1rem;font-family:inherit;outline:none;text-align:center}
.tip-custom input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.tip-card-section{margin-bottom:1.5rem}
.tip-card-section h3{font-size:.75rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;font-weight:600;margin-bottom:.8rem}
.tip-card-fields{display:flex;flex-direction:column;gap:.6rem}
.tip-card-row{display:flex;gap:.5rem}
.tip-field{flex:1;padding:.7rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;min-height:42px}
.tip-field iframe{border:none!important;height:24px!important}
.tip-input{width:100%;padding:.7rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:14px;font-family:inherit;outline:none;margin-top:.4rem}
.tip-input::placeholder{color:#555568}
.pay-spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.tip-saved-section{margin-bottom:1rem}
.tip-saved-card{width:100%;display:flex;align-items:center;gap:.7rem;padding:.8rem 1rem;background:rgba(52,211,153,.06);border:1.5px solid rgba(52,211,153,.25);border-radius:14px;color:#34d399;font-family:inherit;cursor:pointer;transition:.15s}
.tip-saved-card.active{border-color:#34d399;background:rgba(52,211,153,.12)}
.tsc-icon{font-size:1.2rem}
.tsc-info{flex:1;text-align:left;font-size:.82rem;font-weight:500}
.tsc-brand{text-transform:capitalize}
.tsc-check{font-size:.9rem;opacity:0;transition:.2s}
.tip-saved-card.active .tsc-check{opacity:1}
.tip-new-card-link{background:none;border:none;color:var(--t3);font-size:.68rem;font-family:inherit;cursor:pointer;padding:.4rem 0;text-decoration:underline}
.tip-save-check{display:flex;align-items:center;gap:.5rem;font-size:.7rem;color:var(--t3);margin-top:.6rem;cursor:pointer}
.tip-save-check input{accent-color:var(--ac)}
.tip-pay-btn{width:100%;padding:1rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:16px;color:#fff;font-size:.95rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.04em;box-shadow:0 4px 15px rgba(255,107,53,.3);transition:.15s}
.tip-pay-btn:active{transform:scale(.97)}
.tip-pay-btn:disabled{opacity:.4}
.tip-result{display:flex;flex-direction:column;align-items:center;gap:.8rem;text-align:center;padding:2rem 0}
.tip-result-icon{font-size:3rem}
.tip-result-text{font-size:.9rem;color:var(--t2);font-weight:300;line-height:1.6}
/* Prestador register */
#prestadorReg{padding:1.5rem;padding-top:max(env(safe-area-inset-top),1rem);overflow-y:auto}
.preg-title{font-size:1.2rem;font-weight:700;color:var(--ac);margin-bottom:.3rem}
.preg-sub{font-size:.75rem;color:var(--t3);margin-bottom:1.5rem;line-height:1.5}
.preg-services{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:1.5rem}
.preg-svc{padding:.7rem .6rem;background:var(--s1);border:1.5px solid rgba(255,255,255,.06);border-radius:12px;color:var(--t2);font-size:.75rem;font-family:inherit;cursor:pointer;text-align:center;transition:.15s}
.preg-svc:active,.preg-svc.selected{background:var(--ac);border-color:var(--ac);color:#fff}
.preg-mp-status{padding:.8rem 1rem;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.2);border-radius:12px;font-size:.75rem;color:var(--ok);text-align:center;margin-bottom:1rem}
.preg-mp-status.pending{background:rgba(251,191,36,.08);border-color:rgba(251,191,36,.2);color:var(--warn)}

/* ONBOARDING */
#onboarding{padding:0;overflow:hidden;background:var(--bg)}
.onb-slides{display:flex;transition:transform .4s cubic-bezier(.22,1,.36,1);height:100%}
.onb-slide{min-width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2.5rem 2rem;text-align:center;position:relative}
.onb-icon{font-size:3.5rem;margin-bottom:1.5rem;opacity:0;animation:fi .8s ease .3s forwards}
.onb-title{font-size:1.4rem;font-weight:800;color:var(--t1);margin-bottom:.6rem;letter-spacing:-.02em;opacity:0;animation:fi .8s ease .5s forwards}
.onb-desc{font-size:.85rem;color:var(--t2);line-height:1.7;max-width:280px;opacity:0;animation:fi .8s ease .7s forwards}
.onb-dots{position:absolute;bottom:max(env(safe-area-inset-bottom),2rem);left:50%;transform:translateX(-50%);display:flex;gap:.5rem}
.onb-dot{width:8px;height:8px;border-radius:50%;background:var(--b1);transition:all .3s}
.onb-dot.active{background:var(--ac);width:24px;border-radius:4px}
.onb-nav{position:absolute;bottom:calc(max(env(safe-area-inset-bottom),2rem) + 2rem);left:50%;transform:translateX(-50%);display:flex;gap:.8rem;align-items:center}
.onb-skip{padding:.5rem 1rem;background:transparent;border:none;color:var(--t3);font-size:.78rem;font-family:inherit;cursor:pointer}
.onb-next{padding:.6rem 1.8rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:14px;color:#fff;font-size:.85rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.04em}
.onb-next:active{transform:scale(.96)}

/* ZODIAC */
/* Zodiac area — poetic, constellation-style */
.zodiac-area{margin-top:.8rem;opacity:0;animation:fi 1.5s ease 5s forwards;display:flex;flex-direction:column;align-items:center;gap:.8rem}
.zodiac-elements{font-size:.68rem;color:var(--t3);letter-spacing:.2em;text-transform:lowercase;font-weight:300}
.zodiac-elements em{color:var(--ac2);font-style:normal;font-weight:500;letter-spacing:.1em}
/* Constellation glyphs — large, elegant, thin */
.zodiac-constellation{display:flex;align-items:center;gap:1.8rem;justify-content:center}
.zc-sign{display:flex;flex-direction:column;align-items:center;gap:.4rem}
.zc-glyph{width:56px;height:56px;border-radius:50%;background:transparent;border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:1.8rem;color:var(--t1);font-weight:200;position:relative;overflow:hidden}
.zc-glyph::before{content:'';position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.06) 0%,transparent 70%)}
.zc-glyph::after{content:'';position:absolute;inset:-1px;border-radius:50%;border:1px solid transparent;background:conic-gradient(from 0deg,rgba(255,107,53,.15),transparent 30%,transparent 70%,rgba(255,61,113,.15)) border-box;-webkit-mask:linear-gradient(#fff 0 0) padding-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude}
.zc-trait{font-size:.52rem;color:var(--t3);text-transform:uppercase;letter-spacing:.15em;font-weight:500}
.zc-name{font-size:.5rem;color:rgba(255,255,255,.2);letter-spacing:.08em;font-weight:400}
.zc-bridge{display:flex;flex-direction:column;align-items:center;gap:.3rem}
.zc-line{width:30px;height:1px;background:linear-gradient(90deg,rgba(255,107,53,.3),rgba(255,61,113,.3));position:relative}
.zc-line::after{content:'';position:absolute;top:-2px;left:50%;transform:translateX(-50%);width:5px;height:5px;border-radius:50%;background:var(--ac);opacity:.4;box-shadow:0 0 8px var(--ac)}
/* Zodiac phrase — pure poetry, no box */
.zodiac-phrase{font-size:.85rem;color:var(--t2);font-style:italic;line-height:1.7;max-width:260px;text-align:center;font-weight:300;letter-spacing:.01em}

/* REVEAL SELFIE v2 — side by side */

/* CONNECTING OVERLAY — after sonic match, before reveal */
/* Connecting overlay — organic cosmos birth */
/* ═══ CONNECTING OVERLAY — ELECTRIC TOUCH ═══ */
/* ═══ CONNECTION OVERLAY — INTENSE LIGHT BEAM ═══ */
.connecting-overlay{position:fixed;inset:0;z-index:150;background:#010104;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.connecting-overlay.active{opacity:1;pointer-events:auto}
.co-canvas-el{position:absolute;inset:0;z-index:0}
/* Text */
.co-text{position:absolute;top:60%;left:50%;transform:translateX(-50%);z-index:6;font-family:'Orbitron',sans-serif;font-size:.58rem;font-weight:500;letter-spacing:.4em;text-transform:uppercase;opacity:0;color:rgba(160,210,255,.5);animation:co-text-in 1.5s ease 1.2s forwards;white-space:nowrap}
.co-nick{position:absolute;bottom:12%;left:50%;transform:translateX(-50%) translateY(60px);z-index:7;font-family:'Orbitron',sans-serif;font-size:clamp(.95rem,4.5vw,1.8rem);font-weight:900;letter-spacing:.12em;text-transform:uppercase;opacity:0;white-space:nowrap;pointer-events:none;padding:.4em 1em;border-radius:2em;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.06);box-shadow:0 0 30px rgba(100,180,255,.08),inset 0 0 20px rgba(100,180,255,.03);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);animation:co-nick-in 2.5s ease 0.6s forwards}
.connecting-overlay.first .co-nick{color:rgba(255,160,80,.85);border-color:rgba(255,130,50,.12);box-shadow:0 0 30px rgba(255,130,50,.1),inset 0 0 20px rgba(255,130,50,.04);text-shadow:0 0 20px rgba(255,130,50,.4)}
.connecting-overlay.renewed .co-nick{color:rgba(180,210,240,.8);border-color:rgba(150,200,255,.1);box-shadow:0 0 30px rgba(150,200,255,.08),inset 0 0 20px rgba(150,200,255,.03);text-shadow:0 0 20px rgba(150,200,255,.3)}
@keyframes co-nick-in{0%{opacity:0;transform:translateX(-50%) translateY(60px);letter-spacing:.4em;filter:blur(12px)}30%{opacity:1;transform:translateX(-50%) translateY(10px);filter:blur(2px)}60%{letter-spacing:.15em;transform:translateX(-50%) translateY(-2px);filter:blur(0)}100%{opacity:1;letter-spacing:.12em;transform:translateX(-50%) translateY(0);filter:blur(0)}}
.co-brand{position:absolute;top:52%;left:50%;transform:translateX(-50%);z-index:5;font-family:'Orbitron',sans-serif;font-size:1.8rem;font-weight:900;letter-spacing:.15em;text-transform:uppercase;opacity:0;color:rgba(255,255,255,.04);animation:co-brand-in 2s ease 0.8s forwards;white-space:nowrap;pointer-events:none}
@keyframes co-brand-in{0%{opacity:0;letter-spacing:.6em;filter:blur(12px)}60%{opacity:1;filter:blur(0)}100%{opacity:1;letter-spacing:.15em;filter:blur(0)}}
.connecting-overlay.first .co-brand{color:rgba(255,140,60,.06)}
.connecting-overlay.renewed .co-brand{color:rgba(180,210,240,.06)}
@keyframes co-text-in{0%{opacity:0;letter-spacing:.8em;filter:blur(8px)}100%{opacity:1;letter-spacing:.35em;filter:blur(0)}}
/* Progress bar */
.co-progress{position:absolute;top:calc(60% + 20px);left:50%;transform:translateX(-50%);width:100px;height:1px;background:rgba(100,180,255,.08);border-radius:1px;z-index:6;opacity:0;animation:co-prog-in .4s ease 1.5s forwards;overflow:hidden}
@keyframes co-prog-in{to{opacity:1}}
.co-progress-bar{width:0;height:100%;background:linear-gradient(90deg,transparent,rgba(120,200,255,.8),transparent);border-radius:1px;animation:co-prog-fill 3.5s cubic-bezier(.4,.0,.2,1) 0.5s forwards}
@keyframes co-prog-fill{0%{width:0}20%{width:15%}50%{width:40%}75%{width:65%}90%{width:85%}100%{width:100%}}
/* Flash */
.co-flash{position:absolute;inset:0;z-index:7;pointer-events:none;opacity:0}
.connecting-overlay.active .co-flash{animation:co-fullflash 4s ease forwards}
@keyframes co-fullflash{0%{opacity:0}5%{opacity:.6}9%{opacity:0}55%{opacity:.1}60%{opacity:0}100%{opacity:0}}
/* Color themes */
.connecting-overlay.first .co-flash{background:radial-gradient(circle at 50% 50%,rgba(255,130,50,.5),rgba(255,90,20,.2),transparent 60%)}
.connecting-overlay.first .co-text{color:rgba(255,160,80,.6)}
.connecting-overlay.first .co-progress-bar{background:linear-gradient(90deg,transparent,rgba(255,130,50,.8),transparent)}
.connecting-overlay.renewed .co-flash{background:radial-gradient(circle at 50% 50%,rgba(100,200,255,.5),rgba(40,100,255,.2),transparent 60%)}
.connecting-overlay.renewed .co-text{color:rgba(160,210,255,.6)}

/* UTILS */
.hidden{display:none!important}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);padding:.7rem 1.5rem;background:rgba(24,24,36,.92);border:1px solid rgba(255,255,255,.1);border-radius:20px;color:var(--t1);font-size:.82rem;z-index:9999;pointer-events:none;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);box-shadow:0 8px 32px rgba(0,0,0,.4);max-width:85%;text-align:center;font-weight:500}
@keyframes toast-in{0%{opacity:0;transform:translateX(-50%) translateY(12px) scale(.95)}100%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}
@keyframes toast-out{0%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}100%{opacity:0;transform:translateX(-50%) translateY(-8px) scale(.95)}}
@keyframes tin{from{opacity:0;transform:translateX(-50%) translateY(12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
::-webkit-scrollbar{width:2px}::-webkit-scrollbar-thumb{background:var(--b1);border-radius:2px}
</style>
</head>
<body>

<div class="connecting-overlay" id="connectingOverlay">
  <canvas class="co-canvas-el" id="coCanvas"></canvas>
  <div class="co-flash" id="coFlash"></div>
  <div class="co-nick" id="coNick"></div>
  <div class="co-brand">Touch?</div>
  <div class="co-text" id="coText">estabelecendo conexões...</div>
  <div class="co-progress"><div class="co-progress-bar"></div></div>
</div>

<svg width="0" height="0" style="position:absolute"><defs><linearGradient id="verifiedGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#06b6d4"/><stop offset="50%" stop-color="#3b82f6"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient></defs></svg>
<div id="splash" class="screen active">
  <div class="logo">Touch?</div>
  <div class="tag">tudo nasce no gesto</div>
  <div style="position:absolute;bottom:max(env(safe-area-inset-bottom),2rem);font-size:.55rem;color:var(--t3);letter-spacing:.15em;opacity:.4">touchirl v3.0</div>
</div>

<div id="onboarding" class="screen">
  <div class="onb-slides" id="onbSlides">
    <div class="onb-slide">
      <div class="onb-icon">&#x2726;</div>
      <div class="onb-title">Tudo nasce no gesto</div>
      <div class="onb-desc">Touch? transforma encontros em momentos conscientes. Conexões só existem quando duas pessoas decidem estar presentes.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x1F91D;</div>
      <div class="onb-title">Toque para conectar</div>
      <div class="onb-desc">Encoste os celulares, mostre o QR ou use código. Vocês se conectam por 24 horas.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x23F3;</div>
      <div class="onb-title">24 horas, depois se dissolve</div>
      <div class="onb-desc">Cada conexão dura 24h. Conversem, presenteiem, declarem. Se quiserem mais tempo, encostem de novo.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x1F525;</div>
      <div class="onb-title">Streaks e estrelas</div>
      <div class="onb-desc">Encontros seguidos criam streaks com conquistas. Relações especiais geram estrelas que ficam para sempre no seu perfil.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x2648;</div>
      <div class="onb-title">Signos e compatibilidade</div>
      <div class="onb-desc">A cada encontro, os astros falam. Uma frase única baseada nos signos dos dois revela a energia da conexão.</div>
    </div>
  </div>
  <div class="onb-nav">
    <button class="onb-skip" onclick="skipOnboarding()">Pular</button>
    <button class="onb-next" id="onbNextBtn" onclick="nextOnbSlide()">Próximo</button>
  </div>
  <div class="onb-dots" id="onbDots"></div>
</div>

<div id="login" class="screen">
  <div class="login-logo">Touch?</div>
  <div class="login-sub">encontros reais, conexões efêmeras</div>

  <!-- TAB SELECTOR -->
  <div class="auth-tabs" id="authTabs">
    <button class="auth-tab active" id="tabEntrar" onclick="switchAuthTab('login')">Entrar</button>
    <button class="auth-tab" id="tabCriar" onclick="switchAuthTab('register')">Criar conta</button>
  </div>

  <!-- LOGIN FORM -->
  <div class="login-form" id="loginForm">
    <input type="email" class="login-input" id="loginEmail" placeholder="E-mail" autocomplete="email">
    <input type="password" class="login-input" id="loginPass" placeholder="Senha" autocomplete="current-password">
    <button class="bp" id="loginBtn" onclick="loginWithEmail()">ENTRAR</button>
    <div class="login-err" id="loginErr"></div>
    <div onclick="forgotPassword()" style="color:var(--t3);cursor:pointer;font-size:.72rem;text-align:center;margin-top:.2rem">Esqueci minha senha</div>
  </div>

  <!-- REGISTER FORM -->
  <div class="login-form hidden" id="registerForm">
    <input type="text" class="login-input" id="loginNick" placeholder="Nickname (seu nome anônimo)" maxlength="20" autocomplete="off" oninput="checkNickLogin(this.value)">
    <div class="nick-feedback" id="nickFeedbackLogin"></div>
    <div class="login-nick-explain" id="loginNickExplain">⚠️ Não coloque seu nome real! O nick é sua máscara — só você decide quando revelar.</div>
    <input type="email" class="login-input" id="regEmail" placeholder="E-mail" autocomplete="email">
    <input type="password" class="login-input" id="regPass" placeholder="Crie uma senha (mín. 6 caracteres)" autocomplete="new-password">
    <div class="tc" id="loginTermsUso" style="margin:.2rem 0"><input type="checkbox" id="loginTermsCheck"><span style="font-size:.78rem">Li e aceito os <a href="/termos" target="_blank" style="color:var(--ac);text-decoration:underline">Termos de Uso</a></span></div>
    <button class="bp" id="regBtn" onclick="registerWithEmail()">CRIAR CONTA</button>
    <div class="login-err" id="regErr"></div>
  </div>

  <!-- MAGIC LINK -->
  <div class="login-form hidden" id="magicLoginWrap">
    <div style="font-size:.78rem;color:var(--t2);margin-bottom:.3rem;text-align:center">Receba um link de acesso no seu email:</div>
    <input type="email" class="login-input" id="magicEmail" placeholder="seu@email.com" autocomplete="email">
    <button class="bp" onclick="sendMagicLink()">Enviar link de acesso</button>
    <div class="login-err" id="magicErr"></div>
    <div onclick="hideMagicLogin()" style="color:var(--t3);cursor:pointer;font-size:.72rem;text-align:center;margin-top:.2rem">← Voltar</div>
  </div>

  <!-- DIVIDER -->
  <div class="login-divider" id="authDivider">ou</div>

  <!-- SOCIAL LOGINS -->
  <div class="social-btns" id="socialBtns">
    <button class="login-social login-google" onclick="loginWithGoogle()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
      Continuar com Google
    </button>
    <button class="login-social login-apple" onclick="loginWithApple()">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/></svg>
      Continuar com Apple
    </button>
    <button class="login-social login-phone" onclick="showPhoneAuth()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
      Continuar com Telefone (SMS)
    </button>
  </div>

  <!-- PHONE AUTH FORM -->
  <div class="phone-auth-wrap" id="phoneAuthWrap">
    <div style="font-size:.78rem;color:var(--t2);margin-bottom:.5rem;text-align:center">Digite seu número para receber um SMS:</div>
    <div class="phone-row">
      <select id="phoneCountry">
        <option value="+55">🇧🇷 +55</option>
        <option value="+1">🇺🇸 +1</option>
        <option value="+351">🇵🇹 +351</option>
        <option value="+34">🇪🇸 +34</option>
        <option value="+44">🇬🇧 +44</option>
      </select>
      <input type="tel" class="login-input" id="phoneNumber" placeholder="(11) 99999-9999" autocomplete="tel" style="margin:0">
    </div>
    <div id="recaptchaBox"></div>
    <button class="bp" id="phoneSendBtn" onclick="sendSmsCode()" style="margin-top:.3rem">Enviar código SMS</button>
    <div class="login-err" id="phoneErr"></div>
    <!-- SMS Code Input -->
    <div class="sms-code-wrap" id="smsCodeWrap">
      <div style="font-size:.78rem;color:var(--ok);margin-bottom:.4rem">✅ Código enviado!</div>
      <input type="text" class="login-input" id="smsCode" placeholder="000000" maxlength="6" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code">
      <button class="bp" onclick="verifySmsCode()" style="margin-top:.4rem">Verificar código</button>
      <div onclick="sendSmsCode()" style="color:var(--t3);cursor:pointer;font-size:.68rem;margin-top:.3rem">Reenviar código</div>
    </div>
    <div onclick="hidePhoneAuth()" style="color:var(--t3);cursor:pointer;font-size:.72rem;text-align:center;margin-top:.4rem">← Voltar</div>
  </div>

  <!-- MAGIC LINK SHORTCUT -->
  <div id="authMagicLink" onclick="showMagicLogin()" style="color:var(--ac);cursor:pointer;font-size:.72rem;text-align:center;margin-top:.6rem">Entrar sem senha (link por email)</div>
</div>

<div id="register" class="screen">
  <div class="rh"><h1>Touch?</h1><p>complete sua presença</p></div>
  <div class="avs">
    <div class="avp" id="avatarPreview" style="background:var(--s2)">?</div>
    <div class="nick-hint" id="nickHint">escolha um apelido criativo</div>
  </div>
  <div class="fg"><label>Nickname</label><input type="text" id="regNick" placeholder="apelido_criativo" maxlength="20" autocomplete="off" oninput="checkNick(this.value)"></div>
  <div class="nick-feedback" id="nickFeedback"></div>
  <div class="reg-nick-info">⚠️ Não coloque seu nome real! O nick protege sua identidade — só você decide quando revelar quem é. Seja criativo!</div>
  <div class="fg"><label>Data de nascimento</label><input type="date" id="regBirth"></div>
  <div class="tc"><input type="checkbox" id="regTerms"><span>Entendo e aceito que <strong>todas as relações aqui são temporárias</strong>. Nada persiste sem encontro.</span></div>
  <div class="tc"><input type="checkbox" id="regTermsUso"><span>Li e aceito os <a href="/termos" target="_blank" style="color:var(--ac);text-decoration:underline">Termos de Uso</a></span></div>
  <button class="bp" onclick="doRegister()">ENTRAR</button>
</div>

<div id="home" class="screen">
  <!-- Floating event button (persistent while event active) - positioned below daily counter -->
  <div id="floatingEventBtn" style="display:none;position:absolute;top:12%;left:50%;transform:translateX(-50%);z-index:8;padding:.45rem .9rem;background:rgba(96,165,250,.12);backdrop-filter:blur(12px);border:1px solid rgba(96,165,250,.25);border-radius:16px;cursor:pointer;animation:mi .35s ease both;white-space:nowrap" onclick="reopenEventView()">
    <span style="font-size:.7rem;font-weight:600;color:#60a5fa">📍 <span id="floatingEventName"></span> · Ver evento</span>
  </div>
  <canvas id="homeNodesCanvas" style="position:absolute;inset:0;z-index:0;pointer-events:none"></canvas>
  <div class="ptr-indicator" id="ptrIndicator"><div class="ptr-spinner"></div></div>
  <div class="fire-overlay" id="fireOverlay">
    <div class="fire-glow"></div><div class="fire-glow2"></div>
    <div class="fire-particles"><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div></div>
    <div class="fire-edge left"></div><div class="fire-edge right"></div>
    <div class="fire-speaker"><div class="fire-spk-wave"></div><div class="fire-spk-wave"></div><div class="fire-spk-wave"></div></div>
    <div class="sonic-instruct" id="sonicInstruct">
      <div class="si-scene">
        <div class="si-phone left">
          <div class="si-speaker"><div class="si-spk-dot"></div><div class="si-spk-dot"></div><div class="si-spk-dot"></div></div>
        </div>
        <div class="si-energy">
          <div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div>
        </div>
        <div class="si-glow"></div>
        <div class="si-phone right">
          <div class="si-speaker"><div class="si-spk-dot"></div><div class="si-spk-dot"></div><div class="si-spk-dot"></div></div>
        </div>
      </div>
      <div class="si-label">🔊 alto-falante ↔ alto-falante 🔊</div>
      <div class="si-text">Encoste os <em>alto-falantes</em><br>um no outro</div>
    </div>
  </div>
  <!-- TOP: perfil+nick+nome real à esquerda, chat+rede à direita -->
  <div class="home-top">
    <div class="home-user" onclick="showMyProfileSheet()">
      <div class="verified-wrap">
        <div class="home-avatar" id="homeAvatar"></div>
        <div class="verified-badge hidden" id="homeVerifiedBadge"><svg viewBox="0 0 24 24"><path fill="url(#verifiedGrad)" d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5 12 21.04l3.4 1.46 1.89-3.19 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.8 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.34z"/></svg></div>
      </div>
      <div class="home-user-info">
        <div class="hg" id="homeGreeting">Olá</div>
        <div class="home-realname" id="homeRealName"></div>
        <div class="home-verified-row">
          <div class="cd" id="connDot"></div>
          <div class="home-stars-mini hidden" id="homeStarsMini"></div>
        </div>
      </div>
    </div>
    <div class="home-icons">
      <div class="constellation-btn hidden" id="constBtn" onclick="showHistory()" style="position:relative">&#x2726;<span class="network-badge hidden" id="networkBadge" style="position:absolute;top:-4px;right:-4px;min-width:14px;height:14px;border-radius:7px;background:#3b82f6;font-size:.5rem;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;padding:0 3px;border:2px solid var(--bg);line-height:1">0</span></div>
      <div class="rb hidden" id="relBadge" onclick="showRelations()">&#x1F4AC;<span class="ct" id="relCount">0</span></div>
    </div>
  </div>
  <!-- CENTER: botão TOUCH grande -->
  <div class="hc">
    <div class="service-toggle hidden" id="serviceToggle" onclick="toggleServiceMode()"><span id="serviceToggleIcon" style="display:inline-flex;align-items:center"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a4 4 0 0 0-8 0v2"/></svg></span> <span id="serviceToggleLabel">Modo Serviço</span></div>
    <div class="hm" id="homeMotivation">Nada acontece<br>à distância.</div>
    <div style="position:relative;display:flex;align-items:center;justify-content:center">
      <div class="sonic-bars left" id="sonicBarsL"><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div></div>
      <button class="be" id="mainBtn" onclick="handleMainButton()">
        <span class="be-icon"><svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><!-- Phone 1 --><rect x="8" y="10" width="14" height="24" rx="3" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.45)" stroke-width="1.2"/><circle cx="15" cy="30" r="1.2" fill="rgba(255,255,255,.3)"/><!-- Phone 2 --><rect x="26" y="14" width="14" height="24" rx="3" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.45)" stroke-width="1.2"/><circle cx="33" cy="34" r="1.2" fill="rgba(255,255,255,.3)"/><!-- Connection waves --><path d="M22 22 Q24 20 26 22" stroke="rgba(255,107,53,.6)" stroke-width="1.2" fill="none" stroke-linecap="round"/><path d="M21 19 Q24 16 27 19" stroke="rgba(255,107,53,.4)" stroke-width="1" fill="none" stroke-linecap="round"/><path d="M20 16 Q24 12 28 16" stroke="rgba(255,107,53,.25)" stroke-width=".8" fill="none" stroke-linecap="round"/></svg></span>
        <span class="be-text" id="mainBtnText">TOUCH</span>
      </button>
      <div class="sonic-bars right" id="sonicBarsR"><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div></div>
    </div>
    <div class="sonic-status" id="sonicHomeStatus"></div>
    <div class="sonic-fallback" id="sonicFallback">
      <button class="bs" onclick="startEncounter()" style="font-size:.75rem">&#x1F511; Conectar por código</button>
    </div>
    <div class="daily-counter hidden" id="dailyCounter" onclick="showEncounterLog()"><strong id="dailyNum">0</strong> <span id="dailyLabel">Toques em 24h</span> <span class="dc-arrow">›</span></div>
  </div>
  <!-- BOTTOM: minimal — only location + tutorial -->
  <div class="home-bottom">
    <div class="home-nav">
      <button class="hn-btn" onclick="openLocationScreen()"><span class="hn-ico"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></span><span class="hn-lbl" data-i18n="loc_btn">Local</span></button>
      <button class="hn-btn" onclick="showTutorial()"><span class="hn-ico"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span><span class="hn-lbl">Tutorial</span></button>
    </div>
    <div class="home-brand-row">
      <span class="home-brand" id="homeBrand">Touch?</span>
    </div>
  </div>
</div>

<div id="encounter" class="screen">
  <div class="ep active" id="phaseChoose">
    <div class="et">Como vão se encontrar?</div>
    <button class="bp" style="max-width:280px" onclick="createSession()">GERAR CÓDIGO</button>
    <div class="od">ou</div>
    <div class="cir"><input type="text" id="joinCodeInput" placeholder="ENC-000" maxlength="7" autocomplete="off"><button onclick="joinSession()">&#x2192;</button></div>
    <div class="od">ou</div>
    <button class="bp" style="max-width:280px;background:linear-gradient(135deg,#ff6b35,#e05520)" onclick="startSonicMode()">📲 TOUCH — encostar celulares</button>
    <button class="bs" style="margin-top:1.5rem" onclick="goHome()">&#x2190; Voltar</button>
  </div>
  <div class="ep" id="phaseBump">
    <div class="et">Encoste seu celular no da outra pessoa</div>
    <div class="bump-circle" id="bumpCircle">
      <span style="font-size:2rem">📳</span>
      <span style="font-size:.7rem;font-weight:600;letter-spacing:.1em;color:rgba(255,255,255,.85)" id="bumpLabel">PREPARANDO...</span>
    </div>
    <div style="font-size:.75rem;color:var(--t3);max-width:240px;text-align:center;line-height:1.6" id="bumpStatus">Ativando sensores...</div>
    <button class="bs" onclick="stopSonicMode();showPhase('phaseChoose')">&#x2190; Cancelar</button>
  </div>
  <div class="ep" id="phaseCode">
    <div class="et">Peça para a outra pessoa digitar:</div>
    <div class="cdsp" id="sessionCode">ENC-000</div>
    <div class="qb"><canvas id="qrCanvas"></canvas></div>
    <div style="font-size:.75rem;color:var(--t3)">Esperando alguém conectar...</div>
    <div class="wd"><span>&#x25CF;</span><span>&#x25CF;</span><span>&#x25CF;</span></div>
    <button class="bs" onclick="goHome()">Cancelar</button>
  </div>
</div>

<div id="reveal" class="screen">
  <canvas id="rvLightBeam" class="rv-light-beam"></canvas>
  <div class="rv-birth-star" id="rvBirthStar"></div>
  <div class="rv-birth-orb" id="rvOrbL"></div>
  <div class="rv-birth-orb" id="rvOrbR"></div>
  <div class="rv-wrap">
    <div class="rv-center">
      <div class="rv-moment" id="revealMoment">algo nasceu entre vocês</div>
      <div class="rv-phrase" id="revealPhrase"></div>
      <div class="rv-sub">essa é a marca desse encontro</div>
      <div class="rv-avatars" id="revealAvatars">
        <div class="rv-avatar-wrap" id="rvAvatarMe">
          <div class="rv-avatar-inner" id="rvAvatarMeInner"></div>
          <div class="rv-avatar-name" id="rvNameMe"></div>
        </div>
        <div class="rv-connection-symbol">
          <div class="rv-connection-dot"></div>
        </div>
        <div class="rv-avatar-wrap" id="rvAvatarThem">
          <div class="rv-avatar-inner" id="rvAvatarThemInner"></div>
          <div class="rv-avatar-name" id="rvNameThem"></div>
        </div>
      </div>
      <div class="rv-renewed hidden" id="revealRenewed">vocês se encontraram de novo</div>
      <div class="rv-last hidden" id="revealLast"></div>
      <div id="zodiacArea" class="zodiac-area hidden"></div>
    </div>
    <canvas id="selfieCanvas" style="display:none"></canvas>

    <!-- ═══ SELFIE MODAL ═══ -->
    <div class="selfie-modal-bg" id="selfieModalBg" onclick="if(event.target===this)closeSelfieModal()">
      <div class="selfie-modal">
        <div class="selfie-border"></div>
        <div class="selfie-header">
          <h3 id="sfTitle">📸 Registrem esse momento!</h3>
          <div class="selfie-phrase" id="sfPhrase">Vocês se encontraram... agora sorriam!</div>
        </div>
        <div class="selfie-emojis" id="sfEmojis">🎉 😄 ✨ 💫 🤳</div>
        <div class="selfie-camera-area" id="sfCameraArea">
          <div class="sf-placeholder" id="sfPlaceholder">📷</div>
          <video id="selfieVideo" autoplay playsinline style="display:none"></video>
          <img id="sfCapturedImg" class="sf-captured" style="display:none">
        </div>
        <div class="selfie-actions" id="sfActions">
          <button class="sf-btn sf-btn-close" onclick="closeSelfieModal()">Fechar</button>
          <button class="sf-btn sf-btn-capture" id="sfCaptureBtn" onclick="selfieCapture()">📸 Tirar Selfie</button>
        </div>
      </div>
    </div>
    <div class="rv-actions" id="revealActions">
      <div class="rv-btn-row" id="rvIconRow">
        <button type="button" class="rv-icon-btn primary" id="revealEnterBtn" onclick="enterChat()"><span class="rv-ic"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></span><span>Chat</span></button>
        <button type="button" class="rv-icon-btn" id="selfieCapBtn" onclick="revealCaptureSelfie()"><span class="rv-ic"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg></span><span>Selfie</span></button>
        <button type="button" class="rv-icon-btn tip hidden" id="revealTipBtn" onclick="openTipFromReveal()"><span class="rv-ic"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg></span><span id="revealTipLabel">Gorjeta</span></button>
        <button type="button" class="rv-icon-btn skip" id="revealSkipBtn" onclick="goHome()"><span class="rv-ic"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg></span><span>Pular</span></button>
      </div>
      <div class="rv-sec-row" id="rvSecRow"></div>
    </div>
  </div>
</div>

<div id="chat" class="screen">
  <!-- Clean header: back + name + timer pill -->
  <div class="ch">
    <div class="chl">
      <button class="chb" onclick="goHome()">&#x2190;</button>
      <div class="ch-info" onclick="showPartnerProfile()">
        <span class="chn" id="chatPartner">Pessoa</span>
        <span class="ch-sub" id="chatSub"></span>
      </div>
    </div>
    <div class="cht" id="chatTimer">23:59:59</div>
  </div>
  <!-- Phrase banner -->
  <div class="cpb" id="chatPhrase"></div>
  <!-- Streak (collapsible) -->
  <div class="streak-info hidden" id="chatStreak"><span id="chatStreakText"></span><div class="streak-progress"><div class="streak-bar" id="chatStreakBar"></div></div><span id="chatStreakNext" style="font-size:.6rem;color:var(--t3)"></span></div>
  <div id="contactRequestArea"></div>
  <!-- Messages -->
  <div class="cms" id="chatMessages"><div class="ti" id="typingIndicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
  <!-- Quick phrases -->
  <div class="qp-bar" id="quickPhrases"></div>
  <!-- Bottom: input + expandable menu -->
  <div class="chat-bottom" style="position:relative">
    <!-- ID action buttons (only visible when relevant) -->
    <div class="chat-id-bar" id="chatIdBar">
      <button class="id-pill reveal" onclick="revealMyself(state.currentPartnerId)" type="button" id="revealIdBtn">🪪 Revelar ID</button>
    </div>
    <!-- Plus menu (all actions here) -->
    <div class="plus-menu" id="plusMenu">
      <button class="pm-item" onclick="pickPhoto();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(88,166,255,.15);color:#58a6ff">📷</div><span class="pm-label">Foto</span></button>
      <button class="pm-item" onclick="requestSelfie();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(255,200,87,.12);color:#ffc857">🤳</div><span class="pm-label">Selfie</span></button>
      <button class="pm-item" onclick="openContactMenu();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(163,113,247,.12);color:#a371f7">📲</div><span class="pm-label">Contato</span></button>
      <button class="pm-item" onclick="openGiftPicker();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(255,107,53,.12);color:var(--ac)">🎁</div><span class="pm-label">Presente</span></button>
      <button class="pm-item" onclick="openDeclModal();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(52,211,153,.12);color:var(--ok)">📝</div><span class="pm-label">Declarar</span></button>
      <button class="pm-item" onclick="sendPulse();closePlusMenu()" type="button" id="pulseBtn"><div class="pm-ico" style="background:rgba(255,61,113,.12);color:var(--pk)">💗</div><span class="pm-label">Pulsar</span></button>
      <button class="pm-item" onclick="getHoroscope();closePlusMenu()" type="button" id="horoscopeBtn"><div class="pm-ico" style="background:rgba(251,191,36,.12);color:#fbbf24">✨</div><span class="pm-label">Horóscopo</span></button>
      <button class="pm-item" onclick="pickFile();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(255,255,255,.06);color:var(--t2)">📎</div><span class="pm-label">Arquivo</span></button>
    </div>
    <!-- Input row -->
    <div class="cia">
      <div class="cia-wrap">
        <button class="cia-plus" onclick="togglePlusMenu()" type="button">+</button>
        <input type="text" id="chatInput" placeholder="Mensagem..." maxlength="500" autocomplete="off">
      </div>
      <button class="sb" id="sendBtn" onclick="sendMessage()" type="button">&#x2191;</button>
    </div>
  </div>
  <!-- Hidden partner pts for JS reference -->
  <span class="hidden" id="partnerPts"><strong id="partnerPtsNum">0</strong></span>
</div>

<div id="relations" class="screen">
  <div class="rlh"><button class="chb" onclick="goHome()">&#x2190;</button><h2>Conversas ativas</h2><span class="rlh-sub" id="relSubtitle"></span></div>
  <div class="rll" id="relationsList"></div>
</div>

<div id="history" class="screen">
  <div class="const-header">
    <button class="chb" onclick="goHome()">&#x2190;</button>
    <h2>Minha Rede</h2>
    <button id="constSearchToggle" onclick="toggleConstSearch()" style="margin-left:auto;background:none;border:1px solid rgba(255,255,255,.1);border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--t3);flex-shrink:0;transition:all .2s"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></button>
  </div>
  <div id="constSearchOverlay" class="const-search-overlay hidden">
    <div style="display:flex;align-items:center;gap:.4rem;background:rgba(10,10,25,.85);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:.35rem .6rem;max-width:280px;width:90%;backdrop-filter:blur(12px)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="2.5" style="flex-shrink:0"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input id="constSearchInput" type="text" placeholder="Buscar pessoa..." oninput="onConstSearch(this.value)" style="flex:1;background:none;border:none;outline:none;color:#fff;font-size:.72rem;font-family:inherit;padding:.15rem 0">
      <button onclick="clearConstSearch();toggleConstSearch()" style="background:none;border:none;color:rgba(255,255,255,.4);font-size:.9rem;cursor:pointer;padding:0 .1rem;line-height:1">✕</button>
    </div>
    <div id="constSearchCount" style="font-size:.55rem;color:var(--t3);text-align:center;margin-top:.3rem;min-height:.8rem"></div>
  </div>
  <div class="const-copy"><p>Aqui ficam os encontros.<br>O resto passou.</p></div>
  <div class="const-feedback" id="constFeedback"></div>
  <div class="notif-btn" id="constNotifBtn" onclick="toggleNotifPanel()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg><span class="notif-badge hidden" id="constNotifBadge">0</span></div>
  <div class="const-canvas-wrap"><canvas id="constCanvas"></canvas>
    <div id="constLoader" class="const-loader hidden">
      <div class="const-loader-inner">
        <svg class="const-loader-svg" viewBox="0 0 80 80" width="64" height="64">
          <circle cx="40" cy="40" r="6" fill="rgba(255,255,255,.9)"/>
          <circle cx="40" cy="40" r="20" fill="none" stroke="rgba(255,255,255,.15)" stroke-width="1.5"/>
          <circle cx="40" cy="40" r="34" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="1"/>
          <circle class="const-loader-orbit1" cx="60" cy="40" r="3" fill="#9b59b6"/>
          <circle class="const-loader-orbit2" cx="40" cy="14" r="2.2" fill="#6c5ce7"/>
          <circle class="const-loader-orbit3" cx="20" cy="52" r="1.8" fill="#a29bfe"/>
        </svg>
        <div class="const-loader-text">Carregando rede...</div>
      </div>
    </div>
  </div>
  <div class="const-empty hidden" id="constEmpty">
    <div class="const-empty-icon">✦</div>
    <div class="const-empty-text">Nenhum encontro ainda.<br>Dê um touch em alguém para começar sua rede.</div>
  </div>
  <!-- Notification panel -->
  <div class="notif-panel" id="notifPanel">
    <div class="notif-header"><button class="notif-close" onclick="toggleNotifPanel()">←</button><div class="notif-title">Atividade</div></div>
    <div id="notifList"><div class="notif-empty">Carregando...</div></div>
  </div>
  <!-- Redesigned detail card v2 -->
  <div class="const-detail" id="constDetail">
    <div class="cd-handle" id="cdHandle"></div>
    <button class="cd-close" onclick="hideConstDetail()">✕</button>
    <!-- Hero: horizontal — avatar left, info right -->
    <div class="cd-hero">
      <div class="cd-avatar-wrap">
        <div class="cd-avatar" id="cdAvatar"></div>
        <div class="cd-stars-orbit" id="cdStarsOrbit"></div>
        <div class="verified-badge hidden" id="cdVerifiedBadge" style="position:absolute;bottom:0;right:-2px;width:18px;height:18px"><svg viewBox="0 0 24 24"><path fill="url(#verifiedGrad)" d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5 12 21.04l3.4 1.46 1.89-3.19 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.8 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.34z"/></svg></div>
      </div>
      <div class="cd-hero-info">
        <div class="cd-name" id="cdName"></div>
        <div class="cd-alias" id="cdAlias"></div>
        <div class="cd-stats" id="cdStats"></div>
        <div class="cd-profile-tags" id="cdProfileTags" style="display:none;flex-wrap:wrap;gap:.3rem;margin-top:.3rem"></div>
        <div class="cd-anon-preview hidden" id="cdAnonPreview">
          <div class="cd-anon-ball" id="cdAnonBall"></div>
          <span class="cd-anon-nick" id="cdAnonNick"></span>
          <span class="cd-anon-label">anônimo</span>
        </div>
      </div>
    </div>
    <div class="cd-divider"></div>
    <!-- Meta: time, social, selfies -->
    <div class="cd-section" id="cdMeta"></div>
    <!-- Icon actions -->
    <div class="cd-actions" id="cdActions" onclick="event.stopPropagation()"></div>
    <!-- Tip is now an icon button in cdActions -->
    <!-- Declarations mural (visible directly, no collapse) -->
    <div class="cd-section" id="cdDeclSection">
      <div class="cd-decl-mural" id="cdDeclBody"></div>
      <div class="hidden" id="cdDeclareWrap" onclick="event.stopPropagation()">
        <div class="cd-decl-add">
          <input type="text" id="cdDeclareInput" placeholder="Deixe uma declaração..." maxlength="120">
          <button onclick="sendDeclaration()">Enviar</button>
        </div>
      </div>
    </div>
    <!-- History is now an icon button in cdActions -->
  </div>
  <!-- History floating panel -->
  <div class="cd-history-panel" id="cdHistoryPanel">
    <div class="cd-handle" onclick="closeHistoryPanel()"></div>
    <div style="display:flex;align-items:center;padding:.3rem 1rem;gap:.5rem">
      <span style="font-size:.7rem;font-weight:600;color:var(--t1)">Histórico</span>
      <span style="flex:1"></span>
      <button onclick="closeHistoryPanel()" style="background:none;border:none;color:var(--t3);font-size:.8rem;cursor:pointer">✕</button>
    </div>
    <div class="cd-history-scroll" id="cdHistoryScroll"><div style="font-size:.6rem;color:var(--t3);text-align:center;padding:1rem">Carregando...</div></div>
  </div>
  <!-- Selfie zoom overlay -->
  <div class="cd-selfie-zoom" id="selfieZoom" onclick="closeSelfieZoom()">
    <img id="selfieZoomImg" src="" alt="">
    <button class="cd-zoom-delete" id="selfieZoomDelete" onclick="event.stopPropagation();deleteSelfieFromZoom()">Apagar foto</button>
  </div>
</div>

<div id="expireCard" class="screen">
  <div class="ev"><div class="cl">Touch?</div><div class="cf" id="cardPhrase"></div><div class="ctm" id="cardTime"></div><div class="cft">tudo nasce no gesto</div></div>
  <div class="ea"><button class="bs" onclick="goHome()">Voltar</button><button class="bp" style="max-width:160px" onclick="shareCard()">Compartilhar</button></div>
</div>

<div id="boardingPass" class="screen">
  <div class="bp-card" id="bpCard">
    <div class="bp-top"><div class="bp-logo">Touch?</div><div class="bp-type" style="font-size:.55rem;letter-spacing:.15em;color:var(--t3)">PASSE</div></div>
    <div class="bp-body" style="padding:.8rem 1.2rem;text-align:center">
      <!-- Identity row: avatar + name -->
      <div style="display:flex;align-items:center;gap:.6rem;justify-content:center;margin-bottom:.8rem">
        <div class="verified-wrap">
          <div class="bp-avatar" id="bpAvatar" style="width:44px;height:44px;border-radius:50%;font-size:.95rem;font-weight:800;display:flex;align-items:center;justify-content:center;border:1.5px solid rgba(255,255,255,.1)"></div>
          <div class="verified-badge hidden" id="bpVerifiedBadge"><svg viewBox="0 0 24 24"><path fill="url(#verifiedGrad)" d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5 12 21.04l3.4 1.46 1.89-3.19 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.8 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.34z"/></svg></div>
        </div>
        <div style="text-align:left">
          <div class="bp-name" id="bpName" style="font-size:1rem;font-weight:800;margin:0;color:#fff">Nome</div>
          <div class="bp-since" id="bpSince" style="font-size:.5rem;color:var(--t3);margin:.1rem 0 0"></div>
        </div>
      </div>
      <!-- QR Code — center and prominent -->
      <div style="background:#fff;border-radius:16px;padding:12px;margin:0 auto .6rem;display:inline-block">
        <div id="touchQRArea" style="display:flex;align-items:center;justify-content:center;min-width:180px;min-height:180px"></div>
      </div>
      <div style="font-size:.55rem;color:var(--t3);margin-bottom:.1rem">Escaneie para conectar</div>
      <div class="touch-link-url" id="touchLinkUrl" style="font-size:.48rem;color:var(--t3);margin-bottom:.5rem;word-break:break-all;opacity:.5">Gerando...</div>
      <button class="bs" onclick="copyTouchLink()" type="button" style="font-size:.6rem;margin-bottom:.6rem;padding:.3rem .7rem;opacity:.7">Copiar link</button>
      <!-- Stats row -->
      <div style="display:flex;justify-content:center;gap:1rem;padding:.5rem 0;border-top:1px solid rgba(255,255,255,.04)">
        <div style="text-align:center"><div style="font-size:.85rem;font-weight:800;color:#fbbf24" id="bpStars">0</div><div style="font-size:.45rem;color:var(--t3);letter-spacing:.06em">estrelas</div></div>
        <div style="text-align:center"><div style="font-size:.85rem;font-weight:800;color:var(--t1)" id="bpPeople">0</div><div style="font-size:.45rem;color:var(--t3);letter-spacing:.06em">pessoas</div></div>
        <div style="text-align:center"><div style="font-size:.85rem;font-weight:800;color:#ff6b8a" id="bpLikes">0</div><div style="font-size:.45rem;color:var(--t3);letter-spacing:.06em">curtidas</div></div>
        <div style="text-align:center"><div style="font-size:.85rem;font-weight:800;color:var(--ac)" id="bpScore">0</div><div style="font-size:.45rem;color:var(--t3);letter-spacing:.06em">score</div></div>
      </div>
      <div style="margin-top:.2rem"><span id="bpTag" style="font-size:.55rem;font-weight:700;color:#ffd700;background:rgba(255,215,0,.08);padding:.12rem .45rem;border-radius:8px">—</span></div>
    </div>
    <div class="bp-footer">TUDO NASCE NO GESTO</div>
  </div>
  <div class="bp-actions">
    <button class="bs" onclick="goHome()">Voltar</button>
    <button class="bp-dl" onclick="downloadBoardingPass()">Salvar Imagem</button>
  </div>
</div>

<div id="locationScreen" class="screen">
  <div class="loc-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 data-i18n="loc_title">Explorar ao redor</h2><button class="bs" style="font-size:.7rem;padding:.3rem .8rem" onclick="showCreateEvent()" data-i18n="create_event_btn">+ Evento</button></div>
  <div class="loc-scroll" id="locScroll">
    <div class="loc-status" id="locStatus" data-i18n="loc_activate">Ative sua localização para descobrir pessoas e eventos.</div>
    <div class="loc-tabs">
      <div class="loc-tab active" id="tabNearby" onclick="switchLocTab('nearby')" data-i18n="tab_nearby">Pessoas</div>
      <div class="loc-tab" id="tabEvents" onclick="switchLocTab('events')" data-i18n="tab_events">Eventos</div>
    </div>
    <div id="locContent"></div>
  </div>
</div>

<div id="eventDetail" class="screen">
  <div class="loc-header"><button class="chb" onclick="showScreen('locationScreen')">&#x2190;</button><h2 id="evtDetailTitle">Evento</h2></div>
  <div class="loc-scroll" id="evtDetailScroll"></div>
</div>

<!-- GORJETA SCREEN -->
<div id="tipScreen" class="screen">
  <div class="tip-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 style="font-size:1rem;font-weight:600">Gorjeta</h2></div>
  <div class="tip-receiver" id="tipReceiver"></div>
  <div class="tip-amounts">
    <button class="tip-amount-btn" onclick="selectTipAmount(2)">R$2</button>
    <button class="tip-amount-btn" onclick="selectTipAmount(5)">R$5</button>
    <button class="tip-amount-btn" onclick="selectTipAmount(10)">R$10</button>
    <button class="tip-amount-btn" onclick="selectTipAmount(20)">R$20</button>
  </div>
  <div class="tip-custom">
    <label>Outro valor:</label>
    <input type="number" id="tipCustomAmount" placeholder="R$" min="1" max="500" oninput="selectTipCustom()">
  </div>

  <!-- PAYMENT METHODS — unified picker -->
  <div id="tipPayMethods" style="margin-top:.8rem;display:flex;flex-direction:column;gap:.5rem">

    <!-- 1. SAVED CARD + CVV -->
    <div id="tipSavedCard" style="display:none">
      <div style="background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.15);border-radius:16px;padding:.8rem">
        <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.6rem">
          <div style="width:40px;height:28px;border-radius:5px;background:linear-gradient(135deg,#1a1a2e,#2d2d44);display:flex;align-items:center;justify-content:center;font-size:.6rem;color:rgba(255,255,255,.5);flex-shrink:0" id="tipSavedBrandIcon">CARD</div>
          <div style="flex:1">
            <div id="tipSavedCardLabel" style="font-size:.75rem;font-weight:700;color:var(--t1)"></div>
            <div style="font-size:.5rem;color:var(--t3)">Cartão salvo</div>
          </div>
          <div style="width:7px;height:7px;border-radius:50%;background:#10b981;flex-shrink:0"></div>
        </div>
        <div style="display:flex;gap:.4rem;align-items:center">
          <input type="text" id="tipSavedCVV" class="tip-input" placeholder="CVV" inputmode="numeric" maxlength="4" autocomplete="cc-csc" style="width:80px;text-align:center;flex-shrink:0" oninput="validateSavedCVV()">
          <button class="tip-pay-btn" id="tipQuickPayBtn" onclick="quickPay()" disabled style="flex:1;background:linear-gradient(135deg,#6366f1,#4f46e5);font-size:.8rem;padding:.65rem;border-radius:12px;border:none;color:#fff;font-weight:700;font-family:inherit;cursor:pointer">Pagar</button>
        </div>
        <div style="display:flex;justify-content:center;gap:1rem;margin-top:.4rem">
          <button onclick="showNewCardForm()" style="padding:.15rem;border:none;background:transparent;color:var(--t3);font-size:.52rem;font-family:inherit;cursor:pointer">Usar outro cartão</button>
          <button onclick="removeSavedCard()" style="padding:.15rem;border:none;background:transparent;color:var(--err);font-size:.52rem;font-family:inherit;cursor:pointer;opacity:.6">Remover</button>
        </div>
      </div>
    </div>

    <!-- 2. MERCADO PAGO — redirect -->
    <button id="tipMPBtn" onclick="payWithMercadoPago()" style="display:flex;align-items:center;gap:.6rem;width:100%;padding:.7rem .8rem;border-radius:14px;border:1px solid rgba(0,158,227,.2);background:rgba(0,158,227,.06);cursor:pointer;font-family:inherit;transition:all .2s">
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none"><circle cx="14" cy="14" r="13" fill="#009ee3" stroke="#009ee3" stroke-width=".5"/><path d="M7 17.5c0-3.5 2.5-7.5 7-7.5s7 4 7 7.5" stroke="#fff" stroke-width="2" stroke-linecap="round" fill="none"/><path d="M9 17c0-2.5 2-5.5 5-5.5s5 3 5 5.5" stroke="#fff" stroke-width="1.5" stroke-linecap="round" fill="none"/><circle cx="14" cy="17" r="1.5" fill="#fff"/></svg>
      <div style="flex:1;text-align:left">
        <div style="font-size:.75rem;font-weight:700;color:#009ee3">Mercado Pago</div>
        <div style="font-size:.5rem;color:var(--t3)">Cartão, saldo ou parcelado</div>
      </div>
      <span style="font-size:.6rem;color:var(--t3)">→</span>
    </button>

    <!-- 3. PIX -->
    <button id="tipPixToggle" onclick="togglePixSection()" style="display:flex;align-items:center;gap:.6rem;width:100%;padding:.7rem .8rem;border-radius:14px;border:1px solid rgba(0,220,130,.15);background:rgba(0,220,130,.04);cursor:pointer;font-family:inherit;transition:all .2s">
      <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#00dc82,#00b36b);display:flex;align-items:center;justify-content:center;font-size:.75rem;color:#fff;font-weight:800;flex-shrink:0">P</div>
      <div style="flex:1;text-align:left">
        <div style="font-size:.75rem;font-weight:700;color:#00dc82">PIX</div>
        <div style="font-size:.5rem;color:var(--t3)">Instantâneo, sem taxa</div>
      </div>
      <span style="font-size:.6rem;color:var(--t3)">→</span>
    </button>

    <!-- 4. NEW CARD (hidden, shows on "Usar outro cartão") -->
    <button id="tipNewCardToggle" onclick="showNewCardForm()" style="display:flex;align-items:center;gap:.6rem;width:100%;padding:.6rem .8rem;border-radius:14px;border:1px dashed rgba(99,102,241,.2);background:transparent;cursor:pointer;font-family:inherit">
      <div style="width:28px;height:28px;border-radius:50%;background:rgba(99,102,241,.1);display:flex;align-items:center;justify-content:center;font-size:.7rem;color:#6366f1;font-weight:700;flex-shrink:0">+</div>
      <div style="font-size:.7rem;font-weight:600;color:var(--t2)">Adicionar cartão</div>
    </button>
  </div>

  <!-- NEW CARD FORM — expandable -->
  <div id="tipNewCard" style="display:none;margin-top:.6rem">
    <div style="background:rgba(99,102,241,.05);border:1px solid rgba(99,102,241,.12);border-radius:16px;padding:.8rem">
      <div style="font-size:.65rem;font-weight:600;color:var(--t2);margin-bottom:.3rem;text-align:center">Dados do cartão</div>
      <div style="display:flex;justify-content:center;gap:.3rem;margin-bottom:.4rem">
        <div style="padding:2px 5px;border-radius:3px;background:#1a1f71;color:#fff;font-size:.42rem;font-weight:800;letter-spacing:.5px">VISA</div>
        <div style="padding:2px 5px;border-radius:3px;background:#eb001b;color:#fff;font-size:.42rem;font-weight:800">MC</div>
        <div style="padding:2px 5px;border-radius:3px;background:#006fcf;color:#fff;font-size:.42rem;font-weight:800">AMEX</div>
        <div style="padding:2px 5px;border-radius:3px;background:#000;color:#fff;font-size:.42rem;font-weight:800">ELO</div>
        <div style="padding:2px 5px;border-radius:3px;background:#8b2131;color:#fff;font-size:.42rem;font-weight:800">HIPER</div>
      </div>
      <div style="position:relative"><input type="text" id="tipCardNumber" class="tip-input" placeholder="Número do cartão" inputmode="numeric" maxlength="19" autocomplete="cc-number" oninput="formatCardNumber(this)" style="padding-right:50px"><div id="tipCardBrandIcon" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:36px;height:24px;border-radius:4px;background:linear-gradient(135deg,#1a1a2e,#2d2d44);display:flex;align-items:center;justify-content:center;font-size:.55rem;color:rgba(255,255,255,.5);font-weight:700;transition:all .2s">CARD</div></div>
      <div style="display:flex;gap:.4rem;margin-top:.4rem">
        <input type="text" id="tipCardExpiry" class="tip-input" placeholder="MM/AA" inputmode="numeric" maxlength="5" autocomplete="cc-exp" oninput="formatExpiry(this)" style="flex:1">
        <input type="text" id="tipCardCVV" class="tip-input" placeholder="CVV" inputmode="numeric" maxlength="4" autocomplete="cc-csc" style="flex:1">
      </div>
      <input type="text" id="tipCardHolder" class="tip-input" placeholder="Nome no cartão" autocomplete="cc-name" style="margin-top:.4rem">
      <input type="text" id="tipCardCPF" class="tip-input" placeholder="CPF do titular" inputmode="numeric" maxlength="14" oninput="formatCPF(this)" style="margin-top:.4rem">
      <div style="display:flex;align-items:center;gap:.4rem;margin-top:.4rem">
        <input type="checkbox" id="tipSaveCardCheck" checked style="accent-color:#6366f1">
        <label for="tipSaveCardCheck" style="font-size:.55rem;color:var(--t3)">Salvar cartão</label>
      </div>
      <button class="tip-pay-btn" id="tipCardPayBtn" onclick="payWithNewCard()" disabled style="margin-top:.5rem;background:linear-gradient(135deg,#6366f1,#4f46e5);display:flex;align-items:center;justify-content:center;gap:.4rem"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg> Pagar com cartão</button>
      <div style="display:flex;align-items:center;justify-content:center;gap:.5rem;margin-top:.4rem;padding:.25rem;border-radius:8px;background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.12)">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        <span style="font-size:.45rem;color:#22c55e;font-weight:600">Pagamento seguro</span>
        <span style="font-size:.45rem;color:var(--t3)">•</span>
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
        <span style="font-size:.45rem;color:#22c55e;font-weight:600">SSL</span>
      </div>
      <div style="text-align:center;margin-top:.2rem;font-size:.4rem;color:var(--t3)">Dados criptografados e processados pelo Mercado Pago.</div>
    </div>
  </div>

  <!-- PIX SECTION — expandable -->
  <div id="tipPixSection" style="display:none;margin-top:.6rem">
    <div style="background:rgba(0,220,130,.04);border:1px solid rgba(0,220,130,.12);border-radius:16px;padding:.8rem">
      <div style="font-size:.6rem;color:var(--t3);text-align:center;margin-bottom:.5rem;line-height:1.4">PIX — qualquer banco, instantâneo</div>
      <input type="email" id="tipPixEmail" class="tip-input" placeholder="Seu e-mail" autocomplete="email" style="margin-bottom:.4rem">
      <input type="text" id="tipPixCPF" class="tip-input" placeholder="Seu CPF" inputmode="numeric" maxlength="14" autocomplete="off" oninput="formatCPF(this)">
      <button class="tip-pay-btn" id="tipPixBtn" onclick="processPixTip()" disabled style="margin-top:.5rem;background:linear-gradient(135deg,#00dc82,#00b36b)">Gerar PIX</button>
      <div id="tipPixQR" class="hidden" style="text-align:center;padding:.8rem 0">
        <div style="font-size:.7rem;font-weight:600;color:var(--ok);margin-bottom:.4rem">PIX gerado! Escaneie ou copie:</div>
        <img id="tipPixQRImg" style="width:180px;height:180px;border-radius:10px;background:#fff;padding:6px" alt="QR Code PIX">
        <div style="margin-top:.5rem">
          <button onclick="copyPixCode()" style="padding:.35rem .8rem;border-radius:10px;background:rgba(0,220,130,.12);border:1px solid rgba(0,220,130,.25);color:#00dc82;font-size:.65rem;font-weight:600;font-family:inherit;cursor:pointer">Copiar código PIX</button>
        </div>
        <input type="hidden" id="tipPixCode">
        <div style="font-size:.5rem;color:var(--t3);margin-top:.4rem">Expira em 30 minutos.</div>
      </div>
    </div>
  </div>

  <div class="tip-result hidden" id="tipResult">
    <div class="tip-result-icon" id="tipResultIcon"></div>
    <div class="tip-result-text" id="tipResultText"></div>
    <button class="bs" onclick="goHome()" style="margin-top:.8rem">Voltar</button>
  </div>
</div>

<!-- PRESTADOR DASHBOARD -->
<div id="prestadorDash" class="screen">
  <div class="tip-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 style="font-size:1rem;font-weight:600">Meu Painel</h2></div>
  <div id="pdContent" style="padding:.5rem .8rem;overflow-y:auto;max-height:calc(100vh - 60px)">
    <!-- Stats cards -->
    <div id="pdStats" style="display:grid;grid-template-columns:1fr 1fr;gap:.4rem;margin-bottom:.8rem"></div>
    <!-- Period cards -->
    <div id="pdPeriods" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.4rem;margin-bottom:.8rem"></div>
    <!-- MP connection status -->
    <div id="pdMpStatus" style="margin-bottom:.8rem"></div>
    <!-- Recent tips -->
    <div style="font-size:.75rem;font-weight:700;color:var(--t1);margin-bottom:.4rem">Gorjetas recebidas</div>
    <div id="pdTips" style="margin-bottom:1rem"></div>
    <!-- Recent encounters -->
    <div style="font-size:.75rem;font-weight:700;color:var(--t1);margin-bottom:.4rem">Encostadas recebidas</div>
    <div id="pdEncounters"></div>
  </div>
</div>

<!-- PRESTADOR REGISTER SCREEN -->
<div id="prestadorReg" class="screen">
  <div class="tip-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 style="font-size:1rem;font-weight:600">Cadastro de Prestador</h2></div>
  <div class="preg-title">Receba gorjetas pelo Touch?</div>
  <div class="preg-sub">Cadastre-se como prestador de serviço para receber pagamentos de gorjeta diretamente no seu celular.</div>
  <div class="fg"><label>Nome completo</label><input type="text" id="pregName" placeholder="Seu nome"></div>
  <div class="fg"><label>Nickname</label><input type="text" id="pregNick" placeholder="Como vão te encontrar" maxlength="20" oninput="checkPregNick(this.value)"><div class="nick-hint" id="pregNickHint"></div></div>
  <div class="fg"><label>CPF (opcional)</label><input type="text" id="pregCPF" placeholder="000.000.000-00" maxlength="14"></div>
  <div class="fg"><label>Data de nascimento</label><input type="date" id="pregBirth"></div>
  <div class="fg"><label>Tipo de serviço</label></div>
  <div class="preg-services" id="pregServices"></div>
  <div class="preg-mp-status pending" id="pregMpStatus" style="display:none">
    <span id="pregMpText">Conecte sua conta MercadoPago para receber pagamentos</span>
  </div>
  <button class="bp" id="pregSubmitBtn" onclick="registerPrestador()" style="margin-bottom:.8rem">Criar conta de prestador</button>
  <button class="bs" id="pregMpBtn" onclick="connectMercadoPago()" style="display:none;margin-bottom:.8rem;width:100%">🔗 Conectar MercadoPago</button>
  <button class="bs" onclick="goHome()" style="width:100%;margin-bottom:2rem;opacity:.6">← Voltar</button>
</div>

<div id="encounterLog" class="screen">
  <div class="elog-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2>Histórico</h2></div>
  <div style="display:flex;gap:.35rem;padding:.5rem .8rem .3rem;overflow-x:auto;-webkit-overflow-scrolling:touch;position:sticky;top:0;z-index:2;background:var(--bg)" id="elogFilters">
    <button class="elog-filter active" onclick="filterElog('all',this)">Todos</button>
    <button class="elog-filter" onclick="filterElog('people',this)">Pessoas</button>
    <button class="elog-filter" onclick="filterElog('service',this)">Serviços</button>
    <button class="elog-filter" onclick="filterElog('payments',this)">Pagamentos</button>
  </div>
  <div class="elog-list" id="elogList"></div>
</div>

<div id="completeProfile" class="screen">
  <div class="cp-top-bar"><button class="chb" onclick="goHome()">&#x2190;</button><span>Cadastro</span><button class="chb" onclick="saveCompleteProfile()">Salvar</button></div>
  <div class="cp-scroll">
    <!-- Photo -->
    <div class="cp-photo-wrap">
      <div class="cp-photo" id="cpPhotoPreview" onclick="$('cpPhotoInput').click()">
        <span id="cpPhotoPlaceholder" style="font-size:1.6rem;color:var(--t3)">📷</span>
      </div>
      <div class="cp-photo-label" onclick="$('cpPhotoInput').click()">Alterar foto</div>
      <input type="file" id="cpPhotoInput" accept="image/*" style="display:none" onchange="handleProfilePhoto(this)">
    </div>
    <!-- Avatar Accessory Selector -->
    <div class="cp-section-title">Avatar Anônimo</div>
    <div class="cp-note" style="text-align:center;margin:-.2rem 0 .5rem;font-size:.6rem;color:var(--t3)">Escolha um acessório para sua silhueta</div>
    <div id="cpAccessoryGrid" style="display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-bottom:1rem;padding:0 .5rem">
      <!-- Filled by JS -->
    </div>
    <div id="cpAccessoryLock" style="display:none;text-align:center;font-size:.6rem;color:var(--t3);margin:-.4rem 0 .8rem">
      <span style="color:#8b5cf6">Touch Plus</span> ou <span style="color:#fbbf24">Top 1</span> desbloqueiam acessórios
    </div>

    <!-- Identity -->
    <div class="cp-section-title">Identidade</div>
    <div class="cp-field"><label>Apelido</label><input type="text" id="cpNickname" placeholder="seu_apelido" maxlength="20" autocomplete="off"><div class="cp-note">Como todos te veem antes de revelar</div></div>
    <div class="cp-field"><label>Nome real</label><input type="text" id="cpRealName" placeholder="Seu nome completo" maxlength="60"></div>
    <div class="cp-field"><label>Bio</label><textarea id="cpBio" placeholder="Conte algo sobre você..." maxlength="200"></textarea></div>
    <!-- Sobre Você -->
    <div class="cp-section-title">Sobre Você</div>
    <div class="cp-field"><label>Profissão</label><input type="text" id="cpProfession" placeholder="Ex: Designer, Engenheiro, DJ..." maxlength="40"></div>
    <div class="cp-field"><label>Esportes <span style="font-size:.55rem;color:var(--t3);font-weight:400">(até 2)</span></label>
      <div id="cpSportsGrid" class="cp-tag-grid"></div>
    </div>
    <div class="cp-field"><label>Hobbies / Música <span style="font-size:.55rem;color:var(--t3);font-weight:400">(até 2)</span></label>
      <div id="cpHobbiesGrid" class="cp-tag-grid"></div>
    </div>
    <!-- Verification -->
    <div class="cp-section-title">Verificação</div>
    <div class="cp-verif-row">
      <button class="cp-verif-card" id="cpEmailCard" onclick="resendEmailVerification()">
        <div class="cp-verif-ico">✉</div>
        <div class="cp-verif-label">Email</div>
        <div class="cp-verif-status" id="cpEmailStatus">verificar</div>
      </button>
      <button class="cp-verif-card" id="cpFaceCard" onclick="goHome();setTimeout(()=>showFaceEnrollment(),100)">
        <div class="cp-verif-ico">⎔</div>
        <div class="cp-verif-label">Face ID</div>
        <div class="cp-verif-status" id="cpFaceStatus">configurar</div>
      </button>
      <button class="cp-verif-card" id="cpDocCard" onclick="goHome();setTimeout(()=>showDocIdScreen(),100)">
        <div class="cp-verif-ico">⊡</div>
        <div class="cp-verif-label">Doc ID</div>
        <div class="cp-verif-status" id="cpDocStatus">verificar</div>
      </button>
    </div>
    <!-- Social -->
    <div class="cp-section-title">Social</div>
    <div class="cp-field cp-field-privacy"><label>Instagram</label><div class="cp-input-row"><input type="text" id="cpInstagram" placeholder="@seuuser" maxlength="30"><button class="cp-priv-toggle" id="cpPrivInstagram" onclick="toggleCpPriv('Instagram')" title="Visível ao revelar ID"></button></div></div>
    <div class="cp-field cp-field-privacy"><label>TikTok</label><div class="cp-input-row"><input type="text" id="cpTiktok" placeholder="@seuuser" maxlength="30"><button class="cp-priv-toggle" id="cpPrivTiktok" onclick="toggleCpPriv('Tiktok')" title="Visível ao revelar ID"></button></div></div>
    <div class="cp-field cp-field-privacy"><label>X (Twitter)</label><div class="cp-input-row"><input type="text" id="cpTwitter" placeholder="@seuuser" maxlength="30"><button class="cp-priv-toggle" id="cpPrivTwitter" onclick="toggleCpPriv('Twitter')" title="Visível ao revelar ID"></button></div></div>
    <!-- Contact -->
    <div class="cp-section-title">Contato</div>
    <div class="cp-field cp-field-privacy"><label>Telefone</label><div class="cp-input-row"><input type="tel" id="cpPhone" placeholder="+55 11 99999-9999" maxlength="20"><button class="cp-priv-toggle" id="cpPrivPhone" onclick="toggleCpPriv('Phone')" title="Visível ao revelar ID"></button></div></div>
    <div class="cp-field"><label>Email</label><input type="email" id="cpEmail" placeholder="seu@email.com" maxlength="60"><div class="cp-note">Apenas para pagamentos — nunca exibido</div></div>
    <div class="cp-field"><label>CPF</label><input type="text" id="cpCpf" placeholder="000.000.000-00" maxlength="14" inputmode="numeric" oninput="formatCPF(this)"><div class="cp-note">Apenas para pagamentos — nunca exibido</div></div>
    <div style="height:2rem"></div>
  </div>
</div>

<div id="faceEnrollScreen" class="screen">
  <div style="display:flex;align-items:center;padding:.8rem 1rem;background:rgba(18,18,26,.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06)">
    <button class="chb" onclick="stopFaceCamera();goHome()">&#x2190;</button>
    <div style="flex:1;text-align:center;font-size:.9rem;font-weight:700;color:var(--t1)">Face ID</div>
    <div style="width:32px"></div>
  </div>
  <div style="padding:1.2rem;overflow-y:auto;flex:1;display:flex;flex-direction:column;align-items:center;gap:.8rem">
    <div id="faceStatus" style="text-align:center;padding:.4rem;width:100%">
      <div style="font-size:.75rem;color:var(--t2);margin-bottom:.2rem">Cadastro facial para check-in seguro</div>
      <div style="font-size:.55rem;color:var(--t3)">Usado em portarias, eventos e verificações</div>
    </div>
    <!-- Step indicators -->
    <div id="faceSteps" style="display:flex;gap:.3rem;align-items:center;width:100%;justify-content:center;margin:.2rem 0">
      <div class="face-step" id="faceStep1" style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.12);transition:all .3s"></div>
      <div class="face-step" id="faceStep2" style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.12);transition:all .3s"></div>
      <div class="face-step" id="faceStep3" style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.12);transition:all .3s"></div>
      <div class="face-step" id="faceStep4" style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.12);transition:all .3s"></div>
      <div class="face-step" id="faceStep5" style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.12);transition:all .3s"></div>
    </div>
    <div id="faceVideoWrap" style="position:relative;width:220px;height:220px;border-radius:50%;overflow:hidden;border:3px solid rgba(255,255,255,.08);background:#111;display:flex;align-items:center;justify-content:center">
      <video id="faceVideo" autoplay muted playsinline style="width:100%;height:100%;object-fit:cover;transform:scaleX(-1)"></video>
      <div id="faceOverlay" style="position:absolute;inset:0;border-radius:50%;border:3px solid transparent;pointer-events:none;transition:border-color .3s"></div>
      <div id="faceGuide" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.65rem;color:rgba(255,255,255,.5);text-shadow:0 1px 4px rgba(0,0,0,.5)">Posicione seu rosto</div>
      <!-- Scanning animation -->
      <div id="faceScanLine" style="position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#06b6d4,transparent);top:0;opacity:0;transition:opacity .3s;pointer-events:none"></div>
    </div>
    <div id="faceInstructions" style="font-size:.72rem;color:var(--t2);text-align:center;min-height:1.8rem;font-weight:500">Toque em Iniciar para cadastrar</div>
    <div id="faceCaptureCount" style="font-size:.55rem;color:var(--t3)"></div>
    <div style="display:flex;gap:.6rem;margin-top:.3rem">
      <button class="bs" id="faceStartBtn" onclick="startFaceEnroll()" style="padding:.6rem 1.6rem;font-size:.75rem;border-radius:20px">Iniciar</button>
      <button class="bp hidden" id="faceSaveBtn" onclick="saveFaceData()" style="padding:.6rem 1.6rem;font-size:.75rem;border-radius:20px">Salvar Face ID</button>
    </div>
    <div id="faceEnrolledInfo" class="hidden" style="text-align:center;padding:.8rem;background:rgba(0,220,130,.06);border:1px solid rgba(0,220,130,.15);border-radius:12px;width:100%;margin-top:.3rem">
      <div style="font-size:.8rem;font-weight:600;color:var(--ok)">Face ID cadastrado</div>
      <div style="font-size:.55rem;color:var(--t3);margin-top:.2rem">Seu rosto pode ser usado para verificação</div>
      <button class="my-pf-btn my-pf-danger" onclick="removeFaceData()" style="margin-top:.6rem;justify-content:center;font-size:.7rem;padding:.45rem">Remover Face ID</button>
    </div>
    <div style="font-size:.45rem;color:rgba(255,255,255,.15);text-align:center;margin-top:auto;padding:.4rem;line-height:1.5">
      Dados faciais armazenados como vetores matemáticos.<br>
      Foto original não é salva. LGPD Art. 11.
    </div>
  </div>
</div>

<div id="docIdScreen" class="screen">
  <div style="display:flex;align-items:center;padding:.8rem 1rem;background:rgba(18,18,26,.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06)">
    <button class="chb" onclick="goHome()">&#x2190;</button>
    <div style="flex:1;text-align:center;font-size:.9rem;font-weight:700;color:var(--t1)">Doc ID</div>
    <div style="width:32px"></div>
  </div>
  <div style="padding:1.2rem;overflow-y:auto;flex:1;display:flex;flex-direction:column;align-items:center;gap:.8rem">
    <!-- Progress steps -->
    <div id="docStepsBar" style="display:flex;align-items:center;gap:.3rem;width:100%;max-width:280px;margin:0 auto">
      <div id="docStep1" style="flex:1;height:3px;border-radius:2px;background:var(--ac);transition:background .3s"></div>
      <div id="docStep2" style="flex:1;height:3px;border-radius:2px;background:rgba(255,255,255,.1);transition:background .3s"></div>
      <div id="docStep3" style="flex:1;height:3px;border-radius:2px;background:rgba(255,255,255,.1);transition:background .3s"></div>
    </div>
    <div style="text-align:center;padding:.2rem">
      <div id="docStepTitle" style="font-size:.75rem;color:var(--t2);margin-bottom:.15rem;font-weight:600">Passo 1: Foto do documento</div>
      <div id="docStepDesc" style="font-size:.55rem;color:var(--t3)">RG, CNH ou passaporte — frente do documento</div>
    </div>
    <div id="docPreviewWrap" style="width:280px;height:180px;border-radius:16px;overflow:hidden;border:2px dashed rgba(255,255,255,.12);background:rgba(255,255,255,.02);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;transition:border-color .3s" onclick="$('docFileInput').click()">
      <div id="docPlaceholder" style="text-align:center">
        <div style="font-size:1.8rem;margin-bottom:.3rem;opacity:.25">&#9633;</div>
        <div style="font-size:.6rem;color:var(--t3)">Toque para fotografar</div>
      </div>
      <img id="docPreviewImg" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0;display:none">
    </div>
    <input type="file" id="docFileInput" accept="image/*" capture="environment" style="display:none" onchange="handleDocPhoto(this)">
    <div id="docSelfieWrap" class="hidden" style="width:100%;text-align:center">
      <div style="font-size:.65rem;color:var(--t2);margin-bottom:.4rem;font-weight:600">Passo 2: Selfie segurando o documento</div>
      <div style="width:180px;height:180px;border-radius:50%;overflow:hidden;border:3px solid rgba(255,255,255,.08);background:#111;margin:0 auto;cursor:pointer;position:relative;transition:border-color .3s" onclick="$('docSelfieInput').click()">
        <div id="docSelfiePlaceholder" style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;flex-direction:column;gap:.3rem">
          <div style="width:40px;height:40px;border-radius:50%;border:2px dashed rgba(255,255,255,.15)"></div>
          <div style="font-size:.5rem;color:var(--t3)">Toque para selfie</div>
        </div>
        <img id="docSelfieImg" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0;display:none">
      </div>
      <input type="file" id="docSelfieInput" accept="image/*" capture="user" style="display:none" onchange="handleDocSelfie(this)">
    </div>
    <div id="docNameField" class="hidden" style="width:100%">
      <div style="font-size:.6rem;color:var(--t3);margin-bottom:.25rem;font-weight:500">Passo 3: Dados do documento</div>
      <input type="text" id="docNameInput" placeholder="Nome como está no documento" maxlength="80" style="width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:.5rem .7rem;font-size:.75rem;color:var(--t1);font-family:inherit;outline:none;box-sizing:border-box">
      <div style="font-size:.55rem;color:var(--t3);margin-top:.3rem;margin-bottom:.2rem">CPF (opcional)</div>
      <input type="text" id="docCpfInput" placeholder="000.000.000-00" maxlength="14" inputmode="numeric" oninput="formatCPF(this)" style="width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:.5rem .7rem;font-size:.75rem;color:var(--t1);font-family:inherit;outline:none;box-sizing:border-box">
    </div>
    <button class="bp hidden" id="docSaveBtn" onclick="saveDocId()" style="padding:.65rem 2rem;font-size:.8rem;margin-top:.3rem;border-radius:20px">Enviar para verificação</button>
    <div id="docEnrolledInfo" class="hidden" style="text-align:center;padding:.8rem;background:rgba(0,220,130,.06);border:1px solid rgba(0,220,130,.15);border-radius:12px;width:100%">
      <div style="font-size:.8rem;font-weight:600;color:var(--ok)">Documento enviado</div>
      <div style="font-size:.55rem;color:var(--t3);margin-top:.2rem" id="docStatusText">Aguardando validação</div>
    </div>
    <div style="font-size:.45rem;color:rgba(255,255,255,.15);text-align:center;margin-top:auto;padding:.4rem;line-height:1.5">
      Dados criptografados e armazenados com segurança.<br>
      Usados exclusivamente para verificação. LGPD.<br>
      Conforme LGPD Art. 7 — tratamento de dados pessoais.
    </div>
  </div>
</div>

<div id="eventView" class="screen">
  <div style="display:flex;align-items:center;padding:.6rem 1rem;background:rgba(18,18,26,.9);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06)">
    <button class="chb" onclick="closeEventView()">&#x2190;</button>
    <div style="flex:1;text-align:center">
      <div style="font-size:.75rem;font-weight:700;color:#60a5fa;display:flex;align-items:center;gap:.3rem;justify-content:center"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> Check-in</div>
      <div style="font-size:.9rem;font-weight:600" id="evViewName"></div>
    </div>
    <div style="font-size:.7rem;color:var(--t2)" id="evViewCount">0</div>
  </div>
  <div style="flex:1;position:relative;overflow:hidden;background:#050508;touch-action:none">
    <canvas id="evCanvas" style="width:100%;height:100%;touch-action:none"></canvas>
    <!-- Menu FAB (only if event has menu) -->
    <button id="evMenuBtn" onclick="openEventMenu()" style="display:none;position:absolute;bottom:70px;right:16px;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#f97316,#ef4444);border:none;color:#fff;font-size:1.4rem;cursor:pointer;box-shadow:0 4px 20px rgba(249,115,22,.4);z-index:5;transition:transform .2s" title="Cardápio">🍽</button>
    <div id="evCartBadge" style="display:none;position:absolute;bottom:108px;right:12px;background:#ef4444;color:#fff;border-radius:50%;width:22px;height:22px;font-size:.6rem;font-weight:700;text-align:center;line-height:22px;z-index:6;pointer-events:none">0</div>
    <!-- Leave event button -->
    <button id="evLeaveBtn" onclick="leaveEvent()" style="position:absolute;bottom:16px;left:50%;transform:translateX(-50%);padding:.5rem 1.2rem;background:rgba(255,61,113,.12);border:1px solid rgba(255,61,113,.3);border-radius:14px;color:#ff3d71;font-size:.7rem;font-weight:600;font-family:inherit;cursor:pointer;backdrop-filter:blur(8px);transition:all .2s;z-index:5">Saí do evento</button>
  </div>
  <!-- MENU OVERLAY -->
  <div id="evMenuOverlay" style="display:none;position:absolute;inset:0;background:rgba(5,5,12,.97);z-index:10;overflow-y:auto;-webkit-overflow-scrolling:touch">
    <div style="position:sticky;top:0;background:rgba(10,10,20,.95);backdrop-filter:blur(20px);padding:.7rem 1rem;display:flex;align-items:center;z-index:2;border-bottom:1px solid rgba(255,255,255,.06)">
      <button onclick="closeEventMenu()" style="background:none;border:none;color:#fff;font-size:1.2rem;padding:0;cursor:pointer">←</button>
      <div style="flex:1;text-align:center;font-weight:700;font-size:.85rem">Cardápio</div>
      <button onclick="openCart()" style="background:none;border:none;color:#f97316;font-size:.85rem;font-weight:600;cursor:pointer">🛒 <span id="menuCartCount">0</span></button>
    </div>
    <div id="evMenuCats" style="display:flex;gap:.4rem;padding:.5rem 1rem;overflow-x:auto;-webkit-overflow-scrolling:touch"></div>
    <div id="evMenuItems" style="padding:0 .8rem .8rem"></div>
  </div>
  <!-- CART OVERLAY -->
  <div id="evCartOverlay" style="display:none;position:absolute;inset:0;background:rgba(5,5,12,.97);z-index:11;overflow-y:auto;-webkit-overflow-scrolling:touch">
    <div style="position:sticky;top:0;background:rgba(10,10,20,.95);backdrop-filter:blur(20px);padding:.7rem 1rem;display:flex;align-items:center;z-index:2;border-bottom:1px solid rgba(255,255,255,.06)">
      <button onclick="closeCart()" style="background:none;border:none;color:#fff;font-size:1.2rem;padding:0;cursor:pointer">←</button>
      <div style="flex:1;text-align:center;font-weight:700;font-size:.85rem">Meu Pedido</div>
      <button onclick="clearCart()" style="background:none;border:none;color:#ff3d71;font-size:.7rem;cursor:pointer">Limpar</button>
    </div>
    <div id="evCartItems" style="padding:.8rem"></div>
    <div id="evCartFooter" style="position:sticky;bottom:0;background:rgba(10,10,20,.95);backdrop-filter:blur(20px);padding:.8rem 1rem;border-top:1px solid rgba(255,255,255,.06)"></div>
  </div>
</div>

<div id="profile" class="screen">
  <div class="pf-header"><button class="chb" onclick="closeProfile()">&#x2190;</button><h2 id="pfTitle">Perfil</h2></div>
  <div class="pf-scroll" id="pfScroll"></div>
</div>

<!-- SUBSCRIPTION SCREEN -->
<div id="subscriptionScreen" class="screen">
  <div class="tip-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 style="font-size:1rem;font-weight:600">Touch? Plus</h2></div>
  <div style="padding:0 1.2rem;overflow-y:auto;flex:1">
    <!-- Current status -->
    <div id="subCurrentStatus" style="margin-bottom:1rem"></div>
    <!-- Plan card -->
    <div style="background:linear-gradient(145deg,rgba(99,102,241,.12),rgba(168,85,247,.1));border:1px solid rgba(99,102,241,.25);border-radius:18px;padding:1.5rem;text-align:center;margin-bottom:1rem">
      <div style="font-size:2rem;margin-bottom:.4rem">✦</div>
      <div style="font-size:1.3rem;font-weight:800;background:linear-gradient(135deg,#818cf8,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent">Touch? Plus</div>
      <div style="font-size:1.6rem;font-weight:800;color:var(--t1);margin:.5rem 0">R$9,90<span style="font-size:.7rem;font-weight:400;color:var(--t3)">/mês</span></div>
      <div id="subBenefitsList" style="text-align:left;margin:.8rem auto;max-width:260px"></div>
      <!-- Subscription payment methods -->
      <div id="subPayMethods" style="margin-top:.8rem;display:flex;flex-direction:column;gap:.4rem;text-align:left">
        <!-- Saved card + CVV -->
        <div id="subSavedCard" style="display:none">
          <div style="background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.15);border-radius:14px;padding:.7rem">
            <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
              <div style="width:36px;height:24px;border-radius:4px;background:linear-gradient(135deg,#1a1a2e,#2d2d44);display:flex;align-items:center;justify-content:center;font-size:.5rem;color:rgba(255,255,255,.5);flex-shrink:0" id="subSavedBrandIcon">CARD</div>
              <div style="flex:1">
                <div id="subSavedCardLabel" style="font-size:.7rem;font-weight:700;color:var(--t1)"></div>
                <div style="font-size:.45rem;color:var(--t3)">Cartão salvo</div>
              </div>
            </div>
            <div style="display:flex;gap:.3rem;align-items:center">
              <input type="text" id="subSavedCVV" class="tip-input" placeholder="CVV" inputmode="numeric" maxlength="4" style="width:70px;text-align:center;flex-shrink:0" oninput="validateSubCVV()">
              <button id="subCardPayBtn" onclick="subscribeWithCard()" disabled style="flex:1;background:linear-gradient(135deg,#6366f1,#8b5cf6);font-size:.75rem;padding:.6rem;border-radius:12px;border:none;color:#fff;font-weight:700;font-family:inherit;cursor:pointer">Assinar</button>
            </div>
          </div>
        </div>
        <!-- Mercado Pago -->
        <button onclick="startSubscription()" style="display:flex;align-items:center;gap:.5rem;width:100%;padding:.6rem .7rem;border-radius:14px;border:1px solid rgba(0,158,227,.2);background:rgba(0,158,227,.06);cursor:pointer;font-family:inherit">
          <svg width="24" height="24" viewBox="0 0 28 28" fill="none"><circle cx="14" cy="14" r="13" fill="#009ee3"/><path d="M7 17.5c0-3.5 2.5-7.5 7-7.5s7 4 7 7.5" stroke="#fff" stroke-width="2" stroke-linecap="round" fill="none"/><path d="M9 17c0-2.5 2-5.5 5-5.5s5 3 5 5.5" stroke="#fff" stroke-width="1.5" stroke-linecap="round" fill="none"/><circle cx="14" cy="17" r="1.5" fill="#fff"/></svg>
          <div style="flex:1;text-align:left"><div style="font-size:.7rem;font-weight:700;color:#009ee3">Mercado Pago</div><div style="font-size:.45rem;color:var(--t3)">Cartão, saldo ou parcelado</div></div>
          <span style="font-size:.55rem;color:var(--t3)">→</span>
        </button>
        <!-- PIX -->
        <button onclick="subscribeWithPix()" style="display:flex;align-items:center;gap:.5rem;width:100%;padding:.6rem .7rem;border-radius:14px;border:1px solid rgba(0,220,130,.15);background:rgba(0,220,130,.04);cursor:pointer;font-family:inherit">
          <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#00dc82,#00b36b);display:flex;align-items:center;justify-content:center;font-size:.65rem;color:#fff;font-weight:800;flex-shrink:0">P</div>
          <div style="flex:1;text-align:left"><div style="font-size:.7rem;font-weight:700;color:#00dc82">PIX</div><div style="font-size:.45rem;color:var(--t3)">Instantâneo, sem taxa</div></div>
          <span style="font-size:.55rem;color:var(--t3)">→</span>
        </button>
        <!-- Add card -->
        <button onclick="showSubNewCard()" style="display:flex;align-items:center;gap:.5rem;width:100%;padding:.5rem .7rem;border-radius:14px;border:1px dashed rgba(99,102,241,.2);background:transparent;cursor:pointer;font-family:inherit">
          <div style="width:24px;height:24px;border-radius:50%;background:rgba(99,102,241,.1);display:flex;align-items:center;justify-content:center;font-size:.6rem;color:#6366f1;font-weight:700;flex-shrink:0">+</div>
          <div style="font-size:.65rem;font-weight:600;color:var(--t2)">Adicionar cartão</div>
        </button>
      </div>
      <div id="subActionBtn" style="display:none"></div>
      <div style="font-size:.5rem;color:var(--t3);margin-top:.5rem;text-align:center">Cancele quando quiser. Renovação mensal R$9,90.</div>
    </div>
    <!-- FAQ -->
    <div style="font-size:.7rem;color:var(--t3);padding:.5rem 0 2rem">
      <div style="font-weight:600;color:var(--t2);margin-bottom:.4rem">Perguntas frequentes</div>
      <div style="margin-bottom:.4rem"><strong style="color:var(--t2)">Como funciona?</strong> Ao assinar, você é redirecionado para o Mercado Pago para confirmar. O pagamento é recorrente mensal.</div>
      <div style="margin-bottom:.4rem"><strong style="color:var(--t2)">Posso cancelar?</strong> Sim, a qualquer momento. Basta clicar em "Cancelar assinatura" aqui no perfil.</div>
      <div><strong style="color:var(--t2)">Os benefícios são imediatos?</strong> Sim! Assim que o pagamento for confirmado, sua conta é atualizada automaticamente.</div>
    </div>
  </div>
</div>

<div id="giftModal" class="hidden"></div>
<div id="declModal" class="hidden"></div>

<div id="encostaReqArea"></div>
<div id="toast" class="toast hidden"></div>

<script src="https://sdk.mercadopago.com/js/v2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
const $=id=>document.getElementById(id);
let socket=null,state={userId:localStorage.getItem('touch_userId'),userName:localStorage.getItem('touch_userName'),userColor:localStorage.getItem('touch_userColor')||'',userPhoto:localStorage.getItem('touch_userPhoto')||null,email:localStorage.getItem('touch_email')||null,currentSession:null,currentRelation:null,timerInterval:null};
let typingTimeout=null,lastTypingEmit=0,pulseSent=false;

// ═══ FIREBASE AUTH ═══
let firebaseApp=null, firebaseAuthInstance=null, fbUser=null, loginIsRegister=false;

(async function initFirebase(){
  try{
    const r=await fetch('/api/firebase-config');
    const cfg=await r.json();
    firebaseApp=firebase.initializeApp(cfg);
    firebaseAuthInstance=firebase.auth();
    // Listen for auth state changes
    firebaseAuthInstance.onAuthStateChanged(async(user)=>{
      fbUser=user;
      if(user&&!state.userId){
        // User is signed in via Firebase but not linked to ENCOSTA yet
        await linkFirebaseToEncosta(user);
      }
    });
  }catch(e){console.warn('Firebase init falhou:',e.message)}
})();

async function linkFirebaseToEncosta(user){
  try{
    const token=await user.getIdToken();
    const r=await fetch('/api/auth/link',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body:JSON.stringify({firebaseUid:user.uid,email:user.email,displayName:user.displayName,photoURL:user.photoURL,phoneNumber:user.phoneNumber||null,encUserId:state.userId||null,nickname:window._pendingNickname||null})
    });
    const d=await r.json();
    if(d.userId){
      state.userId=d.userId;
      state.userName=d.user.nickname||d.user.name;
      state.userColor=d.user.color||'';
      state.userPhoto=d.user.profilePhoto||d.user.photoURL||null;
      state.email=d.user.email||null;
      state.emailVerified=user.emailVerified||false;
      state.userCpf=d.user.cpf||null;
      localStorage.setItem('touch_userId',d.userId);
      localStorage.setItem('touch_userName',state.userName);
      localStorage.setItem('touch_userColor',state.userColor);
      if(state.email)localStorage.setItem('touch_email',state.email);
      if(state.userPhoto)localStorage.setItem('touch_userPhoto',state.userPhoto);
      // If user still needs to set nickname/birthdate, show register
      if(!d.user.birthdate){
        $('regNick').value=state.userName||'';
        showScreen('register');
        return;
      }
      initSocket();requestAccelPermission();
      showScreen('home');
      $('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(state.userName)+'</span>';
      state.userAccessory=d.user.avatarAccessory||null;
      state.userProfession=d.user.profession||null;
      state.userSports=d.user.sports||[];
      state.userHobbies=d.user.hobbies||[];
      const _ha=$('homeAvatar');
      if(_ha&&state.userName){
        _ha.innerHTML=makeAvatar(state.userName,state.userColor||nickColor(state.userName),40,state.userPhoto||null,false,state.userAccessory);
        _ha.style.background='none';_ha.style.overflow='visible';
      }
      refreshHome();
      // Start polling for email verification if not yet verified
      if(!state.emailVerified)startEmailVerificationPoll();
    }
  }catch(e){console.error('Link Firebase erro:',e)}
}

async function loginWithGoogle(){
  try{
    $('loginErr').textContent='';
    const provider=new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({prompt:'select_account'});
    await firebaseAuthInstance.signInWithPopup(provider);
    // onAuthStateChanged will handle the rest
  }catch(e){
    if(e.code==='auth/popup-blocked'){
      // Fallback to redirect
      try{await firebaseAuthInstance.signInWithRedirect(new firebase.auth.GoogleAuthProvider())}catch(e2){$('loginErr').textContent='Erro ao abrir Google. Tente novamente.'}
    }else if(e.code!=='auth/popup-closed-by-user'){
      $('loginErr').textContent='Erro: '+(e.message||'tente novamente');
    }
  }
}

// ═══ APPLE LOGIN ═══
async function loginWithApple(){
  const btn=document.querySelector('.login-apple');
  const origText=btn?btn.innerHTML:'';
  try{
    $('loginErr').textContent='';
    if(btn){btn.textContent='Conectando...';btn.disabled=true;}
    if(!firebaseAuthInstance){
      $('loginErr').textContent='Firebase não carregou. Recarregue a página.';
      return;
    }
    const provider=new firebase.auth.OAuthProvider('apple.com');
    provider.addScope('email');
    provider.addScope('name');
    provider.setCustomParameters({locale:'pt_BR'});
    console.log('[apple] Calling signInWithPopup...');
    const result=await firebaseAuthInstance.signInWithPopup(provider);
    console.log('[apple] Login success:',result.user?.uid);
  }catch(e){
    console.error('[apple] Login error:',e.code,e.message);
    if(e.code==='auth/popup-blocked'){
      try{
        const provider=new firebase.auth.OAuthProvider('apple.com');
        provider.addScope('email');provider.addScope('name');
        await firebaseAuthInstance.signInWithRedirect(provider);
      }catch(e2){$('loginErr').textContent='Erro ao abrir Apple. Tente novamente.';}
    }else if(e.code==='auth/operation-not-allowed'){
      $('loginErr').textContent='Login com Apple não está ativado. Ative no Firebase Console > Authentication > Sign-in method > Apple.';
    }else if(e.code==='auth/internal-error'){
      $('loginErr').textContent='Apple Sign-In não configurado. Configure no Firebase Console.';
    }else if(e.code!=='auth/popup-closed-by-user'){
      $('loginErr').textContent='Erro Apple: '+(e.message||'tente novamente');
    }
  }finally{
    if(btn){btn.innerHTML=origText;btn.disabled=false;}
  }
}

// ═══ PHONE/SMS AUTH ═══
let _phoneConfirmation=null;
let _recaptchaVerifier=null;
let _recaptchaWidgetId=null;

function showPhoneAuth(){
  $('loginForm').classList.add('hidden');
  $('registerForm').classList.add('hidden');
  $('magicLoginWrap').classList.add('hidden');
  $('authTabs').style.display='none';
  $('authDivider').style.display='none';
  $('authMagicLink').style.display='none';
  $('socialBtns').style.display='none';
  $('phoneAuthWrap').style.display='block';
  $('phoneErr').textContent='';
  $('smsCodeWrap').style.display='none';
  $('phoneSendBtn').style.display='';
  // Init reCAPTCHA (invisible)
  setupRecaptcha();
}

function hidePhoneAuth(){
  $('phoneAuthWrap').style.display='none';
  switchAuthTab(loginIsRegister?'register':'login');
}

function setupRecaptcha(){
  if(_recaptchaVerifier)return; // already set up
  try{
    _recaptchaVerifier=new firebase.auth.RecaptchaVerifier('recaptchaBox',{
      size:'normal',
      callback:()=>{console.log('[phone] reCAPTCHA solved')},
      'expired-callback':()=>{
        $('phoneErr').textContent='reCAPTCHA expirou. Recarregue.';
        _recaptchaVerifier=null;
      }
    });
    _recaptchaVerifier.render().then(widgetId=>{_recaptchaWidgetId=widgetId});
  }catch(e){
    console.error('reCAPTCHA setup err:',e);
    $('phoneErr').textContent='Erro ao configurar verificação. Recarregue a página.';
  }
}

async function sendSmsCode(){
  const country=$('phoneCountry').value;
  let phone=$('phoneNumber').value.replace(/\D/g,'');
  $('phoneErr').textContent='';
  if(!phone||phone.length<8)return $('phoneErr').textContent='Digite um número de telefone válido.';
  const fullPhone=country+phone;
  if(!_recaptchaVerifier){
    setupRecaptcha();
    return $('phoneErr').textContent='Resolva o reCAPTCHA primeiro.';
  }
  try{
    $('phoneSendBtn').textContent='Enviando...';$('phoneSendBtn').disabled=true;
    _phoneConfirmation=await firebaseAuthInstance.signInWithPhoneNumber(fullPhone,_recaptchaVerifier);
    // Show code input
    $('smsCodeWrap').style.display='block';
    $('phoneSendBtn').style.display='none';
    $('phoneErr').textContent='';
    $('smsCode').value='';
    $('smsCode').focus();
  }catch(e){
    $('phoneSendBtn').textContent='Enviar código SMS';$('phoneSendBtn').disabled=false;
    const msgs={
      'auth/invalid-phone-number':'Número de telefone inválido.',
      'auth/too-many-requests':'Muitas tentativas. Aguarde antes de tentar novamente.',
      'auth/captcha-check-failed':'Verificação reCAPTCHA falhou. Tente novamente.',
      'auth/quota-exceeded':'Limite de SMS atingido. Tente outro método.'
    };
    $('phoneErr').textContent=msgs[e.code]||('Erro: '+(e.message||'tente novamente'));
    // Reset reCAPTCHA on error
    if(_recaptchaVerifier){
      try{
        grecaptcha.reset(_recaptchaWidgetId);
      }catch(re){}
    }
  }
}

async function verifySmsCode(){
  const code=$('smsCode').value.trim();
  $('phoneErr').textContent='';
  if(!code||code.length<6)return $('phoneErr').textContent='Digite o código de 6 dígitos.';
  if(!_phoneConfirmation)return $('phoneErr').textContent='Envie o SMS primeiro.';
  try{
    await _phoneConfirmation.confirm(code);
    // onAuthStateChanged will handle the rest (link to ENCOSTA)
    $('phoneAuthWrap').style.display='none';
  }catch(e){
    const msgs={
      'auth/invalid-verification-code':'Código inválido. Verifique e tente novamente.',
      'auth/code-expired':'Código expirou. Reenvie o SMS.'
    };
    $('phoneErr').textContent=msgs[e.code]||('Erro: '+(e.message||'código inválido'));
  }
}

function switchAuthTab(tab){
  $('tabEntrar').classList.toggle('active',tab==='login');
  $('tabCriar').classList.toggle('active',tab==='register');
  $('loginForm').classList.toggle('hidden',tab!=='login');
  $('registerForm').classList.toggle('hidden',tab!=='register');
  $('magicLoginWrap').classList.add('hidden');
  $('authTabs').style.display='';
  $('authDivider').style.display='';
  $('authMagicLink').style.display='';
  $('socialBtns').style.display='';
  $('phoneAuthWrap').style.display='none';
  loginIsRegister=tab==='register';
}

async function loginWithEmail(){
  const email=$('loginEmail').value.trim();
  const pass=$('loginPass').value;
  $('loginErr').textContent='';$('loginErr').style.color='var(--err)';
  if(!email||!pass)return $('loginErr').textContent='Preencha e-mail e senha.';
  try{
    await firebaseAuthInstance.signInWithEmailAndPassword(email,pass);
  }catch(e){
    const msgs={'auth/email-already-in-use':'Este e-mail já está cadastrado.','auth/invalid-email':'E-mail inválido.','auth/user-not-found':'Usuário não encontrado.','auth/wrong-password':'Senha incorreta.','auth/invalid-credential':'E-mail ou senha incorretos.','auth/weak-password':'Senha muito fraca (mínimo 6 caracteres).'};
    $('loginErr').textContent=msgs[e.code]||('Erro: '+(e.message||'tente novamente'));
  }
}

async function registerWithEmail(){
  const nick=$('loginNick').value.trim();
  const email=$('regEmail').value.trim();
  const pass=$('regPass').value;
  $('regErr').textContent='';$('regErr').style.color='var(--err)';
  if(!nick||nick.length<2)return $('regErr').textContent='Escolha um nickname (mín. 2 caracteres).';
  if(!email)return $('regErr').textContent='Preencha seu e-mail.';
  if(pass.length<6)return $('regErr').textContent='Senha precisa ter no mínimo 6 caracteres.';
  if(!$('loginTermsCheck').checked)return $('regErr').textContent='Aceite os Termos de Uso para continuar.';
  window._pendingNickname=nick;
  try{
    const cred=await firebaseAuthInstance.createUserWithEmailAndPassword(email,pass);
    // Send verification email
    if(cred.user){
      try{
        const vResp=await fetch('/api/auth/send-verification',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({uid:cred.user.uid})
        });
        const vData=await vResp.json();
        if(vData.useClientFallback||vData.error){
          await cred.user.sendEmailVerification();
        }
      }catch(ve){
        try{await cred.user.sendEmailVerification()}catch(ve2){}
      }
    }
  }catch(e){
    const msgs={'auth/email-already-in-use':'Este e-mail já está cadastrado.','auth/invalid-email':'E-mail inválido.','auth/weak-password':'Senha muito fraca (mínimo 6 caracteres).'};
    $('regErr').textContent=msgs[e.code]||('Erro: '+(e.message||'tente novamente'));
  }
}

// ═══ EMAIL VERIFICATION ═══
async function resendEmailVerification(){
  if(!fbUser)return showToast('Faça login primeiro.');
  // Reload to get fresh emailVerified status
  try{await fbUser.reload();fbUser=firebaseAuthInstance.currentUser}catch(e){}
  if(fbUser.emailVerified){
    showToast('Email já verificado! ✅');
    state.emailVerified=true;
    const c=$('cpEmailCard');if(c){c.classList.add('active');$('cpEmailStatus').textContent='✓ verificado';$('cpEmailStatus').style.color='#22c55e'}
    return;
  }
  // Strategy: try Firebase client SDK first (most reliable — Firebase handles the sending)
  // If that fails, try server-side (nodemailer with custom SMTP)
  try{
    await fbUser.sendEmailVerification({url:window.location.origin,handleCodeInApp:false});
    showToast('✉ Email de verificação enviado! Verifique spam.');
    return;
  }catch(e1){
    console.warn('[email-verify] Client SDK failed:',e1.code,e1.message);
    if(e1.code==='auth/too-many-requests'){return showToast('⏳ Aguarde um pouco antes de reenviar.')}
  }
  // Fallback: server-side
  try{
    const resp=await fetch('/api/auth/send-verification',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({uid:fbUser.uid})
    });
    const d=await resp.json();
    if(d.error)throw new Error(d.error);
    if(d.sent)showToast('✉ Email de verificação enviado!');
    else if(d.useClientFallback)showToast('⚠️ Serviço de email indisponível. Tente novamente mais tarde.');
    else showToast('✉ Verificação enviada!');
  }catch(e2){
    showToast('Erro ao enviar verificação: '+(e2.message||'tente novamente'));
  }
}

// Periodic email verification check (when user comes back after clicking link)
function startEmailVerificationPoll(){
  if(!fbUser||fbUser.emailVerified||state.emailVerified)return;
  const _evPoll=setInterval(async()=>{
    if(!fbUser||state.emailVerified){clearInterval(_evPoll);return}
    try{
      await fbUser.reload();
      fbUser=firebaseAuthInstance.currentUser;
      if(fbUser.emailVerified){
        state.emailVerified=true;
        clearInterval(_evPoll);
        showToast('Email verificado com sucesso! ✅');
        const c=$('cpEmailCard');if(c){c.classList.add('active');$('cpEmailStatus').textContent='✓ verificado';$('cpEmailStatus').style.color='#22c55e'}
      }
    }catch(e){}
  },10000); // check every 10s
}

// ═══ MAGIC LINK LOGIN ═══
function showMagicLogin(){
  $('loginForm').classList.add('hidden');
  $('registerForm').classList.add('hidden');
  $('magicLoginWrap').classList.remove('hidden');
  $('authTabs').style.display='none';
  $('authDivider').style.display='none';
  $('authMagicLink').style.display='none';
  $('socialBtns').style.display='none';
  $('phoneAuthWrap').style.display='none';
  $('magicEmail').value=$('loginEmail').value||'';
  $('magicErr').textContent='';
}
function hideMagicLogin(){
  switchAuthTab(loginIsRegister?'register':'login');
}
async function sendMagicLink(){
  const email=$('magicEmail').value.trim();
  $('magicErr').textContent='';$('magicErr').style.color='#f87171';
  if(!email)return $('magicErr').textContent='Digite seu email.';
  try{
    // Try server-side first
    const resp=await fetch('/api/auth/send-magic-link',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email,returnUrl:window.location.origin+'/?finishLogin=1'})
    });
    const d=await resp.json();
    if(d.error)throw new Error(d.error);
    if(d.useClientFallback){
      // Server generated link but has no SMTP — use Firebase client SDK to send
      const actionCodeSettings={url:window.location.origin+'/?finishLogin=1',handleCodeInApp:true};
      await firebaseAuthInstance.sendSignInLinkToEmail(email,actionCodeSettings);
    }
    localStorage.setItem('touch_magicEmail',email);
    $('magicErr').style.color='var(--ok)';
    $('magicErr').textContent='✉ Link enviado! Verifique seu email (inclusive spam).';
  }catch(e){
    // Direct client-side attempt
    try{
      const actionCodeSettings={url:window.location.origin+'/?finishLogin=1',handleCodeInApp:true};
      await firebaseAuthInstance.sendSignInLinkToEmail(email,actionCodeSettings);
      localStorage.setItem('touch_magicEmail',email);
      $('magicErr').style.color='var(--ok)';
      $('magicErr').textContent='✉ Link enviado! Verifique seu email (inclusive spam).';
    }catch(e2){
      const msgs={'auth/invalid-email':'Email inválido.','auth/user-not-found':'Email não cadastrado.','auth/operation-not-allowed':'Login sem senha não está habilitado. Use email e senha.'};
      $('magicErr').textContent=msgs[e2.code]||('Erro: '+(e2.message||e.message||'tente novamente'));
    }
  }
}
async function forgotPassword(){
  const email=$('loginEmail').value.trim();
  $('loginErr').style.color='var(--err)';
  if(!email)return $('loginErr').textContent='Preencha o email acima primeiro.';
  try{
    // Try server-side first
    const resp=await fetch('/api/auth/send-password-reset',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email})
    });
    const d=await resp.json();
    if(d.error)throw new Error(d.error);
    if(d.useClientFallback){
      // Server has no SMTP — use Firebase client SDK
      await firebaseAuthInstance.sendPasswordResetEmail(email);
    }
    $('loginErr').style.color='var(--ok)';
    $('loginErr').textContent='✉ Email de recuperação enviado! Verifique sua caixa.';
  }catch(e){
    // Direct client-side attempt
    try{
      await firebaseAuthInstance.sendPasswordResetEmail(email);
      $('loginErr').style.color='var(--ok)';
      $('loginErr').textContent='✉ Email de recuperação enviado!';
    }catch(e2){
      $('loginErr').style.color='#f87171';
      const msgs={'auth/invalid-email':'Email inválido.','auth/user-not-found':'Email não cadastrado.'};
      $('loginErr').textContent=msgs[e2.code]||('Erro: '+(e2.message||e.message||''));
    }
  }
}
// Check if returning from magic link
(async function checkMagicLink(){
  await new Promise(r=>setTimeout(r,2000)); // wait for firebase init
  if(!firebaseAuthInstance)return;
  const href=window.location.href;
  if(firebaseAuthInstance.isSignInWithEmailLink(href)){
    let email=localStorage.getItem('touch_magicEmail');
    if(!email)email=prompt('Por favor, confirme seu email para login:');
    if(!email)return;
    try{
      await firebaseAuthInstance.signInWithEmailLink(email,href);
      localStorage.removeItem('touch_magicEmail');
      window.history.replaceState(null,'',window.location.pathname);
      console.log('🔗 Magic link login successful for',email);
    }catch(e){
      console.error('Magic link login failed:',e);
      // Show error to user
      const errEl=$('loginErr')||$('magicErr');
      if(errEl){errEl.style.color='#f87171';errEl.textContent='Link expirado ou inválido. Tente novamente.'}
      window.history.replaceState(null,'',window.location.pathname);
    }
  }
})();

async function doLogout(){
  try{
    if(firebaseAuthInstance)await firebaseAuthInstance.signOut();
    localStorage.removeItem('touch_userId');localStorage.removeItem('touch_userName');localStorage.removeItem('touch_userColor');
    state.userId=null;state.userName=null;state.userColor='';fbUser=null;
    if(socket){socket.disconnect();socket=null}
    showScreen('login');
  }catch(e){showToast('Erro ao sair.')}
}

// ═══ ONBOARDING ═══
let onbSlide = 0;
const ONB_TOTAL = 5;
function initOnboarding() {
  const dots = $('onbDots');
  dots.innerHTML = '';
  for (let i = 0; i < ONB_TOTAL; i++) {
    const dot = document.createElement('div');
    dot.className = 'onb-dot' + (i === 0 ? ' active' : '');
    dots.appendChild(dot);
  }
}
function nextOnbSlide() {
  onbSlide++;
  if (onbSlide >= ONB_TOTAL) { skipOnboarding(); return; }
  $('onbSlides').style.transform = 'translateX(-' + (onbSlide * 100) + '%)';
  updateOnbDots();
  if (onbSlide === ONB_TOTAL - 1) $('onbNextBtn').textContent = 'Começar';
  // Retrigger animations for current slide
  const slides=document.querySelectorAll('.onb-slide');
  if(slides[onbSlide]){
    slides[onbSlide].querySelectorAll('.onb-icon,.onb-title,.onb-desc').forEach(el=>{
      el.style.animation='none';el.offsetHeight;el.style.animation='';
    });
  }
}
function updateOnbDots() {
  const dots = $('onbDots').children;
  for (let i = 0; i < dots.length; i++) dots[i].className = 'onb-dot' + (i === onbSlide ? ' active' : '');
}
function skipOnboarding() {
  localStorage.setItem('touch_onboarded', '1');
  showScreen('login');
}
function showTutorial(){showManual()}
function showManual(){
  onbSlide=0;
  initOnboarding();
  $('onbSlides').style.transform='translateX(0)';
  $('onbNextBtn').textContent='Próximo';
  // Retrigger fade-in animations by resetting them
  document.querySelectorAll('.onb-icon,.onb-title,.onb-desc').forEach(el=>{
    el.style.animation='none';
    el.offsetHeight; // force reflow
    el.style.animation='';
  });
  const oldSkip=window.skipOnboarding;
  window.skipOnboarding=function(){ showScreen('home'); window.skipOnboarding=oldSkip; };
  showScreen('onboarding');
}

// ═══ SOCKET ═══
function initSocket(){
  if(socket)return;
  socket=io({reconnection:true,reconnectionDelay:1000,reconnectionAttempts:Infinity});
  socket.on('connect',()=>{
    if(state.userId)socket.emit('identify',state.userId);
    updateConn('online');
    // If sonic was running but got killed by disconnect, auto-restart
    if(_sonicWasActive&&!homeSonicActive){
      console.log('[socket reconnect] Sonic was active, auto-restarting...');
      _sonicWasActive=false;
      setTimeout(()=>{if(!homeSonicActive)handleMainButton()},500);
    }
  });
  socket.on('disconnect',()=>{
    updateConn('offline');
    // If sonic is active during disconnect, mark for restart
    if(homeSonicActive){
      _sonicWasActive=true;
      stopHomeSonic();
    }
  });
  socket.io.on('reconnect_attempt',()=>updateConn('reconnecting'));

  // Server says: you matched another visitor, not the operator — keep listening
  socket.on('sonic-retry',({reason})=>{
    console.log('[sonic-retry]',reason);
    // Re-enable detection so the phone keeps looking for the operator
    sonicActive=true;
    const sts=document.querySelector('.sonic-status');
    if(sts)sts.textContent=reason||'Procurando operador...';
  });

  socket.on('checkin-duplicate',d=>{
    console.log('[checkin-duplicate]',d);
    if(homeSonicActive)stopHomeSonic();
    if(sonicActive)stopSonicMode();
    // Show friendly toast that user is already checked in
    const msg=d.message||'Você já fez check-in neste evento!';
    showToast(msg,'⚡');
    // Make sure floating event button is still visible
    if(d.eventId){
      localStorage.setItem('activeEventId',d.eventId);
      localStorage.setItem('activeEventName',d.eventName||'Evento');
      if(!localStorage.getItem('activeEventRole'))localStorage.setItem('activeEventRole','visitor');
      showFloatingEventBtn(d.eventId,d.eventName||'Evento');
    }
  });

  socket.on('relation-created',d=>{
    if(homeSonicActive)stopHomeSonic();
    if(sonicActive)stopSonicMode();
    state.currentRelation=d;playSound('connect');
    // For checkin connections: set up floating event button IMMEDIATELY
    // so visitor always knows they're at the event, even if payment fails later
    if(d.isCheckin&&d.eventId){
      const evName=d.eventName||'Evento';
      localStorage.setItem('activeEventId',d.eventId);
      localStorage.setItem('activeEventName',evName);
      if(!localStorage.getItem('activeEventRole'))localStorage.setItem('activeEventRole','visitor');
      showFloatingEventBtn(d.eventId,evName);
    }
    // Show epic connecting animation with continuous vibration, then reveal
    const co=$('connectingOverlay');
    if(co){
      const isRenewed=!!d.renewed;
      co.classList.remove('first','renewed');
      co.classList.add(isRenewed?'renewed':'first');
      co.classList.add('active');
      const isQuick=!!(d.isServiceTouch||d.isCheckin);
      // Get partner nickname for big display
      const meIsA=d.userA&&d.userA.id===state.userId;
      const partnerData=meIsA?d.userB:d.userA;
      const partnerNick=partnerData?(partnerData.nickname||partnerData.name||''):'';
      startElectricTouch(isRenewed,isQuick?'':partnerNick);
      haptic(isQuick?[60,20,60,20,100]:[80,30,80,30,120,40,120,40,150,30,150,30,200,20,200,20,250,15,250,15,300,10,300,10,400,10,500]);
      setTimeout(()=>{
        stopElectricTouch();
        if(navigator.vibrate)navigator.vibrate(0);
        co.classList.remove('active','first','renewed');
        showScreen('reveal');doReveal(d);
      },isQuick?2500:4200);
    }else{
      showScreen('reveal');doReveal(d);
    }
  });
  socket.on('new-message',({relationId,message})=>{
    if(state.currentRelation?.relationId===relationId){
      if(message.type==='reveal-request'||message.type==='reveal-accepted'||message.type==='reveal-declined'){
        appendRevealChatCard(message);
      }else{appendMessage(message)}
      playSound('receive');hideTyping();
      // Mark as read since we're viewing this chat
      localStorage.setItem('lastRead_'+relationId,Date.now().toString());
    }else{
      // Not viewing this chat — update badge to show unread
      refreshRelations();
    }
  });
  socket.on('partner-typing',({relationId})=>{
    if(state.currentRelation?.relationId===relationId)showTyping()
  });
  // Global listener: if user is removed from event while not on event screen
  socket.on('event-kicked',d=>{
    if(d.userId===state.userId){
      hideFloatingEventBtn();
      if(evViewEventId===d.eventId){closeEventView()}
      showToast('Você foi removido do evento.');
      refreshRelations(); // update chat list/badge (event chat removed)
    }
  });
  socket.on('pulse-received',({relationId})=>{
    // Heartbeat vibration: lub-dub, lub-dub, lub-dub
    const heartbeat=[120,60,80,300,120,60,80,300,120,60,80];
    if(state.currentRelation?.relationId===relationId){
      haptic(heartbeat);playSound('pulse');
      showToast('Sentiu um pulso...');
    }else{haptic(heartbeat);showToast('Alguém pulsou por você')}
  });
  socket.on('ephemeral-received',({relationId,message})=>{
    if(state.currentRelation?.relationId===relationId){appendEphemeral(message);playSound('receive')}
    else showToast('Nova mensagem!');
    haptic([50,30,50]);
  });
  socket.on('photo-received',({relationId,message})=>{
    if(state.currentRelation?.relationId===relationId){appendPhoto(message);playSound('receive')}
    else showToast('Foto recebida!');
    haptic([50,30,50]);
  });
  socket.on('selfie-request',({relationId})=>{
    if(state.currentRelation?.relationId===relationId)showToast('A outra pessoa quer registrar o encontro!');
  });
  socket.on('gift-received',({relationId,gift})=>{
    haptic([100,50,100]);playSound('connect');
    if(gift.needsAddress&&gift.addressStatus==='pending'){
      if(state.currentRelation?.relationId===relationId)showAddressRequest(gift);
      else showToast(gift.fromName+' te enviou '+gift.emoji+' '+gift.giftName+'!');
    }else{showToast(gift.fromName+' te enviou '+gift.emoji+' '+gift.giftName+'!')}
  });
  socket.on('declaration-received',({relationId,declaration})=>{
    haptic([50,30,50]);showToast(declaration.fromName+' escreveu uma declaração para você!');
  });
  socket.on('gift-address-accepted',({giftName})=>{showToast('Presente aceito! '+giftName+' será entregue.');haptic([50,30,50])});
  socket.on('gift-address-declined',({giftName})=>{showToast('Presente recusado: '+giftName);haptic([30])});
  socket.on('identity-request',({relationId,fromName})=>{
    haptic([60,30,60]);playSound('receive');
    showToast(fromName+' quer ver quem você é de verdade!');
  });
  // New: someone wants to reveal IDs (bilateral exchange request)
  // Reveal status update — sync constellation + chat UI
  socket.on('reveal-status-update',({relationId,fromUserId,toUserId,status})=>{
    const partnerId=(fromUserId===state.userId)?toUserId:fromUserId;
    if(!state.pendingReveals)state.pendingReveals={};
    if(status==='pending'){
      state.pendingReveals[partnerId]=fromUserId===state.userId?'sent':'received';
    }else{
      delete state.pendingReveals[partnerId];
    }
    // Update chat ID bar if open with this partner
    if(state.currentPartnerId===partnerId)updateChatIdBar();
  });
  // Bilateral reveal completed
  socket.on('identity-revealed',({fromUserId,realName,profilePhoto,instagram,bio})=>{
    haptic([80,40,80]);playSound('connect');
    if(!state.revealedIds)state.revealedIds={};
    state.revealedIds[fromUserId]={realName,profilePhoto,instagram,bio};
    syncRevealUI(fromUserId,realName,profilePhoto);
    refreshRelations();
    if(state.currentPartnerId!==fromUserId){
      showToast((realName||'Alguém')+' se revelou pra você! 🪪');
    }
  });
  socket.on('encosta-request',data=>showEncostaRequest(data));
  socket.on('encosta-declined',()=>{showToast('Pedido de touch recusado.');haptic([30])});
  socket.on('contact-request',data=>showContactRequest(data));
  socket.on('contact-shared',({relationId,contactType,value})=>{
    // Save contact info as persistent message in chat
    const labels={instagram:'📸 Instagram',whatsapp:'💬 WhatsApp',x:'𝕏 X',email:'📧 Email'};
    const text=(labels[contactType]||contactType)+': '+value;
    if(state.currentRelation?.relationId===relationId){
      appendMessage({userId:'system',text,timestamp:Date.now()});
    }
    // Also save as regular message on server
    if(relationId)socket.emit('send-message',{relationId,userId:'system',text});
    showToast(contactType+': '+value);haptic([20,40,20]);
  });
  socket.on('contact-declined',({contactType})=>{showToast('Pedido de '+contactType+' recusado.');haptic([30])});
  socket.on('selfie-taken',({relationId})=>{showToast('Selfie registrado!');haptic([20,40,20])});
  // Star earned — MUST donate immediately
  socket.on('star-must-donate',({pendingStarId,reason,context,totalEarned,pendingCount})=>{
    haptic([100,50,100,50,100]);playSound('connect');
    showStarDonateModal(pendingStarId,reason,context);
  });
  // Star donation confirmed
  socket.on('star-donation-confirmed',({toUserId,toName,recipientStars,pendingRemaining})=>{
    showToast('⭐ Estrela doada para '+toName+'!');
    // If more pending, next modal will come via star-must-donate
  });
  // Star received from someone
  socket.on('star-received',({fromUserId,fromName,total})=>{
    haptic([80,40,80,40,80]);playSound('connect');
    showToast('⭐ '+fromName+' te deu uma estrela! (Total: '+total+')');
    updateNotifBadge();
  });
  // Network notification: someone donated a star
  socket.on('star-donated-notification',({recipientName,donorName,recipientStars})=>{
    showToast('⭐ '+recipientName+' ganhou estrela de '+donorName+'!');
    updateNotifBadge();
  });
  socket.on('like-toggled',({fromUserId,liked})=>{
    haptic([30,20,30]);
    if(liked)showToast('Alguém curtiu seu perfil! ❤️');
    refreshRelations();
    updateNotifBadge();
  });
  socket.on('streak-unlock',data=>showStreakUnlock(data));
  socket.on('tip-received',({amount,from,status})=>{
    if(status==='approved'){
      haptic([100,50,100,50,100]);playSound('connect');
      showToast('💰 Gorjeta recebida! R$'+amount.toFixed(2).replace('.',',')+' de '+from);
    }else if(status==='pending'||status==='in_process'){
      showToast('⏳ Gorjeta de R$'+amount.toFixed(2).replace('.',',')+' em processamento.');
    }
  });
}
function updateConn(s){const d=$('connDot');if(d)d.className='cd'+(s!=='online'?' '+s:'')}

// ═══ NAV ═══
function showScreen(id){
  const el=$(id);if(!el)return;
  document.querySelectorAll('.screen').forEach(s=>{if(s.id!==id)s.classList.remove('active')});
  void el.offsetHeight;
  el.classList.add('active');
  if(id!=='reveal'&&typeof stopRevealLight==='function')stopRevealLight();
  if(state.timerInterval&&id!=='chat'){clearInterval(state.timerInterval);state.timerInterval=null}
  // Close selfie camera when leaving reveal
  if(id!=='reveal')releaseSelfieCamera();
  // Stop constellation animation + gyro when leaving
  if(id!=='history'){
    if(constState.animFrame){cancelAnimationFrame(constState.animFrame);constState.animFrame=null}
    if(constState._cleanGyro)constState._cleanGyro();
  }
  // Stop face camera when leaving face enrollment
  if(id!=='faceEnrollScreen'&&_faceStream){_faceStream.getTracks().forEach(t=>t.stop());_faceStream=null;_faceCapturing=false}
  // Stop sonic + release audio when leaving home (prevents mic/audio stuck)
  if(id!=='home'){
    if(homeSonicActive)stopHomeSonic();
    if(_homeNodesAnim){cancelAnimationFrame(_homeNodesAnim);_homeNodesAnim=null}
    if(_homeNodesGyro){window.removeEventListener('deviceorientation',_homeNodesGyro);_homeNodesGyro=null}
  }
}
function showPhase(id){document.querySelectorAll('.ep').forEach(p=>p.classList.remove('active'));$(id).classList.add('active')}
function goHome(){
  // Full cleanup: stop any active sonic/audio before returning home
  if(homeSonicActive)stopHomeSonic();
  stopSonicMode(); // ensure all audio contexts + mic streams are fully released
  showScreen('home');refreshHome();
}

// ═══ EVENT VIEW — Constelação do evento no celular ═══
let evViewEventId=null,evViewCtx=null,evViewW=0,evViewH=0,evViewAnim=null;
const evNodes=[],evAmbientP=[],evBolts=[];

async function showEventView(eventId,eventName){
  evViewEventId=eventId;
  $('evViewName').textContent=eventName||'Evento';
  showScreen('eventView');
  // Init canvas
  const cv=$('evCanvas');const rect=cv.parentElement.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  evViewW=rect.width;evViewH=rect.height;
  cv.width=evViewW*dpr;cv.height=evViewH*dpr;cv.style.width=evViewW+'px';cv.style.height=evViewH+'px';
  evViewCtx=cv.getContext('2d');evViewCtx.scale(dpr,dpr);
  evNodes.length=0;evAmbientP.length=0;evBolts.length=0;
  for(let i=0;i<40;i++)evAmbientP.push({x:Math.random()*evViewW,y:Math.random()*evViewH,r:.5+Math.random()*1.5,vx:(Math.random()-.5)*.1,vy:(Math.random()-.5)*.1,a:.03+Math.random()*.12,phase:Math.random()*Math.PI*2});
  // Load attendees
  try{
    const r=await fetch('/api/operator/event/'+eventId+'/attendees');const d=await r.json();
    $('evViewCount').textContent=(d.attendees||[]).length+' pessoas';
    (d.attendees||[]).forEach(a=>addEvNode(a,true));
  }catch(e){console.error('[eventView] load error:',e)}
  // Load restaurant menu (if any)
  loadEventMenu(eventId);
  // Socket listeners
  if(socket){
    socket.on('event-attendee-joined',d=>{if(d.eventId===evViewEventId){addEvNode(d);$('evViewCount').textContent=evNodes.length+' pessoas'}});
    socket.on('event-attendee-left',d=>{if(d.eventId===evViewEventId){if(d.userId===state.userId){showToast('Você foi removido do evento.');hideFloatingEventBtn();closeEventView();return}const idx=evNodes.findIndex(n=>n.userId===d.userId);if(idx>=0)evNodes.splice(idx,1);$('evViewCount').textContent=evNodes.length+' pessoas'}});
    socket.on('event-ended',d=>{if(d.eventId===evViewEventId){showToast('Evento encerrado: '+(d.name||''));closeEventView();refreshRelations()}});
    socket.on('event-match',d=>{if(d.eventId===evViewEventId&&d.userIdA&&d.userIdB)spawnEvBolt(d.userIdA,d.userIdB)});
  }
  if(evViewAnim)cancelAnimationFrame(evViewAnim);
  renderEvCanvas();
}

function addEvNode(d,instant){
  const pad=50;
  const baseR=18; // same size for all
  const n={
    x:pad+Math.random()*(evViewW-pad*2),
    y:pad+Math.random()*(evViewH-pad*2),
    vx:(Math.random()-.5)*0.3,
    vy:(Math.random()-.5)*0.3,
    baseRadius:baseR,
    r:instant?baseR:0,targetR:baseR,
    color:d.color||'hsl('+(Math.random()*360)+',65%,45%)',
    name:d.nickname||'?',
    phase:Math.random()*Math.PI*2,
    glow:instant?0:2,entryScale:instant?1:0,
    userId:d.userId||null,revealed:d.revealed||false,
    revealData:d.revealData||null,profilePhoto:d.profilePhoto||null,
    stars:d.stars||0,topTag:d.topTag||null,
    photoImg:null,photoLoaded:false,verified:!!d.verified
  };
  if(n.revealed&&n.profilePhoto){
    const img=new Image();img.onload=()=>{n.photoImg=img;n.photoLoaded=true};img.src=n.profilePhoto;
  }
  evNodes.push(n);
}
function spawnEvBolt(userIdA,userIdB){
  evBolts.push({userA:userIdA,userB:userIdB,born:Date.now(),duration:3500,segments:null,lastRegen:0});
}
function makeEvLightning(ax,ay,bx,by){
  const pts=[{x:ax,y:ay}];const dx=bx-ax,dy=by-ay;const segs=8+Math.floor(Math.random()*6);
  for(let i=1;i<segs;i++){const frac=i/segs;const jx=(Math.random()-.5)*40;const jy=(Math.random()-.5)*40;
    pts.push({x:ax+dx*frac+jx,y:ay+dy*frac+jy})}
  pts.push({x:bx,y:by});return pts;
}

function renderEvCanvas(){
  if(!evViewCtx)return;const c=evViewCtx;c.clearRect(0,0,evViewW,evViewH);const t=Date.now()/1000;const now=Date.now();
  const W=evViewW,H=evViewH;
  // Ambient particles
  evAmbientP.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;
    c.beginPath();c.arc(p.x,p.y,p.r,0,Math.PI*2);c.fillStyle='rgba(255,255,255,'+Math.max(0,p.a+Math.sin(t*1.5+p.phase)*.03)+')';c.fill()});
  // Center event pin
  const cx=W/2,cy=H/2;
  const cs=14+Math.sin(t*2)*.8;
  c.beginPath();c.arc(cx,cy,cs,0,Math.PI*2);c.fillStyle='rgba(96,165,250,.2)';c.fill();c.strokeStyle='rgba(96,165,250,.35)';c.lineWidth=1;c.stroke();
  c.beginPath();c.arc(cx,cy,cs*.45,0,Math.PI*2);c.fillStyle='#60a5fa';c.fill();
  c.font='600 6px Inter';c.fillStyle='rgba(96,165,250,.5)';c.textAlign='center';c.textBaseline='top';
  c.fillText('📍',cx,cy+cs+3);
  // Move nodes — aquarium float
  const pad=30;const speedLim=0.6;
  evNodes.forEach(n=>{
    if(n.entryScale<1)n.entryScale=Math.min(1,n.entryScale+0.02);
    // Drift
    n.x+=n.vx;n.y+=n.vy;
    // Bounce off edges
    if(n.x<pad){n.x=pad;n.vx=Math.abs(n.vx)*0.8}
    if(n.x>W-pad){n.x=W-pad;n.vx=-Math.abs(n.vx)*0.8}
    if(n.y<pad){n.y=pad;n.vy=Math.abs(n.vy)*0.8}
    if(n.y>H-pad){n.y=H-pad;n.vy=-Math.abs(n.vy)*0.8}
    // Avoid center event pin
    const dcx=n.x-cx,dcy=n.y-cy;const dcDist=Math.sqrt(dcx*dcx+dcy*dcy);
    if(dcDist<cs+n.baseRadius+10&&dcDist>0){const push=(cs+n.baseRadius+10-dcDist)*0.03;n.vx+=dcx/dcDist*push;n.vy+=dcy/dcDist*push}
    // Repulsion between nodes
    evNodes.forEach(o=>{if(o===n)return;const odx=n.x-o.x,ody=n.y-o.y;const od=Math.sqrt(odx*odx+ody*ody);
      const minD=n.baseRadius+o.baseRadius+6;if(od<minD&&od>0){const push=(minD-od)*0.02;n.vx+=odx/od*push;n.vy+=ody/od*push}});
    // Speed limit + small perturbation
    const spd=Math.sqrt(n.vx*n.vx+n.vy*n.vy);
    if(spd>speedLim){n.vx*=speedLim/spd;n.vy*=speedLim/spd}
    n.vx+=(Math.random()-.5)*0.01;n.vy+=(Math.random()-.5)*0.01;
  });
  // Lightning bolts
  for(let i=evBolts.length-1;i>=0;i--){
    const b=evBolts[i];const age=now-b.born;
    if(age>b.duration){evBolts.splice(i,1);continue}
    const nA=evNodes.find(n=>n.userId===b.userA),nB=evNodes.find(n=>n.userId===b.userB);
    if(!nA||!nB)continue;
    if(!b.segments||now-b.lastRegen>100){b.segments=makeEvLightning(nA.x,nA.y,nB.x,nB.y);b.lastRegen=now}
    const fade=age<300?age/300:age>b.duration-500?Math.max(0,(b.duration-age)/500):1;
    if(b.segments.length>1){
      // 3-layer glow
      [[8,'rgba(96,165,250,'+(0.08*fade)+')'],[4,'rgba(147,197,253,'+(0.2*fade)+')'],[1.5,'rgba(255,255,255,'+(0.7*fade)+')']].forEach(([lw,col])=>{
        c.beginPath();c.moveTo(b.segments[0].x,b.segments[0].y);
        b.segments.forEach(p=>c.lineTo(p.x,p.y));c.strokeStyle=col;c.lineWidth=lw;c.lineCap='round';c.stroke()});
      // Label
      const mx=(nA.x+nB.x)/2,my=(nA.y+nB.y)/2;
      c.font='600 7px Inter';c.fillStyle='rgba(96,165,250,'+(0.6*fade)+')';c.textAlign='center';c.textBaseline='middle';
      c.fillText('⚡ conexão',mx,my-10);
    }
  }
  // Render nodes
  evNodes.forEach(n=>{
    if(n.r<n.targetR)n.r=Math.min(n.targetR,n.r+.3);
    const pulse=1+Math.sin(t*1.2+n.phase)*.04;
    const r=Math.min(n.baseRadius*pulse*n.entryScale,24);if(r<1)return;
    // Entry glow
    if(n.glow>0){const gr=r*4*n.glow;const g=c.createRadialGradient(n.x,n.y,0,n.x,n.y,gr);
      g.addColorStop(0,'rgba(96,165,250,'+(0.3*n.glow)+')');g.addColorStop(1,'rgba(0,0,0,0)');
      c.fillStyle=g;c.beginPath();c.arc(n.x,n.y,gr,0,Math.PI*2);c.fill();n.glow=Math.max(0,n.glow-.005)}
    // Top tag
    if(n.topTag&&n.r>=n.targetR*.8){
      const tagColors={top1:'#FFD700',top5:'#C0C0C0',top50:'#CD7F32',top100:'#6a5acd'};
      const tagLabels={top1:'TOP 1',top5:'TOP 5',top50:'TOP 50',top100:'TOP 100'};
      const tagCol=tagColors[n.topTag]||'#6a5acd';const tagLbl=tagLabels[n.topTag]||'';
      if(tagLbl){c.save();c.font='700 6px Inter';c.textAlign='center';c.textBaseline='middle';
        const tw=c.measureText(tagLbl).width+6;const th=10;const tx=n.x;const ty=n.y-r-th/2-3;
        c.fillStyle=tagCol;c.globalAlpha=.85;
        c.beginPath();const br2=3;c.moveTo(tx-tw/2+br2,ty-th/2);c.lineTo(tx+tw/2-br2,ty-th/2);c.quadraticCurveTo(tx+tw/2,ty-th/2,tx+tw/2,ty-th/2+br2);c.lineTo(tx+tw/2,ty+th/2-br2);c.quadraticCurveTo(tx+tw/2,ty+th/2,tx+tw/2-br2,ty+th/2);c.lineTo(tx-tw/2+br2,ty+th/2);c.quadraticCurveTo(tx-tw/2,ty+th/2,tx-tw/2,ty+th/2-br2);c.lineTo(tx-tw/2,ty-th/2+br2);c.quadraticCurveTo(tx-tw/2,ty-th/2,tx-tw/2+br2,ty-th/2);c.fill();
        c.globalAlpha=1;c.fillStyle='#000';c.fillText(tagLbl,tx,ty+.5);c.restore()}}
    // Node — photo or anonymous
    if(n.revealed&&n.photoLoaded&&n.photoImg){
      c.save();c.beginPath();c.arc(n.x,n.y,r,0,Math.PI*2);c.clip();
      c.drawImage(n.photoImg,n.x-r,n.y-r,r*2,r*2);c.restore();
      c.beginPath();c.arc(n.x,n.y,r,0,Math.PI*2);c.strokeStyle='rgba(52,211,153,.6)';c.lineWidth=1.5;c.stroke();
    }else if(n.revealed){
      c.beginPath();c.arc(n.x,n.y,r,0,Math.PI*2);c.fillStyle=n.color;c.fill();c.strokeStyle='rgba(52,211,153,.5)';c.lineWidth=1;c.stroke();
      if(r>5){const ini2=(s)=>{if(!s)return'?';const p=s.trim().split(/\s+/);return p.length>1?(p[0][0]+p[1][0]).toUpperCase():s.slice(0,2).toUpperCase()};
        c.fillStyle='#fff';c.font='600 '+(r*.55)+'px Inter';c.textAlign='center';c.textBaseline='middle';c.fillText(ini2(n.name),n.x,n.y+.5)}
    }else{
      // Anonymous silhouette
      c.beginPath();c.arc(n.x,n.y,r,0,Math.PI*2);c.fillStyle=n.color;c.globalAlpha=.45;c.fill();c.globalAlpha=1;
      c.strokeStyle='rgba(255,255,255,.08)';c.lineWidth=.6;c.stroke();
      // Silhouette head+body
      const ss=r*.35;c.beginPath();c.arc(n.x,n.y-ss*.3,ss,0,Math.PI*2);c.fillStyle='rgba(255,255,255,.25)';c.fill();
      c.beginPath();c.ellipse(n.x,n.y+ss*.8,ss*1.2,ss*.7,0,Math.PI,0);c.fill();
    }
    // Verified badge
    if(n.verified&&r>6){const bsz=Math.max(7,r*.45);const bx=n.x+r*.55,by=n.y+r*.55;
      const vg=c.createLinearGradient(bx-bsz,by-bsz,bx+bsz,by+bsz);vg.addColorStop(0,'#06b6d4');vg.addColorStop(.5,'#3b82f6');vg.addColorStop(1,'#8b5cf6');
      c.beginPath();c.arc(bx,by,bsz,0,Math.PI*2);c.fillStyle=vg;c.fill();c.strokeStyle='#0a0a0f';c.lineWidth=1;c.stroke();
      c.fillStyle='#fff';c.font='700 '+(bsz*.8)+'px Inter';c.textAlign='center';c.textBaseline='middle';c.fillText('+',bx,by+.3)}
    // Name + stars
    if(r>8){
      const dName=n.revealed&&n.revealData&&n.revealData.realName?n.revealData.realName:n.name;
      c.fillStyle='rgba(255,255,255,.35)';c.font='400 7px Inter';c.textAlign='center';
      c.fillText(dName.length>10?dName.slice(0,10)+'…':dName,n.x,n.y+r+10);
      if(n.stars>0){c.fillStyle='rgba(255,215,0,.45)';c.font='400 6px Inter';c.fillText('★'+n.stars,n.x,n.y+r+18)}}
  });
  evViewAnim=requestAnimationFrame(renderEvCanvas);
}

function closeEventView(){
  if(evViewAnim){cancelAnimationFrame(evViewAnim);evViewAnim=null}
  const savedId=evViewEventId;
  const savedName=$('evViewName')?.textContent||'Evento';
  evViewEventId=null;evNodes.length=0;evBolts.length=0;evViewCtx=null;
  // Close menu/cart overlays
  $('evMenuOverlay').style.display='none';$('evCartOverlay').style.display='none';
  $('evMenuBtn').style.display='none';$('evCartBadge').style.display='none';
  if(socket){socket.off('event-attendee-joined');socket.off('event-attendee-left');socket.off('event-ended');socket.off('event-match')}
  // Persist active event in localStorage for floating button
  if(savedId){
    localStorage.setItem('activeEventId',savedId);
    localStorage.setItem('activeEventName',savedName);
    // Only set role if not already set (don't overwrite 'operator' with 'visitor')
    if(!localStorage.getItem('activeEventRole'))localStorage.setItem('activeEventRole','visitor');
    showFloatingEventBtn(savedId,savedName);
  }
  goHome();
}

function showFloatingEventBtn(eventId,eventName){
  const btn=$('floatingEventBtn');if(!btn)return;
  $('floatingEventName').textContent=eventName;
  btn.style.display='';
  btn._eventId=eventId;btn._eventName=eventName;
  // Listen for event-ended to auto-hide
  if(socket){
    socket.off('event-ended-floating');
    socket.on('event-ended',function onEnded(d){
      if(d.eventId===eventId){
        hideFloatingEventBtn();
        showToast('O evento '+esc(eventName)+' foi encerrado');
        refreshRelations(); // remove event chat from list
        socket.off('event-ended',onEnded);
      }
    });
  }
}

function hideFloatingEventBtn(){
  const btn=$('floatingEventBtn');if(btn)btn.style.display='none';
  localStorage.removeItem('activeEventId');
  localStorage.removeItem('activeEventName');
  localStorage.removeItem('activeEventRole');
}

function reopenEventView(){
  const btn=$('floatingEventBtn');
  const eventId=btn?._eventId||localStorage.getItem('activeEventId');
  const eventName=btn?._eventName||localStorage.getItem('activeEventName')||'Evento';
  if(eventId){
    btn.style.display='none';
    showEventView(eventId,eventName);
  }
}

async function leaveEvent(){
  const eventId=evViewEventId||localStorage.getItem('activeEventId');
  if(!eventId){closeEventView();return}
  try{
    await fetch('/api/operator/event/'+eventId+'/leave',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
  }catch(e){}
  hideFloatingEventBtn();
  if(evViewAnim){cancelAnimationFrame(evViewAnim);evViewAnim=null}
  evViewEventId=null;evNodes.length=0;evBolts.length=0;evViewCtx=null;
  if(socket){socket.off('event-attendee-joined');socket.off('event-attendee-left');socket.off('event-ended');socket.off('event-match')}
  showToast('Você saiu do evento');
  goHome();
}

// Restore floating event button on page load
function restoreFloatingEvent(){
  const eventId=localStorage.getItem('activeEventId');
  const eventName=localStorage.getItem('activeEventName');
  if(eventId&&eventName)showFloatingEventBtn(eventId,eventName);
}

// ═══ EVENT MENU & CART (RESTAURANT) ═══
let evMenuData=[],evCart=[],evMenuEventId=null,evTables=0;

async function loadEventMenu(eventId){
  try{
    const r=await fetch('/api/event/'+eventId+'/menu');const d=await r.json();
    evMenuData=d.menu||[];evTables=d.tables||0;
    if(evMenuData.length>0)$('evMenuBtn').style.display='';
    else $('evMenuBtn').style.display='none';
    evMenuEventId=eventId;
  }catch(e){evMenuData=[];}
}

function openEventMenu(){
  $('evMenuOverlay').style.display='';
  renderMenuCats();renderMenuItems();updateCartBadge();
}
function closeEventMenu(){$('evMenuOverlay').style.display='none'}
function openCart(){$('evCartOverlay').style.display='';renderCart()}
function closeCart(){$('evCartOverlay').style.display='none'}
function clearCart(){evCart=[];updateCartBadge();closeCart();showToast('Carrinho limpo')}

function renderMenuCats(){
  const cats=[...new Set(evMenuData.map(i=>i.category||'Geral'))];
  const el=$('evMenuCats');
  el.innerHTML='<button class="ev-cat-btn active" onclick="filterMenuCat(this,\'\')" style="padding:.3rem .8rem;border-radius:20px;border:1px solid rgba(249,115,22,.3);background:rgba(249,115,22,.15);color:#f97316;font-size:.65rem;font-weight:600;white-space:nowrap;cursor:pointer;font-family:inherit">Tudo</button>';
  cats.forEach(cat=>{
    el.innerHTML+='<button class="ev-cat-btn" onclick="filterMenuCat(this,\''+esc(cat)+'\')" style="padding:.3rem .8rem;border-radius:20px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:var(--t2);font-size:.65rem;font-weight:500;white-space:nowrap;cursor:pointer;font-family:inherit">'+esc(cat)+'</button>';
  });
}

function filterMenuCat(btn,cat){
  document.querySelectorAll('.ev-cat-btn').forEach(b=>{b.classList.remove('active');b.style.background='rgba(255,255,255,.05)';b.style.color='var(--t2)';b.style.borderColor='rgba(255,255,255,.1)'});
  btn.classList.add('active');btn.style.background='rgba(249,115,22,.15)';btn.style.color='#f97316';btn.style.borderColor='rgba(249,115,22,.3)';
  renderMenuItems(cat);
}

function renderMenuItems(cat){
  const items=cat?evMenuData.filter(i=>(i.category||'Geral')===cat):evMenuData;
  const el=$('evMenuItems');
  if(!items.length){el.innerHTML='<div style="text-align:center;color:var(--t3);padding:2rem;font-size:.75rem">Nenhum item disponível</div>';return}
  el.innerHTML=items.filter(i=>i.available!==false).map(item=>{
    const inCart=evCart.find(c=>c.id===item.id);
    const qty=inCart?inCart.qty:0;
    const price='R$'+(item.price||0).toFixed(2).replace('.',',');
    return '<div style="display:flex;gap:.7rem;padding:.7rem 0;border-bottom:1px solid rgba(255,255,255,.04);align-items:center">'
      +(item.photo?'<img src="'+esc(item.photo)+'" style="width:60px;height:60px;border-radius:10px;object-fit:cover;flex-shrink:0">':'<div style="width:60px;height:60px;border-radius:10px;background:rgba(249,115,22,.1);display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0">🍽</div>')
      +'<div style="flex:1;min-width:0">'
      +'<div style="font-weight:600;font-size:.8rem;color:var(--t1)">'+esc(item.name)+'</div>'
      +(item.description?'<div style="font-size:.6rem;color:var(--t3);margin-top:.15rem;line-height:1.3">'+esc(item.description)+'</div>':'')
      +'<div style="font-weight:700;color:#f97316;font-size:.8rem;margin-top:.3rem">'+price+'</div>'
      +'</div>'
      +'<div style="display:flex;align-items:center;gap:.4rem;flex-shrink:0">'
      +(qty>0?'<button onclick="addToCart(\''+item.id+'\',-1)" style="width:32px;height:32px;border-radius:50%;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:#fff;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center">−</button><span style="font-weight:700;font-size:.85rem;min-width:20px;text-align:center;color:var(--t1)">'+qty+'</span>':'')
      +'<button onclick="addToCart(\''+item.id+'\',1)" style="width:32px;height:32px;border-radius:50%;border:none;background:#f97316;color:#fff;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700">+</button>'
      +'</div></div>';
  }).join('');
}

function addToCart(itemId,delta){
  const item=evMenuData.find(i=>i.id===itemId);if(!item)return;
  let c=evCart.find(c=>c.id===itemId);
  if(c){c.qty=Math.max(0,c.qty+delta);if(c.qty<=0)evCart=evCart.filter(x=>x.id!==itemId)}
  else if(delta>0)evCart.push({id:item.id,name:item.name,price:item.price||0,qty:1});
  updateCartBadge();renderMenuItems(document.querySelector('.ev-cat-btn.active')?.textContent==='Tudo'?'':document.querySelector('.ev-cat-btn.active')?.textContent||'');
}

function updateCartBadge(){
  const total=evCart.reduce((s,c)=>s+c.qty,0);
  $('evCartBadge').style.display=total>0?'':'none';
  $('evCartBadge').textContent=total;
  const mc=$('menuCartCount');if(mc)mc.textContent=total;
}

function renderCart(){
  const el=$('evCartItems');
  if(!evCart.length){
    el.innerHTML='<div style="text-align:center;color:var(--t3);padding:3rem 1rem;font-size:.8rem">Carrinho vazio<br><span style="font-size:.65rem">Escolha itens do cardápio</span></div>';
    $('evCartFooter').innerHTML='';return;
  }
  el.innerHTML=evCart.map(c=>{
    const price='R$'+(c.price*c.qty).toFixed(2).replace('.',',');
    return '<div style="display:flex;justify-content:space-between;align-items:center;padding:.6rem 0;border-bottom:1px solid rgba(255,255,255,.04)">'
      +'<div><div style="font-weight:600;font-size:.8rem;color:var(--t1)">'+esc(c.name)+'</div>'
      +'<div style="font-size:.6rem;color:var(--t3)">'+c.qty+'× R$'+c.price.toFixed(2).replace('.',',')+'</div></div>'
      +'<div style="display:flex;align-items:center;gap:.3rem">'
      +'<span style="font-weight:700;color:#f97316;font-size:.8rem">'+price+'</span>'
      +'<button onclick="addToCart(\''+c.id+'\',-1);renderCart()" style="width:26px;height:26px;border-radius:50%;border:1px solid rgba(255,61,113,.3);background:none;color:#ff3d71;font-size:.8rem;cursor:pointer">−</button>'
      +'<button onclick="addToCart(\''+c.id+'\',1);renderCart()" style="width:26px;height:26px;border-radius:50%;border:none;background:#f97316;color:#fff;font-size:.8rem;cursor:pointer;font-weight:700">+</button>'
      +'</div></div>';
  }).join('');
  const total=evCart.reduce((s,c)=>s+c.price*c.qty,0);
  const totalStr='R$'+total.toFixed(2).replace('.',',');
  let tableOpts='<option value="">Sem mesa</option>';
  for(let i=1;i<=Math.max(evTables,50);i++)tableOpts+='<option value="'+i+'">Mesa '+i+'</option>';
  $('evCartFooter').innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem"><span style="font-size:.8rem;color:var(--t2)">Total</span><span style="font-size:1.2rem;font-weight:800;color:#f97316">'+totalStr+'</span></div>'
    +'<div style="margin-bottom:.6rem"><label style="font-size:.65rem;color:var(--t3);display:block;margin-bottom:.2rem">Mesa de entrega</label>'
    +'<select id="evCartTable" style="width:100%;padding:.5rem;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:var(--t1);font-size:.8rem;font-family:inherit">'+tableOpts+'</select></div>'
    +'<button onclick="submitOrder(\'counter\')" style="width:100%;padding:.7rem;border-radius:14px;border:none;background:linear-gradient(135deg,#f97316,#ef4444);color:#fff;font-weight:700;font-size:.85rem;cursor:pointer;margin-bottom:.4rem;font-family:inherit">📋 Mostrar pro garçom</button>'
    +'<button onclick="submitOrder(\'card\')" style="width:100%;padding:.6rem;border-radius:14px;border:1px solid rgba(249,115,22,.3);background:rgba(249,115,22,.08);color:#f97316;font-weight:600;font-size:.75rem;cursor:pointer;font-family:inherit">💳 Pagar agora</button>';
}

async function submitOrder(method){
  if(!evCart.length)return showToast('Carrinho vazio');
  const table=$('evCartTable')?.value||'';
  const total=evCart.reduce((s,c)=>s+c.price*c.qty,0);
  const items=evCart.map(c=>({menuItemId:c.id,name:c.name,qty:c.qty,price:c.price}));
  if(method==='counter'){
    // Show big summary to waiter
    showWaiterView(items,table,total);return;
  }
  // Card payment
  try{
    const r=await fetch('/api/event/'+evMenuEventId+'/order',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userId:state.userId,items,table,paymentMethod:'card',total})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Pedido enviado!');evCart=[];updateCartBadge();closeCart();closeEventMenu();
  }catch(e){showToast('Erro ao enviar pedido')}
}

function showWaiterView(items,table,total){
  // Full-screen big text for waiter to see
  const totalStr='R$'+total.toFixed(2).replace('.',',');
  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:#0a0a0f;z-index:9999;display:flex;flex-direction:column;padding:1.5rem;overflow-y:auto';
  overlay.innerHTML='<div style="text-align:center;margin-bottom:1rem"><div style="font-size:1.4rem;font-weight:800;color:#f97316">📋 Pedido</div>'
    +(table?'<div style="font-size:1.8rem;font-weight:900;color:#fff;margin-top:.4rem">Mesa '+esc(table)+'</div>':'')
    +'</div>'
    +'<div style="flex:1">'+items.map(i=>'<div style="display:flex;justify-content:space-between;padding:.8rem 0;border-bottom:2px solid rgba(255,255,255,.08);align-items:center">'
      +'<div><div style="font-size:1.3rem;font-weight:700;color:#fff">'+i.qty+'× '+esc(i.name)+'</div></div>'
      +'<div style="font-size:1.1rem;font-weight:700;color:#f97316">R$'+(i.price*i.qty).toFixed(2).replace('.',',')+'</div></div>').join('')+'</div>'
    +'<div style="text-align:center;padding:1rem 0;border-top:2px solid rgba(249,115,22,.3);margin-top:.5rem">'
    +'<div style="font-size:.8rem;color:var(--t3)">Total</div>'
    +'<div style="font-size:2.2rem;font-weight:900;color:#f97316">'+totalStr+'</div></div>'
    +'<button onclick="this.parentElement.remove();submitOrderCounter()" style="width:100%;padding:1rem;border-radius:16px;border:none;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;font-weight:800;font-size:1.1rem;cursor:pointer;margin-top:.5rem;font-family:inherit">✅ Garçom anotou</button>'
    +'<button onclick="this.parentElement.remove()" style="width:100%;padding:.7rem;border-radius:16px;border:1px solid rgba(255,255,255,.1);background:none;color:var(--t2);font-size:.8rem;cursor:pointer;margin-top:.4rem;font-family:inherit">Voltar ao carrinho</button>';
  document.body.appendChild(overlay);
}

async function submitOrderCounter(){
  const table=$('evCartTable')?.value||'';
  const total=evCart.reduce((s,c)=>s+c.price*c.qty,0);
  const items=evCart.map(c=>({menuItemId:c.id,name:c.name,qty:c.qty,price:c.price}));
  try{
    await fetch('/api/event/'+evMenuEventId+'/order',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userId:state.userId,items,table,paymentMethod:'counter',total})});
  }catch(e){}
  showToast('Pedido registrado!');evCart=[];updateCartBadge();closeCart();closeEventMenu();
}

// ── Request accelerometer permission (iOS requires user gesture) ──
let _accelPermGranted=false;
function requestAccelPermission(){
  if(_accelPermGranted)return;
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(p=>{
      if(p==='granted')_accelPermGranted=true;
    }).catch(()=>{});
  }else{_accelPermGranted=true}
}

async function refreshHome(){
  refreshRelations();
  setHomeMotivation();
  initServiceToggle();
  // Fetch user profile to get latest photo + real name
  if(state.userId){
    try{
      const mp=await fetch('/api/myprofile/'+state.userId).then(r=>r.json());
      const _mpPhoto=mp.profilePhoto||mp.photoURL||null;
      if(_mpPhoto){state.userPhoto=_mpPhoto;localStorage.setItem('touch_userPhoto',_mpPhoto)}
      state.userRealName=mp.realName||null;
      // Load canSee into revealedIds
      if(mp.canSee){
        if(!state.revealedIds)state.revealedIds={};
        Object.keys(mp.canSee).forEach(k=>{if(!state.revealedIds[k])state.revealedIds[k]=mp.canSee[k]});
      }
      if(mp.isPrestador)localStorage.setItem('touch_isPrestador','1');
      state.userVerified=!!mp.verified;
      state.userIsAdmin=!!mp.isAdmin;
      state.userStarsCount=mp.starsReceived||0;
      state.userFaceEnrolled=!!mp.faceEnrolled;
      state.userDocVerified=!!mp.docSubmitted;
      state.userDocStatus=mp.docStatus||null;
      state.userScore=mp.score||0;
      state.userTopTag=mp.topTag||null;
      state.userRealName=mp.realName||'';
      state.userUniqueConnections=mp.uniqueConnections||0;
      state.userIsSubscriber=!!mp.isSubscriber;
      if(mp.email)state.email=mp.email;
      if(mp.cpf)state.userCpf=mp.cpf;
      state.userGiftsReceived=mp.giftsReceived||0;
      const rnEl=$('homeRealName');
      if(rnEl){rnEl.textContent=mp.realName&&mp.realName!==state.userName?mp.realName:''}
      // Check for pending stars that need donation
      try{
        const pend=await fetch('/api/star/pending/'+state.userId).then(r2=>r2.json());
        if(pend.count>0&&!_starModalOpen){
          pend.pending.forEach(p=>showStarDonateModal(p.id,p.reason,p.context));
        }
      }catch(e2){}
    }catch(e){}
  }
  // Set homeAvatar
  if(state.userName){
    const av=$('homeAvatar');
    if(av){
      av.innerHTML=makeAvatar(state.userName,state.userColor||nickColor(state.userName),40,state.userPhoto||null,false,state.userAccessory||null);
      av.style.background='none';av.style.overflow='visible';
    }
    // Show verified badge on home avatar
    const hvb=$('homeVerifiedBadge');
    if(hvb){if(state.userVerified)hvb.classList.remove('hidden');else hvb.classList.add('hidden')}
    // Show stars mini
    const hsm=$('homeStarsMini');
    if(hsm){if(state.userStarsCount>0){hsm.classList.remove('hidden');hsm.textContent='★'.repeat(Math.min(state.userStarsCount,5))+(state.userStarsCount>5?'+':'')}else hsm.classList.add('hidden')}
  }
  try{
    const [d,cn]=await Promise.all([
      fetch('/api/today/'+state.userId).then(r=>r.json()),
      fetch('/api/constellation/'+state.userId).then(r=>r.json())
    ]);
    const c=$('dailyCounter'),n=$('dailyNum');
    if(d.count>0){c.classList.remove('hidden');n.textContent=d.count;const lbl=$('dailyLabel');if(lbl)lbl.textContent=d.count===1?'Toque em 24h':'Toques em 24h'}else c.classList.add('hidden');
    if(cn.total>0){$('constBtn').classList.remove('hidden');updateNetworkBadge()}
    // Update home background nodes
    initHomeNodes(cn.nodes||[]);
  }catch(e){}
}

// ═══ HOME BACKGROUND NODES — rotating neural web ═══
let _homeNodesAnim=null,_homeNodesGyro=null;
function initHomeNodes(nodes){
  if(_homeNodesAnim){cancelAnimationFrame(_homeNodesAnim);_homeNodesAnim=null}
  if(_homeNodesGyro){window.removeEventListener('deviceorientation',_homeNodesGyro);_homeNodesGyro=null}
  const cv=$('homeNodesCanvas');if(!cv)return;
  const count=nodes.length;
  if(count<1)return;
  const dpr=window.devicePixelRatio||1;
  const W=window.innerWidth,H=window.innerHeight;
  cv.width=W*dpr;cv.height=H*dpr;
  cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');
  ctx.scale(dpr,dpr);
  // Generate node positions in an organic circle
  const pts=[];
  for(let i=0;i<count;i++){
    const angle=(i/count)*Math.PI*2+Math.random()*0.3;
    const radius=60+Math.random()*80+Math.min(count,20)*3;
    pts.push({
      x:Math.cos(angle)*radius+(Math.random()-0.5)*20,
      y:Math.sin(angle)*radius+(Math.random()-0.5)*20,
      r:2+Math.random()*2.5,
      phase:Math.random()*Math.PI*2,
      a:0.06+Math.random()*0.06
    });
  }
  // Generate connections (each node connects to 1-2 neighbors)
  const links=[];
  for(let i=0;i<pts.length;i++){
    const next=(i+1)%pts.length;
    links.push([i,next]);
    if(Math.random()>0.5&&pts.length>3){
      const skip=(i+2)%pts.length;
      links.push([i,skip]);
    }
  }
  let tiltX=0,tiltY=0,rawTX=0,rawTY=0;
  _homeNodesGyro=function(e){
    rawTX=Math.max(-1,Math.min(1,(e.gamma||0)/15));
    rawTY=Math.max(-1,Math.min(1,((e.beta||0)-45)/15));
  };
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(function(p){
      if(p==='granted')window.addEventListener('deviceorientation',_homeNodesGyro);
    }).catch(function(){});
  }else{
    window.addEventListener('deviceorientation',_homeNodesGyro);
  }
  const t0=performance.now();
  function draw(){
    _homeNodesAnim=requestAnimationFrame(draw);
    const t=(performance.now()-t0)/1000;
    tiltX+=(rawTX-tiltX)*0.06;
    tiltY+=(rawTY-tiltY)*0.06;
    ctx.clearRect(0,0,W,H);
    // Slow rotation + tilt offset
    const rot=t*0.08;
    const cx=W/2+tiltX*40;
    const cy=H*0.42+tiltY*30;
    // Draw connections
    ctx.lineWidth=0.5;
    links.forEach(([a,b])=>{
      const pa=pts[a],pb=pts[b];
      const ax=cx+Math.cos(rot)*pa.x-Math.sin(rot)*pa.y;
      const ay=cy+Math.sin(rot)*pa.x+Math.cos(rot)*pa.y;
      const bx=cx+Math.cos(rot)*pb.x-Math.sin(rot)*pb.y;
      const by=cy+Math.sin(rot)*pb.x+Math.cos(rot)*pb.y;
      const avg=(pa.a+pb.a)/2;
      ctx.beginPath();ctx.moveTo(ax,ay);ctx.lineTo(bx,by);
      ctx.strokeStyle='rgba(255,107,53,'+(avg*0.4).toFixed(3)+')';ctx.stroke();
    });
    // Draw nodes
    pts.forEach(p=>{
      const nx=cx+Math.cos(rot)*p.x-Math.sin(rot)*p.y;
      const ny=cy+Math.sin(rot)*p.x+Math.cos(rot)*p.y;
      const pulse=p.a+Math.sin(t*1.5+p.phase)*0.02;
      ctx.beginPath();ctx.arc(nx,ny,p.r,0,Math.PI*2);
      ctx.fillStyle='rgba(255,107,53,'+pulse.toFixed(3)+')';ctx.fill();
      // Tiny glow
      const g=ctx.createRadialGradient(nx,ny,0,nx,ny,p.r*4);
      g.addColorStop(0,'rgba(255,107,53,'+(pulse*0.3).toFixed(3)+')');
      g.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(nx,ny,p.r*4,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
    });
  }
  draw();
}

// ═══ REGISTER ═══
let nickCheckTimer=null;
// ── NICK CREATIVITY ENGINE ──
const _commonNames=['maria','joao','pedro','ana','lucas','julia','rafael','gabriela','marcos','felipe','bruno','carlos','daniel','fernanda','gustavo','leticia','mateus','patricia','rodrigo','thiago','andre','amanda','camila','diego','eduardo','fabio','helena','igor','jessica','larissa','leonardo','mariana','natalia','paulo','renata','samuel','tatiana','vitor','william','gabriel','isabela','miguel','sophia','alice','arthur','bernardo','cecilia','davi','elena','francisco','giovanna','henrique','laura','luana','luiza','manuela','nicolas','olivia','valentina','yasmin'];
const _tooSimple=['teste','test','nick','user','nome','name','hello','oi','hey','abc','aaa','zzz','asdf','qwerty','admin'];
const _coolSuggestions=['phantomX','nebulosa','eclipse_total','trov4o','corvo_azul','nuvem_negra','raio_solar','vulcano','criatura','mist3rio','tempestade','sombra_lunar','faisca','cosmico','avatar_zero','noturno','alquimista','estrela_rara','cyber_soul','gravidade'];

function _nickCreativity(nick){
  const lower=nick.toLowerCase().replace(/[_.\-]/g,'');
  // Check if it's a real name
  const isRealName=_commonNames.some(n=>lower.includes(n))||/^[A-Z][a-z]{2,}$/.test(nick);
  if(isRealName)return{level:'boring',icon:'🚫',msg:'Parece um nome real! Lembre-se: o nick protege sua identidade. Crie algo único que represente você!'};
  // Check if too simple / boring
  if(_tooSimple.includes(lower)||/^(.)\1+$/.test(lower))return{level:'boring',icon:'😴',msg:'Isso é muito simples... você tem a chance de criar algo único! Solte a criatividade.'};
  // Check if just numbers
  if(/^\d+$/.test(nick))return{level:'boring',icon:'🔢',msg:'Só números? Você merece mais! Misture letras, crie algo que as pessoas lembrem de você.'};
  // Mostly numbers
  if((nick.replace(/[^0-9]/g,'').length/nick.length)>0.6)return{level:'meh',icon:'🤔',msg:'Muitos números... tenta ser mais criativo! Um bom nick marca presença.'};
  // Short but ok
  if(nick.length<=3)return{level:'meh',icon:'💭',msg:'Curtinho... funciona, mas nicks mais criativos chamam mais atenção!'};
  // Has special chars (_, .)  — creative formatting
  const hasFormat=/[_.\-]/.test(nick);
  const hasMixedCase=/[a-z]/.test(nick)&&/[A-Z]/.test(nick);
  const hasL33t=/[0-9]/.test(nick)&&/[a-zA-Z]/.test(nick)&&(nick.replace(/[^0-9]/g,'').length/nick.length)<0.4;
  const isLong=nick.length>=6;
  let score=0;
  if(hasFormat)score++;
  if(hasMixedCase)score++;
  if(hasL33t)score++;
  if(isLong)score++;
  if(nick.length>=10)score++;
  if(score>=3)return{level:'great',icon:'🔥',msg:'"'+nick+'" é poderoso! Misterioso, único — as pessoas vão lembrar de você.'};
  if(score>=2)return{level:'good',icon:'✨',msg:'"'+nick+'" tá muito bom! Criativo e marcante.'};
  if(isLong)return{level:'good',icon:'👀',msg:'"'+nick+'" tem personalidade! Tá no caminho certo.'};
  return{level:'meh',icon:'💡',msg:'Tá ok... mas você pode mais! Misture letras e números, use _ ou . — crie uma identidade.'};
}

function _showNickFeedback(nick,feedbackEl){
  if(!feedbackEl)return;
  if(!nick||nick.length<2){feedbackEl.className='nick-feedback';return}
  const fb=_nickCreativity(nick);
  feedbackEl.className='nick-feedback visible '+fb.level;
  // Build message with optional suggestions
  let html='<span class="nf-icon">'+fb.icon+'</span> '+fb.msg;
  if(fb.level==='boring'||fb.level==='meh'){
    // Pick 3 random suggestions
    const shuffled=[..._coolSuggestions].sort(()=>Math.random()-.5).slice(0,3);
    html+='<br><span style="opacity:.6;font-size:.65rem">Que tal: </span>';
    html+=shuffled.map(s=>'<span class="nf-suggest" onclick="this.closest(\'.screen,.login-form\').querySelector(\'input[type=text]\').value=\''+s+'\';this.closest(\'.screen,.login-form\').querySelector(\'input[type=text]\').dispatchEvent(new Event(\'input\'))">'+s+'</span>').join(' · ');
  }
  feedbackEl.innerHTML=html;
}

function checkNick(val){
  const nick=val.trim(),hint=$('nickHint'),preview=$('avatarPreview'),fb=$('nickFeedback');
  if(!nick||nick.length<2){hint.textContent='mínimo 2 caracteres';hint.className='nick-hint';preview.textContent='?';preview.style.background='var(--s2)';_showNickFeedback('',fb);return}
  if(!/^[a-zA-Z0-9_.\-]+$/.test(nick)){hint.textContent='só letras, números, _ . -';hint.className='nick-hint taken';_showNickFeedback('',fb);return}
  // Update preview avatar — show anonymous silhouette
  preview.innerHTML=ANON_AVATAR_SVG;preview.style.background='none';preview.style.overflow='hidden';
  // Show creativity feedback instantly
  _showNickFeedback(nick,fb);
  // Debounced availability check
  clearTimeout(nickCheckTimer);
  hint.textContent='verificando...';hint.className='nick-hint';
  nickCheckTimer=setTimeout(async()=>{
    try{
      const r=await fetch('/api/check-nick/'+encodeURIComponent(nick));const d=await r.json();
      if(d.available){hint.textContent='✓ "'+nick+'" está livre e é seu!';hint.className='nick-hint ok'}
      else{hint.textContent='já existe — tente outro';hint.className='nick-hint taken'}
    }catch(e){hint.textContent='';hint.className='nick-hint'}
  },400);
}
// Login form nick checker (same logic, different elements)
function checkNickLogin(val){
  const nick=val.trim(),fb=$('nickFeedbackLogin');
  _showNickFeedback(nick,fb);
}
function nickColor(nick){let h=0;for(let i=0;i<nick.length;i++)h=nick.charCodeAt(i)+((h<<5)-h);return'hsl('+Math.abs(h)%360+',65%,55%)'}
const VERIFIED_SVG='<svg viewBox="0 0 24 24"><path fill="url(#verifiedGrad)" d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5 12 21.04l3.4 1.46 1.89-3.19 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.8 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.34z"/></svg>';
function verifiedBadge(sizeClass){return '<div class="verified-badge '+(sizeClass||'')+'">'+VERIFIED_SVG+'</div>'}

// ══ ANONYMOUS AVATAR SYSTEM ══
// Base silhouette SVG (modern anonymous shadow)
const ANON_AVATAR_SVG='<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="anonBg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#2a2a3e"/><stop offset="100%" stop-color="#1a1a2e"/></linearGradient><linearGradient id="anonBody" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#4a4a6a"/><stop offset="100%" stop-color="#3a3a5a"/></linearGradient></defs><circle cx="50" cy="50" r="50" fill="url(#anonBg)"/><circle cx="50" cy="38" r="16" fill="url(#anonBody)"/><ellipse cx="50" cy="78" rx="26" ry="18" fill="url(#anonBody)"/></svg>';

// Accessories: 5 for Touch Plus, 5 exclusive for Top1
const AVATAR_ACCESSORIES={
  // ── TOUCH PLUS (5) ──
  crown:{name:'Coroa',tier:'plus',svg:'<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><polygon points="26,28 34,14 42,24 50,8 58,24 66,14 74,28 72,32 28,32" fill="#FFD700" stroke="#DAA520" stroke-width="1"/><rect x="28" y="30" width="44" height="5" rx="1" fill="#FFD700" stroke="#DAA520" stroke-width="0.5"/><circle cx="34" cy="16" r="2" fill="#FF4444"/><circle cx="50" cy="10" r="2.5" fill="#4488FF"/><circle cx="66" cy="16" r="2" fill="#44DD44"/></svg>'},
  cat_ears:{name:'Orelhas de Gato',tier:'plus',svg:'<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M24,38 L20,12 L38,28 Z" fill="#ff69b4" stroke="#ff1493" stroke-width="1"/><path d="M26,34 L23,17 L36,29 Z" fill="#ffb6c1"/><path d="M76,38 L80,12 L62,28 Z" fill="#ff69b4" stroke="#ff1493" stroke-width="1"/><path d="M74,34 L77,17 L64,29 Z" fill="#ffb6c1"/></svg>'},
  halo:{name:'Auréola',tier:'plus',svg:'<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="18" rx="22" ry="6" fill="none" stroke="#FFD700" stroke-width="2.5" opacity="0.9"/><ellipse cx="50" cy="18" rx="22" ry="6" fill="none" stroke="#FFF8DC" stroke-width="1" opacity="0.5"/></svg>'},
  glasses:{name:'Óculos Estilosos',tier:'plus',svg:'<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="38" cy="38" r="9" fill="none" stroke="#00e5ff" stroke-width="2"/><circle cx="62" cy="38" r="9" fill="none" stroke="#00e5ff" stroke-width="2"/><line x1="47" y1="38" x2="53" y2="38" stroke="#00e5ff" stroke-width="2"/><line x1="29" y1="36" x2="24" y2="34" stroke="#00e5ff" stroke-width="1.5"/><line x1="71" y1="36" x2="76" y2="34" stroke="#00e5ff" stroke-width="1.5"/><circle cx="38" cy="38" r="9" fill="rgba(0,229,255,0.08)"/><circle cx="62" cy="38" r="9" fill="rgba(0,229,255,0.08)"/></svg>'},
  flame_aura:{name:'Aura de Fogo',tier:'plus',svg:'<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="flameG" x1="0" y1="1" x2="0" y2="0"><stop offset="0%" stop-color="#ff4500" stop-opacity="0.7"/><stop offset="100%" stop-color="#ffd700" stop-opacity="0"/></linearGradient></defs><ellipse cx="50" cy="50" rx="44" ry="46" fill="none" stroke="url(#flameG)" stroke-width="4" opacity="0.6"/><path d="M30,70 Q28,55 34,45 Q30,55 36,60 Z" fill="#ff6347" opacity="0.5"/><path d="M70,70 Q72,55 66,45 Q70,55 64,60 Z" fill="#ff6347" opacity="0.5"/><path d="M44,15 Q46,6 50,2 Q54,6 56,15 Q52,10 50,12 Q48,10 44,15 Z" fill="#ff8c00" opacity="0.6"/></svg>'},
  // ── TOP 1 EXCLUSIVE (5 more) ──
  diamond_crown:{name:'Coroa de Diamante',tier:'top1',svg:'<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><polygon points="26,30 34,16 42,26 50,6 58,26 66,16 74,30 72,34 28,34" fill="#b9f2ff" stroke="#00bcd4" stroke-width="1"/><rect x="28" y="32" width="44" height="5" rx="1" fill="#e0f7fa" stroke="#00bcd4" stroke-width="0.5"/><polygon points="50,8 46,16 54,16" fill="#fff" opacity="0.8"/><circle cx="34" cy="18" r="2" fill="#e0f7fa" stroke="#00bcd4" stroke-width="0.5"/><circle cx="66" cy="18" r="2" fill="#e0f7fa" stroke="#00bcd4" stroke-width="0.5"/></svg>'},
  lightning:{name:'Raio',tier:'top1',svg:'<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M55,2 L42,38 L52,38 L40,62 L68,28 L56,28 L66,2 Z" fill="#FFD700" stroke="#FFA500" stroke-width="0.8" opacity="0.85"/><path d="M57,4 L46,34 L54,34 L44,56 L65,30 L56,30 L64,4 Z" fill="#FFF8DC" opacity="0.4"/></svg>'},
  mask:{name:'Máscara Phantom',tier:'top1',svg:'<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M24,34 Q24,26 36,24 Q44,22 50,24 Q56,22 64,24 Q76,26 76,34 Q76,42 66,44 Q60,44 56,40 Q54,38 50,38 Q46,38 44,40 Q40,44 34,44 Q24,42 24,34 Z" fill="#1a1a2e" stroke="#8b5cf6" stroke-width="1.5"/><ellipse cx="38" cy="34" rx="7" ry="5" fill="none" stroke="#8b5cf6" stroke-width="1"/><ellipse cx="62" cy="34" rx="7" ry="5" fill="none" stroke="#8b5cf6" stroke-width="1"/><ellipse cx="38" cy="34" rx="7" ry="5" fill="rgba(139,92,246,0.1)"/><ellipse cx="62" cy="34" rx="7" ry="5" fill="rgba(139,92,246,0.1)"/></svg>'},
  galaxy_ring:{name:'Anel Galáxia',tier:'top1',svg:'<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="galG" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#8b5cf6"/><stop offset="50%" stop-color="#ec4899"/><stop offset="100%" stop-color="#06b6d4"/></linearGradient></defs><circle cx="50" cy="50" r="46" fill="none" stroke="url(#galG)" stroke-width="2.5" opacity="0.7"/><circle cx="50" cy="50" r="43" fill="none" stroke="url(#galG)" stroke-width="0.5" opacity="0.4"/><circle cx="20" cy="30" r="1.2" fill="#fff" opacity="0.7"/><circle cx="78" cy="25" r="1" fill="#fff" opacity="0.6"/><circle cx="15" cy="55" r="0.8" fill="#fff" opacity="0.5"/><circle cx="85" cy="60" r="1.1" fill="#fff" opacity="0.6"/><circle cx="30" cy="12" r="0.9" fill="#fff" opacity="0.5"/><circle cx="72" cy="85" r="1" fill="#fff" opacity="0.5"/></svg>'},
  wings:{name:'Asas de Anjo',tier:'top1',svg:'<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M22,50 Q8,40 6,28 Q8,20 16,22 Q12,30 18,36 Q14,26 20,20 Q26,24 24,34 Q22,26 28,22 Q32,28 28,40 Z" fill="#e8e8f0" stroke="#c0c0d0" stroke-width="0.5" opacity="0.75"/><path d="M78,50 Q92,40 94,28 Q92,20 84,22 Q88,30 82,36 Q86,26 80,20 Q74,24 76,34 Q78,26 72,22 Q68,28 72,40 Z" fill="#e8e8f0" stroke="#c0c0d0" stroke-width="0.5" opacity="0.75"/></svg>'}
};
const ACCESSORY_LIST=Object.keys(AVATAR_ACCESSORIES);
const PLUS_ACCESSORIES=ACCESSORY_LIST.filter(k=>AVATAR_ACCESSORIES[k].tier==='plus');
const TOP1_ACCESSORIES=ACCESSORY_LIST.filter(k=>AVATAR_ACCESSORIES[k].tier==='top1');

// Pre-render SVG to Image for canvas use
const _anonImg=new Image();
_anonImg.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(ANON_AVATAR_SVG);
let _anonImgReady=false;
_anonImg.onload=()=>{_anonImgReady=true};

const _accImgCache={};
function getAccessoryImg(accKey){
  if(_accImgCache[accKey])return _accImgCache[accKey];
  const acc=AVATAR_ACCESSORIES[accKey];
  if(!acc)return null;
  const img=new Image();
  img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(acc.svg);
  _accImgCache[accKey]={img,ready:false};
  img.onload=()=>{_accImgCache[accKey].ready=true};
  return _accImgCache[accKey];
}
// Pre-load all accessories
ACCESSORY_LIST.forEach(k=>getAccessoryImg(k));

// Get user's allowed accessories based on subscription tier
function getAllowedAccessories(userTier){
  if(userTier==='top1')return ACCESSORY_LIST; // all 10
  if(userTier==='plus')return PLUS_ACCESSORIES; // 5
  return[]; // free users: no accessories
}

function makeAvatar(nick,color,size,photo,verified,accessoryKey){
  size=size||44;
  const sizeClass=size<=30?'verified-badge-sm':size>=60?'verified-badge-lg':'';
  let inner;
  if(photo&&photo.length>10){
    // Real photo — NO accessory overlay (accessory is for anonymous identity only)
    inner='<div style="width:'+size+'px;height:'+size+'px;border-radius:50%;overflow:hidden;flex-shrink:0;border:1.5px solid rgba(255,255,255,.12);box-shadow:0 2px 8px rgba(0,0,0,.2)"><img src="'+photo+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>';
  } else {
    // Anonymous silhouette avatar
    inner='<div style="position:relative;width:'+size+'px;height:'+size+'px;border-radius:50%;overflow:visible;flex-shrink:0">'
      +'<div style="width:'+size+'px;height:'+size+'px;border-radius:50%;overflow:hidden;border:1.5px solid rgba(255,255,255,.12);box-shadow:0 2px 8px rgba(0,0,0,.2)">'+ANON_AVATAR_SVG+'</div>';
    if(accessoryKey&&AVATAR_ACCESSORIES[accessoryKey]){
      inner+='<div style="position:absolute;top:0;left:0;width:'+size+'px;height:'+size+'px;pointer-events:none">'+AVATAR_ACCESSORIES[accessoryKey].svg+'</div>';
    }
    inner+='</div>';
  }
  if(verified) return '<div class="verified-wrap">'+inner+verifiedBadge(sizeClass)+'</div>';
  return inner;
}
async function doRegister(){
  const nick=$('regNick').value.trim(),birth=$('regBirth').value,terms=$('regTerms').checked,termsUso=$('regTermsUso').checked;
  if(!nick||nick.length<2)return showToast('Escolha um nickname.');if(!birth)return showToast('Data de nascimento.');if(!terms)return showToast('Aceite os termos.');if(!termsUso)return showToast('Aceite os Termos de Uso.');
  if(!/^[a-zA-Z0-9_.-]+$/.test(nick))return showToast('Nickname: só letras, números, _ . -');
  try{
    // If user already has ID (came from Firebase link), use update; else register new
    const endpoint=state.userId?'/api/register':'/api/register';
    const body={nickname:nick,birthdate:birth,acceptedTerms:true};
    if(state.userId)body.userId=state.userId;
    const r=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    if(d.userId){
      state.userId=d.userId;state.userName=nick;state.userColor=d.user.color;
      state.userPhoto=d.user.profilePhoto||d.user.photoURL||null;
      localStorage.setItem('touch_userId',d.userId);localStorage.setItem('touch_userName',nick);localStorage.setItem('touch_userColor',d.user.color||'');
      if(state.userPhoto)localStorage.setItem('touch_userPhoto',state.userPhoto);
      // Link with Firebase if signed in
      if(fbUser&&firebaseAuthInstance){
        try{await linkFirebaseToEncosta(fbUser)}catch(e){}
      }
      initSocket();requestAccelPermission();showScreen('home');
      $('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(nick)+'</span>';
      state.userAccessory=d.user.avatarAccessory||null;
      state.userProfession=d.user.profession||null;
      state.userSports=d.user.sports||[];
      state.userHobbies=d.user.hobbies||[];
      const _ha=$('homeAvatar');if(_ha){
        _ha.innerHTML=makeAvatar(nick,d.user.color||nickColor(nick),40,state.userPhoto||null,false,state.userAccessory);
        _ha.style.background='none';_ha.style.overflow='visible';
      }
      haptic([80]);
    }
  }catch(e){showToast('Erro ao registrar.')}
}

// ═══ ENCOUNTER ═══
// ═══ SERVICE MODE ═══
let serviceMode=false;
function toggleServiceMode(){
  serviceMode=!serviceMode;
  const toggle=$('serviceToggle');
  const btn=$('mainBtn');
  if(serviceMode){
    toggle.classList.add('active');
    $('serviceToggleLabel').textContent='Serviço ativo';
    btn.classList.add('service-mode');
    $('mainBtnText').textContent='SERVIÇO';
    haptic([60,20,60]);
  }else{
    toggle.classList.remove('active');
    $('serviceToggleLabel').textContent='Modo Serviço';
    btn.classList.remove('service-mode');
    $('mainBtnText').textContent='TOUCH';
    haptic([30]);
  }
}
function initServiceToggle(){
  const isPrest=localStorage.getItem('touch_isPrestador')==='1';
  const svcEnabled=localStorage.getItem('touch_serviceModeEnabled')==='1';
  const toggle=$('serviceToggle');
  // Only show service button if user is prestador AND has enabled it in settings
  if(isPrest&&svcEnabled&&toggle)toggle.classList.remove('hidden');
  else if(toggle)toggle.classList.add('hidden');
}
function toggleServiceModeEnabled(on){
  localStorage.setItem('touch_serviceModeEnabled',on?'1':'0');
  initServiceToggle();
  // Update the switch visuals
  const sw=$('svcModeSwitch');
  if(sw){
    const span=sw.nextElementSibling;
    const dot=span?span.nextElementSibling:null;
    if(span)span.style.background=on?'#22c55e':'rgba(255,255,255,.12)';
    if(dot)dot.style.left=on?'22px':'2px';
  }
  haptic([20]);
}

function startEncounter(){haptic([40]);showScreen('encounter');showPhase('phaseChoose');$('joinCodeInput').value=''}

// ═══ MAIN BUTTON — sonic first, code fallback ═══
let homeSonicActive=false;
let _sonicWasActive=false; // track if sonic was running before background/disconnect
async function handleMainButton(){
  if(!state.userId){showToast('Faça login primeiro.');showScreen('login');return}
  if(homeSonicActive){stopHomeSonic();return}
  if(!socket){showToast('Sem conexão. Aguarde...');return}

  // ═══ STEP 0: Create AudioContexts IMMEDIATELY on click ═══
  // MUST happen BEFORE any await — browsers kill audio permission
  // after the first async break from the user gesture.
  // Even waiting for socket reconnection loses the gesture!
  stopSonicMode();
  if(sonicStream){sonicStream.getTracks().forEach(t=>t.stop());sonicStream=null;}
  sonicEmitCtx=new(window.AudioContext||window.webkitAudioContext)();
  sonicMicCtx=new(window.AudioContext||window.webkitAudioContext)();
  // Resume synchronously (no await) — just fire and forget, they resolve fast
  sonicEmitCtx.resume();
  sonicMicCtx.resume();
  console.log('[sonic] AudioContexts created+resumed in gesture. Emit:',sonicEmitCtx.state,'Mic:',sonicMicCtx.state);

  haptic([40]);

  // Now safe to do async work — AudioContexts already unlocked
  if(!socket.connected){
    showToast('Reconectando...');
    const waited=await new Promise(r=>{
      if(socket.connected)return r(true);
      const t=setTimeout(()=>r(false),3000);
      socket.once('connect',()=>{clearTimeout(t);r(true)});
    });
    if(!waited){
      // Cleanup the contexts we just created
      try{sonicEmitCtx.close()}catch(e){}
      try{sonicMicCtx.close()}catch(e){}
      sonicEmitCtx=null;sonicMicCtx=null;
      showToast('Sem conexão. Tente novamente.');return;
    }
  }

  homeSonicActive=true;
  sonicActive=true;sonicMyFreq=0;
  const btn=$('mainBtn'),txt=$('mainBtnText'),sts=$('sonicHomeStatus'),fb=$('sonicFallback');
  const barsL=$('sonicBarsL'),barsR=$('sonicBarsR'),fire=$('fireOverlay');
  btn.classList.add('shake-activate');
  setTimeout(()=>btn.classList.remove('shake-activate'),700);
  btn.classList.add('energized');
  txt.textContent='ATIVANDO...';
  sts.textContent='Preparando áudio...';sts.classList.add('active');
  fb.classList.remove('active');
  barsL.classList.add('active');barsR.classList.add('active');
  if(fire)fire.classList.add('active');
  const si=$('sonicInstruct');if(si)si.classList.add('active');

  try{
    // 1. Fresh mic permission
    sts.textContent='Pedindo microfone...';
    sonicStream=await requestMic();
    if(!homeSonicActive)return;
    sts.textContent='Conectando ao servidor...';

    // 2. Get frequency from server
    const _activeEvId=localStorage.getItem('activeEventId')||null;
    const _isOperator=localStorage.getItem('activeEventRole')==='operator';
    const _isCheckin=!!(_activeEvId&&_isOperator);
    socket.emit('sonic-start',{userId:state.userId,isServiceTouch:!!serviceMode,isCheckin:_isCheckin,eventId:_isCheckin?_activeEvId:null});
    const freq=await new Promise((resolve,reject)=>{
      const t=setTimeout(()=>reject(new Error('Timeout')),5000);
      socket.once('sonic-assigned',({freq})=>{clearTimeout(t);resolve(freq)});
    });
    if(!homeSonicActive)return;
    sonicMyFreq=freq;

    // 3. Emit ultrasonic — using the ALREADY RUNNING AudioContext
    // Re-verify context is still running (paranoia check)
    if(sonicEmitCtx.state==='suspended'){await sonicEmitCtx.resume()}
    sonicOsc=sonicEmitCtx.createOscillator();
    sonicOsc.type='sine';
    sonicOsc.frequency.setValueAtTime(freq,sonicEmitCtx.currentTime);
    const gain=sonicEmitCtx.createGain();
    gain.gain.setValueAtTime(0.9,sonicEmitCtx.currentTime);
    sonicOsc.connect(gain);gain.connect(sonicEmitCtx.destination);
    sonicOsc.start();
    console.log('[sonic] Oscillator started at',freq,'Hz. EmitCtx:',sonicEmitCtx.state);

    // 4. Start detection — using the ALREADY RUNNING mic AudioContext
    if(sonicMicCtx.state==='suspended'){await sonicMicCtx.resume()}
    const source=sonicMicCtx.createMediaStreamSource(sonicStream);
    sonicAnalyser=sonicMicCtx.createAnalyser();
    sonicAnalyser.fftSize=SONIC_FFT_SIZE;
    sonicAnalyser.smoothingTimeConstant=0.3;
    source.connect(sonicAnalyser);
    const bufLen=sonicAnalyser.frequencyBinCount;
    const dataArr=new Uint8Array(bufLen);
    const sampleRate=sonicMicCtx.sampleRate;
    const freqPerBin=sampleRate/SONIC_FFT_SIZE;

    // 5. HEALTH CHECK
    const _micTrack=sonicStream.getAudioTracks()[0];
    if(!_micTrack||_micTrack.readyState==='ended'||!_micTrack.enabled){
      console.warn('[sonic] Mic track dead on start');
      stopHomeSonic();
      showToast('Reiniciando microfone...');
      setTimeout(()=>location.reload(),800);
      return;
    }
    // Final context check
    if(sonicEmitCtx.state!=='running'||sonicMicCtx.state!=='running'){
      console.warn('[sonic] AudioContext STILL not running after all setup:',sonicEmitCtx.state,sonicMicCtx.state);
      try{await sonicEmitCtx.resume();await sonicMicCtx.resume()}catch(e){}
      if(sonicEmitCtx.state!=='running'||sonicMicCtx.state!=='running'){
        stopHomeSonic();
        showToast('Áudio travado, reiniciando...');
        setTimeout(()=>location.reload(),800);
        return;
      }
    }

    txt.textContent='TOUCHING...';
    sts.textContent='Encoste os alto-falantes 🔊';
    setTimeout(()=>{if(homeSonicActive){fb.classList.add('active');sts.textContent='Encoste os alto-falantes ou use código'}},10000);

    // Delayed deep health check: after 3s verify mic is actually producing data
    setTimeout(()=>{
      if(!homeSonicActive||!sonicAnalyser)return;
      const testBuf=new Uint8Array(sonicAnalyser.frequencyBinCount);
      sonicAnalyser.getByteFrequencyData(testBuf);
      // Check if we get ANY signal at all (sum > 0 means audio pipeline works)
      let totalEnergy=0;
      for(let i=0;i<testBuf.length;i++)totalEnergy+=testBuf[i];
      // Also check mic track is still alive
      const track=sonicStream&&sonicStream.getAudioTracks()[0];
      const trackDead=!track||track.readyState==='ended'||!track.enabled;
      const ctxBroken=sonicEmitCtx.state!=='running'||sonicMicCtx.state!=='running';
      if(trackDead||ctxBroken){
        console.warn('[sonic health] Audio broken after 3s. Track:',track?.readyState,'EmitCtx:',sonicEmitCtx.state,'MicCtx:',sonicMicCtx.state,'Energy:',totalEnergy);
        stopHomeSonic();
        showToast('Microfone travou, reiniciando...');
        setTimeout(()=>location.reload(),800);
      }
    },3000);

    let confirmHits=0,lastSnapped=0,_dbgFrames=0,_sonicCooldown=0;
    function detect(){
      if(!sonicActive)return;
      // Runtime health: if mic track died or AudioContext suspended mid-run → reload
      const _rt=sonicStream&&sonicStream.getAudioTracks()[0];
      if(!_rt||_rt.readyState==='ended'||sonicMicCtx.state!=='running'){
        console.warn('[sonic detect] Audio died mid-run, reloading');
        stopHomeSonic();showToast('Reconectando microfone...');
        setTimeout(()=>location.reload(),600);return;
      }
      // Cooldown after detection — wait for server response
      if(_sonicCooldown>0){_sonicCooldown--;sonicAnimFrame=requestAnimationFrame(detect);return}
      sonicAnalyser.getByteFrequencyData(dataArr);
      const minBin=Math.floor(18000/freqPerBin),maxBin=Math.ceil(20000/freqPerBin);
      let peakVal=0,peakBin=0;
      for(let i=minBin;i<=maxBin&&i<bufLen;i++){if(dataArr[i]>peakVal){peakVal=dataArr[i];peakBin=i}}
      // Show debug info every ~30 frames (~0.5s)
      _dbgFrames++;
      if(_dbgFrames%30===0&&sts){
        const peakHz=Math.round(peakBin*freqPerBin);
        sts.textContent='Ouvindo... sinal: '+peakVal+' freq: '+peakHz+'Hz'+(confirmHits>0?' ('+confirmHits+'/'+SONIC_CONFIRM_COUNT+')':'');
      }
      if(peakVal>=SONIC_DETECT_THRESHOLD){
        const snapped=Math.round(Math.round(peakBin*freqPerBin)/100)*100;
        if(snapped!==sonicMyFreq&&snapped>=18000&&snapped<=19900){
          if(snapped===lastSnapped)confirmHits++;else{confirmHits=1;lastSnapped=snapped}
          if(sts)sts.textContent='Detectando! '+snapped+'Hz ('+confirmHits+'/'+SONIC_CONFIRM_COUNT+')';
          if(confirmHits>=SONIC_CONFIRM_COUNT){
            haptic([100,30,100]);
            txt.textContent='CONECTOU!';sts.textContent='Encontramos alguém!';
            socket.emit('sonic-detected',{userId:state.userId,detectedFreq:snapped});
            // Don't stop immediately — wait for server confirmation
            // Enter cooldown: skip detection for ~3 seconds (180 frames)
            _sonicCooldown=180;confirmHits=0;lastSnapped=0;
            // Timeout: if relation-created doesn't arrive in 12s, show retry
            setTimeout(()=>{
              if(sonicActive&&!state.currentRelation){
                sts.textContent='Conexão não completou. Tentando novamente...';
                txt.textContent='OUVINDO';
                _sonicCooldown=0; // re-enable detection
              }
            },12000);
          }
        }
      }else if(confirmHits>0)confirmHits=Math.max(0,confirmHits-1);
      sonicAnimFrame=requestAnimationFrame(detect);
    }
    detect();
  }catch(e){
    console.error('Sonic error:',e);
    if(e.name==='NotAllowedError'){
      sts.textContent='Microfone negado.';
      fb.classList.add('active');
    }else{
      // Any other audio error (AbortError, InvalidStateError, etc.) → auto-reload
      sts.textContent='Erro de áudio, reiniciando...';
      stopHomeSonic();
      setTimeout(()=>location.reload(),1200);
      return;
    }
  }
}

function stopHomeSonic(){
  homeSonicActive=false;
  stopSonicMode();
  const btn=$('mainBtn'),txt=$('mainBtnText'),status=$('sonicHomeStatus'),fb=$('sonicFallback');
  const barsL=$('sonicBarsL'),barsR=$('sonicBarsR'),fire=$('fireOverlay');
  btn.classList.remove('energized');
  txt.textContent='TOUCH';
  status.classList.remove('active');
  fb.classList.remove('active');
  barsL.classList.remove('active');barsR.classList.remove('active');
  if(fire)fire.classList.remove('active');
  const si=$('sonicInstruct');if(si)si.classList.remove('active');
}
async function createSession(){
  if(!state.userId){showToast('Faça login primeiro.');showScreen('login');return}
  try{
    const r=await fetch('/api/session/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,isServiceTouch:serviceMode})});
    const d=await r.json();
    if(d.error){if(d.error.includes('inválido')){showToast('Sessão expirada. Faça login novamente.');localStorage.clear();showScreen('login');return}return showToast(d.error)}
    state.currentSession=d.sessionId;$('sessionCode').textContent=d.code;showPhase('phaseCode');generateQR(d.code);socket.emit('join-session',d.sessionId);
  }catch(e){showToast('Erro ao criar sessão.')}
}
async function joinSession(){
  const code=$('joinCodeInput').value.trim().toUpperCase();if(!code)return showToast('Digite o código.');
  if(!state.userId){showToast('Faça login primeiro.');showScreen('login');return}
  try{
    const r=await fetch('/api/session/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,code})});
    const d=await r.json();
    if(d.error){if(d.error.includes('inválido')){showToast('Sessão expirada.');localStorage.clear();showScreen('login');return}return showToast(d.error)}
    if(d.relationId){
      state.currentRelation=d;playSound('connect');
      const co=$('connectingOverlay');
      if(co){
        co.classList.remove('first','renewed');
        co.classList.add(d.renewed?'renewed':'first','active');
        const isQ2=!!(d.isServiceTouch||d.isCheckin);
        const _meA2=d.userA&&d.userA.id===state.userId;
        const _p2=_meA2?d.userB:d.userA;
        startElectricTouch(!!d.renewed,isQ2?'':(_p2?(_p2.nickname||_p2.name||''):''));
        haptic(isQ2?[60,20,60,20,100]:[80,30,80,30,120,40,120,40,150,30,150,30,200,20,200,20,250,15,250,15,300,10,300,10,400,10,500]);
        setTimeout(()=>{stopElectricTouch();if(navigator.vibrate)navigator.vibrate(0);co.classList.remove('active','first','renewed');showScreen('reveal');doReveal(d)},isQ2?1800:4200);
      }else{showScreen('reveal');doReveal(d)}
    }
  }catch(e){showToast('Código inválido ou expirado.')}
}
function generateQR(code){
  const canvas=$('qrCanvas'),ctx=canvas.getContext('2d');canvas.width=180;canvas.height=180;ctx.clearRect(0,0,180,180);
  if(typeof QRCode!=='undefined'){const tmp=document.createElement('div');new QRCode(tmp,{text:location.origin+'?code='+code,width:180,height:180,colorDark:'#0a0a0a',colorLight:'#ffffff'});setTimeout(()=>{const src=tmp.querySelector('img')||tmp.querySelector('canvas');if(src){if(src.tagName==='CANVAS')ctx.drawImage(src,0,0,180,180);else{const i=new Image();i.onload=()=>ctx.drawImage(i,0,0,180,180);i.src=src.src}}},200)}
}

// ═══ SONIC — ultrasonic phone-to-phone ═══
let sonicActive=false,sonicEmitCtx=null,sonicOsc=null,sonicStream=null,sonicMicCtx=null,sonicAnalyser=null,sonicAnimFrame=null,sonicMyFreq=0;
const SONIC_FFT_SIZE=8192;
const SONIC_DETECT_THRESHOLD=50; // lowered further: phone speakers/mics are very weak at 18kHz+
const SONIC_CONFIRM_COUNT=3; // need 3 consecutive detections to confirm (anti false-positive)

// Request mic permission and return stream (reusable)
async function requestMic(){
  return navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
}

function startSonicMode(){
  if(!state.userId){showToast('Faça login primeiro.');showScreen('login');return}
  if(!socket||!socket.connected){showToast('Sem conexão. Aguarde...');return}
  // Full reset
  stopSonicMode();
  showPhase('phaseBump');
  const circle=$('bumpCircle'),label=$('bumpLabel'),status=$('bumpStatus');
  circle.className='bump-circle';label.textContent='PREPARANDO...';
  status.textContent='Preparando áudio...';
  sonicActive=true;sonicMyFreq=0;
  // ═══ Create AudioContexts in user gesture! ═══
  sonicEmitCtx=new(window.AudioContext||window.webkitAudioContext)();
  sonicMicCtx=new(window.AudioContext||window.webkitAudioContext)();
  sonicEmitCtx.resume();sonicMicCtx.resume();
  console.log('[sonic alt] Contexts created in gesture. Emit:',sonicEmitCtx.state,'Mic:',sonicMicCtx.state);
  initSonic(label,status,circle);
}

async function initSonic(label,status,circle){
  try{
    // 1. Get mic permission
    if(status)status.textContent='Pedindo microfone...';
    sonicStream=await requestMic();
    if(status)status.textContent='Microfone OK. Conectando...';

    // 2. Ask server for frequency
    const _sEvId=localStorage.getItem('activeEventId')||null;
    const _sIsOp=localStorage.getItem('activeEventRole')==='operator';
    const _sIsCheckin=!!(_sEvId&&_sIsOp);
    socket.emit('sonic-start',{userId:state.userId,isServiceTouch:!!serviceMode,isCheckin:_sIsCheckin,eventId:_sIsCheckin?_sEvId:null});
    const freq=await new Promise((resolve,reject)=>{
      const timeout=setTimeout(()=>reject(new Error('Server timeout')),5000);
      socket.once('sonic-assigned',({freq})=>{clearTimeout(timeout);resolve(freq)});
    });
    if(!sonicActive)return;
    sonicMyFreq=freq;

    // 3. Start emitting — context already running from gesture!
    if(sonicEmitCtx.state==='suspended')await sonicEmitCtx.resume();
    sonicOsc=sonicEmitCtx.createOscillator();
    sonicOsc.type='sine';
    sonicOsc.frequency.setValueAtTime(freq,sonicEmitCtx.currentTime);
    const gain=sonicEmitCtx.createGain();
    gain.gain.setValueAtTime(0.9,sonicEmitCtx.currentTime);
    sonicOsc.connect(gain);
    gain.connect(sonicEmitCtx.destination);
    sonicOsc.start();
    console.log('[sonic alt] Oscillator started at',freq,'Hz');

    // 4. Start listening — context already running from gesture!
    if(sonicMicCtx.state==='suspended')await sonicMicCtx.resume();
    const source=sonicMicCtx.createMediaStreamSource(sonicStream);
    sonicAnalyser=sonicMicCtx.createAnalyser();
    sonicAnalyser.fftSize=SONIC_FFT_SIZE;
    sonicAnalyser.smoothingTimeConstant=0.3;
    source.connect(sonicAnalyser);
    const bufLen=sonicAnalyser.frequencyBinCount;
    const dataArr=new Uint8Array(bufLen);
    const sampleRate=sonicMicCtx.sampleRate;
    const freqPerBin=sampleRate/SONIC_FFT_SIZE;

    if(circle)circle.classList.add('listening');
    if(label)label.textContent='TOUCH!';
    if(status)status.textContent='Aproxime os celulares...';

    let confirmHits=0,lastSnapped=0,_dbgF2=0,_sonicCooldown2=0;

    function detect(){
      if(!sonicActive)return;
      // Runtime health check
      const _rt2=sonicStream&&sonicStream.getAudioTracks()[0];
      if(!_rt2||_rt2.readyState==='ended'||sonicMicCtx.state!=='running'){
        stopSonicMode();showToast('Microfone perdeu conexão, recarregando...');
        setTimeout(()=>location.reload(),600);return;
      }
      if(_sonicCooldown2>0){_sonicCooldown2--;sonicAnimFrame=requestAnimationFrame(detect);return}
      sonicAnalyser.getByteFrequencyData(dataArr);
      const minBin=Math.floor(18000/freqPerBin);
      const maxBin=Math.ceil(20000/freqPerBin);
      let peakVal=0,peakBin=0;
      for(let i=minBin;i<=maxBin&&i<bufLen;i++){
        if(dataArr[i]>peakVal){peakVal=dataArr[i];peakBin=i}
      }
      _dbgF2++;
      if(_dbgF2%30===0&&status){
        const peakHz=Math.round(peakBin*freqPerBin);
        status.textContent='Ouvindo... sinal: '+peakVal+' freq: '+peakHz+'Hz'+(confirmHits>0?' ('+confirmHits+'/'+SONIC_CONFIRM_COUNT+')':'');
      }
      if(peakVal>=SONIC_DETECT_THRESHOLD){
        const detectedFreq=Math.round(peakBin*freqPerBin);
        const snapped=Math.round(detectedFreq/100)*100;
        // Ignore own frequency and out-of-range
        if(snapped!==sonicMyFreq&&snapped>=18000&&snapped<=19900){
          if(snapped===lastSnapped){confirmHits++}else{confirmHits=1;lastSnapped=snapped}
          if(status)status.textContent='Detectando! '+snapped+'Hz ('+confirmHits+'/'+SONIC_CONFIRM_COUNT+')';
          if(confirmHits>=SONIC_CONFIRM_COUNT){
            haptic([100,30,100]);
            if(circle){circle.classList.remove('listening');circle.classList.add('bumped')}
            if(label)label.textContent='CONECTOU!';
            if(status)status.textContent='Conectando...';
            socket.emit('sonic-detected',{userId:state.userId,detectedFreq:snapped});
            _sonicCooldown2=180;confirmHits=0;lastSnapped=0;
            setTimeout(()=>{
              if(sonicActive&&!state.currentRelation){
                if(status)status.textContent='Tentando novamente...';
                if(label)label.textContent='TOUCH!';
                if(circle){circle.classList.remove('bumped');circle.classList.add('listening')}
                _sonicCooldown2=0;
              }
            },12000);
          }
        }
      }else{
        if(confirmHits>0)confirmHits=Math.max(0,confirmHits-1);
      }
      sonicAnimFrame=requestAnimationFrame(detect);
    }
    detect();

  }catch(e){
    console.error('Sonic init error:',e);
    if(status)status.textContent=e.name==='NotAllowedError'?'Microfone negado. Use código.':'Erro: '+e.message;
    sonicActive=false;
    const fb=$('sonicFallback');if(fb)fb.classList.add('active');
  }
}

function stopSonicMode(){
  sonicActive=false;
  // Stop oscillator first (before closing context)
  if(sonicOsc){try{sonicOsc.disconnect();sonicOsc.stop()}catch(e){}}
  // Close AudioContexts — force close to fully release audio hardware
  if(sonicEmitCtx){try{sonicEmitCtx.close()}catch(e){console.log('[sonic] emitCtx close err:',e)}}
  if(sonicMicCtx){try{sonicMicCtx.close()}catch(e){console.log('[sonic] micCtx close err:',e)}}
  // Kill mic stream tracks
  if(sonicStream){try{sonicStream.getTracks().forEach(t=>{t.stop();t.enabled=false})}catch(e){}}
  // Cancel animation loop
  if(sonicAnimFrame){cancelAnimationFrame(sonicAnimFrame)}
  // Null everything — clean slate
  sonicOsc=null;sonicEmitCtx=null;sonicMicCtx=null;sonicStream=null;sonicAnalyser=null;sonicAnimFrame=null;sonicMyFreq=0;
  console.log('[sonic] Full cleanup done');
  if(socket&&socket.connected){
    const _evId=localStorage.getItem('activeEventRole')==='operator'?localStorage.getItem('activeEventId'):null;
    socket.emit('sonic-stop',{userId:state.userId,eventId:_evId});
  }
}

// ═══ TRON CONNECTION — digital beam animation ═══
let _etAnim=null;
function startElectricTouch(isRenewed,partnerName){
  const cv=$('coCanvas');if(!cv)return;
  // Set partner nickname
  const nickEl=$('coNick');
  if(nickEl)nickEl.textContent=partnerName||'';
  const dpr=window.devicePixelRatio||1;
  const W=window.innerWidth,H=window.innerHeight;
  cv.width=W*dpr;cv.height=H*dpr;
  cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');
  ctx.scale(dpr,dpr);
  // Color palette — ORANGE (Touch) for first connection, WHITE for renewed
  const C=isRenewed
    ?{a:'210,220,240',m:'200,210,235',c:'230,238,250',h:'250,252,255',p:'220,230,245'}
    :{a:'255,130,50',m:'255,110,30',c:'255,155,80',h:'255,200,160',p:'255,140,60'};
  const t0=performance.now();

  // ── ZEBRA BEAMS: fewer, taller, more spaced ──
  const beamCount=12;
  const beamSpacing=H/beamCount*1.1;
  const beams=[];
  for(let i=0;i<beamCount;i++){
    beams.push({
      y:H*1.5-i*beamSpacing-Math.random()*30,
      baseSpeed:250+Math.random()*100,
      tubeH:38+Math.random()*28,
      phase:Math.random()*Math.PI*2,
      breatheFreq:.4+Math.random()*.5
    });
  }
  // Burst state
  let nextBurst=0.8+Math.random()*1;
  let burstIntensity=0;
  let burstSpeed=0;

  // Particles riding along beams
  const particles=[];
  for(let i=0;i<45;i++){
    particles.push({
      x:Math.random()*W,beamIdx:Math.floor(Math.random()*beamCount),
      vx:1.5+Math.random()*3,yOff:(Math.random()-0.5)*0.35,
      r:0.4+Math.random()*1.4,a:0.15+Math.random()*0.35,
      phase:Math.random()*Math.PI*2
    });
  }

  function drawBeam(y,tubeH,breathe,intensity){
    const th=tubeH*breathe;
    // Full width beam layers
    const g1=ctx.createLinearGradient(0,y-th*2.5,0,y+th*2.5);
    g1.addColorStop(0,'transparent');g1.addColorStop(0.3,'rgba('+C.a+','+(0.05*intensity)+')');g1.addColorStop(0.5,'rgba('+C.a+','+(0.09*intensity)+')');g1.addColorStop(0.7,'rgba('+C.a+','+(0.05*intensity)+')');g1.addColorStop(1,'transparent');
    ctx.fillStyle=g1;ctx.fillRect(0,y-th*2.5,W,th*5);
    const g2=ctx.createLinearGradient(0,y-th,0,y+th);
    g2.addColorStop(0,'transparent');g2.addColorStop(0.3,'rgba('+C.m+','+(0.08*intensity)+')');g2.addColorStop(0.5,'rgba('+C.m+','+(0.144*intensity)+')');g2.addColorStop(0.7,'rgba('+C.m+','+(0.08*intensity)+')');g2.addColorStop(1,'transparent');
    ctx.fillStyle=g2;ctx.fillRect(0,y-th,W,th*2);
    const g3=ctx.createLinearGradient(0,y-th*0.3,0,y+th*0.3);
    g3.addColorStop(0,'transparent');g3.addColorStop(0.3,'rgba('+C.c+','+(0.15*intensity)+')');g3.addColorStop(0.5,'rgba('+C.c+','+(0.27*intensity)+')');g3.addColorStop(0.7,'rgba('+C.c+','+(0.15*intensity)+')');g3.addColorStop(1,'transparent');
    ctx.fillStyle=g3;ctx.fillRect(0,y-th*0.3,W,th*0.6);
    // Hot wire
    const g4=ctx.createLinearGradient(0,y-1.5,0,y+1.5);
    g4.addColorStop(0,'transparent');g4.addColorStop(0.5,'rgba('+C.h+','+(0.25*intensity)+')');g4.addColorStop(1,'transparent');
    ctx.fillStyle=g4;ctx.fillRect(0,y-1.5,W,3);
  }

  function animate(){
    const now=performance.now();
    const t=(now-t0)/1000;
    const progress=Math.min(1,t/4.0);
    // Burst logic: frequent sudden acceleration surges
    nextBurst-=0.016;
    if(nextBurst<=0){
      burstIntensity=1;
      burstSpeed=900+Math.random()*600;
      nextBurst=1+Math.random()*1.8;
    }
    if(burstIntensity>0)burstIntensity=Math.max(0,burstIntensity-0.018);
    if(burstSpeed>0)burstSpeed=Math.max(0,burstSpeed-12);

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='rgba(0,0,0,0.96)';
    ctx.fillRect(0,0,W,H);

    // ── Move & draw each beam ──
    const globalIntensity=0.6+progress*0.4+burstIntensity*1.2;
    beams.forEach(b=>{
      const speed=b.baseSpeed+burstSpeed;
      b.y-=speed*0.016;
      if(b.y<-b.tubeH*3) b.y=H+b.tubeH*3+Math.random()*40;
      const breathe=1+Math.sin(t*b.breatheFreq+b.phase)*0.06;
      drawBeam(b.y,b.tubeH,breathe,globalIntensity);
      // Flowing streaks on each beam
      for(let i=0;i<2;i++){
        const sx=((t*90*(1+burstIntensity*4)+i*W/2)%(W+120))-60;
        const sLen=50+Math.sin(t*0.8+i)*20;
        const sy=b.y+Math.sin(t*1.2+i*1.3)*b.tubeH*breathe*0.2;
        const sg=ctx.createLinearGradient(sx,sy,sx-sLen,sy);
        sg.addColorStop(0,'rgba('+C.p+','+(0.20*globalIntensity)+')');
        sg.addColorStop(0.5,'rgba('+C.p+','+(0.06*globalIntensity)+')');
        sg.addColorStop(1,'transparent');
        ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx-sLen,sy);
        ctx.strokeStyle=sg;ctx.lineWidth=1.2;ctx.lineCap='round';ctx.stroke();
      }
    });

    // ── Particles riding beams ──
    particles.forEach(p=>{
      p.x+=p.vx*(1+burstIntensity*4);
      if(p.x>W+10)p.x=-10;
      const b=beams[p.beamIdx%beamCount];
      const py=b.y+p.yOff*b.tubeH+Math.sin(t*0.6+p.phase)*b.tubeH*0.08;
      const fl=(p.a+Math.sin(t*2.5+p.phase)*0.1)*globalIntensity;
      if(fl>0){
        ctx.beginPath();ctx.arc(p.x,py,p.r,0,Math.PI*2);
        ctx.fillStyle='rgba('+C.p+','+Math.min(1,fl).toFixed(3)+')';ctx.fill();
      }
    });

    // ── Flash overlay on burst ──
    if(burstIntensity>0.15){
      const fl=$('coFlash');
      if(fl){
        fl.style.opacity=(burstIntensity*0.25).toFixed(3);
        fl.style.background='linear-gradient(180deg,rgba('+C.c+','+(burstIntensity*0.3)+'),transparent 35%,transparent 65%,rgba('+C.c+','+(burstIntensity*0.3)+'))';
      }
    }else{
      const fl=$('coFlash');if(fl)fl.style.opacity='0';
    }

    _etAnim=requestAnimationFrame(animate);
  }
  _etAnim=requestAnimationFrame(animate);
}
function stopElectricTouch(){
  if(_etAnim){cancelAnimationFrame(_etAnim);_etAnim=null}
  const cv=$('coCanvas');if(cv){const c=cv.getContext('2d');c.clearRect(0,0,cv.width,cv.height)}
  const fl=$('coFlash');if(fl){fl.style.opacity='0'}
  const nk=$('coNick');if(nk){nk.textContent='';nk.style.opacity='0'}
}

// ═══ REVEAL — cinematographic ═══
let _rvLightAnim=null;
let _rvLightHandler=null;
function stopRevealLight(){
  if(_rvLightAnim){cancelAnimationFrame(_rvLightAnim);_rvLightAnim=null}
  if(_rvLightHandler){window.removeEventListener('deviceorientation',_rvLightHandler);_rvLightHandler=null}
}
// beamColor: 'white'=new, 'gold'=known>24h, 'green'=renewed<24h, 'red'=<1h no bonus
function startRevealLight(beamColor){
  stopRevealLight();
  const cv=$('rvLightBeam');if(!cv)return;
  const dpr=window.devicePixelRatio||1;
  // Always use window dimensions to guarantee full coverage
  const W=window.innerWidth;
  const H=window.innerHeight;
  cv.width=W*dpr;cv.height=H*dpr;
  cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');
  ctx.scale(dpr,dpr);
  // Color palettes: [ambient, mid, core, hot, particle, edge]
  const palettes={
    white:{a:'200,210,230',m:'180,190,210',c:'220,230,245',h:'245,248,255',p:'210,220,240',e:'180,200,230'},
    gold:{a:'255,180,60',m:'255,160,50',c:'255,200,100',h:'255,235,180',p:'255,190,100',e:'255,170,50'},
    green:{a:'60,220,130',m:'40,200,110',c:'80,240,150',h:'180,255,210',p:'100,230,160',e:'50,210,120'},
    red:{a:'255,80,80',m:'255,60,60',c:'255,120,100',h:'255,200,180',p:'255,100,90',e:'255,70,70'}
  };
  const C=palettes[beamColor]||palettes.white;
  let tiltY=0,rawTY=0;
  _rvLightHandler=function(e){
    rawTY=Math.max(-1,Math.min(1,(e.gamma||0)/10));
  };
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(function(p){
      if(p==='granted')window.addEventListener('deviceorientation',_rvLightHandler);
    }).catch(function(){});
  }else{
    window.addEventListener('deviceorientation',_rvLightHandler);
  }
  const t0=performance.now();
  const particles=Array.from({length:40},()=>({
    x:Math.random()*W,vx:0.5+Math.random()*1.5,
    yOff:(Math.random()-0.5)*0.5,
    r:0.4+Math.random()*1.2,a:0.08+Math.random()*0.2,
    phase:Math.random()*Math.PI*2
  }));
  function animate(){
    const t=(performance.now()-t0)/1000;
    tiltY+=(rawTY-tiltY)*0.18;
    ctx.clearRect(0,0,W,H);
    const beamCY=H*0.47+tiltY*H*0.35;
    const breathe=1+Math.sin(t*0.9)*0.06;
    const tubeH=45*breathe;
    // Layer 1: Wide ambient — full rect 0 to W
    const g1=ctx.createLinearGradient(0,beamCY-tubeH*3,0,beamCY+tubeH*3);
    g1.addColorStop(0,'transparent');
    g1.addColorStop(0.3,'rgba('+C.a+',.015)');
    g1.addColorStop(0.5,'rgba('+C.a+',.035)');
    g1.addColorStop(0.7,'rgba('+C.a+',.015)');
    g1.addColorStop(1,'transparent');
    ctx.fillStyle=g1;ctx.fillRect(0,0,W,H);
    // Layer 2: Medium band
    const g2=ctx.createLinearGradient(0,beamCY-tubeH*1.2,0,beamCY+tubeH*1.2);
    g2.addColorStop(0,'transparent');
    g2.addColorStop(0.25,'rgba('+C.m+',.025)');
    g2.addColorStop(0.5,'rgba('+C.m+',.06)');
    g2.addColorStop(0.75,'rgba('+C.m+',.025)');
    g2.addColorStop(1,'transparent');
    ctx.fillStyle=g2;ctx.fillRect(0,0,W,H);
    // Layer 3: Narrow core
    const g3=ctx.createLinearGradient(0,beamCY-tubeH*0.35,0,beamCY+tubeH*0.35);
    g3.addColorStop(0,'transparent');
    g3.addColorStop(0.3,'rgba('+C.c+',.04)');
    g3.addColorStop(0.5,'rgba('+C.c+',.08)');
    g3.addColorStop(0.7,'rgba('+C.c+',.04)');
    g3.addColorStop(1,'transparent');
    ctx.fillStyle=g3;ctx.fillRect(0,0,W,H);
    // Layer 4: Hot wire
    const g4=ctx.createLinearGradient(0,beamCY-2,0,beamCY+2);
    g4.addColorStop(0,'transparent');
    g4.addColorStop(0.5,'rgba('+C.h+',.05)');
    g4.addColorStop(1,'transparent');
    ctx.fillStyle=g4;ctx.fillRect(0,0,W,H);
    // Flowing streaks left→right
    for(let i=0;i<5;i++){
      const sx=((t*60+i*W/5)%(W+160))-80;
      const sLen=80+Math.sin(t*0.8+i)*30;
      const sy=beamCY+Math.sin(t*1.2+i*1.3)*tubeH*0.3;
      const sg=ctx.createLinearGradient(sx,sy,sx-sLen,sy);
      sg.addColorStop(0,'rgba('+C.p+',.1)');
      sg.addColorStop(0.6,'rgba('+C.p+',.04)');
      sg.addColorStop(1,'transparent');
      ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx-sLen,sy+Math.sin(t+i)*2);
      ctx.strokeStyle=sg;ctx.lineWidth=1+Math.sin(t*2+i)*0.5;ctx.lineCap='round';ctx.stroke();
    }
    // Particles
    particles.forEach(p=>{
      p.x+=p.vx;
      if(p.x>W+10)p.x=-10;
      const py=beamCY+p.yOff*tubeH+Math.sin(t*0.6+p.phase)*tubeH*0.12;
      const fl=p.a+Math.sin(t*2.5+p.phase)*0.06;
      if(fl>0){
        ctx.beginPath();ctx.arc(p.x,py,p.r,0,Math.PI*2);
        ctx.fillStyle='rgba('+C.p+','+fl.toFixed(3)+')';ctx.fill();
      }
    });
    // Edge lines
    const ea=0.02+Math.sin(t*0.5)*0.008;
    ctx.beginPath();ctx.moveTo(0,beamCY-tubeH*0.5);ctx.lineTo(W,beamCY-tubeH*0.5);
    ctx.strokeStyle='rgba('+C.e+','+ea+')';ctx.lineWidth=0.5;ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,beamCY+tubeH*0.5);ctx.lineTo(W,beamCY+tubeH*0.5);
    ctx.strokeStyle='rgba('+C.e+','+ea+')';ctx.lineWidth=0.5;ctx.stroke();
    _rvLightAnim=requestAnimationFrame(animate);
  }
  _rvLightAnim=requestAnimationFrame(animate);
}

// ═══ BIRTH ORBS ANIMATION — star births two orbs that become avatars ═══
function animateBirthOrbs(){
  const star=$('rvBirthStar');
  const avatarsRow=document.querySelector('.rv-avatars');
  if(!star||!avatarsRow)return;
  // Reset star animation
  star.style.animation='none';star.offsetHeight;star.style.animation='';
  // Reset avatars — start hidden at top
  avatarsRow.classList.remove('birth-anim','birth-landed');
  avatarsRow.style.opacity='0';
  // After star flash (2.2s delay + ~0.4s to peak brightness)
  setTimeout(()=>{
    // Show avatars at top position (small, up high)
    avatarsRow.classList.add('birth-anim');
    avatarsRow.style.opacity='1';
    // Small delay then animate down to final position
    setTimeout(()=>{
      avatarsRow.classList.add('birth-landed');
    },80);
  },2600);
}

function doReveal(data){
  const a=data.userA,b=data.userB;
  const meIsA=a.id===state.userId;
  const me=meIsA?a:b,them=meIsA?b:a;
  const meColor=me.color||nickColor(me.name||'??'),themColor=them.color||nickColor(them.name||'??');
  const isDigital=data.type==='digital';

  // 0. Determine beam color based on relationship status
  // white=first encounter, gold=known but >24h since last, green=re-encounter <24h, red=<1h no bonus
  let beamColor='white';
  if(data.lastEncounter){
    const sinceMs=Date.now()-data.lastEncounter.timestamp;
    const hrs=sinceMs/3600000;
    if(hrs<1)beamColor='red';
    else if(hrs<24)beamColor='green';
    else beamColor='gold';
  }
  startRevealLight(beamColor);
  animateBirthOrbs();

  // 1. Avatars — only show real photo if already revealed
  // New connection = both anonymous. Only show photo if identity is known.
  const partnerId=them.id;
  const theyRevealedToMe=!!(state.revealedIds&&state.revealedIds[partnerId]);
  const iRevealedToThem=!!(data.renewed&&theyRevealedToMe); // if they can see me, I revealed earlier
  const myPhoto=iRevealedToThem?(me.profilePhoto||me.photoURL||state.userPhoto):null;
  const theirPhoto=theyRevealedToMe?(them.profilePhoto||them.photoURL):null;
  const myVerified=!!me.verified;
  const theirVerified=!!them.verified;
  // My avatar: anonymous with accessory if not revealed
  if(myPhoto){
    let myAv='<img class="rv-avatar-img" src="'+esc(myPhoto)+'" alt="" onerror="this.outerHTML=makeAvatar(\''+esc(me.name||'??').replace(/'/g,"\\'")+'\',\''+esc(meColor)+'\',56)">';
    $('rvAvatarMeInner').innerHTML=myVerified?'<div class="verified-wrap">'+myAv+verifiedBadge('verified-badge-lg')+'</div>':myAv;
  }else{
    // Anonymous silhouette with accessory based on nickname
    const myAccKey=me.accessory||null;
    $('rvAvatarMeInner').innerHTML=makeAvatar(me.name,meColor,56,null,myVerified,myAccKey);
  }
  // Their avatar: anonymous if not revealed to me
  if(theirPhoto){
    let thAv='<img class="rv-avatar-img" src="'+esc(theirPhoto)+'" alt="" onerror="this.outerHTML=makeAvatar(\''+esc(them.name||'??').replace(/'/g,"\\'")+'\',\''+esc(themColor)+'\',56)">';
    $('rvAvatarThemInner').innerHTML=theirVerified?'<div class="verified-wrap">'+thAv+verifiedBadge('verified-badge-lg')+'</div>':thAv;
  }else{
    const theirAccKey=them.accessory||null;
    $('rvAvatarThemInner').innerHTML=makeAvatar(them.name,themColor,56,null,theirVerified,theirAccKey);
  }
  // Names: show nickname always, realName only if revealed
  $('rvNameMe').textContent=iRevealedToThem?(me.realName||me.name||'?'):(me.name||'?');
  $('rvNameThem').textContent=theyRevealedToMe?(them.realName||them.name||'?'):(them.name||'?');
  // Stars orbiting around nodes + plus badge
  const myStars=me.stars||0;const theirStars=them.stars||0;
  const meInner=$('rvAvatarMeInner');const themInner=$('rvAvatarThemInner');
  // Remove old stars/badges if any
  meInner.querySelectorAll('.rv-avatar-stars,.rv-star-count,.rv-plus-badge').forEach(e=>e.remove());
  themInner.querySelectorAll('.rv-avatar-stars,.rv-star-count,.rv-plus-badge').forEach(e=>e.remove());
  function addOrbitStars(inner,count){
    if(count<=0)return;
    const cx=28,cy=28;// center of 56x56 avatar
    const orbitR=33;// orbit radius (28 + 5 gap)
    const maxDots=Math.min(count,14);
    const container=document.createElement('div');container.className='rv-avatar-stars';
    for(let i=0;i<maxDots;i++){
      const angle=(i/Math.max(maxDots,10))*Math.PI*2-Math.PI/2;
      const dx=cx+Math.cos(angle)*orbitR;
      const dy=cy+Math.sin(angle)*orbitR;
      const dot=document.createElement('div');dot.className='rv-star-dot';
      dot.style.left=dx+'px';dot.style.top=dy+'px';
      dot.style.transform='translate(-50%,-50%)';
      dot.style.animationDelay=(i*0.12)+'s';
      container.appendChild(dot);
    }
    inner.appendChild(container);
    if(count>3){
      const lbl=document.createElement('div');lbl.className='rv-star-count';
      lbl.textContent='★ '+count;inner.appendChild(lbl);
    }
  }
  addOrbitStars(meInner,myStars);
  addOrbitStars(themInner,theirStars);
  // Plus badge (verified)
  if(myVerified){const b=document.createElement('div');b.className='rv-plus-badge';b.textContent='+';meInner.appendChild(b)}
  if(theirVerified){const b=document.createElement('div');b.className='rv-plus-badge';b.textContent='+';themInner.appendChild(b)}

  // Detect special modes
  const isService=!!data.isServiceTouch;
  const isCheckin=!!data.isCheckin;
  const isSpecial=isService||isCheckin;

  // 2. Moment label + phrase + sub
  const moment=$('revealMoment');
  const phraseEl=$('revealPhrase');
  const subEl=document.querySelector('.rv-sub');
  const zodiacArea=$('zodiacArea');
  const lastEl=$('revealLast');

  // Remove previous service badge if any
  const oldBadge=document.querySelector('.rv-service-badge');
  if(oldBadge)oldBadge.remove();

  if(isService){
    // ── SERVICE REVEAL ──
    moment.textContent='Conexão de serviço';
    moment.style.color='#34d399';
    // Service badge with label
    const badge=document.createElement('div');
    badge.className='rv-service-badge';
    badge.textContent='💼 '+(them.serviceLabel||'Serviço');
    moment.after(badge);
    // Hide poetic elements
    phraseEl.innerHTML='';phraseEl.style.display='none';
    if(subEl)subEl.style.display='none';
    zodiacArea.classList.add('hidden');zodiacArea.innerHTML='';
    $('revealRenewed').classList.add('hidden');
    lastEl.classList.add('hidden');
    startRevealLight('#34d399');
  }else if(isCheckin){
    // ── CHECK-IN REVEAL — show EVENT, not operator ──
    const evName=data.eventName||data.operatorName||them.name||'Evento';
    // Override "them" avatar to show event icon
    $('rvAvatarThemInner').innerHTML='<div style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;box-shadow:0 0 20px rgba(96,165,250,.3)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></div>';
    $('rvNameThem').textContent=evName;
    moment.textContent='Check-in';
    moment.style.color='#60a5fa';
    const badge=document.createElement('div');
    badge.className='rv-service-badge';
    badge.style.borderColor='rgba(96,165,250,.3)';badge.style.background='rgba(96,165,250,.08)';badge.style.color='#60a5fa';
    badge.innerHTML='📍 Check-in em '+esc(evName);
    moment.after(badge);
    phraseEl.innerHTML='';phraseEl.style.display='none';
    if(subEl)subEl.style.display='none';
    zodiacArea.classList.add('hidden');zodiacArea.innerHTML='';
    $('revealRenewed').classList.add('hidden');
    lastEl.classList.add('hidden');
    startRevealLight('#60a5fa');
  }else{
    // ── NORMAL REVEAL ──
    const isEventMatch=!!data.isEventMatch;
    moment.textContent=isDigital?'uma conexão nasceu':'algo nasceu entre vocês';
    moment.style.color='';
    if(isEventMatch){
      // Small event badge under moment
      const emBadge=document.createElement('div');
      emBadge.className='rv-service-badge';
      emBadge.style.borderColor='rgba(96,165,250,.3)';emBadge.style.background='rgba(96,165,250,.08)';emBadge.style.color='#60a5fa';
      emBadge.innerHTML='⚡ '+(data.sharedEventName||'Evento');
      moment.after(emBadge);
    }
    phraseEl.style.display='';
    if(subEl)subEl.style.display='';
    // 3. Renewed
    data.renewed?$('revealRenewed').classList.remove('hidden'):$('revealRenewed').classList.add('hidden');
    // 4. Last encounter
    if(data.lastEncounter){
      const ago=Date.now()-data.lastEncounter.timestamp;
      const days=Math.floor(ago/86400000),hrs=Math.floor((ago%86400000)/3600000);
      let agoStr=days>0?days+'d '+hrs+'h atrás':hrs>0?hrs+'h atrás':'agora';
      lastEl.innerHTML='Último: <strong>'+agoStr+'</strong>';
      lastEl.classList.remove('hidden');
    }else lastEl.classList.add('hidden');
    // 5. Phrase — word by word
    phraseEl.innerHTML='';
    const baseDelay=0.8;
    data.phrase.split(' ').forEach((w,i)=>{
      const s=document.createElement('span');s.className='rv-word';
      s.textContent=w+'\u00A0';
      s.style.animationDelay=(baseDelay+i*0.22)+'s';
      phraseEl.appendChild(s);
    });
    // 6. Zodiac
    if(data.zodiacPhrase&&data.userA?.signInfo&&data.userB?.signInfo){
      zodiacArea.classList.remove('hidden');
      zodiacArea.innerHTML='<div class="zodiac-phrase">'+esc(data.zodiacPhrase)+'</div>';
    }else{zodiacArea.classList.add('hidden');zodiacArea.innerHTML=''}
    startRevealLight(beamColor);
  }

  // 7. Reset selfie
  releaseSelfieCamera();
  closeSelfieModal&&closeSelfieModal();
  $('revealActions').style.opacity='';

  // 8. Configure action buttons based on mode
  const tipBtn=$('revealTipBtn');
  const enterBtn=$('revealEnterBtn');
  const skipBtn=$('revealSkipBtn');
  const capBtn=$('selfieCapBtn');
  const iconRow=$('rvIconRow');
  const secRow=$('rvSecRow');

  // SVG icons for icon buttons
  const _rvIco={
    chat:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>',
    cam:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>',
    tip:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
    skip:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>',
    ticket:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 10h20"/></svg>',
    reveal:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
    share:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>'
  };
  function _rvBtn(icon,label,onclick,cls){
    return '<button type="button" class="rv-icon-btn'+(cls?' '+cls:'')+'" onclick="'+onclick+'"><span class="rv-ic">'+icon+'</span><span>'+label+'</span></button>';
  }

  // Reset
  if(secRow){secRow.style.display='';secRow.innerHTML=''}

  if(isService){
    // SERVICE: gorjeta principal, chat, pular
    let h='';
    h+=_rvBtn(_rvIco.tip,'Gorjeta',"openTipFromReveal()",'tip');
    h+=_rvBtn(_rvIco.chat,'Chat',"enterChat()",'primary');
    h+=_rvBtn(_rvIco.skip,'Pular',"goHome()",'skip');
    iconRow.innerHTML=h;
    if(tipBtn){tipBtn.dataset.receiverId=them.id}
  }else if(isCheckin){
    // CHECKIN: check entry price, reveal, go to event view
    const evId=data.eventId||null;
    const evName=data.eventName||data.operatorName||'Evento';
    const entryPrice=data.entryPrice||0;
    const opId=data.operatorId||them.id; // real operator ID for reveal

    if(entryPrice>0){
      const priceLabel='R$'+entryPrice.toFixed(2).replace('.',',');
      let h='';
      h+=_rvBtn(_rvIco.ticket,'Pagar '+priceLabel,"showEntryPayment('"+evId+"','"+esc(evName)+"',"+entryPrice+",'"+opId+"')",'primary');
      h+=_rvBtn(_rvIco.skip,'Cancelar',"goHome()",'skip');
      iconRow.innerHTML=h;
      if(secRow)secRow.innerHTML='<div style="font-size:.62rem;color:#fbbf24;text-align:center;padding:.3rem;line-height:1.5">Este evento cobra '+priceLabel+' de ingresso.</div>';
    }else if(data.requireReveal){
      let h='';
      h+=_rvBtn(_rvIco.reveal,'Revelar',"revealToOperator('"+opId+"','"+evId+"','"+esc(evName)+"')",'primary');
      h+=_rvBtn(_rvIco.skip,'Anônimo',"showEventView('"+evId+"','"+esc(evName)+"')",'skip');
      iconRow.innerHTML=h;
      if(secRow)secRow.innerHTML='<div style="font-size:.62rem;color:#60a5fa;text-align:center;padding:.3rem;line-height:1.5">Este estabelecimento solicita identificação.</div>';
    }else{
      let h='';
      h+=_rvBtn(_rvIco.reveal,'Revelar',"revealToOperator('"+opId+"','"+evId+"','"+esc(evName)+"')",'primary');
      h+=_rvBtn(_rvIco.skip,'Só check-in',evId?"showEventView('"+evId+"','"+esc(evName)+"')":"goHome()",'skip');
      iconRow.innerHTML=h;
      if(secRow)secRow.style.display='none';
    }
  }else{
    // NORMAL: chat + selfie + share + conexão + pular
    let h='';
    h+=_rvBtn(_rvIco.chat,'Chat 24h',"enterChat()",'primary');
    h+=_rvBtn('<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>','Conexão',"goToConnectionFromReveal()",'');
    h+=_rvBtn(_rvIco.cam,'Selfie',"revealCaptureSelfie()",'');
    h+=_rvBtn(_rvIco.share,'Compartilhar',"shareConnection()",'');
    h+=_rvBtn(_rvIco.skip,'Pular',"goHome()",'skip');
    iconRow.innerHTML=h;
  }

  // Reset service mode after touch
  if(serviceMode){
    serviceMode=false;
    const toggle=$('serviceToggle');if(toggle)toggle.classList.remove('active');
    const btn2=$('mainBtn');if(btn2)btn2.classList.remove('service-mode');
    $('mainBtnText').textContent='TOUCH';
    $('serviceToggleLabel').textContent='Modo Serviço';
  }
}

// Reveal data to operator (checkin mode)
function revealToOperator(operatorId,eventId,eventName){
  fetch('/api/identity/reveal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,targetUserId:operatorId})})
  .then(r=>r.json()).then(d=>{
    if(d.error)showToast(d.error);
    else{showToast('Dados revelados!');if(eventId)showEventView(eventId,eventName);else enterChat()}
  }).catch(()=>showToast('Erro ao revelar.'));
}

function openTipFromReveal(){
  const btn=$('revealTipBtn')||document.querySelector('#rvIconRow .rv-icon-btn.tip');
  if(btn&&btn.dataset.receiverId) showTipScreen(btn.dataset.receiverId);
  else if(state.currentRelation&&state.currentRelation.partnerId) showTipScreen(state.currentRelation.partnerId);
}

// ═══ ENTRY PAYMENT — pay to enter operator event ═══
async function showEntryPayment(eventId,eventName,price,operatorId){
  if(!state.userId){showToast('Faça login para continuar.');return}
  // Always show card form for entry payments (no auto one-tap — avoids confusing errors)
  showEntryCardForm(eventId,eventName,price,operatorId);
}

function showEntryCardForm(eventId,eventName,price,operatorId){
  const priceLabel='R$'+price.toFixed(2).replace('.',',');
  const secRow=$('rvSecRow');
  const iconRow=$('rvIconRow');

  if(iconRow)iconRow.style.display='none';

  if(secRow){
    secRow.style.display='';
    secRow.innerHTML='<div style="width:100%;padding:.6rem">'
      +'<div style="font-size:.7rem;font-weight:600;color:var(--t1);text-align:center;margin-bottom:.3rem">🎫 Ingresso '+priceLabel+' — '+esc(eventName)+'</div>'
      // Card brand logos
      +'<div style="display:flex;justify-content:center;gap:.3rem;margin-bottom:.5rem">'
      +'<div style="padding:2px 6px;border-radius:4px;background:#1a1f71;color:#fff;font-size:.45rem;font-weight:800;letter-spacing:.5px">VISA</div>'
      +'<div style="padding:2px 6px;border-radius:4px;background:#eb001b;color:#fff;font-size:.45rem;font-weight:800">MC</div>'
      +'<div style="padding:2px 6px;border-radius:4px;background:#006fcf;color:#fff;font-size:.45rem;font-weight:800">AMEX</div>'
      +'<div style="padding:2px 6px;border-radius:4px;background:#000;color:#fff;font-size:.45rem;font-weight:800">ELO</div>'
      +'<div style="padding:2px 6px;border-radius:4px;background:#8b2131;color:#fff;font-size:.45rem;font-weight:800">HIPER</div>'
      +'</div>'
      +'<div style="position:relative"><input type="text" id="entryCardNumber" class="tip-input" placeholder="Número do cartão" inputmode="numeric" maxlength="19" autocomplete="cc-number" oninput="formatCardNumber(this);updateEntryBrandIcon()" style="margin-bottom:.3rem;padding-right:2.5rem"><span id="entryBrandIcon" style="position:absolute;right:8px;top:50%;transform:translateY(-65%);font-size:.55rem;padding:2px 5px;border-radius:4px;background:linear-gradient(135deg,#1a1a2e,#2d2d44);color:rgba(255,255,255,.5)"></span></div>'
      +'<div style="display:flex;gap:.3rem;margin-bottom:.3rem"><input type="text" id="entryCardExpiry" class="tip-input" placeholder="MM/AA" inputmode="numeric" maxlength="5" oninput="formatExpiry(this)" style="flex:1"><input type="text" id="entryCardCVV" class="tip-input" placeholder="CVV" inputmode="numeric" maxlength="4" style="flex:1"></div>'
      +'<input type="text" id="entryCardHolder" class="tip-input" placeholder="Nome no cartão" style="margin-bottom:.3rem">'
      +'<input type="text" id="entryCardCPF" class="tip-input" placeholder="CPF" inputmode="numeric" maxlength="14" oninput="formatCPF(this)" style="margin-bottom:.3rem">'
      +'<div style="display:flex;align-items:center;gap:.3rem;margin-bottom:.5rem"><input type="checkbox" id="entrySaveCard" checked style="accent-color:#6366f1"><label for="entrySaveCard" style="font-size:.55rem;color:var(--t3)">Salvar cartão</label></div>'
      +'<button onclick="payEntry(\''+eventId+'\',\''+eventName.replace(/'/g,"\\'")+'\','+price+')" style="width:100%;padding:.65rem;border-radius:14px;border:none;background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;font-size:.82rem;font-weight:700;font-family:inherit;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.4rem" id="entryPayBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg> Pagar '+priceLabel+'</button>'
      // Security badges
      +'<div style="display:flex;align-items:center;justify-content:center;gap:.5rem;margin-top:.45rem;padding:.3rem;border-radius:8px;background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15)">'
      +'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>'
      +'<span style="font-size:.5rem;color:#22c55e;font-weight:600">Pagamento seguro</span>'
      +'<span style="font-size:.5rem;color:var(--t3)">•</span>'
      +'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>'
      +'<span style="font-size:.5rem;color:#22c55e;font-weight:600">Criptografia SSL</span>'
      +'</div>'
      +'<div style="text-align:center;margin-top:.25rem;font-size:.42rem;color:var(--t3)">Seus dados são criptografados e processados pelo Mercado Pago. Não armazenamos dados do cartão.</div>'
      +'<button onclick="showEventView(\''+eventId+'\',\''+eventName.replace(/'/g,"\\'")+'\');" style="width:100%;padding:.45rem;border:none;background:transparent;color:var(--ac);font-size:.6rem;font-family:inherit;cursor:pointer;margin-top:.3rem">Entrar sem pagar agora →</button>'
      +'</div>';
  }
}

async function payEntry(eventId,eventName,price){
  const cardNum=($('entryCardNumber')||{}).value?.replace(/\s/g,'')||'';
  const expiry=($('entryCardExpiry')||{}).value||'';
  const cvv=($('entryCardCVV')||{}).value||'';
  const holder=($('entryCardHolder')||{}).value?.trim()||'';
  const cpf=($('entryCardCPF')||{}).value?.replace(/\D/g,'')||'';
  if(!cardNum||cardNum.length<13)return showToast('Número do cartão inválido.');
  if(!expiry||expiry.length<5)return showToast('Data de validade inválida.');
  if(!cvv||cvv.length<3)return showToast('CVV inválido.');
  if(!holder)return showToast('Nome no cartão obrigatório.');
  if(!cpf||cpf.length<11)return showToast('CPF inválido.');

  const btn=$('entryPayBtn');
  if(btn){btn.disabled=true;btn.textContent='Processando...'}

  try{
    const mp=await getMpSdk();
    if(!mp)throw new Error('SDK não disponível.');
    const [expMonth,expYear]=expiry.split('/');
    // BIN detection
    const d1=cardNum[0],d2=cardNum.substring(0,2);
    let pmId='visa';
    if(d1==='5'||d2==='22'||d2==='23'||d2==='24'||d2==='25'||d2==='26'||d2==='27')pmId='master';
    else if(d1==='4')pmId='visa';
    else if(d2==='34'||d2==='37')pmId='amex';
    else if(d2==='60'||d2==='65'||d2==='63')pmId='elo';

    const tokenResult=await mp.createCardToken({
      cardNumber:cardNum,cardholderName:holder,
      cardExpirationMonth:expMonth,cardExpirationYear:'20'+expYear,
      securityCode:cvv,identificationType:'CPF',identificationNumber:cpf
    });
    if(!tokenResult||!tokenResult.id)throw new Error('Erro ao tokenizar.');

    const resp=await fetch('/api/operator/event/'+eventId+'/pay-entry',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userId:state.userId,token:tokenResult.id,paymentMethodId:pmId,payerEmail:state.email,payerCPF:cpf,deviceId:getMpDeviceId(),cardholderName:holder})
    });
    const result=await resp.json();
    if(result.error)throw new Error(result.error);

    // Save card if checked
    if($('entrySaveCard')&&$('entrySaveCard').checked){
      try{
        const saveToken=await mp.createCardToken({
          cardNumber:cardNum,cardholderName:holder,
          cardExpirationMonth:expMonth,cardExpirationYear:'20'+expYear,
          securityCode:cvv,identificationType:'CPF',identificationNumber:cpf
        });
        if(saveToken?.id){
          await fetch('/api/tip/save-card',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,token:saveToken.id,email:state.email||'',cpf})});
        }
      }catch(e){console.error('Save card err:',e)}
    }

    if(result.status==='approved'){
      showToast('Ingresso pago! ✅');
      haptic([50,30,50,30,50]);
      showEventView(eventId,eventName);
    }else{
      showToast('Pagamento pendente ⏳');
      showEventView(eventId,eventName);
    }
  }catch(e){
    console.error('Entry pay error:',e);
    showToast('Erro no pagamento: '+(e.message||'Tente novamente'));
    if(btn){btn.disabled=false;btn.textContent='🎫 Tentar novamente'}
  }
}

// ═══ SHARE CONNECTION — 9:16 story image ═══
async function shareConnection(){
  try{
  const d=state.currentRelation;if(!d)return showToast('Nada para compartilhar');
  showToast('Gerando imagem…');
  const meIsA=d.userA&&d.userA.id===state.userId;
  const me=meIsA?d.userA:d.userB,them=meIsA?d.userB:d.userA;
  if(!me||!them)return showToast('Dados incompletos');
  const W=1080,H=1920;
  const cv=document.createElement('canvas');cv.width=W;cv.height=H;
  const c=cv.getContext('2d');

  // Background — deep dark with gradient
  const bg=c.createRadialGradient(W/2,H*0.35,0,W/2,H*0.35,H*0.7);
  bg.addColorStop(0,'#0c0c1a');bg.addColorStop(0.5,'#060610');bg.addColorStop(1,'#020206');
  c.fillStyle=bg;c.fillRect(0,0,W,H);
  // Stars
  for(let i=0;i<100;i++){
    const sx=Math.random()*W,sy=Math.random()*H,sr=0.5+Math.random()*1.5;
    c.beginPath();c.arc(sx,sy,sr,0,Math.PI*2);
    c.fillStyle='rgba(255,255,255,'+(0.08+Math.random()*0.2)+')';c.fill();
  }
  // Warm glow behind avatars
  const glow=c.createRadialGradient(W/2,H*0.35,0,W/2,H*0.35,350);
  glow.addColorStop(0,'rgba(255,107,53,.1)');glow.addColorStop(0.5,'rgba(255,60,110,.05)');glow.addColorStop(1,'transparent');
  c.fillStyle=glow;c.fillRect(0,0,W,H);

  // Helper: draw avatar — anonymous silhouette if no photo, with accessory overlay
  function drawAvatar(img,cx,cy,r,name,color,isRevealed,accKey){
    if(img&&img.naturalWidth){
      const iw=img.naturalWidth,ih=img.naturalHeight;
      const side=Math.min(iw,ih);
      const sxx=(iw-side)/2,syy=(ih-side)/2;
      c.save();c.beginPath();c.arc(cx,cy,r,0,Math.PI*2);c.clip();
      c.drawImage(img,sxx,syy,side,side,cx-r,cy-r,r*2,r*2);c.restore();
    }else{
      // Anonymous silhouette (head + body shape)
      const g=c.createLinearGradient(cx,cy-r,cx,cy+r);
      g.addColorStop(0,'#2a2a3e');g.addColorStop(1,'#1a1a2e');
      c.beginPath();c.arc(cx,cy,r,0,Math.PI*2);c.fillStyle=g;c.fill();
      // Head circle
      const headR=r*0.32;const headY=cy-r*0.2;
      const bodyG=c.createLinearGradient(cx,headY-headR,cx,cy+r*0.65);
      bodyG.addColorStop(0,'#4a4a6a');bodyG.addColorStop(1,'#3a3a5a');
      c.beginPath();c.arc(cx,headY,headR,0,Math.PI*2);c.fillStyle=bodyG;c.fill();
      // Body ellipse
      c.beginPath();c.ellipse(cx,cy+r*0.45,r*0.52,r*0.36,0,0,Math.PI*2);c.fillStyle=bodyG;c.fill();
      // Accessory overlay on anonymous avatar
      if(accKey){
        const accData=getAccessoryImg(accKey);
        if(accData&&accData.ready&&accData.img){
          const accSize=r*2;
          c.drawImage(accData.img,cx-r,cy-r,accSize,accSize);
        }
      }
    }
    // Glow ring
    c.beginPath();c.arc(cx,cy,r+3,0,Math.PI*2);
    c.strokeStyle='rgba(255,107,53,.45)';c.lineWidth=2;c.stroke();
    c.beginPath();c.arc(cx,cy,r+8,0,Math.PI*2);
    c.strokeStyle='rgba(255,107,53,.08)';c.lineWidth=6;c.stroke();
  }
  // Helper: orbiting stars
  function drawStars(cx,cy,r,count){
    if(!count||count<=0)return;
    const orbitR=r+12;const maxDots=Math.min(count,14);
    for(let i=0;i<maxDots;i++){
      const a=(i/Math.max(maxDots,10))*Math.PI*2-Math.PI/2;
      const dx=cx+Math.cos(a)*orbitR,dy=cy+Math.sin(a)*orbitR;
      c.beginPath();c.arc(dx,dy,3.5,0,Math.PI*2);c.fillStyle='rgba(255,215,0,.75)';c.fill();
      c.beginPath();c.arc(dx,dy,6,0,Math.PI*2);c.fillStyle='rgba(255,215,0,.12)';c.fill();
    }
    if(count>3){
      c.font='bold 26px Inter,sans-serif';c.fillStyle='rgba(255,215,0,.8)';
      c.textAlign='center';c.textBaseline='middle';c.fillText('★ '+count,cx,cy-r-30);
    }
  }
  // Helper: plus badge
  function drawPlus(cx,cy,r){
    const bx=cx+r*0.62,by=cy+r*0.62,br=18;
    const pg=c.createLinearGradient(bx-br,by-br,bx+br,by+br);
    pg.addColorStop(0,'#06b6d4');pg.addColorStop(0.5,'#3b82f6');pg.addColorStop(1,'#8b5cf6');
    c.beginPath();c.arc(bx,by,br,0,Math.PI*2);c.fillStyle=pg;c.fill();
    c.font='bold 20px Inter,sans-serif';c.fillStyle='#fff';
    c.textAlign='center';c.textBaseline='middle';c.fillText('+',bx,by);
  }

  // Load images — try DOM first (already loaded), then fetch
  function grabDomImg(sel){
    const el=document.querySelector(sel+' img.rv-avatar-img');
    if(el&&el.naturalWidth&&el.complete)return el;
    return null;
  }
  function loadImg(src){
    return new Promise(ok=>{
      if(!src){ok(null);return}
      const im=new Image();im.crossOrigin='anonymous';
      im.onload=()=>ok(im);
      im.onerror=()=>{
        // Retry without crossOrigin (won't taint canvas but at least renders)
        const im2=new Image();im2.onload=()=>ok(im2);im2.onerror=()=>ok(null);im2.src=src;
      };
      im.src=src;
    });
  }
  // Same anonymous/revealed logic as doReveal()
  const partnerId=them.id;
  const theyRevealedToMe=!!(state.revealedIds&&state.revealedIds[partnerId]);
  const iRevealedToThem=!!(d.renewed&&theyRevealedToMe);
  const myPhoto=iRevealedToThem?(me.profilePhoto||me.photoURL||state.userPhoto):null;
  const theirPhoto=theyRevealedToMe?(them.profilePhoto||them.photoURL):null;
  // Try DOM images first (these are already loaded and rendered)
  let myImg=myPhoto?grabDomImg('#rvAvatarMeInner'):null;
  let theirImg=theirPhoto?grabDomImg('#rvAvatarThemInner'):null;
  // If not in DOM, load fresh
  if(myPhoto&&!myImg)myImg=await loadImg(myPhoto);
  if(theirPhoto&&!theirImg)theirImg=await loadImg(theirPhoto);

  // Layout
  const avR=90;
  const avY=H*0.33;
  const avSpacing=155;

  // Moment text (above avatars)
  const momentText=$('revealMoment')?.textContent||'algo nasceu entre vocês';
  c.font='500 28px Inter,sans-serif';c.fillStyle='rgba(255,255,255,.35)';
  c.textAlign='center';c.textBaseline='middle';c.letterSpacing='0.2em';
  c.fillText(momentText.toUpperCase(),W/2,avY-avR-70);

  // Draw avatars (pass accessory key for anonymous silhouette overlay)
  const myAccKey=iRevealedToThem?null:(me.accessory||null);
  const theirAccKey=theyRevealedToMe?null:(them.accessory||null);
  drawAvatar(myImg,W/2-avSpacing,avY,avR,me.name||'?',me.color,iRevealedToThem,myAccKey);
  drawAvatar(theirImg,W/2+avSpacing,avY,avR,them.name||'?',them.color,theyRevealedToMe,theirAccKey);
  // Stars
  drawStars(W/2-avSpacing,avY,avR,me.stars||0);
  drawStars(W/2+avSpacing,avY,avR,them.stars||0);
  // Verified (subscriber) badges
  if(me.verified)drawPlus(W/2-avSpacing,avY,avR);
  if(them.verified)drawPlus(W/2+avSpacing,avY,avR);

  // Connection line — glowing electric
  const x1=W/2-avSpacing+avR+14,x2=W/2+avSpacing-avR-14;
  // Outer glow
  c.beginPath();c.moveTo(x1,avY);c.lineTo(x2,avY);
  c.strokeStyle='rgba(255,107,53,.12)';c.lineWidth=12;c.lineCap='round';c.stroke();
  // Inner glow
  c.beginPath();c.moveTo(x1,avY);c.lineTo(x2,avY);
  c.strokeStyle='rgba(255,107,53,.35)';c.lineWidth=4;c.stroke();
  // Core
  c.beginPath();c.moveTo(x1,avY);c.lineTo(x2,avY);
  c.strokeStyle='rgba(255,180,120,.7)';c.lineWidth=1.5;c.stroke();
  // Center spark
  c.beginPath();c.arc(W/2,avY,8,0,Math.PI*2);
  const sparkG=c.createRadialGradient(W/2,avY,0,W/2,avY,8);
  sparkG.addColorStop(0,'rgba(255,200,150,.9)');sparkG.addColorStop(1,'rgba(255,107,53,.3)');
  c.fillStyle=sparkG;c.fill();

  // Names — discrete, smaller, slightly transparent
  const myName=iRevealedToThem?(me.realName||me.name||'?'):(me.name||'?');
  const theirName=theyRevealedToMe?(them.realName||them.name||'?'):(them.name||'?');
  c.font='600 26px Inter,sans-serif';c.textAlign='center';c.textBaseline='top';
  c.fillStyle='rgba(255,255,255,.4)';
  c.fillText(myName,W/2-avSpacing,avY+avR+20);
  c.fillText(theirName,W/2+avSpacing,avY+avR+20);
  // Verified label under name
  if(me.verified){c.font='600 18px Inter,sans-serif';c.fillStyle='rgba(6,182,212,.6)';c.fillText('✓ assinante',W/2-avSpacing,avY+avR+52)}
  if(them.verified){c.font='600 18px Inter,sans-serif';c.fillStyle='rgba(6,182,212,.6)';c.fillText('✓ assinante',W/2+avSpacing,avY+avR+52)}

  // Phrase (center of card) — larger, more elegant
  const phrase=d.phrase||'';
  if(phrase){
    c.font='italic 300 50px Georgia,Inter,serif';c.fillStyle='rgba(255,255,255,.85)';
    c.textAlign='center';c.textBaseline='top';
    const words=phrase.split(' ');let lines=[];let line='';
    for(const w of words){
      const test=line?line+' '+w:w;
      if(c.measureText(test).width>W-160){lines.push(line);line=w}
      else line=test;
    }
    if(line)lines.push(line);
    const lineH=66;const startY=avY+avR+100;
    lines.forEach((l,i)=>{c.fillText(l,W/2,startY+i*lineH)});
  }

  // Zodiac — subtle
  const zPhrase=d.zodiacPhrase||'';
  if(zPhrase){
    c.font='italic 300 26px Inter,sans-serif';c.fillStyle='rgba(255,255,255,.22)';
    c.textAlign='center';c.fillText(zPhrase,W/2,H*0.62);
  }

  // ── Decorative sparkles across card (Instagram-attractive) ──
  for(let i=0;i<8;i++){
    const sx=120+Math.random()*(W-240),sy=H*0.5+Math.random()*(H*0.3);
    const sz=1+Math.random()*2;
    c.beginPath();c.arc(sx,sy,sz,0,Math.PI*2);
    c.fillStyle='rgba(255,107,53,'+(0.06+Math.random()*0.12)+')';c.fill();
  }

  // ── Bottom brand area — modern and clean ──
  // Subtle horizontal line
  const lineY=H-240;
  const lineG=c.createLinearGradient(W*0.2,lineY,W*0.8,lineY);
  lineG.addColorStop(0,'transparent');lineG.addColorStop(0.5,'rgba(255,107,53,.15)');lineG.addColorStop(1,'transparent');
  c.beginPath();c.moveTo(W*0.2,lineY);c.lineTo(W*0.8,lineY);c.strokeStyle=lineG;c.lineWidth=1;c.stroke();
  // Brand name — gradient-style
  c.font='800 48px Inter,sans-serif';
  c.fillStyle='rgba(255,107,53,.5)';
  c.textAlign='center';c.textBaseline='middle';c.fillText('Touch?',W/2,H-175);
  // Tagline
  c.font='300 22px Inter,sans-serif';c.fillStyle='rgba(255,255,255,.25)';
  c.fillText('tudo nasce no gesto',W/2,H-128);
  // QR-like invite text
  c.font='500 18px Inter,sans-serif';c.fillStyle='rgba(255,255,255,.15)';
  c.fillText('encosta.app',W/2,H-90);

  // Convert to blob and share
  const blob=await new Promise(ok=>cv.toBlob(ok,'image/png',1.0));
  if(!blob)return showToast('Erro ao gerar imagem');
  const file=new File([blob],'touch-conexao.png',{type:'image/png'});
  if(navigator.canShare&&navigator.canShare({files:[file]})){
    await navigator.share({files:[file],title:'Touch? — conexão',text:phrase||'Uma conexão nasceu'});
  }else{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download='touch-conexao.png';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(url),5000);
    showToast('Imagem salva!');
  }
  }catch(e){
    if(e.name!=='AbortError')showToast('Erro: '+(e.message||'falha ao compartilhar'));
    console.error('shareConnection error:',e);
  }
}

// ═══ CHAT ═══
function enterChat(){if(state.currentRelation)openChat(state.currentRelation)}
function goToConnectionFromReveal(){
  // Navigate to constellation/network screen and highlight this connection
  if(!state.currentRelation)return goHome();
  const partnerId=state.currentRelation.partnerId||state.currentRelation.with;
  showHistory().then(()=>{
    // Try to find and open the partner's node detail after constellation loads
    if(partnerId){
      setTimeout(()=>{
        const node=constState.nodes.find(n=>n.id===partnerId);
        if(node)showConstDetail(node);
      },1200);
    }
  }).catch(()=>{});
}
async function openChat(rel){
  state.currentRelation=rel;pulseSent=false;
  const pb=$('pulseBtn');if(pb)pb.style.opacity='1';
  const partner=(rel.userA?.id===state.userId)?rel.userB:rel.userA;
  const isEventRel=!!(rel.isEvent||rel.eventId);
  const pNick=isEventRel?(rel.eventName||rel.partnerName||'Evento'):(partner?.nickname||rel.partnerName||'Pessoa');
  const pRealName=isEventRel?null:(partner?.realName||null);
  const pName=pRealName||pNick;
  state.currentPartnerId=partner?.id||rel.partnerId||null;
  // Event-type chat: show event info
  if(isEventRel){
    $('chatPartner').textContent=pNick;
    $('chatSub').innerHTML='<span style="color:#60a5fa">📍 Chat da organização</span> · '+esc(pNick);
  }else if(pRealName&&pRealName!==pNick){
    $('chatPartner').textContent=pRealName;
    $('chatSub').innerHTML='<span style="color:var(--ok)">✓ ID revelado</span> · @'+esc(pNick);
  }else{
    $('chatPartner').textContent=pNick;
    $('chatSub').textContent='nickname';
  }
  // Load pending reveals for this partner and update chat ID bar
  updateChatIdBar();
  $('chatPhrase').textContent=rel.phrase;
  closePlusMenu();hideTyping();
  const mc=$('chatMessages'),ti=$('typingIndicator');mc.innerHTML='';mc.appendChild(ti);
  loadQuickPhrases();
  try{(await(await fetch('/api/messages/'+rel.relationId)).json()).forEach(m=>{
    if(m.type==='ephemeral')appendEphemeral(m,true);
    else if(m.type==='photo')appendPhoto(m);
    else if(m.type==='reveal-request'||m.type==='reveal-accepted'||m.type==='reveal-declined')appendRevealChatCard(m);
    else appendMessage(m);
  })}catch(e){}
  // Load partner score + stars into subtitle
  try{
    const ps=await fetch('/api/partner-score/'+rel.relationId+'/'+state.userId).then(r=>r.json());
    if(ps.score!=null){
      $('partnerPtsNum').textContent=ps.score;
      const sub=$('chatSub');
      const extra=(ps.stars>0?' · ⭐'+ps.stars:'')+(ps.score>0?' · '+ps.score+'pts':'');
      if(pRealName&&pRealName!==pNick){
        sub.innerHTML='<span style="color:var(--ok)">✓ ID</span> · @'+esc(pNick)+extra;
      }else{
        sub.innerHTML='nickname'+extra;
      }
    }
  }catch(e){}
  // Load streak
  loadStreak();
  startChatTimer(rel.expiresAt);showScreen('chat');
  // Mark as read and refresh badge count
  localStorage.setItem('lastRead_'+rel.relationId,Date.now().toString());
  refreshRelations();
  requestAnimationFrame(()=>{mc.scrollTop=mc.scrollHeight;$('chatInput').focus()});
}
async function loadStreak(){
  if(!state.currentPartnerId)return;
  try{
    const s=await fetch('/api/streak/'+state.userId+'/'+state.currentPartnerId).then(r=>r.json());
    const el=$('chatStreak');
    if(s.currentStreak>0){
      el.classList.remove('hidden');
      // Show stars earned and progress to next
      let starsHtml='';
      for(let i=0;i<s.starsEarned;i++)starsHtml+='⭐';
      const daysInCycle=s.currentStreak%5;
      $('chatStreakText').innerHTML=starsHtml+(starsHtml?' · ':'')+'🔥 '+s.currentStreak+' dia'+(s.currentStreak>1?'s':'');
      $('chatStreakBar').style.width=(s.progress||0)+'%';
      if(s.daysToNextStar>0){
        $('chatStreakNext').textContent='Próxima ⭐ em '+s.daysToNextStar+' dia'+(s.daysToNextStar>1?'s':'');
      }else{
        $('chatStreakNext').textContent='⭐ Nova estrela!';
      }
    }else el.classList.add('hidden');
  }catch(e){}
}
function appendMessage(msg){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');div.className='msg '+(msg.userId===state.userId?'mine':'theirs');
  const t=new Date(msg.timestamp);div.innerHTML=esc(msg.text)+'<div class="mt">'+pad(t.getHours())+':'+pad(t.getMinutes())+'</div>';
  mc.insertBefore(div,ti);if(near||msg.userId===state.userId)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
}
function sendMessage(){
  const input=$('chatInput'),text=input.value.trim();if(!text||!state.currentRelation)return;
  appendMessage({userId:state.userId,text,timestamp:Date.now()});playSound('send');haptic([30]);
  socket.emit('send-message',{relationId:state.currentRelation.relationId,userId:state.userId,text});
  input.value='';updateSendBtn();
}
function nearBot(){const el=$('chatMessages');return el.scrollHeight-el.scrollTop-el.clientHeight<80}
function startChatTimer(expiresAt){
  if(state.timerInterval)clearInterval(state.timerInterval);const el=$('chatTimer');
  let lastSec=-1;
  function tick(){
    const d=expiresAt-Date.now();
    if(d<=0){el.textContent='Expirado';el.classList.add('urg');clearInterval(state.timerInterval);showExpireCard();return}
    const sec=Math.floor(d/1000);
    el.textContent=pad(Math.floor(d/3600000))+':'+pad(Math.floor((d%3600000)/60000))+':'+pad(Math.floor((d%60000)/1000));
    el.classList.toggle('urg',d<3600000);
    // Pulse animation on second change
    if(sec!==lastSec){lastSec=sec;el.style.transform='scale(1.08)';setTimeout(()=>{el.style.transform='scale(1)'},150)}
  }
  tick();state.timerInterval=setInterval(tick,1000);
}

// ═══ HOROSCOPE ═══
async function getHoroscope(){
  if(!state.currentRelation)return;
  try{
    const r=await fetch('/api/horoscope/'+state.currentRelation.relationId+'/'+state.userId);
    const d=await r.json();
    if(d.error)return showToast(d.error);
    // Show as system message in chat
    const text='✨ '+d.phrase;
    appendMessage({userId:'system',text,timestamp:Date.now()});
    // Also emit so partner sees it
    socket.emit('send-message',{relationId:state.currentRelation.relationId,userId:'system',text});
    haptic([30,20,30]);
  }catch(e){showToast('Erro ao consultar astros.')}
}

// ═══ PULSE ═══
function sendPulse(){
  if(!state.currentRelation||pulseSent)return;
  socket.emit('pulse',{relationId:state.currentRelation.relationId,userId:state.userId});
  pulseSent=true;const pb=$('pulseBtn');if(pb)pb.style.opacity='.35';
  // Heartbeat vibration: lub-dub, lub-dub, lub-dub
  haptic([120,60,80,300,120,60,80,300,120,60,80]);
  showToast('Pulso enviado');
}

// ═══ SELFIE ═══
function requestSelfie(){
  if(!state.currentRelation)return;
  const input=document.createElement('input');input.type='file';input.accept='image/*';input.capture='user';
  input.onchange=async()=>{
    const file=input.files[0];if(!file)return;
    const c=document.createElement('canvas'),ctx=c.getContext('2d'),img=new Image();
    img.onload=async()=>{
      c.width=400;c.height=400;const sc=Math.max(400/img.width,400/img.height);
      ctx.drawImage(img,(400-img.width*sc)/2,(400-img.height*sc)/2,img.width*sc,img.height*sc);
      const data=c.toDataURL('image/jpeg',.6);
      await fetch('/api/selfie/'+state.currentRelation.relationId,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,selfieData:data})});
      showToast('Selfie enviada!');
    };img.src=URL.createObjectURL(file);
  };input.click();
}

// ═══ TYPING ═══
function handleTyping(){if(!state.currentRelation||!socket)return;const now=Date.now();if(now-lastTypingEmit>2000){socket.emit('typing',{relationId:state.currentRelation.relationId,userId:state.userId});lastTypingEmit=now}}
function showTyping(){$('typingIndicator').classList.add('vis');if(nearBot())$('chatMessages').scrollTo({top:99999,behavior:'smooth'});clearTimeout(typingTimeout);typingTimeout=setTimeout(hideTyping,3000)}
function hideTyping(){$('typingIndicator').classList.remove('vis')}

// ═══ QUICK PHRASES (EPHEMERAL) ═══
const QUICK_PHRASES=['Observei','Gostei','Algo ficou','Curioso','Queria te ver','Sem pressa','Sorrindo aqui','Pensando em ti'];
function loadQuickPhrases(){
  const bar=$('quickPhrases');if(!bar)return;bar.innerHTML='';
  QUICK_PHRASES.forEach(p=>{
    const chip=document.createElement('button');chip.className='qp-chip';chip.type='button';chip.textContent=p;
    chip.onclick=()=>{sendEphemeral(p);chip.classList.add('sent')};
    bar.appendChild(chip);
  });
}
function sendEphemeral(text){
  if(!state.currentRelation)return;
  const msg={userId:state.userId,text,type:'ephemeral',timestamp:Date.now()};
  appendEphemeral(msg);haptic([40,20,40]);
  socket.emit('send-ephemeral',{relationId:state.currentRelation.relationId,userId:state.userId,text});
}
function appendEphemeral(msg,fromHistory){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');
  div.className='msg ephemeral'+(msg.userId===state.userId?' mine':'');
  div.innerHTML=esc(msg.text)+'<span class="eph-badge">efêmera</span>';
  mc.insertBefore(div,ti);
  if(near||msg.userId===state.userId)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
  // Only auto-fade on real-time receive, not from history
  if(!fromHistory){
    setTimeout(()=>{div.style.transition='opacity .6s,transform .6s';div.style.opacity='0';div.style.transform='scale(.95)';setTimeout(()=>div.remove(),700)},8000);
  }
}

// ═══ PHOTO / FILE IN CHAT ═══
function pickPhoto(){
  closePlusMenu();if(!state.currentRelation)return;
  const input=document.createElement('input');input.type='file';input.accept='image/*';
  input.onchange=()=>{const file=input.files[0];if(file)processAndSendPhoto(file)};
  input.click();
}
function pickFile(){
  closePlusMenu();if(!state.currentRelation)return;
  const input=document.createElement('input');input.type='file';input.accept='image/*,.pdf,.doc,.docx,.txt';
  input.onchange=()=>{
    const file=input.files[0];if(!file)return;
    if(file.type.startsWith('image/'))processAndSendPhoto(file);
    else{showToast('Enviado: '+file.name);haptic([30])}
  };input.click();
}
function processAndSendPhoto(file){
  const reader=new FileReader();
  reader.onload=()=>{
    const img=new Image();img.onload=()=>{
      const c=document.createElement('canvas'),ctx=c.getContext('2d');
      const maxW=600,sc=Math.min(maxW/img.width,maxW/img.height,1);
      c.width=img.width*sc;c.height=img.height*sc;
      ctx.drawImage(img,0,0,c.width,c.height);
      const dataUrl=c.toDataURL('image/jpeg',.7);
      const msg={userId:state.userId,type:'photo',photoData:dataUrl,timestamp:Date.now()};
      appendPhoto(msg);haptic([30]);
      socket.emit('send-photo',{relationId:state.currentRelation.relationId,userId:state.userId,photoData:dataUrl});
    };img.src=reader.result;
  };reader.readAsDataURL(file);
}
function appendPhoto(msg){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');div.className='msg photo '+(msg.userId===state.userId?'mine':'theirs');
  const imgEl=document.createElement('img');imgEl.src=msg.photoData;imgEl.loading='lazy';
  imgEl.onclick=()=>{window.open(msg.photoData,'_blank')};
  div.appendChild(imgEl);
  const t=new Date(msg.timestamp);const tm=document.createElement('div');tm.className='mt';
  tm.textContent=pad(t.getHours())+':'+pad(t.getMinutes());div.appendChild(tm);
  mc.insertBefore(div,ti);
  if(near||msg.userId===state.userId)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
}

// ═══ PLUS MENU ═══
function togglePlusMenu(){const m=$('plusMenu');m.classList.toggle('open')}
function closePlusMenu(){const m=$('plusMenu');if(m)m.classList.remove('open')}

// ═══ STREAK UNLOCK ═══
function showStreakUnlock(data){
  const overlay=document.createElement('div');overlay.className='streak-unlock-overlay';
  const starsTotal=data.starsTotal||1;
  let starsHtml='';for(let i=0;i<starsTotal;i++)starsHtml+='⭐';
  overlay.innerHTML='<div class="streak-unlock-card"><div class="su-emoji">'+starsHtml+'</div><div class="su-title">'+data.streakDays+' dias juntos!</div><div class="su-desc">'+esc(data.unlock.description)+'</div><button class="bp" style="max-width:200px;margin:0 auto" onclick="this.closest(\'.streak-unlock-overlay\').remove()">Incrível!</button></div>';
  document.body.appendChild(overlay);
  haptic([100,50,100,50,100]);playSound('connect');
}

// ═══ TOUCH LINK ═══
let touchLinkData=null;
async function loadTouchLink(){
  try{
    const r=await fetch('/api/touch-link/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
    const d=await r.json();if(d.url){touchLinkData=d;$('touchLinkUrl').textContent=d.url}
  }catch(e){$('touchLinkUrl').textContent='Erro ao gerar link'}
}
function copyTouchLink(){
  if(!touchLinkData)return;
  navigator.clipboard.writeText(touchLinkData.url).then(()=>showToast('Link copiado!')).catch(()=>{
    const ta=document.createElement('textarea');ta.value=touchLinkData.url;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();showToast('Link copiado!');
  });
}
function showTouchQR(){
  const area=$('touchQRArea');
  area.innerHTML='';
  if(touchLinkData&&typeof QRCode!=='undefined'){new QRCode(area,{text:touchLinkData.url,width:180,height:180,colorDark:'#0a0a0a',colorLight:'#ffffff',correctLevel:QRCode.CorrectLevel.M})}
}

// ═══ RELATIONS ═══
async function refreshRelations(){
  if(!state.userId)return;
  try{
    const rels=await(await fetch('/api/relations/'+state.userId)).json();
    state._cachedRels=rels; // cache for showRelations
    const badge=$('relBadge'),count=$('relCount');
    if(rels.length>0){
      badge.classList.remove('hidden');
      // Count unread conversations only
      let unread=0;
      for(const r of rels){
        if(r.lastMessageUserId&&r.lastMessageUserId!==state.userId){
          const lastRead=parseInt(localStorage.getItem('lastRead_'+r.id)||'0');
          if(r.lastMessageTime>lastRead)unread++;
        }
      }
      // Badge shows ONLY unread count — hide count bubble if 0 unread
      if(unread>0){
        count.textContent=unread;
        count.style.display='flex';
        badge.style.background='rgba(255,107,53,.15)';badge.style.borderColor='var(--ac)';
      }else{
        count.style.display='none';
        badge.style.background='rgba(255,255,255,.04)';badge.style.borderColor='rgba(255,255,255,.06)';
      }
    }else badge.classList.add('hidden');
  }catch(e){}
}
async function showRelations(){
  haptic([30]);
  try{
    const rels=await(await fetch('/api/relations/'+state.userId)).json();const list=$('relationsList');
    if(!rels.length){list.innerHTML='<div class="nr"><div class="nr-icon">✦</div>Nenhuma conexão ativa.<div class="nr-text">Encoste em alguém para criar algo que só existe aqui.</div></div>'}
    else{
      const sub=$('relSubtitle');if(sub)sub.textContent=rels.length+' conversa'+(rels.length===1?'':'s');
      list.innerHTML='';rels.forEach((r,idx)=>{
      const h=Math.floor(r.timeLeft/3600000),m=Math.floor((r.timeLeft%3600000)/60000);
      let tc='ok';if(r.timeLeft<3600000)tc='low';else if(r.timeLeft<43200000)tc='med';
      const card=document.createElement('div');card.className='rc';card.style.animationDelay=(idx*0.06)+'s';card.style.animation='mi .35s ease '+(idx*0.06)+'s both';
      const isEventRel=!!(r.isEvent||r.eventId);
      const pColor=isEventRel?'#60a5fa':(r.partnerColor||nickColor(r.partnerName||'??'));
      const timeLabel=tc==='low'?'expirando':'restante';
      let displayName,nameHtml,photoHtml;
      if(isEventRel){
        // Event relation: show event icon and name
        displayName=r.eventName||r.partnerName||'Evento';
        photoHtml='<div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;box-shadow:0 0 12px rgba(96,165,250,.2)">📍</div>';
        nameHtml='<div class="rn" style="color:#60a5fa">'+esc(displayName)+'</div><div style="font-size:.6rem;color:var(--t3);margin-top:.1rem">evento</div>';
      }else{
        displayName=r.partnerRealName||r.partnerName;
        const isRevealed=r.partnerRealName&&r.partnerRealName!==r.partnerName;
        const pVerified=!!r.partnerVerified;
        let pAvInner=r.partnerPhoto?'<div style="width:48px;height:48px;border-radius:50%;overflow:hidden;flex-shrink:0;border:1.5px solid rgba(255,255,255,.12)"><img src="'+r.partnerPhoto+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>':makeAvatar(r.partnerName,pColor,48);
        photoHtml=pVerified?'<div class="verified-wrap">'+pAvInner+verifiedBadge()+'</div>':pAvInner;
        nameHtml='<div class="rn">'+esc(displayName)+(pVerified?' <span style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:.6rem;font-weight:800">✓</span>':'')+(isRevealed?' <span style="font-size:.55rem;color:var(--ok)">✓ ID</span>':'')+'</div>'+(isRevealed?'<div style="font-size:.6rem;color:var(--t3);margin-top:.1rem">@'+esc(r.partnerName)+'</div>':'');
      }
      // Unread count for this relation
      const lastRead=parseInt(localStorage.getItem('lastRead_'+r.id)||'0');
      const unreadCount=(r.lastMessageTime&&r.lastMessageUserId&&r.lastMessageUserId!==state.userId&&r.lastMessageTime>lastRead)?1:0;
      // Preview text
      const previewHtml=r.lastMessagePreview?'<div class="rp-preview">'+esc(r.lastMessagePreview)+'</div>':'<div class="rp">"'+esc(r.phrase)+'"</div>';
      const unreadBadge=unreadCount>0?'<div class="rc-unread"></div>':'';
      card.innerHTML=photoHtml+'<div class="ri">'+nameHtml+previewHtml+'</div><div class="rtm-wrap">'+unreadBadge+'<div class="rtm '+tc+'">'+h+'h '+m+'m</div><div class="rtm-label">'+timeLabel+'</div></div>';
      if(isEventRel){card.style.borderColor='rgba(96,165,250,.15)'}
      const rpid=r.userA===state.userId?r.userB:r.userA;
      card.addEventListener('click',()=>openChat({relationId:r.id,phrase:r.phrase,expiresAt:r.expiresAt,partnerName:isEventRel?(r.eventName||r.partnerName):r.partnerName,partnerId:rpid,isEvent:isEventRel,eventId:r.eventId,eventName:r.eventName,iRevealedToPartner:r.iRevealedToPartner,partnerRevealedToMe:r.partnerRevealedToMe,userA:{id:r.userA,nickname:r.userA===state.userId?state.userName:r.partnerName,realName:r.userA===state.userId?null:r.partnerRealName},userB:{id:r.userB,nickname:r.userB===state.userId?state.userName:r.partnerName,realName:r.userB===state.userId?null:r.partnerRealName}}));
      list.appendChild(card);
    })}
    showScreen('relations');
  }catch(e){showToast('Erro ao carregar.')}
}

// ═══ CONSTELLATION ═══
let constFilter='all'; // 'all','people','anon','events'
function setConstFilter(f){
  constFilter=f;
  // Pill in canvas redraws automatically each frame — no DOM buttons needed
}
// ── Constellation search ──
function toggleConstSearch(){
  const overlay=$('constSearchOverlay');
  const btn=$('constSearchToggle');
  if(!overlay)return;
  if(overlay.classList.contains('hidden')){
    overlay.classList.remove('hidden');
    if(btn){btn.style.background='rgba(99,102,241,.2)';btn.style.borderColor='rgba(99,102,241,.4)'}
    setTimeout(()=>{const inp=$('constSearchInput');if(inp)inp.focus()},50);
  }else{
    clearConstSearch();
    overlay.classList.add('hidden');
    if(btn){btn.style.background='none';btn.style.borderColor='rgba(255,255,255,.1)'}
  }
}
function onConstSearch(val){
  const q=val.toLowerCase().trim();
  constState._searchQuery=q||'';
  const countEl=$('constSearchCount');
  if(!q){
    constState.nodes.forEach(n=>{n._searchMatch=false});
    if(countEl)countEl.textContent='';
    return;
  }
  let matches=0;
  constState.nodes.forEach(n=>{
    const nick=(n.nickname||'').toLowerCase();
    const real=(n.realName||'').toLowerCase();
    n._searchMatch=nick.includes(q)||real.includes(q);
    if(n._searchMatch)matches++;
  });
  if(countEl)countEl.textContent=matches>0?matches+' encontrado'+(matches>1?'s':''):'Nenhum resultado';
}
function clearConstSearch(){
  const inp=$('constSearchInput');
  if(inp)inp.value='';
  constState._searchQuery='';
  constState.nodes.forEach(n=>{n._searchMatch=false});
  const countEl=$('constSearchCount');
  if(countEl)countEl.textContent='';
}

let constState={nodes:[],cam:{x:0,y:0,zoom:1},dragging:false,lastTouch:null,animFrame:null,selectedNode:null,
  fpMode:false,fpTransition:0,fpYaw:0,fpPitch:0,_searchQuery:''};
const CONST_FEEDBACK=['Um novo ponto surgiu.','Sua rede cresceu hoje.','Um encontro deixou rastro.','Um elo foi reforçado.','Algo ficou marcado.','Sua rede se expandiu.'];

async function showHistory(){
  haptic([30]);
  updateNotifBadge();
  // Mark network as seen and clear badge
  const nbadge=$('networkBadge');
  if(nbadge){nbadge.textContent='0';nbadge.classList.add('hidden')}
  fetch('/api/network/seen',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})}).catch(()=>{});
  // Show screen immediately with loading indicator
  clearConstSearch();
  const loader=$('constLoader');
  if(loader){loader.classList.remove('hidden','fade-out')}
  showScreen('history');
  try{
    const data=await(await fetch('/api/constellation/'+state.userId)).json();
    const empty=$('constEmpty');
    if(!data.nodes||!data.nodes.length){empty.classList.remove('hidden');constState.nodes=[];if(loader){loader.classList.add('fade-out');setTimeout(()=>loader.classList.add('hidden'),500)}requestAnimationFrame(()=>requestAnimationFrame(()=>initConstCanvas()));return}
    empty.classList.add('hidden');
    // Load pending reveal requests for constellation state
    try{
      const pendingReveals=await(await fetch('/api/identity/pending/'+state.userId)).json();
      if(!state.pendingReveals)state.pendingReveals={};
      pendingReveals.forEach(pr=>{
        const partnerId=pr.fromUserId===state.userId?pr.toUserId:pr.fromUserId;
        state.pendingReveals[partnerId]=pr.direction;
        // Also update node data
        const nd=data.nodes.find(n=>n.id===partnerId);
        if(nd)nd.pendingReveal=pr.direction;
      });
    }catch(e){}
    // Layout nodes in 3D space — wide spread + z-depth by time
    const now=Date.now();
    const nodeCount=data.nodes.length;
    // Fewer nodes → more spread so they don't cluster
    const fewBonus=nodeCount<6?(6-nodeCount)*32:0;
    const nodes=data.nodes.map((n,i)=>{
      const angle=(i/nodeCount)*Math.PI*2-Math.PI/2;
      const lastMs=n.lastDate?now-new Date(n.lastDate).getTime():999999999;
      const hrs=lastMs/3600000;
      let zDepth;
      // Active connections and recent encounters are closest
      if(n.hasActiveRelation)zDepth=20+Math.random()*20;       // active → very close
      else if(hrs<1)zDepth=48+Math.random()*28;                // <1h → close
      else if(hrs<6)zDepth=80+Math.random()*40;                // <6h → medium-close
      else if(hrs<12)zDepth=130+Math.random()*50;              // <12h → medium
      else if(hrs<24)zDepth=200+Math.random()*60;              // <24h → medium-far
      else if(hrs<72)zDepth=280+Math.random()*70;              // <3d → far
      else zDepth=360+Math.min(200,hrs*0.8)+Math.random()*50;  // >3d → very far
      // More encounters = slightly closer bonus
      zDepth=Math.max(10,zDepth-Math.min(40,Math.log2(1+(n.encounters||1))*12));
      // XY spread — 20% reduced, scales with depth + bonus for few nodes
      const spread=128+fewBonus+zDepth*0.56+(Math.random()-.5)*48;
      // Size: smaller=newer, bigger=longer relationship (by time since first encounter)
      const ageMs=n.firstDate?now-new Date(n.firstDate).getTime():(n.lastDate?now-new Date(n.lastDate).getTime():0);
      const ageDays=ageMs/86400000;
      const sizeByAge=Math.min(22,6+Math.log2(1+ageDays)*4+Math.log2(1+(n.encounters||1))*2);
      return{...n,
        x3d:Math.cos(angle)*spread+(Math.random()-.5)*50,
        y3d:Math.sin(angle)*spread+(Math.random()-.5)*50,
        z3d:zDepth,
        color:n.color||nickColor(n.nickname||'?'),baseRadius:sizeByAge,pulsePhase:Math.random()*Math.PI*2};
    });
    // Pre-load images for revealed users — full cascade
    const myCanSee=state.revealedIds||{};
    nodes.forEach(n=>{
      const revealed=!!(n.partnerRevealedToMe||myCanSee[n.id]);
      // Full photo cascade: profilePhoto > canSee snapshot > lastSelfie
      const photo=n.profilePhoto
        ||(myCanSee[n.id]&&myCanSee[n.id].profilePhoto)
        ||n.lastSelfie||null;
      // DEBUG: log photo status for each node
      console.log('[PHOTO DEBUG]',n.nickname,'| revealed:',revealed,'| profilePhoto:',n.profilePhoto?'YES('+n.profilePhoto.substring(0,30)+')':'NULL','| canSee:',myCanSee[n.id]?JSON.stringify({photo:!!(myCanSee[n.id].profilePhoto)}):'N/A','| lastSelfie:',n.lastSelfie?'YES':'NULL','| finalPhoto:',photo?'YES':'NULL');
      if(revealed&&photo){
        const img=new Image();
        img.src=photo;
        n._img=img;n._imgLoaded=false;n._revealed=true;
        img.onload=()=>{n._imgLoaded=true;console.log('[PHOTO LOADED]',n.nickname)};
        img.onerror=(e)=>{n._imgLoaded=false;n._revealed=true;console.error('[PHOTO ERROR]',n.nickname,photo.substring(0,60),e)}; // show silhouette on error
      }else if(revealed){
        // Revealed but no photo at all — mark revealed for silhouette + real name
        console.log('[PHOTO NONE]',n.nickname,'revealed but no photo source at all');
        n._img=null;n._imgLoaded=false;n._revealed=true;
      }else{
        n._img=null;n._imgLoaded=false;n._revealed=false;
      }
    });
    constState.nodes=nodes;
    constState.cam={x:0,y:0,zoom:0.15};
    constState._entryAnim={active:true,startTime:Date.now(),duration:900};
    constState.selectedNode=null;
    // Pre-load user's own photo for center node
    if(state.userPhoto&&!constState._myImgLoaded){
      const mi=new Image();mi.src=state.userPhoto;
      constState._myImg=mi;constState._myImgLoaded=false;
      mi.onload=()=>{constState._myImgLoaded=true;console.log('[MY PHOTO LOADED]')};
      mi.onerror=(e)=>{console.error('[MY PHOTO ERROR]',state.userPhoto?.substring(0,60),e);constState._myImgLoaded=false};
    }
    hideConstDetail();
    // Wait for screen to become visible before measuring canvas
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      initConstCanvas();
      // Hide loader after canvas is ready
      const ld=$('constLoader');
      if(ld){ld.classList.add('fade-out');setTimeout(()=>ld.classList.add('hidden'),500)}
    }));
    // Show feedback if new nodes since last visit
    const prevCount=parseInt(localStorage.getItem('touch_const_count')||'0');
    if(data.total>prevCount&&prevCount>0){
      const fb=$('constFeedback');
      fb.textContent=CONST_FEEDBACK[Math.floor(Math.random()*CONST_FEEDBACK.length)];
      fb.classList.add('show');
      setTimeout(()=>fb.classList.remove('show'),3500);
    }
    localStorage.setItem('touch_const_count',String(data.total));
  }catch(e){const ld=$('constLoader');if(ld){ld.classList.add('fade-out');setTimeout(()=>ld.classList.add('hidden'),500)}showToast('Erro ao carregar.')}
}

function initConstCanvas(){
  const canvas=$('constCanvas');if(!canvas)return;
  const wrap=canvas.parentElement;
  const dpr=window.devicePixelRatio||1;
  canvas.width=wrap.clientWidth*dpr;
  canvas.height=wrap.clientHeight*dpr;
  canvas.style.width=wrap.clientWidth+'px';
  canvas.style.height=wrap.clientHeight+'px';
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  const W=wrap.clientWidth,H=wrap.clientHeight;

  // ── 3D Perspective parameters ──
  const FOV=300; // field of view — higher = less extreme perspective

  // ── Accelerometer tilt ──
  let tiltX=0,tiltY=0,rawTX=0,rawTY=0;
  function onDevOri(e){
    rawTX=(e.gamma||0)/25;rawTY=(e.beta||0)/25;
  }
  if(window.DeviceOrientationEvent){
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
      DeviceOrientationEvent.requestPermission().then(p=>{if(p==='granted')window.addEventListener('deviceorientation',onDevOri)}).catch(()=>{});
    }else{window.addEventListener('deviceorientation',onDevOri)}
  }
  constState._cleanGyro=()=>{window.removeEventListener('deviceorientation',onDevOri)};

  // ── Touch: 1 finger drag, 2 finger pinch+pan ──
  let pinchDist=0,pinchZoom=1,pointerStart=null,touches2Start=null;
  canvas.onpointerdown=e=>{
    constState.dragging=true;constState.lastTouch={x:e.clientX,y:e.clientY};pointerStart={x:e.clientX,y:e.clientY};
  };
  canvas.onpointermove=e=>{
    if(!constState.dragging||!constState.lastTouch)return;
    if(constState.fpMode)return; // FP mode: only accelerometer, no drag
    const dx=e.clientX-constState.lastTouch.x,dy=e.clientY-constState.lastTouch.y;
    constState.cam.x+=dx/constState.cam.zoom;constState.cam.y+=dy/constState.cam.zoom;
    constState.lastTouch={x:e.clientX,y:e.clientY};
  };
  canvas.onpointerup=e=>{
    if(constState.dragging&&pointerStart){
      const tapThresh=12;
      if(Math.abs(e.clientX-pointerStart.x)<tapThresh&&Math.abs(e.clientY-pointerStart.y)<tapThresh)
        handleConstTap(e.clientX-canvas.getBoundingClientRect().left,e.clientY-canvas.getBoundingClientRect().top,W,H);
    }
    constState.dragging=false;constState.lastTouch=null;pointerStart=null;
  };
  canvas.ontouchstart=e=>{
    if(e.touches.length===2){
      pinchDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      pinchZoom=constState.cam.zoom;
      touches2Start={mx:(e.touches[0].clientX+e.touches[1].clientX)/2,my:(e.touches[0].clientY+e.touches[1].clientY)/2,cx:constState.cam.x,cy:constState.cam.y};
    }
  };
  canvas.ontouchmove=e=>{
    if(e.touches.length===2){
      e.preventDefault();
      const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      constState.cam.zoom=Math.max(.08,Math.min(50,pinchZoom*(d/pinchDist)));
      if(touches2Start){
        const mx=(e.touches[0].clientX+e.touches[1].clientX)/2,my=(e.touches[0].clientY+e.touches[1].clientY)/2;
        constState.cam.x=touches2Start.cx+(mx-touches2Start.mx)/constState.cam.zoom;
        constState.cam.y=touches2Start.cy+(my-touches2Start.my)/constState.cam.zoom;
      }
    }
  };
  canvas.onwheel=e=>{e.preventDefault();constState.cam.zoom=Math.max(.08,Math.min(50,constState.cam.zoom*(e.deltaY>0?.9:1.1)))};

  // ── Particles system ──
  const particles=Array.from({length:120},()=>({
    x:(Math.random()-.5)*W*2,y:(Math.random()-.5)*H*2,
    vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,
    r:Math.random()*.8+.2,a:Math.random()*.15+.03,
    phase:Math.random()*Math.PI*2
  }));

  // ── Grid lines (subtle tech background) ──
  const gridSpacing=60;

  // ── Helper: project 3D to 2D with perspective ──
  function project(x3d,y3d,z3d,camX,camY,zoom,tOX,tOY){
    const wx=(x3d+camX+tOX)*zoom;
    const wy=(y3d+camY+tOY)*zoom;
    const scale=FOV/(FOV+z3d);
    return{
      sx:W/2+wx*scale,
      sy:H*0.45+wy*scale,
      scale:scale*zoom,
      z3d:z3d
    };
  }

  // ── Helper: draw image with center-crop (no stretching) ──
  function drawCroppedImage(img,cx,cy,r){
    const iw=img.naturalWidth||img.width;
    const ih=img.naturalHeight||img.height;
    if(!iw||!ih)return;
    // Compute center square crop from source
    const side=Math.min(iw,ih);
    const sx=(iw-side)/2;
    const sy=(ih-side)/2;
    ctx.save();
    ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.clip();
    ctx.drawImage(img,sx,sy,side,side,cx-r,cy-r,r*2,r*2);
    ctx.restore();
  }

  if(constState.animFrame)cancelAnimationFrame(constState.animFrame);

  // FP mode transition smoothing
  let fpBlend=0; // 0=normal, 1=full FP

  function draw(){
    constState.animFrame=requestAnimationFrame(draw);
    ctx.clearRect(0,0,W,H);
    const t=Date.now()/1000;
    // ── Entry animation — zoom from far to normal ──
    if(constState._entryAnim&&constState._entryAnim.active){
      const ea=constState._entryAnim;
      const elapsed=Date.now()-ea.startTime;
      const progress=Math.min(1,elapsed/ea.duration);
      // Ease out cubic: quick start, smooth landing
      const ease=1-Math.pow(1-progress,3);
      // Zoom: 0.15 → 1.12 → 1.0 (slight overshoot)
      const overshoot=progress<0.7?0:Math.sin((progress-0.7)/0.3*Math.PI)*0.12;
      constState.cam.zoom=0.15+(1-0.15)*ease+overshoot*(1-Math.pow(Math.max(0,(progress-0.85)/0.15),2));
      if(progress>=1){constState._entryAnim.active=false;constState.cam.zoom=1}
    }
    // Lerp tilt
    tiltX+=(rawTX-tiltX)*0.08;tiltY+=(rawTY-tiltY)*0.08;

    // ── FP transition blend ──
    const fpTarget=constState.fpMode?1:0;
    fpBlend+=(fpTarget-fpBlend)*0.06; // smooth ~16 frames
    if(Math.abs(fpBlend-fpTarget)<0.005)fpBlend=fpTarget;
    const isFP=fpBlend>0.01;

    const z=constState.cam.zoom;
    // Tilt scales with zoom — more zoom = more parallax movement
    const tiltMul=Math.min(3,1+Math.log2(Math.max(1,z))*0.6);
    const tiltOffX=tiltX*40*tiltMul*(1-fpBlend);
    const tiltOffY=tiltY*28*tiltMul*(1-fpBlend);

    // ── Subtle hex grid ──
    const gridAlpha=0.03*(1-fpBlend*0.7);
    ctx.save();ctx.globalAlpha=gridAlpha;ctx.strokeStyle='#4488ff';ctx.lineWidth=.5;
    for(let gx=-gridSpacing;gx<W+gridSpacing;gx+=gridSpacing){
      const ox=gx+tiltOffX*.3+(constState.cam.x*z*.1)%gridSpacing;
      ctx.beginPath();ctx.moveTo(ox,0);ctx.lineTo(ox,H);ctx.stroke();
    }
    for(let gy=-gridSpacing;gy<H+gridSpacing;gy+=gridSpacing){
      const oy=gy+tiltOffY*.3+(constState.cam.y*z*.1)%gridSpacing;
      ctx.beginPath();ctx.moveTo(0,oy);ctx.lineTo(W,oy);ctx.stroke();
    }
    ctx.restore();

    // ── Floating particles ──
    particles.forEach(p=>{
      p.x+=p.vx;p.y+=p.vy;
      if(p.x<-W)p.x=W;if(p.x>W)p.x=-W;if(p.y<-H)p.y=H;if(p.y>H)p.y=-H;
      const sx=W/2+p.x+tiltOffX*(.5+p.r);const sy=H/2+p.y+tiltOffY*(.5+p.r);
      const flicker=p.a+Math.sin(t*2+p.phase)*.02;
      ctx.beginPath();ctx.arc(sx,sy,p.r,0,Math.PI*2);
      ctx.fillStyle='rgba(100,160,255,'+flicker.toFixed(3)+')';ctx.fill();
    });

    if(!constState.nodes.length)return;
    const camX=constState.cam.x+tiltOffX;
    const camY=constState.cam.y+tiltOffY;

    // ── FP mode: accelerometer-only look direction ──
    let fpYaw=0,fpPitch=0;
    if(isFP){
      // Accelerometer directly drives look direction — wide range
      fpYaw=tiltX*2.0;   // gamma tilt → horizontal look
      fpPitch=tiltY*1.4;  // beta tilt → vertical look
    }
    const cosY=Math.cos(fpYaw),sinY=Math.sin(fpYaw);
    const cosP=Math.cos(fpPitch),sinP=Math.sin(fpPitch);

    // ── Project nodes ──
    // Normal: 3D from outside. FP: center at bottom, nodes fan out upward/sides
    const meProj=project(0,0,0,camX,camY,z,0,0);
    // Blend center position: normal center → bottom-center for FP
    const fpCenterX=W/2;
    const fpCenterY=H*0.88; // center node goes to bottom
    const mcx=meProj.sx*(1-fpBlend)+fpCenterX*fpBlend;
    const mcy=meProj.sy*(1-fpBlend)+fpCenterY*fpBlend;
    constState._mcx=mcx;constState._mcy=mcy;

    const FP_FOV=260; // wider FOV — keeps nodes visible and closer together
    // Filter nodes — service-only connections hidden from constellation (stay in history)
    const filteredNodes=constState.nodes.filter(n=>{
      // Pure service connections (no personal encounters) → hide from constellation
      if(!n.isEvent&&n.isServiceConnection)return false;
      if(constFilter==='events')return !!n.isEvent;
      if(constFilter==='people'){
        // Revealed people only
        const isRevealed=!!(n.partnerRevealedToMe||(state.revealedIds&&state.revealedIds[n.id]));
        return !n.isEvent&&isRevealed;
      }
      if(constFilter==='anon'){
        const isRevealed=!!(n.partnerRevealedToMe||(state.revealedIds&&state.revealedIds[n.id]));
        return !n.isEvent&&!isRevealed;
      }
      return true; // 'all' = people + events (service-only already excluded above)
    });
    const projected=filteredNodes.map(n=>{
      if(fpBlend<0.01){
        // Pure normal mode
        const p=project(n.x3d,n.y3d,n.z3d,camX,camY,z,0,0);
        n._px=p.sx;n._py=p.sy;n._pscale=p.scale;
        return{n,sx:p.sx,sy:p.sy,scale:p.scale,z3d:p.z3d};
      }
      // FP: fan ALL nodes upward from VOCÊ — like a burst
      // Apply accelerometer rotation to shift the view
      const rx=n.x3d*cosY-n.z3d*sinY;
      const rz=n.x3d*sinY+n.z3d*cosY;
      const ry=n.y3d*cosP-rz*sinP;
      const rz2=n.y3d*sinP+rz*cosP;
      // Flatten depth — push everything to a visible range
      const fpZ=Math.max(60,120+rz2*0.3);
      const fpScale=FP_FOV/fpZ;
      // ALL nodes go UP: Y is always negative (above VOCÊ), spread horizontally
      const fpSx=fpCenterX+rx*fpScale*0.7;
      const fpSy=fpCenterY-Math.abs(fpScale)*(120+Math.abs(ry)*0.5+rz2*0.15);
      // Blend between normal and FP
      const normalP=project(n.x3d,n.y3d,n.z3d,camX,camY,z,0,0);
      const bx=normalP.sx*(1-fpBlend)+fpSx*fpBlend;
      const by=normalP.sy*(1-fpBlend)+fpSy*fpBlend;
      const bs=normalP.scale*(1-fpBlend)+fpScale*fpBlend;
      const bz=n.z3d*(1-fpBlend)+fpZ*fpBlend;
      n._px=bx;n._py=by;n._pscale=bs;
      return{n,sx:bx,sy:by,scale:bs,z3d:bz};
    });
    projected.sort((a,b)=>b.z3d-a.z3d);



    // ── Draw connections — solid LED-glow lines (thickness capped) ──
    const MAX_LINE=3; // max pixel thickness for LED core
    projected.forEach(({n,sx,sy,scale})=>{
      const lineBothVerified=!!(n.partnerRevealedToMe&&n.iRevealedToPartner)||(!!((n.realName&&n.realName!==n.nickname)&&(n.iRevealedToPartner||(state.revealedIds&&state.revealedIds[n.id]&&state.revealedIds[n.id]._iRevealed))));
      const lineColor=lineBothVerified?'0,220,130':'100,140,255';
      const depthAlpha=Math.max(0.03,scale*0.8);
      const rawThick=(0.3+Math.log2(1+(n.encounters||1))*0.4)*scale;
      const thick=Math.min(rawThick,MAX_LINE);
      const lineAlpha=depthAlpha*(0.1+n.intensity*.2);
      // Selected node gets brighter line, but keeps same endpoint (no redirect)
      const isSel=constState.selectedNode&&constState.selectedNode.id===n.id;
      let endX=sx,endY=sy;
      let aMul=isSel?2.0:1; // selected line brighter
      // Dim non-selected when searching
      if(constState._searchQuery&&!n._searchMatch)aMul*=0.15;
      ctx.save();
      // Outer glow layer (wide, soft)
      ctx.beginPath();ctx.moveTo(mcx,mcy);ctx.lineTo(endX,endY);
      ctx.strokeStyle='rgba('+lineColor+','+(lineAlpha*0.3*aMul).toFixed(3)+')';
      ctx.lineWidth=Math.min(thick*4,10);ctx.stroke();
      // Mid glow
      ctx.beginPath();ctx.moveTo(mcx,mcy);ctx.lineTo(endX,endY);
      ctx.strokeStyle='rgba('+lineColor+','+(lineAlpha*0.6*aMul).toFixed(3)+')';
      ctx.lineWidth=Math.min(thick*2,6);ctx.stroke();
      // Core bright line (LED center)
      ctx.beginPath();ctx.moveTo(mcx,mcy);ctx.lineTo(endX,endY);
      ctx.strokeStyle='rgba('+lineColor+','+(lineAlpha*1.2*aMul).toFixed(3)+')';
      ctx.lineWidth=Math.min(thick*0.8,MAX_LINE);ctx.stroke();
      // Traveling energy pulse
      const pulsePos=(t*0.4+n.pulsePhase)%1;
      const px=mcx+(endX-mcx)*pulsePos,py=mcy+(endY-mcy)*pulsePos;
      const pSize=Math.max(2,Math.min(8,6*scale));
      const pg=ctx.createRadialGradient(px,py,0,px,py,pSize);
      pg.addColorStop(0,'rgba('+lineColor+','+(depthAlpha*0.7*aMul).toFixed(3)+')');
      pg.addColorStop(0.4,'rgba('+lineColor+','+(depthAlpha*0.3*aMul).toFixed(3)+')');
      pg.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(px,py,pSize,0,Math.PI*2);ctx.fillStyle=pg;ctx.fill();
      ctx.restore();
    });

    // ── Draw nodes back-to-front ──
    const MAX_NODE_R=28; // fixed max pixel size — zoom only spreads nodes apart
    projected.forEach(({n,sx,sy,scale,z3d})=>{
      const pulse=1+Math.sin(t*1.5+n.pulsePhase)*.06;
      const rawR=n.baseRadius*scale*pulse;
      const r=Math.min(rawR,MAX_NODE_R);
      if(r<0.5)return; // too small to see
      const theyRevealedToMe=!!(n.partnerRevealedToMe||(state.revealedIds&&state.revealedIds[n.id]));
      // Dynamic photo loading — check on every frame if reveal status changed
      if(theyRevealedToMe&&!n._revealed){
        // Cascade: profilePhoto > revealedIds photo > lastSelfie
        const photo=n.profilePhoto
          ||(state.revealedIds&&state.revealedIds[n.id]&&state.revealedIds[n.id].profilePhoto)
          ||n.lastSelfie||null;
        if(photo&&!n._imgLoading){
          n._imgLoading=true;n._revealed=true;
          const img=new Image();
          img.src=photo;
          n._img=img;n._imgLoaded=false;
          img.onload=()=>{n._imgLoaded=true;n._imgLoading=false};
          img.onerror=()=>{n._imgLoading=false;n._revealed=false}; // allow retry
        }
        // Even without photo, mark as revealed so initials show realName
        if(!photo)n._revealed=true;
      }
      const ringColor=n.isEvent?'#60a5fa':(theyRevealedToMe?'#00dc82':'#ff4466');
      const glowRGB=n.isEvent?'96,165,250':(theyRevealedToMe?'0,220,130':'255,68,102');
      // Depth-based opacity: close nodes=bright, far nodes=dim
      let depthAlpha=Math.max(0.15,Math.min(1,scale*1.2));
      // Search dimming: non-matching nodes fade
      if(constState._searchQuery&&!n._searchMatch)depthAlpha*=0.12;
      // Search highlight: matching nodes pulse brighter
      if(constState._searchQuery&&n._searchMatch)depthAlpha=Math.min(1,depthAlpha*1.4);

      // Outer glow (capped)
      const glowR=Math.min(r*3,50);
      ctx.save();ctx.globalAlpha=depthAlpha;
      const glow=ctx.createRadialGradient(sx,sy,0,sx,sy,glowR);
      glow.addColorStop(0,'rgba('+glowRGB+','+(0.06+n.intensity*.1).toFixed(2)+')');glow.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(sx,sy,glowR,0,Math.PI*2);ctx.fillStyle=glow;ctx.fill();

      // Node body: event icon, photo if revealed, or initials
      if(n.isEvent){
        // Event node: blue gradient with pin icon
        ctx.beginPath();ctx.arc(sx,sy,r,0,Math.PI*2);
        const evGrad=ctx.createRadialGradient(sx-r*.3,sy-r*.3,0,sx,sy,r);
        evGrad.addColorStop(0,'rgba(96,165,250,0.7)');evGrad.addColorStop(1,'rgba(59,130,246,0.3)');
        ctx.fillStyle=evGrad;ctx.fill();
        if(r>5){
          ctx.fillStyle='rgba(255,255,255,'+(depthAlpha*0.85).toFixed(2)+')';
          ctx.font=Math.max(6,Math.min(14,r*0.9))+'px sans-serif';
          ctx.textAlign='center';ctx.textBaseline='middle';
          ctx.fillText('📍',sx,sy);
        }
      }else if(n._revealed&&n._imgLoaded&&n._img&&r>4){
        drawCroppedImage(n._img,sx,sy,r);
      }else{
        // Anonymous silhouette avatar
        if(_anonImgReady&&r>4){
          ctx.save();
          ctx.beginPath();ctx.arc(sx,sy,r,0,Math.PI*2);ctx.clip();
          ctx.drawImage(_anonImg,sx-r,sy-r,r*2,r*2);
          ctx.restore();
        }else{
          ctx.beginPath();ctx.arc(sx,sy,r,0,Math.PI*2);
          const nGrad=ctx.createRadialGradient(sx-r*.3,sy-r*.3,0,sx,sy,r);
          nGrad.addColorStop(0,'rgba('+glowRGB+',0.6)');nGrad.addColorStop(1,'rgba('+glowRGB+',0.2)');
          ctx.fillStyle=nGrad;ctx.fill();
        }
        // Draw accessory overlay if user has one
        if(n.avatarAccessory&&r>6){
          const accC=getAccessoryImg(n.avatarAccessory);
          if(accC&&accC.ready){
            ctx.drawImage(accC.img,sx-r,sy-r,r*2,r*2);
          }
        }
      }

      // Ring: GREEN = verified, RED = anonymous
      ctx.beginPath();ctx.arc(sx,sy,r+1,0,Math.PI*2);
      ctx.strokeStyle=ringColor;ctx.lineWidth=Math.max(0.3,Math.min(1,0.8*scale));
      ctx.shadowColor=ringColor;ctx.shadowBlur=Math.max(1,Math.min(8,6*scale));ctx.stroke();ctx.shadowBlur=0;

      // Rotating scan arc for selected node
      if(constState.selectedNode&&constState.selectedNode.id===n.id){
        const sa=(t*2)%(Math.PI*2);
        ctx.beginPath();ctx.arc(sx,sy,r+5,sa,sa+Math.PI*.5);
        ctx.strokeStyle='rgba(255,255,255,.5)';ctx.lineWidth=1.5;ctx.stroke();
      }
      // Search match pulsing ring
      if(constState._searchQuery&&n._searchMatch){
        const sp=0.4+Math.sin(t*3)*.3;
        ctx.beginPath();ctx.arc(sx,sy,r+4,0,Math.PI*2);
        ctx.strokeStyle='rgba(255,255,255,'+sp.toFixed(2)+')';ctx.lineWidth=2;ctx.stroke();
      }

      // Stars around the ring — small dots filling the orbit
      if(n.starsCount&&n.starsCount>0&&r>3){
        const starR=r+3;// orbit radius
        const maxStars=Math.min(n.starsCount,20);// cap at 20 visual stars
        const starSize=Math.max(1,Math.min(2.5,r*0.12));
        for(let si=0;si<maxStars;si++){
          const sa=(si/Math.max(maxStars,12))*Math.PI*2-Math.PI/2;
          const sSx=sx+Math.cos(sa)*starR;
          const sSy=sy+Math.sin(sa)*starR;
          const flicker=0.5+Math.sin(t*3+si*0.7)*0.3;
          ctx.beginPath();ctx.arc(sSx,sSy,starSize,0,Math.PI*2);
          ctx.fillStyle='rgba(255,215,0,'+flicker.toFixed(2)+')';ctx.fill();
        }
        // Count label if many stars
        if(n.starsCount>3&&r>5){
          ctx.font='bold '+Math.max(4,Math.min(7,r*0.35))+'px Inter,sans-serif';
          ctx.fillStyle='rgba(255,215,0,.6)';ctx.textAlign='center';ctx.textBaseline='middle';
          ctx.fillText('★'+n.starsCount,sx,sy-r-8);
        }
      }
      // Top tag badge above node
      if(n.topTag&&r>5){
        const tagLabels={top1:'TOP 1',top5:'TOP 5',top50:'TOP 50',top100:'TOP 100',top1000:'TOP 1K',top5000:'TOP 5K',top10000:'TOP 10K',top100000:'TOP 100K'};
        const tagColors={top1:'#FFD700',top5:'#C0C0C0',top50:'#CD7F32',top100:'#6a5acd',top1000:'#20b2aa',top5000:'#708090',top10000:'#556b2f',top100000:'#8b4513'};
        const tagTxt=tagLabels[n.topTag]||'';
        if(tagTxt){
          const tagFs=Math.max(5,Math.min(8,6*scale));
          const tagW=ctx.measureText?tagFs*tagTxt.length*0.55+6:30;
          const tagH=tagFs+4;const tagY=sy-r-tagH-3;
          const tagColor=tagColors[n.topTag]||'#888';
          ctx.fillStyle=tagColor;
          ctx.beginPath();
          const tr=tagH/2;
          ctx.moveTo(sx-tagW/2+tr,tagY);ctx.lineTo(sx+tagW/2-tr,tagY);ctx.arc(sx+tagW/2-tr,tagY+tr,tr,-Math.PI/2,Math.PI/2);ctx.lineTo(sx-tagW/2+tr,tagY+tagH);ctx.arc(sx-tagW/2+tr,tagY+tr,tr,Math.PI/2,-Math.PI/2);ctx.closePath();ctx.fill();
          ctx.fillStyle='#000';ctx.font='bold '+tagFs+'px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
          ctx.fillText(tagTxt,sx,tagY+tagH/2);
        }
      }
      // Verified badge on constellation canvas
      if(n.verified&&r>4){const br=Math.max(5,r*.45);const bx=sx+r*.55,by=sy+r*.55;
        const vg=ctx.createLinearGradient(bx-br,by-br,bx+br,by+br);vg.addColorStop(0,'#06b6d4');vg.addColorStop(.5,'#3b82f6');vg.addColorStop(1,'#8b5cf6');
        ctx.beginPath();for(let vi=0;vi<8;vi++){const va=vi*Math.PI/4-Math.PI/2;const vri=vi%2===0?br:br*.6;ctx.lineTo(bx+Math.cos(va)*vri,by+Math.sin(va)*vri)}ctx.closePath();ctx.fillStyle=vg;ctx.fill();
        ctx.strokeStyle='#0a0a0f';ctx.lineWidth=Math.max(.8,1.5*scale);ctx.stroke();
        ctx.fillStyle='#fff';ctx.font='700 '+Math.max(4,br*.85)+'px Inter';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('✓',bx,by+.2)}
      // Label — show nickname only (real name only if revealed)
      if(r>3){
        const label=n._revealed?(n.realName||n.nickname):n.nickname;
        const fontSize=Math.max(6,Math.min(11,8*scale));
        ctx.fillStyle='rgba(255,255,255,'+(depthAlpha*(0.35+n.intensity*0.35)).toFixed(2)+')';
        ctx.font='500 '+fontSize+'px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='top';
        ctx.fillText(label.length>12?label.slice(0,11)+'…':label,sx,sy+r+4);
        if(n.encounters>1&&r>6){
          ctx.fillStyle='rgba(255,255,255,'+(depthAlpha*0.2).toFixed(2)+')';ctx.font=(Math.max(5,Math.min(9,6*scale)))+'px Inter,sans-serif';
          ctx.fillText(n.encounters+'x',sx,sy+r+4+fontSize+2);
        }
      }
      ctx.restore();
    });
    ctx.textBaseline='alphabetic';

    // ── Center node (me) — stays visible, slides to bottom in FP ──
    {
      ctx.save();
      const MAX_MY_R=32;
      const myR=Math.min(16*z,MAX_MY_R);
      // Outer scan ring
      const scanAngle=(t*0.5)%(Math.PI*2);
      ctx.beginPath();ctx.arc(mcx,mcy,myR*2.5,scanAngle,scanAngle+Math.PI*.6);
      ctx.strokeStyle='rgba(255,107,53,.15)';ctx.lineWidth=1;ctx.stroke();
      // Glow
      const myGlow=ctx.createRadialGradient(mcx,mcy,0,mcx,mcy,myR*3);
      myGlow.addColorStop(0,'rgba(255,107,53,.2)');myGlow.addColorStop(.5,'rgba(255,107,53,.05)');myGlow.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(mcx,mcy,myR*3,0,Math.PI*2);ctx.fillStyle=myGlow;ctx.fill();
      // Photo or initials
      if(constState._myImg&&constState._myImgLoaded){
        drawCroppedImage(constState._myImg,mcx,mcy,myR);
      }else if(_anonImgReady){
        ctx.save();ctx.beginPath();ctx.arc(mcx,mcy,myR,0,Math.PI*2);ctx.clip();
        ctx.drawImage(_anonImg,mcx-myR,mcy-myR,myR*2,myR*2);ctx.restore();
      }else{
        ctx.beginPath();ctx.arc(mcx,mcy,myR,0,Math.PI*2);ctx.fillStyle=state.userColor||'#ff6b35';ctx.fill();
      }
      // Draw my accessory on center node — only when showing silhouette (no photo)
      if(state.userAccessory&&myR>6&&!(constState._myImg&&constState._myImgLoaded)){
        const myAccC=getAccessoryImg(state.userAccessory);
        if(myAccC&&myAccC.ready){ctx.drawImage(myAccC.img,mcx-myR,mcy-myR,myR*2,myR*2)}
      }
      // Orange ring
      ctx.beginPath();ctx.arc(mcx,mcy,myR,0,Math.PI*2);ctx.strokeStyle='rgba(255,107,53,.6)';ctx.lineWidth=Math.min(2*z,3);ctx.stroke();
      // Label
      ctx.fillStyle='rgba(255,255,255,.4)';ctx.font=Math.min(8*z,12)+'px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='top';
      ctx.fillText('VOCÊ',mcx,mcy+myR+4);
      ctx.restore();
    }

    // ── FP mode HUD: hint centered, fades out after 4s ──
    if(fpBlend>0.6){
      const fpStart=constState._fpHintStart||(constState._fpHintStart=Date.now());
      const fpElapsed=(Date.now()-fpStart)/1000;
      const hintAlpha=fpElapsed<3?fpBlend*0.45:fpElapsed<4.5?fpBlend*0.45*(1-(fpElapsed-3)/1.5):0;
      if(hintAlpha>0.01){
        ctx.save();ctx.globalAlpha=hintAlpha;
        ctx.fillStyle='#fff';ctx.font='400 11px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText('incline o celular para explorar',W/2,H/2-8);
        ctx.fillText('toque no centro para voltar',W/2,H/2+10);
        ctx.restore();
      }
    }else{
      constState._fpHintStart=0; // reset when exiting FP so hint shows again next time
    }

    // ── Floating legend pill (hidden in FP mode) ──
    if(fpBlend>0.7)return; // skip pill in full FP
    const revealedNodes=constState.nodes.filter(n=>!n.isEvent&&!!(n.partnerRevealedToMe||(state.revealedIds&&state.revealedIds[n.id])));
    const anonNodes=constState.nodes.filter(n=>!n.isEvent).length-revealedNodes.length;
    const eventsCount=constState.nodes.filter(n=>!!n.isEvent).length;
    const pillW=Math.min(W-16,320),pillH=28,pillX=(W-pillW)/2,pillY=H-44;
    ctx.save();ctx.globalAlpha=1-fpBlend;
    constState._pillBounds={x:pillX,y:pillY,w:pillW,h:pillH,sections:[]};
    ctx.beginPath();
    const pillR=pillH/2;
    ctx.moveTo(pillX+pillR,pillY);ctx.lineTo(pillX+pillW-pillR,pillY);
    ctx.arc(pillX+pillW-pillR,pillY+pillR,pillR,-Math.PI/2,Math.PI/2);
    ctx.lineTo(pillX+pillR,pillY+pillH);ctx.arc(pillX+pillR,pillY+pillR,pillR,Math.PI/2,-Math.PI/2);
    ctx.closePath();
    ctx.fillStyle='rgba(10,10,25,.7)';ctx.fill();
    ctx.strokeStyle='rgba(100,160,255,.1)';ctx.lineWidth=0.5;ctx.stroke();
    const midY=pillY+pillH/2;
    let tx=pillX+10;
    // Section helper
    function drawPillSection(label,count,color,filterKey){
      const active=constFilter===filterKey;
      const hl=active?.95:.5;
      const sx=tx;
      ctx.beginPath();ctx.arc(tx,midY,3,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
      tx+=8;
      ctx.fillStyle='rgba(255,255,255,'+hl+')';ctx.font=(active?'700':'500')+' 9px Inter,sans-serif';ctx.textAlign='left';ctx.textBaseline='middle';
      ctx.fillText(label+' '+count,tx,midY);
      tx+=ctx.measureText(label+' '+count).width+10;
      constState._pillBounds.sections.push({x:sx-4,w:tx-sx,key:filterKey});
    }
    drawPillSection('Revelados',revealedNodes.length,'#00dc82','people');
    drawPillSection('Anônimos',anonNodes,'#ff4466','anon');
    drawPillSection('Eventos',eventsCount,'#60a5fa','events');
    // Total on right
    ctx.textAlign='right';ctx.fillStyle='rgba(255,255,255,.2)';ctx.font='400 8px Inter,sans-serif';
    ctx.fillText(filteredNodes.length+'',pillX+pillW-10,midY);
    ctx.restore();
    ctx.textBaseline='alphabetic';
  }
  draw();
}

function handleConstTap(tx,ty,W,H){
  // Tap on legend pill → toggle filter
  if(constState._pillBounds&&constState._pillBounds.sections){
    const pb=constState._pillBounds;
    if(ty>=pb.y&&ty<=pb.y+pb.h&&tx>=pb.x&&tx<=pb.x+pb.w){
      const relX=tx-pb.x;
      for(const sec of pb.sections){
        if(relX>=sec.x&&relX<sec.x+sec.w){
          setConstFilter(constFilter===sec.key?'all':sec.key);
          haptic([15]);return;
        }
      }
    }
  }
  // Tap center → show own profile card
  if(constState._mcx!==undefined){
    const dCenter=Math.hypot(tx-constState._mcx,ty-constState._mcy);
    if(dCenter<40){
      showConstDetail({
        id:state.userId,isMe:true,
        nickname:state.userName,realName:state.userRealName||'',
        color:state.userColor||nickColor(state.userName||'??'),
        profilePhoto:state.userPhoto||null,
        verified:!!state.userVerified,topTag:state.userTopTag||null,
        starsCount:state.userStarsCount||0,score:state.userScore||0,
        partnerRevealedToMe:true,iRevealedToPartner:true,
        encounters:0,uniqueConnections:0,
        avatarAccessory:state.userAccessory||null,
        profession:state.userProfession||null,
        sports:state.userSports||[],
        hobbies:state.userHobbies||[]
      });
      haptic([15]);
      // Enter FP when clicking self too
      if(!constState.fpMode){
        constState.fpMode=true;constState.fpTransition=0;constState.fpYaw=0;constState.fpPitch=0;
      }
      return;
    }
  }
  // In FP mode, tap on a node → show detail (stay in FP)
  if(constState.fpMode){
    let hit=null,minD=Infinity;
    constState.nodes.forEach(n=>{
      if(n._px===undefined)return;
      const d=Math.hypot(tx-n._px,ty-n._py);
      if(d<(n.baseRadius*(n._pscale||1)*1.8+16)&&d<minD){minD=d;hit=n}
    });
    if(hit){showConstDetail(hit)}else{
      $('constDetail').classList.remove('visible');
      constState.selectedNode=null;
      exitConstFP();
    }
    return;
  }
  // Normal mode tap
  let hit=null,minD=Infinity;
  constState.nodes.forEach(n=>{
    if(n._px===undefined)return;
    const d=Math.hypot(tx-n._px,ty-n._py);
    const hitR=n.baseRadius*(n._pscale||1)*1.8+12;
    if(d<hitR&&d<minD){minD=d;hit=n}
  });
  if(hit){
    showConstDetail(hit);
    // FPV only activates from center node (VOCÊ), not from other nodes
  }else{hideConstDetail();if(constState.fpMode)exitConstFP()}
}
function enterConstFP(){
  constState.fpMode=true;constState.fpTransition=0;constState.fpYaw=0;constState.fpPitch=0;
  hideConstDetail();
}
function exitConstFP(){
  if(!constState.fpMode)return;
  constState.fpMode=false;constState.fpTransition=1;// will animate back
}
function showConstDetail(node){
  constState.selectedNode=node;
  // SVG icon helpers (inline, no emojis)
  const ICONS={
    heart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
    heartFill:'<svg viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
    eye:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
    eyeOff:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>',
    id:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>',
    chat:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>',
    star:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
    check:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
    wait:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
    accept:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
    tip:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
    history:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/><path d="M2 12h2M20 12h2" opacity=".3"/></svg>'
  };
  function iconBtn(icon,label,onclick,cls){
    return '<button class="cd-action-icon'+(cls?' '+cls:'')+'" onclick="'+onclick+'"><span class="cd-icon">'+icon+'</span><span>'+label+'</span></button>';
  }
  // Event nodes: special detail card
  if(node.isEvent){
    window._constDetailNodeId=node.id;
    const av=$('cdAvatar');
    av.innerHTML='';av.textContent='E';av.style.background='linear-gradient(135deg,#3b82f6,#60a5fa)';av.style.fontSize='1.1rem';av.style.display='flex';av.style.alignItems='center';av.style.justifyContent='center';
    $('cdName').innerHTML='<span style="color:#60a5fa">'+esc(node.nickname||'Evento')+'</span>';
    $('cdAlias').textContent='evento';$('cdAlias').style.display='';
    $('cdStats').innerHTML='<span class="cd-stat-inline"><b>'+(node.encounters||0)+'</b> check-ins</span>';
    const metaEl=$('cdMeta');
    const lastD=node.lastDate?new Date(node.lastDate):null;
    metaEl.innerHTML=lastD?'<div class="cd-time"><span>'+timeAgo(lastD)+'</span></div>':'';
    $('cdActions').innerHTML='';
    $('cdAnonPreview').classList.add('hidden');
    const _evTags=$('cdProfileTags');if(_evTags){_evTags.style.display='none';_evTags.innerHTML=''}
    $('cdDeclSection').classList.add('hidden');
    $('constDetail').classList.add('visible');
    return;
  }
  const theyRevealed=!!node.partnerRevealedToMe;
  const iRevealed=!!node.iRevealedToPartner;
  window._constDetailNodeId=node.id;
  // Avatar
  const av=$('cdAvatar');
  av.style.fontSize='';av.style.display='';av.style.alignItems='';av.style.justifyContent='';
  av.innerHTML='';av.style.overflow='hidden';av.style.background='none';
  if(theyRevealed&&node.profilePhoto){
    // Real photo — NO accessory
    av.innerHTML='<img src="'+esc(node.profilePhoto)+'" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%">';av.style.background=node.color;
  }else{
    // Anonymous silhouette — accessory only here
    av.innerHTML=ANON_AVATAR_SVG;
    if(node.avatarAccessory&&AVATAR_ACCESSORIES[node.avatarAccessory]){av.innerHTML+='<div style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none">'+AVATAR_ACCESSORIES[node.avatarAccessory].svg+'</div>';av.style.overflow='visible'}
  }
  // Star orbit rendering
  const orbEl=$('cdStarsOrbit');
  if(orbEl){
    const sc=node.starsCount||0;
    if(sc>0){
      const positions=[[50,0],[85,15],[100,50],[85,85],[50,100],[15,85],[0,50],[15,15]];
      let orbHtml='';
      for(let i=0;i<Math.min(sc,8);i++){
        const p=positions[i];
        orbHtml+='<span class="cd-orbit-star" style="left:'+p[0]+'%;top:'+p[1]+'%;animation-delay:'+(i*0.3)+'s">★</span>';
      }
      orbEl.innerHTML=orbHtml;
      orbEl.style.display='';
    }else{
      orbEl.innerHTML='';orbEl.style.display='none';
    }
  }
  // Verified badge
  const cvb=$('cdVerifiedBadge');
  if(cvb){if(node.verified)cvb.classList.remove('hidden');else cvb.classList.add('hidden')}
  // Name + tag
  const nameEl=$('cdName');
  let nameHtml=esc(theyRevealed?(node.realName||node.nickname):node.nickname);
  if(node.topTag){
    const tagColors={top1:'#ffd700',top5:'#c0c0c0',top50:'#cd7f32',top100:'#e8a0bf',top1000:'#7ec8e3',top5000:'#b5e3b5',top10000:'#ddd',top100000:'#999'};
    nameHtml+='<span class="cd-tag" style="background:'+(tagColors[node.topTag]||'#888')+'">'+node.topTag.replace('top','TOP ')+'</span>';
  }
  nameEl.innerHTML=nameHtml;
  // Anonymous preview ball
  const anonPreview=$('cdAnonPreview');
  const anonBall=$('cdAnonBall');
  const anonNick=$('cdAnonNick');
  if(theyRevealed&&node.realName&&node.realName!==node.nickname){
    anonBall.innerHTML=ANON_AVATAR_SVG;
    anonBall.style.position='relative';
    // Accessory on the anonymous ball — scaled to fit 24px mini ball
    if(node.avatarAccessory&&AVATAR_ACCESSORIES[node.avatarAccessory]){
      anonBall.innerHTML+='<div style="position:absolute;top:0;left:0;width:24px;height:24px;pointer-events:none">'+AVATAR_ACCESSORIES[node.avatarAccessory].svg+'</div>';
      anonBall.style.overflow='visible';
    }else{
      anonBall.style.overflow='hidden';
    }
    anonBall.style.background='none';
    anonNick.textContent=node.nickname;
    anonPreview.classList.remove('hidden');
  }else if(!theyRevealed){
    // Not revealed: show anon avatar with accessory as the main identity
    anonPreview.classList.add('hidden');
  }else{
    anonPreview.classList.add('hidden');
  }
  // Alias
  const aliasEl=$('cdAlias');
  let aliasParts=[];
  if(theyRevealed&&node.realName&&node.realName!==node.nickname)aliasParts.push('@'+node.nickname);
  if(node.isPrestador&&node.serviceLabel)aliasParts.push(node.serviceLabel);
  aliasEl.textContent=aliasParts.join(' · ');
  aliasEl.style.display=aliasParts.length?'':'none';
  // Inline stats — single clean line, no emojis
  const statsEl=$('cdStats');
  const stars=node.starsCount||0;
  const score=node.score||0;
  const conns=node.uniqueConnections||node.touchers||0;
  let statParts=[];
  const likes=node.likesCount||0;
  if(stars>0)statParts.push('<span class="cd-stat-inline"><b style="color:#fbbf24">'+stars+'</b> estrelas</span>');
  statParts.push('<span class="cd-stat-inline"><b style="color:#60a5fa">'+score+'</b> pts</span>');
  statParts.push('<span class="cd-stat-inline"><b>'+conns+'</b> conexões</span>');
  if(likes>0)statParts.push('<span class="cd-stat-inline"><b style="color:#f87171">'+likes+'</b> curtidas</span>');
  statsEl.innerHTML=statParts.join('<span class="cd-stat-sep">·</span>');
  // Profile tags: profession, sports, hobbies
  const tagsEl=$('cdProfileTags');
  if(tagsEl){
    const allTags=[];
    if(node.profession)allTags.push({text:node.profession});
    (node.sports||[]).forEach(s=>allTags.push({text:s}));
    (node.hobbies||[]).forEach(h=>allTags.push({text:h}));
    if(allTags.length>0){
      tagsEl.innerHTML=allTags.map(t=>'<span style="display:inline-flex;align-items:center;padding:.15rem .45rem;border-radius:14px;font-size:.5rem;font-weight:500;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);color:rgba(255,255,255,.35);letter-spacing:.02em">'+esc(t.text)+'</span>').join('');
      tagsEl.style.display='flex';
    }else{tagsEl.style.display='none';tagsEl.innerHTML=''}
  }
  // Meta section: time, social links, selfies
  const metaEl=$('cdMeta');
  let metaHtml='';
  const lastD=node.lastDate?new Date(node.lastDate):null;
  if(lastD)metaHtml+='<div class="cd-time"><span>último touch a '+timeAgo(lastD)+'</span></div>';
  // Social links (compact, only when revealed)
  if(theyRevealed){
    let socialHtml='<div style="display:flex;gap:.3rem;margin:.2rem 0;flex-wrap:wrap">';
    if(node.instagram){
      const handle=node.instagram.replace(/^@/,'').trim();
      socialHtml+='<a href="https://instagram.com/'+esc(handle)+'" target="_blank" rel="noopener" onclick="event.stopPropagation()" class="cd-insta">'
        +'<svg width="12" height="12" viewBox="0 0 24 24" fill="none"><rect x="2" y="2" width="20" height="20" rx="5" stroke="#e1306c" stroke-width="2"/><circle cx="12" cy="12" r="5" stroke="#e1306c" stroke-width="2"/><circle cx="17.5" cy="6.5" r="1.5" fill="#e1306c"/></svg>'
        +' @'+esc(handle)+'</a>';
    }
    if(node.whatsapp){
      const num=node.whatsapp.replace(/\D/g,'');const waNum=num.startsWith('55')?num:'55'+num;
      socialHtml+='<a href="https://wa.me/'+waNum+'" target="_blank" rel="noopener" onclick="event.stopPropagation()" style="display:inline-flex;align-items:center;gap:.2rem;padding:.2rem .45rem;background:rgba(37,211,102,.06);border:1px solid rgba(37,211,102,.12);border-radius:12px;color:#25d366;font-size:.55rem;font-weight:500;text-decoration:none">'
        +'<svg width="12" height="12" viewBox="0 0 24 24" fill="#25d366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 2C6.477 2 2 6.477 2 12c0 1.89.525 3.66 1.438 5.168L2 22l4.832-1.438A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2z" fill="none" stroke="#25d366" stroke-width="1.5"/></svg>'
        +' WhatsApp</a>';
    }
    socialHtml+='</div>';
    if(node.instagram||node.whatsapp)metaHtml+=socialHtml;
  }
  // Selfies gallery
  const selfies=node.allSelfies||[];
  if(selfies.length>0){
    metaHtml+='<div class="cd-selfies-row">';
    selfies.forEach((s,i)=>{metaHtml+='<img class="cd-selfie" src="'+s.url+'" alt="" onclick="event.stopPropagation();openSelfieZoom('+i+',\''+node.id+'\')">';});
    metaHtml+='</div>';
  }else if(node.lastSelfie){
    metaHtml+='<img class="cd-selfie" src="'+node.lastSelfie+'" alt="" onclick="event.stopPropagation();openSelfieZoom(0,\''+node.id+'\')">';
  }
  metaEl.innerHTML=metaHtml;
  metaEl.style.display=metaHtml?'':'none';
  // Icon action buttons — circular with label, never truncates
  const actEl=$('cdActions');
  const isLiked=!!node.likedByMe;
  const pending=node.pendingReveal||state.pendingReveals[node.id]||null;
  let aHtml='';
  if(!node.isMe){
    // Like
    aHtml+=iconBtn(isLiked?ICONS.heartFill:ICONS.heart,isLiked?'Curtido':'Curtir',"toggleLike('"+node.id+"')",isLiked?'liked':'');
    // Reveal/hide ID
    if(iRevealed){
      aHtml+=iconBtn(ICONS.eyeOff,'Esconder',"toggleMyReveal('"+node.id+"',false)",'success');
    }else{
      aHtml+=iconBtn(ICONS.id,'Revelar',"toggleMyReveal('"+node.id+"',true)",'active');
    }
    // Request ID / received / waiting
    if(theyRevealed){
      const seenKey='revealSeen_'+state.userId;
      const seen=JSON.parse(localStorage.getItem(seenKey)||'{}');
      const isNew=!seen[node.id];
      if(isNew){seen[node.id]=Date.now();localStorage.setItem(seenKey,JSON.stringify(seen))}
      aHtml+=iconBtn(ICONS.check,isNew?'Recém revelado':'ID revelado','',isNew?'revealed-new':'success disabled');
    }else if(pending==='sent'){
      aHtml+=iconBtn(ICONS.wait,'Aguardando','','disabled');
    }else if(pending==='received'){
      aHtml+=iconBtn(ICONS.accept,'Aceitar',"acceptRevealRequest('"+node.id+"');hideConstDetail()",'success');
    }else{
      aHtml+=iconBtn(ICONS.eye,'Pedir ID',"requestRevealFromConstellation('"+node.id+"')",'');
    }
    // Chat — show if active relation exists
    if(node.hasActiveRelation){
      aHtml+=iconBtn(ICONS.chat,'Chat',"openChatFromConst('"+node.id+"')",'');
    }
    // Donate star
    aHtml+=iconBtn(ICONS.star,'Estrela',"event.stopPropagation();confirmDonateStar('"+node.id+"')",'star');
    // Gorjeta — icon button for prestadores
    if(node.isPrestador){
      aHtml+=iconBtn(ICONS.tip,'Gorjeta',"event.stopPropagation();constTipAction('"+node.id+"')",'tip');
    }
    // History
    aHtml+=iconBtn(ICONS.history,'Histórico',"openHistoryPanel()",'');
  }
  actEl.innerHTML=aHtml;
  // Declarations section — mural visible directly
  const declBody=$('cdDeclBody');
  declBody.innerHTML='';
  const declWrap=$('cdDeclareWrap');
  if(node.isMe){
    declWrap.classList.add('hidden');
    $('cdDeclSection').classList.add('hidden');
    actEl.innerHTML='';
  }else{
    declWrap.classList.remove('hidden');
    $('cdDeclSection').classList.remove('hidden');
    $('cdDeclareInput').value='';
  }
  // Load declarations directly into mural
  loadDeclarations(node.id);
  // Gifts count — update inline stat
  fetch('/api/gifts/count/'+node.id).then(r=>r.json()).then(d=>{
    const c=d.count||0;
    if(c>0){
      const sep=document.createElement('span');sep.className='cd-stat-sep';sep.textContent='·';
      const g=document.createElement('span');g.className='cd-stat-inline';g.innerHTML='<b style="color:#c084fc">'+c+'</b> presentes';
      statsEl.appendChild(sep);statsEl.appendChild(g);
    }
  }).catch(()=>{});
  // History panel reset
  $('cdHistoryScroll').innerHTML='<div style="font-size:.6rem;color:var(--t3);text-align:center;padding:1rem">Carregando...</div>';
  $('cdHistoryPanel').classList.remove('visible');
  window._historyLoaded=false;
  // Show card
  $('constDetail').classList.add('visible');
  haptic([15]);
}
async function loadTransactions(nodeId, isMe){
  const txEl=$('cdHistoryScroll');
  if(!txEl)return;
  txEl.innerHTML='<div style="font-size:.6rem;color:var(--t3);padding:.2rem 0;text-align:center">Carregando histórico...</div>';
  try{
    const d=await(await fetch('/api/user/'+state.userId+'/transactions')).json();
    let txList=d.transactions||[];
    // If viewing another user, filter to only transactions involving them
    if(!isMe&&nodeId){
      txList=txList.filter(tx=>tx.otherName&&tx.otherName!=='?'||tx.type==='connection'||tx.type==='checkin');
      // More precise: filter by nodeId in otherName comparison or encounter
      // Actually use the node data we have
      const nodeName=constState.selectedNode?.nickname||'';
      if(nodeName)txList=txList.filter(tx=>(tx.otherName||'').toLowerCase()===nodeName.toLowerCase()||(tx.eventName||'').toLowerCase()===nodeName.toLowerCase());
    }
    if(!txList.length){
      txEl.innerHTML='<div style="font-size:.6rem;color:var(--t3);text-align:center;padding:.4rem 0;opacity:.5">Nenhuma atividade'+(isMe?'':' com essa pessoa')+'</div>';
      return;
    }
    let html='<div style="font-size:.7rem;font-weight:600;color:var(--t2);margin-bottom:.4rem;padding:0 .2rem">'+(isMe?'Seu histórico':'Histórico com '+(constState.selectedNode?.nickname||''))+'</div>';
    txList.slice(0,30).forEach(tx=>{
      const dt=new Date(tx.timestamp);
      const time=dt.toLocaleDateString('pt-BR',{day:'2-digit',month:'short'})+' '+dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
      let icon='',label='',detail='',statusColor='';
      if(tx.type==='tip'){
        icon=tx.direction==='sent'?'💸':'💰';
        label=tx.direction==='sent'?'Gorjeta para '+esc(tx.otherName):'Gorjeta de '+esc(tx.otherName);
        detail='R$ '+tx.amount.toFixed(2).replace('.',',');
      }else if(tx.type==='entry'){
        icon='🎫';
        label='Ingresso'+(tx.eventName?' — '+esc(tx.eventName):'');
        detail='R$ '+tx.amount.toFixed(2).replace('.',',');
      }else if(tx.type==='checkin'){
        icon='📍';
        label='Check-in'+(tx.eventName?' — '+esc(tx.eventName):'');
        detail=tx.phrase?'"'+esc(tx.phrase)+'"':'';
      }else if(tx.type==='connection'){
        icon='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="1.5"><rect x="2" y="4" width="7" height="14" rx="1.5" transform="rotate(-15 5.5 11)"/><rect x="15" y="4" width="7" height="14" rx="1.5" transform="rotate(15 18.5 11)"/><circle cx="12" cy="11" r="2" fill="#60a5fa" stroke="none" opacity=".6"/><path d="M9 11h6" stroke-dasharray="1 1" opacity=".4"/></svg>';
        label='Conexão com '+esc(tx.otherName);
        detail=tx.phrase?'"'+esc(tx.phrase)+'"':'';
      }else if(tx.type==='service'){
        icon='💼';
        label='Serviço — '+esc(tx.otherName);
        detail=tx.phrase?'"'+esc(tx.phrase)+'"':'';
      }
      if(tx.status==='approved')statusColor='#34d399';
      else if(tx.status==='rejected'||tx.status==='cancelled')statusColor='#f87171';
      else if(tx.status==='pending')statusColor='#fbbf24';
      else statusColor='#94a3b8';
      const statusLabel=tx.status==='approved'?'aprovado':tx.status==='rejected'?'recusado':tx.status==='pending'?'pendente':(tx.status==='ok'?'':''+tx.status);
      html+='<div style="display:flex;align-items:flex-start;gap:.5rem;padding:.35rem 0;border-bottom:1px solid rgba(255,255,255,.04)">'
        +'<span style="font-size:.85rem;flex-shrink:0;margin-top:1px;display:flex;align-items:center;justify-content:center;width:20px;height:20px">'+icon+'</span>'
        +'<div style="flex:1;min-width:0">'
          +'<div style="font-size:.65rem;color:var(--t1);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+label+'</div>'
          +'<div style="display:flex;align-items:center;gap:.4rem;margin-top:2px">'
            +'<span style="font-size:.58rem;color:var(--t3)">'+time+'</span>'
            +(statusLabel?'<span style="font-size:.52rem;font-weight:600;color:'+statusColor+';background:'+statusColor+'18;padding:1px 5px;border-radius:6px">'+statusLabel+'</span>':'')
          +'</div>'
        +'</div>'
        +(detail?'<div style="font-size:.63rem;color:var(--t2);font-weight:600;flex-shrink:0;text-align:right">'+detail+'</div>':'')
      +'</div>';
    });
    txEl.innerHTML=html;
  }catch(e){
    txEl.innerHTML='<div style="font-size:.6rem;color:var(--t3);opacity:.5">Erro ao carregar</div>';
  }
}
async function loadDeclarations(targetId){
  const declBody=$('cdDeclBody');
  try{
    const d=await(await fetch('/api/declarations/'+targetId)).json();
    const decls=d.declarations||[];
    if(!decls.length){declBody.innerHTML='';return}
    let html='';
    decls.forEach(dc=>{
      const ago=timeAgo(new Date(dc.createdAt));
      html+='<div class="cd-decl-card">'
        +'<div class="cd-decl-text">"'+esc(dc.text)+'"</div>'
        +'<div class="cd-decl-from">'+esc(dc.fromNick||'Anônimo')+' · '+ago+'</div>'
        +'</div>';
    });
    declBody.innerHTML=html;
  }catch(e){
    declBody.innerHTML='';
  }
}
async function sendDeclaration(){
  const input=$('cdDeclareInput');
  const text=input.value.trim();
  if(!text)return showToast('Digite uma declaração');
  if(text.length<3)return showToast('Mínimo 3 caracteres');
  const targetId=window._constDetailNodeId;
  if(!targetId||targetId===state.userId)return;
  try{
    const r=await fetch('/api/declarations/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      fromUserId:state.userId,toUserId:targetId,text
    })});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    input.value='';
    showToast('Declaração enviada!');
    haptic([25,15,25]);
    loadDeclarations(targetId);
  }catch(e){showToast('Erro ao enviar')}
}
function timeAgo(date){
  const s=Math.floor((Date.now()-date.getTime())/1000);
  if(s<60)return'agora';if(s<3600)return Math.floor(s/60)+'min atrás';
  if(s<86400)return Math.floor(s/3600)+'h atrás';
  const d=Math.floor(s/86400);if(d<7)return d+'d atrás';
  if(d<30)return Math.floor(d/7)+'sem atrás';
  return date.toLocaleDateString('pt-BR');
}
function hideConstDetail(){
  const d=$('constDetail');
  d.style.transform='';
  d.classList.remove('visible');
  $('cdHistoryPanel').classList.remove('visible');
  constState.selectedNode=null;
  if(constState.fpMode)exitConstFP();
}
// ── Collapsible sections toggle ──
function toggleCdSection(bodyId,btn){
  const body=$(bodyId);
  if(!body)return;
  const isOpen=body.classList.toggle('open');
  if(btn)btn.classList.toggle('open',isOpen);
  // Lazy load gifts when first opened
  if(isOpen&&bodyId==='cdGiftsBody'&&!body.dataset.loaded){
    body.dataset.loaded='1';
    loadGiftsForProfile(window._constDetailNodeId);
  }
}
async function loadGiftsForProfile(userId){
  const body=$('cdGiftsBody');
  if(!body)return;
  body.innerHTML='<div style="font-size:.6rem;color:var(--t3);text-align:center;padding:.3rem">Carregando...</div>';
  try{
    const d=await(await fetch('/api/gifts/received/'+userId)).json();
    const gifts=d.gifts||[];
    if(!gifts.length){body.innerHTML='<div style="font-size:.6rem;color:var(--t3);text-align:center;padding:.3rem;opacity:.5">Nenhum presente</div>';return}
    let html='';
    gifts.forEach(g=>{
      html+='<div style="display:flex;align-items:center;gap:.4rem;padding:.3rem .4rem;border-bottom:1px solid rgba(255,255,255,.03)">'
        +'<span style="font-size:.9rem">'+(g.emoji||'🎁')+'</span>'
        +'<div style="flex:1;min-width:0"><div style="font-size:.6rem;color:var(--t1);font-weight:500">'+esc(g.name||'Presente')+'</div>'
        +'<div style="font-size:.5rem;color:var(--t3)">de '+esc(g.fromName||'Anônimo')+' · '+timeAgo(new Date(g.date||Date.now()))+'</div></div>'
        +'</div>';
    });
    body.innerHTML=html;
  }catch(e){body.innerHTML='<div style="font-size:.6rem;color:var(--t3);opacity:.5">Erro</div>'}
}
// ── History floating panel (lazy loaded) ──
function openHistoryPanel(){
  const panel=$('cdHistoryPanel');
  panel.classList.add('visible');
  if(!window._historyLoaded){
    window._historyLoaded=true;
    const nodeId=window._constDetailNodeId;
    const isMe=constState.selectedNode?.isMe||false;
    loadTransactions(nodeId,isMe);
  }
}
function closeHistoryPanel(){
  $('cdHistoryPanel').classList.remove('visible');
}
// ── Swipe-to-dismiss on entire detail card ──
(function(){
  let startY=0,curY=0,dragging=false,scrollTop0=0;
  function onStart(e){
    const detail=$('constDetail');
    if(!detail.classList.contains('visible'))return;
    scrollTop0=detail.scrollTop;
    // Only start drag if at top of scroll
    if(scrollTop0>5)return;
    const t=e.touches?e.touches[0]:e;
    startY=t.clientY;curY=startY;dragging=true;
    detail.style.transition='none';
  }
  function onMove(e){
    if(!dragging)return;
    const detail=$('constDetail');
    const t=e.touches?e.touches[0]:e;
    curY=t.clientY;
    const dy=curY-startY;
    // If trying to scroll up (dy<0), cancel drag and let scroll work
    if(dy<0){dragging=false;detail.style.transition='';detail.style.transform='';return}
    if(dy>8){
      // Resist slightly — use 0.6 factor for rubber-band feel
      const offset=dy*0.6;
      detail.style.transform='translateY('+offset+'px)';
      detail.style.opacity=Math.max(0.3,1-offset/300);
      e.preventDefault();
    }
  }
  function onEnd(){
    if(!dragging)return;
    dragging=false;
    const dy=(curY-startY)*0.6;
    const detail=$('constDetail');
    detail.style.transition='';
    detail.style.opacity='';
    if(dy>60){
      hideConstDetail();
    }else{
      detail.style.transform='';
    }
  }
  setTimeout(()=>{
    const detail=$('constDetail');
    if(!detail)return;
    detail.addEventListener('touchstart',onStart,{passive:true});
    detail.addEventListener('touchmove',onMove,{passive:false});
    detail.addEventListener('touchend',onEnd);
  },500);
})();

// ── Selfie zoom / gallery ──
let _selfieZoomData={selfies:[],idx:0,nodeId:null,holdTimer:null};
function openSelfieZoom(idx,nodeId){
  const node=constState.selectedNode;
  if(!node)return;
  const selfies=node.allSelfies||(node.lastSelfie?[{url:node.lastSelfie,userId:'',relationId:'',date:0}]:[]);
  if(!selfies.length)return;
  _selfieZoomData={selfies,idx:Math.min(idx,selfies.length-1),nodeId};
  const zoom=$('selfieZoom');
  $('selfieZoomImg').src=selfies[_selfieZoomData.idx].url;
  zoom.classList.remove('hold-active');
  zoom.style.display='flex';
  requestAnimationFrame(()=>zoom.classList.add('visible'));
  // Long press to show delete
  const img=$('selfieZoomImg');
  img.addEventListener('pointerdown',selfieHoldStart);
  img.addEventListener('pointerup',selfieHoldEnd);
  img.addEventListener('pointercancel',selfieHoldEnd);
}
function selfieHoldStart(e){
  _selfieZoomData.holdTimer=setTimeout(()=>{
    $('selfieZoom').classList.add('hold-active');
    haptic&&haptic([40]);
  },600);
}
function selfieHoldEnd(){
  if(_selfieZoomData.holdTimer){clearTimeout(_selfieZoomData.holdTimer);_selfieZoomData.holdTimer=null}
}
function closeSelfieZoom(){
  const zoom=$('selfieZoom');
  zoom.classList.remove('visible','hold-active');
  setTimeout(()=>{zoom.style.display='none'},250);
  const img=$('selfieZoomImg');
  img.removeEventListener('pointerdown',selfieHoldStart);
  img.removeEventListener('pointerup',selfieHoldEnd);
  img.removeEventListener('pointercancel',selfieHoldEnd);
}
async function deleteSelfieFromZoom(){
  const s=_selfieZoomData.selfies[_selfieZoomData.idx];
  if(!s||!s.relationId)return;
  if(!confirm('Apagar esta foto?'))return;
  try{
    await fetch('/api/selfie/'+s.relationId+'/'+s.userId,{method:'DELETE'});
    showToast('Foto apagada');
    closeSelfieZoom();
    // Refresh constellation
    if(constState.selectedNode)showConstDetail(constState.selectedNode);
  }catch(e){showToast('Erro ao apagar')}
}

// ── Toggle reveal (on/off) ──
async function toggleMyReveal(partnerId,reveal){
  try{
    if(reveal){
      await revealFromConstellation(partnerId);
    }else{
      // Unreveal — remove canSee
      await fetch('/api/reveal/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,partnerId,reveal:false})});
      showToast('Identidade ocultada');
      // Refresh node
      reloadConstellation();
    }
  }catch(e){showToast('Erro: '+e.message)}
}
function reloadConstellation(){
  fetch('/api/constellation/'+state.userId).then(r=>r.json()).then(d=>{
    if(d.nodes)constState.nodes=d.nodes;
    const sel=constState.selectedNode;
    if(sel){
      const updated=d.nodes.find(n=>n.id===sel.id);
      if(updated)showConstDetail(updated);
    }
  }).catch(()=>{});
}

function constTipAction(nodeId){
  const rid=nodeId||window._constDetailNodeId;
  if(rid){hideConstDetail();showTipScreen(rid)}
}
// ═══ NOTIFICATION PANEL ═══
function toggleNotifPanel(){
  const panel=$('notifPanel');
  if(panel.classList.contains('visible')){
    panel.classList.remove('visible');
  }else{
    // Clear badge immediately when opening
    const badge=$('constNotifBadge');
    if(badge){badge.textContent='0';badge.classList.add('hidden')}
    panel.classList.add('visible');
    loadNotifications();
  }
}
async function loadNotifications(){
  const list=$('notifList');
  list.innerHTML='<div class="notif-empty" style="opacity:.5">Carregando...</div>';
  try{
    const data=await(await fetch('/api/notifications/'+state.userId)).json();
    const notifs=data.notifications||[];
    if(!notifs.length){list.innerHTML='<div class="notif-empty"><div style="font-size:1.8rem;margin-bottom:.5rem;opacity:.4">🔕</div>Nenhuma atividade ainda<div style="font-size:.65rem;color:var(--t3);margin-top:.3rem;opacity:.5">Curtas, estrelas e revelações aparecem aqui</div></div>';return}
    // Mark as seen on server
    fetch('/api/notifications/seen',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})}).catch(()=>{});
    let html='';
    let lastDateLabel='';
    notifs.forEach(n=>{
      const name=n.realName||n.nickname||'Alguém';
      const photo=n.profilePhoto;
      const icoHtml=photo
        ?'<div class="notif-ico" style="background:'+(n.color||'var(--ac)')+'"><img src="'+esc(photo)+'" alt=""></div>'
        :'<div class="notif-ico" style="background:'+(n.color||'var(--ac)')+'">'+esc((n.nickname||'?').slice(0,2).toUpperCase())+'</div>';
      let text='',icon='';
      if(n.type==='like'){icon='❤️';text='<strong>'+esc(name)+'</strong> curtiu você'}
      else if(n.type==='star'){icon='⭐';text='<strong>'+esc(name)+'</strong> te deu uma estrela'}
      else if(n.type==='friend-star'){icon='✨';text='<strong>'+esc(name)+'</strong> ganhou uma estrela'}
      else if(n.type==='network-star'){icon='✨';text='<strong>'+esc(name)+'</strong> ganhou uma estrela'}
      else if(n.type==='reveal-request'){icon='👁';text='<strong>'+esc(name)+'</strong> pediu seu ID'}
      else if(n.type==='identity-revealed'){icon='🪪';text='<strong>'+esc(name)+'</strong> revelou o ID pra você'}
      // Better timestamp formatting
      const ts=n.timestamp;
      let timeStr='';
      if(ts&&ts>0){
        const d=new Date(ts);
        const now=new Date();
        const diff=now-d;
        if(diff<0)timeStr='agora';
        else if(diff<60000)timeStr='agora';
        else if(diff<3600000)timeStr=Math.floor(diff/60000)+' min';
        else if(diff<86400000)timeStr=Math.floor(diff/3600000)+'h atrás';
        else if(diff<172800000)timeStr='ontem';
        else if(diff<604800000)timeStr=Math.floor(diff/86400000)+' dias';
        else{const dd=String(d.getDate()).padStart(2,'0');const mm=String(d.getMonth()+1).padStart(2,'0');timeStr=dd+'/'+mm}
        // Date section labels
        let dateLabel='';
        if(diff<86400000)dateLabel='Hoje';
        else if(diff<172800000)dateLabel='Ontem';
        else if(diff<604800000)dateLabel='Esta semana';
        else dateLabel='Anteriores';
        if(dateLabel!==lastDateLabel){
          html+='<div style="font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;padding:.6rem 1rem .2rem;font-weight:600;opacity:.5">'+dateLabel+'</div>';
          lastDateLabel=dateLabel;
        }
      }
      const unseenDot=n.seen?'':'<div style="width:6px;height:6px;border-radius:50%;background:#3b82f6;flex-shrink:0;margin-left:4px"></div>';
      const clickAction=n.fromId?'onclick="navigateToConstNode(\''+esc(n.fromId)+'\')" style="cursor:pointer"':'';
      const bg=n.seen?'':'background:rgba(59,130,246,.04);';
      html+='<div class="notif-item" '+clickAction+' style="'+bg+'">'+icoHtml+'<div class="notif-content"><div class="notif-text">'+icon+' '+text+'</div>'+(timeStr?'<div class="notif-time">'+timeStr+'</div>':'')+'</div>'+unseenDot+'</div>';
    });
    list.innerHTML=html;
    // Update badge to 0 (just seen them)
    const badge=$('constNotifBadge');
    if(badge){badge.textContent='0';badge.classList.add('hidden')}
  }catch(e){
    list.innerHTML='<div class="notif-empty">Erro ao carregar</div>';
  }
}
// Load notif count when constellation opens — only UNSEEN
function updateNotifBadge(){
  if(!state.userId)return;
  fetch('/api/notifications/'+state.userId).then(r=>r.json()).then(data=>{
    const count=data.unseenCount||0;
    const badge=$('constNotifBadge');
    if(badge){badge.textContent=count;badge.classList.toggle('hidden',count===0)}
  }).catch(()=>{});
}

// ═══ NETWORK BADGE (new connections on rede icon) ═══
function updateNetworkBadge(){
  if(!state.userId)return;
  fetch('/api/network/new-count/'+state.userId).then(r=>r.json()).then(data=>{
    const count=data.newCount||0;
    const badge=$('networkBadge');
    if(badge){badge.textContent=count;badge.classList.toggle('hidden',count===0)}
  }).catch(()=>{});
}

function openChatFromConst(nodeId){
  hideConstDetail();
  // Find active relation with this user
  fetch('/api/relations/'+state.userId).then(r=>r.json()).then(rels=>{
    const rel=rels.find(r=>r.partnerId===nodeId&&r.expiresAt>Date.now());
    if(rel){showScreen('chat');loadChat(rel.id,rel.partnerId,rel.partnerName,rel.partnerColor)}
    else showToast('Conexão expirada');
  }).catch(()=>showToast('Erro ao abrir chat'));
}
function navigateToConstNode(nodeId){
  toggleNotifPanel();
  const node=constState.nodes.find(n=>n.id===nodeId);
  if(node){
    // Center camera on this node
    constState.cam.x=-node.x3d;constState.cam.y=-node.y3d;
    constState.cam.zoom=Math.max(constState.cam.zoom,1.2);
    showConstDetail(node);haptic([20]);
  }
}

// ═══ MORE MENU ═══
function showMoreMenu(){
  const existing=document.querySelector('.more-menu-overlay');if(existing){existing.remove();return}
  const overlay=document.createElement('div');
  overlay.className='more-menu-overlay';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
  overlay.innerHTML='<div class="more-menu-sheet"><div class="more-menu-handle"></div><div class="more-menu-grid">'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showRelations()"><div class="mm-ico">💬</div><div class="mm-lbl">Conversas</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showBoardingPass()"><div class="mm-ico">🪪</div><div class="mm-lbl">ID</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showPrestadorRegister()"><div class="mm-ico">💼</div><div class="mm-lbl">Prestador</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showManual()"><div class="mm-ico">❓</div><div class="mm-lbl">Tutorial</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();window.open(\'/site\',\'_blank\')"><div class="mm-ico">🌐</div><div class="mm-lbl">Sobre o Touch</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();window.open(\'/termos\',\'_blank\')"><div class="mm-ico">📜</div><div class="mm-lbl">Termos de Uso</div></div>'
    +(state.userIsAdmin?'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showVerificationPanel()"><div class="mm-ico" style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800">✓</div><div class="mm-lbl">Verificações</div></div>':'')
    +'</div></div>';
  document.body.appendChild(overlay);
}

// ═══ ENCOUNTER LOG (individual touches) ═══
let _elogData=[];let _elogFilter='all';
function filterElog(filter,btn){
  _elogFilter=filter;
  if(btn){document.querySelectorAll('.elog-filter').forEach(f=>f.classList.remove('active'));btn.classList.add('active')}
  renderElogList(_elogData);
}
function renderElogList(data){
  const list=$('elogList');
  if(!data||!data.length){list.innerHTML='<div class="elog-empty">Nenhum encontro ainda.<br>Toque em alguém para começar!</div>';return}
  let filtered=data;
  if(_elogFilter==='people')filtered=data.filter(e=>e.type!=='service'&&e.type!=='checkin'&&!(e.tipAmount&&e.tipStatus==='approved'));
  else if(_elogFilter==='service')filtered=data.filter(e=>e.type==='service'||e.type==='checkin');
  else if(_elogFilter==='payments')filtered=data.filter(e=>e.tipAmount&&e.tipStatus==='approved');
  if(!filtered.length){list.innerHTML='<div class="elog-empty">Nenhum item nesta categoria.</div>';return}
  const myCanSee2=state.revealedIds||{};
  let html='';let lastDateLabel='';
  filtered.forEach(enc=>{
    const dt=new Date(enc.timestamp);
    const dateLabel=dt.toLocaleDateString('pt-BR',{weekday:'short',day:'numeric',month:'short'});
    if(dateLabel!==lastDateLabel){html+='<div class="elog-date-label">'+dateLabel+'</div>';lastDateLabel=dateLabel}
    const revealed=!!(enc.profilePhoto||myCanSee2[enc.with]);
    const revData=myCanSee2[enc.with];
    const displayName=revealed?(enc.realName||revData?.realName||enc.withName):enc.withName;
    const photo=revealed?(enc.profilePhoto||revData?.profilePhoto||null):null;
    const timeStr=dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    const typeLabel=enc.type==='service'?'serviço':(enc.type==='checkin'?'checkin':(enc.type==='digital'?'digital':'touch'));
    const hasTip=enc.tipAmount&&enc.tipStatus==='approved';
    html+='<div class="elog-item" data-ts="'+enc.timestamp+'">';
    html+='<div class="elog-delete" onclick="event.stopPropagation();deleteEncounter(this.parentElement,'+enc.timestamp+')"><svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg></div>';
    html+='<div class="elog-item-inner">';
    const encVerified=!!enc.verified;
    if(photo){
      let avHtml='<div class="elog-avatar" style="background:'+(enc.withColor||'var(--ac)')+';overflow:hidden"><img src="'+esc(photo)+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>';
      html+=encVerified?'<div class="verified-wrap">'+avHtml+'<div class="verified-badge verified-badge-sm">'+VERIFIED_SVG+'</div></div>':avHtml;
    }else{
      let avHtml='<div class="elog-avatar" style="background:none;overflow:visible">'+ANON_AVATAR_SVG+'</div>';
      html+=encVerified?'<div class="verified-wrap">'+avHtml+'<div class="verified-badge verified-badge-sm">'+VERIFIED_SVG+'</div></div>':avHtml;
    }
    html+='<div style="flex:1;min-width:0">';
    html+='<div class="elog-name">'+esc(displayName)+(encVerified?' <span style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:.55rem;font-weight:800">✓</span>':'')+'</div>';
    html+='<div class="elog-meta">';
    html+='<span style="opacity:.7">'+timeStr+'</span>';
    html+='<span style="opacity:.5">·</span>';
    html+='<span style="opacity:.5">'+typeLabel+'</span>';
    if(enc.points)html+='<span style="color:var(--ac);font-weight:600">+'+enc.points+'</span>';
    const canTip=enc.type==='service'||enc.type==='checkin';
    if(hasTip)html+='<span class="elog-tip-tag">R$'+enc.tipAmount.toFixed(0)+'</span>';
    else if(canTip)html+='<button class="elog-tip-btn" onclick="event.stopPropagation();showTipScreen(\''+esc(enc.with)+'\')">Gorjeta</button>';
    html+='</div></div>';
    html+='</div></div>';
  });
  list.innerHTML=html;
  initElogSwipe();
}

async function showEncounterLog(){
  haptic([30]);
  showScreen('encounterLog');
  _elogFilter='all';
  document.querySelectorAll('.elog-filter').forEach(f=>f.classList.remove('active'));
  const firstFilter=document.querySelector('.elog-filter');if(firstFilter)firstFilter.classList.add('active');
  const list=$('elogList');
  list.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3)">Carregando...</div>';
  try{
    const data=await(await fetch('/api/encounters/'+state.userId)).json();
    _elogData=data||[];
    renderElogList(_elogData);
  }catch(e){list.innerHTML='<div class="elog-empty">Erro ao carregar histórico.</div>'}
}
function initElogSwipe(){
  const items=document.querySelectorAll('.elog-item');
  items.forEach(item=>{
    let startX=0,startY=0,dx=0,isHorizontal=null;
    const inner=item.querySelector('.elog-item-inner');
    if(!inner)return;
    inner.addEventListener('touchstart',e=>{
      const t=e.touches[0];startX=t.clientX;startY=t.clientY;dx=0;isHorizontal=null;
      inner.style.transition='none';
      // Close any other open items
      document.querySelectorAll('.elog-item-inner').forEach(el=>{
        if(el!==inner&&el.style.transform&&el.style.transform!=='translateX(0px)'){
          el.style.transition='transform .2s ease';el.style.transform='translateX(0)';
        }
      });
    },{passive:true});
    inner.addEventListener('touchmove',e=>{
      const t=e.touches[0];
      dx=t.clientX-startX;
      const dy=t.clientY-startY;
      // Decide direction on first significant move
      if(isHorizontal===null&&(Math.abs(dx)>8||Math.abs(dy)>8)){
        isHorizontal=Math.abs(dx)>Math.abs(dy);
      }
      if(!isHorizontal)return; // let vertical scroll happen
      e.preventDefault();
      if(dx<0){
        inner.style.transform='translateX('+Math.max(dx,-60)+'px)';
      }else{
        inner.style.transform='translateX('+Math.min(dx,0)+'px)';
      }
    },{passive:false});
    inner.addEventListener('touchend',()=>{
      inner.style.transition='transform .2s cubic-bezier(.25,.46,.45,.94)';
      if(isHorizontal&&dx<-30){
        inner.style.transform='translateX(-52px)';
      }else{
        inner.style.transform='translateX(0)';
      }
      isHorizontal=null;
    });
  });
}
async function deleteEncounter(el,timestamp){
  haptic([20]);
  try{
    await fetch('/api/encounters/'+state.userId+'/'+timestamp,{method:'DELETE'});
    el.style.transition='all .3s ease';el.style.opacity='0';el.style.maxHeight='0';el.style.padding='0';el.style.margin='0';el.style.overflow='hidden';
    setTimeout(()=>el.remove(),350);
  }catch(e){showToast('Erro ao apagar')}
}

// ═══ COMPLETE PROFILE ═══
let cpPhotoData=null;
async function openCompleteProfile(){
  haptic([30]);
  showScreen('completeProfile');
  // Update email/face/doc cards
  const emailVerified=!!(fbUser&&fbUser.emailVerified);
  const emailCard=$('cpEmailCard');
  if(emailCard){
    emailCard.classList.toggle('active',emailVerified);
    $('cpEmailStatus').textContent=emailVerified?'✓ verificado':'verificar';
    $('cpEmailStatus').style.color=emailVerified?'#22c55e':'';
  }
  const hasFace=!!state.userFaceEnrolled;
  const hasDoc=!!state.userDocVerified;
  const faceCard=$('cpFaceCard'),docCard=$('cpDocCard');
  if(faceCard){faceCard.classList.toggle('active',hasFace);$('cpFaceStatus').textContent=hasFace?'✓ ativo':'configurar';$('cpFaceStatus').style.color=hasFace?'#06b6d4':''}
  if(docCard){docCard.classList.toggle('active-doc',hasDoc);$('cpDocStatus').textContent=hasDoc?'✓ enviado':'verificar';$('cpDocStatus').style.color=hasDoc?'#a855f7':''}
  // Load existing data
  try{
    const d=await(await fetch('/api/myprofile/'+state.userId)).json();
    if(d.nickname)$('cpNickname').value=d.nickname;
    if(d.realName)$('cpRealName').value=d.realName;
    if(d.bio)$('cpBio').value=d.bio;
    if(d.phone)$('cpPhone').value=d.phone;
    if(d.email)$('cpEmail').value=d.email;
    if(d.cpf)$('cpCpf').value=d.cpf;
    if(d.instagram)$('cpInstagram').value=d.instagram;
    if(d.tiktok)$('cpTiktok').value=d.tiktok;
    if(d.twitter)$('cpTwitter').value=d.twitter;
    // Privacy toggles
    const priv=d.privacy||{};
    setCpPriv('Instagram',priv.instagram!==false);
    setCpPriv('Tiktok',priv.tiktok!==false);
    setCpPriv('Twitter',priv.twitter!==false);
    setCpPriv('Phone',priv.phone!==false);
    const _cpPhoto=d.profilePhoto||d.photoURL||null;
    if(_cpPhoto){
      cpPhotoData=_cpPhoto;
      $('cpPhotoPreview').innerHTML='<img src="'+_cpPhoto+'" alt="">';
    }
    // Load accessory selector
    state._selectedAccessory=d.avatarAccessory||null;
    renderAccessoryGrid(d.isTop1?'top1':d.isSubscriber?'plus':'free');
    // Load profession, sports, hobbies
    if(d.profession)$('cpProfession').value=d.profession;
    state._selectedSports=(d.sports||[]).slice(0,2);
    state._selectedHobbies=(d.hobbies||[]).slice(0,2);
    renderTagGrid('cpSportsGrid',SPORTS_LIST,state._selectedSports,2,'_selectedSports');
    renderTagGrid('cpHobbiesGrid',HOBBIES_LIST,state._selectedHobbies,2,'_selectedHobbies');
  }catch(e){}
}
// ═══ ACCESSORY SELECTOR ═══
function renderAccessoryGrid(userTier){
  const grid=$('cpAccessoryGrid');
  const lock=$('cpAccessoryLock');
  if(!grid)return;
  const allowed=getAllowedAccessories(userTier);
  const hasAccess=allowed.length>0;
  if(lock)lock.style.display=hasAccess?'none':'block';
  let html='';
  // "None" option
  html+='<div class="acc-option'+((!state._selectedAccessory)?' acc-selected':'')+'" data-acc="" onclick="selectAccessory(null,this)" style="width:52px;height:52px;border-radius:50%;border:2px solid '+((!state._selectedAccessory)?'#8b5cf6':'rgba(255,255,255,.1)')+';display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;background:rgba(26,26,46,.8);transition:all .2s">'
    +ANON_AVATAR_SVG+'</div>';
  // All accessories
  ACCESSORY_LIST.forEach(key=>{
    const acc=AVATAR_ACCESSORIES[key];
    const isSelected=state._selectedAccessory===key;
    const isLocked=!allowed.includes(key);
    const tierColor=acc.tier==='top1'?'#fbbf24':'#8b5cf6';
    const borderColor=isSelected?tierColor:'rgba(255,255,255,.1)';
    html+='<div class="acc-option'+(isSelected?' acc-selected':'')+(isLocked?' acc-locked':'')+'" data-acc="'+key+'" onclick="'+(isLocked?'showToast(\'Desbloqueie com '+(acc.tier==='top1'?'Top 1':'Touch Plus')+'!\')':'selectAccessory(\''+key+'\',this)')+'" style="width:52px;height:52px;border-radius:50%;border:2px solid '+borderColor+';display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:visible;background:rgba(26,26,46,.8);transition:all .2s;'+(isLocked?'opacity:.35;filter:grayscale(1)':'')+'" title="'+esc(acc.name)+'">'
      +'<div style="width:100%;height:100%;position:relative;overflow:visible">'+ANON_AVATAR_SVG
      +'<div style="position:absolute;top:0;left:0;width:100%;height:100%">'+acc.svg+'</div></div>';
    if(isLocked){
      html+='<div style="position:absolute;bottom:-2px;right:-2px;width:16px;height:16px;background:'+tierColor+';border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;border:1.5px solid rgba(0,0,0,.5)">🔒</div>';
    }
    html+='</div>';
  });
  grid.innerHTML=html;
}
function selectAccessory(key,el){
  state._selectedAccessory=key;
  // Update selection visual
  const grid=$('cpAccessoryGrid');
  if(!grid)return;
  grid.querySelectorAll('.acc-option').forEach(o=>{
    o.classList.remove('acc-selected');
    o.style.borderColor='rgba(255,255,255,.1)';
  });
  if(el){
    el.classList.add('acc-selected');
    const acc=AVATAR_ACCESSORIES[key];
    el.style.borderColor=acc?(acc.tier==='top1'?'#fbbf24':'#8b5cf6'):'#8b5cf6';
  }
  haptic([15]);
}
// ═══ PROFILE TAGS — Sports & Hobbies ═══
const SPORTS_LIST=['Futebol','Basquete','Vôlei','Natação','Corrida','Musculação','Yoga','Surf','Skate','Tênis','Artes Marciais','Ciclismo','Dança','Crossfit','Escalada','Trilha'];
const HOBBIES_LIST=['Música','Cinema','Fotografia','Games','Leitura','Culinária','Viagem','Arte','Podcast','Tecnologia','Moda','Natureza','Animais','Meditação','Festa','Stand-up'];
state._selectedSports=[];
state._selectedHobbies=[];
function renderTagGrid(containerId,items,selected,max,stateKey){
  const grid=$(containerId);if(!grid)return;
  grid.innerHTML=items.map(item=>{
    const sel=selected.includes(item);
    const full=selected.length>=max&&!sel;
    return '<span class="cp-tag'+(sel?' selected':'')+(full?' disabled':'')+'" onclick="toggleTag(\''+stateKey+'\',\''+item+'\','+max+',\''+containerId+'\')">'+item+'</span>';
  }).join('');
}
function toggleTag(stateKey,item,max,containerId){
  const arr=state[stateKey];
  const idx=arr.indexOf(item);
  if(idx>=0){arr.splice(idx,1)}
  else{if(arr.length>=max)return showToast('Máximo '+max+' opções');arr.push(item)}
  const items=stateKey==='_selectedSports'?SPORTS_LIST:HOBBIES_LIST;
  renderTagGrid(containerId,items,arr,max,stateKey);
  haptic([10]);
}
function setCpPriv(field,isOn){
  const btn=$('cpPriv'+field);if(!btn)return;
  btn.classList.toggle('priv-on',isOn);btn.classList.toggle('priv-off',!isOn);
  btn.innerHTML=isOn?'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5" stroke-linecap="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'
    :'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
}
function toggleCpPriv(field){
  const btn=$('cpPriv'+field);if(!btn)return;
  const isOn=btn.classList.contains('priv-on');
  setCpPriv(field,!isOn);haptic([15]);
}
function handleProfilePhoto(input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  if(file.size>5*1024*1024)return showToast('Foto muito grande (máx 5MB)');
  const reader=new FileReader();
  reader.onload=function(e){
    // Compress
    const img=new Image();
    img.onload=function(){
      const canvas=document.createElement('canvas');
      const max=400;
      let w=img.width,h=img.height;
      if(w>max||h>max){if(w>h){h=h*(max/w);w=max}else{w=w*(max/h);h=max}}
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      cpPhotoData=canvas.toDataURL('image/jpeg',0.7);
      $('cpPhotoPreview').innerHTML='<img src="'+cpPhotoData+'" alt="">';
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}
async function saveCompleteProfile(){
  const nicknameVal=$('cpNickname').value.trim();
  const realNameVal=$('cpRealName').value.trim();
  if(realNameVal&&nicknameVal&&realNameVal.toLowerCase()===nicknameVal.toLowerCase()){
    return showToast('Seu nome real precisa ser diferente do nickname!');
  }
  if(nicknameVal&&nicknameVal.length<2)return showToast('Apelido precisa ter pelo menos 2 caracteres.');
  const privBtn=f=>$('cpPriv'+f);
  const data={
    userId:state.userId,
    nickname:nicknameVal||undefined,
    realName:realNameVal,
    bio:$('cpBio').value.trim(),
    profession:$('cpProfession')?$('cpProfession').value.trim():'',
    sports:state._selectedSports||[],
    hobbies:state._selectedHobbies||[],
    phone:$('cpPhone').value.trim(),
    email:$('cpEmail').value.trim(),
    cpf:$('cpCpf').value.trim(),
    instagram:$('cpInstagram').value.trim(),
    tiktok:$('cpTiktok').value.trim(),
    twitter:$('cpTwitter').value.trim(),
    profilePhoto:cpPhotoData||'',
    avatarAccessory:state._selectedAccessory||null,
    privacy:{
      instagram:privBtn('Instagram')?privBtn('Instagram').classList.contains('priv-on'):true,
      tiktok:privBtn('Tiktok')?privBtn('Tiktok').classList.contains('priv-on'):true,
      twitter:privBtn('Twitter')?privBtn('Twitter').classList.contains('priv-on'):true,
      phone:privBtn('Phone')?privBtn('Phone').classList.contains('priv-on'):false
    }
  };
  try{
    const r=await fetch('/api/profile/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    if(data.profilePhoto){state.userPhoto=data.profilePhoto;localStorage.setItem('touch_userPhoto',data.profilePhoto);constState._myImgLoaded=false}
    if(nicknameVal){state.userNickname=nicknameVal;state.userName=nicknameVal;localStorage.setItem('touch_userName',nicknameVal)}
    showToast('Salvo!');haptic([40,20,40]);
    goHome();
  }catch(e){showToast('Erro ao salvar.')}
}

// ═══ REVELAR ID — DUAS AÇÕES ═══
// 1. "Me revelar" = direto, sem aceite. Eu mostro minha identidade.
// 2. "Pedir pra revelar" = solicito que o outro se revele. Precisa aceite.
if(!state.pendingReveals)state.pendingReveals={};

// ACTION 1: Me revelar (direto, imediato)
async function revealMyself(targetUserId){
  if(!state.userId)return;
  try{
    const r=await fetch('/api/identity/reveal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,targetUserId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([60,30,60]);
    showToast('Você se revelou! 🪪');
    updateChatIdBar();
    refreshRelations();
    const cBtn=$('constRevealIdBtn');if(cBtn){cBtn.textContent='✅ Revelado';cBtn.disabled=true;cBtn.style.opacity='.6'}
  }catch(e){showToast('Complete seu perfil antes de se revelar.')}
}

// ACTION 2: Solicitar que o outro se revele (precisa aceite)
async function requestReveal(targetUserId){
  if(!state.userId)return;
  if(state.pendingReveals[targetUserId]==='sent')return showToast('Pedido já enviado. Aguardando...');
  try{
    const r=await fetch('/api/identity/request-reveal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,targetUserId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([40,20,40]);
    state.pendingReveals[targetUserId]='sent';
    updateChatIdBar();
    showToast('Pedido enviado!');
  }catch(e){showToast('Erro ao solicitar.')}
}
function revealFromConstellation(nodeId){revealMyself(nodeId)}
function requestRevealFromConstellation(nodeId){requestReveal(nodeId)}

// Accept: "Aceito me revelar" (eu fui pedido pra me revelar, e aceito)
async function acceptRevealRequest(fromUserId){
  try{
    const r=await fetch('/api/identity/reveal-accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,fromUserId})});
    const d=await r.json();
    if(d.error){showToast(d.error);return}
    haptic([80,40,80,40,80]);
    delete state.pendingReveals[fromUserId];
    showToast('Você se revelou! 🪪');
    updateChatIdBar();
  }catch(e){showToast('Erro ao aceitar.')}
}
async function declineRevealRequest(fromUserId){
  try{await fetch('/api/identity/reveal-decline',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,fromUserId})})}catch(e){}
  delete state.pendingReveals[fromUserId];
  showToast('Pedido recusado.');
  updateChatIdBar();
}

// Like toggle — white heart 🤍 → red ❤️
async function toggleLike(targetUserId){
  if(!state.userId||!targetUserId)return;
  try{
    const r=await fetch('/api/like/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,targetUserId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic(d.liked?[50,30,50]:[20]);
    const btn=$('constLikeBtn');
    if(btn){
      const heart=d.liked?'❤️':'🤍';
      btn.innerHTML=heart+(d.count?' '+d.count:'');
      btn.style.background=d.liked?'rgba(255,60,80,.15)':'rgba(255,100,100,.06)';
      btn.style.borderColor=d.liked?'rgba(255,60,80,.3)':'rgba(255,100,100,.15)';
    }
    if(d.liked)showToast('Curtiu! ❤️');
  }catch(e){}
}

// ══ STAR DONATION MODAL (forced — must donate earned star) ══
let _starDonateQueue=[];
let _starModalOpen=false;

function showStarDonateModal(pendingStarId,reason,context){
  _starDonateQueue.push({pendingStarId,reason,context});
  if(!_starModalOpen)_showNextStarModal();
}

function _showNextStarModal(){
  if(_starDonateQueue.length===0){_starModalOpen=false;return;}
  _starModalOpen=true;
  const item=_starDonateQueue.shift();
  const overlay=document.createElement('div');
  overlay.id='starDonateOverlay';
  overlay.style.cssText='position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;padding:1rem;animation:fadeIn .3s ease';
  const reasonText=item.reason==='streak'?'Streak! '+item.context:item.reason==='milestone'?'Marco: '+item.context:'Você ganhou uma estrela!';
  overlay.innerHTML=`
    <div style="background:var(--c2,#1a1a2e);border-radius:20px;padding:1.5rem;width:100%;max-width:380px;max-height:85vh;overflow-y:auto;border:1px solid rgba(251,191,36,.3);box-shadow:0 0 40px rgba(251,191,36,.15)">
      <div style="text-align:center;margin-bottom:1rem">
        <div style="font-size:2.5rem;margin-bottom:.5rem;animation:pulse 1.5s ease infinite">⭐</div>
        <div style="font-size:1rem;font-weight:700;color:#fbbf24;margin-bottom:.3rem">Você ganhou uma estrela!</div>
        <div style="font-size:.72rem;color:var(--t2,#aaa)">${reasonText}</div>
        <div style="font-size:.65rem;color:var(--t3,#777);margin-top:.4rem">Escolha alguém para presentear — a estrela deve ser doada agora!</div>
      </div>
      <div style="position:relative;margin-bottom:.8rem">
        <input id="starSearchInput" type="text" placeholder="Buscar por nickname..." autocomplete="off" style="width:100%;box-sizing:border-box;padding:.6rem .8rem .6rem 2rem;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:12px;color:#fff;font-size:.8rem;outline:none">
        <div style="position:absolute;left:.6rem;top:50%;transform:translateY(-50%);font-size:.75rem;opacity:.4">🔍</div>
      </div>
      <div id="starSearchResults" style="min-height:120px;max-height:300px;overflow-y:auto"></div>
    </div>`;
  document.body.appendChild(overlay);
  const inp=document.getElementById('starSearchInput');
  const res=document.getElementById('starSearchResults');
  let searchTimeout;
  inp.addEventListener('input',()=>{
    clearTimeout(searchTimeout);
    searchTimeout=setTimeout(async()=>{
      const q=inp.value.trim();
      if(q.length<1){res.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3,#777);font-size:.7rem">Digite um nickname para buscar</div>';return;}
      try{
        const r2=await fetch('/api/star/search-people/'+state.userId+'?q='+encodeURIComponent(q));
        const d=await r2.json();
        if(!d.results||d.results.length===0){res.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3,#777);font-size:.7rem">Nenhum resultado para "'+q+'"</div>';return;}
        res.innerHTML=d.results.map(p=>`
          <div onclick="confirmStarDonate('${item.pendingStarId}','${p.id}','${(p.nickname||'').replace(/'/g,"\\'")}')" style="display:flex;align-items:center;gap:.6rem;padding:.55rem .6rem;margin-bottom:.3rem;background:rgba(255,255,255,.04);border-radius:12px;cursor:pointer;transition:background .2s" onmouseover="this.style.background='rgba(251,191,36,.1)'" onmouseout="this.style.background='rgba(255,255,255,.04)'">
            <div style="width:36px;height:36px;border-radius:50%;background:${p.color||'#666'};display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:#fff;flex-shrink:0">${(p.nickname||'?').slice(0,2).toUpperCase()}</div>
            <div style="flex:1;min-width:0">
              <div style="font-size:.78rem;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.nickname||'?'} ${p.verified?'<span style="color:#3b82f6;font-size:.6rem">✓</span>':''}</div>
              <div style="font-size:.6rem;color:var(--t3,#777)">⭐ ${p.stars||0} estrelas</div>
            </div>
            <div style="font-size:.65rem;color:#fbbf24;font-weight:600">Doar ⭐</div>
          </div>`).join('');
      }catch(e){res.innerHTML='<div style="text-align:center;padding:1rem;color:#f87171;font-size:.7rem">Erro na busca</div>';}
    },300);
  });
  // Show recent connections as suggestions
  _loadStarSuggestions(res,item.pendingStarId);
  setTimeout(()=>inp.focus(),300);
}

async function _loadStarSuggestions(container,pendingStarId){
  container.innerHTML='<div style="text-align:center;padding:1rem;color:var(--t3,#777);font-size:.65rem">Carregando sugestões...</div>';
  try{
    const r=await fetch('/api/constellation/'+state.userId);
    const d=await r.json();
    const nodes=(d.nodes||[]).filter(n=>n.id!==state.userId).slice(0,10);
    if(nodes.length===0){container.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3,#777);font-size:.7rem">Busque por nickname acima</div>';return;}
    container.innerHTML='<div style="font-size:.6rem;color:var(--t3,#777);padding:0 .3rem .4rem;font-weight:600">Suas conexões:</div>'+nodes.map(p=>`
      <div onclick="confirmStarDonate('${pendingStarId}','${p.id}','${(p.nickname||'').replace(/'/g,"\\'")}')" style="display:flex;align-items:center;gap:.6rem;padding:.55rem .6rem;margin-bottom:.3rem;background:rgba(255,255,255,.04);border-radius:12px;cursor:pointer;transition:background .2s" onmouseover="this.style.background='rgba(251,191,36,.1)'" onmouseout="this.style.background='rgba(255,255,255,.04)'">
        <div style="width:36px;height:36px;border-radius:50%;background:${p.color||'#666'};display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:#fff;flex-shrink:0">${(p.nickname||'?').slice(0,2).toUpperCase()}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:.78rem;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.nickname||'?'} ${p.verified?'<span style="color:#3b82f6;font-size:.6rem">✓</span>':''}</div>
          <div style="font-size:.6rem;color:var(--t3,#777)">⭐ ${p.starsCount||0} estrelas</div>
        </div>
        <div style="font-size:.65rem;color:#fbbf24;font-weight:600">Doar ⭐</div>
      </div>`).join('');
  }catch(e){container.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3,#777);font-size:.7rem">Busque por nickname acima</div>';}
}

async function confirmStarDonate(pendingStarId,targetId,targetName){
  if(!confirm('Doar ⭐ estrela para '+targetName+'?'))return;
  try{
    const r=await fetch('/api/star/donate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({fromUserId:state.userId,toUserId:targetId,pendingStarId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([60,30,60,30,100]);
    showToast('⭐ Estrela doada para '+targetName+'!');
    // Close modal
    const ov=document.getElementById('starDonateOverlay');
    if(ov)ov.remove();
    // Process next pending star if any
    setTimeout(()=>_showNextStarModal(),500);
  }catch(e){showToast('Erro ao doar estrela.');}
}

// Direct donate from constellation detail (transfers a star you have)
async function confirmDonateStar(targetUserId){
  const node=constState.selectedNode;
  const targetName=node?node.nickname:'';
  // Fetch balance + pending
  let bal,pendData;
  try{
    const [bRes,pRes]=await Promise.all([
      fetch('/api/star/balance/'+state.userId),
      fetch('/api/star/pending/'+state.userId)
    ]);
    bal=await bRes.json();
    pendData=await pRes.json();
  }catch(e){return showToast('Erro ao verificar estrelas.')}
  if(!pendData||!pendData.pending)pendData={pending:[],count:0};

  if(bal.available<=0){
    return showToast('Você não tem estrelas para doar. Receba estrelas de outras pessoas ou ganhe por streaks!');
  }
  const targetStars=(node?node.starsCount:0)||0;
  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10100;display:flex;align-items:center;justify-content:center;padding:1rem;animation:fadeIn .2s';
  const box=document.createElement('div');
  box.style.cssText='background:linear-gradient(180deg,rgba(20,16,48,.97),rgba(12,10,30,.99));border:1px solid rgba(251,191,36,.15);border-radius:20px;padding:1.5rem 1.2rem;max-width:320px;width:100%;text-align:center;box-shadow:0 8px 40px rgba(0,0,0,.6),0 0 60px rgba(251,191,36,.08)';

  box.innerHTML=''
    +'<div style="font-size:2.5rem;margin-bottom:.3rem;filter:drop-shadow(0 0 12px rgba(251,191,36,.6))">★</div>'
    +'<div style="font-size:.95rem;font-weight:700;color:#fbbf24;margin-bottom:.8rem;letter-spacing:.02em">Reconhecer com Estrela</div>'
    +'<div style="font-size:.75rem;color:rgba(255,255,255,.75);line-height:1.6;margin-bottom:1rem">'
    +'Na rede, estrelas são o reconhecimento mais valioso que existe. '
    +'Ao doar, você está dizendo que <b style="color:#fff">'+esc(targetName)+'</b> é alguém especial pra você.</div>'
    // Transfer preview
    +'<div style="display:flex;align-items:center;justify-content:center;gap:.6rem;margin-bottom:.8rem;padding:.6rem;background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.12);border-radius:12px">'
      +'<div style="text-align:center">'
        +'<div style="font-size:.6rem;color:rgba(255,255,255,.4);margin-bottom:2px">Você</div>'
        +'<div style="font-size:1.1rem;font-weight:800;color:#fbbf24">'+bal.available+' ★</div>'
        +'<div style="font-size:.55rem;color:rgba(255,255,255,.3);margin-top:1px">→ '+(bal.available-1)+' ★</div>'
      +'</div>'
      +'<div style="color:rgba(251,191,36,.4);font-size:1.2rem">→</div>'
      +'<div style="text-align:center">'
        +'<div style="font-size:.6rem;color:rgba(255,255,255,.4);margin-bottom:2px">'+esc(targetName)+'</div>'
        +'<div style="font-size:1.1rem;font-weight:800;color:#fbbf24">'+targetStars+' ★</div>'
        +'<div style="font-size:.55rem;color:rgba(255,255,255,.3);margin-top:1px">→ '+(targetStars+1)+' ★</div>'
      +'</div>'
    +'</div>'
    // Warning
    +'<div style="font-size:.62rem;color:rgba(247,113,113,.7);margin-bottom:1rem;line-height:1.4">'
    +'Essa ação é irreversível. Só recebe de volta se alguém doar pra você.</div>'
    // Buttons
    +'<div style="display:flex;gap:.5rem">'
    +'<button id="cdsCancel" style="flex:1;padding:.55rem;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;color:rgba(255,255,255,.5);font-size:.72rem;font-weight:600;font-family:inherit;cursor:pointer">Cancelar</button>'
    +'<button id="cdsConfirm" style="flex:1;padding:.55rem;background:linear-gradient(135deg,#fbbf24,#f59e0b);border:none;border-radius:12px;color:#1e1b4b;font-size:.72rem;font-weight:700;font-family:inherit;cursor:pointer;box-shadow:0 2px 12px rgba(251,191,36,.3)">Doar ★</button>'
    +'</div>';
  overlay.appendChild(box);
  document.body.appendChild(overlay);
  overlay.querySelector('#cdsCancel').onclick=()=>{overlay.remove()};
  overlay.querySelector('#cdsConfirm').onclick=async()=>{
    const btn=overlay.querySelector('#cdsConfirm');
    btn.textContent='Doando...';btn.style.opacity='.6';btn.style.pointerEvents='none';
    try{
      const body={fromUserId:state.userId,toUserId:targetUserId};
      // If has pending stars (from streak), use those first
      if(pendData.count>0)body.pendingStarId=pendData.pending[0].id;
      const r=await fetch('/api/star/donate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const d=await r.json();
      if(d.error){overlay.remove();return showToast(d.error)}
      // Success animation
      box.innerHTML='<div id="cdsStarAnim" style="position:relative;height:120px;overflow:hidden;margin-bottom:.5rem"></div>'
        +'<div style="font-size:.95rem;font-weight:700;color:#fbbf24;margin-bottom:.3rem">Estrela doada!</div>'
        +'<div style="font-size:.72rem;color:rgba(255,255,255,.6)">'+esc(targetName)+' agora tem <b style="color:#fbbf24">'+(d.recipientStars||targetStars+1)+' ★</b></div>'
        +(typeof d.donorStarsRemaining==='number'?'<div style="font-size:.6rem;color:rgba(255,255,255,.35);margin-top:.3rem">Suas estrelas: '+d.donorStarsRemaining+' ★</div>':'');
      const animEl=document.getElementById('cdsStarAnim');
      if(animEl){
        for(let i=0;i<8;i++){
          const s=document.createElement('div');
          s.textContent='★';
          s.style.cssText='position:absolute;left:50%;top:50%;font-size:'+(1+Math.random())+'rem;color:#fbbf24;filter:drop-shadow(0 0 8px rgba(251,191,36,.8));opacity:0;transform:translate(-50%,-50%);animation:cdsStarBurst .8s ease-out '+(i*0.08)+'s forwards';
          s.style.setProperty('--cds-x',(Math.random()*120-60)+'px');
          s.style.setProperty('--cds-y',(Math.random()*-80-20)+'px');
          animEl.appendChild(s);
        }
      }
      haptic([60,30,60,30,100]);
      setTimeout(()=>{overlay.remove()},2200);
    }catch(e){overlay.remove();showToast('Erro ao doar estrela.')}
  };
  overlay.onclick=(e)=>{if(e.target===overlay)overlay.remove()};
}

// Buy star with score points (for yourself)
async function buyStarForPerson(targetUserId){
  if(!state.userId||!targetUserId)return;
  try{
    const shop=await(await fetch('/api/star/shop/'+state.userId)).json();
    const cost=shop.giftCost;
    if(shop.spendablePoints<cost)return showToast('Pontos insuficientes. Custo: '+cost+', Disponível: '+shop.spendablePoints);
    if(!confirm('Comprar ★ estrela para essa pessoa?\nCusto: '+cost+' pontos (Disponível: '+shop.spendablePoints+')'))return;
    const r=await fetch('/api/star/buy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,target:targetUserId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([60,30,60,30,100]);
    showToast('★ Estrela comprada! (-'+d.cost+' pts)');
  }catch(e){showToast('Erro ao comprar.')}
}

// Buy star for yourself
async function buyStarSelf(){
  if(!state.userId)return;
  try{
    const shop=await(await fetch('/api/star/shop/'+state.userId)).json();
    const cost=shop.selfCost;
    if(shop.spendablePoints<cost)return showToast('Pontos insuficientes. Custo: '+cost+', Disponível: '+shop.spendablePoints);
    if(!confirm('Comprar ★ estrela para você?\nCusto: '+cost+' pontos (Disponível: '+shop.spendablePoints+')'))return;
    const r=await fetch('/api/star/buy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,target:'self'})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([60,30,60,30,100]);
    showToast('★ Estrela adquirida! (-'+d.cost+' pts)');
  }catch(e){showToast('Erro ao comprar.')}
}

// Render reveal messages in chat
function appendRevealChatCard(msg){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');
  div.className='reveal-chat-card';
  div.id='revealMsg-'+(msg.revealRequestId||msg.id);
  if(msg.type==='reveal-request'){
    const iSent=msg.fromUserId===state.userId;
    const name=msg.fromName||'?';
    const color=msg.fromColor||'var(--ac)';
    const initials=esc(name.slice(0,2).toUpperCase());
    const avatarHtml='<div style="width:42px;height:42px;border-radius:50%;background:'+color+';display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:800;color:#fff">'+initials+'</div>';
    // "request-reveal" = alguém pediu pra eu me revelar
    div.innerHTML='<div class="rcc-header">'
      +'<div class="rcc-icon">🪪</div>'
      +avatarHtml
      +'<div class="rcc-text">'
      +(iSent?'<strong>Você</strong> pediu pra essa pessoa se revelar':'<strong>'+esc(name)+'</strong> pede pra você se revelar')
      +'</div></div>'
      +(iSent
        ?'<div class="rcc-status pending">⏳ Aguardando resposta...</div>'
        :'<div class="rcc-actions" id="rccActions-'+msg.revealRequestId+'">'
        +'<button class="bp" style="flex:1;font-size:.82rem" onclick="acceptRevealRequest(\''+msg.fromUserId+'\')">Me revelar 🪪</button>'
        +'<button class="bs" style="flex:1;font-size:.82rem" onclick="declineRevealRequest(\''+msg.fromUserId+'\')">Agora não</button>'
        +'</div>');
    if(!iSent){
      // If I already revealed to them, show as resolved
      const them=db?undefined:undefined;
      const meRevealed=state.currentRelation&&state.currentRelation.iRevealedToPartner;
      if(meRevealed){
        div.innerHTML=div.innerHTML.replace(/<div class="rcc-actions"[^]*<\/div>$/,'<div class="rcc-status accepted">✅ Você se revelou</div>');
      }
    }
  }else if(msg.type==='reveal-accepted'){
    // UNILATERAL: only one person revealed
    const revealed=msg.revealedUser;
    if(!revealed){div.innerHTML='<div class="rcc-status accepted">✅ Identidade revelada</div>';mc.insertBefore(div,ti);return}
    const iAmRevealer=revealed.id===state.userId;
    const photo=revealed.profilePhoto;
    div.innerHTML='<div class="rcc-revealed">'
      +'<div class="rcc-revealed-title">🪪 '+(iAmRevealer?'Você se revelou!':esc(revealed.realName||revealed.nickname)+' se revelou!')+'</div>'
      +'<div style="display:flex;align-items:center;gap:.8rem;margin:.4rem 0">'
      +(photo?'<img src="'+photo+'" class="rcc-photo" alt="">':'<div class="rcc-photo-placeholder">'+esc((revealed.nickname||'?').slice(0,2).toUpperCase())+'</div>')
      +'<div>'
      +'<div class="rcc-name">'+esc(revealed.realName||revealed.nickname)+'</div>'
      +(revealed.instagram?'<a class="rcc-insta" href="https://instagram.com/'+esc(revealed.instagram.replace(/^@/,''))+'" target="_blank" rel="noopener">📸 @'+esc(revealed.instagram.replace(/^@/,''))+'</a>':'')
      +(revealed.bio?'<div style="font-size:.7rem;color:var(--t3);margin-top:.2rem">'+esc(revealed.bio)+'</div>':'')
      +'</div></div></div>';
  }else if(msg.type==='reveal-declined'){
    div.innerHTML='<div class="rcc-status declined">Pedido de reveal não aceito no momento</div>';
  }
  mc.insertBefore(div,ti);
  if(near)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
}

// Update chat ID bar — two actions: "Me revelar" and "Pedir reveal"
function updateChatIdBar(){
  const idBar=$('chatIdBar');if(!idBar)return;
  const pid=state.currentPartnerId;
  if(!pid){idBar.style.display='none';return}
  const rel=state.currentRelation;
  const iRevealed=!!(rel&&rel.iRevealedToPartner);
  const theyRevealed=!!(state.revealedIds&&state.revealedIds[pid]);
  idBar.style.display='flex';
  const btn=$('revealIdBtn');if(!btn)return;
  const pending=state.pendingReveals[pid];
  // Build two-button layout: Revelar/Esconder ID + Pedir ID/Aguardando
  let html='';
  // Button 1: Revelar/Esconder ID
  if(iRevealed){
    html+='<button class="id-bar-btn reveal" onclick="toggleMyReveal(\''+pid+'\',false)">🪪 Esconder ID</button>';
  }else{
    html+='<button class="id-bar-btn reveal" onclick="revealMyself(\''+pid+'\')">🪪 Revelar ID</button>';
  }
  // Button 2: Pedir ID / Aguardando
  if(theyRevealed){
    html+='<button class="id-bar-btn done" disabled>✅ ID recebido</button>';
  }else if(pending==='sent'){
    html+='<button class="id-bar-btn" disabled style="opacity:.6">⏳ Aguardando</button>';
  }else if(pending==='received'){
    html+='<button class="id-bar-btn request" onclick="acceptRevealRequest(\''+pid+'\')">🪪 Aceitar pedido</button>';
  }else{
    html+='<button class="id-bar-btn request" onclick="requestReveal(\''+pid+'\')">👁 Pedir ID</button>';
  }
  idBar.innerHTML=html;
}

// Sync reveal UI
function syncRevealUI(partnerId,realName,profilePhoto){
  delete state.pendingReveals[partnerId];
  if(!state.revealedIds)state.revealedIds={};
  state.revealedIds[partnerId]={realName,profilePhoto};
  if(state.currentPartnerId===partnerId){
    const chatName=$('chatPartner');
    if(chatName&&realName)chatName.textContent=realName;
    const pNick=state.currentRelation?.partnerName||'';
    const sub=$('chatSub');if(sub)sub.innerHTML='<span style="color:var(--ok)">✓ revelou-se pra você</span>'+(pNick?' · @'+esc(pNick):'');
  }
  if(constState.nodes){
    const cNode=constState.nodes.find(n=>n.id===partnerId);
    if(cNode){
      cNode.partnerRevealedToMe=true;cNode.pendingReveal=null;
      if(realName)cNode.realName=realName;
      if(profilePhoto){cNode.profilePhoto=profilePhoto;cNode._revealed=true;
        // Load image for canvas
        const img=new Image();img.src=profilePhoto;
        cNode._img=img;cNode._imgLoaded=false;img.onload=()=>{cNode._imgLoaded=true};
      }
    }
  }
  updateChatIdBar();
  refreshRelations();
}
function appendSystemMsg(text){
  const box=$('chatMessages');if(!box)return;
  const div=document.createElement('div');
  div.style.cssText='text-align:center;font-size:.7rem;color:var(--ac);padding:.5rem;font-style:italic';
  div.textContent=text;box.appendChild(div);box.scrollTop=box.scrollHeight;
}

// ═══ BOARDING PASS ═══
async function showBoardingPassWithQR(){
  await showBoardingPass();
  // Auto-generate QR code (area is always visible now)
  setTimeout(()=>showTouchQR(),300);
}
async function showBoardingPass(){
  haptic([30]);
  try{
    const d=await fetch('/api/boarding-pass/'+state.userId).then(r=>r.json());
    $('bpName').textContent=d.name;
    const bpColor=d.color||nickColor(d.name||'??');
    const bpInitials=(d.name||'??').slice(0,2).toUpperCase();
    $('bpAvatar').innerHTML=makeAvatar(d.name||'??',bpColor,44,state.userPhoto||null,false,state.userAccessory||null);
    $('bpAvatar').style.background='none';$('bpAvatar').style.overflow='visible';
    const since=new Date(d.memberSince);
    const months=['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];
    $('bpSince').textContent='membro desde '+months[since.getMonth()]+' '+since.getFullYear();
    $('bpScore').textContent=d.score;
    $('bpStars').textContent=d.stars;
    $('bpPeople').textContent=d.uniquePeople;
    $('bpLikes').textContent=d.likesCount||0;
    const tagEl=$('bpTag');if(tagEl)tagEl.textContent=d.topTag?d.topTag.replace('top','TOP '):'—';
    const bpvb=$('bpVerifiedBadge');if(bpvb){if(state.userVerified)bpvb.classList.remove('hidden');else bpvb.classList.add('hidden')}
    loadTouchLink();
    showScreen('boardingPass');
  }catch(e){showToast('Erro ao carregar bilhete.')}
}
function downloadBoardingPass(){
  const card=$('bpCard');
  const c=document.createElement('canvas');c.width=640;c.height=900;
  const ctx=c.getContext('2d');
  // Background
  const grad=ctx.createLinearGradient(0,0,0,900);
  grad.addColorStop(0,'#0c0c18');grad.addColorStop(.5,'#161628');grad.addColorStop(1,'#0c0c18');
  ctx.fillStyle=grad;roundRect(ctx,0,0,640,900,30);ctx.fill();
  // Top accent line
  const acGrad=ctx.createLinearGradient(0,0,640,0);acGrad.addColorStop(0,'#ff6b35');acGrad.addColorStop(.5,'#ff3d71');acGrad.addColorStop(1,'#ff6b35');
  ctx.fillStyle=acGrad;ctx.fillRect(0,0,640,5);
  // Header
  ctx.fillStyle='#ff6b35';ctx.font='bold 16px Inter,sans-serif';ctx.letterSpacing='6px';ctx.fillText('Touch?',30,50);
  ctx.fillStyle='#555568';ctx.font='12px Inter,sans-serif';ctx.letterSpacing='3px';ctx.textAlign='right';ctx.fillText('BOARDING PASS',610,50);ctx.textAlign='left';ctx.letterSpacing='0px';
  // Dashed line
  ctx.setLineDash([6,4]);ctx.strokeStyle='#2a2a3a';ctx.beginPath();ctx.moveTo(20,70);ctx.lineTo(620,70);ctx.stroke();ctx.setLineDash([]);
  // Avatar circle
  const avX=320,avY=160,avR=50;
  ctx.beginPath();ctx.arc(avX,avY,avR+3,0,Math.PI*2);ctx.strokeStyle='#ff6b35';ctx.lineWidth=2;ctx.stroke();
  const bpAv=$('bpAvatar');const avColor=bpAv.style.background||'hsl(200,65%,55%)';
  ctx.beginPath();ctx.arc(avX,avY,avR,0,Math.PI*2);ctx.fillStyle=avColor;ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 32px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(bpAv.textContent||'??',avX,avY);ctx.textBaseline='alphabetic';
  // Name
  ctx.fillStyle='#f5f5f7';ctx.font='bold 28px Inter,sans-serif';ctx.textAlign='center';
  ctx.fillText($('bpName').textContent,320,260);
  // Since
  ctx.fillStyle='#555568';ctx.font='13px Inter,sans-serif';
  ctx.fillText($('bpSince').textContent,320,290);
  // Stats boxes
  const stats=[{n:$('bpScore').textContent,l:'SCORE'},{n:$('bpStars').textContent,l:'ESTRELAS'},{n:$('bpPeople').textContent,l:'PESSOAS'},{n:$('bpTotal').textContent,l:'ENCONTROS'}];
  const sw=120,sy=340;
  stats.forEach((s,i)=>{
    const sx=30+i*(sw+25);
    ctx.fillStyle='rgba(255,107,53,0.08)';roundRect(ctx,sx,sy,sw,90,12);ctx.fill();
    ctx.fillStyle='#ff6b35';ctx.font='bold 36px Inter,sans-serif';ctx.textAlign='center';ctx.fillText(s.n,sx+sw/2,sy+45);
    ctx.fillStyle='#555568';ctx.font='10px Inter,sans-serif';ctx.letterSpacing='2px';ctx.fillText(s.l,sx+sw/2,sy+72);ctx.letterSpacing='0px';
  });
  // Dashed line
  ctx.setLineDash([6,4]);ctx.strokeStyle='#2a2a3a';ctx.beginPath();ctx.moveTo(20,480);ctx.lineTo(620,480);ctx.stroke();ctx.setLineDash([]);
  // Barcode
  for(let i=0;i<60;i++){const bh=15+Math.random()*25,bx=80+i*8;ctx.fillStyle='rgba(85,85,104,'+(0.3+Math.random()*0.4).toFixed(2)+')';ctx.fillRect(bx,520,3,bh)}
  // Footer
  ctx.fillStyle='#555568';ctx.font='11px Inter,sans-serif';ctx.letterSpacing='4px';ctx.textAlign='center';
  ctx.fillText('TUDO NASCE NO GESTO',320,610);ctx.letterSpacing='0px';
  // Corners notch effect
  ctx.fillStyle='#050508';
  [[-1,480],[641-20,480]].forEach(([x,y])=>{ctx.beginPath();ctx.arc(x<0?0:640,y,15,0,Math.PI*2);ctx.fill()});
  // Download
  c.toBlob(blob=>{
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='touch-pass.png';a.click();URL.revokeObjectURL(url);
    showToast('Bilhete salvo!');haptic([50,30,50]);
  },'image/png');
}
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath()}

// ═══ PROFILE ═══
let profileReturnTo='chat';
function showProfile(){
  if(!state.userId)return;
  profileReturnTo='home';
  loadProfile(state.userId);
}
async function showPartnerProfile(){
  if(!state.currentRelation)return;
  const pid=state.currentPartnerId;
  if(!pid)return showToast('Parceiro não encontrado.');
  profileReturnTo='chat';
  await loadProfile(pid);
}
async function loadProfile(userId,canAct){
  haptic([30]);
  try{
    const url=canAct===false?'/api/profile/'+userId:'/api/profile/'+userId+'/from/'+state.userId;
    const d=await fetch(url).then(r=>r.json());
    if(d.error)return showToast(d.error);
    renderProfile(d,userId);
    showScreen('profile');
  }catch(e){showToast('Erro ao carregar perfil.')}
}
function renderProfile(d,userId){
  const displayName=d.realName||d.nickname;
  $('pfTitle').textContent=displayName;
  const s=$('pfScroll');
  let html='<div class="pf-card">';
  html+=makeAvatar(d.nickname,d.color||'hsl(200,65%,55%)',64,d.profilePhoto||null,false,d.avatarAccessory||null);
  html+='<div style="margin-top:.8rem;font-size:1.1rem;font-weight:700">'+esc(displayName)+(d.isSubscriber?' <span style="font-size:.55rem;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;padding:.1rem .35rem;border-radius:8px;font-weight:600;vertical-align:middle">Plus</span>':'')+'</div>';
  if(d.realName&&d.realName!==d.nickname){
    html+='<div style="font-size:.7rem;color:var(--t2);margin-top:.1rem">@'+esc(d.nickname)+'</div>';
  }
  if(d.bio)html+='<div style="font-size:.75rem;color:var(--t2);margin-top:.4rem;font-style:italic">'+esc(d.bio)+'</div>';
  // Social links (privacy-filtered by server)
  let socials=[];
  if(d.instagram)socials.push('<span style="color:#e1306c">'+esc(d.instagram)+'</span>');
  if(d.tiktok)socials.push('<span style="color:#69c9d0">'+esc(d.tiktok)+'</span>');
  if(d.twitter)socials.push('<span style="color:#1da1f2">'+esc(d.twitter)+'</span>');
  if(d.phone)socials.push('<span style="color:var(--t2)">'+esc(d.phone)+'</span>');
  if(socials.length)html+='<div style="font-size:.68rem;margin-top:.3rem;display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center">'+socials.join('')+'</div>';
  html+='<div class="pf-stats">';
  html+='<div class="pf-stat"><div class="pf-stat-num" style="color:#fbbf24">'+(d.stars||0)+'</div><div class="pf-stat-lbl">estrelas</div></div>';
  html+='<div class="pf-stat"><div class="pf-stat-num" style="color:#60a5fa">'+(d.score||0)+'</div><div class="pf-stat-lbl">score</div></div>';
  html+='<div class="pf-stat"><div class="pf-stat-num">'+d.uniquePeople+'</div><div class="pf-stat-lbl">conexões</div></div>';
  html+='<div class="pf-stat"><div class="pf-stat-num" style="color:#ff6b8a">'+(d.likesCount||0)+'</div><div class="pf-stat-lbl">curtidas</div></div>';
  html+='</div>';
  // Buy star for self button (on own profile)
  if(userId===state.userId){
    html+='<button onclick="buyStarSelf()" style="margin:.4rem auto 0;display:block;padding:.35rem .8rem;font-size:.65rem;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:16px;color:#fbbf24;cursor:pointer">★ Comprar estrela</button>';
  }
  // Star details
  if(d.starDetails&&d.starDetails.length>0){
    html+='<div style="display:flex;flex-wrap:wrap;gap:.3rem;justify-content:center;margin:.5rem 0">';
    d.starDetails.forEach(s=>{
      const tip=s.reason==='gift'?'Presente de '+(s.fromName||'?'):s.reason==='organic'?'Orgânica ('+s.milestone+'x com '+(s.withName||'?')+')':'Marco';
      html+='<div title="'+tip+'" style="font-size:1rem;cursor:help;transition:.15s" onmouseenter="this.style.transform=\'scale(1.3)\'" onmouseleave="this.style.transform=\'none\'">⭐</div>';
    });
    html+='</div>';
  }
  html+='</div>';
  // Actions if active connection
  if(d.canInteract){
    html+='<div class="pf-actions">';
    html+='<button class="pf-act-btn" onclick="openGiftPicker()">Presentear</button>';
    html+='<button class="pf-act-btn" onclick="openDeclModal()">Declarar</button>';
    html+='</div>';
  }
  // Declarations
  html+='<div class="pf-section"><div class="pf-section-title">Declarações recebidas</div>';
  if(d.declarations&&d.declarations.length>0){
    d.declarations.slice().reverse().forEach(dc=>{
      html+='<div class="pf-decl"><div class="pf-decl-text">"'+esc(dc.text)+'"</div><div class="pf-decl-from">— '+esc(dc.fromName)+'</div></div>';
    });
  }else html+='<div class="pf-empty">Nenhuma declaração ainda.</div>';
  html+='</div>';
  // Gifts
  html+='<div class="pf-section"><div class="pf-section-title">Presentes recebidos</div>';
  if(d.gifts&&d.gifts.length>0){
    d.gifts.slice().reverse().forEach(g=>{
      html+='<div class="pf-gift"><div class="pf-gift-emoji">'+g.emoji+'</div><div class="pf-gift-info"><div class="pf-gift-name">'+esc(g.giftName)+'</div><div class="pf-gift-from">de '+esc(g.fromName)+'</div>'+(g.message?'<div class="pf-gift-msg">"'+esc(g.message)+'"</div>':'')+'</div></div>';
    });
  }else html+='<div class="pf-empty">Nenhum presente ainda.</div>';
  html+='</div>';
  // Subscription card (only on own profile)
  if(userId===state.userId){
    html+='<div class="pf-section" id="pfSubSection"><div class="pf-section-title">Touch? Plus</div>';
    html+='<div id="pfSubCard" style="padding:.6rem;background:linear-gradient(145deg,rgba(99,102,241,.08),rgba(168,85,247,.06));border:1px solid rgba(99,102,241,.15);border-radius:12px;text-align:center"><div style="font-size:.7rem;color:var(--t3)">Carregando...</div></div>';
    html+='</div>';
  }
  // Logout button (only on own profile)
  if(userId===state.userId){
    html+='<div style="margin-top:2rem;text-align:center;padding-bottom:2rem">';
    if(fbUser)html+='<div style="font-size:.72rem;color:var(--t3);margin-bottom:.6rem">'+esc(fbUser.email||fbUser.displayName||'')+'</div>';
    html+='<button class="bs" onclick="doLogout()" style="color:var(--err);border-color:var(--err)">Sair da conta</button>';
    html+='</div>';
  }
  s.innerHTML=html;
  // Load subscription status for own profile
  if(userId===state.userId)loadSubStatus();
}
function closeProfile(){
  if(profileReturnTo==='chat'&&state.currentRelation)showScreen('chat');
  else goHome();
}

// ═══ MY PROFILE SHEET (home avatar click) ═══
function showMyProfileSheet(){
  if(!state.userId)return;
  haptic([30]);
  const existing=document.querySelector('.my-profile-overlay');if(existing){existing.remove();return}
  const overlay=document.createElement('div');
  overlay.className='more-menu-overlay my-profile-overlay';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
  const color=state.userColor||nickColor(state.userName||'??');
  const initials=(state.userName||'??').slice(0,2).toUpperCase();
  const email=fbUser?(fbUser.email||fbUser.displayName||''):'';
  // Avatar: use real photo if available
  const hasPhoto=state.userPhoto&&state.userPhoto.length>10;
  const isVerified=!!state.userVerified;
  let avatarInner=hasPhoto
    ?'<div style="width:56px;height:56px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,.12);flex-shrink:0"><img src="'+state.userPhoto+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>'
    :'<div style="width:56px;height:56px;border-radius:50%;background:'+color+';display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:800;color:#fff;border:2px solid rgba(255,255,255,.12);flex-shrink:0">'+esc(initials)+'</div>';
  const avatarHtml=isVerified?'<div class="verified-wrap">'+avatarInner+verifiedBadge('verified-badge-lg')+'</div>':avatarInner;
  // Cadastro tag
  const profileMostlyComplete=hasPhoto&&state.userRealName;
  const cadastroTag=profileMostlyComplete?'':'<span class="my-pf-tag">completar</span>';
  const realNameLine=state.userRealName?'<div style="font-size:.72rem;color:var(--t2);margin-top:.1rem">'+esc(state.userRealName)+'</div>':'';
  // Prestador: "Serviços" with both cadastro and painel inside
  const isPrestador=localStorage.getItem('touch_isPrestador')==='1';
  const hasEmailVerified=!!(fbUser&&fbUser.emailVerified);
  const hasFace=!!state.userFaceEnrolled;
  const hasDoc=!!state.userDocVerified;
  overlay.innerHTML='<div class="more-menu-sheet" style="padding:1.6rem 1.4rem;position:relative;overflow:visible" id="profileSheet">'
    +'<div class="more-menu-handle"></div>'
    +'<div style="display:flex;justify-content:flex-end;margin-bottom:.3rem;margin-top:-.4rem"><button onclick="this.closest(\'.my-profile-overlay\').remove()" style="width:28px;height:28px;border-radius:50%;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--t2);font-size:.85rem;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:inherit;line-height:1;flex-shrink:0">&times;</button></div>'
    // Header: avatar + name block
    +'<div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.1rem">'
    +avatarHtml
    +'<div style="flex:1;min-width:0">'
    +'<div style="display:flex;align-items:center;gap:.4rem;flex-wrap:wrap"><span style="font-size:1.3rem;font-weight:900;color:#fff;letter-spacing:-.01em">'+esc(state.userName||'??')+'</span>'+(isVerified?' <span style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:.9rem;font-weight:800" title="Verificado">✓</span>':'')+'</div>'
    +(state.userRealName?'<div style="font-size:.72rem;color:var(--t2);margin-top:.15rem">'+esc(state.userRealName)+'</div>':'')
    +'<div style="display:flex;align-items:center;gap:.4rem;margin-top:.25rem;flex-wrap:wrap">'
    +(state.userIsSubscriber?'<span style="font-size:.5rem;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;padding:1px 6px;border-radius:6px;font-weight:700">✦ Plus</span>':'')
    +(state.userStarsCount>0?'<span style="font-size:.55rem;color:#fbbf24;background:rgba(251,191,36,.1);padding:1px 6px;border-radius:6px;font-weight:600">★ '+state.userStarsCount+'</span>':'')
    +(hasEmailVerified?'<span style="font-size:.5rem;color:#22c55e;background:rgba(34,197,94,.1);padding:1px 6px;border-radius:6px;font-weight:600">Email</span>':'')
    +(hasFace?'<span style="font-size:.5rem;color:#06b6d4;background:rgba(6,182,212,.1);padding:1px 6px;border-radius:6px;font-weight:600">Face</span>':'')
    +(hasDoc?'<span style="font-size:.5rem;color:#a855f7;background:rgba(168,85,247,.1);padding:1px 6px;border-radius:6px;font-weight:600">Doc</span>':'')
    +(state.userTopTag?'<span style="font-size:.5rem;color:'+(state.userTopTag==='top1'?'#FFD700':state.userTopTag==='top5'?'#C0C0C0':'#CD7F32')+';background:rgba(255,215,0,.1);padding:1px 6px;border-radius:6px;font-weight:700">'+(state.userTopTag==='top1'?'🏆 TOP 1':state.userTopTag==='top5'?'🥈 TOP 5':state.userTopTag==='top50'?'🥉 TOP 50':'')+'</span>':'')
    +'</div>'
    // Stats row
    +'<div style="display:flex;gap:.8rem;margin-top:.4rem">'
    +'<div style="text-align:center"><div style="font-size:.85rem;font-weight:800;color:#60a5fa">'+(state.userScore||0)+'</div><div style="font-size:.42rem;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">score</div></div>'
    +'<div style="text-align:center"><div style="font-size:.85rem;font-weight:800;color:var(--t1)">'+(state.userUniqueConnections||0)+'</div><div style="font-size:.42rem;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">conexões</div></div>'
    +(state.userStarsCount>0?'<div style="text-align:center"><div style="font-size:.85rem;font-weight:800;color:#fbbf24">'+state.userStarsCount+'</div><div style="font-size:.42rem;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">estrelas</div></div>':'')
    +(state.userGiftsReceived>0?'<div style="text-align:center"><div style="font-size:.85rem;font-weight:800;color:#f472b6">'+state.userGiftsReceived+'</div><div style="font-size:.42rem;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">presentes</div></div>':'')
    +'</div>'
    +'</div></div>'
    // Menu buttons — clean
    +'<div style="display:flex;flex-direction:column;gap:.4rem">'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showBoardingPassWithQR()"><span class="my-pf-ico">ID</span>ID</button>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();openCompleteProfile()"><span class="my-pf-ico" style="font-style:normal">∕</span>Cadastro'+cadastroTag+'</button>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showSubscriptionScreen()"><span class="my-pf-ico" style="font-style:normal">'+(state.userIsSubscriber?'✦':'☆')+'</span>Touch? Plus'+(state.userIsSubscriber?' <span style="font-size:.5rem;background:linear-gradient(135deg,#06b6d4,#3b82f6);color:#fff;padding:1px 5px;border-radius:5px;margin-left:.3rem;font-weight:600">ativo</span>':'')+'</button>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showServicosScreen()"><span class="my-pf-ico" style="font-style:normal">◈</span>Serviços</button>'
    +(state.userIsAdmin?'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showVerificationPanel()"><span class="my-pf-ico" style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800">✓</span>Verificações</button>':'')
    +'<div class="my-pf-divider"></div>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();window.open(\'/site\',\'_blank\')"><span class="my-pf-ico" style="font-style:normal">i</span>Sobre o Touch</button>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();window.open(\'/termos\',\'_blank\')"><span class="my-pf-ico" style="font-style:normal">§</span>Termos de Uso</button>'
    +'<button class="my-pf-btn my-pf-danger" onclick="this.closest(\'.my-profile-overlay\').remove();doLogout()"><span class="my-pf-ico">x</span>Sair</button>'
    +'</div></div>';
  document.body.appendChild(overlay);
  // Swipe-down to dismiss
  const sheet=overlay.querySelector('.more-menu-sheet');
  let _pfTouchY=0,_pfDelta=0;
  sheet.addEventListener('touchstart',function(e){_pfTouchY=e.touches[0].clientY;_pfDelta=0;sheet.style.transition='none'},{passive:true});
  sheet.addEventListener('touchmove',function(e){
    _pfDelta=e.touches[0].clientY-_pfTouchY;
    if(_pfDelta>0){sheet.style.transform='translateY('+_pfDelta+'px)';sheet.style.opacity=Math.max(0.4,1-_pfDelta/400)}
  },{passive:true});
  sheet.addEventListener('touchend',function(){
    sheet.style.transition='transform .25s ease,opacity .25s ease';
    if(_pfDelta>100){sheet.style.transform='translateY(100%)';sheet.style.opacity='0';setTimeout(()=>overlay.remove(),250)}
    else{sheet.style.transform='';sheet.style.opacity=''}
  },{passive:true});
}

// ═══ SUBSCRIPTION ═══
async function showSubscriptionScreen() {
  showScreen('subscriptionScreen');
  loadSubSavedCard();
  // Load plan benefits
  try {
    const plans = await (await fetch('/api/subscription/plans')).json();
    const plan = plans[0]; // touch_plus
    if (plan && plan.benefits) {
      $('subBenefitsList').innerHTML = plan.benefits.map(b =>
        '<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.4rem"><span style="color:#818cf8;font-size:.8rem">✓</span><span style="font-size:.72rem;color:var(--t2)">' + esc(b) + '</span></div>'
      ).join('');
    }
  } catch (e) {}
  // Load current status
  await loadSubStatus();
}

async function loadSubStatus() {
  if (!state.userId) return;
  try {
    const sub = await (await fetch('/api/subscription/status/' + state.userId)).json();
    const statusEl = $('subCurrentStatus');
    const btn = $('subActionBtn');
    if (sub.active) {
      const expDate = sub.expiresAt ? new Date(sub.expiresAt).toLocaleDateString('pt-BR') : '';
      statusEl.innerHTML = '<div style="padding:.8rem;background:rgba(0,220,130,.08);border:1px solid rgba(0,220,130,.2);border-radius:12px;text-align:center">'
        + '<div style="font-size:.85rem;font-weight:700;color:var(--ok)">✓ Assinatura ativa</div>'
        + '<div style="font-size:.65rem;color:var(--t3);margin-top:.2rem">Próxima renovação: ' + expDate + '</div>'
        + '</div>';
      btn.textContent = 'Cancelar assinatura';
      btn.style.background = 'rgba(255,68,102,.15)';
      btn.style.color = '#ff4466';
      btn.onclick = cancelSubscription;
    } else {
      statusEl.innerHTML = '';
      btn.textContent = 'Assinar agora';
      btn.style.background = 'linear-gradient(135deg,#6366f1,#8b5cf6)';
      btn.style.color = '#fff';
      btn.onclick = startSubscription;
    }
    // Also update profile card if visible
    const pfCard = $('pfSubCard');
    if (pfCard) {
      if (sub.active) {
        pfCard.innerHTML = '<div style="font-size:.75rem;font-weight:600;color:var(--ok)">✦ Plus ativo</div><div style="font-size:.6rem;color:var(--t3);margin-top:.15rem">Assinatura mensal · R$9,90</div>';
      } else {
        pfCard.innerHTML = '<div style="font-size:.7rem;color:var(--t2)">Assine o Touch? Plus por R$9,90/mês</div><button onclick="showSubscriptionScreen()" style="margin-top:.4rem;padding:.35rem .8rem;border-radius:10px;border:1px solid rgba(99,102,241,.3);background:rgba(99,102,241,.1);color:#818cf8;font-size:.65rem;font-weight:600;font-family:inherit;cursor:pointer">Ver plano</button>';
      }
    }
  } catch (e) { console.error('Sub status error:', e); }
}

async function startSubscription() {
  const btn = $('subActionBtn');
  btn.disabled = true; btn.textContent = 'Abrindo...';
  try {
    const resp = await fetch('/api/subscription/create', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: state.userId, planId: 'touch_plus' })
    });
    const result = await resp.json();
    if (result.error) throw new Error(result.error);
    const url = result.initPoint || result.sandboxInitPoint;
    if (url) {
      window.location.href = url;
    } else {
      throw new Error('URL de assinatura não disponível.');
    }
  } catch (e) {
    console.error('Subscription error:', e);
    showToast('Erro: ' + (e.message || 'Tente novamente'));
    btn.disabled = false;
    btn.textContent = '✦ Assinar Touch? Plus';
  }
}

async function cancelSubscription() {
  if (!confirm('Cancelar assinatura Touch? Plus?\nVocê perderá os benefícios ao final do período.')) return;
  const btn = $('subActionBtn');
  btn.disabled = true; btn.textContent = 'Cancelando...';
  try {
    const resp = await fetch('/api/subscription/cancel', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: state.userId })
    });
    const result = await resp.json();
    if (result.error) throw new Error(result.error);
    showToast('Assinatura cancelada.');
    await loadSubStatus();
  } catch (e) {
    showToast('Erro: ' + (e.message || 'Tente novamente'));
    btn.disabled = false;
    btn.textContent = 'Cancelar assinatura';
  }
}

// Check subscription result from URL param
function checkSubResultParam() {
  const params = new URLSearchParams(window.location.search);
  if (params.get('subResult') === 'ok') {
    showToast('Assinatura processada! Verificando... ✦');
    window.history.replaceState({}, '', window.location.pathname);
    setTimeout(() => loadSubStatus(), 1000);
  }
}

// ═══ GIFT PICKER ═══
let giftCatalog=[];
async function openGiftPicker(){
  if(!state.currentRelation)return;
  if(!giftCatalog.length){try{giftCatalog=await fetch('/api/gift-catalog').then(r=>r.json())}catch(e){return showToast('Erro ao carregar presentes.')}}
  let html='<div class="modal-overlay" onclick="closeGiftModal(event)">';
  html+='<div class="modal-sheet" onclick="event.stopPropagation()">';
  html+='<div class="modal-handle"></div>';
  html+='<div class="modal-title">&#x1F381; Escolha um presente</div>';
  html+='<div class="gift-grid">';
  giftCatalog.forEach(g=>{
    html+='<div class="gift-option" onclick="selectGift(\''+g.id+'\')">';
    html+='<div class="g-emoji">'+g.emoji+'</div>';
    html+='<div class="g-name">'+esc(g.name)+'</div>';
    html+='<div class="g-desc">'+esc(g.description)+'</div>';
    html+='</div>';
  });
  html+='</div></div></div>';
  $('giftModal').innerHTML=html;$('giftModal').classList.remove('hidden');
}
function closeGiftModal(e){if(e&&e.target.classList.contains('modal-overlay'))$('giftModal').classList.add('hidden');$('giftModal').innerHTML=''}
function selectGift(giftId){
  const gift=giftCatalog.find(g=>g.id===giftId);if(!gift)return;
  let html='<div class="modal-overlay" onclick="closeGiftModal(event)">';
  html+='<div class="modal-sheet" onclick="event.stopPropagation()">';
  html+='<div class="modal-handle"></div>';
  html+='<div class="modal-title">'+gift.emoji+' '+esc(gift.name)+'</div>';
  html+='<div style="text-align:center;font-size:.8rem;color:var(--t2);margin-bottom:.8rem">'+esc(gift.description)+'</div>';
  if(gift.needsAddress)html+='<div style="text-align:center;font-size:.7rem;color:var(--warn);margin-bottom:.6rem">&#x1F4E6; Requer endereço (pediremos permissão)</div>';
  html+='<input class="gift-msg-input" id="giftMsg" placeholder="Mensagem (opcional)" maxlength="120">';
  html+='<div style="margin-top:.8rem;text-align:center"><button class="bp" style="max-width:200px" onclick="confirmSendGift(\''+giftId+'\')">Enviar presente</button></div>';
  html+='</div></div>';
  $('giftModal').innerHTML=html;
}
async function confirmSendGift(giftId){
  const msg=$('giftMsg')?$('giftMsg').value.trim():'';
  try{
    const r=await fetch('/api/gift/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId:state.currentRelation.relationId,fromUserId:state.userId,giftId,message:msg})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Presente enviado!');haptic([50,30,50,30,50]);
    $('giftModal').classList.add('hidden');$('giftModal').innerHTML='';
  }catch(e){showToast('Erro ao enviar.')}
}

// ═══ DECLARATION MODAL ═══
function openDeclModal(){
  if(!state.currentRelation)return;
  let html='<div class="modal-overlay" onclick="closeDeclModal(event)">';
  html+='<div class="modal-sheet" onclick="event.stopPropagation()">';
  html+='<div class="modal-handle"></div>';
  html+='<div class="modal-title">&#x1F4DD; Declaração</div>';
  html+='<div style="text-align:center;font-size:.78rem;color:var(--t2);margin-bottom:.8rem">Escreva algo para ficar no perfil dessa pessoa. Todos que se conectarem a ela poderão ler.</div>';
  html+='<textarea class="decl-input" id="declText" placeholder="Escreva sua declaração..." maxlength="280" oninput="updateDeclCounter()"></textarea>';
  html+='<div class="decl-counter" id="declCounter">0/280</div>';
  html+='<div style="margin-top:.6rem;text-align:center"><button class="bp" style="max-width:200px" onclick="confirmSendDecl()">Publicar</button></div>';
  html+='</div></div>';
  $('declModal').innerHTML=html;$('declModal').classList.remove('hidden');
}
function closeDeclModal(e){if(e&&e.target.classList.contains('modal-overlay'))$('declModal').classList.add('hidden');$('declModal').innerHTML=''}
function updateDeclCounter(){const t=$('declText');if(t)$('declCounter').textContent=t.value.length+'/280'}
async function confirmSendDecl(){
  const text=$('declText')?$('declText').value.trim():'';
  if(!text||text.length<3)return showToast('Escreva pelo menos 3 caracteres.');
  try{
    const r=await fetch('/api/declaration/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId:state.currentRelation.relationId,fromUserId:state.userId,text})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Declaração publicada!');haptic([50,30,50]);
    $('declModal').classList.add('hidden');$('declModal').innerHTML='';
  }catch(e){showToast('Erro ao publicar.')}
}

// ═══ ADDRESS REQUEST (in chat) ═══
function showAddressRequest(gift){
  const area=$('contactRequestArea');
  let html='<div class="addr-request" id="addrReq-'+gift.id+'">';
  html+='<div class="addr-request-text">'+esc(gift.fromName)+' quer te presentear com <strong>'+gift.emoji+' '+esc(gift.giftName)+'</strong>!'+(gift.message?' "'+esc(gift.message)+'"':'')+'</div>';
  html+='<div class="addr-request-note">Seu endereço NÃO é passado para essa pessoa. A plataforma cuida da entrega.</div>';
  html+='<input class="addr-input" id="addrInput-'+gift.id+'" placeholder="Seu endereço completo para entrega">';
  html+='<div class="addr-actions">';
  html+='<button class="addr-btn accept" onclick="respondAddress(\''+gift.id+'\',true)">Aceitar &#x1F4E6;</button>';
  html+='<button class="addr-btn decline" onclick="respondAddress(\''+gift.id+'\',false)">Não, obrigado</button>';
  html+='</div></div>';
  area.innerHTML+=html;
}
async function respondAddress(giftId,accepted){
  const addrEl=$('addrInput-'+giftId);
  const address=addrEl?addrEl.value.trim():'';
  if(accepted&&!address)return showToast('Digite seu endereço para receber.');
  try{
    await fetch('/api/gift/address-response',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({giftId,userId:state.userId,accepted,address:accepted?address:null})});
    const el=$('addrReq-'+giftId);if(el)el.remove();
    showToast(accepted?'Endereço enviado! Presente a caminho.':'Presente recusado.');haptic([50]);
  }catch(e){showToast('Erro.')}
}

// ═══ HISTORY CARD SAVE/SHARE ═══
function saveHistoryCard(idx){
  const e=window._historyData&&window._historyData[idx];if(!e)return;
  const c=document.createElement('canvas');c.width=600;c.height=400;const ctx=c.getContext('2d');
  // BG
  const grad=ctx.createLinearGradient(0,0,0,400);grad.addColorStop(0,'#0a0a12');grad.addColorStop(.5,'#15152a');grad.addColorStop(1,'#0a0a12');
  ctx.fillStyle=grad;roundRect(ctx,0,0,600,400,20);ctx.fill();
  // Accent top
  const acG=ctx.createLinearGradient(0,0,600,0);acG.addColorStop(0,'#ff6b35');acG.addColorStop(1,'#ff3d71');
  ctx.fillStyle=acG;ctx.fillRect(0,0,600,3);
  // Logo
  ctx.fillStyle='#ff6b35';ctx.font='bold 11px Inter,sans-serif';ctx.letterSpacing='4px';ctx.fillText('Touch?',30,35);ctx.letterSpacing='0px';
  // Avatar circle
  const color=e.withColor||nickColor(e.withName||'??');
  ctx.beginPath();ctx.arc(300,120,35,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 22px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText((e.withName||'??').slice(0,2).toUpperCase(),300,120);ctx.textBaseline='alphabetic';
  // Name
  ctx.fillStyle='#f5f5f7';ctx.font='600 18px Inter,sans-serif';ctx.fillText(e.withName||'Alguém',300,185);
  // Date
  const d=new Date(e.timestamp);
  ctx.fillStyle='#555568';ctx.font='12px Inter,sans-serif';ctx.fillText(pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear()+' '+pad(d.getHours())+':'+pad(d.getMinutes()),300,210);
  // Phrase
  if(e.phrase){ctx.fillStyle='#8888a0';ctx.font='italic 16px Inter,sans-serif';
    const words=e.phrase.split(' ');let line='',y=260;
    words.forEach(w=>{const test=line+w+' ';if(ctx.measureText(test).width>460&&line){ctx.fillText('"'+line.trim()+'"',300,y);y+=24;line=w+' '}else line=test});
    if(line)ctx.fillText(line===e.phrase+' '?'"'+line.trim()+'"':line.trim(),300,y);
  }
  // Footer
  ctx.fillStyle='#555568';ctx.font='9px Inter,sans-serif';ctx.letterSpacing='3px';ctx.fillText('TUDO NASCE NO GESTO',300,375);ctx.letterSpacing='0px';ctx.textAlign='left';
  // Download
  c.toBlob(blob=>{const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='touch-encontro-'+(idx+1)+'.png';a.click();URL.revokeObjectURL(url);showToast('Card salvo!');haptic([50,30,50])},'image/png');
}
function shareHistoryCard(idx){
  const e=window._historyData&&window._historyData[idx];if(!e)return;
  const text='"'+(e.phrase||'')+'" — encontro com '+e.withName+' via Touch?';
  if(navigator.share){navigator.share({title:'Touch?',text}).catch(()=>{})}
  else{navigator.clipboard.writeText(text).then(()=>showToast('Copiado!')).catch(()=>{})}
}

// ═══ EXPIRE CARD ═══
function showExpireCard(){if(!state.currentRelation)return;$('cardPhrase').textContent=state.currentRelation.phrase;const cr=state.currentRelation.createdAt||(state.currentRelation.expiresAt-86400000);$('cardTime').textContent=Math.round((state.currentRelation.expiresAt-cr)/3600000)+'h juntos';showScreen('expireCard')}
async function shareCard(){const text='"'+state.currentRelation.phrase+'" — Touch?';if(navigator.share){try{await navigator.share({title:'Touch?',text})}catch(e){}}else{try{await navigator.clipboard.writeText(text);showToast('Copiado!')}catch(e){}}}

// ═══ SOUND & HAPTICS ═══
let audioCtx=null;
function playSound(type){
  try{if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')audioCtx.resume();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sine';const t=audioCtx.currentTime;
  if(type==='send'){o.frequency.setValueAtTime(600,t);o.frequency.exponentialRampToValueAtTime(900,t+.08);g.gain.setValueAtTime(.06,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12)}
  else if(type==='receive'){o.frequency.setValueAtTime(500,t);o.frequency.exponentialRampToValueAtTime(700,t+.1);g.gain.setValueAtTime(.05,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.start(t);o.stop(t+.15)}
  else if(type==='connect'){o.frequency.setValueAtTime(523,t);o.frequency.setValueAtTime(659,t+.12);o.frequency.setValueAtTime(784,t+.24);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4)}
  else if(type==='pulse'){o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(200,t+.3);g.gain.setValueAtTime(.08,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4)}
  }catch(e){}
}
// Haptic vibration — robust for web
let _vibrationTested=false;
function haptic(p){
  try{
    if('vibrate' in navigator){
      navigator.vibrate(p);
      _vibrationTested=true;
    }
  }catch(e){}
}
// Try to activate vibration on first user interaction
document.addEventListener('click',function _activateVibration(){
  if(!_vibrationTested&&'vibrate' in navigator){
    try{navigator.vibrate(1)}catch(e){}
    _vibrationTested=true;
  }
  document.removeEventListener('click',_activateVibration);
},{once:true});
document.addEventListener('touchstart',function _activateVibrationTouch(){
  if(!_vibrationTested&&'vibrate' in navigator){
    try{navigator.vibrate(1)}catch(e){}
    _vibrationTested=true;
  }
  document.removeEventListener('touchstart',_activateVibrationTouch);
},{once:true});

// ═══ HOME MOTIVATION ═══
const HOME_PHRASES=[
  'Nada acontece\nà distância.',
  'Quem toca\ndescobre.',
  'Presença é\na moeda rara.',
  'O encontro\né o começo.',
  'Hoje é feito\nde gestos.',
  'A conexão\nvive no toque.',
  'Não espere.\nTouch.',
  'Cada encontro\ndeixa marca.',
  'O melhor momento\né o presente.',
  'Proximidade\nmuda tudo.'
];
function setHomeMotivation(){
  const el=$('homeMotivation');
  if(!el)return;
  const p=HOME_PHRASES[Math.floor(Math.random()*HOME_PHRASES.length)];
  el.innerHTML=p.replace('\n','<br>');
}

// ═══ UTILS ═══
function showToast(msg){const t=$('toast');t.textContent=msg;t.classList.remove('hidden');t.style.animation='none';t.offsetHeight;t.style.animation='toast-in .35s cubic-bezier(.22,1,.36,1) forwards';clearTimeout(t._t);t._t=setTimeout(()=>{t.style.animation='toast-out .3s ease forwards';setTimeout(()=>t.classList.add('hidden'),300)},2500)}
function esc(text){const d=document.createElement('div');d.textContent=text;return d.innerHTML}
function pad(n){return n.toString().padStart(2,'0')}
function updateSendBtn(){$('sendBtn').classList.toggle('active',$('chatInput').value.trim().length>0)}

// ═══ SELFIE AT CONNECTION (v2 — inline, no separate step) ═══
let selfieStream=null;
function releaseSelfieCamera(){
  if(selfieStream){selfieStream.getTracks().forEach(t=>t.stop());selfieStream=null}
  const v=$('selfieVideo');if(v){v.srcObject=null;v.style.display='none'}
}
function releaseAllMedia(){
  // Stop sonic (mic + speaker)
  if(homeSonicActive)stopHomeSonic();
  if(sonicActive)stopSonicMode();
  // Stop selfie camera
  releaseSelfieCamera();
}
// ═══ SELFIE MODAL ═══
const SELFIE_PHRASES=[
  {title:'📸 Registrem esse momento!',phrase:'Vocês se encontraram... agora sorriam!',emojis:'🎉 😄 ✨ 💫 🤳'},
  {title:'✨ Que encontro!',phrase:'Guardem essa memória pra sempre!',emojis:'💖 😊 🌟 📸 🎊'},
  {title:'🤳 Hora da selfie!',phrase:'Um sorriso vale mais que mil palavras!',emojis:'😁 🥳 ⭐ 💥 📷'},
  {title:'💫 Momento especial!',phrase:'Esse encontro merece uma foto!',emojis:'🎉 😍 ✨ 🤩 📸'},
  {title:'🎉 Olha só quem se encontrou!',phrase:'Vamos eternizar esse momento?',emojis:'💫 😄 🌈 ⚡ 🤳'},
  {title:'😄 Sorriam!',phrase:'A melhor selfie é a que tem história!',emojis:'📸 💖 ✨ 🎊 😁'},
  {title:'🌟 Conexão feita!',phrase:'Agora falta só a foto pra marcar!',emojis:'🤳 🥳 💫 🎉 😊'},
  {title:'💖 Que momento!',phrase:'Dois sorrisos, uma selfie perfeita!',emojis:'😄 ✨ 📷 🌟 🎊'}
];
let _sfCaptured=false;

function revealCaptureSelfie(){
  // Pick random phrase
  const p=SELFIE_PHRASES[Math.floor(Math.random()*SELFIE_PHRASES.length)];
  $('sfTitle').textContent=p.title;
  $('sfPhrase').textContent=p.phrase;
  $('sfEmojis').textContent=p.emojis;
  // Reset state
  _sfCaptured=false;
  $('sfCapturedImg').style.display='none';
  $('sfPlaceholder').style.display='flex';
  $('sfCaptureBtn').textContent='📸 Tirar Selfie';
  $('sfCaptureBtn').className='sf-btn sf-btn-capture';
  $('sfCaptureBtn').onclick=selfieCapture;
  // Show modal
  $('selfieModalBg').style.display='flex';
  // Auto-start camera
  startSelfieCamera();
}

function closeSelfieModal(){
  $('selfieModalBg').style.display='none';
  if(selfieStream){selfieStream.getTracks().forEach(t=>t.stop());selfieStream=null}
  $('selfieVideo').style.display='none';$('selfieVideo').srcObject=null;
}

function startSelfieCamera(){
  if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){
    navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false}).then(stream=>{
      selfieStream=stream;
      const v=$('selfieVideo');v.srcObject=stream;v.style.display='block';
      $('sfPlaceholder').style.display='none';
    }).catch(()=>{selfieFilePicker()});
  }else{selfieFilePicker()}
}

function selfieFilePicker(){
  const input=document.createElement('input');input.type='file';input.accept='image/*';input.capture='user';
  input.onchange=()=>{
    const file=input.files[0];if(!file)return;
    const reader=new FileReader();reader.onload=()=>{
      const img=new Image();img.onload=()=>{
        const cv=document.createElement('canvas'),ctx=cv.getContext('2d');
        cv.width=400;cv.height=400;const sc=Math.max(400/img.width,400/img.height);
        ctx.drawImage(img,(400-img.width*sc)/2,(400-img.height*sc)/2,img.width*sc,img.height*sc);
        selfieSave(cv.toDataURL('image/jpeg',.8));
      };img.src=reader.result;
    };reader.readAsDataURL(file);
  };input.click();
}

function selfieCapture(){
  if(_sfCaptured)return;
  // If stream active, capture from video
  if(selfieStream){
    const v=$('selfieVideo'),cv=$('selfieCanvas');
    cv.width=400;cv.height=400;const ctx=cv.getContext('2d');
    const s=Math.min(v.videoWidth,v.videoHeight);const sx=(v.videoWidth-s)/2,sy=(v.videoHeight-s)/2;
    // Mirror the capture (front camera)
    ctx.translate(400,0);ctx.scale(-1,1);
    ctx.drawImage(v,sx,sy,s,s,0,0,400,400);
    ctx.setTransform(1,0,0,1,0,0);
    const dataUrl=cv.toDataURL('image/jpeg',0.8);
    // Stop camera
    selfieStream.getTracks().forEach(t=>t.stop());selfieStream=null;
    v.style.display='none';
    selfieSave(dataUrl);
  }else{
    selfieFilePicker();
  }
}

function selfieSave(dataUrl){
  _sfCaptured=true;
  // Show captured image
  const capImg=$('sfCapturedImg');capImg.src=dataUrl;capImg.style.display='block';
  $('sfPlaceholder').style.display='none';
  // Update button
  $('sfCaptureBtn').textContent='✅ Salvo!';
  $('sfCaptureBtn').className='sf-btn sf-btn-save';
  // Update the original selfie button on reveal screen
  const btn=$('selfieCapBtn');
  if(btn){btn.querySelector('span:last-child').textContent='Salvo ✓';btn.classList.add('success');btn.querySelector('.rv-ic').style.borderColor='var(--ok)'}
  // Confetti burst
  sfConfetti();
  // Change phrase
  $('sfTitle').textContent='🎉 Perfeito!';
  $('sfPhrase').textContent='Memória registrada com sucesso!';
  // Upload
  if(state.currentRelation){
    fetch('/api/selfie/'+state.currentRelation.relationId,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,selfieData:dataUrl})}).catch(()=>{});
  }
  haptic([50,30,50]);
  // Auto-close after 2s
  setTimeout(()=>closeSelfieModal(),2200);
}

function sfConfetti(){
  const modal=document.querySelector('.selfie-modal');
  const emojis=['🎉','✨','💫','⭐','🌟','💖','🎊','🥳','😄'];
  for(let i=0;i<12;i++){
    const span=document.createElement('span');
    span.className='sf-confetti';
    span.textContent=emojis[Math.floor(Math.random()*emojis.length)];
    span.style.left=Math.random()*90+5+'%';
    span.style.top=Math.random()*40+10+'%';
    span.style.animationDelay=Math.random()*0.5+'s';
    modal.appendChild(span);
    setTimeout(()=>span.remove(),2000);
  }
}

// ═══ CONTACT REQUESTS ═══
function openContactMenu(){
  const area=$('contactRequestArea');
  if(area.innerHTML){area.innerHTML='';return}
  const types=[
    {id:'instagram',emoji:'📸',label:'Instagram'},
    {id:'whatsapp',emoji:'💬',label:'WhatsApp'},
    {id:'x',emoji:'𝕏',label:'X / Twitter'},
    {id:'email',emoji:'📧',label:'Email'},
    {id:'foto',emoji:'📷',label:'Foto'}
  ];
  let html='<div class="contact-menu">';
  types.forEach(t=>{
    html+='<button type="button" class="contact-opt" onclick="requestContact(\''+t.id+'\')">'+t.emoji+' '+t.label+'</button>';
  });
  html+='</div>';
  area.innerHTML=html;
}
async function requestContact(type){
  if(!state.currentRelation)return;
  $('contactRequestArea').innerHTML='';
  try{
    await fetch('/api/request-contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId:state.currentRelation.relationId,fromUserId:state.userId,contactType:type})});
    showToast('Pedido enviado!');haptic([50]);
  }catch(e){showToast('Erro.')}
}
function showContactRequest(data){
  const area=$('contactRequestArea');
  const labels={instagram:'Instagram',whatsapp:'WhatsApp',x:'X / Twitter',email:'Email',foto:'Foto'};
  const emojis={instagram:'📸',whatsapp:'💬',x:'𝕏',email:'📧',foto:'📷'};
  let html='<div class="contact-req-banner" id="contactReq-'+data.requestId+'">';
  html+='<div class="contact-req-text">'+esc(data.from.name)+' quer seu <strong>'+emojis[data.contactType]+' '+(labels[data.contactType]||data.contactType)+'</strong></div>';
  if(data.contactType!=='foto'){
    html+='<input class="contact-req-input" id="contactVal-'+data.requestId+'" placeholder="Seu '+(labels[data.contactType]||'')+'">';
  }
  html+='<div class="contact-req-actions">';
  html+='<button type="button" class="addr-btn accept" onclick="respondContact(\''+data.requestId+'\',\''+data.relationId+'\',\''+data.contactType+'\',true)">Compartilhar</button>';
  html+='<button type="button" class="addr-btn decline" onclick="respondContact(\''+data.requestId+'\',\''+data.relationId+'\',\''+data.contactType+'\',false)">Não</button>';
  html+='</div></div>';
  area.innerHTML+=html;
}
async function respondContact(reqId,relationId,contactType,accepted){
  const valEl=$('contactVal-'+reqId);
  const value=valEl?valEl.value.trim():'';
  if(accepted&&contactType!=='foto'&&!value)return showToast('Preencha o campo.');
  try{
    await fetch('/api/respond-contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId,toUserId:state.userId,contactType,accepted,value:accepted?value:null})});
    const el=$('contactReq-'+reqId);if(el)el.remove();
    showToast(accepted?'Compartilhado!':'Recusado.');
  }catch(e){showToast('Erro.')}
}

// ═══ ENCOSTA REQUEST (digital - needs acceptance) ═══
function showEncostaRequest(data){
  const area=$('encostaReqArea');
  const color=data.from.color||nickColor(data.from.name||'??');
  let html='<div class="encosta-req-banner" id="encostaReq-'+data.requestId+'">';
  html+='<div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem">'+makeAvatar(data.from.name,color,38,data.from.profilePhoto||data.from.photoURL||null);
  html+='<div><div class="encosta-req-title">'+esc(data.from.name)+' quer conectar</div>';
  html+='<div class="encosta-req-sub">📍 '+esc(data.eventName)+'</div></div></div>';
  html+='<div class="encosta-req-actions">';
  html+='<button type="button" class="bp" style="flex:1;font-size:.82rem" onclick="acceptEncostaReq(\''+data.requestId+'\',\''+data.eventId+'\',\''+data.from.id+'\',true)">Aceitar</button>';
  html+='<button type="button" class="bs" style="flex:1;font-size:.82rem" onclick="acceptEncostaReq(\''+data.requestId+'\',\''+data.eventId+'\',\''+data.from.id+'\',false)">Recusar</button>';
  html+='</div></div>';
  area.innerHTML=html;
  haptic([100,50,100]);playSound('receive');
}
async function acceptEncostaReq(reqId,eventId,fromUserId,accepted){
  const el=$('encostaReq-'+reqId);if(el)el.remove();
  if(!accepted){
    try{await fetch('/api/event/encosta-accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,eventId,fromUserId,accepted:false})})}catch(e){}
    showToast('Recusado.');return;
  }
  try{
    const r=await fetch('/api/event/encosta-accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,eventId,fromUserId,accepted:true})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([80,40,80,40,80]);playSound('connect');
    state.currentRelation=d;
    const partner=(d.userA.id===state.userId)?d.userB:d.userA;
    state.currentPartnerId=partner.id;
    showScreen('encounter');showPhase('phaseReveal');
    doReveal(d);
  }catch(e){showToast('Erro ao conectar.')}
}

// ═══ LOCATION / EVENTS ═══
let locWatchId=null,myLat=null,myLng=null,locTab='nearby';
function openLocationScreen(){
  showScreen('locationScreen');
  $('locStatus').className='loc-status';
  $('locStatus').innerHTML='&#x1F50D; '+i18n('loc_searching');
  $('locContent').innerHTML='';
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      myLat=pos.coords.latitude;myLng=pos.coords.longitude;
      onLocationReady('gps');
      if(locWatchId)navigator.geolocation.clearWatch(locWatchId);
      locWatchId=navigator.geolocation.watchPosition(p=>{myLat=p.coords.latitude;myLng=p.coords.longitude;updateLocationOnServer()},{},{enableHighAccuracy:true,maximumAge:30000});
    },()=>fetchApproxLocation(),{enableHighAccuracy:true,timeout:8000});
  }else fetchApproxLocation();
}
function fetchApproxLocation(){
  // Try multiple IP geolocation services
  fetch('https://ipapi.co/json/',{signal:AbortSignal.timeout(5000)}).then(r=>r.json()).then(d=>{
    if(d.latitude&&d.longitude){myLat=d.latitude;myLng=d.longitude;onLocationReady('approx')}
    else return Promise.reject();
  }).catch(()=>{
    // Fallback: ip-api.com
    fetch('https://ipapi.co/json/',{signal:AbortSignal.timeout(5000)}).then(r=>r.json()).then(d=>{
      if(d.latitude&&d.longitude){myLat=d.latitude;myLng=d.longitude;onLocationReady('approx')}
      else onLocationFail();
    }).catch(()=>onLocationFail());
  });
}
function onLocationReady(mode){
  $('locStatus').className='loc-status active';
  $('locStatus').innerHTML=mode==='gps'?'&#x1F4CD; '+i18n('loc_active'):'&#x1F4CD; Localização aproximada (via rede)';
  updateLocationOnServer();
  loadLocTab();
}
function onLocationFail(){
  $('locStatus').className='loc-status error';
  $('locStatus').innerHTML='&#x1F6AB; GPS indisponível';
  let html='<div class="loc-empty"><div class="loc-empty-icon">&#x1F4CD;</div>';
  html+='Sem localização disponível.<br><small style="color:var(--t3)">No notebook o GPS pode não funcionar.<br>No celular com HTTPS funcionará.</small>';
  html+='<br><br><button type="button" class="bp" style="font-size:.8rem;max-width:240px;margin:0 auto" onclick="showCreateEventManual()">&#x1F4CD; Criar evento manualmente</button>';
  html+='</div>';
  $('locContent').innerHTML=html;
}
async function updateLocationOnServer(){
  if(!myLat||!state.userId)return;
  try{await fetch('/api/location/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,lat:myLat,lng:myLng})})}catch(e){}
}
function switchLocTab(tab){
  locTab=tab;
  $('tabNearby').classList.toggle('active',tab==='nearby');
  $('tabEvents').classList.toggle('active',tab==='events');
  loadLocTab();
}
function loadLocTab(){if(locTab==='nearby')loadNearbyPeople();else loadNearbyEvents()}
async function loadNearbyPeople(){
  const c=$('locContent');
  if(!myLat){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3)">'+i18n('loc_activate')+'</div>';return}
  c.innerHTML='<div style="text-align:center;padding:1rem;color:var(--t3)">'+i18n('loc_loading')+'</div>';
  try{
    const r=await fetch('/api/nearby/'+state.userId+'?radius=1000');
    const people=await r.json();
    if(!people.length){c.innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x1F465;</div>'+i18n('loc_no_people')+'</div>';return}
    let html='';
    people.forEach(p=>{
      const color=p.color||nickColor(p.nickname||p.name||'??');
      const nick=p.nickname||p.name||'?';
      const dist=p.distance<1000?Math.round(p.distance)+'m':((p.distance/1000).toFixed(1))+'km';
      html+='<div class="loc-person">';
      html+=makeAvatar(nick,color,36,p.profilePhoto||null);
      html+='<div class="loc-person-info"><div class="loc-person-nick">'+esc(nick)+'</div><div class="loc-person-dist">'+dist+'</div>';
      if(p.score||p.stars)html+='<div class="loc-person-pts">'+(p.score?'&#x26A1;'+p.score:'')+(p.stars?' ⭐'+p.stars:'')+'</div>';
      html+='</div>';
      html+='<button class="loc-encosta-btn" onclick="encostaFromLocation(\''+p.id+'\')">'+i18n('loc_encosta')+'</button>';
      html+='</div>';
    });
    c.innerHTML=html;
  }catch(e){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--err)">Erro ao buscar.</div>'}
}
async function loadNearbyEvents(){
  const c=$('locContent');
  if(!myLat){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3)">'+i18n('loc_activate')+'</div>';return}
  c.innerHTML='<div style="text-align:center;padding:1rem;color:var(--t3)">'+i18n('loc_loading')+'</div>';
  try{
    const r=await fetch('/api/events/nearby?lat='+myLat+'&lng='+myLng+'&radius=5000');
    const events=await r.json();
    if(!events.length){c.innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x1F389;</div>'+i18n('loc_no_events')+'<br><span style="font-size:.72rem;color:var(--ac);cursor:pointer" onclick="showCreateEvent()">'+i18n('create_event_btn')+'</span></div>';return}
    let html='';
    events.forEach(ev=>{
      const dist=ev.distance<1000?Math.round(ev.distance)+'m':((ev.distance/1000).toFixed(1))+'km';
      html+='<div class="evt-card" onclick="openEventDetail(\''+ev.id+'\')">';
      html+='<div class="evt-card-name">'+esc(ev.name)+'</div>';
      html+='<div class="evt-card-meta"><span>📍 '+dist+'</span><span>'+esc(ev.participantCount||0)+' '+i18n('evt_people')+'</span></div>';
      if(ev.description)html+='<div class="evt-card-desc">'+esc(ev.description)+'</div>';
      html+='</div>';
    });
    c.innerHTML=html;
  }catch(e){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--err)">Erro ao buscar.</div>'}
}
function showCreateEvent(){
  _renderEventForm();
}
function showCreateEventManual(){
  _renderEventForm();
}
function _renderEventForm(){
  // Try to get location first if we don't have it
  if(!myLat&&navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      myLat=pos.coords.latitude;myLng=pos.coords.longitude;
    },()=>{},{enableHighAccuracy:true,timeout:5000});
  }
  let html='<div class="loc-create-form">';
  html+='<div class="form-title">&#x1F4CD; '+i18n('create_event_title')+'</div>';
  html+='<div class="form-sub">Crie um ponto de encontro digital em um local físico. Quem estiver por perto poderá entrar e se conectar.</div>';
  if(myLat){
    html+='<div style="font-size:.65rem;color:var(--ok);margin-bottom:.6rem">📍 Localização detectada ('+myLat.toFixed(4)+', '+myLng.toFixed(4)+')</div>';
  }else{
    html+='<div style="font-size:.65rem;color:var(--ac2);margin-bottom:.6rem">📍 Sem GPS — insira as coordenadas manualmente</div>';
  }
  html+='<div class="loc-fg"><label>'+i18n('evt_name')+'</label><input type="text" id="evtName" maxlength="60" placeholder="'+i18n('evt_name_ph')+'"></div>';
  html+='<div class="loc-fg"><label>'+i18n('evt_desc')+'</label><textarea id="evtDesc" maxlength="200" placeholder="'+i18n('evt_desc_ph')+'"></textarea></div>';
  html+='<div class="loc-fg"><label>Latitude</label><input type="text" id="evtLat" value="'+(myLat||'')+'" placeholder="-23.550520"></div>';
  html+='<div class="loc-fg"><label>Longitude</label><input type="text" id="evtLng" value="'+(myLng||'')+'" placeholder="-46.633308"></div>';
  html+='<div style="font-size:.62rem;color:var(--t3);margin:-.4rem 0 .6rem;line-height:1.4">Dica: busque no Google Maps, clique no local e copie as coordenadas. Se o GPS estiver ativo, as coordenadas são preenchidas automaticamente.</div>';
  html+='<div class="loc-fg"><label>&#x1F4E1; '+i18n('evt_radius')+'</label>';
  html+='<div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.3rem">';
  ['50','100','200','500','1000'].forEach(r=>{
    const sel=r==='200'?'background:var(--ac);color:#fff;border-color:var(--ac)':'';
    html+='<button type="button" class="bs radius-opt" style="font-size:.68rem;padding:.3rem .6rem;'+sel+'" onclick="selectRadius(this,'+r+')">'+r+'m</button>';
  });
  html+='</div><input type="hidden" id="evtRadius" value="200"></div>';
  html+='<div style="display:flex;gap:.6rem;margin-top:.3rem"><button type="button" class="bp" style="flex:1" onclick="createEvent()">'+i18n('evt_create')+'</button><button type="button" class="bs" style="flex:1" onclick="loadLocTab()">'+i18n('evt_cancel')+'</button></div>';
  html+='</div>';
  $('locContent').innerHTML=html;
  setTimeout(()=>{const n=$('evtName');if(n)n.focus()},100);
}
function selectRadius(btn,val){
  document.querySelectorAll('.radius-opt').forEach(b=>{b.style.background='';b.style.color='';b.style.borderColor=''});
  btn.style.background='var(--ac)';btn.style.color='#fff';btn.style.borderColor='var(--ac)';
  $('evtRadius').value=val;
}
async function createEvent(){
  const name=$('evtName')?$('evtName').value.trim():'';
  const desc=$('evtDesc')?$('evtDesc').value.trim():'';
  const radius=parseInt($('evtRadius')?$('evtRadius').value:'200')||200;
  if(!name||name.length<3)return showToast(i18n('evt_name_err'));
  // Use GPS coords or manual input
  let lat=myLat,lng=myLng;
  if($('evtLat')){lat=parseFloat($('evtLat').value);lng=parseFloat($('evtLng').value)}
  if(!lat||!lng||isNaN(lat)||isNaN(lng))return showToast('Coordenadas inválidas.');
  try{
    const r=await fetch('/api/event/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,name,description:desc,lat,lng,radius})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast(i18n('evt_created'));haptic([50,30,50]);
    const evtId=d.event?d.event.id:d.id;
    const evtName=name;
    // Mark this user as the event OPERATOR so sonic-start sends isCheckin
    localStorage.setItem('activeEventId',evtId);
    localStorage.setItem('activeEventName',evtName);
    localStorage.setItem('activeEventRole','operator');
    showFloatingEventBtn(evtId,evtName);
    openEventDetail(evtId);
  }catch(e){showToast('Erro ao criar evento.')}
}
async function openEventDetail(eventId){
  showScreen('eventDetail');
  $('evtDetailScroll').innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x23F3;</div>'+i18n('loc_loading')+'</div>';
  try{
    const r=await fetch('/api/event/'+eventId);
    const ev=await r.json();
    if(ev.error){showToast(ev.error);return}
    $('evtDetailTitle').textContent=ev.name;
    const parts=ev.participantsData||ev.participants||[];
    const alreadyIn=parts.some(p=>p.id===state.userId);
    const pCount=parts.length;
    let html='<div class="evt-detail">';
    html+='<div class="evt-detail-name">'+esc(ev.name)+'</div>';
    if(ev.description)html+='<div class="evt-detail-desc">"'+esc(ev.description)+'"</div>';
    html+='<div style="display:flex;gap:.6rem;align-items:center;font-size:.68rem;color:var(--t3);margin-bottom:.8rem">';
    html+='<span>&#x1F4E1; '+ev.radius+'m</span>';
    html+='<span>&#x1F465; '+pCount+' '+i18n('evt_people')+'</span>';
    html+='</div>';
    if(!alreadyIn){
      html+='<button class="bp" style="font-size:.82rem" onclick="joinEvent(\''+eventId+'\')">&#x1F91D; '+i18n('evt_join')+'</button>';
    }else{
      html+='<div style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;color:var(--ok);padding:.5rem .7rem;background:rgba(52,211,153,.06);border-radius:10px;border:1px solid rgba(52,211,153,.15)">&#x2714; '+i18n('evt_joined')+'</div>';
    }
    html+='</div>';
    html+='<div class="evt-ppl-title">'+i18n('evt_participants')+' ('+pCount+')</div>';
    if(pCount>0){
      parts.forEach(p=>{
        const color=p.color||nickColor(p.nickname||p.name||'??');
        const nick=p.nickname||p.name||'?';
        const isMe=p.id===state.userId;
        html+='<div class="loc-person">';
        html+=makeAvatar(nick,color,34,p.profilePhoto||null);
        html+='<div class="loc-person-info"><div class="loc-person-nick">'+esc(nick)+(isMe?' <span style="font-size:.62rem;color:var(--ok)">('+i18n('evt_you')+')</span>':'')+'</div></div>';
        if(!isMe&&alreadyIn)html+='<button class="loc-encosta-btn" onclick="encostaAtEvent(\''+eventId+'\',\''+p.id+'\')">'+i18n('loc_encosta')+'</button>';
        html+='</div>';
      });
    }else html+='<div class="loc-empty"><div class="loc-empty-icon">&#x1F3C3;</div>'+i18n('evt_nobody')+'</div>';
    $('evtDetailScroll').innerHTML=html;
  }catch(e){$('evtDetailScroll').innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x26A0;</div>Erro ao carregar evento.</div>'}
}
async function joinEvent(eventId){
  try{
    const r=await fetch('/api/event/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId,userId:state.userId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast(i18n('evt_joined_msg'));haptic([50,30,50]);
    openEventDetail(eventId);
  }catch(e){showToast('Erro.')}
}
async function encostaAtEvent(eventId,partnerId){
  try{
    const r=await fetch('/api/event/encosta-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId,userId:state.userId,targetId:partnerId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Pedido enviado! Aguardando aceite...');haptic([50,30,50]);
  }catch(e){showToast('Erro ao conectar.')}
}
async function encostaFromLocation(targetId){
  // Start encounter via proximity - create a session and auto-match
  try{
    const r=await fetch('/api/session/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    // now the target joins
    const r2=await fetch('/api/session/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:d.code,userId:targetId})});
    const d2=await r2.json();
    if(d2.error)return showToast(d2.error);
    showToast(i18n('evt_encosta_ok'));haptic([80,40,80,40,80]);
    goHome();refreshHome();
  }catch(e){showToast('Erro ao conectar.')}
}

// ═══ i18n ═══
const LANG={
pt:{
  loc_btn:'Localização',ticket_btn:'Meu Bilhete',loc_title:'Explorar ao redor',
  create_event_btn:'+ Evento',loc_activate:'Ative sua localização para descobrir pessoas e eventos.',
  loc_searching:'Buscando localização...',loc_active:'📍 Localização ativa',
  loc_denied:'Localização negada. Permita no navegador.',tab_nearby:'Pessoas',tab_events:'Eventos',
  loc_loading:'Carregando...',loc_no_people:'Ninguém por perto no momento.',
  loc_no_events:'Nenhum evento por perto.',loc_encosta:'Touch',loc_need_gps:'Ative o GPS primeiro.',
  create_event_title:'Criar um evento',evt_name:'Nome',evt_name_ph:'Ex: Café no centro',
  evt_desc:'Descrição',evt_desc_ph:'Opcional...',evt_radius:'Raio',evt_create:'Criar',evt_cancel:'Cancelar',
  evt_name_err:'Nome precisa ter pelo menos 3 caracteres.',evt_created:'Evento criado!',
  evt_join:'Entrar neste evento',evt_joined:'Você está aqui',evt_joined_msg:'Você entrou no evento!',
  evt_participants:'Participantes',evt_you:'você',evt_nobody:'Ninguém ainda. Seja o primeiro!',
  evt_people:'pessoas',evt_encosta_ok:'Touch! Nova conexão criada.',
  // Home
  brand_name:'Touch?',brand_tag:'tudo nasce no gesto',
  home_greeting:'Olá',home_motto:'Nada acontece<br>à distância.',home_btn:'TOUCH',
  home_footer:'Tocar cria algo. Não tocar faz sumir.',
  sonic_searching:'Emitindo som ultrassônico...',sonic_approach:'Aproxime os celulares...',sonic_fallback:'Aproxime os celulares ou use código',
  // Register
  reg_title:'Touch?',reg_sub:'crie sua presença',reg_nick_hint:'escolha um apelido criativo',
  reg_nick:'Nickname',reg_birth:'Data de nascimento',
  reg_terms:'Entendo e aceito que <strong>todas as relações aqui são temporárias</strong>. Nada persiste sem encontro.',
  reg_btn:'ENTRAR',
  // Encounter
  enc_how:'Como vão se encontrar?',enc_create:'Criar encontro',enc_join:'Entrar com código',
  enc_share:'Compartilhe esse código:',enc_waiting:'Esperando alguém conectar...',
  enc_code_ph:'CÓDIGO',enc_join_btn:'TOUCH',
  // Reveal
  rev_phrase:'Uma frase para começar:',
  // Chat
  chat_msg_ph:'Diga algo que valha 24h...',chat_expired:'Esta conexão expirou.',
  // Profile
  pf_decl:'Declarações',pf_gifts:'Presentes recebidos',pf_empty_decl:'Nenhuma declaração ainda.',
  pf_empty_gift:'Nenhum presente ainda.',
  // Gift
  gift_title:'Escolha um presente',gift_msg_ph:'Mensagem (opcional)',gift_send:'Enviar presente',
  gift_needs_addr:'Requer endereço (pediremos permissão)',gift_sent:'Presente enviado!',
  // Decl
  decl_title:'Declaração',decl_sub:'Escreva algo para ficar no perfil dessa pessoa. Todos que se conectarem a ela poderão ler.',
  decl_ph:'Escreva sua declaração...',decl_publish:'Publicar',decl_min:'Escreva pelo menos 3 caracteres.',
  decl_ok:'Declaração publicada!',
  // Boarding
  bp_title:'Touch? Pass',bp_encounters:'encontros',bp_since:'desde',bp_save:'Salvar Imagem',
  // History
  hist_title:'Minha Rede',hist_empty:'Nenhum encontro ainda.',hist_save:'Salvar',hist_share:'Compartilhar'
},
en:{
  loc_btn:'Location',ticket_btn:'My Ticket',loc_title:'Explore nearby',
  create_event_btn:'+ Event',loc_activate:'Enable your location to discover people and events.',
  loc_searching:'Searching location...',loc_active:'📍 Location active',
  loc_denied:'Location denied. Allow in browser.',tab_nearby:'People',tab_events:'Events',
  loc_loading:'Loading...',loc_no_people:'Nobody nearby right now.',
  loc_no_events:'No events nearby.',loc_encosta:'Touch',loc_need_gps:'Enable GPS first.',
  create_event_title:'Create an event',evt_name:'Name',evt_name_ph:'E.g.: Coffee downtown',
  evt_desc:'Description',evt_desc_ph:'Optional...',evt_radius:'Radius',evt_create:'Create',evt_cancel:'Cancel',
  evt_name_err:'Name must be at least 3 characters.',evt_created:'Event created!',
  evt_join:'Join this event',evt_joined:'You are here',evt_joined_msg:'You joined the event!',
  evt_participants:'Participants',evt_you:'you',evt_nobody:'Nobody yet. Be the first!',
  evt_people:'people',evt_encosta_ok:'Touched! New connection created.',
  brand_name:'Touch?',brand_tag:'it all starts with a gesture',
  home_greeting:'Hello',home_motto:'Nothing happens<br>from a distance.',home_btn:'TOUCH',
  home_footer:'Touching creates something. Not touching makes it vanish.',
  sonic_searching:'Emitting ultrasonic sound...',sonic_approach:'Bring phones closer...',sonic_fallback:'Bring phones closer or use code',
  reg_title:'Touch?',reg_sub:'create your presence',reg_nick_hint:'choose a creative alias',
  reg_nick:'Nickname',reg_birth:'Date of birth',
  reg_terms:'I understand and accept that <strong>all relationships here are temporary</strong>. Nothing persists without encounter.',
  reg_btn:'ENTER',
  enc_how:'How will you meet?',enc_create:'Create encounter',enc_join:'Join with code',
  enc_share:'Share this code:',enc_waiting:'Waiting for someone to connect...',
  enc_code_ph:'CODE',enc_join_btn:'TOUCH',
  rev_phrase:'A phrase to begin:',
  chat_msg_ph:'Say something worth 24h...',chat_expired:'This connection has expired.',
  pf_decl:'Declarations',pf_gifts:'Gifts received',pf_empty_decl:'No declarations yet.',
  pf_empty_gift:'No gifts yet.',
  gift_title:'Choose a gift',gift_msg_ph:'Message (optional)',gift_send:'Send gift',
  gift_needs_addr:'Requires address (we\'ll ask permission)',gift_sent:'Gift sent!',
  decl_title:'Declaration',decl_sub:'Write something for this person\'s profile. Everyone who connects with them can read it.',
  decl_ph:'Write your declaration...',decl_publish:'Publish',decl_min:'Write at least 3 characters.',
  decl_ok:'Declaration published!',
  bp_title:'Touch? Ticket',bp_encounters:'encounters',bp_since:'since',bp_save:'Save Image',
  hist_title:'My Network',hist_empty:'No encounters yet.',hist_save:'Save',hist_share:'Share'
},
es:{
  loc_btn:'Ubicación',ticket_btn:'Mi Boleto',loc_title:'Explorar alrededor',
  create_event_btn:'+ Evento',loc_activate:'Activa tu ubicación para descubrir personas y eventos.',
  loc_searching:'Buscando ubicación...',loc_active:'📍 Ubicación activa',
  loc_denied:'Ubicación denegada. Permite en el navegador.',tab_nearby:'Personas',tab_events:'Eventos',
  loc_loading:'Cargando...',loc_no_people:'Nadie cerca por ahora.',
  loc_no_events:'No hay eventos cerca.',loc_encosta:'Tocar',loc_need_gps:'Activa el GPS primero.',
  create_event_title:'Crear un evento',evt_name:'Nombre',evt_name_ph:'Ej: Café en el centro',
  evt_desc:'Descripción',evt_desc_ph:'Opcional...',evt_radius:'Radio',evt_create:'Crear',evt_cancel:'Cancelar',
  evt_name_err:'El nombre debe tener al menos 3 caracteres.',evt_created:'¡Evento creado!',
  evt_join:'Unirse a este evento',evt_joined:'Estás aquí',evt_joined_msg:'¡Te uniste al evento!',
  evt_participants:'Participantes',evt_you:'tú',evt_nobody:'Nadie aún. ¡Sé el primero!',
  evt_people:'personas',evt_encosta_ok:'¡Tocó! Nueva conexión creada.',
  brand_name:'Touch?',brand_tag:'todo nace en el gesto',
  home_greeting:'Hola',home_motto:'Nada pasa<br>a distancia.',home_btn:'TOCAR',
  home_footer:'Tocar crea algo. No tocar lo hace desaparecer.',
  sonic_searching:'Emitiendo sonido ultrasónico...',sonic_approach:'Acerquen los celulares...',sonic_fallback:'Acerquen los celulares o usen código',
  reg_title:'Touch?',reg_sub:'crea tu presencia',reg_nick_hint:'elige un apodo creativo',
  reg_nick:'Nickname',reg_birth:'Fecha de nacimiento',
  reg_terms:'Entiendo y acepto que <strong>todas las relaciones aquí son temporales</strong>. Nada persiste sin encuentro.',
  reg_btn:'ENTRAR',
  enc_how:'¿Cómo se van a encontrar?',enc_create:'Crear encuentro',enc_join:'Entrar con código',
  enc_share:'Comparte este código:',enc_waiting:'Esperando que alguien conecte...',
  enc_code_ph:'CÓDIGO',enc_join_btn:'TOCAR',
  rev_phrase:'Una frase para empezar:',
  chat_msg_ph:'Di algo que valga 24h...',chat_expired:'Esta conexión expiró.',
  pf_decl:'Declaraciones',pf_gifts:'Regalos recibidos',pf_empty_decl:'Sin declaraciones aún.',
  pf_empty_gift:'Sin regalos aún.',
  gift_title:'Elige un regalo',gift_msg_ph:'Mensaje (opcional)',gift_send:'Enviar regalo',
  gift_needs_addr:'Requiere dirección (pediremos permiso)',gift_sent:'¡Regalo enviado!',
  decl_title:'Declaración',decl_sub:'Escribe algo para el perfil de esta persona. Todos los que se conecten con ella podrán leerlo.',
  decl_ph:'Escribe tu declaración...',decl_publish:'Publicar',decl_min:'Escribe al menos 3 caracteres.',
  decl_ok:'¡Declaración publicada!',
  bp_title:'Touch? Pass',bp_encounters:'encuentros',bp_since:'desde',bp_save:'Guardar Imagen',
  hist_title:'Mi Red',hist_empty:'Sin encuentros aún.',hist_save:'Guardar',hist_share:'Compartir'
}
};
let currentLang=localStorage.getItem('touch_lang')||'pt';
function i18n(key){return (LANG[currentLang]&&LANG[currentLang][key])||LANG.pt[key]||key}
function setLang(lang){
  currentLang=lang;
  localStorage.setItem('touch_lang',lang);
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active',b.textContent.trim().toLowerCase()===lang));
  applyLang();
}
function applyLang(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.getAttribute('data-i18n');
    const val=i18n(key);
    if(val)el.innerHTML=val;
  });
  // Update dynamic elements
  const brand=$('homeBrand');if(brand)brand.textContent=i18n('brand_name');
  const btnText=$('mainBtnText');if(btnText&&!homeSonicActive)btnText.textContent=i18n('home_btn');
}

// ═══ GORJETA / TIP ═══
let tipState = { receiverId: null, amount: 0, method: 'pix' };

function showTipScreen(receiverId) {
  tipState = { receiverId, amount: 0, savedCard: null };
  // Reset UI
  document.querySelectorAll('.tip-amount-btn').forEach(b => b.classList.remove('selected'));
  $('tipCustomAmount').value = '';
  $('tipResult').classList.add('hidden');
  $('tipScreen').querySelector('.tip-amounts').style.display = '';
  $('tipScreen').querySelector('.tip-custom').style.display = '';
  $('tipSavedCard').style.display = 'none';
  $('tipNewCard').style.display = 'none';
  $('tipPixSection').style.display = 'none';
  $('tipPayMethods').style.display = '';
  $('tipPixBtn') && ($('tipPixBtn').disabled = true);
  const tipPixQR = $('tipPixQR'); if (tipPixQR) tipPixQR.classList.add('hidden');
  if ($('tipPixEmail')) $('tipPixEmail').value = '';
  if ($('tipPixCPF')) $('tipPixCPF').value = '';
  if ($('tipSavedCVV')) $('tipSavedCVV').value = '';

  // Fetch receiver info
  fetch('/api/user/' + receiverId).then(r => r.json()).then(u => {
    const color = u.color || nickColor(u.nickname || '?');
    const serviceLabel = u.serviceLabel || '';
    const photo = u.profilePhoto || u.photoURL || null;
    const revData = state.revealedIds && state.revealedIds[receiverId];
    const displayPhoto = photo || (revData && revData.profilePhoto) || null;
    const displayName = (revData && revData.realName) || u.nickname || u.name;
    $('tipReceiver').innerHTML =
      makeAvatar(u.nickname || '?', color, 64, displayPhoto) +
      '<div class="tip-receiver-name">' + esc(displayName) + '</div>' +
      (serviceLabel ? '<div class="tip-receiver-service">' + esc(serviceLabel) + '</div>' : '');
  }).catch(() => {});

  // Check for saved card
  fetch('/api/tip/saved-card/' + state.userId).then(r => r.json()).then(d => {
    if (d.hasSaved) {
      tipState.savedCard = d;
      $('tipSavedCardLabel').textContent = d.brand + ' •••• ' + d.lastFour;
      // Update brand icon color
      const brandKey=(d.brand||'').toLowerCase();
      const brandInfo=CARD_BRANDS[brandKey==='mastercard'?'master':brandKey]||null;
      const sbi=$('tipSavedBrandIcon');
      if(sbi&&brandInfo){sbi.style.background=brandInfo.color;sbi.style.color='#fff';sbi.textContent=brandInfo.icon;sbi.title=brandInfo.name}
      else if(sbi){sbi.textContent=(d.brand||'CARD').slice(0,4).toUpperCase()}
      $('tipSavedCard').style.display = '';
      $('tipNewCardToggle').style.display = 'flex';
    } else {
      $('tipSavedCard').style.display = 'none';
      $('tipNewCardToggle').style.display = 'flex';
    }
  }).catch(() => {});

  showScreen('tipScreen');
}

function showNewCardForm() {
  $('tipPayMethods').style.display = 'none';
  $('tipNewCard').style.display = '';
  $('tipCardNumber').value = '';
  $('tipCardExpiry').value = '';
  $('tipCardCVV').value = '';
  $('tipCardHolder').value = '';
  $('tipCardCPF').value = '';
}
function validateSavedCVV() {
  updateTipBtns();
}
function payWithMercadoPago() {
  if (!tipState.amount || tipState.amount < 1) return showToast('Escolha um valor.');
  // Create preference and redirect to MP checkout
  const btn = $('tipMPBtn');
  btn.style.opacity = '.5'; btn.style.pointerEvents = 'none';
  fetch('/api/tip/mp-checkout', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ payerId: state.userId, receiverId: tipState.receiverId, amount: tipState.amount })
  }).then(r => r.json()).then(d => {
    if (d.initPoint) window.location.href = d.initPoint;
    else { showToast('Erro ao abrir Mercado Pago'); btn.style.opacity = '1'; btn.style.pointerEvents = ''; }
  }).catch(() => { showToast('Erro de conexão'); btn.style.opacity = '1'; btn.style.pointerEvents = ''; });
}
// Subscription payment methods
function validateSubCVV() {
  const cvv = $('subSavedCVV').value.replace(/\D/g, '');
  $('subCardPayBtn').disabled = cvv.length < 3;
}
async function subscribeWithCard() {
  const cvv = $('subSavedCVV').value.replace(/\D/g, '');
  if (cvv.length < 3) return showToast('Digite o CVV');
  const btn = $('subCardPayBtn');
  btn.disabled = true; btn.textContent = 'Processando...';
  try {
    const resp = await fetch('/api/subscription/create-card', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: state.userId, planId: 'touch_plus', cvv })
    });
    const result = await resp.json();
    if (result.error) {
      showPayError(translatePayError(result.error,result.detail));
      btn.disabled=false;btn.textContent='Assinar';
      return;
    }
    showToast('Assinatura ativada! ✦');
    haptic([50,30,50,30,50]);
    goHome();refreshHome();
  } catch (e) {
    showPayError(e.message||'Erro ao processar assinatura.');
    btn.disabled = false; btn.textContent = 'Assinar';
  }
}
async function subscribeWithPix() {
  showToast('PIX para assinatura em breve!');
}
function showSubNewCard() {
  showToast('Cadastre um cartão na tela de gorjeta primeiro.');
}
function loadSubSavedCard() {
  fetch('/api/tip/saved-card/' + state.userId).then(r => r.json()).then(d => {
    if (d.hasSaved) {
      $('subSavedCardLabel').textContent = d.brand + ' •••• ' + d.lastFour;
      const brandKey=(d.brand||'').toLowerCase();
      const brandInfo=CARD_BRANDS[brandKey==='mastercard'?'master':brandKey]||null;
      const sbi=$('subSavedBrandIcon');
      if(sbi&&brandInfo){sbi.style.background=brandInfo.color;sbi.style.color='#fff';sbi.textContent=brandInfo.icon}
      else if(sbi){sbi.textContent=(d.brand||'CARD').slice(0,4).toUpperCase()}
      $('subSavedCard').style.display = '';
    }
  }).catch(() => {});
}

function togglePixSection() {
  const sec = $('tipPixSection');
  const show = sec.style.display === 'none';
  sec.style.display = show ? '' : 'none';
  if (show) { $('tipPayMethods').style.display = 'none'; $('tipNewCard').style.display = 'none'; }
  else { $('tipPayMethods').style.display = ''; }
}


function selectTipAmount(val) {
  tipState.amount = val;
  $('tipCustomAmount').value = '';
  document.querySelectorAll('.tip-amount-btn').forEach(b => {
    b.classList.toggle('selected', b.textContent === 'R$' + val);
  });
  updateTipBtns();
}
function selectTipCustom() {
  const v = parseFloat($('tipCustomAmount').value);
  if (v > 0) {
    tipState.amount = v;
    document.querySelectorAll('.tip-amount-btn').forEach(b => b.classList.remove('selected'));
  }
  updateTipBtns();
}
function updateTipBtns() {
  const has = tipState.amount > 0;
  const label = has ? ' R$' + tipState.amount.toFixed(2).replace('.', ',') : '';
  // Saved card + CVV button
  const qpBtn = $('tipQuickPayBtn');
  const cvvVal = $('tipSavedCVV') ? $('tipSavedCVV').value.replace(/\D/g, '') : '';
  if (qpBtn) { qpBtn.disabled = !(has && cvvVal.length >= 3); qpBtn.textContent = has ? 'Pagar' + label : 'Pagar'; }
  // New card button
  const cpBtn = $('tipCardPayBtn');
  if (cpBtn) { cpBtn.disabled = !has; cpBtn.textContent = has ? 'Pagar' + label : 'Pagar'; }
  // PIX button
  const pxBtn = $('tipPixBtn');
  if (pxBtn) { pxBtn.disabled = !has; pxBtn.textContent = has ? 'PIX' + label : 'Gerar PIX'; }
}

// ── Card brand detection + visual feedback ──
const CARD_BRANDS={
  visa:{name:'Visa',color:'#1a1f71',icon:'V',regex:/^4/,lengths:[16],cvv:3},
  master:{name:'Mastercard',color:'#eb001b',icon:'M',regex:/^(5[1-5]|2[2-7])/,lengths:[16],cvv:3},
  amex:{name:'Amex',color:'#006fcf',icon:'A',regex:/^3[47]/,lengths:[15],cvv:4,mask:'amex'},
  elo:{name:'Elo',color:'#000',icon:'E',regex:/^(636368|636297|504175|438935|40117[89]|45763[12]|50904[0-9]|50905[0-9]|50906[0-9]|6277[0-9]{2}|6362[0-9]{2}|6504|6505|6506|6507|6509|6516|6550)/,lengths:[16],cvv:3},
  hipercard:{name:'Hipercard',color:'#8b2131',icon:'H',regex:/^(606282|3841)/,lengths:[16],cvv:3},
  diners:{name:'Diners',color:'#004a97',icon:'D',regex:/^3(0[0-5]|[68])/,lengths:[14],cvv:3}
};
function detectBrand(num){
  const clean=num.replace(/\D/g,'');
  for(const[id,b]of Object.entries(CARD_BRANDS)){
    if(b.regex.test(clean))return{id,...b};
  }
  return null;
}
function updateBrandIcon(inputEl,iconElId){
  const clean=inputEl.value.replace(/\D/g,'');
  const brand=detectBrand(clean);
  const iconEl=document.getElementById(iconElId);
  if(!iconEl)return brand;
  if(brand){
    iconEl.style.background=brand.color;
    iconEl.style.color='#fff';
    iconEl.textContent=brand.icon;
    iconEl.title=brand.name;
  }else{
    iconEl.style.background='linear-gradient(135deg,#1a1a2e,#2d2d44)';
    iconEl.style.color='rgba(255,255,255,.5)';
    iconEl.textContent='CARD';
    iconEl.title='';
  }
  return brand;
}
function formatCardNumber(el) {
  let v = el.value.replace(/\D/g, '');
  const brand=detectBrand(v);
  const maxLen=brand?Math.max(...brand.lengths):16;
  v=v.slice(0,maxLen);
  if(brand&&brand.mask==='amex'){
    // Amex: 4-6-5
    v=v.replace(/(\d{4})(\d{0,6})(\d{0,5})/,'$1 $2 $3').trim();
  }else{
    v=v.replace(/(.{4})/g,'$1 ').trim();
  }
  el.value=v;
  // Update brand icons in all card forms
  updateBrandIcon(el,'tipCardBrandIcon');
  updateBrandIcon(el,'entryCardBrandIcon');
  // Update CVV maxlength
  const cvvLen=brand?brand.cvv:4;
  const cvvEl=el.closest('div')?.parentElement?.querySelector('[id*="CVV"]');
  if(cvvEl)cvvEl.maxLength=cvvLen;
}
function formatExpiry(el) {
  let v = el.value.replace(/\D/g, '').slice(0, 4);
  if (v.length > 2) v = v.slice(0, 2) + '/' + v.slice(2);
  el.value = v;
}

function formatCPF(el) {
  let v = el.value.replace(/\D/g, '').slice(0, 11);
  if (v.length > 9) v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
  else if (v.length > 6) v = v.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
  else if (v.length > 3) v = v.replace(/(\d{3})(\d{1,3})/, '$1.$2');
  el.value = v;
}

// ── PIX Payment ──
async function processPixTip() {
  if (!tipState.amount || tipState.amount < 1) return showToast('Escolha um valor.');
  const cpf = ($('tipPixCPF').value || '').replace(/\D/g, '');
  if (!cpf || cpf.length < 11) return showToast('Informe seu CPF para PIX.');
  const email = $('tipPixEmail').value.trim() || '';
  if (!email) return showToast('Informe seu e-mail.');

  const btn = $('tipPixBtn');
  btn.disabled = true; btn.textContent = 'Gerando PIX...';
  try {
    const resp = await fetch('/api/tip/pix', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ payerId: state.userId, receiverId: tipState.receiverId, amount: tipState.amount, payerEmail: email, payerCPF: cpf })
    });
    const result = await resp.json();
    if (result.error) throw new Error(result.error);

    // Show QR code
    if (result.qrCodeBase64) {
      $('tipPixQRImg').src = 'data:image/png;base64,' + result.qrCodeBase64;
    } else if (result.ticketUrl) {
      $('tipPixQRImg').src = result.ticketUrl;
    }
    $('tipPixCode').value = result.qrCode || '';
    $('tipPixQR').classList.remove('hidden');
    btn.textContent = '✅ PIX gerado!';
    haptic([30, 20, 30]);

    // Poll for payment confirmation
    if (result.tipId) pollTipStatus(result.tipId);
  } catch (e) {
    console.error('PIX error:', e);
    showToast('Erro: ' + (e.message || 'Tente novamente'));
    btn.disabled = false;
    btn.textContent = '⚡ PIX R$' + tipState.amount.toFixed(2).replace('.', ',');
  }
}

function copyPixCode() {
  const code = $('tipPixCode').value;
  if (!code) return showToast('Nenhum código PIX.');
  navigator.clipboard.writeText(code).then(() => showToast('Código PIX copiado!')).catch(() => {
    // Fallback
    const ta = document.createElement('textarea'); ta.value = code; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    showToast('Código PIX copiado!');
  });
  haptic([20]);
}

function pollTipStatus(tipId) {
  let polls = 0;
  const iv = setInterval(async () => {
    polls++;
    if (polls > 60) { clearInterval(iv); return; } // Stop after 5 min
    try {
      const tips = await (await fetch('/api/tips/' + state.userId)).json();
      const tip = tips.find(t => t.id === tipId);
      if (tip && tip.status === 'approved') {
        clearInterval(iv);
        showTipResult('✅', 'PIX confirmado!<br>R$' + tip.amount.toFixed(2).replace('.', ',') + ' chegou.');
        haptic([50, 30, 50, 30, 50]);
      }
    } catch (e) {}
  }, 5000);
}

// ── MP SDK init ──
let mpSdk = null;
async function getMpSdk() {
  if (mpSdk) return mpSdk;
  try {
    const resp = await fetch('/api/mp-public-key');
    const { publicKey } = await resp.json();
    if (!publicKey) throw new Error('No public key');
    mpSdk = new MercadoPago(publicKey, { locale: 'pt-BR' });
    return mpSdk;
  } catch (e) { console.error('MP SDK init error:', e); return null; }
}
function getMpDeviceId(){
  // MercadoPago SDK sets this global when initialized
  try{ return window.MP_DEVICE_SESSION_ID || document.querySelector('input[name="mercadopago-session-id"]')?.value || null }catch(e){ return null }
}
function updateEntryBrandIcon(){
  const el=$('entryCardNumber');if(!el)return;
  updateBrandIcon(el,'entryBrandIcon');
}

// ── One-Tap Pay — server-side saved card charge, zero friction ──
async function quickPay() {
  if (!tipState.amount || tipState.amount < 1) return showToast('Escolha um valor.');
  const cvv = $('tipSavedCVV') ? $('tipSavedCVV').value.replace(/\D/g, '') : '';
  if (cvv.length < 3) return showToast('Digite o CVV do cartão.');
  const btn = $('tipQuickPayBtn');
  btn.disabled = true; btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:.3rem"><span class="pay-spinner"></span>Processando...</span>';
  haptic([30]);
  try {
    const resp = await fetch('/api/tip/quick-pay', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ payerId: state.userId, receiverId: tipState.receiverId, amount: tipState.amount, cvv })
    });
    const result = await resp.json();
    if (result.error) {
      if (result.cardExpired) {
        tipState.savedCard = null;
        $('tipSavedCard').style.display = 'none';
        $('tipNewCard').style.display = '';
        showPayError('Cartão expirado ou inválido. Cadastre novamente.');
        return;
      }
      showPayError(translatePayError(result.error,result.detail));
      btn.disabled=false;btn.textContent='Pagar R$'+tipState.amount.toFixed(2).replace('.',',');
      return;
    }
    if (result.status === 'approved') {
      showTipResult('✅', 'Gorjeta enviada!<br>R$' + tipState.amount.toFixed(2).replace('.', ','));
      haptic([50, 30, 50, 30, 50]);
    } else if (result.status === 'in_process' || result.status === 'pending') {
      showTipResult('⏳', 'Pagamento em processamento<br><span style="font-size:.6rem;color:var(--t3)">O banco está verificando. Pode levar alguns minutos.</span>');
      if (result.tipId) pollTipStatus(result.tipId);
    } else {
      showPayError(translatePayError(result.statusDetail||'rejected'));
      btn.disabled=false;btn.textContent='Pagar R$'+tipState.amount.toFixed(2).replace('.',',');
    }
  } catch (e) {
    console.error('One-tap error:', e);
    showPayError(e.message||'Erro ao processar. Tente novamente.');
    btn.disabled = false;
    btn.textContent = 'Pagar R$' + tipState.amount.toFixed(2).replace('.', ',');
  }
}

async function removeSavedCard() {
  if (!confirm('Remover cartão salvo?')) return;
  try {
    await fetch('/api/tip/saved-card/' + state.userId, { method: 'DELETE' });
    tipState.savedCard = null;
    $('tipSavedCard').style.display = 'none';
    $('tipNewCard').style.display = '';
    showToast('Cartão removido.');
  } catch (e) { showToast('Erro ao remover.'); }
}

// ── Pay with new card (tokenize → pay → save) ──
async function payWithNewCard() {
  if (!tipState.amount || tipState.amount < 1) return showToast('Escolha um valor.');
  const cardNum = $('tipCardNumber').value.replace(/\s/g, '');
  const expiry = $('tipCardExpiry').value;
  const cvv = $('tipCardCVV').value;
  const holder = $('tipCardHolder').value.trim();
  const cpf = $('tipCardCPF').value.replace(/\D/g, '');
  if (!cardNum || cardNum.length < 13) return showToast('Número do cartão inválido.');
  if (!expiry || expiry.length < 5) return showToast('Data de validade inválida.');
  if (!cvv || cvv.length < 3) return showToast('CVV inválido.');
  if (!holder) return showToast('Nome no cartão obrigatório.');
  if (!cpf || cpf.length < 11) return showToast('CPF inválido.');
  if (!state.email || state.email.includes('@touch.app')) return showPayError('Cadastre seu email no perfil antes de pagar.');

  const btn = $('tipCardPayBtn');
  btn.disabled = true; btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:.3rem"><span class="pay-spinner"></span>Processando...</span>';

  try {
    const mp = await getMpSdk();
    if (!mp) throw new Error('SDK de pagamento não disponível.');

    const [expMonth, expYear] = expiry.split('/');
    // Detect payment method from BIN
    const bin = cardNum.substring(0, 6);
    let payMethodId = 'visa';
    try {
      const pmResp = await fetch('https://api.mercadopago.com/v1/payment_methods/search?bins=' + bin + '&marketplace=NONE', {
        headers: { 'Authorization': 'Bearer ' + (await (await fetch('/api/mp-public-key')).json()).publicKey }
      });
      // Fallback: detect from first digit
    } catch(e) {}
    // Simple BIN detection fallback
    const d1 = cardNum[0], d2 = cardNum.substring(0,2);
    if (d1 === '5' || d2 === '22' || d2 === '23' || d2 === '24' || d2 === '25' || d2 === '26' || d2 === '27') payMethodId = 'master';
    else if (d1 === '4') payMethodId = 'visa';
    else if (d2 === '34' || d2 === '37') payMethodId = 'amex';
    else if (d2 === '60' || d2 === '65' || d2 === '63') payMethodId = 'elo';
    else if (d2 === '38' || d2 === '30') payMethodId = 'diners';

    const tokenResult = await mp.createCardToken({
      cardNumber: cardNum, cardholderName: holder,
      cardExpirationMonth: expMonth, cardExpirationYear: '20' + expYear,
      securityCode: cvv, identificationType: 'CPF', identificationNumber: cpf
    });
    if (!tokenResult || !tokenResult.id) throw new Error('Erro ao tokenizar cartão.');

    const resp = await fetch('/api/tip/create', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        payerId: state.userId, receiverId: tipState.receiverId, amount: tipState.amount,
        token: tokenResult.id, paymentMethodId: payMethodId,
        payerEmail: state.email, payerCPF: cpf
      })
    });
    const result = await resp.json();
    if (result.error) {
      showPayError(translatePayError(result.error,result.detail));
      btn.disabled=false;btn.textContent='💳 Pagar R$'+tipState.amount.toFixed(2).replace('.',',');
      return;
    }

    if (result.status === 'approved') {
      // Save card if checked
      if ($('tipSaveCardCheck').checked) {
        try {
          const saveToken = await mp.createCardToken({
            cardNumber: cardNum, cardholderName: holder,
            cardExpirationMonth: expMonth, cardExpirationYear: '20' + expYear,
            securityCode: cvv, identificationType: 'CPF', identificationNumber: cpf
          });
          if (saveToken?.id) {
            await fetch('/api/tip/save-card', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ userId: state.userId, token: saveToken.id, email: state.email || '', cpf })
            });
          }
        } catch (saveErr) { console.error('Save card error:', saveErr); }
      }
      showTipResult('✅', 'Gorjeta enviada!<br>R$' + tipState.amount.toFixed(2).replace('.', ','));
      haptic([50, 30, 50, 30, 50]);
    } else if (result.status === 'in_process' || result.status === 'pending') {
      showTipResult('⏳', 'Pagamento em processamento<br><span style="font-size:.6rem;color:var(--t3)">O banco está verificando. Pode levar alguns minutos.</span>');
    } else {
      showPayError(translatePayError(result.statusDetail||'rejected'));
      btn.disabled=false;btn.textContent='💳 Pagar R$'+tipState.amount.toFixed(2).replace('.',',');
    }
  } catch (e) {
    console.error('Card payment error:', e);
    showPayError(e.message||'Erro ao processar. Tente novamente.');
    btn.disabled = false;
    btn.textContent = '💳 Pagar R$' + tipState.amount.toFixed(2).replace('.', ',');
  }
}

function checkTipResultParam() {
  const params = new URLSearchParams(window.location.search);
  const tipResult = params.get('tipResult');
  if (tipResult) {
    if (tipResult === 'approved') showToast('Gorjeta confirmada! ✅');
    else if (tipResult === 'pending') showToast('Pagamento em processamento ⏳');
    else showToast('Pagamento não aprovado ❌');
    window.history.replaceState({}, '', window.location.pathname);
  }
}

// ── Translate MP payment errors to clear Portuguese ──
function translatePayError(msg,detail){
  const map={
    'cc_rejected_bad_filled_card_number':'Número do cartão está incorreto. Confira e tente novamente.',
    'cc_rejected_bad_filled_date':'Data de validade incorreta.',
    'cc_rejected_bad_filled_other':'Algum dado do cartão está errado. Confira todos os campos.',
    'cc_rejected_bad_filled_security_code':'CVV incorreto. Verifique o código atrás do cartão.',
    'cc_rejected_blacklist':'Seu cartão foi bloqueado pelo banco. Use outro cartão.',
    'cc_rejected_call_for_authorize':'O banco precisa que você autorize. Ligue para a central do cartão e tente novamente.',
    'cc_rejected_card_disabled':'Cartão desabilitado para compras online. Ative pelo app do banco.',
    'cc_rejected_duplicated_payment':'Pagamento duplicado. Aguarde alguns minutos antes de tentar novamente.',
    'cc_rejected_high_risk':'O banco rejeitou por segurança. Tente com outro cartão ou PIX.',
    'cc_rejected_insufficient_amount':'Saldo insuficiente no cartão.',
    'cc_rejected_invalid_installments':'Parcelas inválidas para este cartão.',
    'cc_rejected_max_attempts':'Muitas tentativas. Aguarde 24h ou use outro cartão.',
    'cc_rejected_other_reason':'Cartão recusado pelo banco. Tente outro cartão ou PIX.',
    'rejected':'Pagamento recusado pelo banco. Tente outro método.',
    'Cartão expirado ou cartão inválido':'Cartão expirado. Cadastre um novo cartão.',
    'CVV inválido ou cartão expirado':'CVV incorreto ou cartão expirado.',
    'customer_not_found':'Erro de cadastro no pagamento. Tente novamente ou cadastre outro cartão.',
    'Customer not found':'Erro de cadastro no pagamento. Tente novamente ou cadastre outro cartão.',
    'customer not found':'Erro de cadastro no pagamento. Tente novamente ou cadastre outro cartão.',
    'Informe seu email para continuar':'Informe seu email no perfil antes de pagar.',
    'Informe seu CPF para continuar':'Informe seu CPF no perfil antes de pagar.',
    'Cadastre seu email no perfil antes de assinar':'Cadastre seu email no perfil antes de assinar.'
  };
  // Check detail first, then msg
  if(detail&&map[detail])return map[detail];
  if(msg&&map[msg])return map[msg];
  // Check if msg contains a known key
  for(const[k,v]of Object.entries(map)){
    if(msg&&msg.includes(k))return v;
  }
  return msg||'Erro ao processar pagamento. Tente novamente.';
}
function showPayError(msg){
  // Show as a styled error toast that stays longer
  const el=document.createElement('div');
  el.style.cssText='position:fixed;top:60px;left:50%;transform:translateX(-50%);max-width:320px;width:90%;z-index:100000;animation:slideDown .3s ease';
  el.innerHTML='<div style="background:rgba(239,68,68,.95);backdrop-filter:blur(12px);color:#fff;padding:.8rem 1rem;border-radius:14px;font-size:.72rem;line-height:1.4;text-align:center;box-shadow:0 8px 32px rgba(239,68,68,.3)">'
    +'<div style="font-weight:700;margin-bottom:.2rem">Pagamento não aprovado</div>'
    +'<div style="opacity:.9">'+msg+'</div>'
    +'</div>';
  document.body.appendChild(el);
  setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .3s';setTimeout(()=>el.remove(),300)},5000);
}
function showTipResult(icon, text) {
  $('tipResult').classList.remove('hidden');
  $('tipResultIcon').textContent = icon;
  $('tipResultText').innerHTML = text;
  $('tipSavedCard').style.display = 'none';
  $('tipNewCard').style.display = 'none';
  $('tipPixSection').style.display = 'none';
  $('tipOtherMethods').style.display = 'none';
  $('tipScreen').querySelector('.tip-amounts').style.display = 'none';
  $('tipScreen').querySelector('.tip-custom').style.display = 'none';
}

// ═══ SERVIÇOS SCREEN ═══
function showServicosScreen(){
  haptic([30]);
  const isPrestador=localStorage.getItem('touch_isPrestador')==='1';
  // Build a simple screen with both options
  const overlay=document.createElement('div');
  overlay.className='more-menu-overlay';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
  const svcActive=localStorage.getItem('touch_serviceModeEnabled')==='1';
  let btns='<button class="my-pf-btn" onclick="this.closest(\'.more-menu-overlay\').remove();showPrestadorRegister()" style="margin-bottom:.4rem"><span class="my-pf-ico">edit</span>Cadastro de prestador</button>';
  if(isPrestador){
    // Service mode on/off toggle
    btns+='<div style="display:flex;align-items:center;justify-content:space-between;padding:.7rem .8rem;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);margin-bottom:.4rem">'
      +'<div><div style="font-size:.72rem;font-weight:600;color:var(--t1)">Modo Serviço na Home</div>'
      +'<div style="font-size:.55rem;color:var(--t3);margin-top:.1rem">Mostra botão de serviço na tela principal</div></div>'
      +'<label style="position:relative;width:44px;height:24px;flex-shrink:0;margin-left:.8rem;cursor:pointer">'
      +'<input type="checkbox" id="svcModeSwitch" onchange="toggleServiceModeEnabled(this.checked)" style="display:none"'+(svcActive?' checked':'')+'>'
      +'<span style="position:absolute;inset:0;border-radius:12px;background:'+(svcActive?'#22c55e':'rgba(255,255,255,.12)')+';transition:all .3s"></span>'
      +'<span style="position:absolute;top:2px;left:'+(svcActive?'22px':'2px')+';width:20px;height:20px;border-radius:50%;background:#fff;transition:all .3s;box-shadow:0 1px 3px rgba(0,0,0,.3)"></span>'
      +'</label></div>';
    btns+='<button class="my-pf-btn" onclick="this.closest(\'.more-menu-overlay\').remove();showPrestadorDash()"><span class="my-pf-ico">$</span>Painel financeiro</button>';
  }
  // Credit card management button
  btns+='<button class="my-pf-btn" onclick="this.closest(\'.more-menu-overlay\').remove();showCardManagement()" style="margin-top:.4rem"><span class="my-pf-ico">💳</span>Cartão de crédito</button>';
  overlay.innerHTML='<div class="more-menu-sheet" style="padding:1.5rem">'
    +'<div class="more-menu-handle"></div>'
    +'<div style="font-size:.9rem;font-weight:700;margin-bottom:.8rem">Serviços</div>'
    +'<div style="font-size:.65rem;color:var(--t3);margin-bottom:1rem">Cadastre-se como prestador, gerencie seu painel financeiro e configure seu cartão para pagamentos.</div>'
    +btns
    +'</div>';
  document.body.appendChild(overlay);
}

// ═══ CARD MANAGEMENT ═══
async function showCardManagement(){
  haptic([30]);
  const overlay=document.createElement('div');
  overlay.className='more-menu-overlay';
  overlay.id='cardMgmtOverlay';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
  overlay.innerHTML='<div class="more-menu-sheet" style="padding:1.5rem;max-height:85vh;overflow-y:auto">'
    +'<div class="more-menu-handle"></div>'
    +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">'
    +'<div style="font-size:.9rem;font-weight:700">Cartão de crédito</div>'
    +'<button class="chb" onclick="this.closest(\'.more-menu-overlay\').remove()" style="font-size:.8rem">✕</button>'
    +'</div>'
    +'<div style="font-size:.65rem;color:var(--t3);margin-bottom:1rem">Salve seu cartão para pagar gorjetas, ingressos e assinaturas com um toque.</div>'
    +'<div id="cmSaved" style="display:none">'
    +'<div style="padding:.8rem;border-radius:14px;background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.15)">'
    +'<div style="display:flex;align-items:center;gap:.6rem">'
    +'<div id="cmBrandIcon" style="width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:800;background:#6366f1;color:#fff">?</div>'
    +'<div style="flex:1"><div id="cmCardLabel" style="font-size:.75rem;font-weight:700;color:var(--t1)"></div>'
    +'<div style="font-size:.6rem;color:var(--t3);margin-top:.1rem">Cartão salvo para pagamentos</div></div>'
    +'</div>'
    +'<div style="display:flex;gap:.5rem;margin-top:.6rem">'
    +'<button onclick="cmRemoveCard()" style="flex:1;padding:.45rem;border-radius:10px;border:1px solid rgba(239,68,68,.2);background:rgba(239,68,68,.06);color:#ef4444;font-size:.65rem;font-weight:600;font-family:inherit;cursor:pointer">Remover cartão</button>'
    +'<button onclick="cmShowNewForm()" style="flex:1;padding:.45rem;border-radius:10px;border:1px solid rgba(99,102,241,.2);background:rgba(99,102,241,.06);color:#6366f1;font-size:.65rem;font-weight:600;font-family:inherit;cursor:pointer">Trocar cartão</button>'
    +'</div></div></div>'
    +'<div id="cmNewForm" style="display:none">'
    +'<div style="display:flex;flex-direction:column;gap:.5rem">'
    +'<div style="position:relative"><input id="cmCardNum" type="tel" inputmode="numeric" maxlength="19" placeholder="Número do cartão" style="width:100%;padding:.6rem .8rem .6rem 2.4rem;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--t1);font-size:.75rem;font-family:inherit;outline:none;box-sizing:border-box" oninput="cmFormatCard(this)">'
    +'<div id="cmBrandBadge" style="position:absolute;left:.6rem;top:50%;transform:translateY(-50%);width:22px;height:16px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:.5rem;font-weight:800;background:rgba(255,255,255,.08);color:var(--t3)">?</div></div>'
    +'<div style="display:flex;gap:.4rem">'
    +'<input id="cmExpiry" type="tel" inputmode="numeric" maxlength="5" placeholder="MM/AA" style="flex:1;padding:.6rem .8rem;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--t1);font-size:.75rem;font-family:inherit;outline:none" oninput="cmFormatExpiry(this)">'
    +'<input id="cmCVV" type="tel" inputmode="numeric" maxlength="4" placeholder="CVV" style="flex:1;padding:.6rem .8rem;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--t1);font-size:.75rem;font-family:inherit;outline:none">'
    +'</div>'
    +'<input id="cmHolder" type="text" placeholder="Nome impresso no cartão" style="width:100%;padding:.6rem .8rem;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--t1);font-size:.75rem;font-family:inherit;outline:none;box-sizing:border-box;text-transform:uppercase">'
    +'<input id="cmCPF" type="tel" inputmode="numeric" maxlength="14" placeholder="CPF do titular" style="width:100%;padding:.6rem .8rem;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--t1);font-size:.75rem;font-family:inherit;outline:none;box-sizing:border-box" oninput="cmFormatCPF(this)">'
    +'<button id="cmSaveBtn" onclick="cmSaveCard()" style="width:100%;padding:.7rem;border-radius:12px;border:none;background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;font-size:.75rem;font-weight:700;font-family:inherit;cursor:pointer;margin-top:.3rem">Salvar cartão</button>'
    +'</div></div>'
    +'<div id="cmStatus" style="display:none;text-align:center;padding:.6rem;border-radius:10px;font-size:.65rem;margin-top:.5rem"></div>'
    +'</div>';
  document.body.appendChild(overlay);
  // Load saved card status
  cmLoadCard();
}
async function cmLoadCard(){
  try{
    const r=await fetch('/api/tip/saved-card/'+state.userId);
    const d=await r.json();
    if(d.hasSaved){
      const brandKey=(d.brand||'').toLowerCase();
      const bi=CARD_BRANDS[brandKey==='mastercard'?'master':brandKey]||null;
      const icon=$('cmBrandIcon');
      if(icon&&bi){icon.style.background=bi.color;icon.textContent=bi.icon}
      else if(icon){icon.textContent=(d.brand||'?').slice(0,2).toUpperCase()}
      $('cmCardLabel').textContent=(d.brand||'Cartão')+' •••• '+d.lastFour;
      $('cmSaved').style.display='';
      $('cmNewForm').style.display='none';
    }else{
      $('cmSaved').style.display='none';
      $('cmNewForm').style.display='';
    }
  }catch(e){$('cmSaved').style.display='none';$('cmNewForm').style.display=''}
}
function cmShowNewForm(){
  $('cmSaved').style.display='none';
  $('cmNewForm').style.display='';
}
async function cmRemoveCard(){
  if(!confirm('Remover cartão salvo?'))return;
  try{
    await fetch('/api/tip/saved-card/'+state.userId,{method:'DELETE'});
    $('cmSaved').style.display='none';
    $('cmNewForm').style.display='';
    cmShowStatus('Cartão removido.','var(--t3)');
    // Also clear tip screen saved card
    if(typeof tipState!=='undefined')tipState.savedCard=null;
    const tsc=$('tipSavedCard');if(tsc)tsc.style.display='none';
    showToast('Cartão removido.');
  }catch(e){showToast('Erro ao remover.')}
}
function cmShowStatus(msg,color){
  const el=$('cmStatus');if(!el)return;
  el.style.display='';el.style.color=color||'var(--t3)';el.textContent=msg;
  setTimeout(()=>{el.style.display='none'},4000);
}
function cmFormatCard(el){
  let v=el.value.replace(/\D/g,'');
  if(v.length>16)v=v.slice(0,16);
  el.value=v.replace(/(.{4})/g,'$1 ').trim();
  // Update brand badge
  const brand=detectBrand(v);
  const badge=$('cmBrandBadge');
  if(badge&&brand){badge.style.background=brand.color;badge.style.color='#fff';badge.textContent=brand.icon}
  else if(badge){badge.style.background='rgba(255,255,255,.08)';badge.style.color='var(--t3)';badge.textContent='?'}
}
function cmFormatExpiry(el){
  let v=el.value.replace(/\D/g,'');
  if(v.length>4)v=v.slice(0,4);
  if(v.length>=3)v=v.slice(0,2)+'/'+v.slice(2);
  el.value=v;
}
function cmFormatCPF(el){
  let v=el.value.replace(/\D/g,'');
  if(v.length>11)v=v.slice(0,11);
  if(v.length>9)v=v.slice(0,3)+'.'+v.slice(3,6)+'.'+v.slice(6,9)+'-'+v.slice(9);
  else if(v.length>6)v=v.slice(0,3)+'.'+v.slice(3,6)+'.'+v.slice(6);
  else if(v.length>3)v=v.slice(0,3)+'.'+v.slice(3);
  el.value=v;
}
async function cmSaveCard(){
  const cardNum=$('cmCardNum').value.replace(/\s/g,'');
  const expiry=$('cmExpiry').value;
  const cvv=$('cmCVV').value;
  const holder=$('cmHolder').value.trim();
  const cpf=$('cmCPF').value.replace(/\D/g,'');
  if(!cardNum||cardNum.length<13)return showToast('Número do cartão inválido.');
  if(!expiry||expiry.length<5)return showToast('Data de validade inválida.');
  if(!cvv||cvv.length<3)return showToast('CVV inválido.');
  if(!holder)return showToast('Nome no cartão obrigatório.');
  if(!cpf||cpf.length<11)return showToast('CPF inválido.');
  const btn=$('cmSaveBtn');
  btn.disabled=true;btn.innerHTML='<span style="display:inline-flex;align-items:center;gap:.3rem"><span class="pay-spinner"></span>Salvando...</span>';
  try{
    const mp=await getMpSdk();
    if(!mp)throw new Error('SDK de pagamento não disponível.');
    const[expMonth,expYear]=expiry.split('/');
    const tokenResult=await mp.createCardToken({
      cardNumber:cardNum,cardholderName:holder,
      cardExpirationMonth:expMonth,cardExpirationYear:'20'+expYear,
      securityCode:cvv,identificationType:'CPF',identificationNumber:cpf
    });
    if(!tokenResult||!tokenResult.id)throw new Error('Erro ao tokenizar cartão.');
    const resp=await fetch('/api/tip/save-card',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userId:state.userId,token:tokenResult.id,email:state.email||'',cpf})
    });
    const result=await resp.json();
    if(result.error)throw new Error(result.error);
    btn.disabled=false;btn.textContent='Salvar cartão';
    cmShowStatus('✅ Cartão salvo com sucesso!','#10b981');
    haptic([30,20,30]);
    showToast('Cartão salvo!');
    cmLoadCard();
  }catch(e){
    console.error('Card save error:',e);
    btn.disabled=false;btn.textContent='Salvar cartão';
    cmShowStatus('❌ '+(e.message||'Erro ao salvar. Tente novamente.'),'#ef4444');
  }
}

// ═══ PRESTADOR REGISTER ═══
let pregSelectedService = null;

// ═══ PRESTADOR DASHBOARD ═══
async function showPrestadorDash() {
  showScreen('prestadorDash');
  $('pdStats').innerHTML = '<div style="text-align:center;grid-column:1/-1;padding:1rem;color:var(--t3);font-size:.7rem">Carregando...</div>';
  $('pdTips').innerHTML = '';
  $('pdEncounters').innerHTML = '';
  try {
    const resp = await fetch('/api/prestador/' + state.userId + '/dashboard');
    const d = await resp.json();
    if (d.error) throw new Error(d.error);

    // Stats cards
    const fmt = v => 'R$' + v.toFixed(2).replace('.', ',');
    $('pdStats').innerHTML =
      pdCard('Total recebido', fmt(d.stats.totalReceived), '#6366f1', d.stats.totalCount + ' gorjetas') +
      pdCard('Líquido (após taxa)', fmt(d.stats.totalNet), '#10b981', '10% taxa Touch?');

    // Period cards
    $('pdPeriods').innerHTML =
      pdMini('Hoje', fmt(d.stats.todayTotal), d.stats.todayCount) +
      pdMini('Semana', fmt(d.stats.weekTotal), d.stats.weekCount) +
      pdMini('Mês', fmt(d.stats.monthTotal), d.stats.monthCount);

    // MP status
    if (d.mpConnected) {
      $('pdMpStatus').innerHTML = '<div style="padding:.5rem;border-radius:12px;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);font-size:.65rem;color:#10b981;text-align:center">✅ Conta Mercado Pago conectada — gorjetas caem direto na sua conta</div>';
    } else {
      $('pdMpStatus').innerHTML = '<div style="padding:.5rem;border-radius:12px;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);font-size:.65rem;color:#fbbf24;text-align:center">⚠️ Conta MP não conectada — gorjetas ficam com a plataforma Touch?</div>';
    }

    // Tips list
    if (d.tips.length === 0) {
      $('pdTips').innerHTML = '<div style="padding:.8rem;text-align:center;color:var(--t3);font-size:.65rem;background:rgba(255,255,255,.03);border-radius:12px">Nenhuma gorjeta recebida ainda</div>';
    } else {
      $('pdTips').innerHTML = d.tips.map(t => {
        const date = new Date(t.createdAt);
        const time = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
        const statusIcon = t.status === 'approved' ? '✅' : t.status === 'pending' ? '⏳' : '❌';
        return '<div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem .6rem;background:rgba(255,255,255,.03);border-radius:10px;margin-bottom:.3rem">' +
          '<div><div style="font-size:.7rem;font-weight:600;color:var(--t1)">' + statusIcon + ' ' + fmt(t.amount) + '</div>' +
          '<div style="font-size:.55rem;color:var(--t3)">' + esc(t.payerName) + ' · ' + time + '</div></div>' +
          '<div style="text-align:right"><div style="font-size:.6rem;color:#10b981;font-weight:600">+' + fmt(t.net) + '</div>' +
          '<div style="font-size:.5rem;color:var(--t3)">taxa ' + fmt(t.fee) + '</div></div></div>';
      }).join('');
    }

    // Encounters list
    if (d.encounters.length === 0) {
      $('pdEncounters').innerHTML = '<div style="padding:.8rem;text-align:center;color:var(--t3);font-size:.65rem;background:rgba(255,255,255,.03);border-radius:12px">Nenhuma encostada recebida ainda</div>';
    } else {
      $('pdEncounters').innerHTML = d.encounters.map(e => {
        const date = new Date(e.timestamp);
        const time = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
        const tipInfo = e.tipAmount > 0 ? ' · 💰 ' + fmt(e.tipAmount) + (e.tipStatus === 'approved' ? ' ✅' : ' ⏳') : '';
        return '<div style="display:flex;align-items:center;gap:.5rem;padding:.4rem .6rem;background:rgba(255,255,255,.03);border-radius:10px;margin-bottom:.3rem">' +
          '<div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#4f46e5);display:flex;align-items:center;justify-content:center;font-size:.55rem;color:#fff;font-weight:700;flex-shrink:0">' + esc(e.nickname[0] || '?') + '</div>' +
          '<div><div style="font-size:.7rem;font-weight:600;color:var(--t1)">' + esc(e.nickname) + tipInfo + '</div>' +
          '<div style="font-size:.55rem;color:var(--t3)">' + time + '</div></div></div>';
      }).join('');
    }
  } catch (e) {
    console.error('Dashboard error:', e);
    $('pdStats').innerHTML = '<div style="text-align:center;grid-column:1/-1;padding:1rem;color:var(--err);font-size:.7rem">Erro ao carregar: ' + (e.message || '') + '</div>';
  }
}

function pdCard(label, value, color, sub) {
  return '<div style="padding:.6rem;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)">' +
    '<div style="font-size:.55rem;color:var(--t3);margin-bottom:.2rem">' + label + '</div>' +
    '<div style="font-size:1.1rem;font-weight:800;color:' + color + '">' + value + '</div>' +
    '<div style="font-size:.5rem;color:var(--t3);margin-top:.15rem">' + sub + '</div></div>';
}

function pdMini(label, value, count) {
  return '<div style="padding:.5rem;border-radius:12px;background:rgba(255,255,255,.03);text-align:center">' +
    '<div style="font-size:.5rem;color:var(--t3)">' + label + '</div>' +
    '<div style="font-size:.8rem;font-weight:700;color:var(--t1)">' + value + '</div>' +
    '<div style="font-size:.5rem;color:var(--t3)">' + count + ' gorj.</div></div>';
}

function showPrestadorRegister() {
  showScreen('prestadorReg');
  // Pre-fill if user already exists
  if (state.userId && state.userName) {
    $('pregNick').value = state.userName;
    $('pregNick').disabled = true; // Can't change nickname of existing user
    // Fetch full user info to pre-fill name
    fetch('/api/user/' + state.userId).then(r => r.json()).then(u => {
      if (u.name) $('pregName').value = u.name;
      if (u.birthdate) $('pregBirth').value = u.birthdate;
      if (u.isPrestador) {
        $('pregSubmitBtn').textContent = 'Atualizar serviço';
        // Show already-prestador status
        $('pregMpStatus').style.display = 'block';
        $('pregMpText').textContent = u.mpConnected ? '✅ MercadoPago conectado' : 'Conecte MercadoPago para receber pagamentos';
        if (!u.mpConnected) { $('pregMpBtn').style.display = 'block'; }
      }
    }).catch(() => {});
  } else {
    $('pregNick').value = '';
    $('pregNick').disabled = false;
    $('pregSubmitBtn').textContent = 'Criar conta de prestador';
    $('pregMpStatus').style.display = 'none';
    $('pregMpBtn').style.display = 'none';
  }
  // Load service types
  const grid = $('pregServices');
  pregSelectedService = null;
  fetch('/api/service-types').then(r => r.json()).then(types => {
    grid.innerHTML = '';
    types.forEach(t => {
      const btn = document.createElement('button');
      btn.className = 'preg-svc';
      btn.textContent = t.label;
      btn.onclick = () => {
        pregSelectedService = t.id;
        grid.querySelectorAll('.preg-svc').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      };
      grid.appendChild(btn);
    });
  });
}

function checkPregNick(val) {
  const hint = $('pregNickHint');
  const nick = val.trim();
  if (!nick || nick.length < 2) { hint.textContent = 'mínimo 2 caracteres'; hint.className = 'nick-hint'; return; }
  if (!/^[a-zA-Z0-9_.-]+$/.test(nick)) { hint.textContent = 'só letras, números, _ . -'; hint.className = 'nick-hint taken'; return; }
  fetch('/api/check-nick/' + encodeURIComponent(nick)).then(r => r.json()).then(d => {
    if (d.available) { hint.textContent = '✓ disponível'; hint.className = 'nick-hint ok'; }
    else { hint.textContent = 'já existe'; hint.className = 'nick-hint taken'; }
  });
}

async function registerPrestador() {
  const name = $('pregName').value.trim();
  const nick = $('pregNick').value.trim();
  const cpf = $('pregCPF').value.trim();
  const birth = $('pregBirth').value;
  if (!name) return showToast('Preencha o nome.');
  if (!pregSelectedService) return showToast('Escolha o tipo de serviço.');

  // If user already has account, convert to prestador (keep same userId)
  const existingId = state.userId || null;
  if (!existingId && (!nick || nick.length < 2)) return showToast('Preencha o nickname.');

  try {
    const body = { serviceType: pregSelectedService, fullName: name, cpf, birthdate: birth || null };
    if (existingId) body.userId = existingId;
    if (nick) body.nickname = nick;
    const resp = await fetch('/api/prestador/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await resp.json();
    if (data.error) return showToast(data.error);
    // Update local state (keep same userId if converting)
    state.userId = data.userId;
    state.userName = data.user.nickname;
    state.userColor = data.user.color;
    localStorage.setItem('touch_userId', data.userId);
    localStorage.setItem('touch_userName', data.user.nickname);
    localStorage.setItem('touch_userColor', data.user.color);
    localStorage.setItem('touch_isPrestador', '1');
    showToast(existingId ? 'Conta atualizada! Agora você é prestador.' : 'Conta criada!');
    // Show MP connect option
    $('pregSubmitBtn').style.display = 'none';
    $('pregMpBtn').style.display = 'block';
    $('pregMpStatus').style.display = 'block';
    $('pregMpText').textContent = 'Agora conecte sua conta MercadoPago para receber pagamentos.';
  } catch (e) { showToast('Erro: ' + e.message); }
}

function connectMercadoPago() {
  if (!state.userId) return showToast('Crie a conta primeiro.');
  window.location.href = '/mp/auth/' + state.userId;
}

// ═══ PULL TO REFRESH (Home) ═══
(function(){
  const home=$('home');if(!home)return;
  let ptrStartY=0,ptrActive=false,ptrTriggered=false;
  const indicator=$('ptrIndicator');
  const threshold=60;
  home.addEventListener('touchstart',e=>{
    if(!home.classList.contains('active'))return;
    ptrStartY=e.touches[0].clientY;ptrActive=true;ptrTriggered=false;
  },{passive:true});
  home.addEventListener('touchmove',e=>{
    if(!ptrActive)return;
    const dy=e.touches[0].clientY-ptrStartY;
    if(dy>20&&dy<150){
      indicator.classList.add('pulling');
      indicator.classList.remove('refreshing');
    }
    if(dy>threshold)ptrTriggered=true;
  },{passive:true});
  home.addEventListener('touchend',()=>{
    if(ptrTriggered){
      indicator.classList.remove('pulling');
      indicator.classList.add('refreshing');
      refreshHome();
      setTimeout(()=>{indicator.classList.remove('refreshing')},1200);
    }else{
      indicator.classList.remove('pulling');
    }
    ptrActive=false;ptrTriggered=false;
  },{passive:true});
})();

// ═══ EVENTS ═══
$('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();sendMessage()}});
$('chatInput').addEventListener('input',()=>{handleTyping();updateSendBtn()});
$('chatInput').addEventListener('focus',()=>closePlusMenu());
document.addEventListener('click',e=>{const pm=$('plusMenu');if(pm&&pm.classList.contains('open')&&!pm.contains(e.target)&&!e.target.closest('.cia-plus'))closePlusMenu()});
$('joinCodeInput').addEventListener('keydown',e=>{if(e.key==='Enter')joinSession()});
if(window.visualViewport){let ph=window.visualViewport.height;window.visualViewport.addEventListener('resize',()=>{if($('chat').classList.contains('active')&&window.visualViewport.height<ph)requestAnimationFrame(()=>{$('chatMessages').scrollTop=99999});ph=window.visualViewport.height})}

// ═══ RESOURCE CLEANUP + SCREENSHOT PROTECTION ═══
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){
    // Save sonic state BEFORE releasing
    _sonicWasActive=homeSonicActive;
    // Release mic, speaker, camera when app goes to background
    releaseAllMedia();
    // Blur chat for screenshot protection
    if($('chat').classList.contains('active'))$('chatMessages').style.filter='blur(20px)';
  }else{
    // ── RETURNED TO FOREGROUND ──
    $('chatMessages').style.filter='';
    // Re-identify on socket in case connection was lost/stale
    if(socket&&state.userId){
      if(!socket.connected){
        // Force reconnect
        socket.connect();
      }else{
        socket.emit('identify',state.userId);
      }
    }
    // Auto-restart sonic if it was active before going to background
    if(_sonicWasActive&&state.userId){
      _sonicWasActive=false;
      console.log('[visibility] Sonic was active, auto-restarting...');
      // Small delay to let socket reconnect and audio subsystem wake up
      setTimeout(()=>{
        if(!homeSonicActive&&!sonicActive){
          handleMainButton();
        }
      },600);
    }
  }
});
// Also cleanup on page close/navigate away
window.addEventListener('beforeunload',()=>releaseAllMedia());
window.addEventListener('pagehide',()=>releaseAllMedia());
// iOS Safari: pageshow event fires when returning from app switcher
window.addEventListener('pageshow',(e)=>{
  if(e.persisted&&state.userId&&socket){
    // Page was restored from bfcache — socket is likely dead
    console.log('[pageshow] bfcache restore, reconnecting...');
    if(!socket.connected)socket.connect();
    else socket.emit('identify',state.userId);
    // If sonic was active, restart
    if(_sonicWasActive){
      _sonicWasActive=false;
      setTimeout(()=>{if(!homeSonicActive)handleMainButton()},800);
    }
  }
});
// Android fallback: some browsers fire 'focus' but not 'visibilitychange'
window.addEventListener('focus',()=>{
  if(document.hidden)return; // let visibilitychange handle it
  if(socket&&state.userId){
    if(!socket.connected)socket.connect();
    // Resume any suspended AudioContexts inline (iOS requires user gesture but focus is close)
    if(sonicEmitCtx&&sonicEmitCtx.state==='suspended')sonicEmitCtx.resume().catch(()=>{});
    if(sonicMicCtx&&sonicMicCtx.state==='suspended')sonicMicCtx.resume().catch(()=>{});
  }
  // If sonic died (contexts closed/interrupted) but flag says it should be on, restart
  if(_sonicWasActive&&!homeSonicActive){
    _sonicWasActive=false;
    setTimeout(()=>{if(!homeSonicActive)handleMainButton()},500);
  }
});
// Block keyboard screenshot shortcuts (partial - won't work on all platforms)
document.addEventListener('keyup',e=>{
  if(e.key==='PrintScreen'&&$('chat').classList.contains('active')){
    $('chatMessages').style.filter='blur(20px)';
    showToast('Screenshots não permitidos no chat.');
    setTimeout(()=>{$('chatMessages').style.filter=''},1500);
  }
});

// ═══ INIT ═══
async function validateUser(){
  if(!state.userId)return false;
  try{
    const r=await fetch('/api/user/'+state.userId);
    if(!r.ok){localStorage.removeItem('touch_userId');localStorage.removeItem('touch_userName');state.userId=null;state.userName=null;return false}
    return true;
  }catch(e){return false}
}
window.addEventListener('load',()=>{
  applyLang();
  const qr=new URLSearchParams(location.search).get('code');
  setTimeout(async()=>{
    if(state.userId&&await validateUser()){
      initSocket();requestAccelPermission();
      // Set home avatar
      const _ha=$('homeAvatar');if(_ha&&state.userName){_ha.innerHTML=makeAvatar(state.userName,state.userColor||nickColor(state.userName),40,state.userPhoto||null,false,state.userAccessory||null);_ha.style.background='none';_ha.style.overflow='visible'}
      if(qr){showScreen('home');$('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(state.userName)+'</span>';setTimeout(()=>{$('joinCodeInput').value=qr;showScreen('encounter');showPhase('phaseChoose');joinSession();history.replaceState({},'','/')},300)}
      else{showScreen('home');$('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(state.userName)+'</span>'}
      refreshHome();restoreFloatingEvent();checkTipResultParam();checkSubResultParam();
    }else{
      // Show onboarding for first-time users, login for returning
      if(!localStorage.getItem('touch_onboarded')){
        initOnboarding();
        showScreen('onboarding');
      }else{
        showScreen('login');
      }
    }
  },1800);
});

// ═══ FACE ID — ENROLLMENT & VERIFICATION ═══
let _faceModelsLoaded=false;
let _faceStream=null;
let _faceDescriptors=[];
let _faceCapturing=false;
let _faceScanAnim=null;
const FACE_CAPTURES_NEEDED=5; // 5 angles

function stopFaceCamera(){
  _faceCapturing=false;
  if(_faceScanAnim){cancelAnimationFrame(_faceScanAnim);_faceScanAnim=null}
  if(_faceStream){_faceStream.getTracks().forEach(t=>t.stop());_faceStream=null}
}

function updateFaceSteps(idx,total){
  for(let i=1;i<=total;i++){
    const el=$('faceStep'+i);
    if(!el)continue;
    if(i<=idx){el.style.background='#06b6d4';el.style.transform='scale(1.3)'}
    else{el.style.background='rgba(255,255,255,.12)';el.style.transform='scale(1)'}
  }
}

function startFaceScanAnim(){
  const line=$('faceScanLine');
  if(!line)return;
  line.style.opacity='1';
  let pos=0,dir=1;
  function animate(){
    pos+=dir*1.5;
    if(pos>100)dir=-1;
    if(pos<0)dir=1;
    line.style.top=pos+'%';
    _faceScanAnim=requestAnimationFrame(animate);
  }
  _faceScanAnim=requestAnimationFrame(animate);
}

function stopFaceScanAnim(){
  if(_faceScanAnim){cancelAnimationFrame(_faceScanAnim);_faceScanAnim=null}
  const line=$('faceScanLine');
  if(line)line.style.opacity='0';
}

async function loadFaceModels(){
  if(_faceModelsLoaded)return true;
  try{
    const MODEL_URL='https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
    await Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
      faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
      faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
    ]);
    _faceModelsLoaded=true;
    return true;
  }catch(e){
    console.error('Face model load error:',e);
    showToast('Erro ao carregar modelos: '+e.message);
    return false;
  }
}

async function showFaceEnrollment(){
  showScreen('faceEnrollScreen');
  _faceDescriptors=[];
  _faceCapturing=false;
  stopFaceScanAnim();
  updateFaceSteps(0,FACE_CAPTURES_NEEDED);
  $('faceCaptureCount').textContent='';
  $('faceGuide').textContent='Posicione seu rosto';
  $('faceGuide').style.display='';
  $('faceOverlay').style.borderColor='transparent';
  $('faceStartBtn').classList.remove('hidden');
  $('faceSaveBtn').classList.add('hidden');
  $('faceInstructions').textContent='Toque em Iniciar para cadastrar';
  // Check if already enrolled
  if(state.userFaceEnrolled){
    $('faceEnrolledInfo').classList.remove('hidden');
    $('faceStartBtn').textContent='Recadastrar';
  }else{
    $('faceEnrolledInfo').classList.add('hidden');
    $('faceStartBtn').textContent='Iniciar captura';
  }
  // Start camera
  try{
    if(_faceStream){_faceStream.getTracks().forEach(t=>t.stop())}
    _faceStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:320},height:{ideal:320}}});
    $('faceVideo').srcObject=_faceStream;
  }catch(e){
    $('faceInstructions').textContent='Câmera não disponível: '+e.message;
  }
}

const _faceAngles=['Olhe para frente','Vire leve à esquerda','Vire leve à direita','Levante o queixo','Abaixe o queixo'];
let _faceRetries=0;
const MAX_FACE_RETRIES=4; // max retries per angle

async function startFaceEnroll(){
  $('faceInstructions').textContent='Carregando modelos de IA...';
  $('faceStartBtn').classList.add('hidden');
  const ok=await loadFaceModels();
  if(!ok){$('faceStartBtn').classList.remove('hidden');return}
  _faceDescriptors=[];
  _faceCapturing=true;
  _faceRetries=0;
  $('faceSaveBtn').classList.add('hidden');
  $('faceEnrolledInfo').classList.add('hidden');
  startFaceScanAnim();
  captureNextAngle(0);
}

async function captureNextAngle(idx){
  if(idx>=FACE_CAPTURES_NEEDED){
    // Done capturing
    _faceCapturing=false;
    stopFaceScanAnim();
    $('faceOverlay').style.borderColor='#00dc82';
    $('faceGuide').textContent='';
    $('faceGuide').style.display='none';
    $('faceInstructions').textContent='Captura completa! Toque em Salvar.';
    $('faceSaveBtn').classList.remove('hidden');
    updateFaceSteps(FACE_CAPTURES_NEEDED,FACE_CAPTURES_NEEDED);
    haptic([40,20,40,20,40]);
    return;
  }
  _faceRetries=0;
  $('faceInstructions').textContent=_faceAngles[idx];
  $('faceCaptureCount').textContent=(idx+1)+' de '+FACE_CAPTURES_NEEDED;
  updateFaceSteps(idx,FACE_CAPTURES_NEEDED);
  $('faceOverlay').style.borderColor='#3b82f6';
  $('faceGuide').style.display='none';
  // Brief pause for user to position
  await new Promise(r=>setTimeout(r,1500));
  if(!_faceCapturing)return;
  attemptFaceCapture(idx);
}

async function attemptFaceCapture(idx){
  if(!_faceCapturing)return;
  const video=$('faceVideo');
  try{
    const detection=await faceapi.detectSingleFace(video,new faceapi.SsdMobilenetv1Options({minConfidence:0.45}))
      .withFaceLandmarks()
      .withFaceDescriptor();
    if(!detection){
      _faceRetries++;
      if(_faceRetries>=MAX_FACE_RETRIES){
        $('faceInstructions').textContent='Difícil detectar. Melhore a iluminação.';
        $('faceOverlay').style.borderColor='#f59e0b';
        _faceRetries=0;
        await new Promise(r=>setTimeout(r,2000));
        if(!_faceCapturing)return;
      }else{
        $('faceInstructions').textContent='Detectando... '+_faceAngles[idx];
      }
      setTimeout(()=>attemptFaceCapture(idx),600);
      return;
    }
    // Got descriptor
    _faceDescriptors.push(Array.from(detection.descriptor));
    $('faceOverlay').style.borderColor='#00dc82';
    haptic([25]);
    await new Promise(r=>setTimeout(r,500));
    captureNextAngle(idx+1);
  }catch(e){
    _faceRetries++;
    if(_faceRetries>=MAX_FACE_RETRIES+2){
      $('faceInstructions').textContent='Erro persistente. Reinicie a captura.';
      _faceCapturing=false;
      stopFaceScanAnim();
      $('faceStartBtn').classList.remove('hidden');
      $('faceStartBtn').textContent='Reiniciar';
      return;
    }
    $('faceInstructions').textContent='Processando...';
    setTimeout(()=>attemptFaceCapture(idx),1000);
  }
}

async function saveFaceData(){
  if(!_faceDescriptors.length){return showToast('Nenhuma captura facial')}
  $('faceSaveBtn').disabled=true;
  $('faceInstructions').textContent='Salvando dados faciais...';
  try{
    const r=await fetch('/api/face/enroll',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      userId:state.userId,
      descriptors:_faceDescriptors,
      capturedAt:Date.now(),
      angles:FACE_CAPTURES_NEEDED
    })});
    const d=await r.json();
    if(d.error){showToast(d.error);$('faceSaveBtn').disabled=false;return}
    state.userFaceEnrolled=true;
    showToast('Face ID cadastrado!');
    haptic([40,20,60]);
    $('faceEnrolledInfo').classList.remove('hidden');
    $('faceSaveBtn').classList.add('hidden');
    $('faceInstructions').textContent='Face ID ativo';
    stopFaceCamera();
  }catch(e){
    showToast('Erro ao salvar Face ID');
    $('faceSaveBtn').disabled=false;
  }
}

async function removeFaceData(){
  if(!confirm('Remover seu Face ID?'))return;
  try{
    const r=await fetch('/api/face/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
    const d=await r.json();
    if(d.ok){
      state.userFaceEnrolled=false;
      showToast('Face ID removido');
      $('faceEnrolledInfo').classList.add('hidden');
      $('faceStartBtn').classList.remove('hidden');
      $('faceStartBtn').textContent='Iniciar captura';
    }
  }catch(e){showToast('Erro ao remover')}
}

// ═══ DOC ID — DOCUMENT VERIFICATION ═══
let _docPhotoData=null;
let _docSelfieData=null;

function updateDocSteps(step){
  for(let i=1;i<=3;i++){
    const el=$('docStep'+i);
    if(el)el.style.background=i<=step?'var(--ac)':'rgba(255,255,255,.1)';
  }
}
function showDocIdScreen(){
  showScreen('docIdScreen');
  _docPhotoData=null;_docSelfieData=null;
  $('docPreviewImg').style.display='none';
  $('docPlaceholder').style.display='';
  $('docSelfieImg').style.display='none';
  $('docSelfiePlaceholder').style.display='';
  $('docSelfieWrap').classList.add('hidden');
  $('docNameField').classList.add('hidden');
  $('docSaveBtn').classList.add('hidden');
  $('docNameInput').value='';
  $('docCpfInput').value='';
  updateDocSteps(1);
  $('docStepTitle').textContent='Passo 1: Foto do documento';
  $('docStepDesc').textContent='RG, CNH ou passaporte — frente do documento';
  $('docPreviewWrap').style.borderColor='rgba(255,255,255,.12)';
  if(state.userDocVerified||state.userDocSubmitted){
    $('docEnrolledInfo').classList.remove('hidden');
    $('docStatusText').textContent=state.userDocStatus==='approved'?'Documento verificado':'Aguardando validação...';
  }else{
    $('docEnrolledInfo').classList.add('hidden');
  }
}

function handleDocPhoto(input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  if(file.size>8*1024*1024)return showToast('Arquivo muito grande (máx 8MB)');
  const reader=new FileReader();
  reader.onload=function(e){
    const img=new Image();
    img.onload=function(){
      const canvas=document.createElement('canvas');
      const max=800;
      let w=img.width,h=img.height;
      if(w>max||h>max){if(w>h){h=h*(max/w);w=max}else{w=w*(max/h);h=max}}
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      _docPhotoData=canvas.toDataURL('image/jpeg',0.8);
      $('docPreviewImg').src=_docPhotoData;
      $('docPreviewImg').style.display='';
      $('docPlaceholder').style.display='none';
      $('docPreviewWrap').style.borderColor='rgba(0,220,130,.3)';
      // Advance to step 2
      updateDocSteps(2);
      $('docStepTitle').textContent='Passo 2: Selfie com documento';
      $('docStepDesc').textContent='Segure o documento ao lado do rosto';
      $('docSelfieWrap').classList.remove('hidden');
      // Scroll selfie into view
      setTimeout(()=>{const el=$('docSelfieWrap');if(el)el.scrollIntoView({behavior:'smooth',block:'center'})},200);
      haptic([20]);
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

function handleDocSelfie(input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  if(file.size>8*1024*1024)return showToast('Arquivo muito grande (máx 8MB)');
  const reader=new FileReader();
  reader.onload=function(e){
    const img=new Image();
    img.onload=function(){
      const canvas=document.createElement('canvas');
      const max=600;
      let w=img.width,h=img.height;
      if(w>max||h>max){if(w>h){h=h*(max/w);w=max}else{w=w*(max/h);h=max}}
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      _docSelfieData=canvas.toDataURL('image/jpeg',0.75);
      $('docSelfieImg').src=_docSelfieData;
      $('docSelfieImg').style.display='';
      $('docSelfiePlaceholder').style.display='none';
      // Advance to step 3
      updateDocSteps(3);
      $('docStepTitle').textContent='Passo 3: Confirme seus dados';
      $('docStepDesc').textContent='Digite o nome como está no documento';
      $('docNameField').classList.remove('hidden');
      $('docSaveBtn').classList.remove('hidden');
      setTimeout(()=>{const el=$('docNameField');if(el)el.scrollIntoView({behavior:'smooth',block:'center'})},200);
      haptic([20]);
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

async function saveDocId(){
  if(!_docPhotoData)return showToast('Tire a foto do documento');
  if(!_docSelfieData)return showToast('Tire a selfie com o documento');
  const name=$('docNameInput').value.trim();
  if(!name)return showToast('Digite o nome no documento');
  $('docSaveBtn').disabled=true;
  try{
    const r=await fetch('/api/doc/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      userId:state.userId,
      docPhoto:_docPhotoData,
      selfiePhoto:_docSelfieData,
      docName:name,
      cpf:$('docCpfInput').value.trim(),
      submittedAt:Date.now()
    })});
    const d=await r.json();
    if(d.error){showToast(d.error);$('docSaveBtn').disabled=false;return}
    state.userDocVerified=true;
    showToast('Documento enviado para verificação!');
    haptic([40,20,60]);
    $('docEnrolledInfo').classList.remove('hidden');
    $('docSaveBtn').classList.add('hidden');
  }catch(e){
    showToast('Erro ao enviar');
    $('docSaveBtn').disabled=false;
  }
}

// ═══ ADMIN VERIFICATION PANEL ═══
async function showVerificationPanel(){
  const existing=document.querySelector('.verify-panel-overlay');if(existing){existing.remove();return}
  const overlay=document.createElement('div');
  overlay.className='more-menu-overlay verify-panel-overlay';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
  overlay.innerHTML='<div class="more-menu-sheet" style="padding:1.5rem;max-height:85vh;overflow-y:auto"><div class="more-menu-handle"></div><div style="text-align:center;padding:1rem;color:var(--t3)">Carregando...</div></div>';
  document.body.appendChild(overlay);
  try{
    const d=await(await fetch('/api/admin/verifications/'+state.userId)).json();
    if(d.error){overlay.querySelector('.more-menu-sheet').innerHTML='<div class="more-menu-handle"></div><p style="color:var(--err);padding:1rem;text-align:center">'+d.error+'</p>';return}
    let html='<div class="more-menu-handle"></div>';
    html+='<h3 style="font-size:1rem;font-weight:700;color:var(--t1);margin-bottom:.8rem;display:flex;align-items:center;gap:.4rem"><span style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800">✓</span> Painel de Verificação</h3>';
    // Verified users
    html+='<div style="font-size:.75rem;font-weight:600;color:var(--t2);margin-bottom:.4rem">Usuários verificados ('+d.verifiedUsers.length+')</div>';
    if(d.verifiedUsers.length===0)html+='<p style="font-size:.72rem;color:var(--t3);margin-bottom:.8rem">Nenhum verificado ainda.</p>';
    d.verifiedUsers.forEach(u=>{
      const av=u.profilePhoto?'<div style="width:32px;height:32px;border-radius:50%;overflow:hidden;flex-shrink:0"><img src="'+u.profilePhoto+'" style="width:100%;height:100%;object-fit:cover"></div>':'<div style="width:32px;height:32px;border-radius:50%;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:800;color:#fff;flex-shrink:0">'+(u.nickname||'??').slice(0,2).toUpperCase()+'</div>';
      html+='<div style="display:flex;align-items:center;gap:.5rem;padding:.5rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;margin-bottom:.3rem">';
      html+='<div class="verified-wrap">'+av+'<div class="verified-badge verified-badge-sm">'+VERIFIED_SVG+'</div></div>';
      html+='<div style="flex:1;min-width:0"><div style="font-size:.78rem;font-weight:600;color:var(--t1)">'+esc(u.nickname)+'</div><div style="font-size:.6rem;color:var(--t3)">★'+u.stars+' · score '+u.score+'</div></div>';
      html+='<button onclick="unverifyUser(\''+u.id+'\',this)" style="font-size:.6rem;padding:.25rem .5rem;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.2);border-radius:8px;color:#f87171;cursor:pointer">Revogar</button>';
      html+='</div>';
    });
    // Verified events
    html+='<div style="font-size:.75rem;font-weight:600;color:var(--t2);margin:.8rem 0 .4rem">Eventos verificados ('+d.verifiedEvents.length+')</div>';
    d.verifiedEvents.forEach(e=>{
      html+='<div style="display:flex;align-items:center;gap:.5rem;padding:.5rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;margin-bottom:.3rem">';
      html+='<div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-size:.9rem">📍</div>';
      html+='<div style="flex:1"><div style="font-size:.78rem;font-weight:600;color:var(--t1)">'+esc(e.name)+' <span style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:.6rem;font-weight:800">✓</span></div><div style="font-size:.6rem;color:var(--t3)">'+e.participants+' participantes</div></div>';
      html+='</div>';
    });
    // Add verification section
    html+='<div style="margin-top:1rem;padding-top:.8rem;border-top:1px solid var(--b1)">';
    html+='<div style="font-size:.75rem;font-weight:600;color:var(--ac);margin-bottom:.5rem">Verificar usuário</div>';
    html+='<div style="display:flex;gap:.3rem;margin-bottom:.5rem"><input type="text" id="verifySearchInput" placeholder="Buscar por nickname..." style="flex:1;padding:.5rem .7rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.75rem;outline:none" oninput="filterVerifyUsers(this.value)"><button onclick="filterVerifyUsers($$(\'verifySearchInput\').value)" style="padding:.5rem .7rem;background:var(--ac);border:none;border-radius:10px;color:#fff;font-size:.7rem;font-weight:600;cursor:pointer">Buscar</button></div>';
    html+='<div id="verifyUserResults" style="max-height:200px;overflow-y:auto">';
    d.allUsers.filter(u=>!u.verified).slice(0,20).forEach(u=>{
      const av2=u.profilePhoto?'<img src="'+u.profilePhoto+'" style="width:28px;height:28px;border-radius:50%;object-fit:cover">':'<div style="width:28px;height:28px;border-radius:50%;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:800;color:#fff">'+(u.nickname||'??').slice(0,2).toUpperCase()+'</div>';
      html+='<div class="verify-user-row" data-nick="'+esc(u.nickname.toLowerCase())+'" style="display:flex;align-items:center;gap:.4rem;padding:.35rem;cursor:pointer;border-radius:8px;margin-bottom:.15rem" onmouseover="this.style.background=\'var(--s2)\'" onmouseout="this.style.background=\'none\'">';
      html+=av2;
      html+='<div style="flex:1;font-size:.72rem;color:var(--t1)">'+esc(u.nickname)+' <span style="color:var(--t3);font-size:.6rem">★'+u.stars+'</span></div>';
      html+='<button onclick="event.stopPropagation();verifyUser(\''+u.id+'\',this)" style="font-size:.58rem;padding:.2rem .5rem;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);border-radius:8px;color:#3b82f6;cursor:pointer;font-weight:600">Verificar</button>';
      html+='</div>';
    });
    html+='</div></div>';
    // Verify event section
    html+='<div style="margin-top:.8rem;padding-top:.8rem;border-top:1px solid var(--b1)">';
    html+='<div style="font-size:.75rem;font-weight:600;color:#60a5fa;margin-bottom:.5rem">Verificar evento</div>';
    html+='<div id="verifyEventResults">';
    d.allEvents.filter(e=>!e.verified).forEach(e=>{
      html+='<div style="display:flex;align-items:center;gap:.4rem;padding:.35rem;margin-bottom:.15rem">';
      html+='<span style="font-size:.85rem">📍</span>';
      html+='<div style="flex:1;font-size:.72rem;color:var(--t1)">'+esc(e.name)+' <span style="color:var(--t3);font-size:.6rem">'+e.participants+' pax</span></div>';
      html+='<button onclick="event.stopPropagation();verifyEvent(\''+e.id+'\',this)" style="font-size:.58rem;padding:.2rem .5rem;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);border-radius:8px;color:#3b82f6;cursor:pointer;font-weight:600">Verificar</button>';
      html+='</div>';
    });
    html+='</div></div>';
    overlay.querySelector('.more-menu-sheet').innerHTML=html;
  }catch(e){overlay.querySelector('.more-menu-sheet').innerHTML='<div class="more-menu-handle"></div><p style="color:var(--err);padding:1rem">Erro ao carregar.</p>'}
}
function $$(_id){return document.getElementById(_id)}
function filterVerifyUsers(q){
  q=q.toLowerCase().trim();
  document.querySelectorAll('.verify-user-row').forEach(r=>{
    r.style.display=!q||r.dataset.nick.includes(q)?'flex':'none';
  });
}
async function verifyUser(targetId,btn){
  btn.disabled=true;btn.textContent='...';
  try{
    const r=await fetch('/api/admin/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:state.userId,targetId})});
    const d=await r.json();
    if(d.ok){btn.textContent='Verificado ✓';btn.style.background='rgba(52,211,153,.1)';btn.style.color='#34d399';btn.style.borderColor='rgba(52,211,153,.2)';showToast('Usuário verificado!')}
    else{btn.textContent='Erro';showToast(d.error||'Erro')}
  }catch(e){btn.textContent='Erro';btn.disabled=false}
}
async function unverifyUser(targetId,btn){
  btn.disabled=true;btn.textContent='...';
  try{
    const r=await fetch('/api/admin/unverify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:state.userId,targetId})});
    const d=await r.json();
    if(d.ok){btn.closest('div[style]').style.opacity='.4';btn.textContent='Revogado';showToast('Verificação revogada.')}
    else{btn.textContent='Erro';showToast(d.error||'Erro')}
  }catch(e){btn.textContent='Erro';btn.disabled=false}
}
async function verifyEvent(eventId,btn){
  btn.disabled=true;btn.textContent='...';
  try{
    const r=await fetch('/api/admin/verify-event',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:state.userId,eventId})});
    const d=await r.json();
    if(d.ok){btn.textContent='Verificado ✓';btn.style.background='rgba(52,211,153,.1)';btn.style.color='#34d399';showToast('Evento verificado!')}
    else{btn.textContent='Erro';showToast(d.error||'Erro')}
  }catch(e){btn.textContent='Erro';btn.disabled=false}
}
</script>
</body>
</html>
