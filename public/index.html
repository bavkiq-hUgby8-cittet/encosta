<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#050508">
<title>Touch? — tudo nasce no gesto</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
*::-webkit-scrollbar{width:3px}
*::-webkit-scrollbar-track{background:transparent}
*::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}
*::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.2)}
::selection{background:rgba(255,107,53,.3);color:#fff}
:root{
  --bg:#050508;--s1:#12121a;--s2:#1a1a24;--s3:#24243a;
  --b1:#2a2a3a;--b2:rgba(255,255,255,0.06);
  --t1:#f5f5f7;--t2:#8888a0;--t3:#555568;
  --ac:#ff6b35;--ac2:#ff8f65;--pk:#ff3d71;
  --gw:rgba(255,107,53,0.12);--gw2:rgba(255,107,53,0.25);
  --ok:#34d399;--warn:#fbbf24;--err:#f87171;
}
html,body{height:100%;width:100%;font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--t1);overflow:hidden;-webkit-font-smoothing:antialiased}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;visibility:hidden;opacity:0;transform:translateY(6px);transition:opacity .35s cubic-bezier(.22,1,.36,1),transform .35s cubic-bezier(.22,1,.36,1),visibility 0s .35s;pointer-events:none}
.screen.active{visibility:visible;opacity:1;transform:translateY(0);transition:opacity .35s cubic-bezier(.22,1,.36,1),transform .35s cubic-bezier(.22,1,.36,1),visibility 0s;pointer-events:auto}

/* SPLASH */
#splash{justify-content:center;align-items:center;background:radial-gradient(circle at 50% 50%,rgba(255,107,53,.03),transparent 60%)}
#splash .logo{font-size:2.8rem;font-weight:800;letter-spacing:.35em;color:var(--ac);animation:gp 2s ease-in-out infinite;opacity:0;animation:gp 2s ease-in-out infinite,splash-in .8s ease forwards}
#splash .tag{margin-top:1.2rem;font-size:.78rem;color:var(--t3);font-weight:300;letter-spacing:.2em;opacity:0;animation:splash-tag-in .8s ease .4s forwards}
@keyframes fi{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes splash-in{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
@keyframes splash-tag-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes gp{0%,100%{text-shadow:0 0 20px var(--gw)}50%{text-shadow:0 0 50px var(--gw2),0 0 100px rgba(255,107,53,.08)}}

/* REGISTER */
#register{padding:2rem 1.5rem;overflow-y:auto}
.rh{text-align:center;margin-bottom:2rem;padding-top:env(safe-area-inset-top,1.5rem)}
.rh h1{font-size:1.8rem;font-weight:800;letter-spacing:.2em;color:var(--ac)}
.rh p{margin-top:.5rem;font-size:.8rem;color:var(--t2)}
.fg{margin-bottom:1.5rem}
.fg label{display:block;font-size:.7rem;color:var(--t2);text-transform:uppercase;letter-spacing:.12em;margin-bottom:.5rem;font-weight:600}
.fg input[type="text"],.fg input[type="date"]{width:100%;padding:.85rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;color:var(--t1);font-size:1rem;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s}
.fg input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.avs{display:flex;flex-direction:column;align-items:center;gap:.8rem;margin-bottom:1.5rem}
.avp{width:90px;height:90px;border-radius:50%;background:var(--s2);border:2px solid var(--b1);display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:800;color:#fff;overflow:hidden;letter-spacing:.05em;transition:all .3s}
.nick-hint{font-size:.7rem;color:var(--t3);transition:.3s}
.nick-hint.taken{color:var(--err)}.nick-hint.ok{color:var(--ok)}
.tc{display:flex;align-items:flex-start;gap:.8rem;margin-bottom:2rem;padding:1rem;background:var(--s1);border-radius:14px;border:1px solid var(--b1)}
.tc input[type="checkbox"]{width:20px;height:20px;margin-top:2px;accent-color:var(--ac);flex-shrink:0}
.tc span{font-size:.82rem;color:var(--t2);line-height:1.5}

/* BUTTONS */
.bp{width:100%;padding:.95rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:14px;color:#fff;font-size:.95rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.06em;transition:transform .15s cubic-bezier(.22,1,.36,1),box-shadow .2s,opacity .2s;box-shadow:0 4px 15px rgba(255,107,53,.3)}
.bp:active{transform:scale(.95)}.bp:disabled{opacity:.35;pointer-events:none}
.bs{padding:.65rem 1.4rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t2);font-size:.85rem;font-family:inherit;cursor:pointer;transition:transform .15s,background .15s}
.bs:active{transform:scale(.95);background:var(--s2)}

/* LOGIN SCREEN */
#login{padding:2rem 1.5rem;justify-content:center;align-items:center;gap:1.2rem;background:radial-gradient(ellipse at 50% 30%,rgba(255,107,53,.04),transparent 60%)}
.login-logo{font-size:2.4rem;font-weight:800;letter-spacing:.3em;color:var(--ac);margin-bottom:.3rem;text-shadow:0 0 40px rgba(255,107,53,.2)}
.login-sub{font-size:.78rem;color:var(--t2);margin-bottom:2rem;text-align:center;line-height:1.5}
.login-form{width:100%;max-width:340px;display:flex;flex-direction:column;gap:1rem}
.login-input{width:100%;padding:.85rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;color:var(--t1);font-size:.95rem;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s}
.login-input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.login-google{width:100%;max-width:340px;padding:.9rem;background:#fff;border:none;border-radius:14px;color:#333;font-size:.9rem;font-weight:600;font-family:inherit;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.6rem;transition:all .15s cubic-bezier(.22,1,.36,1);box-shadow:0 2px 12px rgba(0,0,0,.2)}
.login-google:active{transform:scale(.96);box-shadow:0 1px 6px rgba(0,0,0,.15)}
.login-google img{width:20px;height:20px}
.login-divider{display:flex;align-items:center;gap:1rem;width:100%;max-width:340px;color:var(--t3);font-size:.75rem}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--b1)}
.login-toggle{font-size:.82rem;color:var(--ac);cursor:pointer;text-align:center;margin-top:.5rem}
.login-err{font-size:.78rem;color:var(--err);text-align:center;min-height:1.1rem}
.login-nick-explain{font-size:.7rem;color:var(--t3);text-align:center;line-height:1.5;padding:0 .5rem;font-style:italic}
.reg-nick-info{font-size:.7rem;color:var(--ac2);background:rgba(255,107,53,.06);border:1px solid rgba(255,107,53,.12);border-radius:10px;padding:.6rem .8rem;margin:-.5rem 0 1.2rem;line-height:1.5;text-align:center}

/* PULL TO REFRESH */
.ptr-indicator{position:absolute;top:-50px;left:50%;transform:translateX(-50%);z-index:99;transition:top .3s ease;pointer-events:none}
.ptr-indicator.pulling{top:12px}
.ptr-indicator.refreshing{top:12px}
.ptr-spinner{width:28px;height:28px;border:2.5px solid rgba(255,255,255,.1);border-top-color:var(--ac);border-radius:50%;opacity:.5;transition:opacity .2s}
.ptr-indicator.pulling .ptr-spinner{opacity:1}
.ptr-indicator.refreshing .ptr-spinner{opacity:1;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* HOME */
#home{display:flex;flex-direction:column;align-items:center;height:100%;padding:0;position:relative;overflow:hidden}
#home::before{content:'';position:absolute;top:38%;left:50%;width:500px;height:500px;transform:translate(-50%,-50%);border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.05) 0%,rgba(255,61,113,.02) 40%,transparent 70%);pointer-events:none;z-index:0}
/* Top bar — clean header */
.home-top{display:flex;justify-content:space-between;align-items:center;width:100%;position:relative;z-index:2;flex-shrink:0;padding:max(env(safe-area-inset-top),.8rem) 1.2rem .6rem}
.home-user{display:flex;align-items:center;gap:.6rem;cursor:pointer;-webkit-tap-highlight-color:transparent}
.home-user:active{opacity:.7}
.home-avatar{width:40px;height:40px;border-radius:50%;background:var(--s2);border:2px solid var(--ac);display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:800;color:#fff;overflow:hidden;flex-shrink:0;box-shadow:0 0 12px rgba(255,107,53,.15);transition:transform .2s}
.home-user:active .home-avatar{transform:scale(.9)}
.home-user-info{display:flex;flex-direction:column;gap:.15rem}
.hg{font-size:.75rem;color:var(--t2);font-weight:400;letter-spacing:.01em;line-height:1.2}
.hg .hg-nick{font-size:1.15rem;color:#fff;font-weight:900;letter-spacing:-.02em;display:block;margin-top:.1rem}
.home-realname{font-size:.65rem;color:var(--t3);font-weight:400;letter-spacing:.02em;line-height:1}
.home-user-meta{display:flex;align-items:center;gap:.5rem;font-size:.68rem}
.home-icons{display:flex;gap:.5rem;align-items:center}
/* Verified badge */
.verified-wrap{position:relative;display:inline-flex}
.verified-badge{position:absolute;bottom:-3px;right:-3px;width:20px;height:20px;border-radius:0;background:none;border:none;display:flex;align-items:center;justify-content:center;z-index:3;filter:drop-shadow(0 1px 3px rgba(59,130,246,.6))}
.verified-badge svg{width:20px;height:20px;fill:url(#verifiedGrad)}
.verified-badge-sm{width:16px;height:16px;bottom:-2px;right:-2px}
.verified-badge-sm svg{width:16px;height:16px}
.verified-badge-lg{width:26px;height:26px;bottom:-3px;right:-3px}
.verified-badge-lg svg{width:26px;height:26px}
.home-verified-row{display:flex;align-items:center;gap:.4rem;margin-top:.1rem}
.home-stars-mini{font-size:.7rem;color:#fbbf24;letter-spacing:-.02em}
/* Center section — takes all available space, centers the button */
.hc{text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.8rem;flex:1;position:relative;z-index:1;width:100%;padding:0 1.2rem}
.hm{font-size:.82rem;color:var(--t3);font-weight:300;font-style:italic;line-height:1.6;max-width:220px;letter-spacing:.01em}
.daily-counter{font-size:.7rem;color:var(--t2);font-weight:400;padding:.35rem .8rem;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:20px;margin-top:.2rem}
.daily-counter strong{color:var(--ac);font-weight:700}
/* Main TOUCH button */
.be{width:clamp(150px,42vw,190px);height:clamp(150px,42vw,190px);border-radius:50%;background:rgba(255,107,53,.18);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:2px solid rgba(255,107,53,.35);color:#fff;font-size:.85rem;font-weight:800;font-family:inherit;letter-spacing:.25em;cursor:pointer;position:relative;z-index:1;box-shadow:0 0 50px rgba(255,107,53,.12),0 0 100px rgba(255,107,53,.04),inset 0 0 30px rgba(255,107,53,.08),inset 0 1px 0 rgba(255,255,255,.12);transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.4rem}
.be:active{transform:scale(.92)}
.be .be-icon{font-size:2.4rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3));display:flex;align-items:center;justify-content:center}
.be .be-text{font-size:.78rem;font-weight:800;letter-spacing:.25em}
.be::before{content:'';position:absolute;inset:-4px;border-radius:50%;background:conic-gradient(from 0deg,var(--ac),var(--pk),#9333ea,var(--ac));z-index:-1;animation:rs 4s linear infinite;opacity:.3;filter:blur(4px)}
.be.service-mode{background:radial-gradient(circle at 35% 35%,#444,#222 50%,#111)!important;box-shadow:0 0 50px rgba(0,0,0,.5),0 0 100px rgba(0,0,0,.08),inset 0 1px 0 rgba(255,255,255,.1)!important}
.be.service-mode::before{background:conic-gradient(from 0deg,#555,#333,#555)!important;opacity:.3}
.service-toggle{display:flex;align-items:center;gap:.4rem;padding:.4rem .8rem;border-radius:2rem;font-size:.7rem;font-weight:600;color:var(--t2);background:rgba(255,255,255,.06);cursor:pointer;margin-bottom:.5rem;transition:all .2s}
.service-toggle.active{background:#333;color:#fff;border:1px solid #555}
.be::after{content:'';position:absolute;inset:-30px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.08),transparent 70%);z-index:-2;animation:bb 3s ease-in-out infinite}
/* Energized state */
.be.energized{animation:sonic-energy .6s ease-in-out infinite alternate;box-shadow:0 0 60px rgba(255,107,53,.2),0 0 120px rgba(255,107,53,.1),0 0 200px rgba(255,61,113,.04);background:rgba(255,107,53,.25);border-color:rgba(255,107,53,.5)}
.be.energized::before{animation:rs 1.5s linear infinite;opacity:.8;filter:blur(3px);inset:-8px}
.be.energized::after{animation:sonic-waves 1s ease-out infinite}
.be.energized .be-text{animation:sonic-text .8s ease infinite alternate}
@keyframes bb{0%,100%{opacity:.3}50%{opacity:.6}}
@keyframes rs{to{transform:rotate(360deg)}}
@keyframes sonic-energy{0%{transform:scale(1);box-shadow:0 0 60px var(--gw2),0 0 120px rgba(255,107,53,.15)}100%{transform:scale(1.04);box-shadow:0 0 80px var(--gw2),0 0 150px rgba(255,107,53,.2),0 0 250px rgba(255,61,113,.08)}}
@keyframes sonic-waves{0%{inset:-30px;opacity:.5}100%{inset:-80px;opacity:0}}
@keyframes sonic-text{0%{opacity:1}100%{opacity:.6}}
@keyframes touch-shake{0%{transform:scale(1) rotate(0deg)}10%{transform:scale(1.08) rotate(-4deg)}20%{transform:scale(1.1) rotate(3deg)}30%{transform:scale(1.06) rotate(-3deg)}40%{transform:scale(1.08) rotate(2.5deg)}50%{transform:scale(1.04) rotate(-2deg)}60%{transform:scale(1.06) rotate(1.5deg)}70%{transform:scale(1.03) rotate(-1deg)}80%{transform:scale(1.01) rotate(.5deg)}90%{transform:scale(1) rotate(-.3deg)}100%{transform:scale(1) rotate(0deg)}}
.be.shake-activate{animation:touch-shake .7s ease-out!important}
/* Sound wave bars on sides */
.sonic-bars{position:absolute;top:50%;display:flex;flex-direction:column;gap:3px;transform:translateY(-50%);z-index:0;opacity:0;transition:opacity .3s}
.sonic-bars.active{opacity:1}
.sonic-bars.left{left:-50px}
.sonic-bars.right{right:-50px}
.sonic-bar{height:2px;background:var(--ac);border-radius:2px;opacity:.4}
.sonic-bars.left .sonic-bar{animation:sbar-left .8s ease-in-out infinite alternate}
.sonic-bars.right .sonic-bar{animation:sbar-right .8s ease-in-out infinite alternate}
.sonic-bar:nth-child(1){width:12px;animation-delay:0s}
.sonic-bar:nth-child(2){width:20px;animation-delay:.1s}
.sonic-bar:nth-child(3){width:28px;animation-delay:.2s}
.sonic-bar:nth-child(4){width:20px;animation-delay:.3s}
.sonic-bar:nth-child(5){width:12px;animation-delay:.4s}
@keyframes sbar-left{0%{opacity:.2;transform:translateX(0)}100%{opacity:.7;transform:translateX(-6px)}}
@keyframes sbar-right{0%{opacity:.2;transform:translateX(0)}100%{opacity:.7;transform:translateX(6px)}}
.sonic-status{font-size:.72rem;color:var(--ac2);min-height:1.2em;transition:all .3s;opacity:0}
.sonic-status.active{opacity:1}
.sonic-fallback{opacity:0;transition:opacity .3s;pointer-events:none}
.sonic-fallback.active{opacity:1;pointer-events:auto}
/* FIRE — energy rising from speaker (bottom of phone) */
.fire-overlay{position:absolute;bottom:0;left:0;right:0;height:55%;pointer-events:none;z-index:0;opacity:0;transition:opacity .6s}
.fire-overlay.active{opacity:1}
/* Main upward glow — concentrated in center bottom like speaker beam */
.fire-glow{position:absolute;bottom:-15%;left:50%;transform:translateX(-50%);width:80%;height:55%;background:radial-gradient(ellipse at 50% 100%,rgba(255,107,53,.4) 0%,rgba(255,61,113,.18) 25%,rgba(255,107,53,.06) 50%,transparent 70%);animation:fire-breathe 1s ease-in-out infinite alternate;filter:blur(6px)}
.fire-glow2{position:absolute;bottom:-5%;left:50%;transform:translateX(-50%);width:50%;height:40%;background:radial-gradient(ellipse at 50% 100%,rgba(255,180,80,.3) 0%,rgba(255,107,53,.1) 40%,transparent 65%);animation:fire-breathe .7s ease-in-out infinite alternate-reverse;filter:blur(10px)}
/* Speaker icon glow at very bottom */
.fire-speaker{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:3px;opacity:0;animation:fire-spk-in .8s ease .3s forwards}
.fire-spk-wave{width:12px;height:12px;border:1.5px solid var(--ac);border-radius:50%;opacity:.5;animation:fire-spk-pulse 1.2s ease infinite}
.fire-spk-wave:nth-child(2){width:20px;height:20px;animation-delay:.2s;opacity:.3}
.fire-spk-wave:nth-child(3){width:28px;height:28px;animation-delay:.4s;opacity:.15}
@keyframes fire-spk-in{to{opacity:1}}
@keyframes fire-spk-pulse{0%,100%{opacity:.2;transform:scale(.9)}50%{opacity:.7;transform:scale(1.1)}}
/* Particles — concentrated from center bottom, shooting up like speaker energy */
.fire-particles{position:absolute;bottom:0;left:0;right:0;height:100%;overflow:hidden}
.fire-p{position:absolute;bottom:-8px;border-radius:50%;filter:blur(1.5px);animation:fire-rise linear infinite}
/* Concentrated near center (35-65% of width) — speaker zone */
.fire-p:nth-child(1){left:38%;width:5px;height:5px;background:#ff6b35;animation-duration:1.4s;animation-delay:0s}
.fire-p:nth-child(2){left:42%;width:3px;height:3px;background:#ffc060;animation-duration:1.7s;animation-delay:.2s}
.fire-p:nth-child(3){left:48%;width:7px;height:7px;background:#ff6b35;animation-duration:1.2s;animation-delay:.1s}
.fire-p:nth-child(4){left:52%;width:4px;height:4px;background:#ff3d71;animation-duration:1.6s;animation-delay:.35s}
.fire-p:nth-child(5){left:56%;width:5px;height:5px;background:#ffa060;animation-duration:1.3s;animation-delay:.15s}
.fire-p:nth-child(6){left:44%;width:3px;height:3px;background:#ff8f65;animation-duration:1.8s;animation-delay:.5s}
.fire-p:nth-child(7){left:50%;width:8px;height:8px;background:#ff6b35;animation-duration:1.1s;animation-delay:.25s}
.fire-p:nth-child(8){left:46%;width:4px;height:4px;background:#ffc060;animation-duration:1.5s;animation-delay:.4s}
/* Some scattered wider for spread effect */
.fire-p:nth-child(9){left:30%;width:3px;height:3px;background:#ff8f65;animation-duration:2s;animation-delay:.6s}
.fire-p:nth-child(10){left:65%;width:4px;height:4px;background:#ff6b35;animation-duration:1.9s;animation-delay:.3s}
.fire-p:nth-child(11){left:35%;width:5px;height:5px;background:#ff3d71;animation-duration:1.7s;animation-delay:.7s}
.fire-p:nth-child(12){left:60%;width:3px;height:3px;background:#ffa060;animation-duration:1.6s;animation-delay:.45s}
@keyframes fire-rise{0%{transform:translateY(0) scale(1);opacity:.9}30%{opacity:1}100%{transform:translateY(-50vh) scale(0);opacity:0}}
@keyframes fire-breathe{0%{opacity:.6;transform:translateX(-50%) scale(.95)}100%{opacity:1;transform:translateX(-50%) scale(1.05)}}
/* Edge heat lines — bottom edges glow */
.fire-edge{position:absolute;bottom:0;height:3px;background:linear-gradient(90deg,transparent 20%,var(--ac),#fff,var(--ac),transparent 80%);filter:blur(1px);animation:fire-edge-pulse .8s ease-in-out infinite alternate}
.fire-edge.left{left:0;right:50%;border-radius:0 2px 0 0}
.fire-edge.right{left:50%;right:0;border-radius:2px 0 0 0}
@keyframes fire-edge-pulse{0%{opacity:.3;height:2px}100%{opacity:.9;height:5px}}
/* Sonic instruction — speakers touching animation */
.sonic-instruct{position:absolute;bottom:22%;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:.8rem;opacity:0;transition:opacity .5s;z-index:3}
.sonic-instruct.active{opacity:1}
/* Phones lying down, bottoms (speakers) facing each other */
.si-scene{position:relative;width:160px;height:80px;display:flex;align-items:center;justify-content:center}
.si-phone{position:absolute;width:50px;height:26px;border:1.5px solid var(--ac);border-radius:5px;background:rgba(255,107,53,.06)}
.si-phone.left{left:0;animation:si-slide-l 2s ease-in-out infinite}
.si-phone.right{right:0;animation:si-slide-r 2s ease-in-out infinite}
/* Speaker grille dots on the inner edge */
.si-phone .si-speaker{position:absolute;top:50%;transform:translateY(-50%);display:flex;gap:2px;align-items:center}
.si-phone.left .si-speaker{right:3px}
.si-phone.right .si-speaker{left:3px}
.si-spk-dot{width:2.5px;height:2.5px;border-radius:50%;background:var(--ac);opacity:.6}
/* Energy arcs between speakers */
.si-energy{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;gap:3px;align-items:center}
.si-arc{width:3px;height:10px;border-radius:2px;background:var(--ac);opacity:0;animation:si-arc-flash .6s ease infinite}
.si-arc:nth-child(1){height:6px;animation-delay:0s}
.si-arc:nth-child(2){height:12px;animation-delay:.15s}
.si-arc:nth-child(3){height:8px;animation-delay:.3s}
.si-arc:nth-child(4){height:14px;animation-delay:.1s}
.si-arc:nth-child(5){height:6px;animation-delay:.25s}
@keyframes si-arc-flash{0%{opacity:0;transform:scaleY(.5)}30%{opacity:.9;transform:scaleY(1.1)}60%{opacity:.4;transform:scaleY(.8)}100%{opacity:0;transform:scaleY(.3)}}
@keyframes si-slide-l{0%,100%{transform:translateX(0)}50%{transform:translateX(18px)}}
@keyframes si-slide-r{0%,100%{transform:translateX(0)}50%{transform:translateX(-18px)}}
/* Speaker label */
.si-label{font-size:.5rem;color:var(--t3);letter-spacing:.08em;text-transform:uppercase;opacity:.6}
.si-text{font-size:.72rem;color:var(--ac2);text-align:center;max-width:200px;line-height:1.5;font-weight:600;letter-spacing:.02em}
.si-text em{color:#fff;font-style:normal;font-weight:700}
/* Pulsing glow from speaker zone */
.si-glow{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:20px;height:20px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.4),transparent 70%);animation:si-glow-pulse 1s ease-in-out infinite;filter:blur(4px)}
@keyframes si-glow-pulse{0%,100%{opacity:.3;transform:translate(-50%,-50%) scale(.8)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.5)}}
/* Screenshot block in chat */
#chat .cms{-webkit-user-select:none;user-select:none}
/* Bottom section — anchored tab bar */
.home-bottom{display:flex;flex-direction:column;align-items:center;width:100%;position:relative;z-index:5;flex-shrink:0;padding:0 1.2rem;padding-bottom:max(env(safe-area-inset-bottom),.6rem)}
.home-nav{display:flex;justify-content:space-around;width:100%;padding:.5rem 0;border-top:1px solid rgba(255,255,255,.04);background:linear-gradient(180deg,transparent,rgba(5,5,8,.3))}
.hn-btn{display:flex;flex-direction:column;align-items:center;gap:.2rem;background:none;border:none;color:var(--t3);font-family:inherit;cursor:pointer;padding:.5rem .5rem;border-radius:12px;transition:all .2s cubic-bezier(.22,1,.36,1);-webkit-tap-highlight-color:transparent;min-width:56px;flex:1;max-width:80px;position:relative}
.hn-btn:active{background:rgba(255,255,255,.06);color:var(--t1);transform:scale(.92)}
.hn-ico{font-size:1.15rem;line-height:1;transition:transform .2s}
.hn-btn:active .hn-ico{transform:scale(1.15)}
.hn-lbl{font-size:.52rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:inherit;white-space:nowrap;opacity:.7}
.home-brand-row{display:flex;align-items:center;justify-content:center;gap:.6rem;padding:.2rem 0 .1rem}
.home-brand{font-size:.5rem;font-weight:800;letter-spacing:.35em;color:var(--ac);opacity:.3}
.rb{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;position:relative}
.rb:active{transform:scale(.93)}
.rb .ct{position:absolute;top:-3px;right:-3px;min-width:16px;height:16px;border-radius:50%;background:var(--ac);font-size:.55rem;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
.cd{width:7px;height:7px;border-radius:50%;background:var(--ok);box-shadow:0 0 8px rgba(52,211,153,.6);transition:all .3s ease}
.cd.offline{background:var(--err);box-shadow:0 0 8px rgba(248,113,113,.6)}
.cd.reconnecting{background:var(--warn);box-shadow:0 0 8px rgba(251,191,36,.5);animation:bk 1s infinite}
@keyframes bk{0%,100%{opacity:1}50%{opacity:.3}}
.constellation-btn{width:42px;height:42px;border-radius:50%;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;position:relative;color:#fff;box-shadow:0 0 8px rgba(255,255,255,.12),0 0 16px rgba(255,255,255,.06);animation:constGlow 3s ease-in-out infinite;z-index:10}
.constellation-btn:active{transform:scale(.93)}
@keyframes constGlow{0%,100%{box-shadow:0 0 8px rgba(255,255,255,.12),0 0 16px rgba(255,255,255,.06);border-color:rgba(255,255,255,.25)}50%{box-shadow:0 0 12px rgba(255,255,255,.2),0 0 24px rgba(255,255,255,.1);border-color:rgba(255,255,255,.4)}}

/* ENCOUNTER */
#encounter{padding:2rem 1.5rem;justify-content:center;align-items:center;text-align:center}
.ep{display:none;flex-direction:column;align-items:center;gap:1.5rem;width:100%}.ep.active{display:flex}
.et{font-size:.85rem;color:var(--t2);margin-bottom:.5rem}
.cdsp{font-size:2.8rem;font-weight:800;letter-spacing:.25em;color:var(--ac);font-family:'Courier New',monospace;text-shadow:0 0 20px var(--gw)}
.qb{background:#fff;padding:14px;border-radius:16px;display:inline-block;box-shadow:0 8px 30px rgba(0,0,0,.3)}
.qb canvas{display:block}
.cir{display:flex;gap:.5rem;width:100%;max-width:280px}
.cir input{flex:1;padding:.85rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;color:var(--t1);font-size:1.1rem;font-family:'Courier New',monospace;text-align:center;letter-spacing:.15em;outline:none;text-transform:uppercase}
.cir input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.cir button{padding:0 1.2rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:14px;color:#fff;font-size:1.3rem;cursor:pointer}
.od{display:flex;align-items:center;gap:1rem;color:var(--t3);font-size:.8rem;width:100%;max-width:280px}
.od::before,.od::after{content:'';flex:1;height:1px;background:var(--b1)}
.wd{color:var(--ac);font-size:1.5rem;display:flex;gap:6px;justify-content:center}
.wd span{animation:df 1.4s ease-in-out infinite;opacity:.3}
.wd span:nth-child(2){animation-delay:.2s}.wd span:nth-child(3){animation-delay:.4s}
@keyframes df{0%,100%{opacity:.3}50%{opacity:1}}

/* SONIC ENCOUNTER MODE (kept as phaseBump for compat) */
.bump-circle{width:160px;height:160px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#ff8f65,#ff6b35 50%,#e05520);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:.3rem;position:relative;box-shadow:0 0 60px var(--gw);transition:all .3s}
.bump-circle.listening{animation:sonic-energy .6s ease-in-out infinite alternate}
.bump-circle.bumped{background:radial-gradient(circle at 35% 35%,#34d399,#10b981 50%,#059669);box-shadow:0 0 80px rgba(52,211,153,.4);animation:bump-hit .5s ease}

/* REVEAL — next-gen minimal */
#reveal{justify-content:center;align-items:center;text-align:center;padding:0;overflow:hidden;background:#050508}
.rv-light-beam{position:absolute;inset:0;z-index:0;pointer-events:none}
.rv-wrap{position:relative;z-index:3;display:flex;flex-direction:column;align-items:center;width:100%;height:100%;justify-content:center}
.rv-center{display:flex;flex-direction:column;align-items:center;gap:1.2rem;flex:1;justify-content:center;padding:0 1.5rem}
/* Avatars row */
.rv-avatars{display:flex;align-items:center;justify-content:center;gap:1.2rem;position:relative;opacity:0;animation:rv-up .8s ease 3.8s forwards}
.rv-avatar-wrap{position:relative;display:flex;flex-direction:column;align-items:center;gap:.35rem}
.rv-avatar-img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:1.5px solid rgba(255,255,255,.1);box-shadow:0 0 20px rgba(255,107,53,.15)}
.rv-avatar-name{font-size:.65rem;color:rgba(255,255,255,.45);font-weight:400;letter-spacing:.04em;opacity:0;animation:rv-fi .6s ease 4.4s forwards}
.rv-connection-symbol{display:flex;align-items:center;padding:0 .2rem}
.rv-connection-dot{width:4px;height:4px;border-radius:50%;background:rgba(255,107,53,.5);box-shadow:0 0 8px rgba(255,107,53,.3)}
/* Moment label */
.rv-moment{font-size:.6rem;color:rgba(255,255,255,.25);letter-spacing:.25em;text-transform:uppercase;opacity:0;animation:rv-fi 1.2s ease .3s forwards;font-weight:400}
.rv-service-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.35rem .8rem;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.25);border-radius:16px;font-size:.75rem;color:#34d399;font-weight:500;margin-top:.5rem;opacity:0;animation:rv-fi .8s ease .6s forwards;letter-spacing:.02em}
/* Phrase — THE focus */
.rv-phrase{max-width:300px;min-height:50px;display:flex;flex-wrap:wrap;justify-content:center;gap:.25rem;line-height:2}
.rv-word{display:inline-block;font-size:1.5rem;font-weight:200;color:#fff;opacity:0;transform:translateY(8px);animation:rv-word .7s cubic-bezier(.22,1,.36,1) forwards;letter-spacing:-.01em}
@keyframes rv-word{to{opacity:1;transform:none}}
/* Sub */
.rv-sub{font-size:.58rem;color:rgba(255,255,255,.18);opacity:0;animation:rv-fi .8s ease 5.5s forwards;font-weight:300;letter-spacing:.06em}
.rv-line{display:none}
/* Renewed + last */
.rv-renewed{font-size:.62rem;color:rgba(255,107,53,.5);opacity:0;animation:rv-fi .6s ease 4.8s forwards;letter-spacing:.1em}
.rv-last{font-size:.55rem;color:rgba(255,255,255,.2);margin-top:.1rem;padding:.2rem .6rem;background:rgba(255,255,255,.02);border-radius:6px;border:1px solid rgba(255,255,255,.04);opacity:0;animation:rv-fi .6s ease 5s forwards}
@keyframes rv-fi{to{opacity:1}}
@keyframes rv-up{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
/* Bottom actions — two main buttons side by side */
.rv-actions{position:absolute;bottom:0;left:0;right:0;display:flex;flex-direction:column;gap:.6rem;align-items:center;padding:.8rem 1.5rem calc(env(safe-area-inset-bottom,.5rem) + .8rem);opacity:0;animation:rv-fi .6s ease 6s forwards;z-index:5}
.rv-btn-row{display:flex;gap:.5rem;width:100%;max-width:300px}
.rv-btn-enter{flex:1;padding:.65rem 0;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:28px;color:#fff;font-size:.72rem;font-weight:500;font-family:inherit;cursor:pointer;letter-spacing:.06em;transition:all .15s;backdrop-filter:blur(8px)}
.rv-btn-enter:active{transform:scale(.96);background:rgba(255,255,255,.12)}
.rv-btn-skip{flex:1;padding:.65rem 0;background:transparent;border:1px solid rgba(255,255,255,.06);border-radius:28px;color:rgba(255,255,255,.35);font-size:.72rem;font-weight:400;font-family:inherit;cursor:pointer;letter-spacing:.06em;transition:all .15s}
.rv-btn-skip:active{transform:scale(.96);color:rgba(255,255,255,.6)}
.rv-sec-row{display:flex;gap:.5rem;justify-content:center}
.rv-btn-mini{display:flex;align-items:center;gap:.3rem;padding:.3rem .7rem;background:transparent;border:1px solid rgba(255,255,255,.05);border-radius:16px;color:rgba(255,255,255,.25);font-size:.55rem;font-family:inherit;cursor:pointer;transition:all .15s;letter-spacing:.02em}
.rv-btn-mini:active{background:rgba(255,255,255,.06);color:rgba(255,255,255,.5)}
.rv-btn-mini .rv-ico{font-size:.7rem;line-height:1;opacity:.5}

/* CHAT */
#chat{flex-direction:column;background:var(--bg)}
.ch{display:flex;align-items:center;justify-content:space-between;padding:.5rem .8rem;background:rgba(18,18,24,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-bottom:1px solid rgba(255,255,255,.05);padding-top:max(env(safe-area-inset-top),.5rem);flex-shrink:0;z-index:2;box-shadow:0 1px 12px rgba(0,0,0,.15)}
.chl{display:flex;align-items:center;gap:.5rem;flex:1;min-width:0}
.ch-info{cursor:pointer;display:flex;flex-direction:column;min-width:0;gap:.05rem}
.ch-info:active{opacity:.7}
.chb{width:32px;height:32px;border-radius:50%;background:transparent;border:none;color:var(--t1);font-size:1.05rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.15s;flex-shrink:0}
.chb:active{transform:scale(.9);opacity:.7}
.chn{font-size:.88rem;font-weight:600;letter-spacing:-.01em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ch-sub{font-size:.6rem;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cht{font-size:.72rem;font-weight:700;font-family:'Courier New',monospace;padding:.3rem .7rem;border-radius:20px;background:rgba(255,107,53,.08);color:var(--ac);letter-spacing:.04em;transition:all .3s;flex-shrink:0;border:1px solid rgba(255,107,53,.12)}
.cht.urg{background:rgba(248,113,113,.12);color:var(--err);border-color:rgba(248,113,113,.2);animation:urg-pulse 1.5s ease infinite}
@keyframes urg-pulse{0%,100%{opacity:1}50%{opacity:.6}}
/* ID action pills */
.chat-id-bar{display:flex;gap:.4rem;padding:.3rem .8rem;justify-content:center}
.id-bar-btn{padding:.35rem .7rem;border-radius:20px;font-size:.65rem;font-weight:600;font-family:inherit;cursor:pointer;border:1px solid rgba(255,255,255,.1);transition:all .2s;background:rgba(255,255,255,.06);color:var(--t2)}
.id-bar-btn.reveal{background:rgba(0,220,130,.1);color:#00dc82;border-color:rgba(0,220,130,.2)}
.id-bar-btn.request{background:rgba(163,113,247,.1);color:#a371f7;border-color:rgba(163,113,247,.2)}
.id-bar-btn.done{background:rgba(255,255,255,.04);color:var(--t3);border-color:transparent;cursor:default}
.id-pill{padding:.4rem .8rem;border-radius:20px;font-size:.7rem;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .2s;display:inline-flex;align-items:center;gap:.3rem}
.id-pill.request{background:rgba(163,113,247,.1);color:#a371f7;border:1px solid rgba(163,113,247,.2)}
.id-pill.reveal{background:rgba(255,107,53,.1);color:var(--ac);border:1px solid rgba(255,107,53,.2)}
.id-pill:active{transform:scale(.93)}
.cpb{padding:.55rem 1rem;text-align:center;font-size:.75rem;color:var(--ac2);font-style:italic;background:linear-gradient(180deg,rgba(255,107,53,.06) 0%,transparent 100%);flex-shrink:0;letter-spacing:.01em}
.cms{flex:1;overflow-y:auto;padding:.6rem .8rem;display:flex;flex-direction:column;gap:.35rem;min-height:0;scroll-behavior:smooth}
.msg{max-width:78%;padding:.6rem .9rem;border-radius:18px;font-size:.86rem;line-height:1.45;word-break:break-word;animation:mi .3s cubic-bezier(.22,1,.36,1);position:relative}
.msg.mine{align-self:flex-end;background:linear-gradient(135deg,var(--ac),#e85d2a);color:#fff;border-bottom-right-radius:4px;box-shadow:0 2px 8px rgba(255,107,53,.2)}
.msg.theirs{align-self:flex-start;background:var(--s2);color:var(--t1);border-bottom-left-radius:4px;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.msg.ephemeral{border:1px dashed rgba(255,107,53,.35);background:rgba(255,107,53,.06);color:var(--t1);text-align:center;align-self:center;max-width:85%;font-style:italic;padding:.5rem 1rem;font-size:.8rem}
.msg.ephemeral.mine{background:rgba(255,107,53,.12);border-color:rgba(255,107,53,.4)}
.msg.ephemeral .eph-badge{display:inline-block;font-size:.55rem;text-transform:uppercase;letter-spacing:.1em;opacity:.5;margin-left:.4rem;font-style:normal}
.msg.photo{padding:.25rem}
.msg.photo img{border-radius:14px;max-width:220px;max-height:220px;display:block;object-fit:cover}
.mt{font-size:.55rem;opacity:.4;margin-top:.15rem}
@keyframes mi{from{opacity:0;transform:translateY(6px) scale(.97)}to{opacity:1;transform:none}}
.ti{display:flex;align-items:center;gap:3px;padding:.4rem .8rem;align-self:flex-start;opacity:0;height:0;overflow:hidden;transition:opacity .2s,height .2s}
.ti.vis{opacity:1;height:auto;overflow:visible}
.ti .dot{width:5px;height:5px;border-radius:50%;background:var(--t2);animation:tb 1.4s ease-in-out infinite}
.ti .dot:nth-child(2){animation-delay:.15s}.ti .dot:nth-child(3){animation-delay:.3s}
@keyframes tb{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}
/* System messages */
.msg-system{text-align:center;font-size:.7rem;color:var(--t3);padding:.5rem 1rem;font-style:italic}
/* Quick phrases bar */
.qp-bar{display:flex;gap:.35rem;padding:.4rem .8rem;overflow-x:auto;-webkit-overflow-scrolling:touch;flex-shrink:0;background:transparent;scrollbar-width:none}
.qp-bar::-webkit-scrollbar{display:none}
.qp-chip{padding:.4rem .8rem;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:18px;color:var(--t2);font-size:.72rem;cursor:pointer;flex-shrink:0;font-family:inherit;transition:all .2s cubic-bezier(.22,1,.36,1);white-space:nowrap}
.qp-chip:active{background:var(--ac);color:#fff;border-color:var(--ac);transform:scale(.93)}
.qp-chip.sent{opacity:.25;pointer-events:none;transform:scale(.95)}
/* Chat input area - modern */
.chat-bottom{background:rgba(18,18,24,.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-top:1px solid rgba(255,255,255,.05);flex-shrink:0;padding-bottom:max(env(safe-area-inset-bottom),.5rem)}
.cia{display:flex;align-items:flex-end;gap:.4rem;padding:.35rem .8rem .35rem}
.cia-wrap{flex:1;display:flex;align-items:flex-end;background:var(--s2);border:1px solid rgba(255,255,255,.08);border-radius:22px;transition:border-color .2s;overflow:hidden}
.cia-wrap:focus-within{border-color:var(--ac)}
.cia-plus{width:34px;height:34px;border:none;background:transparent;color:var(--t3);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.15s;padding:0 0 0 .3rem}
.cia-plus:active{color:var(--ac);transform:scale(.9)}
.cia input{flex:1;padding:.6rem .7rem .6rem .2rem;background:transparent;border:none;color:var(--t1);font-size:.86rem;font-family:inherit;outline:none;min-height:20px}
.sb{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--ac),#e85d2a);border:none;color:#fff;font-size:.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s cubic-bezier(.22,1,.36,1);opacity:0;transform:scale(.3);pointer-events:none;flex-shrink:0;box-shadow:0 2px 10px rgba(255,107,53,.3)}
.sb.active{opacity:1;transform:scale(1);pointer-events:auto}
.sb:active{transform:scale(.85)}
/* Plus menu overlay */
.plus-menu{position:absolute;bottom:100%;left:.5rem;right:.5rem;background:rgba(24,24,32,.97);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:.5rem;display:grid;grid-template-columns:repeat(4,1fr);gap:.3rem;transform:translateY(8px);opacity:0;pointer-events:none;transition:all .2s ease;z-index:10;margin-bottom:.4rem}
.plus-menu.open{transform:translateY(0);opacity:1;pointer-events:auto}
.pm-item{display:flex;flex-direction:column;align-items:center;gap:.3rem;padding:.6rem .3rem;border-radius:12px;cursor:pointer;transition:.15s;border:none;background:transparent;font-family:inherit;color:var(--t1)}
.pm-item:active{background:rgba(255,255,255,.06);transform:scale(.95)}
.pm-ico{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.15rem}
.pm-label{font-size:.62rem;color:var(--t2);text-align:center;letter-spacing:.02em}
.selfie-btn{display:none}

/* RELATIONS */
#relations{flex-direction:column;background:var(--bg)}
.rlh{display:flex;align-items:center;gap:.8rem;padding:1rem 1.2rem;background:linear-gradient(180deg,var(--s1) 0%,var(--bg) 100%);border-bottom:1px solid rgba(255,255,255,.04);padding-top:max(env(safe-area-inset-top),1rem)}
.rlh h2{font-size:1.15rem;font-weight:700;letter-spacing:-.01em}
.rlh-sub{font-size:.7rem;color:var(--t3);font-weight:400;margin-left:auto}
.rll{flex:1;overflow-y:auto;padding:.6rem .8rem;padding-bottom:5rem}
.float-history-btn{position:absolute;bottom:1.5rem;right:1.2rem;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--p1),var(--p2));color:#fff;font-size:1.4rem;border:none;box-shadow:0 4px 20px rgba(255,107,53,.35);cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center;transition:transform .2s}
.rc{display:flex;align-items:center;gap:.9rem;padding:1rem;margin-bottom:.6rem;background:linear-gradient(135deg,var(--s1),rgba(26,26,36,.8));border:1px solid rgba(255,255,255,.06);border-radius:18px;cursor:pointer;transition:all .2s cubic-bezier(.22,1,.36,1);position:relative;overflow:hidden}
.rc::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,var(--ac),var(--pk));border-radius:3px 0 0 3px;opacity:.4;transition:opacity .2s}
.rc:active{background:var(--s2);transform:scale(.975);border-color:rgba(255,107,53,.25)}.rc:active::before{opacity:1}
.rav{display:flex;align-items:center;justify-content:center;flex-shrink:0}
.ri{flex:1;min-width:0}
.rn{font-size:1.05rem;font-weight:600;letter-spacing:-.01em;color:var(--t1)}
.rp{font-size:.8rem;color:var(--t2);margin-top:.25rem;font-style:italic;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.rp-preview{font-size:.75rem;color:var(--t3);margin-top:.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rc-unread{width:10px;height:10px;border-radius:50%;background:var(--ac);flex-shrink:0;margin-bottom:.3rem;box-shadow:0 0 8px rgba(255,107,53,.5)}
.rtm-wrap{display:flex;flex-direction:column;align-items:flex-end;gap:.2rem;flex-shrink:0}
.rtm{font-size:.75rem;font-family:'Courier New',monospace;font-weight:700;flex-shrink:0;padding:.25rem .6rem;border-radius:10px;background:rgba(52,211,153,.08)}
.rtm.ok{color:var(--ok);background:rgba(52,211,153,.08)}.rtm.med{color:var(--warn);background:rgba(251,191,36,.08)}.rtm.low{color:var(--err);background:rgba(248,113,113,.08);animation:urg-pulse 1.5s ease infinite}
.rtm-label{font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em}
.nr{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--t2);text-align:center;padding:2.5rem;font-size:1rem;line-height:1.8}
.nr-icon{font-size:2.5rem;margin-bottom:1rem;opacity:.25;filter:grayscale(.5)}
.nr-text{font-size:.82rem;color:var(--t3);max-width:240px;line-height:1.6;font-weight:300}

/* STREAK */
.streak-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:10px;font-size:.7rem;color:#fbbf24;font-weight:600}
.streak-badge .streak-fire{font-size:.75rem}
.streak-info{padding:.5rem .8rem;background:linear-gradient(135deg,rgba(251,191,36,.06),rgba(255,107,53,.04));border:1px solid rgba(251,191,36,.1);border-radius:12px;margin:.3rem .8rem;font-size:.72rem;color:var(--t2);display:flex;align-items:center;justify-content:space-between;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.streak-progress{height:3px;background:rgba(255,255,255,.06);border-radius:2px;flex:1;margin:0 .6rem;overflow:hidden}
.streak-bar{height:100%;background:linear-gradient(90deg,#fbbf24,#ff6b35);border-radius:2px;transition:width .3s ease}
/* Streak unlock modal */
.streak-unlock-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;animation:fadeIn .3s ease}
.streak-unlock-card{background:linear-gradient(170deg,#161628,#0c0c18);border:1px solid rgba(251,191,36,.3);border-radius:20px;padding:2rem;text-align:center;max-width:300px;width:90%;animation:mi .4s ease}
.streak-unlock-card .su-emoji{font-size:2.5rem;margin-bottom:.8rem}
.streak-unlock-card .su-title{font-size:1.1rem;font-weight:700;color:#fbbf24;margin-bottom:.4rem}
.streak-unlock-card .su-desc{font-size:.8rem;color:var(--t2);margin-bottom:1rem;line-height:1.5}
.streak-unlock-card .su-content{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:.8rem;margin-bottom:1rem;font-size:.85rem;font-style:italic;color:var(--ac2);line-height:1.5}
/* Touch link */
.touch-link-area{padding:1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin:.8rem;text-align:center}
.touch-link-url{font-size:.65rem;color:var(--t3);word-break:break-all;margin:.5rem 0;padding:.4rem;background:var(--s2);border-radius:8px;font-family:'Courier New',monospace}
.touch-link-actions{display:flex;gap:.4rem;justify-content:center;margin-top:.5rem}
.touch-link-actions button{padding:.4rem .8rem;font-size:.7rem}

/* SCORE + STARS BADGE */
.pts-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;background:var(--gw);border:1px solid rgba(255,107,53,.15);border-radius:12px;font-size:.7rem;color:var(--ac);font-weight:600}
/* score/stars hidden — data preserved internally */
.pts-partner{display:none}

/* BOARDING PASS */
#boardingPass{justify-content:center;align-items:center;padding:1.5rem;text-align:center;background:var(--bg)}
.bp-card{width:320px;background:linear-gradient(170deg,#0c0c18,#161628,#0c0c18);border:1px solid rgba(255,255,255,.08);border-radius:24px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,.03) inset;position:relative}
.bp-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--ac),var(--pk),var(--ac))}
.bp-top{padding:1.2rem 1.5rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed var(--b1)}
.bp-logo{font-size:.7rem;font-weight:800;letter-spacing:.3em;color:var(--ac)}
.bp-type{font-size:.55rem;color:var(--t3);letter-spacing:.15em;text-transform:uppercase}
.bp-body{padding:1.5rem}
.bp-avatar{width:60px;height:60px;border-radius:50%;background:var(--s2);border:2px solid var(--ac);margin:0 auto .8rem;display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:800;color:#fff;letter-spacing:.03em;overflow:hidden}
.bp-name{font-size:1.2rem;font-weight:700;color:var(--t1);margin-bottom:.2rem}
.bp-since{font-size:.65rem;color:var(--t3);margin-bottom:1.2rem}
.bp-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.8rem;margin-bottom:1.2rem}
.bp-stat{text-align:center;flex:1}
.bp-stat-ico{font-size:1rem;margin-bottom:.15rem}
.bp-stat-num{font-size:1.3rem;font-weight:800;color:var(--ac);line-height:1}
.bp-stat-label{font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-top:.2rem}
.bp-barcode{padding:1rem 1.5rem;border-top:1px dashed var(--b1);display:flex;justify-content:center;gap:2px}
.bp-bar{width:2px;background:var(--t3);border-radius:1px}
.bp-footer{padding:.6rem;font-size:.5rem;color:var(--t3);letter-spacing:.15em;text-align:center}
.bp-actions{display:flex;gap:.8rem;margin-top:1.2rem}
.bp-dl{padding:.6rem 1.2rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:12px;color:#fff;font-size:.8rem;font-weight:600;cursor:pointer;font-family:inherit}
.bp-dl:active{transform:scale(.96)}

/* CONSTELLATION / REDE */
#history{flex-direction:column;background:var(--bg);overflow:hidden}
.const-header{display:flex;align-items:center;gap:.8rem;padding:.8rem 1.2rem;padding-top:max(env(safe-area-inset-top),.8rem);position:absolute;top:0;left:0;right:0;z-index:10;background:linear-gradient(180deg,rgba(2,2,5,.9) 0%,transparent 100%)}
.const-header h2{font-size:.82rem;font-weight:500;color:var(--t2);letter-spacing:.08em;text-transform:uppercase}
.const-copy{position:absolute;top:0;left:0;right:0;text-align:center;padding-top:calc(max(env(safe-area-inset-top),.8rem) + 3rem);z-index:5;pointer-events:none}
.const-copy p{font-size:.65rem;color:rgba(255,255,255,.2);font-weight:300;font-style:italic;line-height:1.7;letter-spacing:.05em}
.const-canvas-wrap{position:absolute;inset:0;z-index:1;background:radial-gradient(ellipse at 50% 45%,rgba(15,15,30,1) 0%,rgba(2,2,5,1) 70%)}
.const-canvas-wrap canvas{width:100%;height:100%;touch-action:none}
/* Node detail overlay */
.const-detail{position:absolute;bottom:0;left:0;right:0;z-index:20;background:rgba(10,10,14,.97);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.06);padding:0;padding-bottom:max(env(safe-area-inset-bottom),.8rem);opacity:0;transform:translateY(100%);transition:all .35s cubic-bezier(.22,1,.36,1);pointer-events:none;max-height:65vh;overflow-y:auto}
.const-detail.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.cd-handle{width:36px;height:4px;background:rgba(255,255,255,.15);border-radius:2px;margin:10px auto 0}
.cd-header{display:flex;align-items:center;gap:.75rem;padding:.8rem 1.2rem .4rem}
.cd-avatar{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:800;color:#fff;border:2px solid rgba(255,255,255,.08);overflow:hidden;position:relative;flex-shrink:0}
.cd-avatar img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0}
.cd-header-info{flex:1;min-width:0}
.cd-name{font-size:.95rem;font-weight:700;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cd-alias{font-size:.7rem;color:var(--t3);margin-top:1px}
.cd-tag{display:inline-block;font-size:.5rem;font-weight:800;padding:1px 6px;border-radius:6px;color:#111;vertical-align:middle;margin-left:.4rem;text-transform:uppercase}
.cd-close{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.06);border:none;color:var(--t3);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.cd-anon-preview{display:flex;align-items:center;gap:.45rem;flex-shrink:0;margin-left:auto;margin-right:.3rem}
.cd-anon-ball{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:800;color:#fff;border:1.5px solid rgba(255,255,255,.12);opacity:.7;flex-shrink:0}
.cd-anon-nick{font-size:.6rem;color:var(--t3);max-width:55px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}
.cd-anon-label{font-size:.5rem;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:.05em}
.cd-close:active{background:rgba(255,255,255,.12)}
.cd-stats{display:flex;gap:0;padding:0 1.2rem .3rem;overflow-x:auto;-webkit-overflow-scrolling:touch}
.cd-stat{flex:1;text-align:center;padding:.45rem .2rem;min-width:0}
.cd-stat-val{font-size:.85rem;font-weight:700;color:var(--t1)}
.cd-stat-lbl{font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.04em;margin-top:1px}
.cd-divider{height:1px;background:rgba(255,255,255,.04);margin:0 1.2rem}
.cd-section{padding:.5rem 1.2rem}
.cd-time{font-size:.65rem;color:var(--t3);display:flex;align-items:center;gap:.4rem}
.cd-time span{display:flex;align-items:center;gap:.2rem}
.cd-insta{display:inline-flex;align-items:center;gap:.3rem;padding:.35rem .7rem;background:linear-gradient(135deg,rgba(225,48,108,.12),rgba(131,58,180,.1));border:1px solid rgba(225,48,108,.18);border-radius:20px;color:#e1306c;font-size:.72rem;font-weight:500;text-decoration:none;transition:all .2s}
.cd-insta:active{transform:scale(.96);background:rgba(225,48,108,.2)}
.cd-selfie{width:44px;height:44px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,.06);margin-left:.3rem;cursor:pointer;transition:transform .15s}
.cd-selfie:active{transform:scale(.95)}
.cd-selfies-row{display:flex;gap:.3rem;padding:.3rem 0;flex-wrap:wrap}
.cd-selfie-zoom{position:fixed;top:0;left:0;right:0;bottom:0;z-index:500;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;transition:opacity .25s}
.cd-selfie-zoom.visible{opacity:1}
.cd-selfie-zoom img{max-width:85vw;max-height:70vh;border-radius:14px;object-fit:contain}
.cd-selfie-zoom .cd-zoom-delete{position:absolute;bottom:max(env(safe-area-inset-bottom),1.5rem);left:50%;transform:translateX(-50%);padding:.5rem 1.2rem;border-radius:12px;border:1px solid rgba(239,68,68,.3);background:rgba(239,68,68,.12);color:#ef4444;font-size:.7rem;font-weight:600;font-family:inherit;cursor:pointer;opacity:0;transition:opacity .3s}
.cd-selfie-zoom.hold-active .cd-zoom-delete{opacity:1}
.cd-actions{display:flex;gap:.4rem;padding:.4rem 1.2rem .2rem;flex-wrap:wrap}
.cd-action{flex:1;min-width:0;padding:.5rem .4rem;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:var(--t1);font-size:.72rem;font-weight:600;font-family:inherit;cursor:pointer;text-align:center;transition:all .15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cd-action:active{transform:scale(.97);background:rgba(255,255,255,.08)}
.cd-action.primary{background:linear-gradient(135deg,rgba(99,102,241,.2),rgba(139,92,246,.15));border-color:rgba(99,102,241,.25);color:#a5b4fc}
.cd-action.success{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.15);color:#86efac}
.cd-action.done{opacity:.5;pointer-events:none;font-size:.65rem}
.cd-action.danger{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.12);color:#fca5a5}
.cd-tip-btn{width:100%;padding:.55rem;background:linear-gradient(135deg,#22c55e,#16a34a);border:none;border-radius:12px;color:#fff;font-size:.75rem;font-weight:600;font-family:inherit;cursor:pointer;margin:.2rem 0}
.cd-tip-btn:active{transform:scale(.97)}
.cd-bio{font-size:.7rem;color:var(--t3);font-style:italic;padding:.2rem 0;line-height:1.4}
/* Notification panel */
.notif-btn{position:absolute;top:max(env(safe-area-inset-top),.6rem);right:.8rem;z-index:15;width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:all .2s}
.notif-btn:active{transform:scale(.9);background:rgba(255,255,255,.12)}
.notif-badge{position:absolute;top:-2px;right:-2px;min-width:16px;height:16px;border-radius:8px;background:#ef4444;font-size:.55rem;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;padding:0 4px;border:2px solid rgba(10,10,14,.95)}
.notif-panel{position:absolute;inset:0;z-index:25;background:rgba(10,10,14,.98);backdrop-filter:blur(16px);padding-top:max(env(safe-area-inset-top),.6rem);opacity:0;transform:translateX(100%);transition:all .3s cubic-bezier(.22,1,.36,1);pointer-events:none;overflow-y:auto}
.notif-panel.visible{opacity:1;transform:translateX(0);pointer-events:auto}
.notif-header{display:flex;align-items:center;gap:.6rem;padding:.6rem 1rem;border-bottom:1px solid rgba(255,255,255,.04)}
.notif-title{flex:1;font-size:.9rem;font-weight:700;color:var(--t1)}
.notif-close{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.06);border:none;color:var(--t3);font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.notif-item{display:flex;align-items:center;gap:.7rem;padding:.65rem 1rem;border-bottom:1px solid rgba(255,255,255,.03);transition:background .15s}
.notif-item:active{background:rgba(255,255,255,.04)}
.notif-ico{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;overflow:hidden;position:relative}
.notif-ico img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0}
.notif-content{flex:1;min-width:0}
.notif-text{font-size:.72rem;color:var(--t1);line-height:1.3}
.notif-text strong{font-weight:600;color:var(--t1)}
.notif-time{font-size:.58rem;color:var(--t3);margin-top:1px}
.notif-empty{text-align:center;padding:3rem 1rem;color:var(--t3);font-size:.8rem}

/* ENCOUNTER LOG */
#encounterLog{padding:0;overflow-y:auto}
.elog-header{display:flex;align-items:center;gap:.6rem;padding:max(env(safe-area-inset-top),.8rem) 1.2rem .6rem;border-bottom:1px solid var(--b1)}
.elog-header h2{font-size:1rem;font-weight:700;flex:1}
.elog-list{padding:.8rem 1rem;display:flex;flex-direction:column;gap:.6rem;padding-bottom:3rem}
.elog-item{background:var(--s1);border:1px solid var(--b1);border-radius:14px;padding:.7rem .8rem;display:flex;gap:.6rem;align-items:center;position:relative;overflow:hidden;touch-action:pan-y}
.elog-item-inner{display:flex;gap:.6rem;align-items:center;flex:1;min-width:0;transition:transform .2s ease;position:relative;z-index:1}
.elog-delete{position:absolute;right:0;top:0;bottom:0;width:70px;background:#ef4444;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.75rem;font-weight:600;z-index:0}
.elog-tip-btn{background:linear-gradient(135deg,#ff6b35,#e05520);border:none;color:#fff;font-size:.8rem;padding:.35rem .6rem;border-radius:1rem;cursor:pointer;flex-shrink:0;align-self:center}
.elog-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:800;color:#fff;flex-shrink:0}
.elog-info{flex:1;min-width:0}
.elog-name{font-size:.85rem;font-weight:600;color:var(--t1)}
.elog-phrase{font-size:.7rem;color:var(--t2);font-style:italic;margin-top:.15rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.elog-meta{display:flex;gap:.6rem;font-size:.62rem;color:var(--t3);margin-top:.25rem;flex-wrap:wrap}
.elog-meta span{display:flex;align-items:center;gap:.2rem}
.elog-tip{color:var(--ok);font-weight:600}
.elog-empty{text-align:center;padding:3rem 1.5rem;color:var(--t3);font-size:.82rem;line-height:1.6;font-weight:300}

/* MORE MENU (overlay) */
.more-menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:8000;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .25s ease}
.more-menu-sheet{background:linear-gradient(180deg,var(--s2),var(--s1));border-radius:24px 24px 0 0;width:100%;max-width:420px;padding:1.5rem;padding-bottom:max(env(safe-area-inset-bottom),1.5rem);animation:slideUp .35s cubic-bezier(.22,1,.36,1)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.more-menu-handle{width:32px;height:4px;background:var(--b1);border-radius:2px;margin:0 auto .8rem}
.more-menu-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
.more-menu-item{display:flex;flex-direction:column;align-items:center;gap:.4rem;padding:.8rem .4rem;background:var(--s2);border:1px solid var(--b1);border-radius:14px;cursor:pointer;transition:.15s}
.more-menu-item:active{transform:scale(.95);background:var(--s3)}
.more-menu-item .mm-ico{font-size:1.4rem}
.more-menu-item .mm-lbl{font-size:.68rem;color:var(--t2);font-weight:500;text-align:center}
.my-pf-btn{display:flex;align-items:center;gap:.7rem;width:100%;padding:.65rem .9rem;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:14px;color:var(--t1);font-size:.8rem;font-weight:500;font-family:inherit;cursor:pointer;transition:all .15s;text-align:left}
.my-pf-btn:active{transform:scale(.98);background:rgba(255,255,255,.06)}
.my-pf-ico{font-size:.7rem;flex-shrink:0;width:20px;text-align:center;color:var(--t3);font-weight:600;letter-spacing:.03em}
.my-pf-tag{margin-left:auto;font-size:.55rem;color:var(--ac);font-weight:600;white-space:nowrap;padding:.15rem .4rem;background:rgba(255,107,53,.1);border-radius:8px}
.my-pf-danger{color:rgba(248,113,113,.7);border-color:rgba(248,113,113,.08)}
.my-pf-divider{height:1px;background:rgba(255,255,255,.04);margin:.25rem 0}

/* COMPLETE PROFILE */
#completeProfile{padding:1.5rem;overflow-y:auto}
.cp-header{text-align:center;margin-bottom:1.5rem;padding-top:env(safe-area-inset-top,1rem)}
.cp-header h2{font-size:1.2rem;font-weight:700;color:var(--t1)}
.cp-header p{font-size:.75rem;color:var(--t2);margin-top:.3rem}
.cp-photo-wrap{display:flex;flex-direction:column;align-items:center;gap:.6rem;margin-bottom:1.5rem}
.cp-photo{width:100px;height:100px;border-radius:50%;background:var(--s2);border:2px solid var(--b1);overflow:hidden;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative}
.cp-photo img{width:100%;height:100%;object-fit:cover}
.cp-photo-label{font-size:.7rem;color:var(--ac);cursor:pointer}
.cp-field{margin-bottom:1.2rem}
.cp-field label{display:block;font-size:.68rem;color:var(--t2);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.4rem;font-weight:600}
.cp-field input,.cp-field textarea{width:100%;padding:.75rem .9rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:.9rem;font-family:inherit;outline:none;transition:border-color .2s}
.cp-field input:focus,.cp-field textarea:focus{border-color:var(--ac)}
.cp-field textarea{resize:none;height:70px}
.cp-note{font-size:.65rem;color:var(--t3);margin-top:.3rem}
.cp-actions{display:flex;gap:.8rem;margin-top:1.5rem;padding-bottom:2rem}
.cp-actions .bp{flex:1}
.cp-actions .bs{flex:0}

/* REVEAL IDENTITY */
/* ID Request/Reveal buttons — eye-catching in chat actions */
@keyframes id-btn-glow{0%,100%{box-shadow:none}50%{box-shadow:0 0 12px rgba(255,107,53,.15)}}
/* Floating ID buttons in constellation detail */
.id-float-btn{display:inline-flex;align-items:center;gap:.4rem;padding:.5rem 1rem;border-radius:20px;font-size:.75rem;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .2s;box-shadow:0 4px 16px rgba(0,0,0,.3)}
.id-float-btn.request{background:linear-gradient(135deg,#7c3aed,#a371f7);color:#fff}
.id-float-btn.reveal{background:linear-gradient(135deg,var(--ac),var(--pk));color:#fff}
.id-float-btn:active{transform:scale(.93)}
.reveal-req-popup{display:none}
.reveal-chat-card{margin:.5rem .4rem;padding:0;animation:mi .3s ease}
.rcc-header{display:flex;align-items:center;gap:.6rem;padding:.8rem;background:linear-gradient(135deg,rgba(255,200,87,.06),rgba(255,107,53,.06));border:1px solid rgba(255,200,87,.2);border-radius:14px}
.rcc-icon{font-size:1.3rem}
.rcc-text{font-size:.78rem;color:var(--t2);line-height:1.4}
.rcc-actions{display:flex;gap:.4rem;margin-top:.4rem;padding:0 .8rem .6rem}
.rcc-status{text-align:center;font-size:.72rem;padding:.4rem .8rem;border-radius:10px;margin-top:.3rem}
.rcc-status.pending{color:#fbbf24;background:rgba(251,191,36,.08)}
.rcc-status.accepted{color:var(--ok);background:rgba(52,211,153,.08)}
.rcc-status.declined{color:var(--t3);background:rgba(255,255,255,.03)}
.rcc-revealed{text-align:center;padding:1rem;background:linear-gradient(135deg,rgba(52,211,153,.06),rgba(0,220,130,.04));border:1px solid rgba(52,211,153,.2);border-radius:16px}
.rcc-revealed-title{font-size:.9rem;font-weight:700;color:var(--ok);margin-bottom:.6rem}
.rcc-revealed-pair{display:flex;justify-content:center;align-items:center;gap:.8rem;margin:.5rem 0}
.rcc-photo{width:52px;height:52px;border-radius:50%;object-fit:cover;border:2px solid var(--ok)}
.rcc-photo-placeholder{width:52px;height:52px;border-radius:50%;background:var(--ac);display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:800;color:#fff}
.rcc-heart{font-size:1.2rem}
.rcc-names{display:flex;justify-content:center;gap:2rem;margin:.3rem 0}
.rcc-name{font-size:.8rem;font-weight:600;color:var(--t1)}
.rcc-insta{display:inline-flex;align-items:center;gap:.3rem;padding:.3rem .7rem;margin-top:.4rem;background:linear-gradient(135deg,rgba(225,48,108,.12),rgba(131,58,180,.12));border:1px solid rgba(225,48,108,.2);border-radius:20px;color:#e1306c;font-size:.7rem;font-weight:500;text-decoration:none}
.reveal-req-content{display:flex;align-items:center;gap:.8rem;margin-bottom:1rem}
.reveal-req-actions{display:flex;gap:.5rem}
.id-revealed-card{background:var(--s1);border:1px solid var(--ac);border-radius:14px;padding:.8rem;display:flex;align-items:center;gap:.8rem;margin:.5rem 0}
.id-revealed-card img{width:44px;height:44px;border-radius:50%;object-fit:cover}
.id-revealed-card .id-name{font-size:.9rem;font-weight:600;color:var(--t1)}
.id-revealed-card .id-bio{font-size:.7rem;color:var(--t2)}
.const-empty{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.8rem;z-index:5;padding:2rem}
.const-empty-icon{font-size:2rem;opacity:.2}
.const-empty-text{font-size:.8rem;color:var(--t3);font-weight:300;text-align:center;line-height:1.7;max-width:220px}
.const-feedback{position:absolute;top:calc(max(env(safe-area-inset-top),.8rem) + 3.5rem);left:50%;transform:translateX(-50%);z-index:15;font-size:.68rem;color:var(--ac2);font-weight:400;font-style:italic;opacity:0;transition:opacity .5s;pointer-events:none;white-space:nowrap}
.const-feedback.show{opacity:1}

/* EXPIRE CARD */
#expireCard{justify-content:center;align-items:center;padding:2rem;text-align:center}
.ev{width:270px;aspect-ratio:9/16;background:linear-gradient(170deg,#0a0a12,#15152a,#0a0a12);border:1px solid var(--b2);border-radius:24px;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:2.5rem;gap:1.5rem;position:relative;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.ev::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg,transparent,rgba(255,107,53,.04),transparent,rgba(255,61,113,.04),transparent);animation:sh 10s linear infinite}
@keyframes sh{to{transform:rotate(360deg)}}
.ev .cl{font-size:.85rem;font-weight:800;letter-spacing:.3em;color:var(--ac);opacity:.5;position:relative}
.ev .cf{font-size:1.15rem;font-weight:300;color:var(--t1);line-height:1.7;position:relative}
.ev .ctm{font-size:.72rem;color:var(--t2);position:relative}
.ev .cft{font-size:.6rem;color:var(--t3);position:absolute;bottom:1.5rem}
.ea{display:flex;gap:1rem;margin-top:1.5rem}

/* PROFILE */
#profile{flex-direction:column;background:var(--bg)}
.pf-header{display:flex;align-items:center;gap:.8rem;padding:1rem;background:var(--s1);border-bottom:1px solid var(--b1);padding-top:max(env(safe-area-inset-top),1rem)}
.pf-header h2{font-size:1.05rem;font-weight:600}
.pf-scroll{flex:1;overflow-y:auto;padding:1rem}
.pf-card{text-align:center;padding:1.5rem;background:linear-gradient(170deg,var(--s1),rgba(26,26,36,.6));border:1px solid rgba(255,255,255,.06);border-radius:20px;margin-bottom:1rem;position:relative;overflow:hidden}
.pf-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 50% 0%,rgba(255,107,53,.04),transparent 60%);pointer-events:none}
.pf-stats{display:flex;justify-content:center;gap:1.5rem;margin-top:1rem}
.pf-stat{text-align:center}
.pf-stat-num{font-size:1.3rem;font-weight:800;color:var(--ac)}
.pf-stat-lbl{font-size:.6rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em}
.pf-section{margin-bottom:1.2rem}
.pf-section-title{font-size:.75rem;color:var(--t2);text-transform:uppercase;letter-spacing:.12em;font-weight:600;margin-bottom:.6rem;padding-left:.3rem}
.pf-decl{padding:.7rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;margin-bottom:.5rem;border-left:3px solid var(--ac)}
.pf-decl-text{font-size:.85rem;color:var(--t1);font-style:italic;line-height:1.5;margin-bottom:.3rem}
.pf-decl-from{font-size:.65rem;color:var(--t3)}
.pf-gift{display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;margin-bottom:.5rem}
.pf-gift-emoji{font-size:1.4rem}
.pf-gift-info{flex:1;min-width:0}
.pf-gift-name{font-size:.82rem;color:var(--t1);font-weight:500}
.pf-gift-from{font-size:.65rem;color:var(--t3)}
.pf-gift-msg{font-size:.72rem;color:var(--t2);font-style:italic;margin-top:.1rem}
.pf-actions{display:flex;gap:.5rem;margin-top:1rem;flex-wrap:wrap;justify-content:center}
.pf-act-btn{padding:.5rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t2);font-size:.78rem;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:.4rem;transition:.15s}
.pf-act-btn:active{background:var(--ac);color:#fff;border-color:var(--ac)}
.pf-empty{font-size:.8rem;color:var(--t3);text-align:center;padding:1rem;font-style:italic}

/* GIFT PICKER MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:200;display:flex;align-items:flex-end;justify-content:center;animation:mfade .25s ease;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
@keyframes mfade{from{opacity:0}to{opacity:1}}
.modal-sheet{width:100%;max-width:420px;max-height:75vh;background:linear-gradient(180deg,var(--s2),var(--s1));border-radius:24px 24px 0 0;padding:1.2rem;overflow-y:auto;animation:mslide .3s cubic-bezier(.22,1,.36,1);padding-bottom:max(env(safe-area-inset-bottom),1.2rem)}
@keyframes mslide{from{transform:translateY(100%)}to{transform:none}}
.modal-handle{width:36px;height:4px;border-radius:2px;background:var(--b1);margin:0 auto .8rem}
.modal-title{font-size:1rem;font-weight:700;text-align:center;margin-bottom:1rem}
.gift-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:1rem}
.gift-option{padding:.8rem;background:var(--s2);border:1px solid var(--b1);border-radius:14px;text-align:center;cursor:pointer;transition:.15s}
.gift-option:active{border-color:var(--ac);background:var(--gw)}
.gift-option .g-emoji{font-size:1.6rem}
.gift-option .g-name{font-size:.78rem;font-weight:600;color:var(--t1);margin-top:.3rem}
.gift-option .g-desc{font-size:.62rem;color:var(--t3);margin-top:.2rem}
.decl-input{width:100%;padding:.8rem;background:var(--s2);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:.88rem;font-family:inherit;resize:none;outline:none;min-height:80px}
.decl-input:focus{border-color:var(--ac)}
.decl-counter{font-size:.6rem;color:var(--t3);text-align:right;margin-top:.3rem}
.gift-msg-input{width:100%;padding:.6rem;background:var(--s2);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;margin-top:.6rem}
.gift-msg-input:focus{border-color:var(--ac)}

/* ADDRESS REQUEST BANNER */
.addr-request{padding:.8rem 1rem;background:linear-gradient(135deg,rgba(255,107,53,.08),rgba(255,61,113,.05));border:1px solid rgba(255,107,53,.15);border-radius:14px;margin:.5rem .8rem;animation:mi .3s ease}
.addr-request-text{font-size:.82rem;color:var(--t1);line-height:1.5;margin-bottom:.6rem}
.addr-request-note{font-size:.68rem;color:var(--t3);margin-bottom:.6rem;font-style:italic}
.addr-input{width:100%;padding:.6rem;background:var(--s2);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;margin-bottom:.5rem}
.addr-input:focus{border-color:var(--ac)}
.addr-actions{display:flex;gap:.5rem}
.addr-btn{padding:.4rem .8rem;border-radius:10px;font-size:.75rem;font-family:inherit;cursor:pointer;border:none}
.addr-btn.accept{background:var(--ac);color:#fff}
.addr-btn.decline{background:var(--s2);color:var(--t2);border:1px solid var(--b1)}

/* LOCATION / EVENTS */
#locationScreen{flex-direction:column;background:var(--bg)}
#eventDetail{flex-direction:column;background:var(--bg)}
.loc-header{display:flex;align-items:center;gap:.8rem;padding:.8rem 1rem;background:var(--s1);border-bottom:1px solid var(--b1);padding-top:max(env(safe-area-inset-top),1rem)}
.loc-header h2{font-size:1rem;font-weight:600;flex:1}
.loc-header .bs{font-size:.68rem;padding:.3rem .7rem}
.loc-scroll{flex:1;overflow-y:auto;padding:1rem;-webkit-overflow-scrolling:touch}
.loc-status{text-align:center;padding:.7rem;font-size:.75rem;color:var(--t2);background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin-bottom:.8rem;display:flex;align-items:center;justify-content:center;gap:.4rem}
.loc-status.active{border-color:var(--ok);color:var(--ok);background:rgba(52,211,153,.05)}
.loc-status.error{border-color:var(--err);color:var(--err)}
.loc-tabs{display:flex;gap:.3rem;margin-bottom:.8rem;background:var(--s1);border-radius:12px;padding:.25rem;border:1px solid var(--b1)}
.loc-tab{flex:1;padding:.45rem;text-align:center;font-size:.75rem;font-weight:600;background:transparent;border:none;border-radius:10px;color:var(--t3);cursor:pointer;font-family:inherit;transition:.2s}
.loc-tab.active{background:var(--ac);color:#fff;box-shadow:0 2px 8px rgba(255,107,53,.3)}
.loc-person{display:flex;align-items:center;gap:.6rem;padding:.65rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin-bottom:.5rem;transition:.15s;animation:mi .3s ease}
.loc-person:active{background:var(--s2);transform:scale(.98)}
.loc-person-info{flex:1;min-width:0}
.loc-person-nick{font-size:.82rem;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.loc-person-dist{font-size:.62rem;color:var(--t3);margin-top:.1rem}
.loc-person-pts{font-size:.65rem;color:var(--ac);margin-top:.1rem}
.loc-encosta-btn{padding:.35rem .7rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:10px;color:#fff;font-size:.68rem;font-weight:700;cursor:pointer;font-family:inherit;flex-shrink:0;letter-spacing:.03em;box-shadow:0 2px 8px rgba(255,107,53,.2);transition:.15s}
.loc-encosta-btn:active{transform:scale(.94)}
.evt-card{padding:.8rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:14px;margin-bottom:.5rem;transition:.15s;animation:mi .3s ease}
.evt-card:active{background:var(--s2);transform:scale(.98)}
.evt-card-name{font-size:.88rem;font-weight:700;color:var(--t1);margin-bottom:.25rem}
.evt-card-meta{font-size:.65rem;color:var(--t3);display:flex;gap:.8rem;margin-bottom:.25rem}
.evt-card-desc{font-size:.72rem;color:var(--t2);font-style:italic;line-height:1.4}
.evt-card-people{font-size:.65rem;color:var(--ac);margin-top:.25rem;font-weight:500}
.evt-detail{padding:1.2rem;background:var(--s1);border:1px solid var(--b1);border-radius:16px;margin-bottom:1rem}
.evt-detail-name{font-size:1.05rem;font-weight:700;color:var(--t1);margin-bottom:.4rem}
.evt-detail-desc{font-size:.8rem;color:var(--t2);font-style:italic;margin-bottom:.8rem;line-height:1.5;padding:.5rem .6rem;background:var(--s2);border-radius:10px}
.evt-ppl-title{font-size:.7rem;color:var(--t2);text-transform:uppercase;letter-spacing:.1em;font-weight:600;margin-bottom:.5rem}
.loc-create-form{padding:1.2rem;background:var(--s1);border:1px solid var(--b1);border-radius:16px;margin-bottom:1rem;animation:mi .3s ease}
.loc-create-form .form-title{font-size:.92rem;font-weight:700;color:var(--t1);margin-bottom:.3rem}
.loc-create-form .form-sub{font-size:.68rem;color:var(--t3);margin-bottom:1rem;line-height:1.4}
.loc-fg{margin-bottom:.8rem}
.loc-fg label{display:block;font-size:.65rem;color:var(--t2);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.3rem;font-weight:600}
.loc-fg input,.loc-fg textarea{width:100%;padding:.65rem .8rem;background:var(--s2);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:.82rem;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s}
.loc-fg textarea{min-height:60px;resize:none}
.loc-fg input:focus,.loc-fg textarea:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.loc-empty{text-align:center;padding:2.5rem 1rem;color:var(--t3);font-size:.82rem;line-height:1.6}
.loc-empty-icon{font-size:2rem;margin-bottom:.6rem;opacity:.5}

/* REVEAL EXTRAS */
.rv-last{font-size:.68rem;color:var(--t3);margin-top:.4rem;padding:.3rem .8rem;background:var(--s1);border-radius:10px;border:1px solid var(--b1)}

/* CONTACT REQUEST */
.contact-menu{display:flex;gap:.3rem;flex-wrap:wrap;padding:.4rem .8rem;animation:mi .3s ease}
.contact-opt{padding:.3rem .6rem;font-size:.68rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;color:var(--t2);cursor:pointer;font-family:inherit}
.contact-opt:active{background:var(--s2)}
.contact-req-banner{padding:.6rem .8rem;background:linear-gradient(135deg,rgba(255,107,53,.06),rgba(255,61,113,.04));border:1px solid rgba(255,107,53,.12);border-radius:12px;margin:.4rem .8rem;animation:mi .3s ease}
.contact-req-text{font-size:.78rem;color:var(--t1);margin-bottom:.4rem}
.contact-req-actions{display:flex;gap:.4rem}
.contact-req-input{width:100%;padding:.4rem .6rem;background:var(--s2);border:1px solid var(--b1);border-radius:8px;color:var(--t1);font-size:.78rem;font-family:inherit;outline:none;margin-bottom:.4rem}

/* ENCOSTA REQUEST NOTIFICATION */
.encosta-req-banner{position:fixed;top:max(env(safe-area-inset-top),1rem);left:1rem;right:1rem;padding:1rem;background:var(--s1);border:1px solid var(--ac);border-radius:16px;z-index:9000;animation:mi .3s ease;box-shadow:0 8px 30px rgba(0,0,0,.5)}
.encosta-req-title{font-size:.82rem;font-weight:600;color:var(--t1);margin-bottom:.4rem}
.encosta-req-sub{font-size:.68rem;color:var(--t3);margin-bottom:.6rem}
.encosta-req-actions{display:flex;gap:.5rem}

/* LANG SWITCHER */
.lang-sw{display:flex;gap:.25rem}
.lang-btn{padding:.15rem .35rem;background:transparent;border:1px solid rgba(255,255,255,.06);border-radius:6px;color:var(--t3);font-size:.52rem;font-weight:600;cursor:pointer;font-family:inherit;text-transform:uppercase;transition:.15s}
.lang-btn.active{color:var(--ac);border-color:rgba(255,107,53,.3)}

/* GORJETA / TIP */
#tipScreen{padding:1.5rem;padding-top:max(env(safe-area-inset-top),1rem);overflow-y:auto}
.tip-header{display:flex;align-items:center;gap:.8rem;margin-bottom:1.5rem}
.tip-receiver{display:flex;flex-direction:column;align-items:center;gap:.6rem;text-align:center;margin-bottom:1.5rem}
.tip-receiver-avatar{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:800;color:#fff;border:2px solid var(--ac)}
.tip-receiver-name{font-size:1.1rem;font-weight:600;color:var(--t1)}
.tip-receiver-service{font-size:.72rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;font-weight:500}
.tip-amounts{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin-bottom:1.2rem}
.tip-amount-btn{padding:.8rem .4rem;background:var(--s1);border:1.5px solid rgba(255,255,255,.06);border-radius:14px;color:var(--t1);font-size:1rem;font-weight:700;font-family:inherit;cursor:pointer;transition:.15s;text-align:center}
.tip-amount-btn:active,.tip-amount-btn.selected{background:var(--ac);border-color:var(--ac);color:#fff;transform:scale(.96)}
.tip-custom{display:flex;align-items:center;gap:.6rem;margin-bottom:1.5rem}
.tip-custom label{font-size:.75rem;color:var(--t3);font-weight:500;white-space:nowrap}
.tip-custom input{flex:1;padding:.7rem 1rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:1.1rem;font-family:inherit;outline:none;text-align:center}
.tip-custom input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--gw)}
.tip-card-section{margin-bottom:1.5rem}
.tip-card-section h3{font-size:.75rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;font-weight:600;margin-bottom:.8rem}
.tip-card-fields{display:flex;flex-direction:column;gap:.6rem}
.tip-card-row{display:flex;gap:.5rem}
.tip-field{flex:1;padding:.7rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;min-height:42px}
.tip-field iframe{border:none!important;height:24px!important}
.tip-input{width:100%;padding:.7rem .8rem;background:var(--s1);border:1px solid var(--b1);border-radius:12px;color:var(--t1);font-size:14px;font-family:inherit;outline:none;margin-top:.4rem}
.tip-input::placeholder{color:#555568}
.pay-spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.tip-saved-section{margin-bottom:1rem}
.tip-saved-card{width:100%;display:flex;align-items:center;gap:.7rem;padding:.8rem 1rem;background:rgba(52,211,153,.06);border:1.5px solid rgba(52,211,153,.25);border-radius:14px;color:#34d399;font-family:inherit;cursor:pointer;transition:.15s}
.tip-saved-card.active{border-color:#34d399;background:rgba(52,211,153,.12)}
.tsc-icon{font-size:1.2rem}
.tsc-info{flex:1;text-align:left;font-size:.82rem;font-weight:500}
.tsc-brand{text-transform:capitalize}
.tsc-check{font-size:.9rem;opacity:0;transition:.2s}
.tip-saved-card.active .tsc-check{opacity:1}
.tip-new-card-link{background:none;border:none;color:var(--t3);font-size:.68rem;font-family:inherit;cursor:pointer;padding:.4rem 0;text-decoration:underline}
.tip-save-check{display:flex;align-items:center;gap:.5rem;font-size:.7rem;color:var(--t3);margin-top:.6rem;cursor:pointer}
.tip-save-check input{accent-color:var(--ac)}
.tip-pay-btn{width:100%;padding:1rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:16px;color:#fff;font-size:.95rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.04em;box-shadow:0 4px 15px rgba(255,107,53,.3);transition:.15s}
.tip-pay-btn:active{transform:scale(.97)}
.tip-pay-btn:disabled{opacity:.4}
.tip-result{display:flex;flex-direction:column;align-items:center;gap:.8rem;text-align:center;padding:2rem 0}
.tip-result-icon{font-size:3rem}
.tip-result-text{font-size:.9rem;color:var(--t2);font-weight:300;line-height:1.6}
/* Prestador register */
#prestadorReg{padding:1.5rem;padding-top:max(env(safe-area-inset-top),1rem);overflow-y:auto}
.preg-title{font-size:1.2rem;font-weight:700;color:var(--ac);margin-bottom:.3rem}
.preg-sub{font-size:.75rem;color:var(--t3);margin-bottom:1.5rem;line-height:1.5}
.preg-services{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:1.5rem}
.preg-svc{padding:.7rem .6rem;background:var(--s1);border:1.5px solid rgba(255,255,255,.06);border-radius:12px;color:var(--t2);font-size:.75rem;font-family:inherit;cursor:pointer;text-align:center;transition:.15s}
.preg-svc:active,.preg-svc.selected{background:var(--ac);border-color:var(--ac);color:#fff}
.preg-mp-status{padding:.8rem 1rem;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.2);border-radius:12px;font-size:.75rem;color:var(--ok);text-align:center;margin-bottom:1rem}
.preg-mp-status.pending{background:rgba(251,191,36,.08);border-color:rgba(251,191,36,.2);color:var(--warn)}

/* ONBOARDING */
#onboarding{padding:0;overflow:hidden;background:var(--bg)}
.onb-slides{display:flex;transition:transform .4s cubic-bezier(.22,1,.36,1);height:100%}
.onb-slide{min-width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2.5rem 2rem;text-align:center;position:relative}
.onb-icon{font-size:3.5rem;margin-bottom:1.5rem;opacity:0;animation:fi .8s ease .3s forwards}
.onb-title{font-size:1.4rem;font-weight:800;color:var(--t1);margin-bottom:.6rem;letter-spacing:-.02em;opacity:0;animation:fi .8s ease .5s forwards}
.onb-desc{font-size:.85rem;color:var(--t2);line-height:1.7;max-width:280px;opacity:0;animation:fi .8s ease .7s forwards}
.onb-dots{position:absolute;bottom:max(env(safe-area-inset-bottom),2rem);left:50%;transform:translateX(-50%);display:flex;gap:.5rem}
.onb-dot{width:8px;height:8px;border-radius:50%;background:var(--b1);transition:all .3s}
.onb-dot.active{background:var(--ac);width:24px;border-radius:4px}
.onb-nav{position:absolute;bottom:calc(max(env(safe-area-inset-bottom),2rem) + 2rem);left:50%;transform:translateX(-50%);display:flex;gap:.8rem;align-items:center}
.onb-skip{padding:.5rem 1rem;background:transparent;border:none;color:var(--t3);font-size:.78rem;font-family:inherit;cursor:pointer}
.onb-next{padding:.6rem 1.8rem;background:linear-gradient(135deg,var(--ac),var(--pk));border:none;border-radius:14px;color:#fff;font-size:.85rem;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:.04em}
.onb-next:active{transform:scale(.96)}

/* ZODIAC */
/* Zodiac area — poetic, constellation-style */
.zodiac-area{margin-top:.8rem;opacity:0;animation:fi 1.5s ease 5s forwards;display:flex;flex-direction:column;align-items:center;gap:.8rem}
.zodiac-elements{font-size:.68rem;color:var(--t3);letter-spacing:.2em;text-transform:lowercase;font-weight:300}
.zodiac-elements em{color:var(--ac2);font-style:normal;font-weight:500;letter-spacing:.1em}
/* Constellation glyphs — large, elegant, thin */
.zodiac-constellation{display:flex;align-items:center;gap:1.8rem;justify-content:center}
.zc-sign{display:flex;flex-direction:column;align-items:center;gap:.4rem}
.zc-glyph{width:56px;height:56px;border-radius:50%;background:transparent;border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:1.8rem;color:var(--t1);font-weight:200;position:relative;overflow:hidden}
.zc-glyph::before{content:'';position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.06) 0%,transparent 70%)}
.zc-glyph::after{content:'';position:absolute;inset:-1px;border-radius:50%;border:1px solid transparent;background:conic-gradient(from 0deg,rgba(255,107,53,.15),transparent 30%,transparent 70%,rgba(255,61,113,.15)) border-box;-webkit-mask:linear-gradient(#fff 0 0) padding-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude}
.zc-trait{font-size:.52rem;color:var(--t3);text-transform:uppercase;letter-spacing:.15em;font-weight:500}
.zc-name{font-size:.5rem;color:rgba(255,255,255,.2);letter-spacing:.08em;font-weight:400}
.zc-bridge{display:flex;flex-direction:column;align-items:center;gap:.3rem}
.zc-line{width:30px;height:1px;background:linear-gradient(90deg,rgba(255,107,53,.3),rgba(255,61,113,.3));position:relative}
.zc-line::after{content:'';position:absolute;top:-2px;left:50%;transform:translateX(-50%);width:5px;height:5px;border-radius:50%;background:var(--ac);opacity:.4;box-shadow:0 0 8px var(--ac)}
/* Zodiac phrase — pure poetry, no box */
.zodiac-phrase{font-size:.85rem;color:var(--t2);font-style:italic;line-height:1.7;max-width:260px;text-align:center;font-weight:300;letter-spacing:.01em}

/* REVEAL SELFIE v2 — side by side */

/* CONNECTING OVERLAY — after sonic match, before reveal */
/* Connecting overlay — organic cosmos birth */
/* ═══ CONNECTING OVERLAY — ELECTRIC TOUCH ═══ */
.connecting-overlay{position:fixed;inset:0;z-index:150;background:#020205;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.connecting-overlay.active{opacity:1;pointer-events:auto}
.co-canvas-el{position:absolute;inset:0;z-index:0}
/* Phones container */
.co-phones{position:relative;z-index:2;display:flex;align-items:center;justify-content:center;gap:0;opacity:0;animation:co-phones-in .8s ease .2s forwards}
@keyframes co-phones-in{0%{opacity:0;gap:80px}60%{gap:2px;opacity:1}80%{gap:6px}100%{gap:3px;opacity:1}}
.co-phone{width:52px;height:88px;border-radius:10px;border:2px solid rgba(255,255,255,.5);position:relative;overflow:hidden;background:rgba(10,10,20,.9)}
.co-phone.left{transform:rotate(-8deg);border-color:rgba(255,255,255,.4)}
.co-phone.right{transform:rotate(8deg);border-color:rgba(255,255,255,.4)}
.co-phone-screen{position:absolute;inset:4px 3px;border-radius:6px;overflow:hidden}
.co-phone-notch{position:absolute;top:2px;left:50%;transform:translateX(-50%);width:16px;height:3px;border-radius:2px;background:rgba(255,255,255,.15);z-index:1}
.co-phone-btn{position:absolute;bottom:3px;left:50%;transform:translateX(-50%);width:8px;height:8px;border-radius:50%;border:1px solid rgba(255,255,255,.12)}
/* Electric canvas fills each phone screen */
.co-phone-canvas{width:100%;height:100%;display:block}
/* Center spark point */
.co-spark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:6px;height:6px;border-radius:50%;z-index:3;opacity:0}
.connecting-overlay.active .co-spark{animation:co-spark-pulse 4s ease forwards}
@keyframes co-spark-pulse{0%{opacity:0;width:2px;height:2px}10%{opacity:1;width:10px;height:10px;box-shadow:0 0 30px 15px var(--co-glow,rgba(255,255,255,.7)),0 0 80px 30px var(--co-glow2,rgba(255,255,255,.3))}25%{width:14px;height:14px;box-shadow:0 0 50px 20px var(--co-glow,rgba(255,255,255,.8)),0 0 120px 50px var(--co-glow2,rgba(255,255,255,.4)),0 0 200px 80px var(--co-glow3,rgba(255,255,255,.1))}50%{width:8px;height:8px;opacity:1;box-shadow:0 0 30px 10px var(--co-glow,rgba(255,255,255,.5)),0 0 80px 30px var(--co-glow2,rgba(255,255,255,.2))}100%{width:4px;height:4px;opacity:.6;box-shadow:0 0 20px 8px var(--co-glow,rgba(255,255,255,.3))}}
/* Flash overlay */
.co-flash{position:absolute;inset:0;z-index:4;pointer-events:none;opacity:0}
.connecting-overlay.active .co-flash{animation:co-fullflash 3.5s ease forwards}
@keyframes co-fullflash{0%{opacity:0}8%{opacity:.7}12%{opacity:0}20%{opacity:.4}24%{opacity:0}35%{opacity:.2}38%{opacity:0}55%{opacity:.15}58%{opacity:0}100%{opacity:0}}
/* Text */
.co-text{position:relative;z-index:5;margin-top:2rem;font-size:.88rem;font-weight:300;letter-spacing:.12em;opacity:0;animation:co-text-in 1.5s ease .6s forwards}
@keyframes co-text-in{0%{opacity:0;transform:translateY(10px);filter:blur(4px)}100%{opacity:.8;transform:translateY(0);filter:blur(0)}}
.co-dots{position:relative;z-index:5;display:flex;gap:5px;margin-top:.5rem}
.co-dots span{width:5px;height:5px;border-radius:50%;opacity:.3;animation:co-dot-beat 1.2s ease-in-out infinite}
.co-dots span:nth-child(2){animation-delay:.2s}
.co-dots span:nth-child(3){animation-delay:.4s}
@keyframes co-dot-beat{0%,100%{opacity:.2;transform:scale(.7)}50%{opacity:1;transform:scale(1.3)}}
/* Color themes */
.connecting-overlay.first{--co-color:rgba(255,255,255,.9);--co-glow:rgba(255,255,255,.7);--co-glow2:rgba(200,220,255,.4);--co-glow3:rgba(180,200,255,.15)}
.connecting-overlay.first .co-spark{background:#fff}
.connecting-overlay.first .co-flash{background:radial-gradient(circle at 50% 50%,rgba(255,255,255,.5),rgba(200,220,255,.2),transparent 70%)}
.connecting-overlay.first .co-dots span{background:#fff}
.connecting-overlay.first .co-text{color:rgba(255,255,255,.8)}
.connecting-overlay.renewed{--co-color:rgba(255,200,60,.9);--co-glow:rgba(255,200,60,.7);--co-glow2:rgba(255,170,30,.4);--co-glow3:rgba(255,140,0,.15)}
.connecting-overlay.renewed .co-spark{background:#ffc83c}
.connecting-overlay.renewed .co-flash{background:radial-gradient(circle at 50% 50%,rgba(255,200,60,.4),rgba(255,160,30,.15),transparent 70%)}
.connecting-overlay.renewed .co-dots span{background:#ffc83c}
.connecting-overlay.renewed .co-text{color:rgba(255,210,80,.8)}

/* UTILS */
.hidden{display:none!important}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);padding:.7rem 1.5rem;background:rgba(24,24,36,.92);border:1px solid rgba(255,255,255,.1);border-radius:20px;color:var(--t1);font-size:.82rem;z-index:9999;pointer-events:none;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);box-shadow:0 8px 32px rgba(0,0,0,.4);max-width:85%;text-align:center;font-weight:500}
@keyframes toast-in{0%{opacity:0;transform:translateX(-50%) translateY(12px) scale(.95)}100%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}
@keyframes toast-out{0%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}100%{opacity:0;transform:translateX(-50%) translateY(-8px) scale(.95)}}
@keyframes tin{from{opacity:0;transform:translateX(-50%) translateY(12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
::-webkit-scrollbar{width:2px}::-webkit-scrollbar-thumb{background:var(--b1);border-radius:2px}
</style>
</head>
<body>

<div class="connecting-overlay" id="connectingOverlay">
  <canvas class="co-canvas-el" id="coCanvas"></canvas>
  <div class="co-flash" id="coFlash"></div>
  <div class="co-phones" id="coPhones">
    <div class="co-phone left">
      <div class="co-phone-notch"></div>
      <div class="co-phone-screen"><canvas class="co-phone-canvas" id="coPhoneL" width="92" height="160"></canvas></div>
      <div class="co-phone-btn"></div>
    </div>
    <div class="co-phone right">
      <div class="co-phone-notch"></div>
      <div class="co-phone-screen"><canvas class="co-phone-canvas" id="coPhoneR" width="92" height="160"></canvas></div>
      <div class="co-phone-btn"></div>
    </div>
  </div>
  <div class="co-spark" id="coSpark"></div>
  <div class="co-text" id="coText">algo está nascendo...</div>
  <div class="co-dots"><span></span><span></span><span></span></div>
</div>

<svg width="0" height="0" style="position:absolute"><defs><linearGradient id="verifiedGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#06b6d4"/><stop offset="50%" stop-color="#3b82f6"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient></defs></svg>
<div id="splash" class="screen active">
  <div class="logo">Touch?</div>
  <div class="tag">tudo nasce no gesto</div>
  <div style="position:absolute;bottom:max(env(safe-area-inset-bottom),2rem);font-size:.55rem;color:var(--t3);letter-spacing:.15em;opacity:.4">touchirl v3.0</div>
</div>

<div id="onboarding" class="screen">
  <div class="onb-slides" id="onbSlides">
    <div class="onb-slide">
      <div class="onb-icon">&#x2726;</div>
      <div class="onb-title">Tudo nasce no gesto</div>
      <div class="onb-desc">Touch? transforma encontros em momentos conscientes. Conexões só existem quando duas pessoas decidem estar presentes.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x1F91D;</div>
      <div class="onb-title">Toque para conectar</div>
      <div class="onb-desc">Encoste os celulares, mostre o QR ou use código. Vocês se conectam por 24 horas.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x23F3;</div>
      <div class="onb-title">24 horas, depois se dissolve</div>
      <div class="onb-desc">Cada conexão dura 24h. Conversem, presenteiem, declarem. Se quiserem mais tempo, encostem de novo.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x1F525;</div>
      <div class="onb-title">Streaks e estrelas</div>
      <div class="onb-desc">Encontros seguidos criam streaks com conquistas. Relações especiais geram estrelas que ficam para sempre no seu perfil.</div>
    </div>
    <div class="onb-slide">
      <div class="onb-icon">&#x2648;</div>
      <div class="onb-title">Signos e compatibilidade</div>
      <div class="onb-desc">A cada encontro, os astros falam. Uma frase única baseada nos signos dos dois revela a energia da conexão.</div>
    </div>
  </div>
  <div class="onb-nav">
    <button class="onb-skip" onclick="skipOnboarding()">Pular</button>
    <button class="onb-next" id="onbNextBtn" onclick="nextOnbSlide()">Próximo</button>
  </div>
  <div class="onb-dots" id="onbDots"></div>
</div>

<div id="login" class="screen">
  <div class="login-logo">Touch?</div>
  <div class="login-sub">encontros reais, conexões efêmeras</div>
  <button class="login-google" onclick="loginWithGoogle()">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
    Entrar com Google
  </button>
  <div class="login-divider">ou</div>
  <div class="login-form" id="loginForm">
    <input type="email" class="login-input" id="loginEmail" placeholder="E-mail" autocomplete="email">
    <input type="password" class="login-input" id="loginPass" placeholder="Senha" autocomplete="current-password">
    <input type="text" class="login-input hidden" id="loginNick" placeholder="Nickname (será seu nome anônimo)" maxlength="20" autocomplete="off">
    <div class="login-nick-explain hidden" id="loginNickExplain">Seu nickname é como as pessoas te veem antes de você revelar quem é de verdade.</div>
    <div class="tc hidden" id="loginTermsUso" style="margin:.5rem 0"><input type="checkbox" id="loginTermsCheck"><span style="font-size:.78rem">Li e aceito os <a href="/termos" target="_blank" style="color:var(--ac);text-decoration:underline">Termos de Uso</a></span></div>
    <button class="bp" id="loginBtn" onclick="loginWithEmail()">ENTRAR</button>
    <div class="login-err" id="loginErr"></div>
    <div class="login-toggle" id="loginToggle" onclick="toggleLoginMode()">Não tem conta? <strong>Criar agora — é rápido</strong></div>
  </div>
</div>

<div id="register" class="screen">
  <div class="rh"><h1>Touch?</h1><p>complete sua presença</p></div>
  <div class="avs">
    <div class="avp" id="avatarPreview" style="background:var(--s2)">?</div>
    <div class="nick-hint" id="nickHint">escolha um apelido criativo</div>
  </div>
  <div class="fg"><label>Nickname</label><input type="text" id="regNick" placeholder="apelido_criativo" maxlength="20" autocomplete="off" oninput="checkNick(this.value)"></div>
  <div class="reg-nick-info">Escolha um apelido criativo! Não use seu nome real — ele será seu segredo até você decidir revelar para alguém.</div>
  <div class="fg"><label>Data de nascimento</label><input type="date" id="regBirth"></div>
  <div class="tc"><input type="checkbox" id="regTerms"><span>Entendo e aceito que <strong>todas as relações aqui são temporárias</strong>. Nada persiste sem encontro.</span></div>
  <div class="tc"><input type="checkbox" id="regTermsUso"><span>Li e aceito os <a href="/termos" target="_blank" style="color:var(--ac);text-decoration:underline">Termos de Uso</a></span></div>
  <button class="bp" onclick="doRegister()">ENTRAR</button>
</div>

<div id="home" class="screen">
  <!-- Floating event button (persistent while event active) - positioned below daily counter -->
  <div id="floatingEventBtn" style="display:none;position:absolute;top:auto;bottom:calc(50% - 110px);left:50%;transform:translateX(-50%);z-index:8;padding:.5rem 1rem;background:rgba(96,165,250,.12);backdrop-filter:blur(12px);border:1px solid rgba(96,165,250,.25);border-radius:16px;cursor:pointer;animation:mi .35s ease both;white-space:nowrap" onclick="reopenEventView()">
    <span style="font-size:.7rem;font-weight:600;color:#60a5fa">📍 <span id="floatingEventName"></span> · Ver evento</span>
  </div>
  <canvas id="homeNodesCanvas" style="position:absolute;inset:0;z-index:0;pointer-events:none"></canvas>
  <div class="ptr-indicator" id="ptrIndicator"><div class="ptr-spinner"></div></div>
  <div class="fire-overlay" id="fireOverlay">
    <div class="fire-glow"></div><div class="fire-glow2"></div>
    <div class="fire-particles"><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div></div>
    <div class="fire-edge left"></div><div class="fire-edge right"></div>
    <div class="fire-speaker"><div class="fire-spk-wave"></div><div class="fire-spk-wave"></div><div class="fire-spk-wave"></div></div>
    <div class="sonic-instruct" id="sonicInstruct">
      <div class="si-scene">
        <div class="si-phone left">
          <div class="si-speaker"><div class="si-spk-dot"></div><div class="si-spk-dot"></div><div class="si-spk-dot"></div></div>
        </div>
        <div class="si-energy">
          <div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div>
        </div>
        <div class="si-glow"></div>
        <div class="si-phone right">
          <div class="si-speaker"><div class="si-spk-dot"></div><div class="si-spk-dot"></div><div class="si-spk-dot"></div></div>
        </div>
      </div>
      <div class="si-label">🔊 alto-falante ↔ alto-falante 🔊</div>
      <div class="si-text">Encoste os <em>alto-falantes</em><br>um no outro</div>
    </div>
  </div>
  <!-- TOP: perfil+nick+nome real à esquerda, chat+rede à direita -->
  <div class="home-top">
    <div class="home-user" onclick="showMyProfileSheet()">
      <div class="verified-wrap">
        <div class="home-avatar" id="homeAvatar"></div>
        <div class="verified-badge hidden" id="homeVerifiedBadge"><svg viewBox="0 0 24 24"><path fill="url(#verifiedGrad)" d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5 12 21.04l3.4 1.46 1.89-3.19 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.8 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.34z"/></svg></div>
      </div>
      <div class="home-user-info">
        <div class="hg" id="homeGreeting">Olá</div>
        <div class="home-realname" id="homeRealName"></div>
        <div class="home-verified-row">
          <div class="cd" id="connDot"></div>
          <div class="home-stars-mini hidden" id="homeStarsMini"></div>
        </div>
      </div>
    </div>
    <div class="home-icons">
      <div class="constellation-btn hidden" id="constBtn" onclick="showHistory()">&#x2726;</div>
      <div class="rb hidden" id="relBadge" onclick="showRelations()">&#x1F4AC;<span class="ct" id="relCount">0</span></div>
    </div>
  </div>
  <!-- CENTER: botão TOUCH grande -->
  <div class="hc">
    <div class="service-toggle hidden" id="serviceToggle" onclick="toggleServiceMode()"><span id="serviceToggleIcon">💼</span> <span id="serviceToggleLabel">Modo Serviço</span></div>
    <div class="hm" id="homeMotivation">Nada acontece<br>à distância.</div>
    <div style="position:relative;display:flex;align-items:center;justify-content:center">
      <div class="sonic-bars left" id="sonicBarsL"><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div></div>
      <button class="be" id="mainBtn" onclick="handleMainButton()">
        <span class="be-icon"><svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><!-- Phone 1 --><rect x="8" y="10" width="14" height="24" rx="3" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.45)" stroke-width="1.2"/><circle cx="15" cy="30" r="1.2" fill="rgba(255,255,255,.3)"/><!-- Phone 2 --><rect x="26" y="14" width="14" height="24" rx="3" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.45)" stroke-width="1.2"/><circle cx="33" cy="34" r="1.2" fill="rgba(255,255,255,.3)"/><!-- Connection waves --><path d="M22 22 Q24 20 26 22" stroke="rgba(255,107,53,.6)" stroke-width="1.2" fill="none" stroke-linecap="round"/><path d="M21 19 Q24 16 27 19" stroke="rgba(255,107,53,.4)" stroke-width="1" fill="none" stroke-linecap="round"/><path d="M20 16 Q24 12 28 16" stroke="rgba(255,107,53,.25)" stroke-width=".8" fill="none" stroke-linecap="round"/></svg></span>
        <span class="be-text" id="mainBtnText">TOUCH</span>
      </button>
      <div class="sonic-bars right" id="sonicBarsR"><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div></div>
    </div>
    <div class="sonic-status" id="sonicHomeStatus"></div>
    <div class="sonic-fallback" id="sonicFallback">
      <button class="bs" onclick="startEncounter()" style="font-size:.75rem">&#x1F511; Conectar por código</button>
    </div>
    <div class="daily-counter hidden" id="dailyCounter"><strong id="dailyNum">0</strong> pessoas em 24h</div>
  </div>
  <!-- BOTTOM: minimal — only location + tutorial -->
  <div class="home-bottom">
    <div class="home-nav">
      <button class="hn-btn" onclick="openLocationScreen()"><span class="hn-ico">📍</span><span class="hn-lbl" data-i18n="loc_btn">Local</span></button>
      <button class="hn-btn" onclick="showTutorial()"><span class="hn-ico">❓</span><span class="hn-lbl">Tutorial</span></button>
    </div>
    <div class="home-brand-row">
      <span class="home-brand" id="homeBrand">Touch?</span>
    </div>
  </div>
</div>

<div id="encounter" class="screen">
  <div class="ep active" id="phaseChoose">
    <div class="et">Como vão se encontrar?</div>
    <button class="bp" style="max-width:280px" onclick="createSession()">GERAR CÓDIGO</button>
    <div class="od">ou</div>
    <div class="cir"><input type="text" id="joinCodeInput" placeholder="ENC-000" maxlength="7" autocomplete="off"><button onclick="joinSession()">&#x2192;</button></div>
    <div class="od">ou</div>
    <button class="bp" style="max-width:280px;background:linear-gradient(135deg,#ff6b35,#e05520)" onclick="startSonicMode()">📲 TOUCH — encostar celulares</button>
    <button class="bs" style="margin-top:1.5rem" onclick="goHome()">&#x2190; Voltar</button>
  </div>
  <div class="ep" id="phaseBump">
    <div class="et">Encoste seu celular no da outra pessoa</div>
    <div class="bump-circle" id="bumpCircle">
      <span style="font-size:2rem">📳</span>
      <span style="font-size:.7rem;font-weight:600;letter-spacing:.1em;color:rgba(255,255,255,.85)" id="bumpLabel">PREPARANDO...</span>
    </div>
    <div style="font-size:.75rem;color:var(--t3);max-width:240px;text-align:center;line-height:1.6" id="bumpStatus">Ativando sensores...</div>
    <button class="bs" onclick="stopSonicMode();showPhase('phaseChoose')">&#x2190; Cancelar</button>
  </div>
  <div class="ep" id="phaseCode">
    <div class="et">Peça para a outra pessoa digitar:</div>
    <div class="cdsp" id="sessionCode">ENC-000</div>
    <div class="qb"><canvas id="qrCanvas"></canvas></div>
    <div style="font-size:.75rem;color:var(--t3)">Esperando alguém conectar...</div>
    <div class="wd"><span>&#x25CF;</span><span>&#x25CF;</span><span>&#x25CF;</span></div>
    <button class="bs" onclick="goHome()">Cancelar</button>
  </div>
</div>

<div id="reveal" class="screen">
  <canvas id="rvLightBeam" class="rv-light-beam"></canvas>
  <div class="rv-wrap">
    <div class="rv-center">
      <div class="rv-moment" id="revealMoment">algo nasceu entre vocês</div>
      <div class="rv-phrase" id="revealPhrase"></div>
      <div class="rv-sub">essa é a marca desse encontro</div>
      <div class="rv-avatars" id="revealAvatars">
        <div class="rv-avatar-wrap" id="rvAvatarMe">
          <div id="rvAvatarMeInner"></div>
          <div class="rv-avatar-name" id="rvNameMe"></div>
        </div>
        <div class="rv-connection-symbol">
          <div class="rv-connection-dot"></div>
        </div>
        <div class="rv-avatar-wrap" id="rvAvatarThem">
          <div id="rvAvatarThemInner"></div>
          <div class="rv-avatar-name" id="rvNameThem"></div>
        </div>
      </div>
      <div class="rv-renewed hidden" id="revealRenewed">vocês se encontraram de novo</div>
      <div class="rv-last hidden" id="revealLast"></div>
      <div id="zodiacArea" class="zodiac-area hidden"></div>
    </div>
    <video id="selfieVideo" autoplay playsinline style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:1.5px solid rgba(255,255,255,.15);display:none;margin:0 auto"></video>
    <canvas id="selfieCanvas" style="display:none"></canvas>
    <div id="selfiePreview" style="display:none;margin:0 auto"></div>
    <div class="rv-actions" id="revealActions">
      <div class="rv-btn-row">
        <button type="button" class="rv-btn-enter" id="revealEnterBtn" onclick="enterChat()">Abrir conexão</button>
        <button type="button" class="rv-btn-skip" id="revealSkipBtn" onclick="goHome()">Pular</button>
      </div>
      <div class="rv-sec-row">
        <button type="button" class="rv-btn-mini" id="selfieCapBtn" onclick="revealCaptureSelfie()"><span class="rv-ico">📸</span>Selfie</button>
        <button type="button" class="rv-btn-mini hidden" id="revealTipBtn" onclick="openTipFromReveal()"><span class="rv-ico">💲</span><span id="revealTipLabel">Gorjeta</span></button>
      </div>
    </div>
  </div>
</div>

<div id="chat" class="screen">
  <!-- Clean header: back + name + timer pill -->
  <div class="ch">
    <div class="chl">
      <button class="chb" onclick="goHome()">&#x2190;</button>
      <div class="ch-info" onclick="showPartnerProfile()">
        <span class="chn" id="chatPartner">Pessoa</span>
        <span class="ch-sub" id="chatSub"></span>
      </div>
    </div>
    <div class="cht" id="chatTimer">23:59:59</div>
  </div>
  <!-- Phrase banner -->
  <div class="cpb" id="chatPhrase"></div>
  <!-- Streak (collapsible) -->
  <div class="streak-info hidden" id="chatStreak"><span id="chatStreakText"></span><div class="streak-progress"><div class="streak-bar" id="chatStreakBar"></div></div><span id="chatStreakNext" style="font-size:.6rem;color:var(--t3)"></span></div>
  <div id="contactRequestArea"></div>
  <!-- Messages -->
  <div class="cms" id="chatMessages"><div class="ti" id="typingIndicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
  <!-- Quick phrases -->
  <div class="qp-bar" id="quickPhrases"></div>
  <!-- Bottom: input + expandable menu -->
  <div class="chat-bottom" style="position:relative">
    <!-- ID action buttons (only visible when relevant) -->
    <div class="chat-id-bar" id="chatIdBar">
      <button class="id-pill reveal" onclick="revealMyself(state.currentPartnerId)" type="button" id="revealIdBtn">🪪 Revelar ID</button>
    </div>
    <!-- Plus menu (all actions here) -->
    <div class="plus-menu" id="plusMenu">
      <button class="pm-item" onclick="pickPhoto();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(88,166,255,.15);color:#58a6ff">📷</div><span class="pm-label">Foto</span></button>
      <button class="pm-item" onclick="requestSelfie();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(255,200,87,.12);color:#ffc857">🤳</div><span class="pm-label">Selfie</span></button>
      <button class="pm-item" onclick="openContactMenu();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(163,113,247,.12);color:#a371f7">📲</div><span class="pm-label">Contato</span></button>
      <button class="pm-item" onclick="openGiftPicker();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(255,107,53,.12);color:var(--ac)">🎁</div><span class="pm-label">Presente</span></button>
      <button class="pm-item" onclick="openDeclModal();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(52,211,153,.12);color:var(--ok)">📝</div><span class="pm-label">Declarar</span></button>
      <button class="pm-item" onclick="sendPulse();closePlusMenu()" type="button" id="pulseBtn"><div class="pm-ico" style="background:rgba(255,61,113,.12);color:var(--pk)">💗</div><span class="pm-label">Pulsar</span></button>
      <button class="pm-item" onclick="getHoroscope();closePlusMenu()" type="button" id="horoscopeBtn"><div class="pm-ico" style="background:rgba(251,191,36,.12);color:#fbbf24">✨</div><span class="pm-label">Horóscopo</span></button>
      <button class="pm-item" onclick="pickFile();closePlusMenu()" type="button"><div class="pm-ico" style="background:rgba(255,255,255,.06);color:var(--t2)">📎</div><span class="pm-label">Arquivo</span></button>
    </div>
    <!-- Input row -->
    <div class="cia">
      <div class="cia-wrap">
        <button class="cia-plus" onclick="togglePlusMenu()" type="button">+</button>
        <input type="text" id="chatInput" placeholder="Mensagem..." maxlength="500" autocomplete="off">
      </div>
      <button class="sb" id="sendBtn" onclick="sendMessage()" type="button">&#x2191;</button>
    </div>
  </div>
  <!-- Hidden partner pts for JS reference -->
  <span class="hidden" id="partnerPts"><strong id="partnerPtsNum">0</strong></span>
</div>

<div id="relations" class="screen">
  <div class="rlh"><button class="chb" onclick="goHome()">&#x2190;</button><h2>Conexões ativas</h2><span class="rlh-sub" id="relSubtitle"></span></div>
  <div class="rll" id="relationsList"></div>
  <button class="float-history-btn" onclick="showEncounterLog()" title="Histórico de encontros">📋</button>
</div>

<div id="history" class="screen">
  <div class="const-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2>Minha Constelação</h2></div>
  <div style="display:flex;gap:.35rem;padding:0 .8rem .3rem;justify-content:center;flex-wrap:wrap">
    <button class="const-filter-btn" id="constFilterAll" onclick="setConstFilter('all')" style="padding:.25rem .65rem;border-radius:20px;border:1px solid rgba(255,255,255,.12);background:rgba(99,102,241,.15);color:#a78bfa;font-size:.6rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s">Todos</button>
    <button class="const-filter-btn" id="constFilterRevealed" onclick="setConstFilter('revealed')" style="padding:.25rem .65rem;border-radius:20px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--t3);font-size:.6rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s">🟢 Revelados</button>
    <button class="const-filter-btn" id="constFilterAnon" onclick="setConstFilter('anon')" style="padding:.25rem .65rem;border-radius:20px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--t3);font-size:.6rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s">🔴 Anônimos</button>
    <button class="const-filter-btn" id="constFilterEvents" onclick="setConstFilter('events')" style="padding:.25rem .65rem;border-radius:20px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--t3);font-size:.6rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s">📍 Eventos</button>
  </div>
  <div class="const-copy"><p>Aqui ficam os encontros.<br>O resto passou.</p></div>
  <div class="const-feedback" id="constFeedback"></div>
  <div class="notif-btn" id="constNotifBtn" onclick="toggleNotifPanel()">🔔<span class="notif-badge hidden" id="constNotifBadge">0</span></div>
  <div class="const-canvas-wrap"><canvas id="constCanvas"></canvas></div>
  <div class="const-empty hidden" id="constEmpty">
    <div class="const-empty-icon">✦</div>
    <div class="const-empty-text">Nenhum encontro ainda.<br>Dê um touch em alguém para começar sua constelação.</div>
  </div>
  <!-- Notification panel -->
  <div class="notif-panel" id="notifPanel">
    <div class="notif-header"><button class="notif-close" onclick="toggleNotifPanel()">←</button><div class="notif-title">Atividade</div></div>
    <div id="notifList"><div class="notif-empty">Carregando...</div></div>
  </div>
  <!-- Redesigned detail card -->
  <div class="const-detail" id="constDetail">
    <div class="cd-handle"></div>
    <div class="cd-header">
      <div class="verified-wrap">
        <div class="cd-avatar" id="cdAvatar"></div>
        <div class="verified-badge hidden" id="cdVerifiedBadge"><svg viewBox="0 0 24 24"><path fill="url(#verifiedGrad)" d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5 12 21.04l3.4 1.46 1.89-3.19 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.8 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.34z"/></svg></div>
      </div>
      <div class="cd-header-info">
        <div class="cd-name" id="cdName"></div>
        <div class="cd-alias" id="cdAlias"></div>
      </div>
      <div class="cd-anon-preview hidden" id="cdAnonPreview">
        <div style="display:flex;flex-direction:column;align-items:center;gap:2px">
          <div class="cd-anon-ball" id="cdAnonBall"></div>
          <div class="cd-anon-nick" id="cdAnonNick"></div>
          <div class="cd-anon-label">anônimo</div>
        </div>
      </div>
      <button class="cd-close" onclick="hideConstDetail()">✕</button>
    </div>
    <div class="cd-stats" id="cdStats"></div>
    <div class="cd-divider"></div>
    <div class="cd-section" id="cdMeta"></div>
    <div class="cd-actions" id="cdActions" onclick="event.stopPropagation()"></div>
    <div class="cd-section hidden" id="cdTipWrap"><button class="cd-tip-btn" id="cdTipBtn" onclick="event.stopPropagation();constTipAction()">Dar gorjeta</button></div>
    <div class="cd-divider"></div>
    <div class="cd-section" id="cdDeclarations" style="max-height:160px;overflow-y:auto"></div>
    <div class="cd-section hidden" id="cdDeclareWrap" onclick="event.stopPropagation()">
      <div style="display:flex;gap:.4rem;align-items:center">
        <input type="text" id="cdDeclareInput" placeholder="Deixe uma declaração..." maxlength="120" style="flex:1;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:.45rem .6rem;font-size:.68rem;color:var(--t1);font-family:inherit;outline:none">
        <button onclick="sendDeclaration()" style="padding:.4rem .7rem;border-radius:10px;background:linear-gradient(135deg,rgba(99,102,241,.2),rgba(139,92,246,.15));border:1px solid rgba(99,102,241,.2);color:#a5b4fc;font-size:.65rem;font-weight:600;font-family:inherit;cursor:pointer;white-space:nowrap">Enviar</button>
      </div>
    </div>
  </div>
  <!-- Selfie zoom overlay -->
  <div class="cd-selfie-zoom" id="selfieZoom" onclick="closeSelfieZoom()">
    <img id="selfieZoomImg" src="" alt="">
    <button class="cd-zoom-delete" id="selfieZoomDelete" onclick="event.stopPropagation();deleteSelfieFromZoom()">Apagar foto</button>
  </div>
</div>

<div id="expireCard" class="screen">
  <div class="ev"><div class="cl">Touch?</div><div class="cf" id="cardPhrase"></div><div class="ctm" id="cardTime"></div><div class="cft">tudo nasce no gesto</div></div>
  <div class="ea"><button class="bs" onclick="goHome()">Voltar</button><button class="bp" style="max-width:160px" onclick="shareCard()">Compartilhar</button></div>
</div>

<div id="boardingPass" class="screen">
  <div class="bp-card" id="bpCard">
    <div class="bp-top"><div class="bp-logo">Touch?</div><div class="bp-type" style="font-size:.55rem;letter-spacing:.15em;color:var(--t3)">ID</div></div>
    <div class="bp-body" style="padding:1rem 1.5rem;text-align:center">
      <!-- QR Code center -->
      <div id="touchQRArea" style="margin:0 auto .8rem;display:flex;align-items:center;justify-content:center;min-height:160px;background:rgba(255,255,255,.03);border-radius:16px;border:1px solid rgba(255,255,255,.04);padding:.8rem"></div>
      <div class="touch-link-url" id="touchLinkUrl" style="font-size:.55rem;color:var(--t3);margin-bottom:.6rem;word-break:break-all">Gerando...</div>
      <button class="bs" onclick="copyTouchLink()" type="button" style="font-size:.65rem;margin-bottom:.8rem;padding:.35rem .8rem">Copiar link</button>
      <!-- Compact identity -->
      <div style="display:flex;align-items:center;gap:.7rem;justify-content:center;margin-bottom:.6rem">
        <div class="verified-wrap">
          <div class="bp-avatar" id="bpAvatar" style="width:40px;height:40px;border-radius:50%;font-size:.9rem;font-weight:800;display:flex;align-items:center;justify-content:center;border:1.5px solid rgba(255,255,255,.1)"></div>
          <div class="verified-badge hidden" id="bpVerifiedBadge"><svg viewBox="0 0 24 24"><path fill="url(#verifiedGrad)" d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5 12 21.04l3.4 1.46 1.89-3.19 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.8 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.34z"/></svg></div>
        </div>
        <div style="text-align:left">
          <div class="bp-name" id="bpName" style="font-size:.9rem;font-weight:700;margin:0">Nome</div>
          <div class="bp-since" id="bpSince" style="font-size:.55rem;color:var(--t3);margin:0"></div>
        </div>
      </div>
      <!-- Compact stats row -->
      <div style="display:flex;justify-content:center;gap:1.2rem;padding:.5rem 0;border-top:1px solid rgba(255,255,255,.04)">
        <div style="text-align:center"><div style="font-size:.95rem;font-weight:800;color:#fbbf24" id="bpStars">0</div><div style="font-size:.5rem;color:var(--t3);letter-spacing:.06em">estrelas</div></div>
        <div style="text-align:center"><div style="font-size:.95rem;font-weight:800;color:var(--t1)" id="bpPeople">0</div><div style="font-size:.5rem;color:var(--t3);letter-spacing:.06em">pessoas</div></div>
        <div style="text-align:center"><div style="font-size:.95rem;font-weight:800;color:#ff6b8a" id="bpLikes">0</div><div style="font-size:.5rem;color:var(--t3);letter-spacing:.06em">curtidas</div></div>
        <div style="text-align:center"><div style="font-size:.95rem;font-weight:800;color:var(--ac)" id="bpScore">0</div><div style="font-size:.5rem;color:var(--t3);letter-spacing:.06em">score</div></div>
      </div>
      <!-- Ranking tag -->
      <div style="margin-top:.3rem"><span id="bpTag" style="font-size:.6rem;font-weight:700;color:#ffd700;background:rgba(255,215,0,.08);padding:.15rem .5rem;border-radius:8px">—</span></div>
    </div>
    <div class="bp-footer">TUDO NASCE NO GESTO</div>
  </div>
  <div class="bp-actions">
    <button class="bs" onclick="goHome()">Voltar</button>
    <button class="bp-dl" onclick="downloadBoardingPass()">Salvar Imagem</button>
  </div>
</div>

<div id="locationScreen" class="screen">
  <div class="loc-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 data-i18n="loc_title">Explorar ao redor</h2><button class="bs" style="font-size:.7rem;padding:.3rem .8rem" onclick="showCreateEvent()" data-i18n="create_event_btn">+ Evento</button></div>
  <div class="loc-scroll" id="locScroll">
    <div class="loc-status" id="locStatus" data-i18n="loc_activate">Ative sua localização para descobrir pessoas e eventos.</div>
    <div class="loc-tabs">
      <div class="loc-tab active" id="tabNearby" onclick="switchLocTab('nearby')" data-i18n="tab_nearby">Pessoas</div>
      <div class="loc-tab" id="tabEvents" onclick="switchLocTab('events')" data-i18n="tab_events">Eventos</div>
    </div>
    <div id="locContent"></div>
  </div>
</div>

<div id="eventDetail" class="screen">
  <div class="loc-header"><button class="chb" onclick="showScreen('locationScreen')">&#x2190;</button><h2 id="evtDetailTitle">Evento</h2></div>
  <div class="loc-scroll" id="evtDetailScroll"></div>
</div>

<!-- GORJETA SCREEN -->
<div id="tipScreen" class="screen">
  <div class="tip-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 style="font-size:1rem;font-weight:600">Gorjeta</h2></div>
  <div class="tip-receiver" id="tipReceiver"></div>
  <div class="tip-amounts">
    <button class="tip-amount-btn" onclick="selectTipAmount(2)">R$2</button>
    <button class="tip-amount-btn" onclick="selectTipAmount(5)">R$5</button>
    <button class="tip-amount-btn" onclick="selectTipAmount(10)">R$10</button>
    <button class="tip-amount-btn" onclick="selectTipAmount(20)">R$20</button>
  </div>
  <div class="tip-custom">
    <label>Outro valor:</label>
    <input type="number" id="tipCustomAmount" placeholder="R$" min="1" max="500" oninput="selectTipCustom()">
  </div>

  <!-- PAYMENT METHODS — unified picker -->
  <div id="tipPayMethods" style="margin-top:.8rem;display:flex;flex-direction:column;gap:.5rem">

    <!-- 1. SAVED CARD + CVV -->
    <div id="tipSavedCard" style="display:none">
      <div style="background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.15);border-radius:16px;padding:.8rem">
        <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.6rem">
          <div style="width:40px;height:28px;border-radius:5px;background:linear-gradient(135deg,#1a1a2e,#2d2d44);display:flex;align-items:center;justify-content:center;font-size:.6rem;color:rgba(255,255,255,.5);flex-shrink:0" id="tipSavedBrandIcon">CARD</div>
          <div style="flex:1">
            <div id="tipSavedCardLabel" style="font-size:.75rem;font-weight:700;color:var(--t1)"></div>
            <div style="font-size:.5rem;color:var(--t3)">Cartão salvo</div>
          </div>
          <div style="width:7px;height:7px;border-radius:50%;background:#10b981;flex-shrink:0"></div>
        </div>
        <div style="display:flex;gap:.4rem;align-items:center">
          <input type="text" id="tipSavedCVV" class="tip-input" placeholder="CVV" inputmode="numeric" maxlength="4" autocomplete="cc-csc" style="width:80px;text-align:center;flex-shrink:0" oninput="validateSavedCVV()">
          <button class="tip-pay-btn" id="tipQuickPayBtn" onclick="quickPay()" disabled style="flex:1;background:linear-gradient(135deg,#6366f1,#4f46e5);font-size:.8rem;padding:.65rem;border-radius:12px;border:none;color:#fff;font-weight:700;font-family:inherit;cursor:pointer">Pagar</button>
        </div>
        <div style="display:flex;justify-content:center;gap:1rem;margin-top:.4rem">
          <button onclick="showNewCardForm()" style="padding:.15rem;border:none;background:transparent;color:var(--t3);font-size:.52rem;font-family:inherit;cursor:pointer">Usar outro cartão</button>
          <button onclick="removeSavedCard()" style="padding:.15rem;border:none;background:transparent;color:var(--err);font-size:.52rem;font-family:inherit;cursor:pointer;opacity:.6">Remover</button>
        </div>
      </div>
    </div>

    <!-- 2. MERCADO PAGO — redirect -->
    <button id="tipMPBtn" onclick="payWithMercadoPago()" style="display:flex;align-items:center;gap:.6rem;width:100%;padding:.7rem .8rem;border-radius:14px;border:1px solid rgba(0,158,227,.2);background:rgba(0,158,227,.06);cursor:pointer;font-family:inherit;transition:all .2s">
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none"><circle cx="14" cy="14" r="13" fill="#009ee3" stroke="#009ee3" stroke-width=".5"/><path d="M7 17.5c0-3.5 2.5-7.5 7-7.5s7 4 7 7.5" stroke="#fff" stroke-width="2" stroke-linecap="round" fill="none"/><path d="M9 17c0-2.5 2-5.5 5-5.5s5 3 5 5.5" stroke="#fff" stroke-width="1.5" stroke-linecap="round" fill="none"/><circle cx="14" cy="17" r="1.5" fill="#fff"/></svg>
      <div style="flex:1;text-align:left">
        <div style="font-size:.75rem;font-weight:700;color:#009ee3">Mercado Pago</div>
        <div style="font-size:.5rem;color:var(--t3)">Cartão, saldo ou parcelado</div>
      </div>
      <span style="font-size:.6rem;color:var(--t3)">→</span>
    </button>

    <!-- 3. PIX -->
    <button id="tipPixToggle" onclick="togglePixSection()" style="display:flex;align-items:center;gap:.6rem;width:100%;padding:.7rem .8rem;border-radius:14px;border:1px solid rgba(0,220,130,.15);background:rgba(0,220,130,.04);cursor:pointer;font-family:inherit;transition:all .2s">
      <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#00dc82,#00b36b);display:flex;align-items:center;justify-content:center;font-size:.75rem;color:#fff;font-weight:800;flex-shrink:0">P</div>
      <div style="flex:1;text-align:left">
        <div style="font-size:.75rem;font-weight:700;color:#00dc82">PIX</div>
        <div style="font-size:.5rem;color:var(--t3)">Instantâneo, sem taxa</div>
      </div>
      <span style="font-size:.6rem;color:var(--t3)">→</span>
    </button>

    <!-- 4. NEW CARD (hidden, shows on "Usar outro cartão") -->
    <button id="tipNewCardToggle" onclick="showNewCardForm()" style="display:flex;align-items:center;gap:.6rem;width:100%;padding:.6rem .8rem;border-radius:14px;border:1px dashed rgba(99,102,241,.2);background:transparent;cursor:pointer;font-family:inherit">
      <div style="width:28px;height:28px;border-radius:50%;background:rgba(99,102,241,.1);display:flex;align-items:center;justify-content:center;font-size:.7rem;color:#6366f1;font-weight:700;flex-shrink:0">+</div>
      <div style="font-size:.7rem;font-weight:600;color:var(--t2)">Adicionar cartão</div>
    </button>
  </div>

  <!-- NEW CARD FORM — expandable -->
  <div id="tipNewCard" style="display:none;margin-top:.6rem">
    <div style="background:rgba(99,102,241,.05);border:1px solid rgba(99,102,241,.12);border-radius:16px;padding:.8rem">
      <div style="font-size:.65rem;font-weight:600;color:var(--t2);margin-bottom:.4rem;text-align:center">Dados do cartão</div>
      <div style="position:relative"><input type="text" id="tipCardNumber" class="tip-input" placeholder="Número do cartão" inputmode="numeric" maxlength="19" autocomplete="cc-number" oninput="formatCardNumber(this)" style="padding-right:50px"><div id="tipCardBrandIcon" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:36px;height:24px;border-radius:4px;background:linear-gradient(135deg,#1a1a2e,#2d2d44);display:flex;align-items:center;justify-content:center;font-size:.55rem;color:rgba(255,255,255,.5);font-weight:700;transition:all .2s">CARD</div></div>
      <div style="display:flex;gap:.4rem;margin-top:.4rem">
        <input type="text" id="tipCardExpiry" class="tip-input" placeholder="MM/AA" inputmode="numeric" maxlength="5" autocomplete="cc-exp" oninput="formatExpiry(this)" style="flex:1">
        <input type="text" id="tipCardCVV" class="tip-input" placeholder="CVV" inputmode="numeric" maxlength="4" autocomplete="cc-csc" style="flex:1">
      </div>
      <input type="text" id="tipCardHolder" class="tip-input" placeholder="Nome no cartão" autocomplete="cc-name" style="margin-top:.4rem">
      <input type="text" id="tipCardCPF" class="tip-input" placeholder="CPF do titular" inputmode="numeric" maxlength="14" oninput="formatCPF(this)" style="margin-top:.4rem">
      <div style="display:flex;align-items:center;gap:.4rem;margin-top:.4rem">
        <input type="checkbox" id="tipSaveCardCheck" checked style="accent-color:#6366f1">
        <label for="tipSaveCardCheck" style="font-size:.55rem;color:var(--t3)">Salvar cartão</label>
      </div>
      <button class="tip-pay-btn" id="tipCardPayBtn" onclick="payWithNewCard()" disabled style="margin-top:.5rem;background:linear-gradient(135deg,#6366f1,#4f46e5)">Pagar com cartão</button>
    </div>
  </div>

  <!-- PIX SECTION — expandable -->
  <div id="tipPixSection" style="display:none;margin-top:.6rem">
    <div style="background:rgba(0,220,130,.04);border:1px solid rgba(0,220,130,.12);border-radius:16px;padding:.8rem">
      <div style="font-size:.6rem;color:var(--t3);text-align:center;margin-bottom:.5rem;line-height:1.4">PIX — qualquer banco, instantâneo</div>
      <input type="email" id="tipPixEmail" class="tip-input" placeholder="Seu e-mail" autocomplete="email" style="margin-bottom:.4rem">
      <input type="text" id="tipPixCPF" class="tip-input" placeholder="Seu CPF" inputmode="numeric" maxlength="14" autocomplete="off" oninput="formatCPF(this)">
      <button class="tip-pay-btn" id="tipPixBtn" onclick="processPixTip()" disabled style="margin-top:.5rem;background:linear-gradient(135deg,#00dc82,#00b36b)">Gerar PIX</button>
      <div id="tipPixQR" class="hidden" style="text-align:center;padding:.8rem 0">
        <div style="font-size:.7rem;font-weight:600;color:var(--ok);margin-bottom:.4rem">PIX gerado! Escaneie ou copie:</div>
        <img id="tipPixQRImg" style="width:180px;height:180px;border-radius:10px;background:#fff;padding:6px" alt="QR Code PIX">
        <div style="margin-top:.5rem">
          <button onclick="copyPixCode()" style="padding:.35rem .8rem;border-radius:10px;background:rgba(0,220,130,.12);border:1px solid rgba(0,220,130,.25);color:#00dc82;font-size:.65rem;font-weight:600;font-family:inherit;cursor:pointer">Copiar código PIX</button>
        </div>
        <input type="hidden" id="tipPixCode">
        <div style="font-size:.5rem;color:var(--t3);margin-top:.4rem">Expira em 30 minutos.</div>
      </div>
    </div>
  </div>

  <div class="tip-result hidden" id="tipResult">
    <div class="tip-result-icon" id="tipResultIcon"></div>
    <div class="tip-result-text" id="tipResultText"></div>
    <button class="bs" onclick="goHome()" style="margin-top:.8rem">Voltar</button>
  </div>
</div>

<!-- PRESTADOR DASHBOARD -->
<div id="prestadorDash" class="screen">
  <div class="tip-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 style="font-size:1rem;font-weight:600">Meu Painel</h2></div>
  <div id="pdContent" style="padding:.5rem .8rem;overflow-y:auto;max-height:calc(100vh - 60px)">
    <!-- Stats cards -->
    <div id="pdStats" style="display:grid;grid-template-columns:1fr 1fr;gap:.4rem;margin-bottom:.8rem"></div>
    <!-- Period cards -->
    <div id="pdPeriods" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.4rem;margin-bottom:.8rem"></div>
    <!-- MP connection status -->
    <div id="pdMpStatus" style="margin-bottom:.8rem"></div>
    <!-- Recent tips -->
    <div style="font-size:.75rem;font-weight:700;color:var(--t1);margin-bottom:.4rem">Gorjetas recebidas</div>
    <div id="pdTips" style="margin-bottom:1rem"></div>
    <!-- Recent encounters -->
    <div style="font-size:.75rem;font-weight:700;color:var(--t1);margin-bottom:.4rem">Encostadas recebidas</div>
    <div id="pdEncounters"></div>
  </div>
</div>

<!-- PRESTADOR REGISTER SCREEN -->
<div id="prestadorReg" class="screen">
  <div class="tip-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 style="font-size:1rem;font-weight:600">Cadastro de Prestador</h2></div>
  <div class="preg-title">Receba gorjetas pelo Touch?</div>
  <div class="preg-sub">Cadastre-se como prestador de serviço para receber pagamentos de gorjeta diretamente no seu celular.</div>
  <div class="fg"><label>Nome completo</label><input type="text" id="pregName" placeholder="Seu nome"></div>
  <div class="fg"><label>Nickname</label><input type="text" id="pregNick" placeholder="Como vão te encontrar" maxlength="20" oninput="checkPregNick(this.value)"><div class="nick-hint" id="pregNickHint"></div></div>
  <div class="fg"><label>CPF (opcional)</label><input type="text" id="pregCPF" placeholder="000.000.000-00" maxlength="14"></div>
  <div class="fg"><label>Data de nascimento</label><input type="date" id="pregBirth"></div>
  <div class="fg"><label>Tipo de serviço</label></div>
  <div class="preg-services" id="pregServices"></div>
  <div class="preg-mp-status pending" id="pregMpStatus" style="display:none">
    <span id="pregMpText">Conecte sua conta MercadoPago para receber pagamentos</span>
  </div>
  <button class="bp" id="pregSubmitBtn" onclick="registerPrestador()" style="margin-bottom:.8rem">Criar conta de prestador</button>
  <button class="bs" id="pregMpBtn" onclick="connectMercadoPago()" style="display:none;margin-bottom:.8rem;width:100%">🔗 Conectar MercadoPago</button>
  <button class="bs" onclick="goHome()" style="width:100%;margin-bottom:2rem;opacity:.6">← Voltar</button>
</div>

<div id="encounterLog" class="screen">
  <div class="elog-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2>Histórico de encontros</h2></div>
  <div class="elog-list" id="elogList"></div>
</div>

<div id="completeProfile" class="screen">
  <div class="cp-header">
    <button class="chb" onclick="goHome()" style="position:absolute;left:1rem;top:1.2rem">&#x2190;</button>
    <h2>Perfil completo</h2>
    <p>Opcional — preencha para poder revelar sua identidade</p>
  </div>
  <div class="cp-photo-wrap">
    <div class="cp-photo" id="cpPhotoPreview" onclick="$('cpPhotoInput').click()">
      <span id="cpPhotoPlaceholder" style="font-size:2rem;color:var(--t3)">📷</span>
    </div>
    <div class="cp-photo-label" onclick="$('cpPhotoInput').click()">Adicionar foto real</div>
    <input type="file" id="cpPhotoInput" accept="image/*" style="display:none" onchange="handleProfilePhoto(this)">
  </div>
  <div class="cp-field"><label>Apelido (máscara)</label><input type="text" id="cpNickname" placeholder="seu_apelido" maxlength="20" autocomplete="off"><div class="cp-note">Sua identidade secreta — como todos te veem</div></div>
  <div class="cp-field"><label>Nome real</label><input type="text" id="cpRealName" placeholder="Seu nome completo" maxlength="60"></div>
  <div class="cp-field"><label>Bio</label><textarea id="cpBio" placeholder="Conte algo sobre você..." maxlength="200"></textarea></div>
  <div class="cp-field"><label>Telefone</label><input type="tel" id="cpPhone" placeholder="+55 11 99999-9999" maxlength="20"><div class="cp-note">Opcional — não será mostrado publicamente</div></div>
  <div class="cp-field"><label>Email</label><input type="email" id="cpEmail" placeholder="seu@email.com" maxlength="60"><div class="cp-note">Necessário para pagamentos e assinatura</div></div>
  <div class="cp-field"><label>CPF</label><input type="text" id="cpCpf" placeholder="000.000.000-00" maxlength="14" inputmode="numeric" oninput="formatCPF(this)"><div class="cp-note">Necessário para pagamentos — não será exibido</div></div>
  <div class="cp-field"><label>Instagram</label><input type="text" id="cpInstagram" placeholder="@seuuser" maxlength="30"></div>
  <div class="cp-field"><label>X (Twitter)</label><input type="text" id="cpTwitter" placeholder="@seuuser" maxlength="30"></div>
  <div class="cp-actions">
    <button class="bs" onclick="goHome()">Voltar</button>
    <button class="bp" onclick="saveCompleteProfile()">Salvar</button>
  </div>
</div>

<div id="faceEnrollScreen" class="screen">
  <div style="display:flex;align-items:center;padding:.8rem 1rem;background:rgba(18,18,26,.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06)">
    <button class="chb" onclick="goHome()">&#x2190;</button>
    <div style="flex:1;text-align:center;font-size:.9rem;font-weight:700;color:var(--t1)">🔐 Face ID</div>
    <div style="width:32px"></div>
  </div>
  <div style="padding:1.2rem;overflow-y:auto;flex:1;display:flex;flex-direction:column;align-items:center;gap:1rem">
    <div id="faceStatus" style="text-align:center;padding:.8rem;width:100%">
      <div style="font-size:.8rem;color:var(--t2);margin-bottom:.3rem">Reconhecimento facial para validação de identidade</div>
      <div style="font-size:.6rem;color:var(--t3)">Portarias, eventos, check-ins seguros</div>
    </div>
    <div id="faceVideoWrap" style="position:relative;width:240px;height:240px;border-radius:50%;overflow:hidden;border:3px solid rgba(255,255,255,.08);background:#111;display:flex;align-items:center;justify-content:center">
      <video id="faceVideo" autoplay muted playsinline style="width:100%;height:100%;object-fit:cover;transform:scaleX(-1)"></video>
      <div id="faceOverlay" style="position:absolute;inset:0;border-radius:50%;border:3px solid transparent;pointer-events:none;transition:border-color .3s"></div>
      <div id="faceGuide" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.7rem;color:var(--t3)">Posicione seu rosto</div>
    </div>
    <div id="faceProgress" style="width:200px;height:4px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden">
      <div id="faceProgressBar" style="width:0%;height:100%;background:linear-gradient(90deg,#06b6d4,#3b82f6,#8b5cf6);border-radius:4px;transition:width .3s"></div>
    </div>
    <div id="faceInstructions" style="font-size:.7rem;color:var(--t2);text-align:center;min-height:2rem">Toque em "Iniciar" para cadastrar</div>
    <div id="faceCaptureCount" style="font-size:.6rem;color:var(--t3)"></div>
    <div style="display:flex;gap:.6rem;margin-top:.5rem">
      <button class="bs" id="faceStartBtn" onclick="startFaceEnroll()" style="padding:.6rem 1.4rem;font-size:.75rem">Iniciar captura</button>
      <button class="bp hidden" id="faceSaveBtn" onclick="saveFaceData()" style="padding:.6rem 1.4rem;font-size:.75rem">Salvar Face ID</button>
    </div>
    <div id="faceEnrolledInfo" class="hidden" style="text-align:center;padding:.8rem;background:rgba(0,220,130,.06);border:1px solid rgba(0,220,130,.15);border-radius:12px;width:100%;margin-top:.5rem">
      <div style="font-size:.8rem;font-weight:600;color:var(--ok)">✓ Face ID cadastrado</div>
      <div style="font-size:.6rem;color:var(--t3);margin-top:.2rem">Seu rosto pode ser usado para verificação</div>
      <button class="my-pf-btn my-pf-danger" onclick="removeFaceData()" style="margin-top:.6rem;justify-content:center;font-size:.7rem;padding:.45rem">Remover Face ID</button>
    </div>
    <div style="font-size:.5rem;color:rgba(255,255,255,.2);text-align:center;margin-top:auto;padding:.6rem">
      Seus dados faciais são armazenados como vetores matemáticos (descritores).<br>
      A foto original NÃO é salva. Apenas o mapa numérico do rosto.<br>
      Conforme LGPD Art. 11 — dados biométricos sensíveis.
    </div>
  </div>
</div>

<div id="docIdScreen" class="screen">
  <div style="display:flex;align-items:center;padding:.8rem 1rem;background:rgba(18,18,26,.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06)">
    <button class="chb" onclick="goHome()">&#x2190;</button>
    <div style="flex:1;text-align:center;font-size:.9rem;font-weight:700;color:var(--t1)">📄 Doc ID</div>
    <div style="width:32px"></div>
  </div>
  <div style="padding:1.2rem;overflow-y:auto;flex:1;display:flex;flex-direction:column;align-items:center;gap:1rem">
    <div style="text-align:center;padding:.5rem">
      <div style="font-size:.8rem;color:var(--t2);margin-bottom:.3rem">Verificação por documento</div>
      <div style="font-size:.6rem;color:var(--t3)">RG, CNH ou passaporte — frente do documento</div>
    </div>
    <div id="docPreviewWrap" style="width:280px;height:180px;border-radius:16px;overflow:hidden;border:2px dashed rgba(255,255,255,.12);background:rgba(255,255,255,.02);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative" onclick="$('docFileInput').click()">
      <div id="docPlaceholder" style="text-align:center">
        <div style="font-size:2.5rem;margin-bottom:.4rem;opacity:.3">📄</div>
        <div style="font-size:.65rem;color:var(--t3)">Toque para fotografar o documento</div>
      </div>
      <img id="docPreviewImg" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0;display:none">
    </div>
    <input type="file" id="docFileInput" accept="image/*" capture="environment" style="display:none" onchange="handleDocPhoto(this)">
    <div id="docSelfieWrap" class="hidden" style="width:100%;text-align:center">
      <div style="font-size:.7rem;color:var(--t2);margin-bottom:.5rem;font-weight:600">Agora uma selfie segurando o documento</div>
      <div style="width:200px;height:200px;border-radius:50%;overflow:hidden;border:3px solid rgba(255,255,255,.08);background:#111;margin:0 auto;cursor:pointer;position:relative" onclick="$('docSelfieInput').click()">
        <div id="docSelfiePlaceholder" style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:2rem;opacity:.3">🤳</div>
        <img id="docSelfieImg" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0;display:none">
      </div>
      <input type="file" id="docSelfieInput" accept="image/*" capture="user" style="display:none" onchange="handleDocSelfie(this)">
    </div>
    <div id="docNameField" class="hidden" style="width:100%">
      <div style="font-size:.65rem;color:var(--t3);margin-bottom:.3rem">Nome no documento</div>
      <input type="text" id="docNameInput" placeholder="Nome como está no documento" maxlength="80" style="width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:.5rem .7rem;font-size:.75rem;color:var(--t1);font-family:inherit;outline:none;box-sizing:border-box">
      <div style="font-size:.65rem;color:var(--t3);margin-top:.4rem;margin-bottom:.3rem">CPF (opcional)</div>
      <input type="text" id="docCpfInput" placeholder="000.000.000-00" maxlength="14" style="width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:.5rem .7rem;font-size:.75rem;color:var(--t1);font-family:inherit;outline:none;box-sizing:border-box">
    </div>
    <button class="bp hidden" id="docSaveBtn" onclick="saveDocId()" style="padding:.65rem 2rem;font-size:.8rem;margin-top:.5rem">Enviar para verificação</button>
    <div id="docEnrolledInfo" class="hidden" style="text-align:center;padding:.8rem;background:rgba(0,220,130,.06);border:1px solid rgba(0,220,130,.15);border-radius:12px;width:100%">
      <div style="font-size:.8rem;font-weight:600;color:var(--ok)">✓ Documento enviado</div>
      <div style="font-size:.6rem;color:var(--t3);margin-top:.2rem" id="docStatusText">Aguardando validação</div>
    </div>
    <div style="font-size:.5rem;color:rgba(255,255,255,.2);text-align:center;margin-top:auto;padding:.6rem">
      Seus dados são criptografados e armazenados com segurança.<br>
      Usados exclusivamente para verificação de identidade.<br>
      Conforme LGPD Art. 7 — tratamento de dados pessoais.
    </div>
  </div>
</div>

<div id="eventView" class="screen">
  <div style="display:flex;align-items:center;padding:.6rem 1rem;background:rgba(18,18,26,.9);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06)">
    <button class="chb" onclick="closeEventView()">&#x2190;</button>
    <div style="flex:1;text-align:center">
      <div style="font-size:.75rem;font-weight:700;color:#60a5fa">📍 Check-in</div>
      <div style="font-size:.9rem;font-weight:600" id="evViewName"></div>
    </div>
    <div style="font-size:.7rem;color:var(--t2)" id="evViewCount">0</div>
  </div>
  <div style="flex:1;position:relative;overflow:hidden;background:#050508">
    <canvas id="evCanvas" style="width:100%;height:100%"></canvas>
    <!-- Leave event button -->
    <button id="evLeaveBtn" onclick="leaveEvent()" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);padding:.5rem 1.2rem;background:rgba(255,61,113,.12);border:1px solid rgba(255,61,113,.3);border-radius:14px;color:#ff3d71;font-size:.7rem;font-weight:600;font-family:inherit;cursor:pointer;backdrop-filter:blur(8px);transition:all .2s;z-index:5">Saí do evento</button>
  </div>
</div>

<div id="profile" class="screen">
  <div class="pf-header"><button class="chb" onclick="closeProfile()">&#x2190;</button><h2 id="pfTitle">Perfil</h2></div>
  <div class="pf-scroll" id="pfScroll"></div>
</div>

<!-- SUBSCRIPTION SCREEN -->
<div id="subscriptionScreen" class="screen">
  <div class="tip-header"><button class="chb" onclick="goHome()">&#x2190;</button><h2 style="font-size:1rem;font-weight:600">Touch? Plus</h2></div>
  <div style="padding:0 1.2rem;overflow-y:auto;flex:1">
    <!-- Current status -->
    <div id="subCurrentStatus" style="margin-bottom:1rem"></div>
    <!-- Plan card -->
    <div style="background:linear-gradient(145deg,rgba(99,102,241,.12),rgba(168,85,247,.1));border:1px solid rgba(99,102,241,.25);border-radius:18px;padding:1.5rem;text-align:center;margin-bottom:1rem">
      <div style="font-size:2rem;margin-bottom:.4rem">✦</div>
      <div style="font-size:1.3rem;font-weight:800;background:linear-gradient(135deg,#818cf8,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent">Touch? Plus</div>
      <div style="font-size:1.6rem;font-weight:800;color:var(--t1);margin:.5rem 0">R$9,90<span style="font-size:.7rem;font-weight:400;color:var(--t3)">/mês</span></div>
      <div id="subBenefitsList" style="text-align:left;margin:.8rem auto;max-width:260px"></div>
      <!-- Subscription payment methods -->
      <div id="subPayMethods" style="margin-top:.8rem;display:flex;flex-direction:column;gap:.4rem;text-align:left">
        <!-- Saved card + CVV -->
        <div id="subSavedCard" style="display:none">
          <div style="background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.15);border-radius:14px;padding:.7rem">
            <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
              <div style="width:36px;height:24px;border-radius:4px;background:linear-gradient(135deg,#1a1a2e,#2d2d44);display:flex;align-items:center;justify-content:center;font-size:.5rem;color:rgba(255,255,255,.5);flex-shrink:0" id="subSavedBrandIcon">CARD</div>
              <div style="flex:1">
                <div id="subSavedCardLabel" style="font-size:.7rem;font-weight:700;color:var(--t1)"></div>
                <div style="font-size:.45rem;color:var(--t3)">Cartão salvo</div>
              </div>
            </div>
            <div style="display:flex;gap:.3rem;align-items:center">
              <input type="text" id="subSavedCVV" class="tip-input" placeholder="CVV" inputmode="numeric" maxlength="4" style="width:70px;text-align:center;flex-shrink:0" oninput="validateSubCVV()">
              <button id="subCardPayBtn" onclick="subscribeWithCard()" disabled style="flex:1;background:linear-gradient(135deg,#6366f1,#8b5cf6);font-size:.75rem;padding:.6rem;border-radius:12px;border:none;color:#fff;font-weight:700;font-family:inherit;cursor:pointer">Assinar</button>
            </div>
          </div>
        </div>
        <!-- Mercado Pago -->
        <button onclick="startSubscription()" style="display:flex;align-items:center;gap:.5rem;width:100%;padding:.6rem .7rem;border-radius:14px;border:1px solid rgba(0,158,227,.2);background:rgba(0,158,227,.06);cursor:pointer;font-family:inherit">
          <svg width="24" height="24" viewBox="0 0 28 28" fill="none"><circle cx="14" cy="14" r="13" fill="#009ee3"/><path d="M7 17.5c0-3.5 2.5-7.5 7-7.5s7 4 7 7.5" stroke="#fff" stroke-width="2" stroke-linecap="round" fill="none"/><path d="M9 17c0-2.5 2-5.5 5-5.5s5 3 5 5.5" stroke="#fff" stroke-width="1.5" stroke-linecap="round" fill="none"/><circle cx="14" cy="17" r="1.5" fill="#fff"/></svg>
          <div style="flex:1;text-align:left"><div style="font-size:.7rem;font-weight:700;color:#009ee3">Mercado Pago</div><div style="font-size:.45rem;color:var(--t3)">Cartão, saldo ou parcelado</div></div>
          <span style="font-size:.55rem;color:var(--t3)">→</span>
        </button>
        <!-- PIX -->
        <button onclick="subscribeWithPix()" style="display:flex;align-items:center;gap:.5rem;width:100%;padding:.6rem .7rem;border-radius:14px;border:1px solid rgba(0,220,130,.15);background:rgba(0,220,130,.04);cursor:pointer;font-family:inherit">
          <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#00dc82,#00b36b);display:flex;align-items:center;justify-content:center;font-size:.65rem;color:#fff;font-weight:800;flex-shrink:0">P</div>
          <div style="flex:1;text-align:left"><div style="font-size:.7rem;font-weight:700;color:#00dc82">PIX</div><div style="font-size:.45rem;color:var(--t3)">Instantâneo, sem taxa</div></div>
          <span style="font-size:.55rem;color:var(--t3)">→</span>
        </button>
        <!-- Add card -->
        <button onclick="showSubNewCard()" style="display:flex;align-items:center;gap:.5rem;width:100%;padding:.5rem .7rem;border-radius:14px;border:1px dashed rgba(99,102,241,.2);background:transparent;cursor:pointer;font-family:inherit">
          <div style="width:24px;height:24px;border-radius:50%;background:rgba(99,102,241,.1);display:flex;align-items:center;justify-content:center;font-size:.6rem;color:#6366f1;font-weight:700;flex-shrink:0">+</div>
          <div style="font-size:.65rem;font-weight:600;color:var(--t2)">Adicionar cartão</div>
        </button>
      </div>
      <div id="subActionBtn" style="display:none"></div>
      <div style="font-size:.5rem;color:var(--t3);margin-top:.5rem;text-align:center">Cancele quando quiser. Renovação mensal R$9,90.</div>
    </div>
    <!-- FAQ -->
    <div style="font-size:.7rem;color:var(--t3);padding:.5rem 0 2rem">
      <div style="font-weight:600;color:var(--t2);margin-bottom:.4rem">Perguntas frequentes</div>
      <div style="margin-bottom:.4rem"><strong style="color:var(--t2)">Como funciona?</strong> Ao assinar, você é redirecionado para o Mercado Pago para confirmar. O pagamento é recorrente mensal.</div>
      <div style="margin-bottom:.4rem"><strong style="color:var(--t2)">Posso cancelar?</strong> Sim, a qualquer momento. Basta clicar em "Cancelar assinatura" aqui no perfil.</div>
      <div><strong style="color:var(--t2)">Os benefícios são imediatos?</strong> Sim! Assim que o pagamento for confirmado, sua conta é atualizada automaticamente.</div>
    </div>
  </div>
</div>

<div id="giftModal" class="hidden"></div>
<div id="declModal" class="hidden"></div>

<div id="encostaReqArea"></div>
<div id="toast" class="toast hidden"></div>

<script src="https://sdk.mercadopago.com/js/v2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
const $=id=>document.getElementById(id);
let socket=null,state={userId:localStorage.getItem('touch_userId'),userName:localStorage.getItem('touch_userName'),userColor:localStorage.getItem('touch_userColor')||'',userPhoto:localStorage.getItem('touch_userPhoto')||null,currentSession:null,currentRelation:null,timerInterval:null};
let typingTimeout=null,lastTypingEmit=0,pulseSent=false;

// ═══ FIREBASE AUTH ═══
let firebaseApp=null, firebaseAuthInstance=null, fbUser=null, loginIsRegister=false;

(async function initFirebase(){
  try{
    const r=await fetch('/api/firebase-config');
    const cfg=await r.json();
    firebaseApp=firebase.initializeApp(cfg);
    firebaseAuthInstance=firebase.auth();
    // Listen for auth state changes
    firebaseAuthInstance.onAuthStateChanged(async(user)=>{
      fbUser=user;
      if(user&&!state.userId){
        // User is signed in via Firebase but not linked to ENCOSTA yet
        await linkFirebaseToEncosta(user);
      }
    });
  }catch(e){console.warn('Firebase init falhou:',e.message)}
})();

async function linkFirebaseToEncosta(user){
  try{
    const token=await user.getIdToken();
    const r=await fetch('/api/auth/link',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body:JSON.stringify({firebaseUid:user.uid,email:user.email,displayName:user.displayName,photoURL:user.photoURL,encUserId:state.userId||null,nickname:window._pendingNickname||null})
    });
    const d=await r.json();
    if(d.userId){
      state.userId=d.userId;
      state.userName=d.user.nickname||d.user.name;
      state.userColor=d.user.color||'';
      state.userPhoto=d.user.profilePhoto||d.user.photoURL||null;
      localStorage.setItem('touch_userId',d.userId);
      localStorage.setItem('touch_userName',state.userName);
      localStorage.setItem('touch_userColor',state.userColor);
      if(state.userPhoto)localStorage.setItem('touch_userPhoto',state.userPhoto);
      // If user still needs to set nickname/birthdate, show register
      if(!d.user.birthdate){
        $('regNick').value=state.userName||'';
        showScreen('register');
        return;
      }
      initSocket();requestAccelPermission();
      showScreen('home');
      $('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(state.userName)+'</span>';
      const _ha=$('homeAvatar');
      if(_ha&&state.userName){
        if(state.userPhoto){_ha.innerHTML='<img src="'+esc(state.userPhoto)+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%" onerror="this.remove();this.parentElement.textContent=\''+esc((state.userName||'??').slice(0,2).toUpperCase())+'\'">';_ha.style.background=state.userColor||nickColor(state.userName);_ha.style.overflow='hidden'}
        else{_ha.textContent=(state.userName||'??').slice(0,2).toUpperCase();_ha.style.background=state.userColor||nickColor(state.userName)}
      }
      refreshHome();
    }
  }catch(e){console.error('Link Firebase erro:',e)}
}

async function loginWithGoogle(){
  try{
    $('loginErr').textContent='';
    const provider=new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({prompt:'select_account'});
    await firebaseAuthInstance.signInWithPopup(provider);
    // onAuthStateChanged will handle the rest
  }catch(e){
    if(e.code==='auth/popup-blocked'){
      // Fallback to redirect
      try{await firebaseAuthInstance.signInWithRedirect(new firebase.auth.GoogleAuthProvider())}catch(e2){$('loginErr').textContent='Erro ao abrir Google. Tente novamente.'}
    }else if(e.code!=='auth/popup-closed-by-user'){
      $('loginErr').textContent='Erro: '+(e.message||'tente novamente');
    }
  }
}

async function loginWithEmail(){
  const email=$('loginEmail').value.trim();
  const pass=$('loginPass').value;
  $('loginErr').textContent='';
  if(!email||!pass)return $('loginErr').textContent='Preencha e-mail e senha.';
  try{
    if(loginIsRegister){
      const nick=$('loginNick')?$('loginNick').value.trim():'';
      if(!nick||nick.length<2)return $('loginErr').textContent='Escolha um nickname (mín. 2 caracteres).';
      if(pass.length<6)return $('loginErr').textContent='Senha precisa ter no mínimo 6 caracteres.';
      if(!$('loginTermsCheck').checked)return $('loginErr').textContent='Aceite os Termos de Uso para continuar.';
      window._pendingNickname=nick;
      await firebaseAuthInstance.createUserWithEmailAndPassword(email,pass);
    }else{
      await firebaseAuthInstance.signInWithEmailAndPassword(email,pass);
    }
    // onAuthStateChanged will handle the rest
  }catch(e){
    const msgs={'auth/email-already-in-use':'Este e-mail já está cadastrado.','auth/invalid-email':'E-mail inválido.','auth/user-not-found':'Usuário não encontrado.','auth/wrong-password':'Senha incorreta.','auth/invalid-credential':'E-mail ou senha incorretos.','auth/weak-password':'Senha muito fraca (mínimo 6 caracteres).'};
    $('loginErr').textContent=msgs[e.code]||('Erro: '+(e.message||'tente novamente'));
  }
}

function toggleLoginMode(){
  loginIsRegister=!loginIsRegister;
  $('loginBtn').textContent=loginIsRegister?'CRIAR CONTA':'ENTRAR';
  $('loginToggle').innerHTML=loginIsRegister?'Já tem conta? <strong>Entrar</strong>':'Não tem conta? <strong>Criar agora — é rápido</strong>';
  $('loginErr').textContent='';
  $('loginNick').classList.toggle('hidden',!loginIsRegister);
  $('loginNickExplain').classList.toggle('hidden',!loginIsRegister);
  $('loginTermsUso').classList.toggle('hidden',!loginIsRegister);
  if(loginIsRegister)$('loginPass').placeholder='Crie uma senha (mín. 6 caracteres)';
  else $('loginPass').placeholder='Senha';
}

async function doLogout(){
  try{
    if(firebaseAuthInstance)await firebaseAuthInstance.signOut();
    localStorage.removeItem('touch_userId');localStorage.removeItem('touch_userName');localStorage.removeItem('touch_userColor');
    state.userId=null;state.userName=null;state.userColor='';fbUser=null;
    if(socket){socket.disconnect();socket=null}
    showScreen('login');
  }catch(e){showToast('Erro ao sair.')}
}

// ═══ ONBOARDING ═══
let onbSlide = 0;
const ONB_TOTAL = 5;
function initOnboarding() {
  const dots = $('onbDots');
  dots.innerHTML = '';
  for (let i = 0; i < ONB_TOTAL; i++) {
    const dot = document.createElement('div');
    dot.className = 'onb-dot' + (i === 0 ? ' active' : '');
    dots.appendChild(dot);
  }
}
function nextOnbSlide() {
  onbSlide++;
  if (onbSlide >= ONB_TOTAL) { skipOnboarding(); return; }
  $('onbSlides').style.transform = 'translateX(-' + (onbSlide * 100) + '%)';
  updateOnbDots();
  if (onbSlide === ONB_TOTAL - 1) $('onbNextBtn').textContent = 'Começar';
  // Retrigger animations for current slide
  const slides=document.querySelectorAll('.onb-slide');
  if(slides[onbSlide]){
    slides[onbSlide].querySelectorAll('.onb-icon,.onb-title,.onb-desc').forEach(el=>{
      el.style.animation='none';el.offsetHeight;el.style.animation='';
    });
  }
}
function updateOnbDots() {
  const dots = $('onbDots').children;
  for (let i = 0; i < dots.length; i++) dots[i].className = 'onb-dot' + (i === onbSlide ? ' active' : '');
}
function skipOnboarding() {
  localStorage.setItem('touch_onboarded', '1');
  showScreen('login');
}
function showTutorial(){showManual()}
function showManual(){
  onbSlide=0;
  initOnboarding();
  $('onbSlides').style.transform='translateX(0)';
  $('onbNextBtn').textContent='Próximo';
  // Retrigger fade-in animations by resetting them
  document.querySelectorAll('.onb-icon,.onb-title,.onb-desc').forEach(el=>{
    el.style.animation='none';
    el.offsetHeight; // force reflow
    el.style.animation='';
  });
  const oldSkip=window.skipOnboarding;
  window.skipOnboarding=function(){ showScreen('home'); window.skipOnboarding=oldSkip; };
  showScreen('onboarding');
}

// ═══ SOCKET ═══
function initSocket(){
  if(socket)return;
  socket=io({reconnection:true,reconnectionDelay:1000,reconnectionAttempts:Infinity});
  socket.on('connect',()=>{if(state.userId)socket.emit('identify',state.userId);updateConn('online')});
  socket.on('disconnect',()=>updateConn('offline'));
  socket.io.on('reconnect_attempt',()=>updateConn('reconnecting'));

  socket.on('relation-created',d=>{
    if(homeSonicActive)stopHomeSonic();
    if(sonicActive)stopSonicMode();
    state.currentRelation=d;playSound('connect');
    // Show epic connecting animation with continuous vibration, then reveal
    const co=$('connectingOverlay');
    if(co){
      const isRenewed=!!d.renewed;
      co.classList.remove('first','renewed');
      co.classList.add(isRenewed?'renewed':'first');
      co.classList.add('active');
      const isQuick=!!(d.isServiceTouch||d.isCheckin);
      startElectricTouch(isRenewed);
      haptic(isQuick?[60,20,60,20,100]:[80,30,80,30,120,40,120,40,150,30,150,30,200,20,200,20,250,15,250,15,300,10,300,10,400,10,500]);
      setTimeout(()=>{
        stopElectricTouch();
        if(navigator.vibrate)navigator.vibrate(0);
        co.classList.remove('active','first','renewed');
        showScreen('reveal');doReveal(d);
      },isQuick?1800:4200);
    }else{
      showScreen('reveal');doReveal(d);
    }
  });
  socket.on('new-message',({relationId,message})=>{
    if(state.currentRelation?.relationId===relationId){
      if(message.type==='reveal-request'||message.type==='reveal-accepted'||message.type==='reveal-declined'){
        appendRevealChatCard(message);
      }else{appendMessage(message)}
      playSound('receive');hideTyping();
    }
  });
  socket.on('partner-typing',({relationId})=>{
    if(state.currentRelation?.relationId===relationId)showTyping()
  });
  socket.on('pulse-received',({relationId})=>{
    // Heartbeat vibration: lub-dub, lub-dub, lub-dub
    const heartbeat=[120,60,80,300,120,60,80,300,120,60,80];
    if(state.currentRelation?.relationId===relationId){
      haptic(heartbeat);playSound('pulse');
      showToast('Sentiu um pulso...');
    }else{haptic(heartbeat);showToast('Alguém pulsou por você')}
  });
  socket.on('ephemeral-received',({relationId,message})=>{
    if(state.currentRelation?.relationId===relationId){appendEphemeral(message);playSound('receive')}
    else showToast('Nova mensagem!');
    haptic([50,30,50]);
  });
  socket.on('photo-received',({relationId,message})=>{
    if(state.currentRelation?.relationId===relationId){appendPhoto(message);playSound('receive')}
    else showToast('Foto recebida!');
    haptic([50,30,50]);
  });
  socket.on('selfie-request',({relationId})=>{
    if(state.currentRelation?.relationId===relationId)showToast('A outra pessoa quer registrar o encontro!');
  });
  socket.on('gift-received',({relationId,gift})=>{
    haptic([100,50,100]);playSound('connect');
    if(gift.needsAddress&&gift.addressStatus==='pending'){
      if(state.currentRelation?.relationId===relationId)showAddressRequest(gift);
      else showToast(gift.fromName+' te enviou '+gift.emoji+' '+gift.giftName+'!');
    }else{showToast(gift.fromName+' te enviou '+gift.emoji+' '+gift.giftName+'!')}
  });
  socket.on('declaration-received',({relationId,declaration})=>{
    haptic([50,30,50]);showToast(declaration.fromName+' escreveu uma declaração para você!');
  });
  socket.on('gift-address-accepted',({giftName})=>{showToast('Presente aceito! '+giftName+' será entregue.');haptic([50,30,50])});
  socket.on('gift-address-declined',({giftName})=>{showToast('Presente recusado: '+giftName);haptic([30])});
  socket.on('identity-request',({relationId,fromName})=>{
    haptic([60,30,60]);playSound('receive');
    showToast(fromName+' quer ver quem você é de verdade!');
  });
  // New: someone wants to reveal IDs (bilateral exchange request)
  // Reveal status update — sync constellation + chat UI
  socket.on('reveal-status-update',({relationId,fromUserId,toUserId,status})=>{
    const partnerId=(fromUserId===state.userId)?toUserId:fromUserId;
    if(!state.pendingReveals)state.pendingReveals={};
    if(status==='pending'){
      state.pendingReveals[partnerId]=fromUserId===state.userId?'sent':'received';
    }else{
      delete state.pendingReveals[partnerId];
    }
    // Update chat ID bar if open with this partner
    if(state.currentPartnerId===partnerId)updateChatIdBar();
  });
  // Bilateral reveal completed
  socket.on('identity-revealed',({fromUserId,realName,profilePhoto,instagram,bio})=>{
    haptic([80,40,80]);playSound('connect');
    if(!state.revealedIds)state.revealedIds={};
    state.revealedIds[fromUserId]={realName,profilePhoto,instagram,bio};
    syncRevealUI(fromUserId,realName,profilePhoto);
    refreshRelations();
    if(state.currentPartnerId!==fromUserId){
      showToast((realName||'Alguém')+' se revelou pra você! 🪪');
    }
  });
  socket.on('encosta-request',data=>showEncostaRequest(data));
  socket.on('encosta-declined',()=>{showToast('Pedido de touch recusado.');haptic([30])});
  socket.on('contact-request',data=>showContactRequest(data));
  socket.on('contact-shared',({relationId,contactType,value})=>{
    // Save contact info as persistent message in chat
    const labels={instagram:'📸 Instagram',whatsapp:'💬 WhatsApp',x:'𝕏 X',email:'📧 Email'};
    const text=(labels[contactType]||contactType)+': '+value;
    if(state.currentRelation?.relationId===relationId){
      appendMessage({userId:'system',text,timestamp:Date.now()});
    }
    // Also save as regular message on server
    if(relationId)socket.emit('send-message',{relationId,userId:'system',text});
    showToast(contactType+': '+value);haptic([20,40,20]);
  });
  socket.on('contact-declined',({contactType})=>{showToast('Pedido de '+contactType+' recusado.');haptic([30])});
  socket.on('selfie-taken',({relationId})=>{showToast('Selfie registrado!');haptic([20,40,20])});
  // Star earned — MUST donate immediately
  socket.on('star-must-donate',({pendingStarId,reason,context,totalEarned,pendingCount})=>{
    haptic([100,50,100,50,100]);playSound('connect');
    showStarDonateModal(pendingStarId,reason,context);
  });
  // Star donation confirmed
  socket.on('star-donation-confirmed',({toUserId,toName,recipientStars,pendingRemaining})=>{
    showToast('⭐ Estrela doada para '+toName+'!');
    // If more pending, next modal will come via star-must-donate
  });
  // Star received from someone
  socket.on('star-received',({fromUserId,fromName,total})=>{
    haptic([80,40,80,40,80]);playSound('connect');
    showToast('⭐ '+fromName+' te deu uma estrela! (Total: '+total+')');
  });
  // Network notification: someone donated a star
  socket.on('star-donated-notification',({recipientName,donorName,recipientStars})=>{
    showToast('⭐ '+recipientName+' ganhou estrela de '+donorName+'!');
  });
  socket.on('like-toggled',({fromUserId,liked})=>{
    haptic([30,20,30]);
    if(liked)showToast('Alguém curtiu seu perfil! ❤️');
    refreshRelations();
  });
  socket.on('streak-unlock',data=>showStreakUnlock(data));
  socket.on('tip-received',({amount,from,status})=>{
    if(status==='approved'){
      haptic([100,50,100,50,100]);playSound('connect');
      showToast('💰 Gorjeta recebida! R$'+amount.toFixed(2).replace('.',',')+' de '+from);
    }else if(status==='pending'||status==='in_process'){
      showToast('⏳ Gorjeta de R$'+amount.toFixed(2).replace('.',',')+' em processamento.');
    }
  });
}
function updateConn(s){const d=$('connDot');if(d)d.className='cd'+(s!=='online'?' '+s:'')}

// ═══ NAV ═══
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>{if(s.id!==id)s.classList.remove('active')});
  requestAnimationFrame(()=>$(id).classList.add('active'));
  if(id!=='reveal'&&typeof stopRevealLight==='function')stopRevealLight();
  if(state.timerInterval&&id!=='chat'){clearInterval(state.timerInterval);state.timerInterval=null}
  // Close selfie camera when leaving reveal
  if(id!=='reveal')releaseSelfieCamera();
  // Stop constellation animation + gyro when leaving
  if(id!=='history'){
    if(constState.animFrame){cancelAnimationFrame(constState.animFrame);constState.animFrame=null}
    if(constState._cleanGyro)constState._cleanGyro();
  }
  // Stop face camera when leaving face enrollment
  if(id!=='faceEnrollScreen'&&_faceStream){_faceStream.getTracks().forEach(t=>t.stop());_faceStream=null;_faceCapturing=false}
  // Stop home nodes animation when leaving home
  if(id!=='home'){
    if(_homeNodesAnim){cancelAnimationFrame(_homeNodesAnim);_homeNodesAnim=null}
    if(_homeNodesGyro){window.removeEventListener('deviceorientation',_homeNodesGyro);_homeNodesGyro=null}
  }
}
function showPhase(id){document.querySelectorAll('.ep').forEach(p=>p.classList.remove('active'));$(id).classList.add('active')}
function goHome(){showScreen('home');refreshHome()}

// ═══ EVENT VIEW — Constelação do evento no celular ═══
let evViewEventId=null,evViewCtx=null,evViewW=0,evViewH=0,evViewAnim=null;
const evNodes=[],evAmbientP=[];

async function showEventView(eventId,eventName){
  evViewEventId=eventId;
  $('evViewName').textContent=eventName||'Evento';
  showScreen('eventView');
  // Init canvas
  const cv=$('evCanvas');const rect=cv.parentElement.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  evViewW=rect.width;evViewH=rect.height;
  cv.width=evViewW*dpr;cv.height=evViewH*dpr;cv.style.width=evViewW+'px';cv.style.height=evViewH+'px';
  evViewCtx=cv.getContext('2d');evViewCtx.scale(dpr,dpr);
  evNodes.length=0;evAmbientP.length=0;
  for(let i=0;i<40;i++)evAmbientP.push({x:Math.random()*evViewW,y:Math.random()*evViewH,r:.5+Math.random()*1.5,vx:(Math.random()-.5)*.1,vy:(Math.random()-.5)*.1,a:.03+Math.random()*.12,phase:Math.random()*Math.PI*2});
  // Load attendees
  try{
    const r=await fetch('/api/operator/event/'+eventId+'/attendees');const d=await r.json();
    $('evViewCount').textContent=(d.attendees||[]).length+' pessoas';
    (d.attendees||[]).forEach(a=>addEvNode(a,true));
  }catch(e){console.error('[eventView] load error:',e)}
  // Socket listeners
  if(socket){
    socket.on('event-attendee-joined',d=>{if(d.eventId===evViewEventId){addEvNode(d);$('evViewCount').textContent=evNodes.length+' pessoas'}});
    socket.on('event-attendee-left',d=>{if(d.eventId===evViewEventId){evNodes=evNodes.filter(n=>n.userId!==d.userId);$('evViewCount').textContent=evNodes.length+' pessoas'}});
    socket.on('event-ended',d=>{if(d.eventId===evViewEventId){showToast('Evento encerrado: '+(d.name||''));closeEventView()}});
  }
  if(evViewAnim)cancelAnimationFrame(evViewAnim);
  renderEvCanvas();
}

function addEvNode(d,instant){
  const stars=d.stars||0;
  const maxStars=Math.max(1,...evNodes.map(n=>n.stars||0),stars);
  const maxDist=Math.min(evViewW,evViewH)*0.36;
  const minDist=35;
  const dist=maxDist-(stars/Math.max(1,maxStars))*(maxDist-minDist);
  const angle=Math.random()*Math.PI*2;
  const baseR=7+Math.min(stars*.3,5);
  const n={orbitAngle:angle,orbitDist:dist,orbitSpeed:0.0003+stars*0.00005,r:instant?baseR:0,targetR:baseR,color:d.color||'hsl('+(Math.random()*360)+',65%,45%)',name:d.nickname||'?',phase:Math.random()*Math.PI*2,glow:instant?0:1,userId:d.userId||null,revealed:d.revealed||false,revealData:d.revealData||null,profilePhoto:d.profilePhoto||null,stars:stars,topTag:d.topTag||null,photoImg:null,photoLoaded:false,x:0,y:0,verified:!!d.verified};
  if(n.revealed&&n.profilePhoto){
    const img=new Image();img.crossOrigin='anonymous';
    img.onload=()=>{n.photoImg=img;n.photoLoaded=true};
    img.src=n.profilePhoto;
  }
  evNodes.push(n);
}

function renderEvCanvas(){
  if(!evViewCtx)return;const c=evViewCtx;c.clearRect(0,0,evViewW,evViewH);const t=Date.now()/1000;
  const cx=evViewW/2,cy=evViewH/2;
  // Ambient
  evAmbientP.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=evViewW;if(p.x>evViewW)p.x=0;if(p.y<0)p.y=evViewH;if(p.y>evViewH)p.y=0;
    c.beginPath();c.arc(p.x,p.y,p.r,0,Math.PI*2);c.fillStyle='rgba(255,255,255,'+Math.max(0,p.a+Math.sin(t*1.5+p.phase)*.03)+')';c.fill()});
  // Recalc orbits
  const maxStars=Math.max(1,...evNodes.map(n=>n.stars||0));
  const maxDist=Math.min(evViewW,evViewH)*0.36;
  const minDist=35;
  // Orbit rings
  [.25,.5,.75].forEach(f=>{const rd=minDist+(maxDist-minDist)*f;c.beginPath();c.arc(cx,cy,rd,0,Math.PI*2);c.strokeStyle='rgba(99,102,241,.04)';c.lineWidth=.5;c.stroke()});
  // Update positions
  evNodes.forEach(n=>{
    n.orbitDist=maxDist-((n.stars||0)/maxStars)*(maxDist-minDist);
    n.orbitAngle+=n.orbitSpeed;
    n.x=cx+Math.cos(n.orbitAngle)*n.orbitDist;
    n.y=cy+Math.sin(n.orbitAngle)*n.orbitDist;
    if(n.r<1)return;
    // Line to center
    const la=.05+Math.sin(t*.8+n.phase)*.02;c.beginPath();c.moveTo(cx,cy);c.lineTo(n.x,n.y);c.strokeStyle='rgba(99,102,241,'+la+')';c.lineWidth=.6;c.stroke();
  });
  // Center — event icon
  const cs=18+Math.sin(t*2)*1;
  c.beginPath();c.arc(cx,cy,cs,0,Math.PI*2);c.fillStyle='#60a5fa';c.fill();c.strokeStyle='rgba(255,255,255,.15)';c.lineWidth=1.5;c.stroke();
  c.fillStyle='#fff';c.font='700 10px Inter';c.textAlign='center';c.textBaseline='middle';c.fillText('📍',cx,cy);
  // Nodes
  evNodes.forEach(n=>{if(n.r<n.targetR)n.r=Math.min(n.targetR,n.r+.3);const pulse=1+Math.sin(t*1.2+n.phase)*.04;const r=n.r*pulse;
    // Glow
    if(n.glow>0){const gr=r*5*n.glow;const g=c.createRadialGradient(n.x,n.y,0,n.x,n.y,gr);g.addColorStop(0,'rgba(96,165,250,'+(0.3*n.glow)+')');g.addColorStop(1,'rgba(0,0,0,0)');c.fillStyle=g;c.beginPath();c.arc(n.x,n.y,gr,0,Math.PI*2);c.fill();n.glow=Math.max(0,n.glow-.005)}
    // Top tag
    if(n.topTag&&n.r>=n.targetR*.8){
      const tagColors={top1:'#FFD700',top5:'#C0C0C0',top50:'#CD7F32',top100:'#6a5acd'};
      const tagLabels={top1:'TOP 1',top5:'TOP 5',top50:'TOP 50',top100:'TOP 100'};
      const tagCol=tagColors[n.topTag]||'#6a5acd';const tagLbl=tagLabels[n.topTag]||'';
      if(tagLbl){c.save();c.font='700 5px Inter';c.textAlign='center';c.textBaseline='middle';
        const tw=c.measureText(tagLbl).width+5;const th=9;const tx=n.x;const ty=n.y-r-th/2-2;
        c.fillStyle=tagCol;c.globalAlpha=.85;
        c.beginPath();const br=3;c.moveTo(tx-tw/2+br,ty-th/2);c.lineTo(tx+tw/2-br,ty-th/2);c.quadraticCurveTo(tx+tw/2,ty-th/2,tx+tw/2,ty-th/2+br);c.lineTo(tx+tw/2,ty+th/2-br);c.quadraticCurveTo(tx+tw/2,ty+th/2,tx+tw/2-br,ty+th/2);c.lineTo(tx-tw/2+br,ty+th/2);c.quadraticCurveTo(tx-tw/2,ty+th/2,tx-tw/2,ty+th/2-br);c.lineTo(tx-tw/2,ty-th/2+br);c.quadraticCurveTo(tx-tw/2,ty-th/2,tx-tw/2+br,ty-th/2);c.fill();
        c.globalAlpha=1;c.fillStyle='#000';c.fillText(tagLbl,tx,ty+.5);c.restore()}}
    // Node — photo or color
    if(n.revealed&&n.photoLoaded&&n.photoImg){
      c.save();c.beginPath();c.arc(n.x,n.y,r,0,Math.PI*2);c.clip();
      c.drawImage(n.photoImg,n.x-r,n.y-r,r*2,r*2);c.restore();
      c.beginPath();c.arc(n.x,n.y,r,0,Math.PI*2);c.strokeStyle='rgba(52,211,153,.6)';c.lineWidth=1.5;c.stroke();
    }else{
      c.beginPath();c.arc(n.x,n.y,r,0,Math.PI*2);c.fillStyle=n.color;c.fill();c.strokeStyle='rgba(255,255,255,.1)';c.lineWidth=.6;c.stroke();
      if(n.revealed){c.beginPath();c.arc(n.x,n.y,r+2,0,Math.PI*2);c.strokeStyle='rgba(52,211,153,.5)';c.lineWidth=1;c.stroke()}
      if(r>4){const ini2=(s)=>{if(!s)return'?';const p=s.trim().split(/\s+/);return p.length>1?(p[0][0]+p[1][0]).toUpperCase():s.slice(0,2).toUpperCase()};
        c.fillStyle='#fff';c.font='600 '+(r*.55)+'px Inter';c.textAlign='center';c.textBaseline='middle';c.fillText(ini2(n.name),n.x,n.y+.5)}}
    // Verified badge on canvas
    if(n.verified&&r>5){const br=Math.max(6,r*.5);const bx=n.x+r*.55,by=n.y+r*.55;
      const vg=c.createLinearGradient(bx-br,by-br,bx+br,by+br);vg.addColorStop(0,'#06b6d4');vg.addColorStop(.5,'#3b82f6');vg.addColorStop(1,'#8b5cf6');
      c.beginPath();for(let i=0;i<8;i++){const a=i*Math.PI/4-Math.PI/2;const ri=i%2===0?br:br*.6;c.lineTo(bx+Math.cos(a)*ri,by+Math.sin(a)*ri)}c.closePath();c.fillStyle=vg;c.fill();c.strokeStyle='#0a0a0f';c.lineWidth=1.5;c.stroke();
      c.fillStyle='#fff';c.font='700 '+(br*.85)+'px Inter';c.textAlign='center';c.textBaseline='middle';c.fillText('✓',bx,by+.3)}
    // Name + stars below
    if(r>6){const dName=n.revealed&&n.revealData&&n.revealData.realName?n.revealData.realName:n.name;
      c.fillStyle='rgba(255,255,255,.3)';c.font='400 6px Inter';c.textAlign='center';
      c.fillText(dName.length>12?dName.slice(0,12)+'…':dName,n.x,n.y+r+8);
      if(n.stars>0){c.fillStyle='rgba(255,215,0,.5)';c.font='400 5px Inter';c.fillText('⭐'+n.stars,n.x,n.y+r+15)}}
  });
  evViewAnim=requestAnimationFrame(renderEvCanvas);
}

function closeEventView(){
  if(evViewAnim){cancelAnimationFrame(evViewAnim);evViewAnim=null}
  const savedId=evViewEventId;
  const savedName=$('evViewName')?.textContent||'Evento';
  evViewEventId=null;evNodes.length=0;evViewCtx=null;
  if(socket){socket.off('event-attendee-joined');socket.off('event-attendee-left');socket.off('event-ended')}
  // Persist active event in localStorage for floating button
  if(savedId){
    localStorage.setItem('activeEventId',savedId);
    localStorage.setItem('activeEventName',savedName);
    showFloatingEventBtn(savedId,savedName);
  }
  goHome();
}

function showFloatingEventBtn(eventId,eventName){
  const btn=$('floatingEventBtn');if(!btn)return;
  $('floatingEventName').textContent=eventName;
  btn.style.display='';
  btn._eventId=eventId;btn._eventName=eventName;
  // Listen for event-ended to auto-hide
  if(socket){
    socket.off('event-ended-floating');
    socket.on('event-ended',function onEnded(d){
      if(d.eventId===eventId){
        hideFloatingEventBtn();
        showToast('O evento '+esc(eventName)+' foi encerrado');
        socket.off('event-ended',onEnded);
      }
    });
  }
}

function hideFloatingEventBtn(){
  const btn=$('floatingEventBtn');if(btn)btn.style.display='none';
  localStorage.removeItem('activeEventId');
  localStorage.removeItem('activeEventName');
}

function reopenEventView(){
  const btn=$('floatingEventBtn');
  const eventId=btn?._eventId||localStorage.getItem('activeEventId');
  const eventName=btn?._eventName||localStorage.getItem('activeEventName')||'Evento';
  if(eventId){
    btn.style.display='none';
    showEventView(eventId,eventName);
  }
}

async function leaveEvent(){
  const eventId=evViewEventId||localStorage.getItem('activeEventId');
  if(!eventId){closeEventView();return}
  try{
    await fetch('/api/operator/event/'+eventId+'/leave',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
  }catch(e){}
  hideFloatingEventBtn();
  if(evViewAnim){cancelAnimationFrame(evViewAnim);evViewAnim=null}
  evViewEventId=null;evNodes.length=0;evViewCtx=null;
  if(socket){socket.off('event-attendee-joined');socket.off('event-attendee-left');socket.off('event-ended')}
  showToast('Você saiu do evento');
  goHome();
}

// Restore floating event button on page load
function restoreFloatingEvent(){
  const eventId=localStorage.getItem('activeEventId');
  const eventName=localStorage.getItem('activeEventName');
  if(eventId&&eventName)showFloatingEventBtn(eventId,eventName);
}

// ── Request accelerometer permission (iOS requires user gesture) ──
let _accelPermGranted=false;
function requestAccelPermission(){
  if(_accelPermGranted)return;
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(p=>{
      if(p==='granted')_accelPermGranted=true;
    }).catch(()=>{});
  }else{_accelPermGranted=true}
}

async function refreshHome(){
  refreshRelations();
  setHomeMotivation();
  initServiceToggle();
  // Fetch user profile to get latest photo + real name
  if(state.userId){
    try{
      const mp=await fetch('/api/myprofile/'+state.userId).then(r=>r.json());
      const _mpPhoto=mp.profilePhoto||mp.photoURL||null;
      if(_mpPhoto){state.userPhoto=_mpPhoto;localStorage.setItem('touch_userPhoto',_mpPhoto)}
      state.userRealName=mp.realName||null;
      // Load canSee into revealedIds
      if(mp.canSee){
        if(!state.revealedIds)state.revealedIds={};
        Object.keys(mp.canSee).forEach(k=>{if(!state.revealedIds[k])state.revealedIds[k]=mp.canSee[k]});
      }
      if(mp.isPrestador)localStorage.setItem('touch_isPrestador','1');
      state.userVerified=!!mp.verified;
      state.userIsAdmin=!!mp.isAdmin;
      state.userStarsCount=mp.starsReceived||0;
      state.userFaceEnrolled=!!mp.faceEnrolled;
      state.userDocVerified=!!mp.docSubmitted;
      state.userScore=mp.score||0;
      state.userTopTag=mp.topTag||null;
      state.userRealName=mp.realName||'';
      state.userUniqueConnections=mp.uniqueConnections||0;
      state.userIsSubscriber=!!mp.isSubscriber;
      state.userGiftsReceived=mp.giftsReceived||0;
      const rnEl=$('homeRealName');
      if(rnEl){rnEl.textContent=mp.realName&&mp.realName!==state.userName?mp.realName:''}
      // Check for pending stars that need donation
      try{
        const pend=await fetch('/api/star/pending/'+state.userId).then(r2=>r2.json());
        if(pend.count>0&&!_starModalOpen){
          pend.pending.forEach(p=>showStarDonateModal(p.id,p.reason,p.context));
        }
      }catch(e2){}
    }catch(e){}
  }
  // Set homeAvatar
  if(state.userName){
    const av=$('homeAvatar');
    if(av){
      if(state.userPhoto){
        av.innerHTML='<img src="'+esc(state.userPhoto)+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%" onerror="this.remove();this.parentElement.textContent=\''+esc((state.userName||'??').slice(0,2).toUpperCase())+'\'">';
        av.style.background=state.userColor||nickColor(state.userName);av.style.overflow='hidden';
      }else{
        av.textContent=(state.userName||'??').slice(0,2).toUpperCase();av.style.background=state.userColor||nickColor(state.userName);
      }
    }
    // Show verified badge on home avatar
    const hvb=$('homeVerifiedBadge');
    if(hvb){if(state.userVerified)hvb.classList.remove('hidden');else hvb.classList.add('hidden')}
    // Show stars mini
    const hsm=$('homeStarsMini');
    if(hsm){if(state.userStarsCount>0){hsm.classList.remove('hidden');hsm.textContent='★'.repeat(Math.min(state.userStarsCount,5))+(state.userStarsCount>5?'+':'')}else hsm.classList.add('hidden')}
  }
  try{
    const [d,cn]=await Promise.all([
      fetch('/api/today/'+state.userId).then(r=>r.json()),
      fetch('/api/constellation/'+state.userId).then(r=>r.json())
    ]);
    const c=$('dailyCounter'),n=$('dailyNum');
    if(d.count>0){c.classList.remove('hidden');n.textContent=d.count}else c.classList.add('hidden');
    if(cn.total>0)$('constBtn').classList.remove('hidden');
    // Update home background nodes
    initHomeNodes(cn.nodes||[]);
  }catch(e){}
}

// ═══ HOME BACKGROUND NODES — rotating neural web ═══
let _homeNodesAnim=null,_homeNodesGyro=null;
function initHomeNodes(nodes){
  if(_homeNodesAnim){cancelAnimationFrame(_homeNodesAnim);_homeNodesAnim=null}
  if(_homeNodesGyro){window.removeEventListener('deviceorientation',_homeNodesGyro);_homeNodesGyro=null}
  const cv=$('homeNodesCanvas');if(!cv)return;
  const count=nodes.length;
  if(count<1)return;
  const dpr=window.devicePixelRatio||1;
  const W=window.innerWidth,H=window.innerHeight;
  cv.width=W*dpr;cv.height=H*dpr;
  cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');
  ctx.scale(dpr,dpr);
  // Generate node positions in an organic circle
  const pts=[];
  for(let i=0;i<count;i++){
    const angle=(i/count)*Math.PI*2+Math.random()*0.3;
    const radius=60+Math.random()*80+Math.min(count,20)*3;
    pts.push({
      x:Math.cos(angle)*radius+(Math.random()-0.5)*20,
      y:Math.sin(angle)*radius+(Math.random()-0.5)*20,
      r:2+Math.random()*2.5,
      phase:Math.random()*Math.PI*2,
      a:0.06+Math.random()*0.06
    });
  }
  // Generate connections (each node connects to 1-2 neighbors)
  const links=[];
  for(let i=0;i<pts.length;i++){
    const next=(i+1)%pts.length;
    links.push([i,next]);
    if(Math.random()>0.5&&pts.length>3){
      const skip=(i+2)%pts.length;
      links.push([i,skip]);
    }
  }
  let tiltX=0,tiltY=0,rawTX=0,rawTY=0;
  _homeNodesGyro=function(e){
    rawTX=Math.max(-1,Math.min(1,(e.gamma||0)/15));
    rawTY=Math.max(-1,Math.min(1,((e.beta||0)-45)/15));
  };
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(function(p){
      if(p==='granted')window.addEventListener('deviceorientation',_homeNodesGyro);
    }).catch(function(){});
  }else{
    window.addEventListener('deviceorientation',_homeNodesGyro);
  }
  const t0=performance.now();
  function draw(){
    _homeNodesAnim=requestAnimationFrame(draw);
    const t=(performance.now()-t0)/1000;
    tiltX+=(rawTX-tiltX)*0.06;
    tiltY+=(rawTY-tiltY)*0.06;
    ctx.clearRect(0,0,W,H);
    // Slow rotation + tilt offset
    const rot=t*0.08;
    const cx=W/2+tiltX*40;
    const cy=H*0.42+tiltY*30;
    // Draw connections
    ctx.lineWidth=0.5;
    links.forEach(([a,b])=>{
      const pa=pts[a],pb=pts[b];
      const ax=cx+Math.cos(rot)*pa.x-Math.sin(rot)*pa.y;
      const ay=cy+Math.sin(rot)*pa.x+Math.cos(rot)*pa.y;
      const bx=cx+Math.cos(rot)*pb.x-Math.sin(rot)*pb.y;
      const by=cy+Math.sin(rot)*pb.x+Math.cos(rot)*pb.y;
      const avg=(pa.a+pb.a)/2;
      ctx.beginPath();ctx.moveTo(ax,ay);ctx.lineTo(bx,by);
      ctx.strokeStyle='rgba(255,107,53,'+(avg*0.4).toFixed(3)+')';ctx.stroke();
    });
    // Draw nodes
    pts.forEach(p=>{
      const nx=cx+Math.cos(rot)*p.x-Math.sin(rot)*p.y;
      const ny=cy+Math.sin(rot)*p.x+Math.cos(rot)*p.y;
      const pulse=p.a+Math.sin(t*1.5+p.phase)*0.02;
      ctx.beginPath();ctx.arc(nx,ny,p.r,0,Math.PI*2);
      ctx.fillStyle='rgba(255,107,53,'+pulse.toFixed(3)+')';ctx.fill();
      // Tiny glow
      const g=ctx.createRadialGradient(nx,ny,0,nx,ny,p.r*4);
      g.addColorStop(0,'rgba(255,107,53,'+(pulse*0.3).toFixed(3)+')');
      g.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(nx,ny,p.r*4,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
    });
  }
  draw();
}

// ═══ REGISTER ═══
let nickCheckTimer=null;
function checkNick(val){
  const nick=val.trim(),hint=$('nickHint'),preview=$('avatarPreview');
  if(!nick||nick.length<2){hint.textContent='mínimo 2 caracteres';hint.className='nick-hint';preview.textContent='?';preview.style.background='var(--s2)';return}
  if(!/^[a-zA-Z0-9_.-]+$/.test(nick)){hint.textContent='só letras, números, _ . -';hint.className='nick-hint taken';return}
  // Update preview avatar
  const initials=nick.slice(0,2).toUpperCase();
  const color=nickColor(nick);
  preview.textContent=initials;preview.style.background=color;
  // Debounced availability check
  clearTimeout(nickCheckTimer);
  hint.textContent='verificando...';hint.className='nick-hint';
  nickCheckTimer=setTimeout(async()=>{
    try{
      const r=await fetch('/api/check-nick/'+encodeURIComponent(nick));const d=await r.json();
      if(d.available){hint.textContent='disponível!';hint.className='nick-hint ok'}
      else{hint.textContent='já existe';hint.className='nick-hint taken'}
    }catch(e){hint.textContent='';hint.className='nick-hint'}
  },400);
}
function nickColor(nick){let h=0;for(let i=0;i<nick.length;i++)h=nick.charCodeAt(i)+((h<<5)-h);return'hsl('+Math.abs(h)%360+',65%,55%)'}
const VERIFIED_SVG='<svg viewBox="0 0 24 24"><path fill="url(#verifiedGrad)" d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5 12 21.04l3.4 1.46 1.89-3.19 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.8 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.34z"/></svg>';
function verifiedBadge(sizeClass){return '<div class="verified-badge '+(sizeClass||'')+'">'+VERIFIED_SVG+'</div>'}
function makeAvatar(nick,color,size,photo,verified){
  size=size||44;
  const sizeClass=size<=30?'verified-badge-sm':size>=60?'verified-badge-lg':'';
  let inner;
  if(photo&&photo.length>10){
    inner='<div style="width:'+size+'px;height:'+size+'px;border-radius:50%;overflow:hidden;flex-shrink:0;border:1.5px solid rgba(255,255,255,.12);box-shadow:0 2px 8px rgba(0,0,0,.2)"><img src="'+photo+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>';
  } else {
    const initials=(nick||'??').slice(0,2).toUpperCase();
    inner='<div style="width:'+size+'px;height:'+size+'px;border-radius:50%;background:'+color+';display:flex;align-items:center;justify-content:center;font-size:'+(size*.36)+'px;font-weight:800;color:#fff;letter-spacing:.03em;flex-shrink:0;border:1.5px solid rgba(255,255,255,.12);box-shadow:0 2px 8px rgba(0,0,0,.2)">'+esc(initials)+'</div>';
  }
  if(verified) return '<div class="verified-wrap">'+inner+verifiedBadge(sizeClass)+'</div>';
  return inner;
}
async function doRegister(){
  const nick=$('regNick').value.trim(),birth=$('regBirth').value,terms=$('regTerms').checked,termsUso=$('regTermsUso').checked;
  if(!nick||nick.length<2)return showToast('Escolha um nickname.');if(!birth)return showToast('Data de nascimento.');if(!terms)return showToast('Aceite os termos.');if(!termsUso)return showToast('Aceite os Termos de Uso.');
  if(!/^[a-zA-Z0-9_.-]+$/.test(nick))return showToast('Nickname: só letras, números, _ . -');
  try{
    // If user already has ID (came from Firebase link), use update; else register new
    const endpoint=state.userId?'/api/register':'/api/register';
    const body={nickname:nick,birthdate:birth,acceptedTerms:true};
    if(state.userId)body.userId=state.userId;
    const r=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    if(d.userId){
      state.userId=d.userId;state.userName=nick;state.userColor=d.user.color;
      state.userPhoto=d.user.profilePhoto||d.user.photoURL||null;
      localStorage.setItem('touch_userId',d.userId);localStorage.setItem('touch_userName',nick);localStorage.setItem('touch_userColor',d.user.color||'');
      if(state.userPhoto)localStorage.setItem('touch_userPhoto',state.userPhoto);
      // Link with Firebase if signed in
      if(fbUser&&firebaseAuthInstance){
        try{await linkFirebaseToEncosta(fbUser)}catch(e){}
      }
      initSocket();requestAccelPermission();showScreen('home');
      $('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(nick)+'</span>';
      const _ha=$('homeAvatar');if(_ha){
        if(state.userPhoto){_ha.innerHTML='<img src="'+esc(state.userPhoto)+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%">';_ha.style.background=d.user.color||nickColor(nick);_ha.style.overflow='hidden'}
        else{_ha.textContent=nick.slice(0,2).toUpperCase();_ha.style.background=d.user.color||nickColor(nick)}
      }
      haptic([80]);
    }
  }catch(e){showToast('Erro ao registrar.')}
}

// ═══ ENCOUNTER ═══
// ═══ SERVICE MODE ═══
let serviceMode=false;
function toggleServiceMode(){
  serviceMode=!serviceMode;
  const toggle=$('serviceToggle');
  const btn=$('mainBtn');
  if(serviceMode){
    toggle.classList.add('active');
    $('serviceToggleLabel').textContent='SERVIÇO ATIVO';
    btn.classList.add('service-mode');
    $('mainBtnText').textContent='SERVIÇO';
    haptic([60,20,60]);
  }else{
    toggle.classList.remove('active');
    $('serviceToggleLabel').textContent='Modo Serviço';
    btn.classList.remove('service-mode');
    $('mainBtnText').textContent='TOUCH';
    haptic([30]);
  }
}
function initServiceToggle(){
  const isPrest=localStorage.getItem('touch_isPrestador')==='1';
  const toggle=$('serviceToggle');
  if(isPrest&&toggle)toggle.classList.remove('hidden');
}

function startEncounter(){haptic([40]);showScreen('encounter');showPhase('phaseChoose');$('joinCodeInput').value=''}

// ═══ MAIN BUTTON — sonic first, code fallback ═══
let homeSonicActive=false;
async function handleMainButton(){
  if(!state.userId){showToast('Faça login primeiro.');showScreen('login');return}
  if(homeSonicActive){stopHomeSonic();return}
  if(!socket||!socket.connected){showToast('Sem conexão. Aguarde...');return}
  haptic([40]);

  // RESET: kill any leftover audio/mic state from previous attempt
  stopSonicMode();

  homeSonicActive=true;
  sonicActive=true;sonicMyFreq=0;
  const btn=$('mainBtn'),txt=$('mainBtnText'),sts=$('sonicHomeStatus'),fb=$('sonicFallback');
  const barsL=$('sonicBarsL'),barsR=$('sonicBarsR'),fire=$('fireOverlay');
  // Shake animation on activate
  btn.classList.add('shake-activate');
  setTimeout(()=>btn.classList.remove('shake-activate'),700);
  btn.classList.add('energized');
  txt.textContent='ATIVANDO...';
  // ALWAYS request fresh mic permission to avoid stuck loops
  if(sonicStream){sonicStream.getTracks().forEach(t=>t.stop());sonicStream=null;}
  if(sonicMicCtx){try{sonicMicCtx.close()}catch(e){} sonicMicCtx=null;}
  if(sonicEmitCtx){try{sonicEmitCtx.close()}catch(e){} sonicEmitCtx=null;}
  sts.textContent='Pedindo microfone...';sts.classList.add('active');
  fb.classList.remove('active'); // reset fallback
  barsL.classList.add('active');barsR.classList.add('active');
  if(fire)fire.classList.add('active');
  const si=$('sonicInstruct');if(si)si.classList.add('active');

  try{
    // 1. Fresh mic permission — always request new stream
    sonicStream=await requestMic();
    if(!homeSonicActive)return;
    sts.textContent='Conectando ao servidor...';

    // 2. Get frequency from server
    socket.emit('sonic-start',{userId:state.userId,isServiceTouch:!!serviceMode});
    const freq=await new Promise((resolve,reject)=>{
      const t=setTimeout(()=>reject(new Error('Timeout')),5000);
      socket.once('sonic-assigned',({freq})=>{clearTimeout(t);resolve(freq)});
    });
    if(!homeSonicActive)return;
    sonicMyFreq=freq;

    // 3. Emit ultrasonic — fresh AudioContext
    sonicEmitCtx=new(window.AudioContext||window.webkitAudioContext)();
    if(sonicEmitCtx.state==='suspended')await sonicEmitCtx.resume();
    sonicOsc=sonicEmitCtx.createOscillator();
    sonicOsc.type='sine';
    sonicOsc.frequency.setValueAtTime(freq,sonicEmitCtx.currentTime);
    const gain=sonicEmitCtx.createGain();
    gain.gain.setValueAtTime(0.8,sonicEmitCtx.currentTime);
    sonicOsc.connect(gain);gain.connect(sonicEmitCtx.destination);
    sonicOsc.start();

    // 4. Start detection — fresh AudioContext for mic
    sonicMicCtx=new(window.AudioContext||window.webkitAudioContext)();
    if(sonicMicCtx.state==='suspended')await sonicMicCtx.resume();
    const source=sonicMicCtx.createMediaStreamSource(sonicStream);
    sonicAnalyser=sonicMicCtx.createAnalyser();
    sonicAnalyser.fftSize=SONIC_FFT_SIZE;
    sonicAnalyser.smoothingTimeConstant=0.3;
    source.connect(sonicAnalyser);
    const bufLen=sonicAnalyser.frequencyBinCount;
    const dataArr=new Uint8Array(bufLen);
    const sampleRate=sonicMicCtx.sampleRate;
    const freqPerBin=sampleRate/SONIC_FFT_SIZE;

    txt.textContent='TOUCHING...';
    sts.textContent='Encoste os alto-falantes 🔊';
    setTimeout(()=>{if(homeSonicActive){fb.classList.add('active');sts.textContent='Encoste os alto-falantes ou use código'}},10000);

    let confirmHits=0,lastSnapped=0;
    function detect(){
      if(!sonicActive)return;
      sonicAnalyser.getByteFrequencyData(dataArr);
      const minBin=Math.floor(18000/freqPerBin),maxBin=Math.ceil(20000/freqPerBin);
      let peakVal=0,peakBin=0;
      for(let i=minBin;i<=maxBin&&i<bufLen;i++){if(dataArr[i]>peakVal){peakVal=dataArr[i];peakBin=i}}
      if(peakVal>=SONIC_DETECT_THRESHOLD){
        const snapped=Math.round(Math.round(peakBin*freqPerBin)/100)*100;
        if(snapped!==sonicMyFreq&&snapped>=18000&&snapped<=19900){
          if(snapped===lastSnapped)confirmHits++;else{confirmHits=1;lastSnapped=snapped}
          if(confirmHits>=SONIC_CONFIRM_COUNT){
            haptic([100,30,100]);
            txt.textContent='CONECTOU!';sts.textContent='Encontramos alguém!';
            socket.emit('sonic-detected',{userId:state.userId,detectedFreq:snapped});
            sonicActive=false;return;
          }
        }
      }else if(confirmHits>0)confirmHits=Math.max(0,confirmHits-1);
      sonicAnimFrame=requestAnimationFrame(detect);
    }
    detect();
  }catch(e){
    console.error('Sonic error:',e);
    sts.textContent=e.name==='NotAllowedError'?'Microfone negado.':'Erro: '+e.message;
    fb.classList.add('active');
  }
}

function stopHomeSonic(){
  homeSonicActive=false;
  stopSonicMode();
  const btn=$('mainBtn'),txt=$('mainBtnText'),status=$('sonicHomeStatus'),fb=$('sonicFallback');
  const barsL=$('sonicBarsL'),barsR=$('sonicBarsR'),fire=$('fireOverlay');
  btn.classList.remove('energized');
  txt.textContent='TOUCH';
  status.classList.remove('active');
  fb.classList.remove('active');
  barsL.classList.remove('active');barsR.classList.remove('active');
  if(fire)fire.classList.remove('active');
  const si=$('sonicInstruct');if(si)si.classList.remove('active');
}
async function createSession(){
  if(!state.userId){showToast('Faça login primeiro.');showScreen('login');return}
  try{
    const r=await fetch('/api/session/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,isServiceTouch:serviceMode})});
    const d=await r.json();
    if(d.error){if(d.error.includes('inválido')){showToast('Sessão expirada. Faça login novamente.');localStorage.clear();showScreen('login');return}return showToast(d.error)}
    state.currentSession=d.sessionId;$('sessionCode').textContent=d.code;showPhase('phaseCode');generateQR(d.code);socket.emit('join-session',d.sessionId);
  }catch(e){showToast('Erro ao criar sessão.')}
}
async function joinSession(){
  const code=$('joinCodeInput').value.trim().toUpperCase();if(!code)return showToast('Digite o código.');
  if(!state.userId){showToast('Faça login primeiro.');showScreen('login');return}
  try{
    const r=await fetch('/api/session/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,code})});
    const d=await r.json();
    if(d.error){if(d.error.includes('inválido')){showToast('Sessão expirada.');localStorage.clear();showScreen('login');return}return showToast(d.error)}
    if(d.relationId){
      state.currentRelation=d;playSound('connect');
      const co=$('connectingOverlay');
      if(co){
        co.classList.remove('first','renewed');
        co.classList.add(d.renewed?'renewed':'first','active');
        const isQ2=!!(d.isServiceTouch||d.isCheckin);
        startElectricTouch(!!d.renewed);
        haptic(isQ2?[60,20,60,20,100]:[80,30,80,30,120,40,120,40,150,30,150,30,200,20,200,20,250,15,250,15,300,10,300,10,400,10,500]);
        setTimeout(()=>{stopElectricTouch();if(navigator.vibrate)navigator.vibrate(0);co.classList.remove('active','first','renewed');showScreen('reveal');doReveal(d)},isQ2?1800:4200);
      }else{showScreen('reveal');doReveal(d)}
    }
  }catch(e){showToast('Código inválido ou expirado.')}
}
function generateQR(code){
  const canvas=$('qrCanvas'),ctx=canvas.getContext('2d');canvas.width=180;canvas.height=180;ctx.clearRect(0,0,180,180);
  if(typeof QRCode!=='undefined'){const tmp=document.createElement('div');new QRCode(tmp,{text:location.origin+'?code='+code,width:180,height:180,colorDark:'#0a0a0a',colorLight:'#ffffff'});setTimeout(()=>{const src=tmp.querySelector('img')||tmp.querySelector('canvas');if(src){if(src.tagName==='CANVAS')ctx.drawImage(src,0,0,180,180);else{const i=new Image();i.onload=()=>ctx.drawImage(i,0,0,180,180);i.src=src.src}}},200)}
}

// ═══ SONIC — ultrasonic phone-to-phone ═══
let sonicActive=false,sonicEmitCtx=null,sonicOsc=null,sonicStream=null,sonicMicCtx=null,sonicAnalyser=null,sonicAnimFrame=null,sonicMyFreq=0;
const SONIC_FFT_SIZE=8192;
const SONIC_DETECT_THRESHOLD=80; // lowered: phone mics pick up 18kHz weakly
const SONIC_CONFIRM_COUNT=3; // need 3 consecutive detections to confirm (anti false-positive)

// Request mic permission and return stream (reusable)
async function requestMic(){
  return navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
}

function startSonicMode(){
  if(!state.userId){showToast('Faça login primeiro.');showScreen('login');return}
  if(!socket||!socket.connected){showToast('Sem conexão. Aguarde...');return}
  showPhase('phaseBump');
  const circle=$('bumpCircle'),label=$('bumpLabel'),status=$('bumpStatus');
  circle.className='bump-circle';label.textContent='PREPARANDO...';
  status.textContent='Pedindo microfone...';
  sonicActive=true;sonicMyFreq=0;
  initSonic(label,status,circle);
}

async function initSonic(label,status,circle){
  try{
    // 1. Get mic permission first
    sonicStream=await requestMic();
    if(status)status.textContent='Microfone OK. Conectando...';

    // 2. Ask server for frequency
    socket.emit('sonic-start',{userId:state.userId});
    const freq=await new Promise((resolve,reject)=>{
      const timeout=setTimeout(()=>reject(new Error('Server timeout')),5000);
      socket.once('sonic-assigned',({freq})=>{clearTimeout(timeout);resolve(freq)});
    });
    if(!sonicActive)return; // user may have cancelled
    sonicMyFreq=freq;

    // 3. Start emitting (louder for phone speakers)
    sonicEmitCtx=new(window.AudioContext||window.webkitAudioContext)();
    sonicOsc=sonicEmitCtx.createOscillator();
    sonicOsc.type='sine';
    sonicOsc.frequency.setValueAtTime(freq,sonicEmitCtx.currentTime);
    const gain=sonicEmitCtx.createGain();
    gain.gain.setValueAtTime(0.8,sonicEmitCtx.currentTime); // louder! phones need it
    sonicOsc.connect(gain);
    gain.connect(sonicEmitCtx.destination);
    sonicOsc.start();

    // 4. Start listening with confirmed detection
    sonicMicCtx=new(window.AudioContext||window.webkitAudioContext)();
    const source=sonicMicCtx.createMediaStreamSource(sonicStream);
    sonicAnalyser=sonicMicCtx.createAnalyser();
    sonicAnalyser.fftSize=SONIC_FFT_SIZE;
    sonicAnalyser.smoothingTimeConstant=0.3; // less smoothing = faster response
    source.connect(sonicAnalyser);
    const bufLen=sonicAnalyser.frequencyBinCount;
    const dataArr=new Uint8Array(bufLen);
    const sampleRate=sonicMicCtx.sampleRate;
    const freqPerBin=sampleRate/SONIC_FFT_SIZE;

    if(circle)circle.classList.add('listening');
    if(label)label.textContent='TOUCH!';
    if(status)status.textContent='Aproxime os celulares...';

    let confirmHits=0,lastSnapped=0;

    function detect(){
      if(!sonicActive)return;
      sonicAnalyser.getByteFrequencyData(dataArr);
      const minBin=Math.floor(18000/freqPerBin);
      const maxBin=Math.ceil(20000/freqPerBin);
      let peakVal=0,peakBin=0;
      for(let i=minBin;i<=maxBin&&i<bufLen;i++){
        if(dataArr[i]>peakVal){peakVal=dataArr[i];peakBin=i}
      }
      if(peakVal>=SONIC_DETECT_THRESHOLD){
        const detectedFreq=Math.round(peakBin*freqPerBin);
        const snapped=Math.round(detectedFreq/100)*100;
        // Ignore own frequency and out-of-range
        if(snapped!==sonicMyFreq&&snapped>=18000&&snapped<=19900){
          if(snapped===lastSnapped){confirmHits++}else{confirmHits=1;lastSnapped=snapped}
          if(confirmHits>=SONIC_CONFIRM_COUNT){
            // Confirmed detection!
            haptic([100,30,100]);
            if(circle){circle.classList.remove('listening');circle.classList.add('bumped')}
            if(label)label.textContent='CONECTOU!';
            if(status)status.textContent='Conectando...';
            socket.emit('sonic-detected',{userId:state.userId,detectedFreq:snapped});
            sonicActive=false;
            return;
          }
        }
      }else{
        // Reset if signal lost
        if(confirmHits>0)confirmHits=Math.max(0,confirmHits-1);
      }
      sonicAnimFrame=requestAnimationFrame(detect);
    }
    detect();

  }catch(e){
    console.error('Sonic init error:',e);
    if(status)status.textContent=e.name==='NotAllowedError'?'Microfone negado. Use código.':'Erro: '+e.message;
    sonicActive=false;
    const fb=$('sonicFallback');if(fb)fb.classList.add('active');
  }
}

function stopSonicMode(){
  sonicActive=false;
  if(sonicOsc){try{sonicOsc.stop()}catch(e){}}
  if(sonicEmitCtx){try{sonicEmitCtx.close()}catch(e){}}
  if(sonicMicCtx){try{sonicMicCtx.close()}catch(e){}}
  if(sonicStream){sonicStream.getTracks().forEach(t=>t.stop())}
  if(sonicAnimFrame)cancelAnimationFrame(sonicAnimFrame);
  sonicOsc=null;sonicEmitCtx=null;sonicMicCtx=null;sonicStream=null;sonicAnalyser=null;sonicAnimFrame=null;sonicMyFreq=0;
  if(socket&&socket.connected)socket.emit('sonic-stop',{userId:state.userId});
}

// ═══ ELECTRIC TOUCH — epic connection animation ═══
let _etAnim=null;
function startElectricTouch(isRenewed){
  const bg=$('coCanvas');if(!bg)return;
  const W=window.innerWidth,H=window.innerHeight;
  bg.width=W;bg.height=H;
  const ctx=bg.getContext('2d');
  // Phone mini canvases
  const cL=$('coPhoneL'),cR=$('coPhoneR');
  const ctxL=cL?cL.getContext('2d'):null;
  const ctxR=cR?cR.getContext('2d'):null;
  // Colors
  const baseR=isRenewed?255:220,baseG=isRenewed?200:230,baseB=isRenewed?60:255;
  const glowR=isRenewed?255:180,glowG=isRenewed?170:200,glowB=isRenewed?0:255;
  const t0=performance.now();
  // Lightning bolt generator
  function bolt(x0,y0,x1,y1,depth,maxD){
    const pts=[{x:x0,y:y0}];
    const segs=4+Math.floor(Math.random()*4);
    for(let i=1;i<segs;i++){
      const t=i/segs;
      const mx=x0+(x1-x0)*t;
      const my=y0+(y1-y0)*t;
      const spread=(1-Math.abs(t-.5)*2)*40*(1-depth/maxD);
      pts.push({x:mx+(Math.random()-.5)*spread,y:my+(Math.random()-.5)*spread});
    }
    pts.push({x:x1,y:y1});
    return pts;
  }
  function drawBolt(c,pts,alpha,width,r,g,b){
    c.beginPath();c.moveTo(pts[0].x,pts[0].y);
    for(let i=1;i<pts.length;i++)c.lineTo(pts[i].x,pts[i].y);
    c.strokeStyle='rgba('+r+','+g+','+b+','+alpha+')';
    c.lineWidth=width;c.lineCap='round';c.lineJoin='round';c.stroke();
    // Core white line
    c.beginPath();c.moveTo(pts[0].x,pts[0].y);
    for(let i=1;i<pts.length;i++)c.lineTo(pts[i].x,pts[i].y);
    c.strokeStyle='rgba(255,255,255,'+(alpha*.8)+')';
    c.lineWidth=Math.max(0.5,width*.3);c.stroke();
  }
  // Background bolts (full screen)
  let bgBolts=[];
  function genBgBolts(count){
    bgBolts=[];
    for(let i=0;i<count;i++){
      const side=Math.random()>.5;
      const x0=W/2+(side?-1:1)*(10+Math.random()*30);
      const y0=H/2+(Math.random()-.5)*40;
      const angle=Math.random()*Math.PI*2;
      const len=80+Math.random()*200;
      const x1=x0+Math.cos(angle)*len;
      const y1=y0+Math.sin(angle)*len;
      const pts=bolt(x0,y0,x1,y1,0,3);
      // Branch
      const branches=[];
      if(Math.random()>.4){
        const bi=1+Math.floor(Math.random()*(pts.length-2));
        const ba=angle+(Math.random()-.5)*1.2;
        const bl=30+Math.random()*80;
        branches.push(bolt(pts[bi].x,pts[bi].y,pts[bi].x+Math.cos(ba)*bl,pts[bi].y+Math.sin(ba)*bl,1,3));
      }
      bgBolts.push({pts,branches,alpha:.3+Math.random()*.5,width:1+Math.random()*2,life:0,maxLife:3+Math.random()*6});
    }
  }
  // Phone screen lightning (mirrored)
  function drawPhoneLightning(c,w,h,t,mirror){
    c.clearRect(0,0,w,h);
    // Radial energy from the touching edge
    const fromX=mirror?0:w;
    const grad=c.createRadialGradient(fromX,h/2,0,fromX,h/2,w*1.5);
    const a=.15+Math.sin(t*3)*.1;
    grad.addColorStop(0,'rgba('+baseR+','+baseG+','+baseB+','+a+')');
    grad.addColorStop(.4,'rgba('+baseR+','+baseG+','+baseB+','+(a*.3)+')');
    grad.addColorStop(1,'transparent');
    c.fillStyle=grad;c.fillRect(0,0,w,h);
    // Mini bolts from the edge
    const count=2+Math.floor(Math.random()*3);
    for(let i=0;i<count;i++){
      const x0=fromX;
      const y0=h*.2+Math.random()*h*.6;
      const x1=mirror?w*.5+Math.random()*w*.4:w*.1+Math.random()*w*.4;
      const y1=y0+(Math.random()-.5)*h*.4;
      const pts=bolt(x0,y0,x1,y1,0,2);
      const la=.4+Math.random()*.4;
      c.beginPath();c.moveTo(pts[0].x,pts[0].y);
      for(let j=1;j<pts.length;j++)c.lineTo(pts[j].x,pts[j].y);
      c.strokeStyle='rgba('+baseR+','+baseG+','+baseB+','+la+')';
      c.lineWidth=.8+Math.random();c.lineCap='round';c.stroke();
      c.beginPath();c.moveTo(pts[0].x,pts[0].y);
      for(let j=1;j<pts.length;j++)c.lineTo(pts[j].x,pts[j].y);
      c.strokeStyle='rgba(255,255,255,'+(la*.6)+')';
      c.lineWidth=.4;c.stroke();
    }
    // Scan line effect
    const scanY=(t*80)%h;
    c.fillStyle='rgba('+baseR+','+baseG+','+baseB+',0.06)';
    c.fillRect(0,scanY,w,2);
  }
  let frame=0;
  function animate(){
    const now=performance.now();
    const t=(now-t0)/1000;
    const progress=Math.min(1,t/4.2);
    // Clear background
    ctx.clearRect(0,0,W,H);
    // Dark vignette
    const vg=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,Math.max(W,H)*.7);
    vg.addColorStop(0,'transparent');
    vg.addColorStop(1,'rgba(0,0,0,.3)');
    ctx.fillStyle=vg;ctx.fillRect(0,0,W,H);
    // Generate new bolts periodically
    if(frame%4===0)genBgBolts(3+Math.floor(progress*5));
    // Draw background bolts
    bgBolts.forEach(b=>{
      const a=b.alpha*(1-b.life/b.maxLife)*(.5+progress*.5);
      if(a<=0)return;
      drawBolt(ctx,b.pts,a,b.width,glowR,glowG,glowB);
      b.branches.forEach(br=>drawBolt(ctx,br,a*.6,b.width*.6,glowR,glowG,glowB));
      b.life+=.5;
    });
    // Center glow pulse
    const gSize=20+Math.sin(t*4)*10+progress*30;
    const cg=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,gSize);
    cg.addColorStop(0,'rgba('+baseR+','+baseG+','+baseB+','+(0.3+progress*.3)+')');
    cg.addColorStop(.5,'rgba('+baseR+','+baseG+','+baseB+',0.08)');
    cg.addColorStop(1,'transparent');
    ctx.fillStyle=cg;ctx.fillRect(W/2-gSize,H/2-gSize,gSize*2,gSize*2);
    // Streaking energy lines radiating outward
    if(progress>.2){
      const lineCount=Math.floor(progress*12);
      for(let i=0;i<lineCount;i++){
        const angle=(i/lineCount)*Math.PI*2+t*.3;
        const len=30+progress*120+Math.sin(t*5+i)*20;
        const x0=W/2+Math.cos(angle)*8;
        const y0=H/2+Math.sin(angle)*8;
        const x1=W/2+Math.cos(angle)*len;
        const y1=H/2+Math.sin(angle)*len;
        ctx.beginPath();ctx.moveTo(x0,y0);ctx.lineTo(x1,y1);
        ctx.strokeStyle='rgba('+baseR+','+baseG+','+baseB+','+(0.1+Math.random()*.15)+')';
        ctx.lineWidth=.5+Math.random();ctx.stroke();
      }
    }
    // Phone screen animations (mirrored — left phone shows energy from right edge, right from left)
    if(ctxL&&ctxR){
      drawPhoneLightning(ctxL,92,160,t,false);
      drawPhoneLightning(ctxR,92,160,t,true);
    }
    frame++;
    _etAnim=requestAnimationFrame(animate);
  }
  _etAnim=requestAnimationFrame(animate);
}
function stopElectricTouch(){
  if(_etAnim){cancelAnimationFrame(_etAnim);_etAnim=null}
  const bg=$('coCanvas');if(bg){const c=bg.getContext('2d');c.clearRect(0,0,bg.width,bg.height)}
  const cL=$('coPhoneL'),cR=$('coPhoneR');
  if(cL)cL.getContext('2d').clearRect(0,0,92,160);
  if(cR)cR.getContext('2d').clearRect(0,0,92,160);
}

// ═══ REVEAL — cinematographic ═══
let _rvLightAnim=null;
let _rvLightHandler=null;
function stopRevealLight(){
  if(_rvLightAnim){cancelAnimationFrame(_rvLightAnim);_rvLightAnim=null}
  if(_rvLightHandler){window.removeEventListener('deviceorientation',_rvLightHandler);_rvLightHandler=null}
}
// beamColor: 'white'=new, 'gold'=known>24h, 'green'=renewed<24h, 'red'=<1h no bonus
function startRevealLight(beamColor){
  stopRevealLight();
  const cv=$('rvLightBeam');if(!cv)return;
  const dpr=window.devicePixelRatio||1;
  // Always use window dimensions to guarantee full coverage
  const W=window.innerWidth;
  const H=window.innerHeight;
  cv.width=W*dpr;cv.height=H*dpr;
  cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');
  ctx.scale(dpr,dpr);
  // Color palettes: [ambient, mid, core, hot, particle, edge]
  const palettes={
    white:{a:'200,210,230',m:'180,190,210',c:'220,230,245',h:'245,248,255',p:'210,220,240',e:'180,200,230'},
    gold:{a:'255,180,60',m:'255,160,50',c:'255,200,100',h:'255,235,180',p:'255,190,100',e:'255,170,50'},
    green:{a:'60,220,130',m:'40,200,110',c:'80,240,150',h:'180,255,210',p:'100,230,160',e:'50,210,120'},
    red:{a:'255,80,80',m:'255,60,60',c:'255,120,100',h:'255,200,180',p:'255,100,90',e:'255,70,70'}
  };
  const C=palettes[beamColor]||palettes.white;
  let tiltY=0,rawTY=0;
  _rvLightHandler=function(e){
    rawTY=Math.max(-1,Math.min(1,(e.gamma||0)/10));
  };
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(function(p){
      if(p==='granted')window.addEventListener('deviceorientation',_rvLightHandler);
    }).catch(function(){});
  }else{
    window.addEventListener('deviceorientation',_rvLightHandler);
  }
  const t0=performance.now();
  const particles=Array.from({length:40},()=>({
    x:Math.random()*W,vx:0.5+Math.random()*1.5,
    yOff:(Math.random()-0.5)*0.5,
    r:0.4+Math.random()*1.2,a:0.08+Math.random()*0.2,
    phase:Math.random()*Math.PI*2
  }));
  function animate(){
    const t=(performance.now()-t0)/1000;
    tiltY+=(rawTY-tiltY)*0.18;
    ctx.clearRect(0,0,W,H);
    const beamCY=H*0.47+tiltY*H*0.35;
    const breathe=1+Math.sin(t*0.9)*0.06;
    const tubeH=45*breathe;
    // Layer 1: Wide ambient — full rect 0 to W
    const g1=ctx.createLinearGradient(0,beamCY-tubeH*3,0,beamCY+tubeH*3);
    g1.addColorStop(0,'transparent');
    g1.addColorStop(0.3,'rgba('+C.a+',.015)');
    g1.addColorStop(0.5,'rgba('+C.a+',.035)');
    g1.addColorStop(0.7,'rgba('+C.a+',.015)');
    g1.addColorStop(1,'transparent');
    ctx.fillStyle=g1;ctx.fillRect(0,0,W,H);
    // Layer 2: Medium band
    const g2=ctx.createLinearGradient(0,beamCY-tubeH*1.2,0,beamCY+tubeH*1.2);
    g2.addColorStop(0,'transparent');
    g2.addColorStop(0.25,'rgba('+C.m+',.025)');
    g2.addColorStop(0.5,'rgba('+C.m+',.06)');
    g2.addColorStop(0.75,'rgba('+C.m+',.025)');
    g2.addColorStop(1,'transparent');
    ctx.fillStyle=g2;ctx.fillRect(0,0,W,H);
    // Layer 3: Narrow core
    const g3=ctx.createLinearGradient(0,beamCY-tubeH*0.35,0,beamCY+tubeH*0.35);
    g3.addColorStop(0,'transparent');
    g3.addColorStop(0.3,'rgba('+C.c+',.04)');
    g3.addColorStop(0.5,'rgba('+C.c+',.08)');
    g3.addColorStop(0.7,'rgba('+C.c+',.04)');
    g3.addColorStop(1,'transparent');
    ctx.fillStyle=g3;ctx.fillRect(0,0,W,H);
    // Layer 4: Hot wire
    const g4=ctx.createLinearGradient(0,beamCY-2,0,beamCY+2);
    g4.addColorStop(0,'transparent');
    g4.addColorStop(0.5,'rgba('+C.h+',.05)');
    g4.addColorStop(1,'transparent');
    ctx.fillStyle=g4;ctx.fillRect(0,0,W,H);
    // Flowing streaks left→right
    for(let i=0;i<5;i++){
      const sx=((t*60+i*W/5)%(W+160))-80;
      const sLen=80+Math.sin(t*0.8+i)*30;
      const sy=beamCY+Math.sin(t*1.2+i*1.3)*tubeH*0.3;
      const sg=ctx.createLinearGradient(sx,sy,sx-sLen,sy);
      sg.addColorStop(0,'rgba('+C.p+',.1)');
      sg.addColorStop(0.6,'rgba('+C.p+',.04)');
      sg.addColorStop(1,'transparent');
      ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx-sLen,sy+Math.sin(t+i)*2);
      ctx.strokeStyle=sg;ctx.lineWidth=1+Math.sin(t*2+i)*0.5;ctx.lineCap='round';ctx.stroke();
    }
    // Particles
    particles.forEach(p=>{
      p.x+=p.vx;
      if(p.x>W+10)p.x=-10;
      const py=beamCY+p.yOff*tubeH+Math.sin(t*0.6+p.phase)*tubeH*0.12;
      const fl=p.a+Math.sin(t*2.5+p.phase)*0.06;
      if(fl>0){
        ctx.beginPath();ctx.arc(p.x,py,p.r,0,Math.PI*2);
        ctx.fillStyle='rgba('+C.p+','+fl.toFixed(3)+')';ctx.fill();
      }
    });
    // Edge lines
    const ea=0.02+Math.sin(t*0.5)*0.008;
    ctx.beginPath();ctx.moveTo(0,beamCY-tubeH*0.5);ctx.lineTo(W,beamCY-tubeH*0.5);
    ctx.strokeStyle='rgba('+C.e+','+ea+')';ctx.lineWidth=0.5;ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,beamCY+tubeH*0.5);ctx.lineTo(W,beamCY+tubeH*0.5);
    ctx.strokeStyle='rgba('+C.e+','+ea+')';ctx.lineWidth=0.5;ctx.stroke();
    _rvLightAnim=requestAnimationFrame(animate);
  }
  _rvLightAnim=requestAnimationFrame(animate);
}

function doReveal(data){
  const a=data.userA,b=data.userB;
  const meIsA=a.id===state.userId;
  const me=meIsA?a:b,them=meIsA?b:a;
  const meColor=me.color||nickColor(me.name||'??'),themColor=them.color||nickColor(them.name||'??');
  const isDigital=data.type==='digital';

  // 0. Determine beam color based on relationship status
  // white=first encounter, gold=known but >24h since last, green=re-encounter <24h, red=<1h no bonus
  let beamColor='white';
  if(data.lastEncounter){
    const sinceMs=Date.now()-data.lastEncounter.timestamp;
    const hrs=sinceMs/3600000;
    if(hrs<1)beamColor='red';
    else if(hrs<24)beamColor='green';
    else beamColor='gold';
  }
  startRevealLight(beamColor);

  // 1. Avatars — always try photo first (profilePhoto, photoURL, state)
  const myPhoto=me.profilePhoto||me.photoURL||state.userPhoto;
  const theirPhoto=them.profilePhoto||them.photoURL;
  const myVerified=!!me.verified;
  const theirVerified=!!them.verified;
  if(myPhoto){
    let myAv='<img class="rv-avatar-img" src="'+esc(myPhoto)+'" alt="" onerror="this.outerHTML=makeAvatar(\''+esc(me.name||'??').replace(/'/g,"\\'")+'\',\''+esc(meColor)+'\',56)">';
    $('rvAvatarMeInner').innerHTML=myVerified?'<div class="verified-wrap">'+myAv+verifiedBadge('verified-badge-lg')+'</div>':myAv;
  }else{
    $('rvAvatarMeInner').innerHTML=makeAvatar(me.name,meColor,56,null,myVerified);
  }
  if(theirPhoto){
    let thAv='<img class="rv-avatar-img" src="'+esc(theirPhoto)+'" alt="" onerror="this.outerHTML=makeAvatar(\''+esc(them.name||'??').replace(/'/g,"\\'")+'\',\''+esc(themColor)+'\',56)">';
    $('rvAvatarThemInner').innerHTML=theirVerified?'<div class="verified-wrap">'+thAv+verifiedBadge('verified-badge-lg')+'</div>':thAv;
  }else{
    $('rvAvatarThemInner').innerHTML=makeAvatar(them.name,themColor,56,null,theirVerified);
  }
  $('rvNameMe').textContent=me.realName||me.name||'?';
  $('rvNameThem').textContent=them.realName||them.name||'?';

  // Detect special modes
  const isService=!!data.isServiceTouch;
  const isCheckin=!!data.isCheckin;
  const isSpecial=isService||isCheckin;

  // 2. Moment label + phrase + sub
  const moment=$('revealMoment');
  const phraseEl=$('revealPhrase');
  const subEl=document.querySelector('.rv-sub');
  const zodiacArea=$('zodiacArea');
  const lastEl=$('revealLast');

  // Remove previous service badge if any
  const oldBadge=document.querySelector('.rv-service-badge');
  if(oldBadge)oldBadge.remove();

  if(isService){
    // ── SERVICE REVEAL ──
    moment.textContent='Conexão de serviço';
    moment.style.color='#34d399';
    // Service badge with label
    const badge=document.createElement('div');
    badge.className='rv-service-badge';
    badge.textContent='💼 '+(them.serviceLabel||'Serviço');
    moment.after(badge);
    // Hide poetic elements
    phraseEl.innerHTML='';phraseEl.style.display='none';
    if(subEl)subEl.style.display='none';
    zodiacArea.classList.add('hidden');zodiacArea.innerHTML='';
    $('revealRenewed').classList.add('hidden');
    lastEl.classList.add('hidden');
    startRevealLight('#34d399');
  }else if(isCheckin){
    // ── CHECK-IN REVEAL — show EVENT, not operator ──
    const evName=data.eventName||data.operatorName||them.name||'Evento';
    // Override "them" avatar to show event icon
    $('rvAvatarThemInner').innerHTML='<div style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-size:1.6rem;box-shadow:0 0 20px rgba(96,165,250,.3)">📍</div>';
    $('rvNameThem').textContent=evName;
    moment.textContent='Check-in';
    moment.style.color='#60a5fa';
    const badge=document.createElement('div');
    badge.className='rv-service-badge';
    badge.style.borderColor='rgba(96,165,250,.3)';badge.style.background='rgba(96,165,250,.08)';badge.style.color='#60a5fa';
    badge.innerHTML='📍 Check-in em '+esc(evName);
    moment.after(badge);
    phraseEl.innerHTML='';phraseEl.style.display='none';
    if(subEl)subEl.style.display='none';
    zodiacArea.classList.add('hidden');zodiacArea.innerHTML='';
    $('revealRenewed').classList.add('hidden');
    lastEl.classList.add('hidden');
    startRevealLight('#60a5fa');
  }else{
    // ── NORMAL REVEAL ──
    moment.textContent=isDigital?'uma conexão nasceu':'algo nasceu entre vocês';
    moment.style.color='';
    phraseEl.style.display='';
    if(subEl)subEl.style.display='';
    // 3. Renewed
    data.renewed?$('revealRenewed').classList.remove('hidden'):$('revealRenewed').classList.add('hidden');
    // 4. Last encounter
    if(data.lastEncounter){
      const ago=Date.now()-data.lastEncounter.timestamp;
      const days=Math.floor(ago/86400000),hrs=Math.floor((ago%86400000)/3600000);
      let agoStr=days>0?days+'d '+hrs+'h atrás':hrs>0?hrs+'h atrás':'agora';
      lastEl.innerHTML='Último: <strong>'+agoStr+'</strong>';
      lastEl.classList.remove('hidden');
    }else lastEl.classList.add('hidden');
    // 5. Phrase — word by word
    phraseEl.innerHTML='';
    const baseDelay=0.8;
    data.phrase.split(' ').forEach((w,i)=>{
      const s=document.createElement('span');s.className='rv-word';
      s.textContent=w+'\u00A0';
      s.style.animationDelay=(baseDelay+i*0.22)+'s';
      phraseEl.appendChild(s);
    });
    // 6. Zodiac
    if(data.zodiacPhrase&&data.userA?.signInfo&&data.userB?.signInfo){
      zodiacArea.classList.remove('hidden');
      zodiacArea.innerHTML='<div class="zodiac-phrase">'+esc(data.zodiacPhrase)+'</div>';
    }else{zodiacArea.classList.add('hidden');zodiacArea.innerHTML=''}
    startRevealLight(beamColor);
  }

  // 7. Reset selfie
  releaseSelfieCamera();
  $('selfiePreview').style.display='none';$('selfiePreview').innerHTML='';
  const capBtn=$('selfieCapBtn');
  if(capBtn){capBtn.innerHTML='<span class="rv-ico">📸</span>Selfie';capBtn.disabled=false}
  $('revealActions').style.opacity='';

  // 8. Configure action buttons based on mode
  const tipBtn=$('revealTipBtn');
  const enterBtn=$('revealEnterBtn');
  const skipBtn=$('revealSkipBtn');
  const secRow=document.querySelector('#revealActions .rv-sec-row');

  // Reset buttons to default state first
  if(enterBtn){enterBtn.style.display='';enterBtn.textContent='Abrir conexão';enterBtn.onclick=function(){enterChat()}}
  if(tipBtn){tipBtn.className='rv-btn-mini hidden';tipBtn.style.cssText='';tipBtn.innerHTML='<span class="rv-ico">💲</span><span id="revealTipLabel">Gorjeta</span>'}
  if(capBtn)capBtn.style.display='';
  if(secRow)secRow.style.display='';

  if(isService){
    // SERVICE: gorjeta principal, chat pequeno, sem selfie
    if(enterBtn)enterBtn.style.display='none';
    if(capBtn)capBtn.style.display='none';
    if(tipBtn){
      tipBtn.className='rv-btn-enter';
      tipBtn.style.cssText='background:linear-gradient(135deg,#34d399,#059669);border-color:#34d399;color:#fff;font-size:.82rem;font-weight:600;width:100%;padding:.7rem 0;';
      tipBtn.textContent='💲 Pagar Gorjeta'+(them.serviceLabel?' — '+them.serviceLabel:'');
      tipBtn.dataset.receiverId=them.id;
      tipBtn.classList.remove('hidden');
      const mainRow=document.querySelector('#revealActions .rv-btn-row');
      if(mainRow)mainRow.prepend(tipBtn);
    }
    // Add small chat button in sec row
    if(secRow){
      secRow.innerHTML='<button type="button" class="rv-btn-mini" onclick="enterChat()"><span class="rv-ico">💬</span>Abrir chat</button>';
    }
  }else if(isCheckin){
    // CHECKIN: check entry price, reveal, go to event view
    const evId=data.eventId||null;
    const evName=data.eventName||data.operatorName||'Evento';
    const entryPrice=data.entryPrice||0;

    if(entryPrice>0){
      // ── PAID CHECK-IN — show payment first ──
      const priceLabel='R$'+entryPrice.toFixed(2).replace('.',',');
      if(enterBtn){
        enterBtn.textContent='🎫 Pagar ingresso '+priceLabel;
        enterBtn.style.background='linear-gradient(135deg,#6366f1,#4f46e5)';
        enterBtn.onclick=function(){showEntryPayment(evId,evName,entryPrice,them.id)}
      }
      if(skipBtn){skipBtn.textContent='Cancelar';skipBtn.onclick=function(){goHome()}}
      if(secRow){
        secRow.innerHTML='<div style="font-size:.62rem;color:#fbbf24;text-align:center;padding:.3rem;line-height:1.5">🎫 Este evento cobra '+priceLabel+' de ingresso.</div>';
      }
    }else if(data.requireReveal){
      if(enterBtn){enterBtn.textContent='Revelar e continuar';enterBtn.style.background='linear-gradient(135deg,#34d399,#10b981)';enterBtn.onclick=function(){revealToOperator(them.id,evId,evName)}}
      if(skipBtn){skipBtn.textContent='Continuar anônimo';skipBtn.onclick=function(){if(evId)showEventView(evId,evName);else goHome()}}
      if(secRow){secRow.innerHTML='<div style="font-size:.62rem;color:#60a5fa;text-align:center;padding:.3rem;line-height:1.5">📋 Este estabelecimento solicita identificação.<br>Revele sua identidade para uma experiência completa.</div>'}
    }else{
      if(enterBtn){enterBtn.textContent='Revelar meus dados';enterBtn.onclick=function(){revealToOperator(them.id,evId,evName)}}
      if(skipBtn){skipBtn.textContent='Só check-in';skipBtn.onclick=function(){if(evId)showEventView(evId,evName);else goHome()}}
      if(secRow)secRow.style.display='none';
    }
  }else{
    // NORMAL: show gorjeta if them is prestador
    if(tipBtn&&them.isPrestador){
      tipBtn.classList.remove('hidden');
      tipBtn.dataset.receiverId=them.id;
      const lbl=$('revealTipLabel');
      if(lbl)lbl.textContent='Dar gorjeta'+(them.serviceLabel?' — '+them.serviceLabel:'');
    }
  }

  // Reset service mode after touch
  if(serviceMode){
    serviceMode=false;
    const toggle=$('serviceToggle');if(toggle)toggle.classList.remove('active');
    const btn2=$('mainBtn');if(btn2)btn2.classList.remove('service-mode');
    $('mainBtnText').textContent='TOUCH';
    $('serviceToggleLabel').textContent='Modo Serviço';
  }
}

// Reveal data to operator (checkin mode)
function revealToOperator(operatorId,eventId,eventName){
  fetch('/api/identity/reveal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,targetUserId:operatorId})})
  .then(r=>r.json()).then(d=>{
    if(d.error)showToast(d.error);
    else{showToast('Dados revelados!');if(eventId)showEventView(eventId,eventName);else enterChat()}
  }).catch(()=>showToast('Erro ao revelar.'));
}

function openTipFromReveal(){
  const btn=$('revealTipBtn');
  if(btn&&btn.dataset.receiverId) showTipScreen(btn.dataset.receiverId);
}

// ═══ ENTRY PAYMENT — pay to enter operator event ═══
async function showEntryPayment(eventId,eventName,price,operatorId){
  const priceLabel='R$'+price.toFixed(2).replace('.',',');
  const secRow=document.querySelector('#revealActions .rv-sec-row');
  const enterBtn=$('revealEnterBtn');

  // Check if user has saved card for one-tap
  let hasSaved=false;
  try{
    const sc=await fetch('/api/tip/saved-card/'+state.userId).then(r=>r.json());
    if(sc.hasSaved)hasSaved=true;
  }catch(e){}

  if(hasSaved){
    // ONE-TAP: pay immediately with saved card
    if(enterBtn){enterBtn.disabled=true;enterBtn.textContent='Processando...'}
    try{
      const resp=await fetch('/api/operator/event/'+eventId+'/pay-entry',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({userId:state.userId,useSavedCard:true})
      });
      const result=await resp.json();
      if(result.error){
        if(result.cardExpired){
          // Fallback to new card
          showEntryCardForm(eventId,eventName,price,operatorId);
          return;
        }
        throw new Error(result.error);
      }
      if(result.status==='approved'){
        showToast('Ingresso pago! ✅');
        haptic([50,30,50,30,50]);
        showEventView(eventId,eventName);
      }else{
        showToast('Pagamento pendente ⏳');
        showEventView(eventId,eventName);
      }
    }catch(e){
      showToast('Erro: '+(e.message||'Tente novamente'));
      if(enterBtn){enterBtn.disabled=false;enterBtn.textContent='🎫 Pagar ingresso '+priceLabel}
    }
  }else{
    // No saved card — show card form inline
    showEntryCardForm(eventId,eventName,price,operatorId);
  }
}

function showEntryCardForm(eventId,eventName,price,operatorId){
  const priceLabel='R$'+price.toFixed(2).replace('.',',');
  const secRow=document.querySelector('#revealActions .rv-sec-row');
  const enterBtn=$('revealEnterBtn');
  const skipBtn=$('revealSkipBtn');

  if(enterBtn)enterBtn.style.display='none';
  if(skipBtn)skipBtn.style.display='none';

  if(secRow){
    secRow.style.display='';
    secRow.innerHTML='<div style="width:100%;padding:.6rem">'
      +'<div style="font-size:.7rem;font-weight:600;color:var(--t1);text-align:center;margin-bottom:.5rem">🎫 Ingresso '+priceLabel+' — '+esc(eventName)+'</div>'
      +'<input type="text" id="entryCardNumber" class="tip-input" placeholder="Número do cartão" inputmode="numeric" maxlength="19" autocomplete="cc-number" oninput="formatCardNumber(this)" style="margin-bottom:.3rem">'
      +'<div style="display:flex;gap:.3rem;margin-bottom:.3rem"><input type="text" id="entryCardExpiry" class="tip-input" placeholder="MM/AA" inputmode="numeric" maxlength="5" oninput="formatExpiry(this)" style="flex:1"><input type="text" id="entryCardCVV" class="tip-input" placeholder="CVV" inputmode="numeric" maxlength="4" style="flex:1"></div>'
      +'<input type="text" id="entryCardHolder" class="tip-input" placeholder="Nome no cartão" style="margin-bottom:.3rem">'
      +'<input type="text" id="entryCardCPF" class="tip-input" placeholder="CPF" inputmode="numeric" maxlength="14" oninput="formatCPF(this)" style="margin-bottom:.3rem">'
      +'<div style="display:flex;align-items:center;gap:.3rem;margin-bottom:.5rem"><input type="checkbox" id="entrySaveCard" checked style="accent-color:#6366f1"><label for="entrySaveCard" style="font-size:.55rem;color:var(--t3)">Salvar cartão</label></div>'
      +'<button onclick="payEntry(\''+eventId+'\',\''+eventName.replace(/'/g,"\\'")+'\','+price+')" style="width:100%;padding:.65rem;border-radius:14px;border:none;background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;font-size:.82rem;font-weight:700;font-family:inherit;cursor:pointer" id="entryPayBtn">🎫 Pagar '+priceLabel+'</button>'
      +'<button onclick="goHome()" style="width:100%;padding:.3rem;border:none;background:transparent;color:var(--t3);font-size:.55rem;font-family:inherit;cursor:pointer;margin-top:.3rem">Cancelar</button>'
      +'</div>';
  }
}

async function payEntry(eventId,eventName,price){
  const cardNum=($('entryCardNumber')||{}).value?.replace(/\s/g,'')||'';
  const expiry=($('entryCardExpiry')||{}).value||'';
  const cvv=($('entryCardCVV')||{}).value||'';
  const holder=($('entryCardHolder')||{}).value?.trim()||'';
  const cpf=($('entryCardCPF')||{}).value?.replace(/\D/g,'')||'';
  if(!cardNum||cardNum.length<13)return showToast('Número do cartão inválido.');
  if(!expiry||expiry.length<5)return showToast('Data de validade inválida.');
  if(!cvv||cvv.length<3)return showToast('CVV inválido.');
  if(!holder)return showToast('Nome no cartão obrigatório.');
  if(!cpf||cpf.length<11)return showToast('CPF inválido.');

  const btn=$('entryPayBtn');
  if(btn){btn.disabled=true;btn.textContent='Processando...'}

  try{
    const mp=await getMpSdk();
    if(!mp)throw new Error('SDK não disponível.');
    const [expMonth,expYear]=expiry.split('/');
    // BIN detection
    const d1=cardNum[0],d2=cardNum.substring(0,2);
    let pmId='visa';
    if(d1==='5'||d2==='22'||d2==='23'||d2==='24'||d2==='25'||d2==='26'||d2==='27')pmId='master';
    else if(d1==='4')pmId='visa';
    else if(d2==='34'||d2==='37')pmId='amex';
    else if(d2==='60'||d2==='65'||d2==='63')pmId='elo';

    const tokenResult=await mp.createCardToken({
      cardNumber:cardNum,cardholderName:holder,
      cardExpirationMonth:expMonth,cardExpirationYear:'20'+expYear,
      securityCode:cvv,identificationType:'CPF',identificationNumber:cpf
    });
    if(!tokenResult||!tokenResult.id)throw new Error('Erro ao tokenizar.');

    const resp=await fetch('/api/operator/event/'+eventId+'/pay-entry',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userId:state.userId,token:tokenResult.id,paymentMethodId:pmId,payerEmail:state.email||state.userId+'@touch.app',payerCPF:cpf})
    });
    const result=await resp.json();
    if(result.error)throw new Error(result.error);

    // Save card if checked
    if($('entrySaveCard')&&$('entrySaveCard').checked){
      try{
        const saveToken=await mp.createCardToken({
          cardNumber:cardNum,cardholderName:holder,
          cardExpirationMonth:expMonth,cardExpirationYear:'20'+expYear,
          securityCode:cvv,identificationType:'CPF',identificationNumber:cpf
        });
        if(saveToken?.id){
          await fetch('/api/tip/save-card',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,token:saveToken.id,email:state.email||'',cpf})});
        }
      }catch(e){console.error('Save card err:',e)}
    }

    if(result.status==='approved'){
      showToast('Ingresso pago! ✅');
      haptic([50,30,50,30,50]);
      showEventView(eventId,eventName);
    }else{
      showToast('Pagamento pendente ⏳');
      showEventView(eventId,eventName);
    }
  }catch(e){
    console.error('Entry pay error:',e);
    showToast('Erro: '+(e.message||'Tente novamente'));
    if(btn){btn.disabled=false;btn.textContent='🎫 Pagar R$'+price.toFixed(2).replace('.',',')}
  }
}

// ═══ CHAT ═══
function enterChat(){if(state.currentRelation)openChat(state.currentRelation)}
async function openChat(rel){
  state.currentRelation=rel;pulseSent=false;
  const pb=$('pulseBtn');if(pb)pb.style.opacity='1';
  const partner=(rel.userA?.id===state.userId)?rel.userB:rel.userA;
  const isEventRel=!!(rel.isEvent||rel.eventId);
  const pNick=isEventRel?(rel.eventName||rel.partnerName||'Evento'):(partner?.nickname||rel.partnerName||'Pessoa');
  const pRealName=isEventRel?null:(partner?.realName||null);
  const pName=pRealName||pNick;
  state.currentPartnerId=partner?.id||rel.partnerId||null;
  // Event-type chat: show event info
  if(isEventRel){
    $('chatPartner').textContent=pNick;
    $('chatSub').innerHTML='<span style="color:#60a5fa">📍 Chat da organização</span> · '+esc(pNick);
  }else if(pRealName&&pRealName!==pNick){
    $('chatPartner').textContent=pRealName;
    $('chatSub').innerHTML='<span style="color:var(--ok)">✓ ID revelado</span> · @'+esc(pNick);
  }else{
    $('chatPartner').textContent=pNick;
    $('chatSub').textContent='nickname';
  }
  // Load pending reveals for this partner and update chat ID bar
  updateChatIdBar();
  $('chatPhrase').textContent=rel.phrase;
  closePlusMenu();hideTyping();
  const mc=$('chatMessages'),ti=$('typingIndicator');mc.innerHTML='';mc.appendChild(ti);
  loadQuickPhrases();
  try{(await(await fetch('/api/messages/'+rel.relationId)).json()).forEach(m=>{
    if(m.type==='ephemeral')appendEphemeral(m,true);
    else if(m.type==='photo')appendPhoto(m);
    else if(m.type==='reveal-request'||m.type==='reveal-accepted'||m.type==='reveal-declined')appendRevealChatCard(m);
    else appendMessage(m);
  })}catch(e){}
  // Load partner score + stars into subtitle
  try{
    const ps=await fetch('/api/partner-score/'+rel.relationId+'/'+state.userId).then(r=>r.json());
    if(ps.score!=null){
      $('partnerPtsNum').textContent=ps.score;
      const sub=$('chatSub');
      const extra=(ps.stars>0?' · ⭐'+ps.stars:'')+(ps.score>0?' · '+ps.score+'pts':'');
      if(pRealName&&pRealName!==pNick){
        sub.innerHTML='<span style="color:var(--ok)">✓ ID</span> · @'+esc(pNick)+extra;
      }else{
        sub.innerHTML='nickname'+extra;
      }
    }
  }catch(e){}
  // Load streak
  loadStreak();
  startChatTimer(rel.expiresAt);showScreen('chat');
  // Mark as read
  localStorage.setItem('lastRead_'+rel.relationId,Date.now().toString());
  requestAnimationFrame(()=>{mc.scrollTop=mc.scrollHeight;$('chatInput').focus()});
}
async function loadStreak(){
  if(!state.currentPartnerId)return;
  try{
    const s=await fetch('/api/streak/'+state.userId+'/'+state.currentPartnerId).then(r=>r.json());
    const el=$('chatStreak');
    if(s.currentStreak>0){
      el.classList.remove('hidden');
      // Show stars earned and progress to next
      let starsHtml='';
      for(let i=0;i<s.starsEarned;i++)starsHtml+='⭐';
      const daysInCycle=s.currentStreak%5;
      $('chatStreakText').innerHTML=starsHtml+(starsHtml?' · ':'')+'🔥 '+s.currentStreak+' dia'+(s.currentStreak>1?'s':'');
      $('chatStreakBar').style.width=(s.progress||0)+'%';
      if(s.daysToNextStar>0){
        $('chatStreakNext').textContent='Próxima ⭐ em '+s.daysToNextStar+' dia'+(s.daysToNextStar>1?'s':'');
      }else{
        $('chatStreakNext').textContent='⭐ Nova estrela!';
      }
    }else el.classList.add('hidden');
  }catch(e){}
}
function appendMessage(msg){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');div.className='msg '+(msg.userId===state.userId?'mine':'theirs');
  const t=new Date(msg.timestamp);div.innerHTML=esc(msg.text)+'<div class="mt">'+pad(t.getHours())+':'+pad(t.getMinutes())+'</div>';
  mc.insertBefore(div,ti);if(near||msg.userId===state.userId)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
}
function sendMessage(){
  const input=$('chatInput'),text=input.value.trim();if(!text||!state.currentRelation)return;
  appendMessage({userId:state.userId,text,timestamp:Date.now()});playSound('send');haptic([30]);
  socket.emit('send-message',{relationId:state.currentRelation.relationId,userId:state.userId,text});
  input.value='';updateSendBtn();
}
function nearBot(){const el=$('chatMessages');return el.scrollHeight-el.scrollTop-el.clientHeight<80}
function startChatTimer(expiresAt){
  if(state.timerInterval)clearInterval(state.timerInterval);const el=$('chatTimer');
  let lastSec=-1;
  function tick(){
    const d=expiresAt-Date.now();
    if(d<=0){el.textContent='Expirado';el.classList.add('urg');clearInterval(state.timerInterval);showExpireCard();return}
    const sec=Math.floor(d/1000);
    el.textContent=pad(Math.floor(d/3600000))+':'+pad(Math.floor((d%3600000)/60000))+':'+pad(Math.floor((d%60000)/1000));
    el.classList.toggle('urg',d<3600000);
    // Pulse animation on second change
    if(sec!==lastSec){lastSec=sec;el.style.transform='scale(1.08)';setTimeout(()=>{el.style.transform='scale(1)'},150)}
  }
  tick();state.timerInterval=setInterval(tick,1000);
}

// ═══ HOROSCOPE ═══
async function getHoroscope(){
  if(!state.currentRelation)return;
  try{
    const r=await fetch('/api/horoscope/'+state.currentRelation.relationId+'/'+state.userId);
    const d=await r.json();
    if(d.error)return showToast(d.error);
    // Show as system message in chat
    const text='✨ '+d.phrase;
    appendMessage({userId:'system',text,timestamp:Date.now()});
    // Also emit so partner sees it
    socket.emit('send-message',{relationId:state.currentRelation.relationId,userId:'system',text});
    haptic([30,20,30]);
  }catch(e){showToast('Erro ao consultar astros.')}
}

// ═══ PULSE ═══
function sendPulse(){
  if(!state.currentRelation||pulseSent)return;
  socket.emit('pulse',{relationId:state.currentRelation.relationId,userId:state.userId});
  pulseSent=true;const pb=$('pulseBtn');if(pb)pb.style.opacity='.35';
  // Heartbeat vibration: lub-dub, lub-dub, lub-dub
  haptic([120,60,80,300,120,60,80,300,120,60,80]);
  showToast('Pulso enviado');
}

// ═══ SELFIE ═══
function requestSelfie(){
  if(!state.currentRelation)return;
  const input=document.createElement('input');input.type='file';input.accept='image/*';input.capture='user';
  input.onchange=async()=>{
    const file=input.files[0];if(!file)return;
    const c=document.createElement('canvas'),ctx=c.getContext('2d'),img=new Image();
    img.onload=async()=>{
      c.width=400;c.height=400;const sc=Math.max(400/img.width,400/img.height);
      ctx.drawImage(img,(400-img.width*sc)/2,(400-img.height*sc)/2,img.width*sc,img.height*sc);
      const data=c.toDataURL('image/jpeg',.6);
      await fetch('/api/selfie/'+state.currentRelation.relationId,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,selfieData:data})});
      showToast('Selfie enviada!');
    };img.src=URL.createObjectURL(file);
  };input.click();
}

// ═══ TYPING ═══
function handleTyping(){if(!state.currentRelation||!socket)return;const now=Date.now();if(now-lastTypingEmit>2000){socket.emit('typing',{relationId:state.currentRelation.relationId,userId:state.userId});lastTypingEmit=now}}
function showTyping(){$('typingIndicator').classList.add('vis');if(nearBot())$('chatMessages').scrollTo({top:99999,behavior:'smooth'});clearTimeout(typingTimeout);typingTimeout=setTimeout(hideTyping,3000)}
function hideTyping(){$('typingIndicator').classList.remove('vis')}

// ═══ QUICK PHRASES (EPHEMERAL) ═══
const QUICK_PHRASES=['Observei','Gostei','Algo ficou','Curioso','Queria te ver','Sem pressa','Sorrindo aqui','Pensando em ti'];
function loadQuickPhrases(){
  const bar=$('quickPhrases');if(!bar)return;bar.innerHTML='';
  QUICK_PHRASES.forEach(p=>{
    const chip=document.createElement('button');chip.className='qp-chip';chip.type='button';chip.textContent=p;
    chip.onclick=()=>{sendEphemeral(p);chip.classList.add('sent')};
    bar.appendChild(chip);
  });
}
function sendEphemeral(text){
  if(!state.currentRelation)return;
  const msg={userId:state.userId,text,type:'ephemeral',timestamp:Date.now()};
  appendEphemeral(msg);haptic([40,20,40]);
  socket.emit('send-ephemeral',{relationId:state.currentRelation.relationId,userId:state.userId,text});
}
function appendEphemeral(msg,fromHistory){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');
  div.className='msg ephemeral'+(msg.userId===state.userId?' mine':'');
  div.innerHTML=esc(msg.text)+'<span class="eph-badge">efêmera</span>';
  mc.insertBefore(div,ti);
  if(near||msg.userId===state.userId)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
  // Only auto-fade on real-time receive, not from history
  if(!fromHistory){
    setTimeout(()=>{div.style.transition='opacity .6s,transform .6s';div.style.opacity='0';div.style.transform='scale(.95)';setTimeout(()=>div.remove(),700)},8000);
  }
}

// ═══ PHOTO / FILE IN CHAT ═══
function pickPhoto(){
  closePlusMenu();if(!state.currentRelation)return;
  const input=document.createElement('input');input.type='file';input.accept='image/*';
  input.onchange=()=>{const file=input.files[0];if(file)processAndSendPhoto(file)};
  input.click();
}
function pickFile(){
  closePlusMenu();if(!state.currentRelation)return;
  const input=document.createElement('input');input.type='file';input.accept='image/*,.pdf,.doc,.docx,.txt';
  input.onchange=()=>{
    const file=input.files[0];if(!file)return;
    if(file.type.startsWith('image/'))processAndSendPhoto(file);
    else{showToast('Enviado: '+file.name);haptic([30])}
  };input.click();
}
function processAndSendPhoto(file){
  const reader=new FileReader();
  reader.onload=()=>{
    const img=new Image();img.onload=()=>{
      const c=document.createElement('canvas'),ctx=c.getContext('2d');
      const maxW=600,sc=Math.min(maxW/img.width,maxW/img.height,1);
      c.width=img.width*sc;c.height=img.height*sc;
      ctx.drawImage(img,0,0,c.width,c.height);
      const dataUrl=c.toDataURL('image/jpeg',.7);
      const msg={userId:state.userId,type:'photo',photoData:dataUrl,timestamp:Date.now()};
      appendPhoto(msg);haptic([30]);
      socket.emit('send-photo',{relationId:state.currentRelation.relationId,userId:state.userId,photoData:dataUrl});
    };img.src=reader.result;
  };reader.readAsDataURL(file);
}
function appendPhoto(msg){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');div.className='msg photo '+(msg.userId===state.userId?'mine':'theirs');
  const imgEl=document.createElement('img');imgEl.src=msg.photoData;imgEl.loading='lazy';
  imgEl.onclick=()=>{window.open(msg.photoData,'_blank')};
  div.appendChild(imgEl);
  const t=new Date(msg.timestamp);const tm=document.createElement('div');tm.className='mt';
  tm.textContent=pad(t.getHours())+':'+pad(t.getMinutes());div.appendChild(tm);
  mc.insertBefore(div,ti);
  if(near||msg.userId===state.userId)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
}

// ═══ PLUS MENU ═══
function togglePlusMenu(){const m=$('plusMenu');m.classList.toggle('open')}
function closePlusMenu(){const m=$('plusMenu');if(m)m.classList.remove('open')}

// ═══ STREAK UNLOCK ═══
function showStreakUnlock(data){
  const overlay=document.createElement('div');overlay.className='streak-unlock-overlay';
  const starsTotal=data.starsTotal||1;
  let starsHtml='';for(let i=0;i<starsTotal;i++)starsHtml+='⭐';
  overlay.innerHTML='<div class="streak-unlock-card"><div class="su-emoji">'+starsHtml+'</div><div class="su-title">'+data.streakDays+' dias juntos!</div><div class="su-desc">'+esc(data.unlock.description)+'</div><button class="bp" style="max-width:200px;margin:0 auto" onclick="this.closest(\'.streak-unlock-overlay\').remove()">Incrível!</button></div>';
  document.body.appendChild(overlay);
  haptic([100,50,100,50,100]);playSound('connect');
}

// ═══ TOUCH LINK ═══
let touchLinkData=null;
async function loadTouchLink(){
  try{
    const r=await fetch('/api/touch-link/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
    const d=await r.json();if(d.url){touchLinkData=d;$('touchLinkUrl').textContent=d.url}
  }catch(e){$('touchLinkUrl').textContent='Erro ao gerar link'}
}
function copyTouchLink(){
  if(!touchLinkData)return;
  navigator.clipboard.writeText(touchLinkData.url).then(()=>showToast('Link copiado!')).catch(()=>{
    const ta=document.createElement('textarea');ta.value=touchLinkData.url;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();showToast('Link copiado!');
  });
}
function showTouchQR(){
  const area=$('touchQRArea');
  if(area.style.display!=='none'){area.style.display='none';return}
  area.style.display='block';area.innerHTML='';
  if(touchLinkData&&typeof QRCode!=='undefined'){new QRCode(area,{text:touchLinkData.url,width:160,height:160,colorDark:'#ff6b35',colorLight:'#0a0a10'})}
}

// ═══ RELATIONS ═══
async function refreshRelations(){
  if(!state.userId)return;
  try{
    const rels=await(await fetch('/api/relations/'+state.userId)).json();
    state._cachedRels=rels; // cache for showRelations
    const badge=$('relBadge'),count=$('relCount');
    if(rels.length>0){
      badge.classList.remove('hidden');
      // Count unread from server data (fast, no extra fetches)
      let unread=0;
      for(const r of rels){
        if(r.lastMessageUserId&&r.lastMessageUserId!==state.userId){
          const lastRead=parseInt(localStorage.getItem('lastRead_'+r.id)||'0');
          if(r.lastMessageTime>lastRead)unread++;
        }
      }
      count.textContent=unread>0?unread:rels.length;
      if(unread>0){badge.style.background='rgba(255,107,53,.15)';badge.style.borderColor='var(--ac)'}
      else{badge.style.background='rgba(255,255,255,.04)';badge.style.borderColor='rgba(255,255,255,.06)'}
    }else badge.classList.add('hidden');
  }catch(e){}
}
async function showRelations(){
  haptic([30]);
  try{
    const rels=await(await fetch('/api/relations/'+state.userId)).json();const list=$('relationsList');
    if(!rels.length){list.innerHTML='<div class="nr"><div class="nr-icon">✦</div>Nenhuma conexão ativa.<div class="nr-text">Encoste em alguém para criar algo que só existe aqui.</div></div>'}
    else{
      const sub=$('relSubtitle');if(sub)sub.textContent=rels.length+' conex'+(rels.length===1?'ão':'ões');
      list.innerHTML='';rels.forEach((r,idx)=>{
      const h=Math.floor(r.timeLeft/3600000),m=Math.floor((r.timeLeft%3600000)/60000);
      let tc='ok';if(r.timeLeft<3600000)tc='low';else if(r.timeLeft<43200000)tc='med';
      const card=document.createElement('div');card.className='rc';card.style.animationDelay=(idx*0.06)+'s';card.style.animation='mi .35s ease '+(idx*0.06)+'s both';
      const isEventRel=!!(r.isEvent||r.eventId);
      const pColor=isEventRel?'#60a5fa':(r.partnerColor||nickColor(r.partnerName||'??'));
      const timeLabel=tc==='low'?'expirando':'restante';
      let displayName,nameHtml,photoHtml;
      if(isEventRel){
        // Event relation: show event icon and name
        displayName=r.eventName||r.partnerName||'Evento';
        photoHtml='<div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;box-shadow:0 0 12px rgba(96,165,250,.2)">📍</div>';
        nameHtml='<div class="rn" style="color:#60a5fa">'+esc(displayName)+'</div><div style="font-size:.6rem;color:var(--t3);margin-top:.1rem">evento</div>';
      }else{
        displayName=r.partnerRealName||r.partnerName;
        const isRevealed=r.partnerRealName&&r.partnerRealName!==r.partnerName;
        const pVerified=!!r.partnerVerified;
        let pAvInner=r.partnerPhoto?'<div style="width:48px;height:48px;border-radius:50%;overflow:hidden;flex-shrink:0;border:1.5px solid rgba(255,255,255,.12)"><img src="'+r.partnerPhoto+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>':makeAvatar(r.partnerName,pColor,48);
        photoHtml=pVerified?'<div class="verified-wrap">'+pAvInner+verifiedBadge()+'</div>':pAvInner;
        nameHtml='<div class="rn">'+esc(displayName)+(pVerified?' <span style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:.6rem;font-weight:800">✓</span>':'')+(isRevealed?' <span style="font-size:.55rem;color:var(--ok)">✓ ID</span>':'')+'</div>'+(isRevealed?'<div style="font-size:.6rem;color:var(--t3);margin-top:.1rem">@'+esc(r.partnerName)+'</div>':'');
      }
      // Unread count for this relation
      const lastRead=parseInt(localStorage.getItem('lastRead_'+r.id)||'0');
      const unreadCount=(r.lastMessageTime&&r.lastMessageUserId&&r.lastMessageUserId!==state.userId&&r.lastMessageTime>lastRead)?1:0;
      // Preview text
      const previewHtml=r.lastMessagePreview?'<div class="rp-preview">'+esc(r.lastMessagePreview)+'</div>':'<div class="rp">"'+esc(r.phrase)+'"</div>';
      const unreadBadge=unreadCount>0?'<div class="rc-unread"></div>':'';
      card.innerHTML=photoHtml+'<div class="ri">'+nameHtml+previewHtml+'</div><div class="rtm-wrap">'+unreadBadge+'<div class="rtm '+tc+'">'+h+'h '+m+'m</div><div class="rtm-label">'+timeLabel+'</div></div>';
      if(isEventRel){card.style.borderColor='rgba(96,165,250,.15)'}
      const rpid=r.userA===state.userId?r.userB:r.userA;
      card.addEventListener('click',()=>openChat({relationId:r.id,phrase:r.phrase,expiresAt:r.expiresAt,partnerName:isEventRel?(r.eventName||r.partnerName):r.partnerName,partnerId:rpid,isEvent:isEventRel,eventId:r.eventId,eventName:r.eventName,iRevealedToPartner:r.iRevealedToPartner,partnerRevealedToMe:r.partnerRevealedToMe,userA:{id:r.userA,nickname:r.userA===state.userId?state.userName:r.partnerName,realName:r.userA===state.userId?null:r.partnerRealName},userB:{id:r.userB,nickname:r.userB===state.userId?state.userName:r.partnerName,realName:r.userB===state.userId?null:r.partnerRealName}}));
      list.appendChild(card);
    })}
    showScreen('relations');
  }catch(e){showToast('Erro ao carregar.')}
}

// ═══ CONSTELLATION ═══
let constFilter='all'; // 'all','revealed','anon','events'
function setConstFilter(f){
  constFilter=f;
  const btns=['constFilterAll','constFilterRevealed','constFilterAnon','constFilterEvents'];
  const activeColors={all:['rgba(99,102,241,.15)','rgba(99,102,241,.3)','#a78bfa'],revealed:['rgba(0,220,130,.12)','rgba(0,220,130,.3)','#00dc82'],anon:['rgba(255,68,102,.12)','rgba(255,68,102,.3)','#ff4466'],events:['rgba(96,165,250,.12)','rgba(96,165,250,.3)','#60a5fa']};
  btns.forEach(id=>{
    const el=$(id);if(!el)return;
    const key=id.replace('constFilter','').toLowerCase();
    if(key===f){const c=activeColors[f]||activeColors.all;el.style.background=c[0];el.style.borderColor=c[1];el.style.color=c[2]}
    else{el.style.background='rgba(255,255,255,.04)';el.style.borderColor='rgba(255,255,255,.08)';el.style.color='var(--t3)'}
  });
}
let constState={nodes:[],cam:{x:0,y:0,zoom:1},dragging:false,lastTouch:null,animFrame:null,selectedNode:null,
  fpMode:false,fpTransition:0,fpYaw:0,fpPitch:0};
const CONST_FEEDBACK=['Um novo ponto surgiu.','Sua rede cresceu hoje.','Um encontro deixou rastro.','Um elo foi reforçado.','Algo ficou marcado.','A constelação se expandiu.'];

async function showHistory(){
  haptic([30]);
  updateNotifBadge();
  try{
    const data=await(await fetch('/api/constellation/'+state.userId)).json();
    const empty=$('constEmpty');
    if(!data.nodes||!data.nodes.length){empty.classList.remove('hidden');constState.nodes=[];showScreen('history');requestAnimationFrame(()=>requestAnimationFrame(()=>initConstCanvas()));return}
    empty.classList.add('hidden');
    // Load pending reveal requests for constellation state
    try{
      const pendingReveals=await(await fetch('/api/identity/pending/'+state.userId)).json();
      if(!state.pendingReveals)state.pendingReveals={};
      pendingReveals.forEach(pr=>{
        const partnerId=pr.fromUserId===state.userId?pr.toUserId:pr.fromUserId;
        state.pendingReveals[partnerId]=pr.direction;
        // Also update node data
        const nd=data.nodes.find(n=>n.id===partnerId);
        if(nd)nd.pendingReveal=pr.direction;
      });
    }catch(e){}
    // Layout nodes in 3D space — wide spread + z-depth by time
    const now=Date.now();
    const nodeCount=data.nodes.length;
    // Fewer nodes → more spread so they don't cluster
    const fewBonus=nodeCount<6?(6-nodeCount)*32:0;
    const nodes=data.nodes.map((n,i)=>{
      const angle=(i/nodeCount)*Math.PI*2-Math.PI/2;
      const lastMs=n.lastDate?now-new Date(n.lastDate).getTime():999999999;
      const hrs=lastMs/3600000;
      let zDepth;
      // Active connections and recent encounters are closest
      if(n.hasActiveRelation)zDepth=20+Math.random()*20;       // active → very close
      else if(hrs<1)zDepth=48+Math.random()*28;                // <1h → close
      else if(hrs<6)zDepth=80+Math.random()*40;                // <6h → medium-close
      else if(hrs<12)zDepth=130+Math.random()*50;              // <12h → medium
      else if(hrs<24)zDepth=200+Math.random()*60;              // <24h → medium-far
      else if(hrs<72)zDepth=280+Math.random()*70;              // <3d → far
      else zDepth=360+Math.min(200,hrs*0.8)+Math.random()*50;  // >3d → very far
      // More encounters = slightly closer bonus
      zDepth=Math.max(10,zDepth-Math.min(40,Math.log2(1+(n.encounters||1))*12));
      // XY spread — 20% reduced, scales with depth + bonus for few nodes
      const spread=128+fewBonus+zDepth*0.56+(Math.random()-.5)*48;
      // Size: smaller=newer, bigger=longer relationship (by time since first encounter)
      const ageMs=n.firstDate?now-new Date(n.firstDate).getTime():(n.lastDate?now-new Date(n.lastDate).getTime():0);
      const ageDays=ageMs/86400000;
      const sizeByAge=Math.min(22,6+Math.log2(1+ageDays)*4+Math.log2(1+(n.encounters||1))*2);
      return{...n,
        x3d:Math.cos(angle)*spread+(Math.random()-.5)*50,
        y3d:Math.sin(angle)*spread+(Math.random()-.5)*50,
        z3d:zDepth,
        color:n.color||nickColor(n.nickname||'?'),baseRadius:sizeByAge,pulsePhase:Math.random()*Math.PI*2};
    });
    // Pre-load images ONLY for revealed users (canSee)
    const myCanSee=state.revealedIds||{};
    nodes.forEach(n=>{
      const revealed=!!(n.partnerRevealedToMe||myCanSee[n.id]);
      if(revealed&&n.profilePhoto){
        const img=new Image();
        img.crossOrigin='anonymous';
        img.src=n.profilePhoto;
        n._img=img;n._imgLoaded=false;n._revealed=true;
        img.onload=()=>{n._imgLoaded=true};
      }else{
        n._img=null;n._imgLoaded=false;n._revealed=false;
      }
    });
    constState.nodes=nodes;
    constState.cam={x:0,y:0,zoom:0.15};
    constState._entryAnim={active:true,startTime:Date.now(),duration:900};
    constState.selectedNode=null;
    // Pre-load user's own photo for center node
    if(state.userPhoto&&!constState._myImgLoaded){
      const mi=new Image();mi.crossOrigin='anonymous';mi.src=state.userPhoto;
      constState._myImg=mi;constState._myImgLoaded=false;
      mi.onload=()=>{constState._myImgLoaded=true};
    }
    hideConstDetail();
    showScreen('history');
    // Wait for screen to become visible before measuring canvas
    requestAnimationFrame(()=>requestAnimationFrame(()=>initConstCanvas()));
    // Show feedback if new nodes since last visit
    const prevCount=parseInt(localStorage.getItem('touch_const_count')||'0');
    if(data.total>prevCount&&prevCount>0){
      const fb=$('constFeedback');
      fb.textContent=CONST_FEEDBACK[Math.floor(Math.random()*CONST_FEEDBACK.length)];
      fb.classList.add('show');
      setTimeout(()=>fb.classList.remove('show'),3500);
    }
    localStorage.setItem('touch_const_count',String(data.total));
  }catch(e){showToast('Erro ao carregar.')}
}

function initConstCanvas(){
  const canvas=$('constCanvas');if(!canvas)return;
  const wrap=canvas.parentElement;
  const dpr=window.devicePixelRatio||1;
  canvas.width=wrap.clientWidth*dpr;
  canvas.height=wrap.clientHeight*dpr;
  canvas.style.width=wrap.clientWidth+'px';
  canvas.style.height=wrap.clientHeight+'px';
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  const W=wrap.clientWidth,H=wrap.clientHeight;

  // ── 3D Perspective parameters ──
  const FOV=300; // field of view — higher = less extreme perspective

  // ── Accelerometer tilt ──
  let tiltX=0,tiltY=0,rawTX=0,rawTY=0;
  function onDevOri(e){
    rawTX=(e.gamma||0)/25;rawTY=(e.beta||0)/25;
  }
  if(window.DeviceOrientationEvent){
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
      DeviceOrientationEvent.requestPermission().then(p=>{if(p==='granted')window.addEventListener('deviceorientation',onDevOri)}).catch(()=>{});
    }else{window.addEventListener('deviceorientation',onDevOri)}
  }
  constState._cleanGyro=()=>{window.removeEventListener('deviceorientation',onDevOri)};

  // ── Touch: 1 finger drag, 2 finger pinch+pan ──
  let pinchDist=0,pinchZoom=1,pointerStart=null,touches2Start=null;
  canvas.onpointerdown=e=>{
    constState.dragging=true;constState.lastTouch={x:e.clientX,y:e.clientY};pointerStart={x:e.clientX,y:e.clientY};
  };
  canvas.onpointermove=e=>{
    if(!constState.dragging||!constState.lastTouch)return;
    if(constState.fpMode)return; // FP mode: only accelerometer, no drag
    const dx=e.clientX-constState.lastTouch.x,dy=e.clientY-constState.lastTouch.y;
    constState.cam.x+=dx/constState.cam.zoom;constState.cam.y+=dy/constState.cam.zoom;
    constState.lastTouch={x:e.clientX,y:e.clientY};
  };
  canvas.onpointerup=e=>{
    if(constState.dragging&&pointerStart){
      const tapThresh=12;
      if(Math.abs(e.clientX-pointerStart.x)<tapThresh&&Math.abs(e.clientY-pointerStart.y)<tapThresh)
        handleConstTap(e.clientX-canvas.getBoundingClientRect().left,e.clientY-canvas.getBoundingClientRect().top,W,H);
    }
    constState.dragging=false;constState.lastTouch=null;pointerStart=null;
  };
  canvas.ontouchstart=e=>{
    if(e.touches.length===2){
      pinchDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      pinchZoom=constState.cam.zoom;
      touches2Start={mx:(e.touches[0].clientX+e.touches[1].clientX)/2,my:(e.touches[0].clientY+e.touches[1].clientY)/2,cx:constState.cam.x,cy:constState.cam.y};
    }
  };
  canvas.ontouchmove=e=>{
    if(e.touches.length===2){
      e.preventDefault();
      const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      constState.cam.zoom=Math.max(.08,Math.min(50,pinchZoom*(d/pinchDist)));
      if(touches2Start){
        const mx=(e.touches[0].clientX+e.touches[1].clientX)/2,my=(e.touches[0].clientY+e.touches[1].clientY)/2;
        constState.cam.x=touches2Start.cx+(mx-touches2Start.mx)/constState.cam.zoom;
        constState.cam.y=touches2Start.cy+(my-touches2Start.my)/constState.cam.zoom;
      }
    }
  };
  canvas.onwheel=e=>{e.preventDefault();constState.cam.zoom=Math.max(.08,Math.min(50,constState.cam.zoom*(e.deltaY>0?.9:1.1)))};

  // ── Particles system ──
  const particles=Array.from({length:120},()=>({
    x:(Math.random()-.5)*W*2,y:(Math.random()-.5)*H*2,
    vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,
    r:Math.random()*.8+.2,a:Math.random()*.15+.03,
    phase:Math.random()*Math.PI*2
  }));

  // ── Grid lines (subtle tech background) ──
  const gridSpacing=60;

  // ── Helper: project 3D to 2D with perspective ──
  function project(x3d,y3d,z3d,camX,camY,zoom,tOX,tOY){
    const wx=(x3d+camX+tOX)*zoom;
    const wy=(y3d+camY+tOY)*zoom;
    const scale=FOV/(FOV+z3d);
    return{
      sx:W/2+wx*scale,
      sy:H*0.45+wy*scale,
      scale:scale*zoom,
      z3d:z3d
    };
  }

  // ── Helper: draw image with center-crop (no stretching) ──
  function drawCroppedImage(img,cx,cy,r){
    const iw=img.naturalWidth||img.width;
    const ih=img.naturalHeight||img.height;
    if(!iw||!ih)return;
    // Compute center square crop from source
    const side=Math.min(iw,ih);
    const sx=(iw-side)/2;
    const sy=(ih-side)/2;
    ctx.save();
    ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.clip();
    ctx.drawImage(img,sx,sy,side,side,cx-r,cy-r,r*2,r*2);
    ctx.restore();
  }

  if(constState.animFrame)cancelAnimationFrame(constState.animFrame);

  // FP mode transition smoothing
  let fpBlend=0; // 0=normal, 1=full FP

  function draw(){
    constState.animFrame=requestAnimationFrame(draw);
    ctx.clearRect(0,0,W,H);
    const t=Date.now()/1000;
    // ── Entry animation — zoom from far to normal ──
    if(constState._entryAnim&&constState._entryAnim.active){
      const ea=constState._entryAnim;
      const elapsed=Date.now()-ea.startTime;
      const progress=Math.min(1,elapsed/ea.duration);
      // Ease out cubic: quick start, smooth landing
      const ease=1-Math.pow(1-progress,3);
      // Zoom: 0.15 → 1.12 → 1.0 (slight overshoot)
      const overshoot=progress<0.7?0:Math.sin((progress-0.7)/0.3*Math.PI)*0.12;
      constState.cam.zoom=0.15+(1-0.15)*ease+overshoot*(1-Math.pow(Math.max(0,(progress-0.85)/0.15),2));
      if(progress>=1){constState._entryAnim.active=false;constState.cam.zoom=1}
    }
    // Lerp tilt
    tiltX+=(rawTX-tiltX)*0.08;tiltY+=(rawTY-tiltY)*0.08;

    // ── FP transition blend ──
    const fpTarget=constState.fpMode?1:0;
    fpBlend+=(fpTarget-fpBlend)*0.06; // smooth ~16 frames
    if(Math.abs(fpBlend-fpTarget)<0.005)fpBlend=fpTarget;
    const isFP=fpBlend>0.01;

    const z=constState.cam.zoom;
    // Tilt scales with zoom — more zoom = more parallax movement
    const tiltMul=Math.min(3,1+Math.log2(Math.max(1,z))*0.6);
    const tiltOffX=tiltX*40*tiltMul*(1-fpBlend);
    const tiltOffY=tiltY*28*tiltMul*(1-fpBlend);

    // ── Subtle hex grid ──
    const gridAlpha=0.03*(1-fpBlend*0.7);
    ctx.save();ctx.globalAlpha=gridAlpha;ctx.strokeStyle='#4488ff';ctx.lineWidth=.5;
    for(let gx=-gridSpacing;gx<W+gridSpacing;gx+=gridSpacing){
      const ox=gx+tiltOffX*.3+(constState.cam.x*z*.1)%gridSpacing;
      ctx.beginPath();ctx.moveTo(ox,0);ctx.lineTo(ox,H);ctx.stroke();
    }
    for(let gy=-gridSpacing;gy<H+gridSpacing;gy+=gridSpacing){
      const oy=gy+tiltOffY*.3+(constState.cam.y*z*.1)%gridSpacing;
      ctx.beginPath();ctx.moveTo(0,oy);ctx.lineTo(W,oy);ctx.stroke();
    }
    ctx.restore();

    // ── Floating particles ──
    particles.forEach(p=>{
      p.x+=p.vx;p.y+=p.vy;
      if(p.x<-W)p.x=W;if(p.x>W)p.x=-W;if(p.y<-H)p.y=H;if(p.y>H)p.y=-H;
      const sx=W/2+p.x+tiltOffX*(.5+p.r);const sy=H/2+p.y+tiltOffY*(.5+p.r);
      const flicker=p.a+Math.sin(t*2+p.phase)*.02;
      ctx.beginPath();ctx.arc(sx,sy,p.r,0,Math.PI*2);
      ctx.fillStyle='rgba(100,160,255,'+flicker.toFixed(3)+')';ctx.fill();
    });

    if(!constState.nodes.length)return;
    const camX=constState.cam.x+tiltOffX;
    const camY=constState.cam.y+tiltOffY;

    // ── FP mode: accelerometer-only look direction ──
    let fpYaw=0,fpPitch=0;
    if(isFP){
      // Accelerometer directly drives look direction — wide range
      fpYaw=tiltX*2.0;   // gamma tilt → horizontal look
      fpPitch=tiltY*1.4;  // beta tilt → vertical look
    }
    const cosY=Math.cos(fpYaw),sinY=Math.sin(fpYaw);
    const cosP=Math.cos(fpPitch),sinP=Math.sin(fpPitch);

    // ── Project nodes ──
    // Normal: 3D from outside. FP: center at bottom, nodes fan out upward/sides
    const meProj=project(0,0,0,camX,camY,z,0,0);
    // Blend center position: normal center → bottom-center for FP
    const fpCenterX=W/2;
    const fpCenterY=H*0.88; // center node goes to bottom
    const mcx=meProj.sx*(1-fpBlend)+fpCenterX*fpBlend;
    const mcy=meProj.sy*(1-fpBlend)+fpCenterY*fpBlend;
    constState._mcx=mcx;constState._mcy=mcy;

    const FP_FOV=180; // wider FOV for immersive fan-out
    // Filter nodes by constellation filter
    const filteredNodes=constState.nodes.filter(n=>{
      if(constFilter==='events')return !!n.isEvent;
      if(constFilter==='revealed'){
        const isRevealed=!!(n.partnerRevealedToMe||(state.revealedIds&&state.revealedIds[n.id]));
        return !n.isEvent&&isRevealed;
      }
      if(constFilter==='anon'){
        const isRevealed=!!(n.partnerRevealedToMe||(state.revealedIds&&state.revealedIds[n.id]));
        return !n.isEvent&&!isRevealed;
      }
      return !n.isEvent; // 'all' = all people (no events)
    });
    const projected=filteredNodes.map(n=>{
      if(fpBlend<0.01){
        // Pure normal mode
        const p=project(n.x3d,n.y3d,n.z3d,camX,camY,z,0,0);
        n._px=p.sx;n._py=p.sy;n._pscale=p.scale;
        return{n,sx:p.sx,sy:p.sy,scale:p.scale,z3d:p.z3d};
      }
      // FP: fan-out from bottom center
      // Use accelerometer to rotate the 3D space around viewer
      const rx=n.x3d*cosY-n.z3d*sinY;
      const rz=n.x3d*sinY+n.z3d*cosY;
      const ry=n.y3d*cosP-rz*sinP;
      const rz2=n.y3d*sinP+rz*cosP;
      // All nodes visible — behind wraps to far
      const fpZ=rz2<5?300+Math.abs(rz2)*5:rz2;
      const fpScale=FP_FOV/fpZ;
      // Fan outward: X spreads horizontally, Y goes UPWARD from bottom
      const fpSx=fpCenterX+rx*fpScale;
      const fpSy=fpCenterY-(Math.abs(ry)+rz2*0.4)*fpScale; // push upward
      // Blend between normal and FP
      const normalP=project(n.x3d,n.y3d,n.z3d,camX,camY,z,0,0);
      const bx=normalP.sx*(1-fpBlend)+fpSx*fpBlend;
      const by=normalP.sy*(1-fpBlend)+fpSy*fpBlend;
      const bs=normalP.scale*(1-fpBlend)+fpScale*fpBlend;
      const bz=n.z3d*(1-fpBlend)+fpZ*fpBlend;
      n._px=bx;n._py=by;n._pscale=bs;
      return{n,sx:bx,sy:by,scale:bs,z3d:bz};
    });
    projected.sort((a,b)=>b.z3d-a.z3d);

    // ── Draw connections — solid LED-glow lines (thickness capped) ──
    const MAX_LINE=3; // max pixel thickness for LED core
    projected.forEach(({n,sx,sy,scale})=>{
      const lineBothVerified=!!(n.partnerRevealedToMe&&n.iRevealedToPartner)||(!!((n.realName&&n.realName!==n.nickname)&&(n.iRevealedToPartner||(state.revealedIds&&state.revealedIds[n.id]&&state.revealedIds[n.id]._iRevealed))));
      const lineColor=lineBothVerified?'0,220,130':'100,140,255';
      const depthAlpha=Math.max(0.03,scale*0.8);
      const rawThick=(0.3+Math.log2(1+(n.encounters||1))*0.4)*scale;
      const thick=Math.min(rawThick,MAX_LINE);
      const lineAlpha=depthAlpha*(0.1+n.intensity*.2);
      ctx.save();
      // Outer glow layer (wide, soft)
      ctx.beginPath();ctx.moveTo(mcx,mcy);ctx.lineTo(sx,sy);
      ctx.strokeStyle='rgba('+lineColor+','+(lineAlpha*0.3).toFixed(3)+')';
      ctx.lineWidth=Math.min(thick*4,10);ctx.stroke();
      // Mid glow
      ctx.beginPath();ctx.moveTo(mcx,mcy);ctx.lineTo(sx,sy);
      ctx.strokeStyle='rgba('+lineColor+','+(lineAlpha*0.6).toFixed(3)+')';
      ctx.lineWidth=Math.min(thick*2,6);ctx.stroke();
      // Core bright line (LED center)
      ctx.beginPath();ctx.moveTo(mcx,mcy);ctx.lineTo(sx,sy);
      ctx.strokeStyle='rgba('+lineColor+','+(lineAlpha*1.2).toFixed(3)+')';
      ctx.lineWidth=Math.min(thick*0.8,MAX_LINE);ctx.stroke();
      // Traveling energy pulse
      const pulsePos=(t*0.4+n.pulsePhase)%1;
      const px=mcx+(sx-mcx)*pulsePos,py=mcy+(sy-mcy)*pulsePos;
      const pSize=Math.max(2,Math.min(8,6*scale));
      const pg=ctx.createRadialGradient(px,py,0,px,py,pSize);
      pg.addColorStop(0,'rgba('+lineColor+','+(depthAlpha*0.7).toFixed(3)+')');
      pg.addColorStop(0.4,'rgba('+lineColor+','+(depthAlpha*0.3).toFixed(3)+')');
      pg.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(px,py,pSize,0,Math.PI*2);ctx.fillStyle=pg;ctx.fill();
      ctx.restore();
    });

    // ── Draw nodes back-to-front ──
    const MAX_NODE_R=28; // fixed max pixel size — zoom only spreads nodes apart
    projected.forEach(({n,sx,sy,scale,z3d})=>{
      const pulse=1+Math.sin(t*1.5+n.pulsePhase)*.06;
      const rawR=n.baseRadius*scale*pulse;
      const r=Math.min(rawR,MAX_NODE_R);
      if(r<0.5)return; // too small to see
      const theyRevealedToMe=!!(n.partnerRevealedToMe||(state.revealedIds&&state.revealedIds[n.id]));
      const ringColor=n.isEvent?'#60a5fa':(theyRevealedToMe?'#00dc82':'#ff4466');
      const glowRGB=n.isEvent?'96,165,250':(theyRevealedToMe?'0,220,130':'255,68,102');
      // Depth-based opacity: close nodes=bright, far nodes=dim
      const depthAlpha=Math.max(0.15,Math.min(1,scale*1.2));

      // Outer glow (capped)
      const glowR=Math.min(r*3,50);
      ctx.save();ctx.globalAlpha=depthAlpha;
      const glow=ctx.createRadialGradient(sx,sy,0,sx,sy,glowR);
      glow.addColorStop(0,'rgba('+glowRGB+','+(0.06+n.intensity*.1).toFixed(2)+')');glow.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(sx,sy,glowR,0,Math.PI*2);ctx.fillStyle=glow;ctx.fill();

      // Node body: event icon, photo if revealed, or initials
      if(n.isEvent){
        // Event node: blue gradient with pin icon
        ctx.beginPath();ctx.arc(sx,sy,r,0,Math.PI*2);
        const evGrad=ctx.createRadialGradient(sx-r*.3,sy-r*.3,0,sx,sy,r);
        evGrad.addColorStop(0,'rgba(96,165,250,0.7)');evGrad.addColorStop(1,'rgba(59,130,246,0.3)');
        ctx.fillStyle=evGrad;ctx.fill();
        if(r>5){
          ctx.fillStyle='rgba(255,255,255,'+(depthAlpha*0.85).toFixed(2)+')';
          ctx.font=Math.max(6,Math.min(14,r*0.9))+'px sans-serif';
          ctx.textAlign='center';ctx.textBaseline='middle';
          ctx.fillText('📍',sx,sy);
        }
      }else if(n._revealed&&n._imgLoaded&&n._img&&r>4){
        drawCroppedImage(n._img,sx,sy,r);
      }else{
        ctx.beginPath();ctx.arc(sx,sy,r,0,Math.PI*2);
        const nGrad=ctx.createRadialGradient(sx-r*.3,sy-r*.3,0,sx,sy,r);
        nGrad.addColorStop(0,'rgba('+glowRGB+',0.6)');nGrad.addColorStop(1,'rgba('+glowRGB+',0.2)');
        ctx.fillStyle=nGrad;ctx.fill();
        // Draw initials (2 letters of nickname)
        if(r>5){
          const ini=(n.nickname||'??').slice(0,2).toUpperCase();
          ctx.fillStyle='rgba(255,255,255,'+(depthAlpha*0.8).toFixed(2)+')';
          ctx.font='bold '+Math.max(5,Math.min(10,r*0.7))+'px Inter,sans-serif';
          ctx.textAlign='center';ctx.textBaseline='middle';
          ctx.fillText(ini,sx,sy);
        }
      }

      // Ring: GREEN = verified, RED = anonymous
      ctx.beginPath();ctx.arc(sx,sy,r+1,0,Math.PI*2);
      ctx.strokeStyle=ringColor;ctx.lineWidth=Math.max(0.3,Math.min(1,0.8*scale));
      ctx.shadowColor=ringColor;ctx.shadowBlur=Math.max(1,Math.min(8,6*scale));ctx.stroke();ctx.shadowBlur=0;

      // Rotating scan arc for selected node
      if(constState.selectedNode&&constState.selectedNode.id===n.id){
        const sa=(t*2)%(Math.PI*2);
        ctx.beginPath();ctx.arc(sx,sy,r+5,sa,sa+Math.PI*.5);
        ctx.strokeStyle='rgba(255,255,255,.5)';ctx.lineWidth=1.5;ctx.stroke();
      }

      // Stars around the ring — small dots filling the orbit
      if(n.starsCount&&n.starsCount>0&&r>3){
        const starR=r+3;// orbit radius
        const maxStars=Math.min(n.starsCount,20);// cap at 20 visual stars
        const starSize=Math.max(1,Math.min(2.5,r*0.12));
        for(let si=0;si<maxStars;si++){
          const sa=(si/Math.max(maxStars,12))*Math.PI*2-Math.PI/2;
          const sSx=sx+Math.cos(sa)*starR;
          const sSy=sy+Math.sin(sa)*starR;
          const flicker=0.5+Math.sin(t*3+si*0.7)*0.3;
          ctx.beginPath();ctx.arc(sSx,sSy,starSize,0,Math.PI*2);
          ctx.fillStyle='rgba(255,215,0,'+flicker.toFixed(2)+')';ctx.fill();
        }
        // Count label if many stars
        if(n.starsCount>3&&r>5){
          ctx.font='bold '+Math.max(4,Math.min(7,r*0.35))+'px Inter,sans-serif';
          ctx.fillStyle='rgba(255,215,0,.6)';ctx.textAlign='center';ctx.textBaseline='middle';
          ctx.fillText('★'+n.starsCount,sx,sy-r-8);
        }
      }
      // Top tag badge above node
      if(n.topTag&&r>5){
        const tagLabels={top1:'TOP 1',top5:'TOP 5',top50:'TOP 50',top100:'TOP 100',top1000:'TOP 1K',top5000:'TOP 5K',top10000:'TOP 10K',top100000:'TOP 100K'};
        const tagColors={top1:'#FFD700',top5:'#C0C0C0',top50:'#CD7F32',top100:'#6a5acd',top1000:'#20b2aa',top5000:'#708090',top10000:'#556b2f',top100000:'#8b4513'};
        const tagTxt=tagLabels[n.topTag]||'';
        if(tagTxt){
          const tagFs=Math.max(5,Math.min(8,6*scale));
          const tagW=ctx.measureText?tagFs*tagTxt.length*0.55+6:30;
          const tagH=tagFs+4;const tagY=sy-r-tagH-3;
          const tagColor=tagColors[n.topTag]||'#888';
          ctx.fillStyle=tagColor;
          ctx.beginPath();
          const tr=tagH/2;
          ctx.moveTo(sx-tagW/2+tr,tagY);ctx.lineTo(sx+tagW/2-tr,tagY);ctx.arc(sx+tagW/2-tr,tagY+tr,tr,-Math.PI/2,Math.PI/2);ctx.lineTo(sx-tagW/2+tr,tagY+tagH);ctx.arc(sx-tagW/2+tr,tagY+tr,tr,Math.PI/2,-Math.PI/2);ctx.closePath();ctx.fill();
          ctx.fillStyle='#000';ctx.font='bold '+tagFs+'px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
          ctx.fillText(tagTxt,sx,tagY+tagH/2);
        }
      }
      // Verified badge on constellation canvas
      if(n.verified&&r>4){const br=Math.max(5,r*.45);const bx=sx+r*.55,by=sy+r*.55;
        const vg=ctx.createLinearGradient(bx-br,by-br,bx+br,by+br);vg.addColorStop(0,'#06b6d4');vg.addColorStop(.5,'#3b82f6');vg.addColorStop(1,'#8b5cf6');
        ctx.beginPath();for(let vi=0;vi<8;vi++){const va=vi*Math.PI/4-Math.PI/2;const vri=vi%2===0?br:br*.6;ctx.lineTo(bx+Math.cos(va)*vri,by+Math.sin(va)*vri)}ctx.closePath();ctx.fillStyle=vg;ctx.fill();
        ctx.strokeStyle='#0a0a0f';ctx.lineWidth=Math.max(.8,1.5*scale);ctx.stroke();
        ctx.fillStyle='#fff';ctx.font='700 '+Math.max(4,br*.85)+'px Inter';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('✓',bx,by+.2)}
      // Label — show nickname only (real name only if revealed)
      if(r>3){
        const label=n._revealed?(n.realName||n.nickname):n.nickname;
        const fontSize=Math.max(6,Math.min(11,8*scale));
        ctx.fillStyle='rgba(255,255,255,'+(depthAlpha*(0.35+n.intensity*0.35)).toFixed(2)+')';
        ctx.font='500 '+fontSize+'px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='top';
        ctx.fillText(label.length>12?label.slice(0,11)+'…':label,sx,sy+r+4);
        if(n.encounters>1&&r>6){
          ctx.fillStyle='rgba(255,255,255,'+(depthAlpha*0.2).toFixed(2)+')';ctx.font=(Math.max(5,Math.min(9,6*scale)))+'px Inter,sans-serif';
          ctx.fillText(n.encounters+'x',sx,sy+r+4+fontSize+2);
        }
      }
      ctx.restore();
    });
    ctx.textBaseline='alphabetic';

    // ── Center node (me) — stays visible, slides to bottom in FP ──
    {
      ctx.save();
      const MAX_MY_R=32;
      const myR=Math.min(16*z,MAX_MY_R);
      // Outer scan ring
      const scanAngle=(t*0.5)%(Math.PI*2);
      ctx.beginPath();ctx.arc(mcx,mcy,myR*2.5,scanAngle,scanAngle+Math.PI*.6);
      ctx.strokeStyle='rgba(255,107,53,.15)';ctx.lineWidth=1;ctx.stroke();
      // Glow
      const myGlow=ctx.createRadialGradient(mcx,mcy,0,mcx,mcy,myR*3);
      myGlow.addColorStop(0,'rgba(255,107,53,.2)');myGlow.addColorStop(.5,'rgba(255,107,53,.05)');myGlow.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(mcx,mcy,myR*3,0,Math.PI*2);ctx.fillStyle=myGlow;ctx.fill();
      // Photo or initials
      if(constState._myImg&&constState._myImgLoaded){
        drawCroppedImage(constState._myImg,mcx,mcy,myR);
      }else{
        ctx.beginPath();ctx.arc(mcx,mcy,myR,0,Math.PI*2);ctx.fillStyle=state.userColor||'#ff6b35';ctx.fill();
        ctx.fillStyle='#fff';ctx.font='bold '+Math.min(9*z,14)+'px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText((state.userName||'EU').slice(0,2).toUpperCase(),mcx,mcy);
      }
      // Orange ring
      ctx.beginPath();ctx.arc(mcx,mcy,myR,0,Math.PI*2);ctx.strokeStyle='rgba(255,107,53,.6)';ctx.lineWidth=Math.min(2*z,3);ctx.stroke();
      // Label
      ctx.fillStyle='rgba(255,255,255,.4)';ctx.font=Math.min(8*z,12)+'px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='top';
      ctx.fillText('VOCÊ',mcx,mcy+myR+4);
      ctx.restore();
    }

    // ── FP mode HUD: hint at top ──
    if(fpBlend>0.6){
      ctx.save();ctx.globalAlpha=fpBlend*0.3;
      ctx.fillStyle='#fff';ctx.font='400 10px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='top';
      ctx.fillText('incline o celular para explorar · toque no centro para voltar',W/2,12);
      ctx.restore();
    }

    // ── Floating legend pill (hidden in FP mode) ──
    if(fpBlend>0.7)return; // skip pill in full FP
    const verified=constState.nodes.filter(n=>!!(n.partnerRevealedToMe||(state.revealedIds&&state.revealedIds[n.id]))).length;
    const anon=constState.nodes.filter(n=>!n.isEvent).length-verified;
    const pillW=Math.min(W-24,260),pillH=32,pillX=(W-pillW)/2,pillY=H-48;
    ctx.save();ctx.globalAlpha=1-fpBlend;
    // Store pill bounds for click detection
    constState._pillBounds={x:pillX,y:pillY,w:pillW,h:pillH,revX:pillX,revW:pillW/2,anonX:pillX+pillW/2,anonW:pillW/2};
    ctx.beginPath();
    const pillR=pillH/2;
    ctx.moveTo(pillX+pillR,pillY);ctx.lineTo(pillX+pillW-pillR,pillY);
    ctx.arc(pillX+pillW-pillR,pillY+pillR,pillR,-Math.PI/2,Math.PI/2);
    ctx.lineTo(pillX+pillR,pillY+pillH);ctx.arc(pillX+pillR,pillY+pillR,pillR,Math.PI/2,-Math.PI/2);
    ctx.closePath();
    ctx.fillStyle='rgba(10,10,25,.65)';ctx.fill();
    ctx.strokeStyle='rgba(100,160,255,.12)';ctx.lineWidth=0.5;ctx.stroke();
    const midY=pillY+pillH/2;
    let tx=pillX+14;
    // Revealed section (clickable)
    const revHighlight=constFilter==='revealed'?.9:.55;
    ctx.beginPath();ctx.arc(tx,midY,3.5,0,Math.PI*2);ctx.fillStyle='#00dc82';ctx.fill();
    tx+=10;
    ctx.fillStyle='rgba(255,255,255,'+revHighlight+')';ctx.font=(constFilter==='revealed'?'700':'500')+' 10px Inter,sans-serif';ctx.textAlign='left';ctx.textBaseline='middle';
    ctx.fillText('Revelados: '+verified,tx,midY);
    const revEndX=tx+ctx.measureText('Revelados: '+verified).width;
    constState._pillBounds.revEndX=revEndX+8;
    tx=revEndX+16;
    // Anon section (clickable)
    const anonHighlight=constFilter==='anon'?.9:.55;
    ctx.beginPath();ctx.arc(tx,midY,3.5,0,Math.PI*2);ctx.fillStyle='#ff4466';ctx.fill();
    tx+=10;
    constState._pillBounds.anonStartX=tx-14;
    ctx.fillStyle='rgba(255,255,255,'+anonHighlight+')';ctx.font=(constFilter==='anon'?'700':'500')+' 10px Inter,sans-serif';
    ctx.fillText('Anônimos: '+anon,tx,midY);
    ctx.textAlign='right';ctx.fillStyle='rgba(255,255,255,.25)';ctx.font='400 9px Inter,sans-serif';
    ctx.fillText(filteredNodes.length+' nós',pillX+pillW-14,midY);
    ctx.restore();
    ctx.textBaseline='alphabetic';
  }
  draw();
}

function handleConstTap(tx,ty,W,H){
  // Tap on legend pill → toggle filter
  if(constState._pillBounds){
    const pb=constState._pillBounds;
    if(ty>=pb.y&&ty<=pb.y+pb.h&&tx>=pb.x&&tx<=pb.x+pb.w){
      if(tx<(pb.revEndX||pb.x+pb.w/2)){
        setConstFilter(constFilter==='revealed'?'all':'revealed');
      }else if(tx>=(pb.anonStartX||pb.x+pb.w/2)){
        setConstFilter(constFilter==='anon'?'all':'anon');
      }
      haptic([15]);return;
    }
  }
  // Tap center → show own profile card
  if(constState._mcx!==undefined){
    const dCenter=Math.hypot(tx-constState._mcx,ty-constState._mcy);
    if(dCenter<40){
      showConstDetail({
        id:state.userId,isMe:true,
        nickname:state.userName,realName:state.userRealName||'',
        color:state.userColor||nickColor(state.userName||'??'),
        profilePhoto:state.userPhoto||null,
        verified:!!state.userVerified,topTag:state.userTopTag||null,
        starsCount:state.userStarsCount||0,score:state.userScore||0,
        partnerRevealedToMe:true,iRevealedToPartner:true,
        encounters:0,uniqueConnections:0
      });
      haptic([15]);
      return;
    }
  }
  // In FP mode, tap on a node → show detail
  if(constState.fpMode){
    let hit=null,minD=Infinity;
    constState.nodes.forEach(n=>{
      if(n._px===undefined)return;
      const d=Math.hypot(tx-n._px,ty-n._py);
      if(d<(n.baseRadius*(n._pscale||1)*1.8+16)&&d<minD){minD=d;hit=n}
    });
    if(hit){showConstDetail(hit)}else{hideConstDetail()}
    return;
  }
  // Normal mode tap
  let hit=null,minD=Infinity;
  constState.nodes.forEach(n=>{
    if(n._px===undefined)return;
    const d=Math.hypot(tx-n._px,ty-n._py);
    const hitR=n.baseRadius*(n._pscale||1)*1.8+12;
    if(d<hitR&&d<minD){minD=d;hit=n}
  });
  if(hit){showConstDetail(hit)}else{hideConstDetail()}
}
function enterConstFP(){
  constState.fpMode=true;constState.fpTransition=0;constState.fpYaw=0;constState.fpPitch=0;
  hideConstDetail();
}
function exitConstFP(){
  if(!constState.fpMode)return;
  constState.fpMode=false;constState.fpTransition=1;// will animate back
}
function showConstDetail(node){
  constState.selectedNode=node;
  // Event nodes: special detail card
  if(node.isEvent){
    window._constDetailNodeId=node.id;
    const av=$('cdAvatar');
    av.innerHTML='';av.textContent='📍';av.style.background='linear-gradient(135deg,#3b82f6,#60a5fa)';av.style.fontSize='1.4rem';av.style.display='flex';av.style.alignItems='center';av.style.justifyContent='center';
    $('cdName').innerHTML='<span style="color:#60a5fa">'+esc(node.nickname||'Evento')+'</span>';
    $('cdAlias').textContent='evento';$('cdAlias').style.display='';
    const statsEl=$('cdStats');
    statsEl.innerHTML='<div class="cd-stat"><div class="cd-stat-val">'+(node.encounters||0)+'</div><div class="cd-stat-lbl">check-ins</div></div>';
    const metaEl=$('cdMeta');
    const lastD=node.lastDate?new Date(node.lastDate):null;
    metaEl.innerHTML=lastD?'<div class="cd-time"><span>🕐 '+timeAgo(lastD)+'</span></div>':'';
    $('cdActions').innerHTML='';
    $('cdAnonPreview').classList.add('hidden');
    $('constDetail').classList.add('visible');
    return;
  }
  const theyRevealed=!!node.partnerRevealedToMe;
  const iRevealed=!!node.iRevealedToPartner;
  window._constDetailNodeId=node.id;
  // Avatar
  const av=$('cdAvatar');
  av.style.fontSize='';av.style.display='';av.style.alignItems='';av.style.justifyContent='';
  if(theyRevealed&&node.profilePhoto){
    av.innerHTML='<img src="'+esc(node.profilePhoto)+'" alt="">';av.style.background=node.color;
  }else{
    av.innerHTML='';av.textContent=(node.nickname||'??').slice(0,2).toUpperCase();av.style.background=node.color;
  }
  // Verified badge
  const cvb=$('cdVerifiedBadge');
  if(cvb){if(node.verified)cvb.classList.remove('hidden');else cvb.classList.add('hidden')}
  // Name + tag
  const nameEl=$('cdName');
  let nameHtml=esc(theyRevealed?(node.realName||node.nickname):node.nickname);
  if(node.verified)nameHtml+=' <span style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:.65rem;font-weight:800">✓</span>';
  if(node.topTag){
    const tagColors={top1:'#ffd700',top5:'#c0c0c0',top50:'#cd7f32',top100:'#e8a0bf',top1000:'#7ec8e3',top5000:'#b5e3b5',top10000:'#ddd',top100000:'#999'};
    nameHtml+='<span class="cd-tag" style="background:'+(tagColors[node.topTag]||'#888')+'">'+node.topTag.replace('top','TOP ')+'</span>';
  }
  nameEl.innerHTML=nameHtml;
  // Anonymous preview ball (shows what others see before reveal)
  const anonPreview=$('cdAnonPreview');
  const anonBall=$('cdAnonBall');
  const anonNick=$('cdAnonNick');
  if(theyRevealed&&node.realName&&node.realName!==node.nickname){
    anonBall.textContent=(node.nickname||'??').slice(0,2).toUpperCase();
    anonBall.style.background=node.color;
    anonNick.textContent=node.nickname;
    anonPreview.classList.remove('hidden');
  }else{
    anonPreview.classList.add('hidden');
  }
  // Alias
  const aliasEl=$('cdAlias');
  let aliasParts=[];
  if(theyRevealed&&node.realName&&node.realName!==node.nickname)aliasParts.push('@'+node.nickname);
  if(node.isPrestador&&node.serviceLabel)aliasParts.push('💼 '+node.serviceLabel);
  aliasEl.textContent=aliasParts.join(' · ');
  aliasEl.style.display=aliasParts.length?'':'none';
  // Stats row — Stars (primary), Score, Unique Connections, Likes
  const statsEl=$('cdStats');
  let statsHtml='';
  statsHtml+='<div class="cd-stat"><div class="cd-stat-val" style="color:#fbbf24">'+(node.starsCount||0)+'</div><div class="cd-stat-lbl">estrelas</div></div>';
  statsHtml+='<div class="cd-stat"><div class="cd-stat-val" style="color:#60a5fa">'+(node.score||0)+'</div><div class="cd-stat-lbl">score</div></div>';
  statsHtml+='<div class="cd-stat"><div class="cd-stat-val">'+(node.uniqueConnections||node.touchers||0)+'</div><div class="cd-stat-lbl">conexões</div></div>';
  statsHtml+='<div class="cd-stat"><div class="cd-stat-val" style="color:#c084fc">'+(node.giftsReceived||0)+'</div><div class="cd-stat-lbl">presentes</div></div>';
  statsEl.innerHTML=statsHtml;
  // Meta section: time, social links with logos, selfies gallery
  const metaEl=$('cdMeta');
  let metaHtml='';
  const lastD=node.lastDate?new Date(node.lastDate):null;
  if(lastD){
    metaHtml+='<div class="cd-time"><span style="color:var(--t3);font-size:.65rem">'+timeAgo(lastD)+'</span></div>';
  }
  // Social links with logos (only when revealed)
  if(theyRevealed){
    let socialHtml='<div style="display:flex;gap:.4rem;margin:.3rem 0;flex-wrap:wrap">';
    if(node.instagram){
      const handle=node.instagram.replace(/^@/,'').trim();
      socialHtml+='<a href="https://instagram.com/'+esc(handle)+'" target="_blank" rel="noopener" onclick="event.stopPropagation()" style="display:inline-flex;align-items:center;gap:.3rem;padding:.3rem .6rem;background:linear-gradient(135deg,rgba(225,48,108,.12),rgba(131,58,180,.1));border:1px solid rgba(225,48,108,.18);border-radius:16px;color:#e1306c;font-size:.65rem;font-weight:500;text-decoration:none">'
        +'<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><rect x="2" y="2" width="20" height="20" rx="5" stroke="#e1306c" stroke-width="2"/><circle cx="12" cy="12" r="5" stroke="#e1306c" stroke-width="2"/><circle cx="17.5" cy="6.5" r="1.5" fill="#e1306c"/></svg>'
        +' @'+esc(handle)+'</a>';
    }
    if(node.whatsapp){
      const num=node.whatsapp.replace(/\D/g,'');
      const waNum=num.startsWith('55')?num:'55'+num;
      socialHtml+='<a href="https://wa.me/'+waNum+'" target="_blank" rel="noopener" onclick="event.stopPropagation()" style="display:inline-flex;align-items:center;gap:.3rem;padding:.3rem .6rem;background:rgba(37,211,102,.08);border:1px solid rgba(37,211,102,.18);border-radius:16px;color:#25d366;font-size:.65rem;font-weight:500;text-decoration:none">'
        +'<svg width="14" height="14" viewBox="0 0 24 24" fill="#25d366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 2C6.477 2 2 6.477 2 12c0 1.89.525 3.66 1.438 5.168L2 22l4.832-1.438A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2z" fill="none" stroke="#25d366" stroke-width="1.5"/></svg>'
        +' WhatsApp</a>';
    }
    socialHtml+='</div>';
    if(node.instagram||node.whatsapp)metaHtml+=socialHtml;
  }
  // Selfies gallery — clickable thumbnails
  const selfies=node.allSelfies||[];
  if(selfies.length>0){
    metaHtml+='<div class="cd-selfies-row">';
    selfies.forEach((s,i)=>{
      metaHtml+='<img class="cd-selfie" src="'+s.url+'" alt="" onclick="event.stopPropagation();openSelfieZoom('+i+',\''+node.id+'\')">';
    });
    metaHtml+='</div>';
  } else if(node.lastSelfie){
    metaHtml+='<img class="cd-selfie" src="'+node.lastSelfie+'" alt="" onclick="event.stopPropagation();openSelfieZoom(0,\''+node.id+'\')">';
  }
  metaEl.innerHTML=metaHtml;
  metaEl.style.display=metaHtml?'':'none';
  // Actions — toggle reveal (liga/desliga), reworded labels
  const actEl=$('cdActions');
  const isLiked=!!node.likedByMe;
  const pending=node.pendingReveal||state.pendingReveals[node.id]||null;
  let aHtml='';
  // Like
  aHtml+='<button class="cd-action" id="constLikeBtn" onclick="toggleLike(\''+node.id+'\')">'+(isLiked?'❤️ Curtido':'🤍 Curtir')+'</button>';
  // Button 1: Revelar/Esconder ID (toggle my visibility)
  if(iRevealed){
    aHtml+='<button class="cd-action" onclick="toggleMyReveal(\''+node.id+'\',false)" style="background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.2);color:#86efac">🪪 Esconder ID</button>';
  }else{
    aHtml+='<button class="cd-action primary" onclick="toggleMyReveal(\''+node.id+'\',true)">🪪 Revelar ID</button>';
  }
  // Button 2: Pedir ID / Aguardando
  if(theyRevealed){
    aHtml+='<button class="cd-action" style="background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.15);color:#86efac;opacity:.7" disabled>✅ ID recebido</button>';
  }else if(pending==='sent'){
    aHtml+='<button class="cd-action" disabled style="opacity:.5">⏳ Aguardando</button>';
  }else if(pending==='received'){
    aHtml+='<button class="cd-action success" onclick="acceptRevealRequest(\''+node.id+'\');hideConstDetail()">🪪 Aceitar pedido</button>';
  }else{
    aHtml+='<button class="cd-action" onclick="requestRevealFromConstellation(\''+node.id+'\')">👁 Pedir ID</button>';
  }
  // Chat button (discreet) if active relation or <24h
  const lastMs=node.lastDate?Date.now()-new Date(node.lastDate).getTime():999999999;
  if(node.hasActiveRelation||lastMs<86400000){
    aHtml+='<button class="cd-action" onclick="openChatFromConst(\''+node.id+'\')" style="opacity:.7;font-size:.65rem">Chat</button>';
  }
  actEl.innerHTML=aHtml;
  // Tip
  const tipWrap=$('cdTipWrap');
  if(node.isPrestador){tipWrap.classList.remove('hidden');$('cdTipBtn').dataset.receiverId=node.id}
  else tipWrap.classList.add('hidden');
  // Async: check if can donate stars — show subtle link
  Promise.all([
    fetch('/api/stars/available/'+state.userId).then(r=>r.json()).catch(()=>({available:0})),
    fetch('/api/star/shop/'+state.userId).then(r=>r.json()).catch(()=>({spendablePoints:0,giftCost:999}))
  ]).then(([avail,shop])=>{
    const canDonate=avail.available>0;
    const canBuy=shop.spendablePoints>=shop.giftCost;
    if(canDonate||canBuy){
      const donateEl=document.createElement('div');
      donateEl.style.cssText='text-align:center;padding:.2rem 0 .1rem;';
      donateEl.innerHTML='<span style="font-size:.6rem;color:var(--t3);cursor:pointer;opacity:.6" onclick="event.stopPropagation();'+(canDonate?'donateStar(\''+node.id+'\')':'buyStarForPerson(\''+node.id+'\')')+'">★ doar estrela</span>';
      actEl.parentElement.insertBefore(donateEl,actEl.nextSibling);
    }
  });
  // Declarations section (30-day expiry)
  const declEl=$('cdDeclarations');
  declEl.innerHTML='<div style="font-size:.6rem;color:var(--t3);padding:.2rem 0">Carregando declarações...</div>';
  const declWrap=$('cdDeclareWrap');
  if(node.isMe){
    declWrap.classList.add('hidden'); // can't declare yourself
    // For own profile, hide actions that don't make sense
    actEl.innerHTML='';
  }else{
    declWrap.classList.remove('hidden');
    $('cdDeclareInput').value='';
  }
  // Load declarations
  loadDeclarations(node.id);
  // Load gifts count async
  fetch('/api/gifts/count/'+node.id).then(r=>r.json()).then(d=>{
    const giftStat=document.querySelector('#cdStats .cd-stat:last-child .cd-stat-val');
    if(giftStat)giftStat.textContent=d.count||0;
  }).catch(()=>{});
  $('constDetail').classList.add('visible');
  haptic([15]);
}
async function loadDeclarations(targetId){
  const declEl=$('cdDeclarations');
  try{
    const d=await(await fetch('/api/declarations/'+targetId)).json();
    if(!d.declarations||!d.declarations.length){
      declEl.innerHTML='<div style="font-size:.6rem;color:var(--t3);text-align:center;padding:.4rem 0;opacity:.5">Nenhuma declaração ainda</div>';
      return;
    }
    let html='<div style="font-size:.6rem;color:var(--t3);margin-bottom:.3rem;font-weight:600">Declarações</div>';
    d.declarations.forEach(dc=>{
      const ago=timeAgo(new Date(dc.createdAt));
      const daysLeft=Math.max(0,Math.ceil((dc.expiresAt-Date.now())/86400000));
      html+='<div style="padding:.35rem .5rem;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.04);border-radius:10px;margin-bottom:.3rem">'
        +'<div style="display:flex;align-items:center;gap:.3rem;margin-bottom:.15rem">'
        +'<span style="width:18px;height:18px;border-radius:50%;background:'+esc(dc.fromColor||'#666')+';display:inline-flex;align-items:center;justify-content:center;font-size:.45rem;font-weight:800;color:#fff;flex-shrink:0">'+esc((dc.fromNick||'??').slice(0,2).toUpperCase())+'</span>'
        +'<span style="font-size:.6rem;font-weight:600;color:var(--t2)">'+esc(dc.fromNick||'Anônimo')+'</span>'
        +'<span style="font-size:.5rem;color:var(--t3);margin-left:auto">'+ago+' · '+daysLeft+'d</span>'
        +'</div>'
        +'<div style="font-size:.65rem;color:var(--t1);line-height:1.3">'+esc(dc.text)+'</div>'
        +'</div>';
    });
    declEl.innerHTML=html;
  }catch(e){
    declEl.innerHTML='<div style="font-size:.6rem;color:var(--t3);opacity:.5">Erro ao carregar</div>';
  }
}
async function sendDeclaration(){
  const input=$('cdDeclareInput');
  const text=input.value.trim();
  if(!text)return showToast('Digite uma declaração');
  if(text.length<3)return showToast('Mínimo 3 caracteres');
  const targetId=window._constDetailNodeId;
  if(!targetId||targetId===state.userId)return;
  try{
    const r=await fetch('/api/declarations/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      fromUserId:state.userId,toUserId:targetId,text
    })});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    input.value='';
    showToast('Declaração enviada!');
    haptic([25,15,25]);
    loadDeclarations(targetId);
  }catch(e){showToast('Erro ao enviar')}
}
function timeAgo(date){
  const s=Math.floor((Date.now()-date.getTime())/1000);
  if(s<60)return'agora';if(s<3600)return Math.floor(s/60)+'min atrás';
  if(s<86400)return Math.floor(s/3600)+'h atrás';
  const d=Math.floor(s/86400);if(d<7)return d+'d atrás';
  if(d<30)return Math.floor(d/7)+'sem atrás';
  return date.toLocaleDateString('pt-BR');
}
function hideConstDetail(){$('constDetail').classList.remove('visible');constState.selectedNode=null}

// ── Selfie zoom / gallery ──
let _selfieZoomData={selfies:[],idx:0,nodeId:null,holdTimer:null};
function openSelfieZoom(idx,nodeId){
  const node=constState.selectedNode;
  if(!node)return;
  const selfies=node.allSelfies||(node.lastSelfie?[{url:node.lastSelfie,userId:'',relationId:'',date:0}]:[]);
  if(!selfies.length)return;
  _selfieZoomData={selfies,idx:Math.min(idx,selfies.length-1),nodeId};
  const zoom=$('selfieZoom');
  $('selfieZoomImg').src=selfies[_selfieZoomData.idx].url;
  zoom.classList.remove('hold-active');
  zoom.style.display='flex';
  requestAnimationFrame(()=>zoom.classList.add('visible'));
  // Long press to show delete
  const img=$('selfieZoomImg');
  img.addEventListener('pointerdown',selfieHoldStart);
  img.addEventListener('pointerup',selfieHoldEnd);
  img.addEventListener('pointercancel',selfieHoldEnd);
}
function selfieHoldStart(e){
  _selfieZoomData.holdTimer=setTimeout(()=>{
    $('selfieZoom').classList.add('hold-active');
    haptic&&haptic([40]);
  },600);
}
function selfieHoldEnd(){
  if(_selfieZoomData.holdTimer){clearTimeout(_selfieZoomData.holdTimer);_selfieZoomData.holdTimer=null}
}
function closeSelfieZoom(){
  const zoom=$('selfieZoom');
  zoom.classList.remove('visible','hold-active');
  setTimeout(()=>{zoom.style.display='none'},250);
  const img=$('selfieZoomImg');
  img.removeEventListener('pointerdown',selfieHoldStart);
  img.removeEventListener('pointerup',selfieHoldEnd);
  img.removeEventListener('pointercancel',selfieHoldEnd);
}
async function deleteSelfieFromZoom(){
  const s=_selfieZoomData.selfies[_selfieZoomData.idx];
  if(!s||!s.relationId)return;
  if(!confirm('Apagar esta foto?'))return;
  try{
    await fetch('/api/selfie/'+s.relationId+'/'+s.userId,{method:'DELETE'});
    showToast('Foto apagada');
    closeSelfieZoom();
    // Refresh constellation
    if(constState.selectedNode)showConstDetail(constState.selectedNode);
  }catch(e){showToast('Erro ao apagar')}
}

// ── Toggle reveal (on/off) ──
async function toggleMyReveal(partnerId,reveal){
  try{
    if(reveal){
      await revealFromConstellation(partnerId);
    }else{
      // Unreveal — remove canSee
      await fetch('/api/reveal/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,partnerId,reveal:false})});
      showToast('Identidade ocultada');
      // Refresh node
      reloadConstellation();
    }
  }catch(e){showToast('Erro: '+e.message)}
}
function reloadConstellation(){
  fetch('/api/constellation/'+state.userId).then(r=>r.json()).then(d=>{
    if(d.nodes)constState.nodes=d.nodes;
    const sel=constState.selectedNode;
    if(sel){
      const updated=d.nodes.find(n=>n.id===sel.id);
      if(updated)showConstDetail(updated);
    }
  }).catch(()=>{});
}

function constTipAction(){
  const btn=$('cdTipBtn');
  if(btn&&btn.dataset.receiverId){hideConstDetail();showTipScreen(btn.dataset.receiverId)}
}
// ═══ NOTIFICATION PANEL ═══
function toggleNotifPanel(){
  const panel=$('notifPanel');
  if(panel.classList.contains('visible')){
    panel.classList.remove('visible');
  }else{
    panel.classList.add('visible');
    loadNotifications();
  }
}
async function loadNotifications(){
  const list=$('notifList');
  list.innerHTML='<div class="notif-empty">Carregando...</div>';
  try{
    const data=await(await fetch('/api/notifications/'+state.userId)).json();
    const notifs=data.notifications||[];
    if(!notifs.length){list.innerHTML='<div class="notif-empty">Nenhuma atividade ainda</div>';return}
    // Mark as seen
    fetch('/api/notifications/seen',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})}).catch(()=>{});
    let html='';
    notifs.forEach(n=>{
      const name=n.realName||n.nickname||'Alguém';
      const photo=n.profilePhoto;
      const icoHtml=photo
        ?'<div class="notif-ico" style="background:'+(n.color||'var(--ac)')+'"><img src="'+esc(photo)+'" alt=""></div>'
        :'<div class="notif-ico" style="background:'+(n.color||'var(--ac)')+'">'+esc((n.nickname||'?').slice(0,2).toUpperCase())+'</div>';
      let text='';
      if(n.type==='like')text='<strong>'+esc(name)+'</strong> curtiu você ❤️';
      else if(n.type==='star')text='<strong>'+esc(name)+'</strong> te deu uma ⭐';
      else if(n.type==='friend-star')text='<strong>'+esc(name)+'</strong> ganhou uma ⭐';
      else if(n.type==='network-star')text='<strong>'+esc(name)+'</strong> ganhou uma ⭐';
      else if(n.type==='reveal-request')text='<strong>'+esc(name)+'</strong> pediu seu ID 👁';
      else if(n.type==='identity-revealed')text='<strong>'+esc(name)+'</strong> revelou o ID pra você 🪪';
      // Timestamp formatting
      const ts=n.timestamp;
      let timeStr='';
      if(ts){
        const d=new Date(ts);
        const now=new Date();
        const diff=now-d;
        if(diff<60000)timeStr='agora';
        else if(diff<3600000)timeStr=Math.floor(diff/60000)+'min';
        else if(diff<86400000)timeStr=Math.floor(diff/3600000)+'h';
        else if(diff<604800000)timeStr=Math.floor(diff/86400000)+'d';
        else timeStr=d.getDate()+'/'+(d.getMonth()+1);
      }
      const unseenDot=n.seen?'':'<div style="width:6px;height:6px;border-radius:50%;background:#3b82f6;flex-shrink:0;margin-left:auto"></div>';
      const clickAction=n.fromId?'onclick="navigateToConstNode(\''+esc(n.fromId)+'\')" style="cursor:pointer"':'';
      const bg=n.seen?'':'background:rgba(59,130,246,.04);';
      html+='<div class="notif-item" '+clickAction+' style="'+bg+'">'+icoHtml+'<div class="notif-content"><div class="notif-text">'+text+'</div>'+(timeStr?'<div class="notif-time">'+timeStr+'</div>':'')+'</div>'+unseenDot+'</div>';
    });
    list.innerHTML=html;
    // Update badge to 0 (just seen them)
    const badge=$('constNotifBadge');
    if(badge){badge.textContent='0';badge.classList.add('hidden')}
  }catch(e){
    list.innerHTML='<div class="notif-empty">Erro ao carregar</div>';
  }
}
// Load notif count when constellation opens — only UNSEEN
function updateNotifBadge(){
  if(!state.userId)return;
  fetch('/api/notifications/'+state.userId).then(r=>r.json()).then(data=>{
    const count=data.unseenCount||0;
    const badge=$('constNotifBadge');
    if(badge){badge.textContent=count;badge.classList.toggle('hidden',count===0)}
  }).catch(()=>{});
}

function openChatFromConst(nodeId){
  hideConstDetail();
  // Find active relation with this user
  fetch('/api/relations/'+state.userId).then(r=>r.json()).then(rels=>{
    const rel=rels.find(r=>r.partnerId===nodeId&&r.expiresAt>Date.now());
    if(rel){showScreen('chat');loadChat(rel.id,rel.partnerId,rel.partnerName,rel.partnerColor)}
    else showToast('Conexão expirada');
  }).catch(()=>showToast('Erro ao abrir chat'));
}
function navigateToConstNode(nodeId){
  toggleNotifPanel();
  const node=constState.nodes.find(n=>n.id===nodeId);
  if(node){
    // Center camera on this node
    constState.cam.x=-node.x3d;constState.cam.y=-node.y3d;
    constState.cam.zoom=Math.max(constState.cam.zoom,1.2);
    showConstDetail(node);haptic([20]);
  }
}

// ═══ MORE MENU ═══
function showMoreMenu(){
  const existing=document.querySelector('.more-menu-overlay');if(existing){existing.remove();return}
  const overlay=document.createElement('div');
  overlay.className='more-menu-overlay';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
  overlay.innerHTML='<div class="more-menu-sheet"><div class="more-menu-handle"></div><div class="more-menu-grid">'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showRelations()"><div class="mm-ico">💬</div><div class="mm-lbl">Conexões</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showBoardingPass()"><div class="mm-ico">🪪</div><div class="mm-lbl">ID</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showPrestadorRegister()"><div class="mm-ico">💼</div><div class="mm-lbl">Prestador</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showManual()"><div class="mm-ico">❓</div><div class="mm-lbl">Tutorial</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();window.open(\'/site\',\'_blank\')"><div class="mm-ico">🌐</div><div class="mm-lbl">Sobre o Touch</div></div>'
    +'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();window.open(\'/termos\',\'_blank\')"><div class="mm-ico">📜</div><div class="mm-lbl">Termos de Uso</div></div>'
    +(state.userIsAdmin?'<div class="more-menu-item" onclick="this.closest(\'.more-menu-overlay\').remove();showVerificationPanel()"><div class="mm-ico" style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800">✓</div><div class="mm-lbl">Verificações</div></div>':'')
    +'</div></div>';
  document.body.appendChild(overlay);
}

// ═══ ENCOUNTER LOG (individual touches) ═══
async function showEncounterLog(){
  haptic([30]);
  showScreen('encounterLog');
  const list=$('elogList');
  list.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3)">Carregando...</div>';
  try{
    const data=await(await fetch('/api/encounters/'+state.userId)).json();
    if(!data||!data.length){
      list.innerHTML='<div class="elog-empty">Nenhum encontro ainda.<br>Toque em alguém para começar!</div>';
      return;
    }
    const myCanSee2=state.revealedIds||{};
    let html='';
    let lastDateLabel='';
    data.forEach(enc=>{
      const dt=new Date(enc.timestamp);
      const dateLabel=dt.toLocaleDateString('pt-BR',{weekday:'short',day:'numeric',month:'short'});
      if(dateLabel!==lastDateLabel){
        html+='<div style="font-size:.6rem;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;padding:.6rem 0 .2rem;font-weight:600;border-bottom:1px solid rgba(255,255,255,.04);margin-bottom:.3rem">'+dateLabel+'</div>';
        lastDateLabel=dateLabel;
      }
      const revealed=!!(enc.profilePhoto||myCanSee2[enc.with]);
      const revData=myCanSee2[enc.with];
      const displayName=revealed?(enc.realName||revData?.realName||enc.withName):enc.withName;
      const photo=revealed?(enc.profilePhoto||revData?.profilePhoto||null):null;
      const timeStr=dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
      const typeIcon=enc.type==='service'?'💼':(enc.type==='digital'?'📱':'📲');
      html+='<div class="elog-item" data-ts="'+enc.timestamp+'">';
      html+='<div class="elog-delete" onclick="event.stopPropagation();deleteEncounter(this.parentElement,'+enc.timestamp+')">Apagar</div>';
      html+='<div class="elog-item-inner">';
      const encVerified=!!enc.verified;
      if(photo){
        let avHtml='<div class="elog-avatar" style="background:'+(enc.withColor||'var(--ac)')+';overflow:hidden"><img src="'+esc(photo)+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>';
        html+=encVerified?'<div class="verified-wrap">'+avHtml+'<div class="verified-badge verified-badge-sm">'+VERIFIED_SVG+'</div></div>':avHtml;
      }else{
        let avHtml='<div class="elog-avatar" style="background:'+(enc.withColor||'var(--ac)')+'">'+(enc.withName||'??').slice(0,2).toUpperCase()+'</div>';
        html+=encVerified?'<div class="verified-wrap">'+avHtml+'<div class="verified-badge verified-badge-sm">'+VERIFIED_SVG+'</div></div>':avHtml;
      }
      html+='<div style="flex:1;min-width:0">';
      html+='<div class="elog-name" style="font-size:.8rem">'+esc(displayName)+(encVerified?' <span style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:.6rem;font-weight:800">✓</span>':'')+'</div>';
      html+='<div class="elog-meta" style="margin-top:.15rem">';
      html+='<span>'+typeIcon+' '+timeStr+'</span>';
      if(enc.points)html+='<span>+'+enc.points+'pts</span>';
      html+='</div></div>';
      html+='</div></div>';
    });
    list.innerHTML=html;
    // Init swipe-to-delete
    initElogSwipe();
  }catch(e){list.innerHTML='<div class="elog-empty">Erro ao carregar histórico.</div>'}
}
function initElogSwipe(){
  const items=document.querySelectorAll('.elog-item');
  items.forEach(item=>{
    let startX=0,startY=0,dx=0,isHorizontal=null;
    const inner=item.querySelector('.elog-item-inner');
    if(!inner)return;
    inner.addEventListener('touchstart',e=>{
      const t=e.touches[0];startX=t.clientX;startY=t.clientY;dx=0;isHorizontal=null;
      inner.style.transition='none';
      // Close any other open items
      document.querySelectorAll('.elog-item-inner').forEach(el=>{
        if(el!==inner&&el.style.transform&&el.style.transform!=='translateX(0px)'){
          el.style.transition='transform .2s ease';el.style.transform='translateX(0)';
        }
      });
    },{passive:true});
    inner.addEventListener('touchmove',e=>{
      const t=e.touches[0];
      dx=t.clientX-startX;
      const dy=t.clientY-startY;
      // Decide direction on first significant move
      if(isHorizontal===null&&(Math.abs(dx)>8||Math.abs(dy)>8)){
        isHorizontal=Math.abs(dx)>Math.abs(dy);
      }
      if(!isHorizontal)return; // let vertical scroll happen
      e.preventDefault();
      if(dx<0){
        inner.style.transform='translateX('+Math.max(dx,-80)+'px)';
      }else{
        inner.style.transform='translateX('+Math.min(dx,0)+'px)';
      }
    },{passive:false});
    inner.addEventListener('touchend',()=>{
      inner.style.transition='transform .2s ease';
      if(isHorizontal&&dx<-35){
        inner.style.transform='translateX(-70px)';
      }else{
        inner.style.transform='translateX(0)';
      }
      isHorizontal=null;
    });
  });
}
async function deleteEncounter(el,timestamp){
  haptic([20]);
  try{
    await fetch('/api/encounters/'+state.userId+'/'+timestamp,{method:'DELETE'});
    el.style.transition='all .3s ease';el.style.opacity='0';el.style.maxHeight='0';el.style.padding='0';el.style.margin='0';el.style.overflow='hidden';
    setTimeout(()=>el.remove(),350);
  }catch(e){showToast('Erro ao apagar')}
}

// ═══ COMPLETE PROFILE ═══
let cpPhotoData=null;
async function openCompleteProfile(){
  haptic([30]);
  showScreen('completeProfile');
  // Load existing data
  try{
    const d=await(await fetch('/api/myprofile/'+state.userId)).json();
    if(d.nickname)$('cpNickname').value=d.nickname;
    if(d.realName)$('cpRealName').value=d.realName;
    if(d.bio)$('cpBio').value=d.bio;
    if(d.phone)$('cpPhone').value=d.phone;
    if(d.email)$('cpEmail').value=d.email;
    if(d.cpf)$('cpCpf').value=d.cpf;
    if(d.instagram)$('cpInstagram').value=d.instagram;
    if(d.twitter)$('cpTwitter').value=d.twitter;
    const _cpPhoto=d.profilePhoto||d.photoURL||null;
    if(_cpPhoto){
      cpPhotoData=_cpPhoto;
      $('cpPhotoPreview').innerHTML='<img src="'+_cpPhoto+'" alt="">';
    }
  }catch(e){}
}
function handleProfilePhoto(input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  if(file.size>5*1024*1024)return showToast('Foto muito grande (máx 5MB)');
  const reader=new FileReader();
  reader.onload=function(e){
    // Compress
    const img=new Image();
    img.onload=function(){
      const canvas=document.createElement('canvas');
      const max=400;
      let w=img.width,h=img.height;
      if(w>max||h>max){if(w>h){h=h*(max/w);w=max}else{w=w*(max/h);h=max}}
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      cpPhotoData=canvas.toDataURL('image/jpeg',0.7);
      $('cpPhotoPreview').innerHTML='<img src="'+cpPhotoData+'" alt="">';
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}
async function saveCompleteProfile(){
  const nicknameVal=$('cpNickname').value.trim();
  const realNameVal=$('cpRealName').value.trim();
  if(realNameVal&&nicknameVal&&realNameVal.toLowerCase()===nicknameVal.toLowerCase()){
    return showToast('Seu nome real precisa ser diferente do nickname!');
  }
  if(nicknameVal&&nicknameVal.length<2)return showToast('Apelido precisa ter pelo menos 2 caracteres.');
  const data={
    userId:state.userId,
    nickname:nicknameVal||undefined,
    realName:realNameVal,
    bio:$('cpBio').value.trim(),
    phone:$('cpPhone').value.trim(),
    email:$('cpEmail').value.trim(),
    cpf:$('cpCpf').value.trim(),
    instagram:$('cpInstagram').value.trim(),
    twitter:$('cpTwitter').value.trim(),
    profilePhoto:cpPhotoData||''
  };
  try{
    const r=await fetch('/api/profile/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    // Update local state
    if(data.profilePhoto){state.userPhoto=data.profilePhoto;localStorage.setItem('touch_userPhoto',data.profilePhoto);constState._myImgLoaded=false}
    if(nicknameVal){state.userNickname=nicknameVal;state.userName=nicknameVal;localStorage.setItem('touch_userName',nicknameVal)}
    showToast('Perfil salvo!');haptic([40,20,40]);
    goHome();
  }catch(e){showToast('Erro ao salvar.')}
}

// ═══ REVELAR ID — DUAS AÇÕES ═══
// 1. "Me revelar" = direto, sem aceite. Eu mostro minha identidade.
// 2. "Pedir pra revelar" = solicito que o outro se revele. Precisa aceite.
if(!state.pendingReveals)state.pendingReveals={};

// ACTION 1: Me revelar (direto, imediato)
async function revealMyself(targetUserId){
  if(!state.userId)return;
  try{
    const r=await fetch('/api/identity/reveal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,targetUserId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([60,30,60]);
    showToast('Você se revelou! 🪪');
    updateChatIdBar();
    refreshRelations();
    const cBtn=$('constRevealIdBtn');if(cBtn){cBtn.textContent='✅ Revelado';cBtn.disabled=true;cBtn.style.opacity='.6'}
  }catch(e){showToast('Complete seu perfil antes de se revelar.')}
}

// ACTION 2: Solicitar que o outro se revele (precisa aceite)
async function requestReveal(targetUserId){
  if(!state.userId)return;
  if(state.pendingReveals[targetUserId]==='sent')return showToast('Pedido já enviado. Aguardando...');
  try{
    const r=await fetch('/api/identity/request-reveal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,targetUserId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([40,20,40]);
    state.pendingReveals[targetUserId]='sent';
    updateChatIdBar();
    showToast('Pedido enviado!');
  }catch(e){showToast('Erro ao solicitar.')}
}
function revealFromConstellation(nodeId){revealMyself(nodeId)}
function requestRevealFromConstellation(nodeId){requestReveal(nodeId)}

// Accept: "Aceito me revelar" (eu fui pedido pra me revelar, e aceito)
async function acceptRevealRequest(fromUserId){
  try{
    const r=await fetch('/api/identity/reveal-accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,fromUserId})});
    const d=await r.json();
    if(d.error){showToast(d.error);return}
    haptic([80,40,80,40,80]);
    delete state.pendingReveals[fromUserId];
    showToast('Você se revelou! 🪪');
    updateChatIdBar();
  }catch(e){showToast('Erro ao aceitar.')}
}
async function declineRevealRequest(fromUserId){
  try{await fetch('/api/identity/reveal-decline',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,fromUserId})})}catch(e){}
  delete state.pendingReveals[fromUserId];
  showToast('Pedido recusado.');
  updateChatIdBar();
}

// Like toggle — white heart 🤍 → red ❤️
async function toggleLike(targetUserId){
  if(!state.userId||!targetUserId)return;
  try{
    const r=await fetch('/api/like/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,targetUserId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic(d.liked?[50,30,50]:[20]);
    const btn=$('constLikeBtn');
    if(btn){
      const heart=d.liked?'❤️':'🤍';
      btn.innerHTML=heart+(d.count?' '+d.count:'');
      btn.style.background=d.liked?'rgba(255,60,80,.15)':'rgba(255,100,100,.06)';
      btn.style.borderColor=d.liked?'rgba(255,60,80,.3)':'rgba(255,100,100,.15)';
    }
    if(d.liked)showToast('Curtiu! ❤️');
  }catch(e){}
}

// ══ STAR DONATION MODAL (forced — must donate earned star) ══
let _starDonateQueue=[];
let _starModalOpen=false;

function showStarDonateModal(pendingStarId,reason,context){
  _starDonateQueue.push({pendingStarId,reason,context});
  if(!_starModalOpen)_showNextStarModal();
}

function _showNextStarModal(){
  if(_starDonateQueue.length===0){_starModalOpen=false;return;}
  _starModalOpen=true;
  const item=_starDonateQueue.shift();
  const overlay=document.createElement('div');
  overlay.id='starDonateOverlay';
  overlay.style.cssText='position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;padding:1rem;animation:fadeIn .3s ease';
  const reasonText=item.reason==='streak'?'Streak! '+item.context:item.reason==='milestone'?'Marco: '+item.context:'Você ganhou uma estrela!';
  overlay.innerHTML=`
    <div style="background:var(--c2,#1a1a2e);border-radius:20px;padding:1.5rem;width:100%;max-width:380px;max-height:85vh;overflow-y:auto;border:1px solid rgba(251,191,36,.3);box-shadow:0 0 40px rgba(251,191,36,.15)">
      <div style="text-align:center;margin-bottom:1rem">
        <div style="font-size:2.5rem;margin-bottom:.5rem;animation:pulse 1.5s ease infinite">⭐</div>
        <div style="font-size:1rem;font-weight:700;color:#fbbf24;margin-bottom:.3rem">Você ganhou uma estrela!</div>
        <div style="font-size:.72rem;color:var(--t2,#aaa)">${reasonText}</div>
        <div style="font-size:.65rem;color:var(--t3,#777);margin-top:.4rem">Escolha alguém para presentear — a estrela deve ser doada agora!</div>
      </div>
      <div style="position:relative;margin-bottom:.8rem">
        <input id="starSearchInput" type="text" placeholder="Buscar por nickname..." autocomplete="off" style="width:100%;box-sizing:border-box;padding:.6rem .8rem .6rem 2rem;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:12px;color:#fff;font-size:.8rem;outline:none">
        <div style="position:absolute;left:.6rem;top:50%;transform:translateY(-50%);font-size:.75rem;opacity:.4">🔍</div>
      </div>
      <div id="starSearchResults" style="min-height:120px;max-height:300px;overflow-y:auto"></div>
    </div>`;
  document.body.appendChild(overlay);
  const inp=document.getElementById('starSearchInput');
  const res=document.getElementById('starSearchResults');
  let searchTimeout;
  inp.addEventListener('input',()=>{
    clearTimeout(searchTimeout);
    searchTimeout=setTimeout(async()=>{
      const q=inp.value.trim();
      if(q.length<1){res.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3,#777);font-size:.7rem">Digite um nickname para buscar</div>';return;}
      try{
        const r2=await fetch('/api/star/search-people/'+state.userId+'?q='+encodeURIComponent(q));
        const d=await r2.json();
        if(!d.results||d.results.length===0){res.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3,#777);font-size:.7rem">Nenhum resultado para "'+q+'"</div>';return;}
        res.innerHTML=d.results.map(p=>`
          <div onclick="confirmStarDonate('${item.pendingStarId}','${p.id}','${(p.nickname||'').replace(/'/g,"\\'")}')" style="display:flex;align-items:center;gap:.6rem;padding:.55rem .6rem;margin-bottom:.3rem;background:rgba(255,255,255,.04);border-radius:12px;cursor:pointer;transition:background .2s" onmouseover="this.style.background='rgba(251,191,36,.1)'" onmouseout="this.style.background='rgba(255,255,255,.04)'">
            <div style="width:36px;height:36px;border-radius:50%;background:${p.color||'#666'};display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:#fff;flex-shrink:0">${(p.nickname||'?').slice(0,2).toUpperCase()}</div>
            <div style="flex:1;min-width:0">
              <div style="font-size:.78rem;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.nickname||'?'} ${p.verified?'<span style="color:#3b82f6;font-size:.6rem">✓</span>':''}</div>
              <div style="font-size:.6rem;color:var(--t3,#777)">⭐ ${p.stars||0} estrelas</div>
            </div>
            <div style="font-size:.65rem;color:#fbbf24;font-weight:600">Doar ⭐</div>
          </div>`).join('');
      }catch(e){res.innerHTML='<div style="text-align:center;padding:1rem;color:#f87171;font-size:.7rem">Erro na busca</div>';}
    },300);
  });
  // Show recent connections as suggestions
  _loadStarSuggestions(res,item.pendingStarId);
  setTimeout(()=>inp.focus(),300);
}

async function _loadStarSuggestions(container,pendingStarId){
  container.innerHTML='<div style="text-align:center;padding:1rem;color:var(--t3,#777);font-size:.65rem">Carregando sugestões...</div>';
  try{
    const r=await fetch('/api/constellation/'+state.userId);
    const d=await r.json();
    const nodes=(d.nodes||[]).filter(n=>n.id!==state.userId).slice(0,10);
    if(nodes.length===0){container.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3,#777);font-size:.7rem">Busque por nickname acima</div>';return;}
    container.innerHTML='<div style="font-size:.6rem;color:var(--t3,#777);padding:0 .3rem .4rem;font-weight:600">Suas conexões:</div>'+nodes.map(p=>`
      <div onclick="confirmStarDonate('${pendingStarId}','${p.id}','${(p.nickname||'').replace(/'/g,"\\'")}')" style="display:flex;align-items:center;gap:.6rem;padding:.55rem .6rem;margin-bottom:.3rem;background:rgba(255,255,255,.04);border-radius:12px;cursor:pointer;transition:background .2s" onmouseover="this.style.background='rgba(251,191,36,.1)'" onmouseout="this.style.background='rgba(255,255,255,.04)'">
        <div style="width:36px;height:36px;border-radius:50%;background:${p.color||'#666'};display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:#fff;flex-shrink:0">${(p.nickname||'?').slice(0,2).toUpperCase()}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:.78rem;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.nickname||'?'} ${p.verified?'<span style="color:#3b82f6;font-size:.6rem">✓</span>':''}</div>
          <div style="font-size:.6rem;color:var(--t3,#777)">⭐ ${p.starsCount||0} estrelas</div>
        </div>
        <div style="font-size:.65rem;color:#fbbf24;font-weight:600">Doar ⭐</div>
      </div>`).join('');
  }catch(e){container.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3,#777);font-size:.7rem">Busque por nickname acima</div>';}
}

async function confirmStarDonate(pendingStarId,targetId,targetName){
  if(!confirm('Doar ⭐ estrela para '+targetName+'?'))return;
  try{
    const r=await fetch('/api/star/donate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({fromUserId:state.userId,toUserId:targetId,pendingStarId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([60,30,60,30,100]);
    showToast('⭐ Estrela doada para '+targetName+'!');
    // Close modal
    const ov=document.getElementById('starDonateOverlay');
    if(ov)ov.remove();
    // Process next pending star if any
    setTimeout(()=>_showNextStarModal(),500);
  }catch(e){showToast('Erro ao doar estrela.');}
}

// Direct donate from constellation detail (uses available earned stars)
async function donateStar(targetUserId){
  if(!state.userId||!targetUserId)return;
  try{
    const pend=await(await fetch('/api/star/pending/'+state.userId)).json();
    if(pend.count>0){
      // Has pending — use first pending star
      const pendingStarId=pend.pending[0].id;
      const r=await fetch('/api/star/donate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({fromUserId:state.userId,toUserId:targetUserId,pendingStarId})});
      const d=await r.json();
      if(d.error)return showToast(d.error);
      haptic([60,30,60,30,100]);
      showToast('⭐ Estrela doada!');
      return;
    }
    // No pending — check legacy available
    const avail=await(await fetch('/api/stars/available/'+state.userId)).json();
    if(avail.available<=0)return showToast('Sem estrelas para doar. Continue conectando!');
    if(!confirm('Doar ⭐ estrela para essa pessoa? (Você tem '+avail.available+' disponíveis)'))return;
    const r=await fetch('/api/star/donate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({fromUserId:state.userId,toUserId:targetUserId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([60,30,60,30,100]);
    showToast('⭐ Estrela doada!');
  }catch(e){showToast('Erro ao doar.')}
}

// Buy star with score points (for yourself)
async function buyStarForPerson(targetUserId){
  if(!state.userId||!targetUserId)return;
  try{
    const shop=await(await fetch('/api/star/shop/'+state.userId)).json();
    const cost=shop.giftCost;
    if(shop.spendablePoints<cost)return showToast('Pontos insuficientes. Custo: '+cost+', Disponível: '+shop.spendablePoints);
    if(!confirm('Comprar ★ estrela para essa pessoa?\nCusto: '+cost+' pontos (Disponível: '+shop.spendablePoints+')'))return;
    const r=await fetch('/api/star/buy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,target:targetUserId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([60,30,60,30,100]);
    showToast('★ Estrela comprada! (-'+d.cost+' pts)');
  }catch(e){showToast('Erro ao comprar.')}
}

// Buy star for yourself
async function buyStarSelf(){
  if(!state.userId)return;
  try{
    const shop=await(await fetch('/api/star/shop/'+state.userId)).json();
    const cost=shop.selfCost;
    if(shop.spendablePoints<cost)return showToast('Pontos insuficientes. Custo: '+cost+', Disponível: '+shop.spendablePoints);
    if(!confirm('Comprar ★ estrela para você?\nCusto: '+cost+' pontos (Disponível: '+shop.spendablePoints+')'))return;
    const r=await fetch('/api/star/buy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,target:'self'})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([60,30,60,30,100]);
    showToast('★ Estrela adquirida! (-'+d.cost+' pts)');
  }catch(e){showToast('Erro ao comprar.')}
}

// Render reveal messages in chat
function appendRevealChatCard(msg){
  const mc=$('chatMessages'),ti=$('typingIndicator'),near=nearBot();
  const div=document.createElement('div');
  div.className='reveal-chat-card';
  div.id='revealMsg-'+(msg.revealRequestId||msg.id);
  if(msg.type==='reveal-request'){
    const iSent=msg.fromUserId===state.userId;
    const name=msg.fromName||'?';
    const color=msg.fromColor||'var(--ac)';
    const initials=esc(name.slice(0,2).toUpperCase());
    const avatarHtml='<div style="width:42px;height:42px;border-radius:50%;background:'+color+';display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:800;color:#fff">'+initials+'</div>';
    // "request-reveal" = alguém pediu pra eu me revelar
    div.innerHTML='<div class="rcc-header">'
      +'<div class="rcc-icon">🪪</div>'
      +avatarHtml
      +'<div class="rcc-text">'
      +(iSent?'<strong>Você</strong> pediu pra essa pessoa se revelar':'<strong>'+esc(name)+'</strong> pede pra você se revelar')
      +'</div></div>'
      +(iSent
        ?'<div class="rcc-status pending">⏳ Aguardando resposta...</div>'
        :'<div class="rcc-actions" id="rccActions-'+msg.revealRequestId+'">'
        +'<button class="bp" style="flex:1;font-size:.82rem" onclick="acceptRevealRequest(\''+msg.fromUserId+'\')">Me revelar 🪪</button>'
        +'<button class="bs" style="flex:1;font-size:.82rem" onclick="declineRevealRequest(\''+msg.fromUserId+'\')">Agora não</button>'
        +'</div>');
    if(!iSent){
      // If I already revealed to them, show as resolved
      const them=db?undefined:undefined;
      const meRevealed=state.currentRelation&&state.currentRelation.iRevealedToPartner;
      if(meRevealed){
        div.innerHTML=div.innerHTML.replace(/<div class="rcc-actions"[^]*<\/div>$/,'<div class="rcc-status accepted">✅ Você se revelou</div>');
      }
    }
  }else if(msg.type==='reveal-accepted'){
    // UNILATERAL: only one person revealed
    const revealed=msg.revealedUser;
    if(!revealed){div.innerHTML='<div class="rcc-status accepted">✅ Identidade revelada</div>';mc.insertBefore(div,ti);return}
    const iAmRevealer=revealed.id===state.userId;
    const photo=revealed.profilePhoto;
    div.innerHTML='<div class="rcc-revealed">'
      +'<div class="rcc-revealed-title">🪪 '+(iAmRevealer?'Você se revelou!':esc(revealed.realName||revealed.nickname)+' se revelou!')+'</div>'
      +'<div style="display:flex;align-items:center;gap:.8rem;margin:.4rem 0">'
      +(photo?'<img src="'+photo+'" class="rcc-photo" alt="">':'<div class="rcc-photo-placeholder">'+esc((revealed.nickname||'?').slice(0,2).toUpperCase())+'</div>')
      +'<div>'
      +'<div class="rcc-name">'+esc(revealed.realName||revealed.nickname)+'</div>'
      +(revealed.instagram?'<a class="rcc-insta" href="https://instagram.com/'+esc(revealed.instagram.replace(/^@/,''))+'" target="_blank" rel="noopener">📸 @'+esc(revealed.instagram.replace(/^@/,''))+'</a>':'')
      +(revealed.bio?'<div style="font-size:.7rem;color:var(--t3);margin-top:.2rem">'+esc(revealed.bio)+'</div>':'')
      +'</div></div></div>';
  }else if(msg.type==='reveal-declined'){
    div.innerHTML='<div class="rcc-status declined">Pedido de reveal não aceito no momento</div>';
  }
  mc.insertBefore(div,ti);
  if(near)mc.scrollTo({top:mc.scrollHeight,behavior:'smooth'});
}

// Update chat ID bar — two actions: "Me revelar" and "Pedir reveal"
function updateChatIdBar(){
  const idBar=$('chatIdBar');if(!idBar)return;
  const pid=state.currentPartnerId;
  if(!pid){idBar.style.display='none';return}
  const rel=state.currentRelation;
  const iRevealed=!!(rel&&rel.iRevealedToPartner);
  const theyRevealed=!!(state.revealedIds&&state.revealedIds[pid]);
  idBar.style.display='flex';
  const btn=$('revealIdBtn');if(!btn)return;
  const pending=state.pendingReveals[pid];
  // Build two-button layout: Revelar/Esconder ID + Pedir ID/Aguardando
  let html='';
  // Button 1: Revelar/Esconder ID
  if(iRevealed){
    html+='<button class="id-bar-btn reveal" onclick="toggleMyReveal(\''+pid+'\',false)">🪪 Esconder ID</button>';
  }else{
    html+='<button class="id-bar-btn reveal" onclick="revealMyself(\''+pid+'\')">🪪 Revelar ID</button>';
  }
  // Button 2: Pedir ID / Aguardando
  if(theyRevealed){
    html+='<button class="id-bar-btn done" disabled>✅ ID recebido</button>';
  }else if(pending==='sent'){
    html+='<button class="id-bar-btn" disabled style="opacity:.6">⏳ Aguardando</button>';
  }else if(pending==='received'){
    html+='<button class="id-bar-btn request" onclick="acceptRevealRequest(\''+pid+'\')">🪪 Aceitar pedido</button>';
  }else{
    html+='<button class="id-bar-btn request" onclick="requestReveal(\''+pid+'\')">👁 Pedir ID</button>';
  }
  idBar.innerHTML=html;
}

// Sync reveal UI
function syncRevealUI(partnerId,realName,profilePhoto){
  delete state.pendingReveals[partnerId];
  if(!state.revealedIds)state.revealedIds={};
  state.revealedIds[partnerId]={realName,profilePhoto};
  if(state.currentPartnerId===partnerId){
    const chatName=$('chatPartner');
    if(chatName&&realName)chatName.textContent=realName;
    const pNick=state.currentRelation?.partnerName||'';
    const sub=$('chatSub');if(sub)sub.innerHTML='<span style="color:var(--ok)">✓ revelou-se pra você</span>'+(pNick?' · @'+esc(pNick):'');
  }
  if(constState.nodes){
    const cNode=constState.nodes.find(n=>n.id===partnerId);
    if(cNode){
      cNode.partnerRevealedToMe=true;cNode.pendingReveal=null;
      if(realName)cNode.realName=realName;
      if(profilePhoto){cNode.profilePhoto=profilePhoto;cNode._revealed=true;
        // Load image for canvas
        const img=new Image();img.crossOrigin='anonymous';img.src=profilePhoto;
        cNode._img=img;cNode._imgLoaded=false;img.onload=()=>{cNode._imgLoaded=true};
      }
    }
  }
  updateChatIdBar();
  refreshRelations();
}
function appendSystemMsg(text){
  const box=$('chatMessages');if(!box)return;
  const div=document.createElement('div');
  div.style.cssText='text-align:center;font-size:.7rem;color:var(--ac);padding:.5rem;font-style:italic';
  div.textContent=text;box.appendChild(div);box.scrollTop=box.scrollHeight;
}

// ═══ BOARDING PASS ═══
async function showBoardingPassWithQR(){
  await showBoardingPass();
  // Auto-generate QR code (area is always visible now)
  setTimeout(()=>showTouchQR(),300);
}
async function showBoardingPass(){
  haptic([30]);
  try{
    const d=await fetch('/api/boarding-pass/'+state.userId).then(r=>r.json());
    $('bpName').textContent=d.name;
    const bpColor=d.color||nickColor(d.name||'??');
    const bpInitials=(d.name||'??').slice(0,2).toUpperCase();
    $('bpAvatar').innerHTML='';
    if(state.userPhoto&&state.userPhoto.length>10){$('bpAvatar').style.background='none';$('bpAvatar').innerHTML='<img src="'+state.userPhoto+'" style="width:100%;height:100%;border-radius:50%;object-fit:cover" alt="">'}
    else{$('bpAvatar').textContent=bpInitials;$('bpAvatar').style.background=bpColor;$('bpAvatar').style.fontSize='1.4rem';$('bpAvatar').style.fontWeight='800';$('bpAvatar').style.color='#fff'}
    const since=new Date(d.memberSince);
    const months=['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];
    $('bpSince').textContent='membro desde '+months[since.getMonth()]+' '+since.getFullYear();
    $('bpScore').textContent=d.score;
    $('bpStars').textContent=d.stars;
    $('bpPeople').textContent=d.uniquePeople;
    $('bpLikes').textContent=d.likesCount||0;
    const tagEl=$('bpTag');if(tagEl)tagEl.textContent=d.topTag?d.topTag.replace('top','TOP '):'—';
    const bpvb=$('bpVerifiedBadge');if(bpvb){if(state.userVerified)bpvb.classList.remove('hidden');else bpvb.classList.add('hidden')}
    loadTouchLink();
    showScreen('boardingPass');
  }catch(e){showToast('Erro ao carregar bilhete.')}
}
function downloadBoardingPass(){
  const card=$('bpCard');
  const c=document.createElement('canvas');c.width=640;c.height=900;
  const ctx=c.getContext('2d');
  // Background
  const grad=ctx.createLinearGradient(0,0,0,900);
  grad.addColorStop(0,'#0c0c18');grad.addColorStop(.5,'#161628');grad.addColorStop(1,'#0c0c18');
  ctx.fillStyle=grad;roundRect(ctx,0,0,640,900,30);ctx.fill();
  // Top accent line
  const acGrad=ctx.createLinearGradient(0,0,640,0);acGrad.addColorStop(0,'#ff6b35');acGrad.addColorStop(.5,'#ff3d71');acGrad.addColorStop(1,'#ff6b35');
  ctx.fillStyle=acGrad;ctx.fillRect(0,0,640,5);
  // Header
  ctx.fillStyle='#ff6b35';ctx.font='bold 16px Inter,sans-serif';ctx.letterSpacing='6px';ctx.fillText('Touch?',30,50);
  ctx.fillStyle='#555568';ctx.font='12px Inter,sans-serif';ctx.letterSpacing='3px';ctx.textAlign='right';ctx.fillText('BOARDING PASS',610,50);ctx.textAlign='left';ctx.letterSpacing='0px';
  // Dashed line
  ctx.setLineDash([6,4]);ctx.strokeStyle='#2a2a3a';ctx.beginPath();ctx.moveTo(20,70);ctx.lineTo(620,70);ctx.stroke();ctx.setLineDash([]);
  // Avatar circle
  const avX=320,avY=160,avR=50;
  ctx.beginPath();ctx.arc(avX,avY,avR+3,0,Math.PI*2);ctx.strokeStyle='#ff6b35';ctx.lineWidth=2;ctx.stroke();
  const bpAv=$('bpAvatar');const avColor=bpAv.style.background||'hsl(200,65%,55%)';
  ctx.beginPath();ctx.arc(avX,avY,avR,0,Math.PI*2);ctx.fillStyle=avColor;ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 32px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(bpAv.textContent||'??',avX,avY);ctx.textBaseline='alphabetic';
  // Name
  ctx.fillStyle='#f5f5f7';ctx.font='bold 28px Inter,sans-serif';ctx.textAlign='center';
  ctx.fillText($('bpName').textContent,320,260);
  // Since
  ctx.fillStyle='#555568';ctx.font='13px Inter,sans-serif';
  ctx.fillText($('bpSince').textContent,320,290);
  // Stats boxes
  const stats=[{n:$('bpScore').textContent,l:'SCORE'},{n:$('bpStars').textContent,l:'ESTRELAS'},{n:$('bpPeople').textContent,l:'PESSOAS'},{n:$('bpTotal').textContent,l:'ENCONTROS'}];
  const sw=120,sy=340;
  stats.forEach((s,i)=>{
    const sx=30+i*(sw+25);
    ctx.fillStyle='rgba(255,107,53,0.08)';roundRect(ctx,sx,sy,sw,90,12);ctx.fill();
    ctx.fillStyle='#ff6b35';ctx.font='bold 36px Inter,sans-serif';ctx.textAlign='center';ctx.fillText(s.n,sx+sw/2,sy+45);
    ctx.fillStyle='#555568';ctx.font='10px Inter,sans-serif';ctx.letterSpacing='2px';ctx.fillText(s.l,sx+sw/2,sy+72);ctx.letterSpacing='0px';
  });
  // Dashed line
  ctx.setLineDash([6,4]);ctx.strokeStyle='#2a2a3a';ctx.beginPath();ctx.moveTo(20,480);ctx.lineTo(620,480);ctx.stroke();ctx.setLineDash([]);
  // Barcode
  for(let i=0;i<60;i++){const bh=15+Math.random()*25,bx=80+i*8;ctx.fillStyle='rgba(85,85,104,'+(0.3+Math.random()*0.4).toFixed(2)+')';ctx.fillRect(bx,520,3,bh)}
  // Footer
  ctx.fillStyle='#555568';ctx.font='11px Inter,sans-serif';ctx.letterSpacing='4px';ctx.textAlign='center';
  ctx.fillText('TUDO NASCE NO GESTO',320,610);ctx.letterSpacing='0px';
  // Corners notch effect
  ctx.fillStyle='#050508';
  [[-1,480],[641-20,480]].forEach(([x,y])=>{ctx.beginPath();ctx.arc(x<0?0:640,y,15,0,Math.PI*2);ctx.fill()});
  // Download
  c.toBlob(blob=>{
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='touch-pass.png';a.click();URL.revokeObjectURL(url);
    showToast('Bilhete salvo!');haptic([50,30,50]);
  },'image/png');
}
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath()}

// ═══ PROFILE ═══
let profileReturnTo='chat';
function showProfile(){
  if(!state.userId)return;
  profileReturnTo='home';
  loadProfile(state.userId);
}
async function showPartnerProfile(){
  if(!state.currentRelation)return;
  const pid=state.currentPartnerId;
  if(!pid)return showToast('Parceiro não encontrado.');
  profileReturnTo='chat';
  await loadProfile(pid);
}
async function loadProfile(userId,canAct){
  haptic([30]);
  try{
    const url=canAct===false?'/api/profile/'+userId:'/api/profile/'+userId+'/from/'+state.userId;
    const d=await fetch(url).then(r=>r.json());
    if(d.error)return showToast(d.error);
    renderProfile(d,userId);
    showScreen('profile');
  }catch(e){showToast('Erro ao carregar perfil.')}
}
function renderProfile(d,userId){
  const displayName=d.realName||d.nickname;
  $('pfTitle').textContent=displayName;
  const s=$('pfScroll');
  let html='<div class="pf-card">';
  if(d.profilePhoto){
    html+='<div style="width:64px;height:64px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,.1)"><img src="'+d.profilePhoto+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>';
  }else{
    html+=makeAvatar(d.nickname,d.color,64);
  }
  html+='<div style="margin-top:.8rem;font-size:1.1rem;font-weight:700">'+esc(displayName)+(d.isSubscriber?' <span style="font-size:.55rem;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;padding:.1rem .35rem;border-radius:8px;font-weight:600;vertical-align:middle">Plus</span>':'')+'</div>';
  if(d.realName&&d.realName!==d.nickname){
    html+='<div style="font-size:.7rem;color:var(--t2);margin-top:.1rem">@'+esc(d.nickname)+'</div>';
  }
  if(d.bio)html+='<div style="font-size:.75rem;color:var(--t2);margin-top:.4rem;font-style:italic">'+esc(d.bio)+'</div>';
  if(d.instagram)html+='<div style="font-size:.7rem;color:var(--ac);margin-top:.2rem">'+esc(d.instagram)+'</div>';
  html+='<div class="pf-stats">';
  html+='<div class="pf-stat"><div class="pf-stat-num" style="color:#fbbf24">'+(d.stars||0)+'</div><div class="pf-stat-lbl">estrelas</div></div>';
  html+='<div class="pf-stat"><div class="pf-stat-num" style="color:#60a5fa">'+(d.score||0)+'</div><div class="pf-stat-lbl">score</div></div>';
  html+='<div class="pf-stat"><div class="pf-stat-num">'+d.uniquePeople+'</div><div class="pf-stat-lbl">conexões</div></div>';
  html+='<div class="pf-stat"><div class="pf-stat-num" style="color:#ff6b8a">'+(d.likesCount||0)+'</div><div class="pf-stat-lbl">curtidas</div></div>';
  html+='</div>';
  // Buy star for self button (on own profile)
  if(userId===state.userId){
    html+='<button onclick="buyStarSelf()" style="margin:.4rem auto 0;display:block;padding:.35rem .8rem;font-size:.65rem;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:16px;color:#fbbf24;cursor:pointer">★ Comprar estrela</button>';
  }
  // Star details
  if(d.starDetails&&d.starDetails.length>0){
    html+='<div style="display:flex;flex-wrap:wrap;gap:.3rem;justify-content:center;margin:.5rem 0">';
    d.starDetails.forEach(s=>{
      const tip=s.reason==='gift'?'Presente de '+(s.fromName||'?'):s.reason==='organic'?'Orgânica ('+s.milestone+'x com '+(s.withName||'?')+')':'Marco';
      html+='<div title="'+tip+'" style="font-size:1rem;cursor:help;transition:.15s" onmouseenter="this.style.transform=\'scale(1.3)\'" onmouseleave="this.style.transform=\'none\'">⭐</div>';
    });
    html+='</div>';
  }
  html+='</div>';
  // Actions if active connection
  if(d.canInteract){
    html+='<div class="pf-actions">';
    html+='<button class="pf-act-btn" onclick="openGiftPicker()">Presentear</button>';
    html+='<button class="pf-act-btn" onclick="openDeclModal()">Declarar</button>';
    html+='</div>';
  }
  // Declarations
  html+='<div class="pf-section"><div class="pf-section-title">Declarações recebidas</div>';
  if(d.declarations&&d.declarations.length>0){
    d.declarations.slice().reverse().forEach(dc=>{
      html+='<div class="pf-decl"><div class="pf-decl-text">"'+esc(dc.text)+'"</div><div class="pf-decl-from">— '+esc(dc.fromName)+'</div></div>';
    });
  }else html+='<div class="pf-empty">Nenhuma declaração ainda.</div>';
  html+='</div>';
  // Gifts
  html+='<div class="pf-section"><div class="pf-section-title">Presentes recebidos</div>';
  if(d.gifts&&d.gifts.length>0){
    d.gifts.slice().reverse().forEach(g=>{
      html+='<div class="pf-gift"><div class="pf-gift-emoji">'+g.emoji+'</div><div class="pf-gift-info"><div class="pf-gift-name">'+esc(g.giftName)+'</div><div class="pf-gift-from">de '+esc(g.fromName)+'</div>'+(g.message?'<div class="pf-gift-msg">"'+esc(g.message)+'"</div>':'')+'</div></div>';
    });
  }else html+='<div class="pf-empty">Nenhum presente ainda.</div>';
  html+='</div>';
  // Subscription card (only on own profile)
  if(userId===state.userId){
    html+='<div class="pf-section" id="pfSubSection"><div class="pf-section-title">Touch? Plus</div>';
    html+='<div id="pfSubCard" style="padding:.6rem;background:linear-gradient(145deg,rgba(99,102,241,.08),rgba(168,85,247,.06));border:1px solid rgba(99,102,241,.15);border-radius:12px;text-align:center"><div style="font-size:.7rem;color:var(--t3)">Carregando...</div></div>';
    html+='</div>';
  }
  // Logout button (only on own profile)
  if(userId===state.userId){
    html+='<div style="margin-top:2rem;text-align:center;padding-bottom:2rem">';
    if(fbUser)html+='<div style="font-size:.72rem;color:var(--t3);margin-bottom:.6rem">'+esc(fbUser.email||fbUser.displayName||'')+'</div>';
    html+='<button class="bs" onclick="doLogout()" style="color:var(--err);border-color:var(--err)">Sair da conta</button>';
    html+='</div>';
  }
  s.innerHTML=html;
  // Load subscription status for own profile
  if(userId===state.userId)loadSubStatus();
}
function closeProfile(){
  if(profileReturnTo==='chat'&&state.currentRelation)showScreen('chat');
  else goHome();
}

// ═══ MY PROFILE SHEET (home avatar click) ═══
function showMyProfileSheet(){
  if(!state.userId)return;
  haptic([30]);
  const existing=document.querySelector('.my-profile-overlay');if(existing){existing.remove();return}
  const overlay=document.createElement('div');
  overlay.className='more-menu-overlay my-profile-overlay';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
  const color=state.userColor||nickColor(state.userName||'??');
  const initials=(state.userName||'??').slice(0,2).toUpperCase();
  const email=fbUser?(fbUser.email||fbUser.displayName||''):'';
  // Avatar: use real photo if available
  const hasPhoto=state.userPhoto&&state.userPhoto.length>10;
  const isVerified=!!state.userVerified;
  let avatarInner=hasPhoto
    ?'<div style="width:56px;height:56px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,.12);flex-shrink:0"><img src="'+state.userPhoto+'" style="width:100%;height:100%;object-fit:cover" alt=""></div>'
    :'<div style="width:56px;height:56px;border-radius:50%;background:'+color+';display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:800;color:#fff;border:2px solid rgba(255,255,255,.12);flex-shrink:0">'+esc(initials)+'</div>';
  const avatarHtml=isVerified?'<div class="verified-wrap">'+avatarInner+verifiedBadge('verified-badge-lg')+'</div>':avatarInner;
  // Cadastro tag
  const profileMostlyComplete=hasPhoto&&state.userRealName;
  const cadastroTag=profileMostlyComplete?'':'<span class="my-pf-tag">completar</span>';
  const realNameLine=state.userRealName?'<div style="font-size:.72rem;color:var(--t2);margin-top:.1rem">'+esc(state.userRealName)+'</div>':'';
  // Prestador: "Serviços" with both cadastro and painel inside
  const isPrestador=localStorage.getItem('touch_isPrestador')==='1';
  const hasFace=!!state.userFaceEnrolled;
  const hasDoc=!!state.userDocVerified;
  overlay.innerHTML='<div class="more-menu-sheet" style="padding:1.6rem 1.4rem">'
    +'<div class="more-menu-handle"></div>'
    // Header: avatar + name block redesigned — nick is HERO
    +'<div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.1rem">'
    +avatarHtml
    +'<div style="flex:1;min-width:0">'
    +'<div style="display:flex;align-items:center;gap:.4rem;flex-wrap:wrap"><span style="font-size:1.3rem;font-weight:900;color:#fff;letter-spacing:-.01em">'+esc(state.userName||'??')+'</span>'+(isVerified?' <span style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:.9rem;font-weight:800" title="Verificado">✓</span>':'')+'</div>'
    +(state.userRealName?'<div style="font-size:.72rem;color:var(--t2);margin-top:.15rem">'+esc(state.userRealName)+'</div>':'')
    +'<div style="display:flex;align-items:center;gap:.4rem;margin-top:.25rem;flex-wrap:wrap">'
    +(state.userIsSubscriber?'<span style="font-size:.5rem;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;padding:1px 6px;border-radius:6px;font-weight:700">✦ Plus</span>':'')
    +(state.userStarsCount>0?'<span style="font-size:.55rem;color:#fbbf24;background:rgba(251,191,36,.1);padding:1px 6px;border-radius:6px;font-weight:600">★ '+state.userStarsCount+'</span>':'')
    +(hasFace?'<span style="font-size:.5rem;color:#06b6d4;background:rgba(6,182,212,.1);padding:1px 6px;border-radius:6px;font-weight:600">🔐 Face</span>':'')
    +(hasDoc?'<span style="font-size:.5rem;color:#a855f7;background:rgba(168,85,247,.1);padding:1px 6px;border-radius:6px;font-weight:600">📄 Doc</span>':'')
    +(state.userTopTag?'<span style="font-size:.5rem;color:'+(state.userTopTag==='top1'?'#FFD700':state.userTopTag==='top5'?'#C0C0C0':'#CD7F32')+';background:rgba(255,215,0,.1);padding:1px 6px;border-radius:6px;font-weight:700">'+(state.userTopTag==='top1'?'🏆 TOP 1':state.userTopTag==='top5'?'🥈 TOP 5':state.userTopTag==='top50'?'🥉 TOP 50':'')+'</span>':'')
    +'</div>'
    // Stats row
    +'<div style="display:flex;gap:.8rem;margin-top:.4rem">'
    +'<div style="text-align:center"><div style="font-size:.85rem;font-weight:800;color:#60a5fa">'+(state.userScore||0)+'</div><div style="font-size:.42rem;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">score</div></div>'
    +'<div style="text-align:center"><div style="font-size:.85rem;font-weight:800;color:var(--t1)">'+(state.userUniqueConnections||0)+'</div><div style="font-size:.42rem;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">conexões</div></div>'
    +(state.userStarsCount>0?'<div style="text-align:center"><div style="font-size:.85rem;font-weight:800;color:#fbbf24">'+state.userStarsCount+'</div><div style="font-size:.42rem;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">estrelas</div></div>':'')
    +(state.userGiftsReceived>0?'<div style="text-align:center"><div style="font-size:.85rem;font-weight:800;color:#f472b6">'+state.userGiftsReceived+'</div><div style="font-size:.42rem;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">presentes</div></div>':'')
    +'</div>'
    +'</div></div>'
    // Menu buttons — clean, no emojis
    +'<div style="display:flex;flex-direction:column;gap:.4rem">'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showBoardingPassWithQR()"><span class="my-pf-ico">ID</span>Meu Cartão</button>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();openCompleteProfile()"><span class="my-pf-ico">✏️</span>Cadastro'+cadastroTag+'</button>'
    // Verification cards row
    +'<div style="display:flex;gap:.4rem;margin:.15rem 0">'
    +'<button onclick="this.closest(\'.my-profile-overlay\').remove();showFaceEnrollment()" style="flex:1;padding:.55rem .4rem;border-radius:14px;border:1px solid '+(hasFace?'rgba(6,182,212,.3)':'rgba(255,255,255,.06)')+';background:'+(hasFace?'rgba(6,182,212,.06)':'rgba(255,255,255,.02)')+';cursor:pointer;text-align:center;font-family:inherit;transition:all .15s">'
    +'<div style="font-size:1.3rem;margin-bottom:.2rem">🔐</div>'
    +'<div style="font-size:.62rem;font-weight:700;color:'+(hasFace?'#06b6d4':'var(--t1)')+'">Face ID</div>'
    +'<div style="font-size:.48rem;color:'+(hasFace?'#06b6d4':'var(--t3)')+';margin-top:.1rem">'+(hasFace?'✓ ativo':'configurar')+'</div>'
    +'</button>'
    +'<button onclick="this.closest(\'.my-profile-overlay\').remove();showDocIdScreen()" style="flex:1;padding:.55rem .4rem;border-radius:14px;border:1px solid '+(hasDoc?'rgba(168,85,247,.3)':'rgba(255,255,255,.06)')+';background:'+(hasDoc?'rgba(168,85,247,.06)':'rgba(255,255,255,.02)')+';cursor:pointer;text-align:center;font-family:inherit;transition:all .15s">'
    +'<div style="font-size:1.3rem;margin-bottom:.2rem">📄</div>'
    +'<div style="font-size:.62rem;font-weight:700;color:'+(hasDoc?'#a855f7':'var(--t1)')+'">Doc ID</div>'
    +'<div style="font-size:.48rem;color:'+(hasDoc?'#a855f7':'var(--t3)')+';margin-top:.1rem">'+(hasDoc?'✓ enviado':'verificar')+'</div>'
    +'</button>'
    +'</div>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showEncounterLog()"><span class="my-pf-ico">📋</span>Histórico</button>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showSubscriptionScreen()"><span class="my-pf-ico">'+(state.userIsSubscriber?'✦':'⭐')+'</span>Touch? Plus'+(state.userIsSubscriber?' <span style="font-size:.5rem;background:linear-gradient(135deg,#06b6d4,#3b82f6);color:#fff;padding:1px 5px;border-radius:5px;margin-left:.3rem;font-weight:600">ativo</span>':'')+'</button>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showServicosScreen()"><span class="my-pf-ico">💼</span>Serviços</button>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showManual()"><span class="my-pf-ico">❓</span>Tutorial</button>'
    +(state.userIsAdmin?'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();showVerificationPanel()"><span class="my-pf-ico" style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800">✓</span>Verificações</button>':'')
    +'<div class="my-pf-divider"></div>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();window.open(\'/site\',\'_blank\')"><span class="my-pf-ico">☷</span>Sobre o Touch</button>'
    +'<button class="my-pf-btn" onclick="this.closest(\'.my-profile-overlay\').remove();window.open(\'/termos\',\'_blank\')"><span class="my-pf-ico">§</span>Termos de Uso</button>'
    +'<button class="my-pf-btn my-pf-danger" onclick="this.closest(\'.my-profile-overlay\').remove();doLogout()"><span class="my-pf-ico">x</span>Sair</button>'
    +'</div></div>';
  document.body.appendChild(overlay);
}

// ═══ SUBSCRIPTION ═══
async function showSubscriptionScreen() {
  showScreen('subscriptionScreen');
  loadSubSavedCard();
  // Load plan benefits
  try {
    const plans = await (await fetch('/api/subscription/plans')).json();
    const plan = plans[0]; // touch_plus
    if (plan && plan.benefits) {
      $('subBenefitsList').innerHTML = plan.benefits.map(b =>
        '<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.4rem"><span style="color:#818cf8;font-size:.8rem">✓</span><span style="font-size:.72rem;color:var(--t2)">' + esc(b) + '</span></div>'
      ).join('');
    }
  } catch (e) {}
  // Load current status
  await loadSubStatus();
}

async function loadSubStatus() {
  if (!state.userId) return;
  try {
    const sub = await (await fetch('/api/subscription/status/' + state.userId)).json();
    const statusEl = $('subCurrentStatus');
    const btn = $('subActionBtn');
    if (sub.active) {
      const expDate = sub.expiresAt ? new Date(sub.expiresAt).toLocaleDateString('pt-BR') : '';
      statusEl.innerHTML = '<div style="padding:.8rem;background:rgba(0,220,130,.08);border:1px solid rgba(0,220,130,.2);border-radius:12px;text-align:center">'
        + '<div style="font-size:.85rem;font-weight:700;color:var(--ok)">✓ Assinatura ativa</div>'
        + '<div style="font-size:.65rem;color:var(--t3);margin-top:.2rem">Próxima renovação: ' + expDate + '</div>'
        + '</div>';
      btn.textContent = 'Cancelar assinatura';
      btn.style.background = 'rgba(255,68,102,.15)';
      btn.style.color = '#ff4466';
      btn.onclick = cancelSubscription;
    } else {
      statusEl.innerHTML = '';
      btn.textContent = 'Assinar agora';
      btn.style.background = 'linear-gradient(135deg,#6366f1,#8b5cf6)';
      btn.style.color = '#fff';
      btn.onclick = startSubscription;
    }
    // Also update profile card if visible
    const pfCard = $('pfSubCard');
    if (pfCard) {
      if (sub.active) {
        pfCard.innerHTML = '<div style="font-size:.75rem;font-weight:600;color:var(--ok)">✦ Plus ativo</div><div style="font-size:.6rem;color:var(--t3);margin-top:.15rem">Assinatura mensal · R$9,90</div>';
      } else {
        pfCard.innerHTML = '<div style="font-size:.7rem;color:var(--t2)">Assine o Touch? Plus por R$9,90/mês</div><button onclick="showSubscriptionScreen()" style="margin-top:.4rem;padding:.35rem .8rem;border-radius:10px;border:1px solid rgba(99,102,241,.3);background:rgba(99,102,241,.1);color:#818cf8;font-size:.65rem;font-weight:600;font-family:inherit;cursor:pointer">Ver plano</button>';
      }
    }
  } catch (e) { console.error('Sub status error:', e); }
}

async function startSubscription() {
  const btn = $('subActionBtn');
  btn.disabled = true; btn.textContent = 'Abrindo...';
  try {
    const resp = await fetch('/api/subscription/create', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: state.userId, planId: 'touch_plus' })
    });
    const result = await resp.json();
    if (result.error) throw new Error(result.error);
    const url = result.initPoint || result.sandboxInitPoint;
    if (url) {
      window.location.href = url;
    } else {
      throw new Error('URL de assinatura não disponível.');
    }
  } catch (e) {
    console.error('Subscription error:', e);
    showToast('Erro: ' + (e.message || 'Tente novamente'));
    btn.disabled = false;
    btn.textContent = '✦ Assinar Touch? Plus';
  }
}

async function cancelSubscription() {
  if (!confirm('Cancelar assinatura Touch? Plus?\nVocê perderá os benefícios ao final do período.')) return;
  const btn = $('subActionBtn');
  btn.disabled = true; btn.textContent = 'Cancelando...';
  try {
    const resp = await fetch('/api/subscription/cancel', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: state.userId })
    });
    const result = await resp.json();
    if (result.error) throw new Error(result.error);
    showToast('Assinatura cancelada.');
    await loadSubStatus();
  } catch (e) {
    showToast('Erro: ' + (e.message || 'Tente novamente'));
    btn.disabled = false;
    btn.textContent = 'Cancelar assinatura';
  }
}

// Check subscription result from URL param
function checkSubResultParam() {
  const params = new URLSearchParams(window.location.search);
  if (params.get('subResult') === 'ok') {
    showToast('Assinatura processada! Verificando... ✦');
    window.history.replaceState({}, '', window.location.pathname);
    setTimeout(() => loadSubStatus(), 1000);
  }
}

// ═══ GIFT PICKER ═══
let giftCatalog=[];
async function openGiftPicker(){
  if(!state.currentRelation)return;
  if(!giftCatalog.length){try{giftCatalog=await fetch('/api/gift-catalog').then(r=>r.json())}catch(e){return showToast('Erro ao carregar presentes.')}}
  let html='<div class="modal-overlay" onclick="closeGiftModal(event)">';
  html+='<div class="modal-sheet" onclick="event.stopPropagation()">';
  html+='<div class="modal-handle"></div>';
  html+='<div class="modal-title">&#x1F381; Escolha um presente</div>';
  html+='<div class="gift-grid">';
  giftCatalog.forEach(g=>{
    html+='<div class="gift-option" onclick="selectGift(\''+g.id+'\')">';
    html+='<div class="g-emoji">'+g.emoji+'</div>';
    html+='<div class="g-name">'+esc(g.name)+'</div>';
    html+='<div class="g-desc">'+esc(g.description)+'</div>';
    html+='</div>';
  });
  html+='</div></div></div>';
  $('giftModal').innerHTML=html;$('giftModal').classList.remove('hidden');
}
function closeGiftModal(e){if(e&&e.target.classList.contains('modal-overlay'))$('giftModal').classList.add('hidden');$('giftModal').innerHTML=''}
function selectGift(giftId){
  const gift=giftCatalog.find(g=>g.id===giftId);if(!gift)return;
  let html='<div class="modal-overlay" onclick="closeGiftModal(event)">';
  html+='<div class="modal-sheet" onclick="event.stopPropagation()">';
  html+='<div class="modal-handle"></div>';
  html+='<div class="modal-title">'+gift.emoji+' '+esc(gift.name)+'</div>';
  html+='<div style="text-align:center;font-size:.8rem;color:var(--t2);margin-bottom:.8rem">'+esc(gift.description)+'</div>';
  if(gift.needsAddress)html+='<div style="text-align:center;font-size:.7rem;color:var(--warn);margin-bottom:.6rem">&#x1F4E6; Requer endereço (pediremos permissão)</div>';
  html+='<input class="gift-msg-input" id="giftMsg" placeholder="Mensagem (opcional)" maxlength="120">';
  html+='<div style="margin-top:.8rem;text-align:center"><button class="bp" style="max-width:200px" onclick="confirmSendGift(\''+giftId+'\')">Enviar presente</button></div>';
  html+='</div></div>';
  $('giftModal').innerHTML=html;
}
async function confirmSendGift(giftId){
  const msg=$('giftMsg')?$('giftMsg').value.trim():'';
  try{
    const r=await fetch('/api/gift/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId:state.currentRelation.relationId,fromUserId:state.userId,giftId,message:msg})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Presente enviado!');haptic([50,30,50,30,50]);
    $('giftModal').classList.add('hidden');$('giftModal').innerHTML='';
  }catch(e){showToast('Erro ao enviar.')}
}

// ═══ DECLARATION MODAL ═══
function openDeclModal(){
  if(!state.currentRelation)return;
  let html='<div class="modal-overlay" onclick="closeDeclModal(event)">';
  html+='<div class="modal-sheet" onclick="event.stopPropagation()">';
  html+='<div class="modal-handle"></div>';
  html+='<div class="modal-title">&#x1F4DD; Declaração</div>';
  html+='<div style="text-align:center;font-size:.78rem;color:var(--t2);margin-bottom:.8rem">Escreva algo para ficar no perfil dessa pessoa. Todos que se conectarem a ela poderão ler.</div>';
  html+='<textarea class="decl-input" id="declText" placeholder="Escreva sua declaração..." maxlength="280" oninput="updateDeclCounter()"></textarea>';
  html+='<div class="decl-counter" id="declCounter">0/280</div>';
  html+='<div style="margin-top:.6rem;text-align:center"><button class="bp" style="max-width:200px" onclick="confirmSendDecl()">Publicar</button></div>';
  html+='</div></div>';
  $('declModal').innerHTML=html;$('declModal').classList.remove('hidden');
}
function closeDeclModal(e){if(e&&e.target.classList.contains('modal-overlay'))$('declModal').classList.add('hidden');$('declModal').innerHTML=''}
function updateDeclCounter(){const t=$('declText');if(t)$('declCounter').textContent=t.value.length+'/280'}
async function confirmSendDecl(){
  const text=$('declText')?$('declText').value.trim():'';
  if(!text||text.length<3)return showToast('Escreva pelo menos 3 caracteres.');
  try{
    const r=await fetch('/api/declaration/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId:state.currentRelation.relationId,fromUserId:state.userId,text})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Declaração publicada!');haptic([50,30,50]);
    $('declModal').classList.add('hidden');$('declModal').innerHTML='';
  }catch(e){showToast('Erro ao publicar.')}
}

// ═══ ADDRESS REQUEST (in chat) ═══
function showAddressRequest(gift){
  const area=$('contactRequestArea');
  let html='<div class="addr-request" id="addrReq-'+gift.id+'">';
  html+='<div class="addr-request-text">'+esc(gift.fromName)+' quer te presentear com <strong>'+gift.emoji+' '+esc(gift.giftName)+'</strong>!'+(gift.message?' "'+esc(gift.message)+'"':'')+'</div>';
  html+='<div class="addr-request-note">Seu endereço NÃO é passado para essa pessoa. A plataforma cuida da entrega.</div>';
  html+='<input class="addr-input" id="addrInput-'+gift.id+'" placeholder="Seu endereço completo para entrega">';
  html+='<div class="addr-actions">';
  html+='<button class="addr-btn accept" onclick="respondAddress(\''+gift.id+'\',true)">Aceitar &#x1F4E6;</button>';
  html+='<button class="addr-btn decline" onclick="respondAddress(\''+gift.id+'\',false)">Não, obrigado</button>';
  html+='</div></div>';
  area.innerHTML+=html;
}
async function respondAddress(giftId,accepted){
  const addrEl=$('addrInput-'+giftId);
  const address=addrEl?addrEl.value.trim():'';
  if(accepted&&!address)return showToast('Digite seu endereço para receber.');
  try{
    await fetch('/api/gift/address-response',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({giftId,userId:state.userId,accepted,address:accepted?address:null})});
    const el=$('addrReq-'+giftId);if(el)el.remove();
    showToast(accepted?'Endereço enviado! Presente a caminho.':'Presente recusado.');haptic([50]);
  }catch(e){showToast('Erro.')}
}

// ═══ HISTORY CARD SAVE/SHARE ═══
function saveHistoryCard(idx){
  const e=window._historyData&&window._historyData[idx];if(!e)return;
  const c=document.createElement('canvas');c.width=600;c.height=400;const ctx=c.getContext('2d');
  // BG
  const grad=ctx.createLinearGradient(0,0,0,400);grad.addColorStop(0,'#0a0a12');grad.addColorStop(.5,'#15152a');grad.addColorStop(1,'#0a0a12');
  ctx.fillStyle=grad;roundRect(ctx,0,0,600,400,20);ctx.fill();
  // Accent top
  const acG=ctx.createLinearGradient(0,0,600,0);acG.addColorStop(0,'#ff6b35');acG.addColorStop(1,'#ff3d71');
  ctx.fillStyle=acG;ctx.fillRect(0,0,600,3);
  // Logo
  ctx.fillStyle='#ff6b35';ctx.font='bold 11px Inter,sans-serif';ctx.letterSpacing='4px';ctx.fillText('Touch?',30,35);ctx.letterSpacing='0px';
  // Avatar circle
  const color=e.withColor||nickColor(e.withName||'??');
  ctx.beginPath();ctx.arc(300,120,35,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 22px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText((e.withName||'??').slice(0,2).toUpperCase(),300,120);ctx.textBaseline='alphabetic';
  // Name
  ctx.fillStyle='#f5f5f7';ctx.font='600 18px Inter,sans-serif';ctx.fillText(e.withName||'Alguém',300,185);
  // Date
  const d=new Date(e.timestamp);
  ctx.fillStyle='#555568';ctx.font='12px Inter,sans-serif';ctx.fillText(pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear()+' '+pad(d.getHours())+':'+pad(d.getMinutes()),300,210);
  // Phrase
  if(e.phrase){ctx.fillStyle='#8888a0';ctx.font='italic 16px Inter,sans-serif';
    const words=e.phrase.split(' ');let line='',y=260;
    words.forEach(w=>{const test=line+w+' ';if(ctx.measureText(test).width>460&&line){ctx.fillText('"'+line.trim()+'"',300,y);y+=24;line=w+' '}else line=test});
    if(line)ctx.fillText(line===e.phrase+' '?'"'+line.trim()+'"':line.trim(),300,y);
  }
  // Footer
  ctx.fillStyle='#555568';ctx.font='9px Inter,sans-serif';ctx.letterSpacing='3px';ctx.fillText('TUDO NASCE NO GESTO',300,375);ctx.letterSpacing='0px';ctx.textAlign='left';
  // Download
  c.toBlob(blob=>{const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='touch-encontro-'+(idx+1)+'.png';a.click();URL.revokeObjectURL(url);showToast('Card salvo!');haptic([50,30,50])},'image/png');
}
function shareHistoryCard(idx){
  const e=window._historyData&&window._historyData[idx];if(!e)return;
  const text='"'+(e.phrase||'')+'" — encontro com '+e.withName+' via Touch?';
  if(navigator.share){navigator.share({title:'Touch?',text}).catch(()=>{})}
  else{navigator.clipboard.writeText(text).then(()=>showToast('Copiado!')).catch(()=>{})}
}

// ═══ EXPIRE CARD ═══
function showExpireCard(){if(!state.currentRelation)return;$('cardPhrase').textContent=state.currentRelation.phrase;const cr=state.currentRelation.createdAt||(state.currentRelation.expiresAt-86400000);$('cardTime').textContent=Math.round((state.currentRelation.expiresAt-cr)/3600000)+'h juntos';showScreen('expireCard')}
async function shareCard(){const text='"'+state.currentRelation.phrase+'" — Touch?';if(navigator.share){try{await navigator.share({title:'Touch?',text})}catch(e){}}else{try{await navigator.clipboard.writeText(text);showToast('Copiado!')}catch(e){}}}

// ═══ SOUND & HAPTICS ═══
let audioCtx=null;
function playSound(type){
  try{if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')audioCtx.resume();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sine';const t=audioCtx.currentTime;
  if(type==='send'){o.frequency.setValueAtTime(600,t);o.frequency.exponentialRampToValueAtTime(900,t+.08);g.gain.setValueAtTime(.06,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12)}
  else if(type==='receive'){o.frequency.setValueAtTime(500,t);o.frequency.exponentialRampToValueAtTime(700,t+.1);g.gain.setValueAtTime(.05,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.start(t);o.stop(t+.15)}
  else if(type==='connect'){o.frequency.setValueAtTime(523,t);o.frequency.setValueAtTime(659,t+.12);o.frequency.setValueAtTime(784,t+.24);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4)}
  else if(type==='pulse'){o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(200,t+.3);g.gain.setValueAtTime(.08,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4)}
  }catch(e){}
}
// Haptic vibration — robust for web
let _vibrationTested=false;
function haptic(p){
  try{
    if('vibrate' in navigator){
      navigator.vibrate(p);
      _vibrationTested=true;
    }
  }catch(e){}
}
// Try to activate vibration on first user interaction
document.addEventListener('click',function _activateVibration(){
  if(!_vibrationTested&&'vibrate' in navigator){
    try{navigator.vibrate(1)}catch(e){}
    _vibrationTested=true;
  }
  document.removeEventListener('click',_activateVibration);
},{once:true});
document.addEventListener('touchstart',function _activateVibrationTouch(){
  if(!_vibrationTested&&'vibrate' in navigator){
    try{navigator.vibrate(1)}catch(e){}
    _vibrationTested=true;
  }
  document.removeEventListener('touchstart',_activateVibrationTouch);
},{once:true});

// ═══ HOME MOTIVATION ═══
const HOME_PHRASES=[
  'Nada acontece\nà distância.',
  'Quem toca\ndescobre.',
  'Presença é\na moeda rara.',
  'O encontro\né o começo.',
  'Hoje é feito\nde gestos.',
  'A conexão\nvive no toque.',
  'Não espere.\nTouch.',
  'Cada encontro\ndeixa marca.',
  'O melhor momento\né o presente.',
  'Proximidade\nmuda tudo.'
];
function setHomeMotivation(){
  const el=$('homeMotivation');
  if(!el)return;
  const p=HOME_PHRASES[Math.floor(Math.random()*HOME_PHRASES.length)];
  el.innerHTML=p.replace('\n','<br>');
}

// ═══ UTILS ═══
function showToast(msg){const t=$('toast');t.textContent=msg;t.classList.remove('hidden');t.style.animation='none';t.offsetHeight;t.style.animation='toast-in .35s cubic-bezier(.22,1,.36,1) forwards';clearTimeout(t._t);t._t=setTimeout(()=>{t.style.animation='toast-out .3s ease forwards';setTimeout(()=>t.classList.add('hidden'),300)},2500)}
function esc(text){const d=document.createElement('div');d.textContent=text;return d.innerHTML}
function pad(n){return n.toString().padStart(2,'0')}
function updateSendBtn(){$('sendBtn').classList.toggle('active',$('chatInput').value.trim().length>0)}

// ═══ SELFIE AT CONNECTION (v2 — inline, no separate step) ═══
let selfieStream=null;
function releaseSelfieCamera(){
  if(selfieStream){selfieStream.getTracks().forEach(t=>t.stop());selfieStream=null}
  const v=$('selfieVideo');if(v){v.srcObject=null;v.style.display='none'}
}
function releaseAllMedia(){
  // Stop sonic (mic + speaker)
  if(homeSonicActive)stopHomeSonic();
  if(sonicActive)stopSonicMode();
  // Stop selfie camera
  releaseSelfieCamera();
}
function revealCaptureSelfie(){
  const btn=$('selfieCapBtn');
  // If camera already active, capture
  if(selfieStream){
    const v=$('selfieVideo'),c=$('selfieCanvas');
    c.width=400;c.height=400;const ctx=c.getContext('2d');
    const s=Math.min(v.videoWidth,v.videoHeight);const sx=(v.videoWidth-s)/2,sy=(v.videoHeight-s)/2;
    ctx.drawImage(v,sx,sy,s,s,0,0,400,400);
    const dataUrl=c.toDataURL('image/jpeg',0.7);
    if(selfieStream){selfieStream.getTracks().forEach(t=>t.stop());selfieStream=null}
    v.style.display='none';
    $('selfiePreview').innerHTML='<img src="'+dataUrl+'" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--ok)">';
    $('selfiePreview').style.display='block';
    btn.innerHTML='<span class="rv-ico">&#x2714;</span> Salvo';btn.disabled=true;btn.style.borderColor='var(--ok)';btn.style.color='var(--ok)';
    if(state.currentRelation){
      fetch('/api/selfie/'+state.currentRelation.relationId,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,selfieData:dataUrl})}).catch(()=>{});
    }
    haptic([50,30,50]);
    return;
  }
  // Open camera inline
  if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){
    navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false}).then(stream=>{
      selfieStream=stream;const v=$('selfieVideo');v.srcObject=stream;v.style.display='block';
      btn.innerHTML='<span class="rv-ico">&#x1F4F8;</span> Capturar';
    }).catch(()=>{
      // Fallback: file picker
      const input=document.createElement('input');input.type='file';input.accept='image/*';input.capture='user';
      input.onchange=()=>{
        const file=input.files[0];if(!file)return;
        const reader=new FileReader();reader.onload=()=>{
          const img=new Image();img.onload=()=>{
            const c=document.createElement('canvas'),ctx=c.getContext('2d');
            c.width=400;c.height=400;const sc=Math.max(400/img.width,400/img.height);
            ctx.drawImage(img,(400-img.width*sc)/2,(400-img.height*sc)/2,img.width*sc,img.height*sc);
            const dataUrl=c.toDataURL('image/jpeg',.7);
            $('selfiePreview').innerHTML='<img src="'+dataUrl+'" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--ok)">';
            $('selfiePreview').style.display='block';
            btn.innerHTML='<span class="rv-ico">&#x2714;</span> Salvo';btn.disabled=true;btn.style.borderColor='var(--ok)';btn.style.color='var(--ok)';
            if(state.currentRelation)fetch('/api/selfie/'+state.currentRelation.relationId,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,selfieData:dataUrl})}).catch(()=>{});
            haptic([50,30,50]);
          };img.src=reader.result;
        };reader.readAsDataURL(file);
      };input.click();
    });
  }else{
    // No camera API - use file picker
    const input=document.createElement('input');input.type='file';input.accept='image/*';input.capture='user';
    input.onchange=()=>{
      const file=input.files[0];if(!file)return;
      const reader=new FileReader();reader.onload=()=>{
        $('selfiePreview').innerHTML='<img src="'+reader.result+'" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--ok)">';
        $('selfiePreview').style.display='block';
        btn.innerHTML='<span class="rv-ico">&#x2714;</span> Salvo';btn.disabled=true;
        haptic([50,30,50]);
      };reader.readAsDataURL(file);
    };input.click();
  }
}

// ═══ CONTACT REQUESTS ═══
function openContactMenu(){
  const area=$('contactRequestArea');
  if(area.innerHTML){area.innerHTML='';return}
  const types=[
    {id:'instagram',emoji:'📸',label:'Instagram'},
    {id:'whatsapp',emoji:'💬',label:'WhatsApp'},
    {id:'x',emoji:'𝕏',label:'X / Twitter'},
    {id:'email',emoji:'📧',label:'Email'},
    {id:'foto',emoji:'📷',label:'Foto'}
  ];
  let html='<div class="contact-menu">';
  types.forEach(t=>{
    html+='<button type="button" class="contact-opt" onclick="requestContact(\''+t.id+'\')">'+t.emoji+' '+t.label+'</button>';
  });
  html+='</div>';
  area.innerHTML=html;
}
async function requestContact(type){
  if(!state.currentRelation)return;
  $('contactRequestArea').innerHTML='';
  try{
    await fetch('/api/request-contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId:state.currentRelation.relationId,fromUserId:state.userId,contactType:type})});
    showToast('Pedido enviado!');haptic([50]);
  }catch(e){showToast('Erro.')}
}
function showContactRequest(data){
  const area=$('contactRequestArea');
  const labels={instagram:'Instagram',whatsapp:'WhatsApp',x:'X / Twitter',email:'Email',foto:'Foto'};
  const emojis={instagram:'📸',whatsapp:'💬',x:'𝕏',email:'📧',foto:'📷'};
  let html='<div class="contact-req-banner" id="contactReq-'+data.requestId+'">';
  html+='<div class="contact-req-text">'+esc(data.from.name)+' quer seu <strong>'+emojis[data.contactType]+' '+(labels[data.contactType]||data.contactType)+'</strong></div>';
  if(data.contactType!=='foto'){
    html+='<input class="contact-req-input" id="contactVal-'+data.requestId+'" placeholder="Seu '+(labels[data.contactType]||'')+'">';
  }
  html+='<div class="contact-req-actions">';
  html+='<button type="button" class="addr-btn accept" onclick="respondContact(\''+data.requestId+'\',\''+data.relationId+'\',\''+data.contactType+'\',true)">Compartilhar</button>';
  html+='<button type="button" class="addr-btn decline" onclick="respondContact(\''+data.requestId+'\',\''+data.relationId+'\',\''+data.contactType+'\',false)">Não</button>';
  html+='</div></div>';
  area.innerHTML+=html;
}
async function respondContact(reqId,relationId,contactType,accepted){
  const valEl=$('contactVal-'+reqId);
  const value=valEl?valEl.value.trim():'';
  if(accepted&&contactType!=='foto'&&!value)return showToast('Preencha o campo.');
  try{
    await fetch('/api/respond-contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relationId,toUserId:state.userId,contactType,accepted,value:accepted?value:null})});
    const el=$('contactReq-'+reqId);if(el)el.remove();
    showToast(accepted?'Compartilhado!':'Recusado.');
  }catch(e){showToast('Erro.')}
}

// ═══ ENCOSTA REQUEST (digital - needs acceptance) ═══
function showEncostaRequest(data){
  const area=$('encostaReqArea');
  const color=data.from.color||nickColor(data.from.name||'??');
  let html='<div class="encosta-req-banner" id="encostaReq-'+data.requestId+'">';
  html+='<div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem">'+makeAvatar(data.from.name,color,38,data.from.profilePhoto||data.from.photoURL||null);
  html+='<div><div class="encosta-req-title">'+esc(data.from.name)+' quer conectar</div>';
  html+='<div class="encosta-req-sub">📍 '+esc(data.eventName)+'</div></div></div>';
  html+='<div class="encosta-req-actions">';
  html+='<button type="button" class="bp" style="flex:1;font-size:.82rem" onclick="acceptEncostaReq(\''+data.requestId+'\',\''+data.eventId+'\',\''+data.from.id+'\',true)">Aceitar</button>';
  html+='<button type="button" class="bs" style="flex:1;font-size:.82rem" onclick="acceptEncostaReq(\''+data.requestId+'\',\''+data.eventId+'\',\''+data.from.id+'\',false)">Recusar</button>';
  html+='</div></div>';
  area.innerHTML=html;
  haptic([100,50,100]);playSound('receive');
}
async function acceptEncostaReq(reqId,eventId,fromUserId,accepted){
  const el=$('encostaReq-'+reqId);if(el)el.remove();
  if(!accepted){
    try{await fetch('/api/event/encosta-accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,eventId,fromUserId,accepted:false})})}catch(e){}
    showToast('Recusado.');return;
  }
  try{
    const r=await fetch('/api/event/encosta-accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,eventId,fromUserId,accepted:true})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    haptic([80,40,80,40,80]);playSound('connect');
    state.currentRelation=d;
    const partner=(d.userA.id===state.userId)?d.userB:d.userA;
    state.currentPartnerId=partner.id;
    showScreen('encounter');showPhase('phaseReveal');
    doReveal(d);
  }catch(e){showToast('Erro ao conectar.')}
}

// ═══ LOCATION / EVENTS ═══
let locWatchId=null,myLat=null,myLng=null,locTab='nearby';
function openLocationScreen(){
  showScreen('locationScreen');
  $('locStatus').className='loc-status';
  $('locStatus').innerHTML='&#x1F50D; '+i18n('loc_searching');
  $('locContent').innerHTML='';
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      myLat=pos.coords.latitude;myLng=pos.coords.longitude;
      onLocationReady('gps');
      if(locWatchId)navigator.geolocation.clearWatch(locWatchId);
      locWatchId=navigator.geolocation.watchPosition(p=>{myLat=p.coords.latitude;myLng=p.coords.longitude;updateLocationOnServer()},{},{enableHighAccuracy:true,maximumAge:30000});
    },()=>fetchApproxLocation(),{enableHighAccuracy:true,timeout:8000});
  }else fetchApproxLocation();
}
function fetchApproxLocation(){
  // Try multiple IP geolocation services
  fetch('https://ipapi.co/json/',{signal:AbortSignal.timeout(5000)}).then(r=>r.json()).then(d=>{
    if(d.latitude&&d.longitude){myLat=d.latitude;myLng=d.longitude;onLocationReady('approx')}
    else return Promise.reject();
  }).catch(()=>{
    // Fallback: ip-api.com
    fetch('http://ip-api.com/json/?fields=lat,lon',{signal:AbortSignal.timeout(5000)}).then(r=>r.json()).then(d=>{
      if(d.lat&&d.lon){myLat=d.lat;myLng=d.lon;onLocationReady('approx')}
      else onLocationFail();
    }).catch(()=>onLocationFail());
  });
}
function onLocationReady(mode){
  $('locStatus').className='loc-status active';
  $('locStatus').innerHTML=mode==='gps'?'&#x1F4CD; '+i18n('loc_active'):'&#x1F4CD; Localização aproximada (via rede)';
  updateLocationOnServer();
  loadLocTab();
}
function onLocationFail(){
  $('locStatus').className='loc-status error';
  $('locStatus').innerHTML='&#x1F6AB; GPS indisponível';
  let html='<div class="loc-empty"><div class="loc-empty-icon">&#x1F4CD;</div>';
  html+='Sem localização disponível.<br><small style="color:var(--t3)">No notebook o GPS pode não funcionar.<br>No celular com HTTPS funcionará.</small>';
  html+='<br><br><button type="button" class="bp" style="font-size:.8rem;max-width:240px;margin:0 auto" onclick="showCreateEventManual()">&#x1F4CD; Criar evento manualmente</button>';
  html+='</div>';
  $('locContent').innerHTML=html;
}
async function updateLocationOnServer(){
  if(!myLat||!state.userId)return;
  try{await fetch('/api/location/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,lat:myLat,lng:myLng})})}catch(e){}
}
function switchLocTab(tab){
  locTab=tab;
  $('tabNearby').classList.toggle('active',tab==='nearby');
  $('tabEvents').classList.toggle('active',tab==='events');
  loadLocTab();
}
function loadLocTab(){if(locTab==='nearby')loadNearbyPeople();else loadNearbyEvents()}
async function loadNearbyPeople(){
  const c=$('locContent');
  if(!myLat){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3)">'+i18n('loc_activate')+'</div>';return}
  c.innerHTML='<div style="text-align:center;padding:1rem;color:var(--t3)">'+i18n('loc_loading')+'</div>';
  try{
    const r=await fetch('/api/nearby/'+state.userId+'?radius=1000');
    const people=await r.json();
    if(!people.length){c.innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x1F465;</div>'+i18n('loc_no_people')+'</div>';return}
    let html='';
    people.forEach(p=>{
      const color=p.color||nickColor(p.nickname||p.name||'??');
      const nick=p.nickname||p.name||'?';
      const dist=p.distance<1000?Math.round(p.distance)+'m':((p.distance/1000).toFixed(1))+'km';
      html+='<div class="loc-person">';
      html+=makeAvatar(nick,color,36,p.profilePhoto||null);
      html+='<div class="loc-person-info"><div class="loc-person-nick">'+esc(nick)+'</div><div class="loc-person-dist">'+dist+'</div>';
      if(p.score||p.stars)html+='<div class="loc-person-pts">'+(p.score?'&#x26A1;'+p.score:'')+(p.stars?' ⭐'+p.stars:'')+'</div>';
      html+='</div>';
      html+='<button class="loc-encosta-btn" onclick="encostaFromLocation(\''+p.id+'\')">'+i18n('loc_encosta')+'</button>';
      html+='</div>';
    });
    c.innerHTML=html;
  }catch(e){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--err)">Erro ao buscar.</div>'}
}
async function loadNearbyEvents(){
  const c=$('locContent');
  if(!myLat){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--t3)">'+i18n('loc_activate')+'</div>';return}
  c.innerHTML='<div style="text-align:center;padding:1rem;color:var(--t3)">'+i18n('loc_loading')+'</div>';
  try{
    const r=await fetch('/api/events/nearby?lat='+myLat+'&lng='+myLng+'&radius=5000');
    const events=await r.json();
    if(!events.length){c.innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x1F389;</div>'+i18n('loc_no_events')+'<br><span style="font-size:.72rem;color:var(--ac);cursor:pointer" onclick="showCreateEvent()">'+i18n('create_event_btn')+'</span></div>';return}
    let html='';
    events.forEach(ev=>{
      const dist=ev.distance<1000?Math.round(ev.distance)+'m':((ev.distance/1000).toFixed(1))+'km';
      html+='<div class="evt-card" onclick="openEventDetail(\''+ev.id+'\')">';
      html+='<div class="evt-card-name">'+esc(ev.name)+'</div>';
      html+='<div class="evt-card-meta"><span>📍 '+dist+'</span><span>'+esc(ev.participantCount||0)+' '+i18n('evt_people')+'</span></div>';
      if(ev.description)html+='<div class="evt-card-desc">'+esc(ev.description)+'</div>';
      html+='</div>';
    });
    c.innerHTML=html;
  }catch(e){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--err)">Erro ao buscar.</div>'}
}
function showCreateEvent(){
  _renderEventForm();
}
function showCreateEventManual(){
  _renderEventForm();
}
function _renderEventForm(){
  // Try to get location first if we don't have it
  if(!myLat&&navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      myLat=pos.coords.latitude;myLng=pos.coords.longitude;
    },()=>{},{enableHighAccuracy:true,timeout:5000});
  }
  let html='<div class="loc-create-form">';
  html+='<div class="form-title">&#x1F4CD; '+i18n('create_event_title')+'</div>';
  html+='<div class="form-sub">Crie um ponto de encontro digital em um local físico. Quem estiver por perto poderá entrar e se conectar.</div>';
  if(myLat){
    html+='<div style="font-size:.65rem;color:var(--ok);margin-bottom:.6rem">📍 Localização detectada ('+myLat.toFixed(4)+', '+myLng.toFixed(4)+')</div>';
  }else{
    html+='<div style="font-size:.65rem;color:var(--ac2);margin-bottom:.6rem">📍 Sem GPS — insira as coordenadas manualmente</div>';
  }
  html+='<div class="loc-fg"><label>'+i18n('evt_name')+'</label><input type="text" id="evtName" maxlength="60" placeholder="'+i18n('evt_name_ph')+'"></div>';
  html+='<div class="loc-fg"><label>'+i18n('evt_desc')+'</label><textarea id="evtDesc" maxlength="200" placeholder="'+i18n('evt_desc_ph')+'"></textarea></div>';
  html+='<div class="loc-fg"><label>Latitude</label><input type="text" id="evtLat" value="'+(myLat||'')+'" placeholder="-23.550520"></div>';
  html+='<div class="loc-fg"><label>Longitude</label><input type="text" id="evtLng" value="'+(myLng||'')+'" placeholder="-46.633308"></div>';
  html+='<div style="font-size:.62rem;color:var(--t3);margin:-.4rem 0 .6rem;line-height:1.4">Dica: busque no Google Maps, clique no local e copie as coordenadas. Se o GPS estiver ativo, as coordenadas são preenchidas automaticamente.</div>';
  html+='<div class="loc-fg"><label>&#x1F4E1; '+i18n('evt_radius')+'</label>';
  html+='<div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.3rem">';
  ['50','100','200','500','1000'].forEach(r=>{
    const sel=r==='200'?'background:var(--ac);color:#fff;border-color:var(--ac)':'';
    html+='<button type="button" class="bs radius-opt" style="font-size:.68rem;padding:.3rem .6rem;'+sel+'" onclick="selectRadius(this,'+r+')">'+r+'m</button>';
  });
  html+='</div><input type="hidden" id="evtRadius" value="200"></div>';
  html+='<div style="display:flex;gap:.6rem;margin-top:.3rem"><button type="button" class="bp" style="flex:1" onclick="createEvent()">'+i18n('evt_create')+'</button><button type="button" class="bs" style="flex:1" onclick="loadLocTab()">'+i18n('evt_cancel')+'</button></div>';
  html+='</div>';
  $('locContent').innerHTML=html;
  setTimeout(()=>{const n=$('evtName');if(n)n.focus()},100);
}
function selectRadius(btn,val){
  document.querySelectorAll('.radius-opt').forEach(b=>{b.style.background='';b.style.color='';b.style.borderColor=''});
  btn.style.background='var(--ac)';btn.style.color='#fff';btn.style.borderColor='var(--ac)';
  $('evtRadius').value=val;
}
async function createEvent(){
  const name=$('evtName')?$('evtName').value.trim():'';
  const desc=$('evtDesc')?$('evtDesc').value.trim():'';
  const radius=parseInt($('evtRadius')?$('evtRadius').value:'200')||200;
  if(!name||name.length<3)return showToast(i18n('evt_name_err'));
  // Use GPS coords or manual input
  let lat=myLat,lng=myLng;
  if($('evtLat')){lat=parseFloat($('evtLat').value);lng=parseFloat($('evtLng').value)}
  if(!lat||!lng||isNaN(lat)||isNaN(lng))return showToast('Coordenadas inválidas.');
  try{
    const r=await fetch('/api/event/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId,name,description:desc,lat,lng,radius})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast(i18n('evt_created'));haptic([50,30,50]);
    const evtId=d.event?d.event.id:d.id;
    openEventDetail(evtId);
  }catch(e){showToast('Erro ao criar evento.')}
}
async function openEventDetail(eventId){
  showScreen('eventDetail');
  $('evtDetailScroll').innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x23F3;</div>'+i18n('loc_loading')+'</div>';
  try{
    const r=await fetch('/api/event/'+eventId);
    const ev=await r.json();
    if(ev.error){showToast(ev.error);return}
    $('evtDetailTitle').textContent=ev.name;
    const parts=ev.participantsData||ev.participants||[];
    const alreadyIn=parts.some(p=>p.id===state.userId);
    const pCount=parts.length;
    let html='<div class="evt-detail">';
    html+='<div class="evt-detail-name">'+esc(ev.name)+'</div>';
    if(ev.description)html+='<div class="evt-detail-desc">"'+esc(ev.description)+'"</div>';
    html+='<div style="display:flex;gap:.6rem;align-items:center;font-size:.68rem;color:var(--t3);margin-bottom:.8rem">';
    html+='<span>&#x1F4E1; '+ev.radius+'m</span>';
    html+='<span>&#x1F465; '+pCount+' '+i18n('evt_people')+'</span>';
    html+='</div>';
    if(!alreadyIn){
      html+='<button class="bp" style="font-size:.82rem" onclick="joinEvent(\''+eventId+'\')">&#x1F91D; '+i18n('evt_join')+'</button>';
    }else{
      html+='<div style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;color:var(--ok);padding:.5rem .7rem;background:rgba(52,211,153,.06);border-radius:10px;border:1px solid rgba(52,211,153,.15)">&#x2714; '+i18n('evt_joined')+'</div>';
    }
    html+='</div>';
    html+='<div class="evt-ppl-title">'+i18n('evt_participants')+' ('+pCount+')</div>';
    if(pCount>0){
      parts.forEach(p=>{
        const color=p.color||nickColor(p.nickname||p.name||'??');
        const nick=p.nickname||p.name||'?';
        const isMe=p.id===state.userId;
        html+='<div class="loc-person">';
        html+=makeAvatar(nick,color,34,p.profilePhoto||null);
        html+='<div class="loc-person-info"><div class="loc-person-nick">'+esc(nick)+(isMe?' <span style="font-size:.62rem;color:var(--ok)">('+i18n('evt_you')+')</span>':'')+'</div></div>';
        if(!isMe&&alreadyIn)html+='<button class="loc-encosta-btn" onclick="encostaAtEvent(\''+eventId+'\',\''+p.id+'\')">'+i18n('loc_encosta')+'</button>';
        html+='</div>';
      });
    }else html+='<div class="loc-empty"><div class="loc-empty-icon">&#x1F3C3;</div>'+i18n('evt_nobody')+'</div>';
    $('evtDetailScroll').innerHTML=html;
  }catch(e){$('evtDetailScroll').innerHTML='<div class="loc-empty"><div class="loc-empty-icon">&#x26A0;</div>Erro ao carregar evento.</div>'}
}
async function joinEvent(eventId){
  try{
    const r=await fetch('/api/event/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId,userId:state.userId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast(i18n('evt_joined_msg'));haptic([50,30,50]);
    openEventDetail(eventId);
  }catch(e){showToast('Erro.')}
}
async function encostaAtEvent(eventId,partnerId){
  try{
    const r=await fetch('/api/event/encosta-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId,userId:state.userId,targetId:partnerId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    showToast('Pedido enviado! Aguardando aceite...');haptic([50,30,50]);
  }catch(e){showToast('Erro ao conectar.')}
}
async function encostaFromLocation(targetId){
  // Start encounter via proximity - create a session and auto-match
  try{
    const r=await fetch('/api/session/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
    const d=await r.json();
    if(d.error)return showToast(d.error);
    // now the target joins
    const r2=await fetch('/api/session/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:d.code,userId:targetId})});
    const d2=await r2.json();
    if(d2.error)return showToast(d2.error);
    showToast(i18n('evt_encosta_ok'));haptic([80,40,80,40,80]);
    goHome();refreshHome();
  }catch(e){showToast('Erro ao conectar.')}
}

// ═══ i18n ═══
const LANG={
pt:{
  loc_btn:'Localização',ticket_btn:'Meu Bilhete',loc_title:'Explorar ao redor',
  create_event_btn:'+ Evento',loc_activate:'Ative sua localização para descobrir pessoas e eventos.',
  loc_searching:'Buscando localização...',loc_active:'📍 Localização ativa',
  loc_denied:'Localização negada. Permita no navegador.',tab_nearby:'Pessoas',tab_events:'Eventos',
  loc_loading:'Carregando...',loc_no_people:'Ninguém por perto no momento.',
  loc_no_events:'Nenhum evento por perto.',loc_encosta:'Touch',loc_need_gps:'Ative o GPS primeiro.',
  create_event_title:'Criar um evento',evt_name:'Nome',evt_name_ph:'Ex: Café no centro',
  evt_desc:'Descrição',evt_desc_ph:'Opcional...',evt_radius:'Raio',evt_create:'Criar',evt_cancel:'Cancelar',
  evt_name_err:'Nome precisa ter pelo menos 3 caracteres.',evt_created:'Evento criado!',
  evt_join:'Entrar neste evento',evt_joined:'Você está aqui',evt_joined_msg:'Você entrou no evento!',
  evt_participants:'Participantes',evt_you:'você',evt_nobody:'Ninguém ainda. Seja o primeiro!',
  evt_people:'pessoas',evt_encosta_ok:'Touch! Nova conexão criada.',
  // Home
  brand_name:'Touch?',brand_tag:'tudo nasce no gesto',
  home_greeting:'Olá',home_motto:'Nada acontece<br>à distância.',home_btn:'TOUCH',
  home_footer:'Tocar cria algo. Não tocar faz sumir.',
  sonic_searching:'Emitindo som ultrassônico...',sonic_approach:'Aproxime os celulares...',sonic_fallback:'Aproxime os celulares ou use código',
  // Register
  reg_title:'Touch?',reg_sub:'crie sua presença',reg_nick_hint:'escolha um apelido criativo',
  reg_nick:'Nickname',reg_birth:'Data de nascimento',
  reg_terms:'Entendo e aceito que <strong>todas as relações aqui são temporárias</strong>. Nada persiste sem encontro.',
  reg_btn:'ENTRAR',
  // Encounter
  enc_how:'Como vão se encontrar?',enc_create:'Criar encontro',enc_join:'Entrar com código',
  enc_share:'Compartilhe esse código:',enc_waiting:'Esperando alguém conectar...',
  enc_code_ph:'CÓDIGO',enc_join_btn:'TOUCH',
  // Reveal
  rev_phrase:'Uma frase para começar:',
  // Chat
  chat_msg_ph:'Diga algo que valha 24h...',chat_expired:'Esta conexão expirou.',
  // Profile
  pf_decl:'Declarações',pf_gifts:'Presentes recebidos',pf_empty_decl:'Nenhuma declaração ainda.',
  pf_empty_gift:'Nenhum presente ainda.',
  // Gift
  gift_title:'Escolha um presente',gift_msg_ph:'Mensagem (opcional)',gift_send:'Enviar presente',
  gift_needs_addr:'Requer endereço (pediremos permissão)',gift_sent:'Presente enviado!',
  // Decl
  decl_title:'Declaração',decl_sub:'Escreva algo para ficar no perfil dessa pessoa. Todos que se conectarem a ela poderão ler.',
  decl_ph:'Escreva sua declaração...',decl_publish:'Publicar',decl_min:'Escreva pelo menos 3 caracteres.',
  decl_ok:'Declaração publicada!',
  // Boarding
  bp_title:'Touch? Pass',bp_encounters:'encontros',bp_since:'desde',bp_save:'Salvar Imagem',
  // History
  hist_title:'Constelação',hist_empty:'Nenhum encontro ainda.',hist_save:'Salvar',hist_share:'Compartilhar'
},
en:{
  loc_btn:'Location',ticket_btn:'My Ticket',loc_title:'Explore nearby',
  create_event_btn:'+ Event',loc_activate:'Enable your location to discover people and events.',
  loc_searching:'Searching location...',loc_active:'📍 Location active',
  loc_denied:'Location denied. Allow in browser.',tab_nearby:'People',tab_events:'Events',
  loc_loading:'Loading...',loc_no_people:'Nobody nearby right now.',
  loc_no_events:'No events nearby.',loc_encosta:'Touch',loc_need_gps:'Enable GPS first.',
  create_event_title:'Create an event',evt_name:'Name',evt_name_ph:'E.g.: Coffee downtown',
  evt_desc:'Description',evt_desc_ph:'Optional...',evt_radius:'Radius',evt_create:'Create',evt_cancel:'Cancel',
  evt_name_err:'Name must be at least 3 characters.',evt_created:'Event created!',
  evt_join:'Join this event',evt_joined:'You are here',evt_joined_msg:'You joined the event!',
  evt_participants:'Participants',evt_you:'you',evt_nobody:'Nobody yet. Be the first!',
  evt_people:'people',evt_encosta_ok:'Touched! New connection created.',
  brand_name:'Touch?',brand_tag:'it all starts with a gesture',
  home_greeting:'Hello',home_motto:'Nothing happens<br>from a distance.',home_btn:'TOUCH',
  home_footer:'Touching creates something. Not touching makes it vanish.',
  sonic_searching:'Emitting ultrasonic sound...',sonic_approach:'Bring phones closer...',sonic_fallback:'Bring phones closer or use code',
  reg_title:'Touch?',reg_sub:'create your presence',reg_nick_hint:'choose a creative alias',
  reg_nick:'Nickname',reg_birth:'Date of birth',
  reg_terms:'I understand and accept that <strong>all relationships here are temporary</strong>. Nothing persists without encounter.',
  reg_btn:'ENTER',
  enc_how:'How will you meet?',enc_create:'Create encounter',enc_join:'Join with code',
  enc_share:'Share this code:',enc_waiting:'Waiting for someone to connect...',
  enc_code_ph:'CODE',enc_join_btn:'TOUCH',
  rev_phrase:'A phrase to begin:',
  chat_msg_ph:'Say something worth 24h...',chat_expired:'This connection has expired.',
  pf_decl:'Declarations',pf_gifts:'Gifts received',pf_empty_decl:'No declarations yet.',
  pf_empty_gift:'No gifts yet.',
  gift_title:'Choose a gift',gift_msg_ph:'Message (optional)',gift_send:'Send gift',
  gift_needs_addr:'Requires address (we\'ll ask permission)',gift_sent:'Gift sent!',
  decl_title:'Declaration',decl_sub:'Write something for this person\'s profile. Everyone who connects with them can read it.',
  decl_ph:'Write your declaration...',decl_publish:'Publish',decl_min:'Write at least 3 characters.',
  decl_ok:'Declaration published!',
  bp_title:'Touch? Ticket',bp_encounters:'encounters',bp_since:'since',bp_save:'Save Image',
  hist_title:'Constellation',hist_empty:'No encounters yet.',hist_save:'Save',hist_share:'Share'
},
es:{
  loc_btn:'Ubicación',ticket_btn:'Mi Boleto',loc_title:'Explorar alrededor',
  create_event_btn:'+ Evento',loc_activate:'Activa tu ubicación para descubrir personas y eventos.',
  loc_searching:'Buscando ubicación...',loc_active:'📍 Ubicación activa',
  loc_denied:'Ubicación denegada. Permite en el navegador.',tab_nearby:'Personas',tab_events:'Eventos',
  loc_loading:'Cargando...',loc_no_people:'Nadie cerca por ahora.',
  loc_no_events:'No hay eventos cerca.',loc_encosta:'Tocar',loc_need_gps:'Activa el GPS primero.',
  create_event_title:'Crear un evento',evt_name:'Nombre',evt_name_ph:'Ej: Café en el centro',
  evt_desc:'Descripción',evt_desc_ph:'Opcional...',evt_radius:'Radio',evt_create:'Crear',evt_cancel:'Cancelar',
  evt_name_err:'El nombre debe tener al menos 3 caracteres.',evt_created:'¡Evento creado!',
  evt_join:'Unirse a este evento',evt_joined:'Estás aquí',evt_joined_msg:'¡Te uniste al evento!',
  evt_participants:'Participantes',evt_you:'tú',evt_nobody:'Nadie aún. ¡Sé el primero!',
  evt_people:'personas',evt_encosta_ok:'¡Tocó! Nueva conexión creada.',
  brand_name:'Touch?',brand_tag:'todo nace en el gesto',
  home_greeting:'Hola',home_motto:'Nada pasa<br>a distancia.',home_btn:'TOCAR',
  home_footer:'Tocar crea algo. No tocar lo hace desaparecer.',
  sonic_searching:'Emitiendo sonido ultrasónico...',sonic_approach:'Acerquen los celulares...',sonic_fallback:'Acerquen los celulares o usen código',
  reg_title:'Touch?',reg_sub:'crea tu presencia',reg_nick_hint:'elige un apodo creativo',
  reg_nick:'Nickname',reg_birth:'Fecha de nacimiento',
  reg_terms:'Entiendo y acepto que <strong>todas las relaciones aquí son temporales</strong>. Nada persiste sin encuentro.',
  reg_btn:'ENTRAR',
  enc_how:'¿Cómo se van a encontrar?',enc_create:'Crear encuentro',enc_join:'Entrar con código',
  enc_share:'Comparte este código:',enc_waiting:'Esperando que alguien conecte...',
  enc_code_ph:'CÓDIGO',enc_join_btn:'TOCAR',
  rev_phrase:'Una frase para empezar:',
  chat_msg_ph:'Di algo que valga 24h...',chat_expired:'Esta conexión expiró.',
  pf_decl:'Declaraciones',pf_gifts:'Regalos recibidos',pf_empty_decl:'Sin declaraciones aún.',
  pf_empty_gift:'Sin regalos aún.',
  gift_title:'Elige un regalo',gift_msg_ph:'Mensaje (opcional)',gift_send:'Enviar regalo',
  gift_needs_addr:'Requiere dirección (pediremos permiso)',gift_sent:'¡Regalo enviado!',
  decl_title:'Declaración',decl_sub:'Escribe algo para el perfil de esta persona. Todos los que se conecten con ella podrán leerlo.',
  decl_ph:'Escribe tu declaración...',decl_publish:'Publicar',decl_min:'Escribe al menos 3 caracteres.',
  decl_ok:'¡Declaración publicada!',
  bp_title:'Touch? Pass',bp_encounters:'encuentros',bp_since:'desde',bp_save:'Guardar Imagen',
  hist_title:'Constelación',hist_empty:'Sin encuentros aún.',hist_save:'Guardar',hist_share:'Compartir'
}
};
let currentLang=localStorage.getItem('touch_lang')||'pt';
function i18n(key){return (LANG[currentLang]&&LANG[currentLang][key])||LANG.pt[key]||key}
function setLang(lang){
  currentLang=lang;
  localStorage.setItem('touch_lang',lang);
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active',b.textContent.trim().toLowerCase()===lang));
  applyLang();
}
function applyLang(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.getAttribute('data-i18n');
    const val=i18n(key);
    if(val)el.innerHTML=val;
  });
  // Update dynamic elements
  const brand=$('homeBrand');if(brand)brand.textContent=i18n('brand_name');
  const btnText=$('mainBtnText');if(btnText&&!homeSonicActive)btnText.textContent=i18n('home_btn');
}

// ═══ GORJETA / TIP ═══
let tipState = { receiverId: null, amount: 0, method: 'pix' };

function showTipScreen(receiverId) {
  tipState = { receiverId, amount: 0, savedCard: null };
  // Reset UI
  document.querySelectorAll('.tip-amount-btn').forEach(b => b.classList.remove('selected'));
  $('tipCustomAmount').value = '';
  $('tipResult').classList.add('hidden');
  $('tipScreen').querySelector('.tip-amounts').style.display = '';
  $('tipScreen').querySelector('.tip-custom').style.display = '';
  $('tipSavedCard').style.display = 'none';
  $('tipNewCard').style.display = 'none';
  $('tipPixSection').style.display = 'none';
  $('tipPayMethods').style.display = '';
  $('tipPixBtn') && ($('tipPixBtn').disabled = true);
  const tipPixQR = $('tipPixQR'); if (tipPixQR) tipPixQR.classList.add('hidden');
  if ($('tipPixEmail')) $('tipPixEmail').value = '';
  if ($('tipPixCPF')) $('tipPixCPF').value = '';
  if ($('tipSavedCVV')) $('tipSavedCVV').value = '';

  // Fetch receiver info
  fetch('/api/user/' + receiverId).then(r => r.json()).then(u => {
    const color = u.color || nickColor(u.nickname || '?');
    const serviceLabel = u.serviceLabel || '';
    const photo = u.profilePhoto || u.photoURL || null;
    const revData = state.revealedIds && state.revealedIds[receiverId];
    const displayPhoto = photo || (revData && revData.profilePhoto) || null;
    const displayName = (revData && revData.realName) || u.nickname || u.name;
    $('tipReceiver').innerHTML =
      makeAvatar(u.nickname || '?', color, 64, displayPhoto) +
      '<div class="tip-receiver-name">' + esc(displayName) + '</div>' +
      (serviceLabel ? '<div class="tip-receiver-service">' + esc(serviceLabel) + '</div>' : '');
  }).catch(() => {});

  // Check for saved card
  fetch('/api/tip/saved-card/' + state.userId).then(r => r.json()).then(d => {
    if (d.hasSaved) {
      tipState.savedCard = d;
      $('tipSavedCardLabel').textContent = d.brand + ' •••• ' + d.lastFour;
      // Update brand icon color
      const brandKey=(d.brand||'').toLowerCase();
      const brandInfo=CARD_BRANDS[brandKey==='mastercard'?'master':brandKey]||null;
      const sbi=$('tipSavedBrandIcon');
      if(sbi&&brandInfo){sbi.style.background=brandInfo.color;sbi.style.color='#fff';sbi.textContent=brandInfo.icon;sbi.title=brandInfo.name}
      else if(sbi){sbi.textContent=(d.brand||'CARD').slice(0,4).toUpperCase()}
      $('tipSavedCard').style.display = '';
      $('tipNewCardToggle').style.display = 'flex';
    } else {
      $('tipSavedCard').style.display = 'none';
      $('tipNewCardToggle').style.display = 'flex';
    }
  }).catch(() => {});

  showScreen('tipScreen');
}

function showNewCardForm() {
  $('tipPayMethods').style.display = 'none';
  $('tipNewCard').style.display = '';
  $('tipCardNumber').value = '';
  $('tipCardExpiry').value = '';
  $('tipCardCVV').value = '';
  $('tipCardHolder').value = '';
  $('tipCardCPF').value = '';
}
function validateSavedCVV() {
  updateTipBtns();
}
function payWithMercadoPago() {
  if (!tipState.amount || tipState.amount < 1) return showToast('Escolha um valor.');
  // Create preference and redirect to MP checkout
  const btn = $('tipMPBtn');
  btn.style.opacity = '.5'; btn.style.pointerEvents = 'none';
  fetch('/api/tip/mp-checkout', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ payerId: state.userId, receiverId: tipState.receiverId, amount: tipState.amount })
  }).then(r => r.json()).then(d => {
    if (d.initPoint) window.location.href = d.initPoint;
    else { showToast('Erro ao abrir Mercado Pago'); btn.style.opacity = '1'; btn.style.pointerEvents = ''; }
  }).catch(() => { showToast('Erro de conexão'); btn.style.opacity = '1'; btn.style.pointerEvents = ''; });
}
// Subscription payment methods
function validateSubCVV() {
  const cvv = $('subSavedCVV').value.replace(/\D/g, '');
  $('subCardPayBtn').disabled = cvv.length < 3;
}
async function subscribeWithCard() {
  const cvv = $('subSavedCVV').value.replace(/\D/g, '');
  if (cvv.length < 3) return showToast('Digite o CVV');
  const btn = $('subCardPayBtn');
  btn.disabled = true; btn.textContent = 'Processando...';
  try {
    const resp = await fetch('/api/subscription/create-card', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: state.userId, planId: 'touch_plus', cvv })
    });
    const result = await resp.json();
    if (result.error) {
      showPayError(translatePayError(result.error,result.detail));
      btn.disabled=false;btn.textContent='Assinar';
      return;
    }
    showToast('Assinatura ativada! ✦');
    haptic([50,30,50,30,50]);
    goHome();refreshHome();
  } catch (e) {
    showPayError(e.message||'Erro ao processar assinatura.');
    btn.disabled = false; btn.textContent = 'Assinar';
  }
}
async function subscribeWithPix() {
  showToast('PIX para assinatura em breve!');
}
function showSubNewCard() {
  showToast('Cadastre um cartão na tela de gorjeta primeiro.');
}
function loadSubSavedCard() {
  fetch('/api/tip/saved-card/' + state.userId).then(r => r.json()).then(d => {
    if (d.hasSaved) {
      $('subSavedCardLabel').textContent = d.brand + ' •••• ' + d.lastFour;
      const brandKey=(d.brand||'').toLowerCase();
      const brandInfo=CARD_BRANDS[brandKey==='mastercard'?'master':brandKey]||null;
      const sbi=$('subSavedBrandIcon');
      if(sbi&&brandInfo){sbi.style.background=brandInfo.color;sbi.style.color='#fff';sbi.textContent=brandInfo.icon}
      else if(sbi){sbi.textContent=(d.brand||'CARD').slice(0,4).toUpperCase()}
      $('subSavedCard').style.display = '';
    }
  }).catch(() => {});
}

function togglePixSection() {
  const sec = $('tipPixSection');
  const show = sec.style.display === 'none';
  sec.style.display = show ? '' : 'none';
  if (show) { $('tipPayMethods').style.display = 'none'; $('tipNewCard').style.display = 'none'; }
  else { $('tipPayMethods').style.display = ''; }
}


function selectTipAmount(val) {
  tipState.amount = val;
  $('tipCustomAmount').value = '';
  document.querySelectorAll('.tip-amount-btn').forEach(b => {
    b.classList.toggle('selected', b.textContent === 'R$' + val);
  });
  updateTipBtns();
}
function selectTipCustom() {
  const v = parseFloat($('tipCustomAmount').value);
  if (v > 0) {
    tipState.amount = v;
    document.querySelectorAll('.tip-amount-btn').forEach(b => b.classList.remove('selected'));
  }
  updateTipBtns();
}
function updateTipBtns() {
  const has = tipState.amount > 0;
  const label = has ? ' R$' + tipState.amount.toFixed(2).replace('.', ',') : '';
  // Saved card + CVV button
  const qpBtn = $('tipQuickPayBtn');
  const cvvVal = $('tipSavedCVV') ? $('tipSavedCVV').value.replace(/\D/g, '') : '';
  if (qpBtn) { qpBtn.disabled = !(has && cvvVal.length >= 3); qpBtn.textContent = has ? 'Pagar' + label : 'Pagar'; }
  // New card button
  const cpBtn = $('tipCardPayBtn');
  if (cpBtn) { cpBtn.disabled = !has; cpBtn.textContent = has ? 'Pagar' + label : 'Pagar'; }
  // PIX button
  const pxBtn = $('tipPixBtn');
  if (pxBtn) { pxBtn.disabled = !has; pxBtn.textContent = has ? 'PIX' + label : 'Gerar PIX'; }
}

// ── Card brand detection + visual feedback ──
const CARD_BRANDS={
  visa:{name:'Visa',color:'#1a1f71',icon:'V',regex:/^4/,lengths:[16],cvv:3},
  master:{name:'Mastercard',color:'#eb001b',icon:'M',regex:/^(5[1-5]|2[2-7])/,lengths:[16],cvv:3},
  amex:{name:'Amex',color:'#006fcf',icon:'A',regex:/^3[47]/,lengths:[15],cvv:4,mask:'amex'},
  elo:{name:'Elo',color:'#000',icon:'E',regex:/^(636368|636297|504175|438935|40117[89]|45763[12]|50904[0-9]|50905[0-9]|50906[0-9]|6277[0-9]{2}|6362[0-9]{2}|6504|6505|6506|6507|6509|6516|6550)/,lengths:[16],cvv:3},
  hipercard:{name:'Hipercard',color:'#8b2131',icon:'H',regex:/^(606282|3841)/,lengths:[16],cvv:3},
  diners:{name:'Diners',color:'#004a97',icon:'D',regex:/^3(0[0-5]|[68])/,lengths:[14],cvv:3}
};
function detectBrand(num){
  const clean=num.replace(/\D/g,'');
  for(const[id,b]of Object.entries(CARD_BRANDS)){
    if(b.regex.test(clean))return{id,...b};
  }
  return null;
}
function updateBrandIcon(inputEl,iconElId){
  const clean=inputEl.value.replace(/\D/g,'');
  const brand=detectBrand(clean);
  const iconEl=document.getElementById(iconElId);
  if(!iconEl)return brand;
  if(brand){
    iconEl.style.background=brand.color;
    iconEl.style.color='#fff';
    iconEl.textContent=brand.icon;
    iconEl.title=brand.name;
  }else{
    iconEl.style.background='linear-gradient(135deg,#1a1a2e,#2d2d44)';
    iconEl.style.color='rgba(255,255,255,.5)';
    iconEl.textContent='CARD';
    iconEl.title='';
  }
  return brand;
}
function formatCardNumber(el) {
  let v = el.value.replace(/\D/g, '');
  const brand=detectBrand(v);
  const maxLen=brand?Math.max(...brand.lengths):16;
  v=v.slice(0,maxLen);
  if(brand&&brand.mask==='amex'){
    // Amex: 4-6-5
    v=v.replace(/(\d{4})(\d{0,6})(\d{0,5})/,'$1 $2 $3').trim();
  }else{
    v=v.replace(/(.{4})/g,'$1 ').trim();
  }
  el.value=v;
  // Update brand icons in all card forms
  updateBrandIcon(el,'tipCardBrandIcon');
  updateBrandIcon(el,'entryCardBrandIcon');
  // Update CVV maxlength
  const cvvLen=brand?brand.cvv:4;
  const cvvEl=el.closest('div')?.parentElement?.querySelector('[id*="CVV"]');
  if(cvvEl)cvvEl.maxLength=cvvLen;
}
function formatExpiry(el) {
  let v = el.value.replace(/\D/g, '').slice(0, 4);
  if (v.length > 2) v = v.slice(0, 2) + '/' + v.slice(2);
  el.value = v;
}

function formatCPF(el) {
  let v = el.value.replace(/\D/g, '').slice(0, 11);
  if (v.length > 9) v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
  else if (v.length > 6) v = v.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
  else if (v.length > 3) v = v.replace(/(\d{3})(\d{1,3})/, '$1.$2');
  el.value = v;
}

// ── PIX Payment ──
async function processPixTip() {
  if (!tipState.amount || tipState.amount < 1) return showToast('Escolha um valor.');
  const cpf = ($('tipPixCPF').value || '').replace(/\D/g, '');
  if (!cpf || cpf.length < 11) return showToast('Informe seu CPF para PIX.');
  const email = $('tipPixEmail').value.trim() || '';
  if (!email) return showToast('Informe seu e-mail.');

  const btn = $('tipPixBtn');
  btn.disabled = true; btn.textContent = 'Gerando PIX...';
  try {
    const resp = await fetch('/api/tip/pix', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ payerId: state.userId, receiverId: tipState.receiverId, amount: tipState.amount, payerEmail: email, payerCPF: cpf })
    });
    const result = await resp.json();
    if (result.error) throw new Error(result.error);

    // Show QR code
    if (result.qrCodeBase64) {
      $('tipPixQRImg').src = 'data:image/png;base64,' + result.qrCodeBase64;
    } else if (result.ticketUrl) {
      $('tipPixQRImg').src = result.ticketUrl;
    }
    $('tipPixCode').value = result.qrCode || '';
    $('tipPixQR').classList.remove('hidden');
    btn.textContent = '✅ PIX gerado!';
    haptic([30, 20, 30]);

    // Poll for payment confirmation
    if (result.tipId) pollTipStatus(result.tipId);
  } catch (e) {
    console.error('PIX error:', e);
    showToast('Erro: ' + (e.message || 'Tente novamente'));
    btn.disabled = false;
    btn.textContent = '⚡ PIX R$' + tipState.amount.toFixed(2).replace('.', ',');
  }
}

function copyPixCode() {
  const code = $('tipPixCode').value;
  if (!code) return showToast('Nenhum código PIX.');
  navigator.clipboard.writeText(code).then(() => showToast('Código PIX copiado!')).catch(() => {
    // Fallback
    const ta = document.createElement('textarea'); ta.value = code; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    showToast('Código PIX copiado!');
  });
  haptic([20]);
}

function pollTipStatus(tipId) {
  let polls = 0;
  const iv = setInterval(async () => {
    polls++;
    if (polls > 60) { clearInterval(iv); return; } // Stop after 5 min
    try {
      const tips = await (await fetch('/api/tips/' + state.userId)).json();
      const tip = tips.find(t => t.id === tipId);
      if (tip && tip.status === 'approved') {
        clearInterval(iv);
        showTipResult('✅', 'PIX confirmado!<br>R$' + tip.amount.toFixed(2).replace('.', ',') + ' chegou.');
        haptic([50, 30, 50, 30, 50]);
      }
    } catch (e) {}
  }, 5000);
}

// ── MP SDK init ──
let mpSdk = null;
async function getMpSdk() {
  if (mpSdk) return mpSdk;
  try {
    const resp = await fetch('/api/mp-public-key');
    const { publicKey } = await resp.json();
    if (!publicKey) throw new Error('No public key');
    mpSdk = new MercadoPago(publicKey);
    return mpSdk;
  } catch (e) { console.error('MP SDK init error:', e); return null; }
}

// ── One-Tap Pay — server-side saved card charge, zero friction ──
async function quickPay() {
  if (!tipState.amount || tipState.amount < 1) return showToast('Escolha um valor.');
  const cvv = $('tipSavedCVV') ? $('tipSavedCVV').value.replace(/\D/g, '') : '';
  if (cvv.length < 3) return showToast('Digite o CVV do cartão.');
  const btn = $('tipQuickPayBtn');
  btn.disabled = true; btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:.3rem"><span class="pay-spinner"></span>Processando...</span>';
  haptic([30]);
  try {
    const resp = await fetch('/api/tip/quick-pay', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ payerId: state.userId, receiverId: tipState.receiverId, amount: tipState.amount, cvv })
    });
    const result = await resp.json();
    if (result.error) {
      if (result.cardExpired) {
        tipState.savedCard = null;
        $('tipSavedCard').style.display = 'none';
        $('tipNewCard').style.display = '';
        showPayError('Cartão expirado ou inválido. Cadastre novamente.');
        return;
      }
      showPayError(translatePayError(result.error,result.detail));
      btn.disabled=false;btn.textContent='Pagar R$'+tipState.amount.toFixed(2).replace('.',',');
      return;
    }
    if (result.status === 'approved') {
      showTipResult('✅', 'Gorjeta enviada!<br>R$' + tipState.amount.toFixed(2).replace('.', ','));
      haptic([50, 30, 50, 30, 50]);
    } else if (result.status === 'in_process' || result.status === 'pending') {
      showTipResult('⏳', 'Pagamento em processamento<br><span style="font-size:.6rem;color:var(--t3)">O banco está verificando. Pode levar alguns minutos.</span>');
      if (result.tipId) pollTipStatus(result.tipId);
    } else {
      showPayError(translatePayError(result.statusDetail||'rejected'));
      btn.disabled=false;btn.textContent='Pagar R$'+tipState.amount.toFixed(2).replace('.',',');
    }
  } catch (e) {
    console.error('One-tap error:', e);
    showPayError(e.message||'Erro ao processar. Tente novamente.');
    btn.disabled = false;
    btn.textContent = 'Pagar R$' + tipState.amount.toFixed(2).replace('.', ',');
  }
}

async function removeSavedCard() {
  if (!confirm('Remover cartão salvo?')) return;
  try {
    await fetch('/api/tip/saved-card/' + state.userId, { method: 'DELETE' });
    tipState.savedCard = null;
    $('tipSavedCard').style.display = 'none';
    $('tipNewCard').style.display = '';
    showToast('Cartão removido.');
  } catch (e) { showToast('Erro ao remover.'); }
}

// ── Pay with new card (tokenize → pay → save) ──
async function payWithNewCard() {
  if (!tipState.amount || tipState.amount < 1) return showToast('Escolha um valor.');
  const cardNum = $('tipCardNumber').value.replace(/\s/g, '');
  const expiry = $('tipCardExpiry').value;
  const cvv = $('tipCardCVV').value;
  const holder = $('tipCardHolder').value.trim();
  const cpf = $('tipCardCPF').value.replace(/\D/g, '');
  if (!cardNum || cardNum.length < 13) return showToast('Número do cartão inválido.');
  if (!expiry || expiry.length < 5) return showToast('Data de validade inválida.');
  if (!cvv || cvv.length < 3) return showToast('CVV inválido.');
  if (!holder) return showToast('Nome no cartão obrigatório.');
  if (!cpf || cpf.length < 11) return showToast('CPF inválido.');

  const btn = $('tipCardPayBtn');
  btn.disabled = true; btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:.3rem"><span class="pay-spinner"></span>Processando...</span>';

  try {
    const mp = await getMpSdk();
    if (!mp) throw new Error('SDK de pagamento não disponível.');

    const [expMonth, expYear] = expiry.split('/');
    // Detect payment method from BIN
    const bin = cardNum.substring(0, 6);
    let payMethodId = 'visa';
    try {
      const pmResp = await fetch('https://api.mercadopago.com/v1/payment_methods/search?bins=' + bin + '&marketplace=NONE', {
        headers: { 'Authorization': 'Bearer ' + (await (await fetch('/api/mp-public-key')).json()).publicKey }
      });
      // Fallback: detect from first digit
    } catch(e) {}
    // Simple BIN detection fallback
    const d1 = cardNum[0], d2 = cardNum.substring(0,2);
    if (d1 === '5' || d2 === '22' || d2 === '23' || d2 === '24' || d2 === '25' || d2 === '26' || d2 === '27') payMethodId = 'master';
    else if (d1 === '4') payMethodId = 'visa';
    else if (d2 === '34' || d2 === '37') payMethodId = 'amex';
    else if (d2 === '60' || d2 === '65' || d2 === '63') payMethodId = 'elo';
    else if (d2 === '38' || d2 === '30') payMethodId = 'diners';

    const tokenResult = await mp.createCardToken({
      cardNumber: cardNum, cardholderName: holder,
      cardExpirationMonth: expMonth, cardExpirationYear: '20' + expYear,
      securityCode: cvv, identificationType: 'CPF', identificationNumber: cpf
    });
    if (!tokenResult || !tokenResult.id) throw new Error('Erro ao tokenizar cartão.');

    const resp = await fetch('/api/tip/create', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        payerId: state.userId, receiverId: tipState.receiverId, amount: tipState.amount,
        token: tokenResult.id, paymentMethodId: payMethodId,
        payerEmail: state.email || state.userId + '@touch.app', payerCPF: cpf
      })
    });
    const result = await resp.json();
    if (result.error) {
      showPayError(translatePayError(result.error,result.detail));
      btn.disabled=false;btn.textContent='💳 Pagar R$'+tipState.amount.toFixed(2).replace('.',',');
      return;
    }

    if (result.status === 'approved') {
      // Save card if checked
      if ($('tipSaveCardCheck').checked) {
        try {
          const saveToken = await mp.createCardToken({
            cardNumber: cardNum, cardholderName: holder,
            cardExpirationMonth: expMonth, cardExpirationYear: '20' + expYear,
            securityCode: cvv, identificationType: 'CPF', identificationNumber: cpf
          });
          if (saveToken?.id) {
            await fetch('/api/tip/save-card', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ userId: state.userId, token: saveToken.id, email: state.email || state.userId + '@touch.app', cpf })
            });
          }
        } catch (saveErr) { console.error('Save card error:', saveErr); }
      }
      showTipResult('✅', 'Gorjeta enviada!<br>R$' + tipState.amount.toFixed(2).replace('.', ','));
      haptic([50, 30, 50, 30, 50]);
    } else if (result.status === 'in_process' || result.status === 'pending') {
      showTipResult('⏳', 'Pagamento em processamento<br><span style="font-size:.6rem;color:var(--t3)">O banco está verificando. Pode levar alguns minutos.</span>');
    } else {
      showPayError(translatePayError(result.statusDetail||'rejected'));
      btn.disabled=false;btn.textContent='💳 Pagar R$'+tipState.amount.toFixed(2).replace('.',',');
    }
  } catch (e) {
    console.error('Card payment error:', e);
    showPayError(e.message||'Erro ao processar. Tente novamente.');
    btn.disabled = false;
    btn.textContent = '💳 Pagar R$' + tipState.amount.toFixed(2).replace('.', ',');
  }
}

function checkTipResultParam() {
  const params = new URLSearchParams(window.location.search);
  const tipResult = params.get('tipResult');
  if (tipResult) {
    if (tipResult === 'approved') showToast('Gorjeta confirmada! ✅');
    else if (tipResult === 'pending') showToast('Pagamento em processamento ⏳');
    else showToast('Pagamento não aprovado ❌');
    window.history.replaceState({}, '', window.location.pathname);
  }
}

// ── Translate MP payment errors to clear Portuguese ──
function translatePayError(msg,detail){
  const map={
    'cc_rejected_bad_filled_card_number':'Número do cartão está incorreto. Confira e tente novamente.',
    'cc_rejected_bad_filled_date':'Data de validade incorreta.',
    'cc_rejected_bad_filled_other':'Algum dado do cartão está errado. Confira todos os campos.',
    'cc_rejected_bad_filled_security_code':'CVV incorreto. Verifique o código atrás do cartão.',
    'cc_rejected_blacklist':'Seu cartão foi bloqueado pelo banco. Use outro cartão.',
    'cc_rejected_call_for_authorize':'O banco precisa que você autorize. Ligue para a central do cartão e tente novamente.',
    'cc_rejected_card_disabled':'Cartão desabilitado para compras online. Ative pelo app do banco.',
    'cc_rejected_duplicated_payment':'Pagamento duplicado. Aguarde alguns minutos antes de tentar novamente.',
    'cc_rejected_high_risk':'O banco rejeitou por segurança. Tente com outro cartão ou PIX.',
    'cc_rejected_insufficient_amount':'Saldo insuficiente no cartão.',
    'cc_rejected_invalid_installments':'Parcelas inválidas para este cartão.',
    'cc_rejected_max_attempts':'Muitas tentativas. Aguarde 24h ou use outro cartão.',
    'cc_rejected_other_reason':'Cartão recusado pelo banco. Tente outro cartão ou PIX.',
    'rejected':'Pagamento recusado pelo banco. Tente outro método.',
    'Cartão expirado ou cartão inválido':'Cartão expirado. Cadastre um novo cartão.',
    'CVV inválido ou cartão expirado':'CVV incorreto ou cartão expirado.'
  };
  // Check detail first, then msg
  if(detail&&map[detail])return map[detail];
  if(msg&&map[msg])return map[msg];
  // Check if msg contains a known key
  for(const[k,v]of Object.entries(map)){
    if(msg&&msg.includes(k))return v;
  }
  return msg||'Erro ao processar pagamento. Tente novamente.';
}
function showPayError(msg){
  // Show as a styled error toast that stays longer
  const el=document.createElement('div');
  el.style.cssText='position:fixed;top:60px;left:50%;transform:translateX(-50%);max-width:320px;width:90%;z-index:100000;animation:slideDown .3s ease';
  el.innerHTML='<div style="background:rgba(239,68,68,.95);backdrop-filter:blur(12px);color:#fff;padding:.8rem 1rem;border-radius:14px;font-size:.72rem;line-height:1.4;text-align:center;box-shadow:0 8px 32px rgba(239,68,68,.3)">'
    +'<div style="font-weight:700;margin-bottom:.2rem">Pagamento não aprovado</div>'
    +'<div style="opacity:.9">'+msg+'</div>'
    +'</div>';
  document.body.appendChild(el);
  setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .3s';setTimeout(()=>el.remove(),300)},5000);
}
function showTipResult(icon, text) {
  $('tipResult').classList.remove('hidden');
  $('tipResultIcon').textContent = icon;
  $('tipResultText').innerHTML = text;
  $('tipSavedCard').style.display = 'none';
  $('tipNewCard').style.display = 'none';
  $('tipPixSection').style.display = 'none';
  $('tipOtherMethods').style.display = 'none';
  $('tipScreen').querySelector('.tip-amounts').style.display = 'none';
  $('tipScreen').querySelector('.tip-custom').style.display = 'none';
}

// ═══ SERVIÇOS SCREEN ═══
function showServicosScreen(){
  haptic([30]);
  const isPrestador=localStorage.getItem('touch_isPrestador')==='1';
  // Build a simple screen with both options
  const overlay=document.createElement('div');
  overlay.className='more-menu-overlay';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
  let btns='<button class="my-pf-btn" onclick="this.closest(\'.more-menu-overlay\').remove();showPrestadorRegister()" style="margin-bottom:.4rem"><span class="my-pf-ico">edit</span>Cadastro de serviço</button>';
  if(isPrestador){
    btns+='<button class="my-pf-btn" onclick="this.closest(\'.more-menu-overlay\').remove();showPrestadorDash()"><span class="my-pf-ico">$</span>Painel financeiro</button>';
  }
  overlay.innerHTML='<div class="more-menu-sheet" style="padding:1.5rem">'
    +'<div class="more-menu-handle"></div>'
    +'<div style="font-size:.9rem;font-weight:700;margin-bottom:.8rem">Serviços</div>'
    +'<div style="font-size:.65rem;color:var(--t3);margin-bottom:1rem">Cadastre-se como prestador para receber gorjetas e gerencie seu painel financeiro.</div>'
    +btns
    +'</div>';
  document.body.appendChild(overlay);
}

// ═══ PRESTADOR REGISTER ═══
let pregSelectedService = null;

// ═══ PRESTADOR DASHBOARD ═══
async function showPrestadorDash() {
  showScreen('prestadorDash');
  $('pdStats').innerHTML = '<div style="text-align:center;grid-column:1/-1;padding:1rem;color:var(--t3);font-size:.7rem">Carregando...</div>';
  $('pdTips').innerHTML = '';
  $('pdEncounters').innerHTML = '';
  try {
    const resp = await fetch('/api/prestador/' + state.userId + '/dashboard');
    const d = await resp.json();
    if (d.error) throw new Error(d.error);

    // Stats cards
    const fmt = v => 'R$' + v.toFixed(2).replace('.', ',');
    $('pdStats').innerHTML =
      pdCard('Total recebido', fmt(d.stats.totalReceived), '#6366f1', d.stats.totalCount + ' gorjetas') +
      pdCard('Líquido (após taxa)', fmt(d.stats.totalNet), '#10b981', '10% taxa Touch?');

    // Period cards
    $('pdPeriods').innerHTML =
      pdMini('Hoje', fmt(d.stats.todayTotal), d.stats.todayCount) +
      pdMini('Semana', fmt(d.stats.weekTotal), d.stats.weekCount) +
      pdMini('Mês', fmt(d.stats.monthTotal), d.stats.monthCount);

    // MP status
    if (d.mpConnected) {
      $('pdMpStatus').innerHTML = '<div style="padding:.5rem;border-radius:12px;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);font-size:.65rem;color:#10b981;text-align:center">✅ Conta Mercado Pago conectada — gorjetas caem direto na sua conta</div>';
    } else {
      $('pdMpStatus').innerHTML = '<div style="padding:.5rem;border-radius:12px;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);font-size:.65rem;color:#fbbf24;text-align:center">⚠️ Conta MP não conectada — gorjetas ficam com a plataforma Touch?</div>';
    }

    // Tips list
    if (d.tips.length === 0) {
      $('pdTips').innerHTML = '<div style="padding:.8rem;text-align:center;color:var(--t3);font-size:.65rem;background:rgba(255,255,255,.03);border-radius:12px">Nenhuma gorjeta recebida ainda</div>';
    } else {
      $('pdTips').innerHTML = d.tips.map(t => {
        const date = new Date(t.createdAt);
        const time = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
        const statusIcon = t.status === 'approved' ? '✅' : t.status === 'pending' ? '⏳' : '❌';
        return '<div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem .6rem;background:rgba(255,255,255,.03);border-radius:10px;margin-bottom:.3rem">' +
          '<div><div style="font-size:.7rem;font-weight:600;color:var(--t1)">' + statusIcon + ' ' + fmt(t.amount) + '</div>' +
          '<div style="font-size:.55rem;color:var(--t3)">' + esc(t.payerName) + ' · ' + time + '</div></div>' +
          '<div style="text-align:right"><div style="font-size:.6rem;color:#10b981;font-weight:600">+' + fmt(t.net) + '</div>' +
          '<div style="font-size:.5rem;color:var(--t3)">taxa ' + fmt(t.fee) + '</div></div></div>';
      }).join('');
    }

    // Encounters list
    if (d.encounters.length === 0) {
      $('pdEncounters').innerHTML = '<div style="padding:.8rem;text-align:center;color:var(--t3);font-size:.65rem;background:rgba(255,255,255,.03);border-radius:12px">Nenhuma encostada recebida ainda</div>';
    } else {
      $('pdEncounters').innerHTML = d.encounters.map(e => {
        const date = new Date(e.timestamp);
        const time = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
        const tipInfo = e.tipAmount > 0 ? ' · 💰 ' + fmt(e.tipAmount) + (e.tipStatus === 'approved' ? ' ✅' : ' ⏳') : '';
        return '<div style="display:flex;align-items:center;gap:.5rem;padding:.4rem .6rem;background:rgba(255,255,255,.03);border-radius:10px;margin-bottom:.3rem">' +
          '<div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#4f46e5);display:flex;align-items:center;justify-content:center;font-size:.55rem;color:#fff;font-weight:700;flex-shrink:0">' + esc(e.nickname[0] || '?') + '</div>' +
          '<div><div style="font-size:.7rem;font-weight:600;color:var(--t1)">' + esc(e.nickname) + tipInfo + '</div>' +
          '<div style="font-size:.55rem;color:var(--t3)">' + time + '</div></div></div>';
      }).join('');
    }
  } catch (e) {
    console.error('Dashboard error:', e);
    $('pdStats').innerHTML = '<div style="text-align:center;grid-column:1/-1;padding:1rem;color:var(--err);font-size:.7rem">Erro ao carregar: ' + (e.message || '') + '</div>';
  }
}

function pdCard(label, value, color, sub) {
  return '<div style="padding:.6rem;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)">' +
    '<div style="font-size:.55rem;color:var(--t3);margin-bottom:.2rem">' + label + '</div>' +
    '<div style="font-size:1.1rem;font-weight:800;color:' + color + '">' + value + '</div>' +
    '<div style="font-size:.5rem;color:var(--t3);margin-top:.15rem">' + sub + '</div></div>';
}

function pdMini(label, value, count) {
  return '<div style="padding:.5rem;border-radius:12px;background:rgba(255,255,255,.03);text-align:center">' +
    '<div style="font-size:.5rem;color:var(--t3)">' + label + '</div>' +
    '<div style="font-size:.8rem;font-weight:700;color:var(--t1)">' + value + '</div>' +
    '<div style="font-size:.5rem;color:var(--t3)">' + count + ' gorj.</div></div>';
}

function showPrestadorRegister() {
  showScreen('prestadorReg');
  // Pre-fill if user already exists
  if (state.userId && state.userName) {
    $('pregNick').value = state.userName;
    $('pregNick').disabled = true; // Can't change nickname of existing user
    // Fetch full user info to pre-fill name
    fetch('/api/user/' + state.userId).then(r => r.json()).then(u => {
      if (u.name) $('pregName').value = u.name;
      if (u.birthdate) $('pregBirth').value = u.birthdate;
      if (u.isPrestador) {
        $('pregSubmitBtn').textContent = 'Atualizar serviço';
        // Show already-prestador status
        $('pregMpStatus').style.display = 'block';
        $('pregMpText').textContent = u.mpConnected ? '✅ MercadoPago conectado' : 'Conecte MercadoPago para receber pagamentos';
        if (!u.mpConnected) { $('pregMpBtn').style.display = 'block'; }
      }
    }).catch(() => {});
  } else {
    $('pregNick').value = '';
    $('pregNick').disabled = false;
    $('pregSubmitBtn').textContent = 'Criar conta de prestador';
    $('pregMpStatus').style.display = 'none';
    $('pregMpBtn').style.display = 'none';
  }
  // Load service types
  const grid = $('pregServices');
  pregSelectedService = null;
  fetch('/api/service-types').then(r => r.json()).then(types => {
    grid.innerHTML = '';
    types.forEach(t => {
      const btn = document.createElement('button');
      btn.className = 'preg-svc';
      btn.textContent = t.label;
      btn.onclick = () => {
        pregSelectedService = t.id;
        grid.querySelectorAll('.preg-svc').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      };
      grid.appendChild(btn);
    });
  });
}

function checkPregNick(val) {
  const hint = $('pregNickHint');
  const nick = val.trim();
  if (!nick || nick.length < 2) { hint.textContent = 'mínimo 2 caracteres'; hint.className = 'nick-hint'; return; }
  if (!/^[a-zA-Z0-9_.-]+$/.test(nick)) { hint.textContent = 'só letras, números, _ . -'; hint.className = 'nick-hint taken'; return; }
  fetch('/api/check-nick/' + encodeURIComponent(nick)).then(r => r.json()).then(d => {
    if (d.available) { hint.textContent = '✓ disponível'; hint.className = 'nick-hint ok'; }
    else { hint.textContent = 'já existe'; hint.className = 'nick-hint taken'; }
  });
}

async function registerPrestador() {
  const name = $('pregName').value.trim();
  const nick = $('pregNick').value.trim();
  const cpf = $('pregCPF').value.trim();
  const birth = $('pregBirth').value;
  if (!name) return showToast('Preencha o nome.');
  if (!pregSelectedService) return showToast('Escolha o tipo de serviço.');

  // If user already has account, convert to prestador (keep same userId)
  const existingId = state.userId || null;
  if (!existingId && (!nick || nick.length < 2)) return showToast('Preencha o nickname.');

  try {
    const body = { serviceType: pregSelectedService, fullName: name, cpf, birthdate: birth || null };
    if (existingId) body.userId = existingId;
    if (nick) body.nickname = nick;
    const resp = await fetch('/api/prestador/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await resp.json();
    if (data.error) return showToast(data.error);
    // Update local state (keep same userId if converting)
    state.userId = data.userId;
    state.userName = data.user.nickname;
    state.userColor = data.user.color;
    localStorage.setItem('touch_userId', data.userId);
    localStorage.setItem('touch_userName', data.user.nickname);
    localStorage.setItem('touch_userColor', data.user.color);
    localStorage.setItem('touch_isPrestador', '1');
    showToast(existingId ? 'Conta atualizada! Agora você é prestador.' : 'Conta criada!');
    // Show MP connect option
    $('pregSubmitBtn').style.display = 'none';
    $('pregMpBtn').style.display = 'block';
    $('pregMpStatus').style.display = 'block';
    $('pregMpText').textContent = 'Agora conecte sua conta MercadoPago para receber pagamentos.';
  } catch (e) { showToast('Erro: ' + e.message); }
}

function connectMercadoPago() {
  if (!state.userId) return showToast('Crie a conta primeiro.');
  window.location.href = '/mp/auth/' + state.userId;
}

// ═══ PULL TO REFRESH (Home) ═══
(function(){
  const home=$('home');if(!home)return;
  let ptrStartY=0,ptrActive=false,ptrTriggered=false;
  const indicator=$('ptrIndicator');
  const threshold=60;
  home.addEventListener('touchstart',e=>{
    if(!home.classList.contains('active'))return;
    ptrStartY=e.touches[0].clientY;ptrActive=true;ptrTriggered=false;
  },{passive:true});
  home.addEventListener('touchmove',e=>{
    if(!ptrActive)return;
    const dy=e.touches[0].clientY-ptrStartY;
    if(dy>20&&dy<150){
      indicator.classList.add('pulling');
      indicator.classList.remove('refreshing');
    }
    if(dy>threshold)ptrTriggered=true;
  },{passive:true});
  home.addEventListener('touchend',()=>{
    if(ptrTriggered){
      indicator.classList.remove('pulling');
      indicator.classList.add('refreshing');
      refreshHome();
      setTimeout(()=>{indicator.classList.remove('refreshing')},1200);
    }else{
      indicator.classList.remove('pulling');
    }
    ptrActive=false;ptrTriggered=false;
  },{passive:true});
})();

// ═══ EVENTS ═══
$('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();sendMessage()}});
$('chatInput').addEventListener('input',()=>{handleTyping();updateSendBtn()});
$('chatInput').addEventListener('focus',()=>closePlusMenu());
document.addEventListener('click',e=>{const pm=$('plusMenu');if(pm&&pm.classList.contains('open')&&!pm.contains(e.target)&&!e.target.closest('.cia-plus'))closePlusMenu()});
$('joinCodeInput').addEventListener('keydown',e=>{if(e.key==='Enter')joinSession()});
if(window.visualViewport){let ph=window.visualViewport.height;window.visualViewport.addEventListener('resize',()=>{if($('chat').classList.contains('active')&&window.visualViewport.height<ph)requestAnimationFrame(()=>{$('chatMessages').scrollTop=99999});ph=window.visualViewport.height})}

// ═══ RESOURCE CLEANUP + SCREENSHOT PROTECTION ═══
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){
    // Release mic, speaker, camera when app goes to background
    releaseAllMedia();
    // Blur chat for screenshot protection
    if($('chat').classList.contains('active'))$('chatMessages').style.filter='blur(20px)';
  }else{
    $('chatMessages').style.filter='';
  }
});
// Also cleanup on page close/navigate away
window.addEventListener('beforeunload',()=>releaseAllMedia());
window.addEventListener('pagehide',()=>releaseAllMedia());
// Block keyboard screenshot shortcuts (partial - won't work on all platforms)
document.addEventListener('keyup',e=>{
  if(e.key==='PrintScreen'&&$('chat').classList.contains('active')){
    $('chatMessages').style.filter='blur(20px)';
    showToast('Screenshots não permitidos no chat.');
    setTimeout(()=>{$('chatMessages').style.filter=''},1500);
  }
});

// ═══ INIT ═══
async function validateUser(){
  if(!state.userId)return false;
  try{
    const r=await fetch('/api/user/'+state.userId);
    if(!r.ok){localStorage.removeItem('touch_userId');localStorage.removeItem('touch_userName');state.userId=null;state.userName=null;return false}
    return true;
  }catch(e){return false}
}
window.addEventListener('load',()=>{
  applyLang();
  const qr=new URLSearchParams(location.search).get('code');
  setTimeout(async()=>{
    if(state.userId&&await validateUser()){
      initSocket();requestAccelPermission();
      // Set home avatar
      const _ha=$('homeAvatar');if(_ha&&state.userName){_ha.textContent=(state.userName||'??').slice(0,2).toUpperCase();_ha.style.background=state.userColor||nickColor(state.userName)}
      if(qr){showScreen('home');$('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(state.userName)+'</span>';setTimeout(()=>{$('joinCodeInput').value=qr;showScreen('encounter');showPhase('phaseChoose');joinSession();history.replaceState({},'','/')},300)}
      else{showScreen('home');$('homeGreeting').innerHTML=i18n('home_greeting')+', <span class="hg-nick">'+esc(state.userName)+'</span>'}
      refreshHome();restoreFloatingEvent();checkTipResultParam();checkSubResultParam();
    }else{
      // Show onboarding for first-time users, login for returning
      if(!localStorage.getItem('touch_onboarded')){
        initOnboarding();
        showScreen('onboarding');
      }else{
        showScreen('login');
      }
    }
  },1800);
});

// ═══ FACE ID — ENROLLMENT & VERIFICATION ═══
let _faceModelsLoaded=false;
let _faceStream=null;
let _faceDescriptors=[];
let _faceCapturing=false;
const FACE_CAPTURES_NEEDED=5; // 5 angles

async function loadFaceModels(){
  if(_faceModelsLoaded)return true;
  try{
    const MODEL_URL='https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
    await Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
      faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
      faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
    ]);
    _faceModelsLoaded=true;
    return true;
  }catch(e){
    console.error('Face model load error:',e);
    showToast('Erro ao carregar modelos: '+e.message);
    return false;
  }
}

async function showFaceEnrollment(){
  showScreen('faceEnrollScreen');
  _faceDescriptors=[];
  _faceCapturing=false;
  $('faceProgressBar').style.width='0%';
  $('faceCaptureCount').textContent='';
  $('faceGuide').textContent='Posicione seu rosto';
  $('faceGuide').style.display='';
  $('faceOverlay').style.borderColor='transparent';
  $('faceStartBtn').classList.remove('hidden');
  $('faceSaveBtn').classList.add('hidden');
  $('faceInstructions').textContent='Toque em "Iniciar" para cadastrar';
  // Check if already enrolled
  if(state.userFaceEnrolled){
    $('faceEnrolledInfo').classList.remove('hidden');
    $('faceStartBtn').textContent='Recadastrar';
  }else{
    $('faceEnrolledInfo').classList.add('hidden');
    $('faceStartBtn').textContent='Iniciar captura';
  }
  // Start camera
  try{
    if(_faceStream){_faceStream.getTracks().forEach(t=>t.stop())}
    _faceStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:320},height:{ideal:320}}});
    $('faceVideo').srcObject=_faceStream;
  }catch(e){
    $('faceInstructions').textContent='Câmera não disponível: '+e.message;
  }
}

const _faceAngles=['Olhe para frente','Vire levemente à esquerda','Vire levemente à direita','Levante o queixo','Abaixe o queixo'];

async function startFaceEnroll(){
  $('faceInstructions').textContent='Carregando modelos...';
  const ok=await loadFaceModels();
  if(!ok)return;
  _faceDescriptors=[];
  _faceCapturing=true;
  $('faceStartBtn').classList.add('hidden');
  $('faceSaveBtn').classList.add('hidden');
  $('faceEnrolledInfo').classList.add('hidden');
  captureNextAngle(0);
}

async function captureNextAngle(idx){
  if(idx>=FACE_CAPTURES_NEEDED){
    // Done capturing
    _faceCapturing=false;
    $('faceOverlay').style.borderColor='#00dc82';
    $('faceGuide').textContent='✓ Captura completa!';
    $('faceInstructions').textContent='Toque em "Salvar" para registrar seu Face ID';
    $('faceSaveBtn').classList.remove('hidden');
    $('faceProgressBar').style.width='100%';
    haptic([40,20,40,20,40]);
    return;
  }
  $('faceInstructions').textContent=_faceAngles[idx];
  $('faceCaptureCount').textContent=(idx+1)+'/'+FACE_CAPTURES_NEEDED;
  $('faceProgressBar').style.width=(idx/FACE_CAPTURES_NEEDED*100)+'%';
  $('faceOverlay').style.borderColor='#3b82f6';
  $('faceGuide').style.display='none';
  // Wait a moment then detect
  await new Promise(r=>setTimeout(r,1200));
  if(!_faceCapturing)return;
  const video=$('faceVideo');
  try{
    const detection=await faceapi.detectSingleFace(video,new faceapi.SsdMobilenetv1Options({minConfidence:0.5}))
      .withFaceLandmarks()
      .withFaceDescriptor();
    if(!detection){
      $('faceInstructions').textContent='Rosto não detectado — '+_faceAngles[idx];
      setTimeout(()=>captureNextAngle(idx),800);
      return;
    }
    // Got descriptor (128-dimensional Float32Array)
    _faceDescriptors.push(Array.from(detection.descriptor));
    $('faceOverlay').style.borderColor='#00dc82';
    haptic([25]);
    await new Promise(r=>setTimeout(r,400));
    captureNextAngle(idx+1);
  }catch(e){
    $('faceInstructions').textContent='Erro na detecção — tentando novamente...';
    setTimeout(()=>captureNextAngle(idx),1000);
  }
}

async function saveFaceData(){
  if(!_faceDescriptors.length){return showToast('Nenhuma captura facial')}
  $('faceSaveBtn').disabled=true;
  $('faceInstructions').textContent='Salvando...';
  try{
    const r=await fetch('/api/face/enroll',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      userId:state.userId,
      descriptors:_faceDescriptors,
      capturedAt:Date.now(),
      angles:FACE_CAPTURES_NEEDED
    })});
    const d=await r.json();
    if(d.error){showToast(d.error);$('faceSaveBtn').disabled=false;return}
    state.userFaceEnrolled=true;
    showToast('Face ID cadastrado com sucesso!');
    haptic([40,20,60]);
    $('faceEnrolledInfo').classList.remove('hidden');
    $('faceSaveBtn').classList.add('hidden');
    $('faceInstructions').textContent='Face ID ativo';
    // Stop camera
    if(_faceStream){_faceStream.getTracks().forEach(t=>t.stop());_faceStream=null}
  }catch(e){
    showToast('Erro ao salvar Face ID');
    $('faceSaveBtn').disabled=false;
  }
}

async function removeFaceData(){
  if(!confirm('Remover seu Face ID?'))return;
  try{
    const r=await fetch('/api/face/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:state.userId})});
    const d=await r.json();
    if(d.ok){
      state.userFaceEnrolled=false;
      showToast('Face ID removido');
      $('faceEnrolledInfo').classList.add('hidden');
      $('faceStartBtn').classList.remove('hidden');
      $('faceStartBtn').textContent='Iniciar captura';
    }
  }catch(e){showToast('Erro ao remover')}
}

// ═══ DOC ID — DOCUMENT VERIFICATION ═══
let _docPhotoData=null;
let _docSelfieData=null;

function showDocIdScreen(){
  showScreen('docIdScreen');
  _docPhotoData=null;_docSelfieData=null;
  $('docPreviewImg').style.display='none';
  $('docPlaceholder').style.display='';
  $('docSelfieImg').style.display='none';
  $('docSelfiePlaceholder').style.display='';
  $('docSelfieWrap').classList.add('hidden');
  $('docNameField').classList.add('hidden');
  $('docSaveBtn').classList.add('hidden');
  $('docNameInput').value='';
  $('docCpfInput').value='';
  if(state.userDocVerified){
    $('docEnrolledInfo').classList.remove('hidden');
    $('docStatusText').textContent=state.userDocStatus==='approved'?'Documento verificado ✓':'Aguardando validação...';
  }else{
    $('docEnrolledInfo').classList.add('hidden');
  }
}

function handleDocPhoto(input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  if(file.size>8*1024*1024)return showToast('Arquivo muito grande (máx 8MB)');
  const reader=new FileReader();
  reader.onload=function(e){
    const img=new Image();
    img.onload=function(){
      const canvas=document.createElement('canvas');
      const max=800;
      let w=img.width,h=img.height;
      if(w>max||h>max){if(w>h){h=h*(max/w);w=max}else{w=w*(max/h);h=max}}
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      _docPhotoData=canvas.toDataURL('image/jpeg',0.8);
      $('docPreviewImg').src=_docPhotoData;
      $('docPreviewImg').style.display='';
      $('docPlaceholder').style.display='none';
      $('docSelfieWrap').classList.remove('hidden');
      haptic([20]);
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

function handleDocSelfie(input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  if(file.size>8*1024*1024)return showToast('Arquivo muito grande (máx 8MB)');
  const reader=new FileReader();
  reader.onload=function(e){
    const img=new Image();
    img.onload=function(){
      const canvas=document.createElement('canvas');
      const max=600;
      let w=img.width,h=img.height;
      if(w>max||h>max){if(w>h){h=h*(max/w);w=max}else{w=w*(max/h);h=max}}
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      _docSelfieData=canvas.toDataURL('image/jpeg',0.75);
      $('docSelfieImg').src=_docSelfieData;
      $('docSelfieImg').style.display='';
      $('docSelfiePlaceholder').style.display='none';
      $('docNameField').classList.remove('hidden');
      $('docSaveBtn').classList.remove('hidden');
      haptic([20]);
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

async function saveDocId(){
  if(!_docPhotoData)return showToast('Tire a foto do documento');
  if(!_docSelfieData)return showToast('Tire a selfie com o documento');
  const name=$('docNameInput').value.trim();
  if(!name)return showToast('Digite o nome no documento');
  $('docSaveBtn').disabled=true;
  try{
    const r=await fetch('/api/doc/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      userId:state.userId,
      docPhoto:_docPhotoData,
      selfiePhoto:_docSelfieData,
      docName:name,
      cpf:$('docCpfInput').value.trim(),
      submittedAt:Date.now()
    })});
    const d=await r.json();
    if(d.error){showToast(d.error);$('docSaveBtn').disabled=false;return}
    state.userDocVerified=true;
    showToast('Documento enviado para verificação!');
    haptic([40,20,60]);
    $('docEnrolledInfo').classList.remove('hidden');
    $('docSaveBtn').classList.add('hidden');
  }catch(e){
    showToast('Erro ao enviar');
    $('docSaveBtn').disabled=false;
  }
}

// ═══ ADMIN VERIFICATION PANEL ═══
async function showVerificationPanel(){
  const existing=document.querySelector('.verify-panel-overlay');if(existing){existing.remove();return}
  const overlay=document.createElement('div');
  overlay.className='more-menu-overlay verify-panel-overlay';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
  overlay.innerHTML='<div class="more-menu-sheet" style="padding:1.5rem;max-height:85vh;overflow-y:auto"><div class="more-menu-handle"></div><div style="text-align:center;padding:1rem;color:var(--t3)">Carregando...</div></div>';
  document.body.appendChild(overlay);
  try{
    const d=await(await fetch('/api/admin/verifications/'+state.userId)).json();
    if(d.error){overlay.querySelector('.more-menu-sheet').innerHTML='<div class="more-menu-handle"></div><p style="color:var(--err);padding:1rem;text-align:center">'+d.error+'</p>';return}
    let html='<div class="more-menu-handle"></div>';
    html+='<h3 style="font-size:1rem;font-weight:700;color:var(--t1);margin-bottom:.8rem;display:flex;align-items:center;gap:.4rem"><span style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800">✓</span> Painel de Verificação</h3>';
    // Verified users
    html+='<div style="font-size:.75rem;font-weight:600;color:var(--t2);margin-bottom:.4rem">Usuários verificados ('+d.verifiedUsers.length+')</div>';
    if(d.verifiedUsers.length===0)html+='<p style="font-size:.72rem;color:var(--t3);margin-bottom:.8rem">Nenhum verificado ainda.</p>';
    d.verifiedUsers.forEach(u=>{
      const av=u.profilePhoto?'<div style="width:32px;height:32px;border-radius:50%;overflow:hidden;flex-shrink:0"><img src="'+u.profilePhoto+'" style="width:100%;height:100%;object-fit:cover"></div>':'<div style="width:32px;height:32px;border-radius:50%;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:800;color:#fff;flex-shrink:0">'+(u.nickname||'??').slice(0,2).toUpperCase()+'</div>';
      html+='<div style="display:flex;align-items:center;gap:.5rem;padding:.5rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;margin-bottom:.3rem">';
      html+='<div class="verified-wrap">'+av+'<div class="verified-badge verified-badge-sm">'+VERIFIED_SVG+'</div></div>';
      html+='<div style="flex:1;min-width:0"><div style="font-size:.78rem;font-weight:600;color:var(--t1)">'+esc(u.nickname)+'</div><div style="font-size:.6rem;color:var(--t3)">★'+u.stars+' · score '+u.score+'</div></div>';
      html+='<button onclick="unverifyUser(\''+u.id+'\',this)" style="font-size:.6rem;padding:.25rem .5rem;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.2);border-radius:8px;color:#f87171;cursor:pointer">Revogar</button>';
      html+='</div>';
    });
    // Verified events
    html+='<div style="font-size:.75rem;font-weight:600;color:var(--t2);margin:.8rem 0 .4rem">Eventos verificados ('+d.verifiedEvents.length+')</div>';
    d.verifiedEvents.forEach(e=>{
      html+='<div style="display:flex;align-items:center;gap:.5rem;padding:.5rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;margin-bottom:.3rem">';
      html+='<div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-size:.9rem">📍</div>';
      html+='<div style="flex:1"><div style="font-size:.78rem;font-weight:600;color:var(--t1)">'+esc(e.name)+' <span style="background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:.6rem;font-weight:800">✓</span></div><div style="font-size:.6rem;color:var(--t3)">'+e.participants+' participantes</div></div>';
      html+='</div>';
    });
    // Add verification section
    html+='<div style="margin-top:1rem;padding-top:.8rem;border-top:1px solid var(--b1)">';
    html+='<div style="font-size:.75rem;font-weight:600;color:var(--ac);margin-bottom:.5rem">Verificar usuário</div>';
    html+='<div style="display:flex;gap:.3rem;margin-bottom:.5rem"><input type="text" id="verifySearchInput" placeholder="Buscar por nickname..." style="flex:1;padding:.5rem .7rem;background:var(--s1);border:1px solid var(--b1);border-radius:10px;color:var(--t1);font-size:.75rem;outline:none" oninput="filterVerifyUsers(this.value)"><button onclick="filterVerifyUsers($$(\'verifySearchInput\').value)" style="padding:.5rem .7rem;background:var(--ac);border:none;border-radius:10px;color:#fff;font-size:.7rem;font-weight:600;cursor:pointer">Buscar</button></div>';
    html+='<div id="verifyUserResults" style="max-height:200px;overflow-y:auto">';
    d.allUsers.filter(u=>!u.verified).slice(0,20).forEach(u=>{
      const av2=u.profilePhoto?'<img src="'+u.profilePhoto+'" style="width:28px;height:28px;border-radius:50%;object-fit:cover">':'<div style="width:28px;height:28px;border-radius:50%;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:800;color:#fff">'+(u.nickname||'??').slice(0,2).toUpperCase()+'</div>';
      html+='<div class="verify-user-row" data-nick="'+esc(u.nickname.toLowerCase())+'" style="display:flex;align-items:center;gap:.4rem;padding:.35rem;cursor:pointer;border-radius:8px;margin-bottom:.15rem" onmouseover="this.style.background=\'var(--s2)\'" onmouseout="this.style.background=\'none\'">';
      html+=av2;
      html+='<div style="flex:1;font-size:.72rem;color:var(--t1)">'+esc(u.nickname)+' <span style="color:var(--t3);font-size:.6rem">★'+u.stars+'</span></div>';
      html+='<button onclick="event.stopPropagation();verifyUser(\''+u.id+'\',this)" style="font-size:.58rem;padding:.2rem .5rem;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);border-radius:8px;color:#3b82f6;cursor:pointer;font-weight:600">Verificar</button>';
      html+='</div>';
    });
    html+='</div></div>';
    // Verify event section
    html+='<div style="margin-top:.8rem;padding-top:.8rem;border-top:1px solid var(--b1)">';
    html+='<div style="font-size:.75rem;font-weight:600;color:#60a5fa;margin-bottom:.5rem">Verificar evento</div>';
    html+='<div id="verifyEventResults">';
    d.allEvents.filter(e=>!e.verified).forEach(e=>{
      html+='<div style="display:flex;align-items:center;gap:.4rem;padding:.35rem;margin-bottom:.15rem">';
      html+='<span style="font-size:.85rem">📍</span>';
      html+='<div style="flex:1;font-size:.72rem;color:var(--t1)">'+esc(e.name)+' <span style="color:var(--t3);font-size:.6rem">'+e.participants+' pax</span></div>';
      html+='<button onclick="event.stopPropagation();verifyEvent(\''+e.id+'\',this)" style="font-size:.58rem;padding:.2rem .5rem;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);border-radius:8px;color:#3b82f6;cursor:pointer;font-weight:600">Verificar</button>';
      html+='</div>';
    });
    html+='</div></div>';
    overlay.querySelector('.more-menu-sheet').innerHTML=html;
  }catch(e){overlay.querySelector('.more-menu-sheet').innerHTML='<div class="more-menu-handle"></div><p style="color:var(--err);padding:1rem">Erro ao carregar.</p>'}
}
function $$(_id){return document.getElementById(_id)}
function filterVerifyUsers(q){
  q=q.toLowerCase().trim();
  document.querySelectorAll('.verify-user-row').forEach(r=>{
    r.style.display=!q||r.dataset.nick.includes(q)?'flex':'none';
  });
}
async function verifyUser(targetId,btn){
  btn.disabled=true;btn.textContent='...';
  try{
    const r=await fetch('/api/admin/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:state.userId,targetId})});
    const d=await r.json();
    if(d.ok){btn.textContent='Verificado ✓';btn.style.background='rgba(52,211,153,.1)';btn.style.color='#34d399';btn.style.borderColor='rgba(52,211,153,.2)';showToast('Usuário verificado!')}
    else{btn.textContent='Erro';showToast(d.error||'Erro')}
  }catch(e){btn.textContent='Erro';btn.disabled=false}
}
async function unverifyUser(targetId,btn){
  btn.disabled=true;btn.textContent='...';
  try{
    const r=await fetch('/api/admin/unverify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:state.userId,targetId})});
    const d=await r.json();
    if(d.ok){btn.closest('div[style]').style.opacity='.4';btn.textContent='Revogado';showToast('Verificação revogada.')}
    else{btn.textContent='Erro';showToast(d.error||'Erro')}
  }catch(e){btn.textContent='Erro';btn.disabled=false}
}
async function verifyEvent(eventId,btn){
  btn.disabled=true;btn.textContent='...';
  try{
    const r=await fetch('/api/admin/verify-event',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:state.userId,eventId})});
    const d=await r.json();
    if(d.ok){btn.textContent='Verificado ✓';btn.style.background='rgba(52,211,153,.1)';btn.style.color='#34d399';showToast('Evento verificado!')}
    else{btn.textContent='Erro';showToast(d.error||'Erro')}
  }catch(e){btn.textContent='Erro';btn.disabled=false}
}
</script>
</body>
</html>
