<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Touch? ‚Äî Painel Operacional</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#050508;--s1:#12121a;--s2:#1a1a24;--t1:#f5f5f7;--t2:#a0a0b8;--t3:#666680;--ac:#6366f1;--ac2:#818cf8;--ok:#34d399;--fire:#ff6b35;--pk:#ff3d71;--gw:rgba(255,107,53,.2);--gw2:rgba(255,107,53,.3);--b1:rgba(255,255,255,.06)}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;overflow:hidden;-webkit-user-select:none;user-select:none}

/* Login */
.op-login{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;z-index:100;background:var(--bg)}
.op-login h1{font-size:2.2rem;font-weight:800;letter-spacing:.06em}.op-login h1 span{color:var(--ac)}
.op-login-sub{font-size:.75rem;color:var(--t3);max-width:300px;text-align:center;line-height:1.6}
.op-login-btn{padding:.8rem 2rem;background:var(--ac);border:none;border-radius:14px;color:#fff;font-size:.85rem;font-weight:600;font-family:inherit;cursor:pointer;transition:transform .2s}
.op-login-btn:active{transform:scale(.95)}

/* Header */
.op-header{display:flex;align-items:center;justify-content:space-between;padding:.5rem 1rem;background:rgba(18,18,26,.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--b1);z-index:10;position:relative}
.op-logo{font-size:.82rem;font-weight:700;letter-spacing:.08em}.op-logo span{color:var(--ac)}
.op-stats{display:flex;gap:1rem;align-items:center;font-size:.7rem;color:var(--t2)}
.op-stat-num{font-weight:700;color:var(--ok);font-size:1rem}
.op-user{font-size:.65rem;color:var(--t3)}

/* Main layout */
.op-main{display:flex;height:calc(100vh - 40px);position:relative}
.op-canvas-area{flex:1;position:relative;overflow:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center}
.op-sidebar{width:280px;background:rgba(18,18,26,.92);backdrop-filter:blur(20px);border-left:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden;z-index:5}
@media(max-width:768px){
  .op-sidebar{position:absolute;bottom:0;left:0;right:0;width:100%;height:36vh;border-left:none;border-top:1px solid var(--b1);border-radius:20px 20px 0 0;z-index:5}
  .op-canvas-area{height:64vh}
}

/* ‚ïê‚ïê‚ïê TOUCH BUTTON ‚Äî exact copy from main app ‚ïê‚ïê‚ïê */
.op-btn-area{position:relative;display:flex;flex-direction:column;align-items:center;gap:.6rem;z-index:3}
.be{width:clamp(130px,36vw,170px);height:clamp(130px,36vw,170px);border-radius:50%;background:radial-gradient(circle at 35% 35%,#ff8f65,#ff6b35 50%,#e05520);border:none;color:#fff;font-size:.85rem;font-weight:800;font-family:inherit;letter-spacing:.25em;cursor:pointer;position:relative;z-index:1;box-shadow:0 0 50px var(--gw),0 0 100px rgba(255,107,53,.08),inset 0 1px 0 rgba(255,255,255,.15);transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.3rem}
.be:active{transform:scale(.92)}
.be .be-text{font-size:.75rem;font-weight:800;letter-spacing:.25em}
.be::before{content:'';position:absolute;inset:-4px;border-radius:50%;background:conic-gradient(from 0deg,var(--ac),var(--pk),#9333ea,var(--ac));z-index:-1;animation:rs 4s linear infinite;opacity:.5;filter:blur(2px)}
.be::after{content:'';position:absolute;inset:-30px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.08),transparent 70%);z-index:-2;animation:bb 3s ease-in-out infinite}
.be.energized{animation:sonic-energy .6s ease-in-out infinite alternate;box-shadow:0 0 60px var(--gw2),0 0 120px rgba(255,107,53,.15),0 0 200px rgba(255,61,113,.06)}
.be.energized::before{animation:rs 1.5s linear infinite;opacity:.8;filter:blur(3px);inset:-8px}
.be.energized::after{animation:sonic-waves 1s ease-out infinite}
.be.energized .be-text{animation:sonic-text .8s ease infinite alternate}
.be.connected{background:radial-gradient(circle at 35% 35%,#34d399,#10b981 50%,#059669)!important;box-shadow:0 0 80px rgba(52,211,153,.5)!important;animation:bump-hit .5s ease!important}
@keyframes bb{0%,100%{opacity:.3}50%{opacity:.6}}
@keyframes rs{to{transform:rotate(360deg)}}
@keyframes sonic-energy{0%{transform:scale(1);box-shadow:0 0 60px var(--gw2),0 0 120px rgba(255,107,53,.15)}100%{transform:scale(1.04);box-shadow:0 0 80px var(--gw2),0 0 150px rgba(255,107,53,.2),0 0 250px rgba(255,61,113,.08)}}
@keyframes sonic-waves{0%{inset:-30px;opacity:.5}100%{inset:-80px;opacity:0}}
@keyframes sonic-text{0%{opacity:1}100%{opacity:.6}}
@keyframes bump-hit{0%{transform:scale(1)}30%{transform:scale(1.15)}60%{transform:scale(.95)}100%{transform:scale(1)}}

/* Sound wave bars */
.sonic-bars{position:absolute;top:50%;display:flex;flex-direction:column;gap:3px;transform:translateY(-50%);z-index:0;opacity:0;transition:opacity .3s}
.sonic-bars.active{opacity:1}
.sonic-bars.left{left:-50px}
.sonic-bars.right{right:-50px}
.sonic-bar{height:2px;background:var(--ac);border-radius:2px;opacity:.4}
.sonic-bars.left .sonic-bar{animation:sbar-left .8s ease-in-out infinite alternate}
.sonic-bars.right .sonic-bar{animation:sbar-right .8s ease-in-out infinite alternate}
.sonic-bar:nth-child(1){width:12px;animation-delay:0s}
.sonic-bar:nth-child(2){width:20px;animation-delay:.1s}
.sonic-bar:nth-child(3){width:28px;animation-delay:.2s}
.sonic-bar:nth-child(4){width:20px;animation-delay:.3s}
.sonic-bar:nth-child(5){width:12px;animation-delay:.4s}
@keyframes sbar-left{0%{opacity:.2;transform:translateX(0)}100%{opacity:.7;transform:translateX(-6px)}}
@keyframes sbar-right{0%{opacity:.2;transform:translateX(0)}100%{opacity:.7;transform:translateX(6px)}}

/* FIRE overlay */
.fire-overlay{position:absolute;bottom:0;left:0;right:0;height:55%;pointer-events:none;z-index:0;opacity:0;transition:opacity .6s}
.fire-overlay.active{opacity:1}
.fire-glow{position:absolute;bottom:-15%;left:50%;transform:translateX(-50%);width:80%;height:55%;background:radial-gradient(ellipse at 50% 100%,rgba(255,107,53,.4) 0%,rgba(255,61,113,.18) 25%,rgba(255,107,53,.06) 50%,transparent 70%);animation:fire-breathe 1s ease-in-out infinite alternate;filter:blur(6px)}
.fire-glow2{position:absolute;bottom:-5%;left:50%;transform:translateX(-50%);width:50%;height:40%;background:radial-gradient(ellipse at 50% 100%,rgba(255,180,80,.3) 0%,rgba(255,107,53,.1) 40%,transparent 65%);animation:fire-breathe .7s ease-in-out infinite alternate-reverse;filter:blur(10px)}
.fire-speaker{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:3px;opacity:0;animation:fire-spk-in .8s ease .3s forwards}
.fire-spk-wave{width:12px;height:12px;border:1.5px solid var(--ac);border-radius:50%;opacity:.5;animation:fire-spk-pulse 1.2s ease infinite}
.fire-spk-wave:nth-child(2){width:20px;height:20px;animation-delay:.2s;opacity:.3}
.fire-spk-wave:nth-child(3){width:28px;height:28px;animation-delay:.4s;opacity:.15}
@keyframes fire-spk-in{to{opacity:1}}
@keyframes fire-spk-pulse{0%,100%{opacity:.2;transform:scale(.9)}50%{opacity:.7;transform:scale(1.1)}}
.fire-particles{position:absolute;bottom:0;left:0;right:0;height:100%;overflow:hidden}
.fire-p{position:absolute;bottom:-8px;border-radius:50%;filter:blur(1.5px);animation:fire-rise linear infinite}
.fire-p:nth-child(1){left:38%;width:5px;height:5px;background:#ff6b35;animation-duration:1.4s;animation-delay:0s}
.fire-p:nth-child(2){left:42%;width:3px;height:3px;background:#ffc060;animation-duration:1.7s;animation-delay:.2s}
.fire-p:nth-child(3){left:48%;width:7px;height:7px;background:#ff6b35;animation-duration:1.2s;animation-delay:.1s}
.fire-p:nth-child(4){left:52%;width:4px;height:4px;background:#ff3d71;animation-duration:1.6s;animation-delay:.35s}
.fire-p:nth-child(5){left:56%;width:5px;height:5px;background:#ffa060;animation-duration:1.3s;animation-delay:.15s}
.fire-p:nth-child(6){left:44%;width:3px;height:3px;background:#ff8f65;animation-duration:1.8s;animation-delay:.5s}
.fire-p:nth-child(7){left:50%;width:8px;height:8px;background:#ff6b35;animation-duration:1.1s;animation-delay:.25s}
.fire-p:nth-child(8){left:46%;width:4px;height:4px;background:#ffc060;animation-duration:1.5s;animation-delay:.4s}
.fire-p:nth-child(9){left:30%;width:3px;height:3px;background:#ff8f65;animation-duration:2s;animation-delay:.6s}
.fire-p:nth-child(10){left:65%;width:4px;height:4px;background:#ff6b35;animation-duration:1.9s;animation-delay:.3s}
.fire-p:nth-child(11){left:35%;width:5px;height:5px;background:#ff3d71;animation-duration:1.7s;animation-delay:.7s}
.fire-p:nth-child(12){left:60%;width:3px;height:3px;background:#ffa060;animation-duration:1.6s;animation-delay:.45s}
@keyframes fire-rise{0%{transform:translateY(0) scale(1);opacity:.9}30%{opacity:1}100%{transform:translateY(-50vh) scale(0);opacity:0}}
@keyframes fire-breathe{0%{opacity:.6;transform:translateX(-50%) scale(.95)}100%{opacity:1;transform:translateX(-50%) scale(1.05)}}
.fire-edge{position:absolute;bottom:0;height:3px;background:linear-gradient(90deg,transparent 20%,var(--ac),#fff,var(--ac),transparent 80%);filter:blur(1px);animation:fire-edge-pulse .8s ease-in-out infinite alternate}
.fire-edge.left{left:0;right:50%;border-radius:0 2px 0 0}
.fire-edge.right{left:50%;right:0;border-radius:2px 0 0 0}
@keyframes fire-edge-pulse{0%{opacity:.3;height:2px}100%{opacity:.9;height:5px}}

/* Sonic instruction ‚Äî phones touching */
.sonic-instruct{position:absolute;bottom:18%;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:.8rem;opacity:0;transition:opacity .5s;z-index:3}
.sonic-instruct.active{opacity:1}
.si-scene{position:relative;width:160px;height:80px;display:flex;align-items:center;justify-content:center}
.si-phone{position:absolute;width:50px;height:26px;border:1.5px solid var(--ac);border-radius:5px;background:rgba(255,107,53,.06)}
.si-phone.left{left:0;animation:si-slide-l 2s ease-in-out infinite}
.si-phone.right{right:0;animation:si-slide-r 2s ease-in-out infinite}
.si-phone .si-speaker{position:absolute;top:50%;transform:translateY(-50%);display:flex;gap:2px;align-items:center}
.si-phone.left .si-speaker{right:3px}
.si-phone.right .si-speaker{left:3px}
.si-spk-dot{width:2.5px;height:2.5px;border-radius:50%;background:var(--ac);opacity:.6}
.si-energy{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;gap:3px;align-items:center}
.si-arc{width:3px;height:10px;border-radius:2px;background:var(--ac);opacity:0;animation:si-arc-flash .6s ease infinite}
.si-arc:nth-child(1){height:6px;animation-delay:0s}
.si-arc:nth-child(2){height:12px;animation-delay:.15s}
.si-arc:nth-child(3){height:8px;animation-delay:.3s}
.si-arc:nth-child(4){height:14px;animation-delay:.1s}
.si-arc:nth-child(5){height:6px;animation-delay:.25s}
@keyframes si-arc-flash{0%{opacity:0;transform:scaleY(.5)}30%{opacity:.9;transform:scaleY(1.1)}60%{opacity:.4;transform:scaleY(.8)}100%{opacity:0;transform:scaleY(.3)}}
@keyframes si-slide-l{0%,100%{transform:translateX(0)}50%{transform:translateX(18px)}}
@keyframes si-slide-r{0%,100%{transform:translateX(0)}50%{transform:translateX(-18px)}}
.si-glow{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:20px;height:20px;border-radius:50%;background:radial-gradient(circle,rgba(255,107,53,.4),transparent 70%);animation:si-glow-pulse 1s ease-in-out infinite;filter:blur(4px)}
@keyframes si-glow-pulse{0%,100%{opacity:.3;transform:translate(-50%,-50%) scale(.8)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.5)}}
.si-label{font-size:.5rem;color:var(--t3);letter-spacing:.08em;text-transform:uppercase;opacity:.6}
.si-text{font-size:.72rem;color:var(--ac2);text-align:center;max-width:200px;line-height:1.5;font-weight:600;letter-spacing:.02em}
.si-text em{color:#fff;font-style:normal;font-weight:700}

.sonic-status{font-size:.72rem;color:var(--ac2);min-height:1.2em;transition:all .3s;opacity:0;text-align:center}
.sonic-status.active{opacity:1}

/* Network canvas behind button */
#opCanvas{position:absolute;inset:0;width:100%;height:100%;z-index:0}

/* Sidebar */
.op-sb-header{padding:.6rem .8rem;border-bottom:1px solid var(--b1);font-size:.68rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;font-weight:600;display:flex;justify-content:space-between}
.op-sb-list{flex:1;overflow-y:auto;padding:.4rem}
.op-checkin-item{display:flex;align-items:center;gap:.6rem;padding:.5rem .4rem;border-bottom:1px solid rgba(255,255,255,.03);animation:op-slide-in .6s cubic-bezier(.22,1,.36,1)}
@keyframes op-slide-in{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
.op-ci-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.58rem;font-weight:700;color:#fff;flex-shrink:0}
.op-ci-info{flex:1;min-width:0}
.op-ci-name{font-size:.72rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.op-ci-time{font-size:.55rem;color:var(--t3)}
.op-ci-badge{font-size:.5rem;padding:.1rem .3rem;border-radius:6px;font-weight:600;background:rgba(255,255,255,.04);color:var(--t3);border:1px solid var(--b1)}
.op-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:.8rem;color:var(--t3);padding:2rem}
.op-empty-ico{font-size:2rem;opacity:.4}
.op-empty-text{font-size:.68rem;text-align:center;line-height:1.6;max-width:200px}

/* Connection flash overlay */
.op-flash{position:fixed;inset:0;z-index:50;pointer-events:none;opacity:0}
</style>
</head>
<body>

<div class="op-login" id="opLogin">
  <h1>Touch<span>?</span></h1>
  <div class="op-login-sub">Painel Operacional<br>Check-in em tempo real para eventos e estabelecimentos</div>
  <button class="op-login-btn" onclick="opDoLogin()">Entrar com Google</button>
</div>

<div style="display:none" id="opApp">
  <div class="op-header">
    <div class="op-logo">Touch<span>?</span> Operador</div>
    <div class="op-stats">
      <div><span class="op-stat-num" id="opCount">0</span> check-ins</div>
      <div class="op-user" id="opUserName"></div>
    </div>
  </div>
  <div class="op-main">
    <div class="op-canvas-area">
      <canvas id="opCanvas"></canvas>
      <!-- FIRE OVERLAY ‚Äî exact copy from main app -->
      <div class="fire-overlay" id="fireOverlay">
        <div class="fire-glow"></div><div class="fire-glow2"></div>
        <div class="fire-particles"><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div><div class="fire-p"></div></div>
        <div class="fire-edge left"></div><div class="fire-edge right"></div>
        <div class="fire-speaker"><div class="fire-spk-wave"></div><div class="fire-spk-wave"></div><div class="fire-spk-wave"></div></div>
      </div>
      <!-- PHONES TOUCHING INSTRUCTION -->
      <div class="sonic-instruct" id="sonicInstruct">
        <div class="si-scene">
          <div class="si-phone left"><div class="si-speaker"><div class="si-spk-dot"></div><div class="si-spk-dot"></div><div class="si-spk-dot"></div></div></div>
          <div class="si-energy"><div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div><div class="si-arc"></div></div>
          <div class="si-glow"></div>
          <div class="si-phone right"><div class="si-speaker"><div class="si-spk-dot"></div><div class="si-spk-dot"></div><div class="si-spk-dot"></div></div></div>
        </div>
        <div class="si-label">üîä alto-falante ‚Üî alto-falante üîä</div>
        <div class="si-text">Encoste o <em>celular</em> no<br><em>alto-falante</em> do computador</div>
      </div>
      <!-- TOUCH BUTTON ‚Äî exact copy from main app -->
      <div class="op-btn-area">
        <div style="position:relative;display:flex;align-items:center;justify-content:center">
          <div class="sonic-bars left" id="sonicBarsL"><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div></div>
          <button class="be" id="opTouchBtn" onclick="opToggleTouch()">
            <span class="be-text" id="opBtnText">TOUCH</span>
          </button>
          <div class="sonic-bars right" id="sonicBarsR"><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div><div class="sonic-bar"></div></div>
        </div>
        <div class="sonic-status" id="opStatus"></div>
      </div>
    </div>
    <div class="op-sidebar">
      <div class="op-sb-header"><span>Check-ins</span><span id="opListCount">0</span></div>
      <div class="op-sb-list" id="opList">
        <div class="op-empty" id="opEmpty">
          <div class="op-empty-ico">üì°</div>
          <div class="op-empty-text">Ative o TOUCH para come√ßar.<br>As pessoas encostam o celular e aparecem aqui.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<canvas class="op-flash" id="opFlash"></canvas>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
const S={userId:null,userName:null,userColor:null,socket:null,checkins:[]};
let homeSonicActive=false,sonicActive=false,sonicMyFreq=0;
let sonicEmitCtx=null,sonicOsc=null,sonicStream=null,sonicMicCtx=null,sonicAnalyser=null,sonicAnimFrame=null;
let sonicKeepAlive=null,audioCtx=null;
const SONIC_FFT_SIZE=8192,SONIC_DETECT_THRESHOLD=80,SONIC_CONFIRM_COUNT=3;

function $(id){return document.getElementById(id)}

// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
(async function(){
  const r=await fetch('/api/firebase-config');const cfg=await r.json();
  firebase.initializeApp(cfg);
  firebase.auth().onAuthStateChanged(async user=>{
    if(user){
      // CRITICAL: Ensure user exists in database via /api/auth/link
      // Without this, sonic-start is rejected because db.users[userId] is null
      try{
        const linkRes=await fetch('/api/auth/link',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({firebaseUid:user.uid,email:user.email,displayName:user.displayName,photoURL:user.photoURL})});
        const linkData=await linkRes.json();
        S.userId=linkData.userId; // Use the ENCOSTA userId (not Firebase uid)
        S.userName=linkData.user?.nickname||linkData.user?.name||user.displayName||'Operador';
        S.userColor=linkData.user?.color||'#6366f1';
        console.log('[operator] Auth linked:',S.userId,'name:',S.userName,'linked:',linkData.linked);
      }catch(e){
        console.error('[operator] Auth link failed:',e);
        // Fallback: try GET
        S.userId=user.uid;
        try{const ur=await fetch('/api/user/'+user.uid);const ud=await ur.json();S.userName=ud.nickname||ud.name||user.displayName||'Operador';S.userColor=ud.color||'#6366f1'}
        catch(e2){S.userName=user.displayName||'Operador';S.userColor='#6366f1'}
      }
      $('opLogin').style.display='none';$('opApp').style.display='';
      $('opUserName').textContent=S.userName;
      initSocket();initCanvas();loadExisting();
    }else{$('opLogin').style.display='';$('opApp').style.display='none'}
  });
})();
function opDoLogin(){firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert('Erro: '+e.message))}

// ‚ïê‚ïê‚ïê SOCKET ‚ïê‚ïê‚ïê
function initSocket(){
  S.socket=io({reconnection:true,reconnectionDelay:1000});
  S.socket.on('connect',()=>{
    if(S.userId)S.socket.emit('identify',S.userId);
    // On reconnect: re-register in queue AND update oscillator to new freq
    if(homeSonicActive){
      S.socket.emit('sonic-start',{userId:S.userId,isCheckin:true});
      S.socket.once('sonic-assigned',({freq})=>{
        sonicMyFreq=freq;
        if(sonicOsc&&sonicEmitCtx){try{sonicOsc.frequency.setValueAtTime(freq,sonicEmitCtx.currentTime)}catch(e){}}
      });
    }
  });
  // Use checkin-created as the primary event (avoids duplicates with relation-created)
  S.socket.on('checkin-created',d=>{handleNewCheckin(d)});
  // relation-created: only handle on the PHONE side, not operator
  // (operator gets checkin-created which has the visitor's data already)
  S.socket.on('sonic-matched',()=>{
    // Operator STAYS in sonicQueue after connection (server keeps it).
    // Do NOT re-register ‚Äî that would assign a new freq while oscillator plays old freq.
    // Just update joinedAt to prevent timeout cleanup:
    if(homeSonicActive&&S.socket&&S.socket.connected){
      // Re-register with same freq by telling server to keep us alive
      // We DON'T call sonic-start (which would assign new freq)
      // Instead, server already keeps operator in queue. Nothing to do.
      console.log('[operator] sonic-matched: staying in queue, continuing detection');
    }
  });
}

// ‚ïê‚ïê‚ïê SONIC ‚Äî COPIED EXACTLY FROM MAIN APP ‚ïê‚ïê‚ïê
async function requestMic(){
  return navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
}

async function opToggleTouch(){
  if(homeSonicActive){stopHomeSonic();return}
  if(!S.socket||!S.socket.connected){alert('Sem conex√£o. Aguarde...');return}

  // RESET: kill any leftover audio/mic state
  stopSonicMode();

  homeSonicActive=true;
  sonicActive=true;sonicMyFreq=0;
  const btn=$('opTouchBtn'),txt=$('opBtnText'),sts=$('opStatus');
  const barsL=$('sonicBarsL'),barsR=$('sonicBarsR'),fire=$('fireOverlay');
  const si=$('sonicInstruct');
  btn.classList.add('energized');
  txt.textContent='ATIVANDO...';
  // ALWAYS request fresh mic
  if(sonicStream){sonicStream.getTracks().forEach(t=>t.stop());sonicStream=null;}
  if(sonicMicCtx){try{sonicMicCtx.close()}catch(e){} sonicMicCtx=null;}
  if(sonicEmitCtx){try{sonicEmitCtx.close()}catch(e){} sonicEmitCtx=null;}
  sts.textContent='Pedindo microfone...';sts.classList.add('active');
  barsL.classList.add('active');barsR.classList.add('active');
  if(fire)fire.classList.add('active');
  if(si)si.classList.add('active');

  try{
    // 1. Fresh mic permission
    sonicStream=await requestMic();
    if(!homeSonicActive)return;
    sts.textContent='Conectando ao servidor...';

    // 2. Get frequency
    S.socket.emit('sonic-start',{userId:S.userId,isCheckin:true});
    const freq=await new Promise((resolve,reject)=>{
      const t=setTimeout(()=>reject(new Error('Timeout')),8000);
      S.socket.once('sonic-assigned',({freq})=>{clearTimeout(t);resolve(freq)});
    });
    if(!homeSonicActive)return;
    sonicMyFreq=freq;

    // 3. Emit ultrasonic ‚Äî USE SAME AudioContext for BOTH emit and mic
    // (single context avoids Chrome issues with multiple contexts)
    sonicEmitCtx=new(window.AudioContext||window.webkitAudioContext)();
    if(sonicEmitCtx.state==='suspended')await sonicEmitCtx.resume();
    console.log('[operator] EmitCtx state:',sonicEmitCtx.state,'sampleRate:',sonicEmitCtx.sampleRate);

    // Play brief AUDIBLE confirmation beep so user knows speaker works
    const confirmOsc=sonicEmitCtx.createOscillator();
    const confirmGain=sonicEmitCtx.createGain();
    confirmOsc.connect(confirmGain);confirmGain.connect(sonicEmitCtx.destination);
    confirmOsc.type='sine';confirmOsc.frequency.setValueAtTime(880,sonicEmitCtx.currentTime);
    confirmGain.gain.setValueAtTime(0.15,sonicEmitCtx.currentTime);
    confirmGain.gain.linearRampToValueAtTime(0,sonicEmitCtx.currentTime+0.3);
    confirmOsc.start();confirmOsc.stop(sonicEmitCtx.currentTime+0.3);

    // Start ultrasonic oscillator
    sonicOsc=sonicEmitCtx.createOscillator();
    sonicOsc.type='sine';
    sonicOsc.frequency.setValueAtTime(freq,sonicEmitCtx.currentTime);
    const gain=sonicEmitCtx.createGain();
    gain.gain.setValueAtTime(1.0,sonicEmitCtx.currentTime);
    sonicOsc.connect(gain);gain.connect(sonicEmitCtx.destination);
    sonicOsc.start();
    console.log('[operator] Oscillator started at',freq,'Hz, gain:1.0, ctxState:',sonicEmitCtx.state);

    // 4. Start detection ‚Äî use SEPARATE context for mic
    sonicMicCtx=new(window.AudioContext||window.webkitAudioContext)();
    if(sonicMicCtx.state==='suspended')await sonicMicCtx.resume();
    const source=sonicMicCtx.createMediaStreamSource(sonicStream);
    sonicAnalyser=sonicMicCtx.createAnalyser();
    sonicAnalyser.fftSize=SONIC_FFT_SIZE;
    sonicAnalyser.smoothingTimeConstant=0.3;
    source.connect(sonicAnalyser);
    const bufLen=sonicAnalyser.frequencyBinCount;
    const dataArr=new Uint8Array(bufLen);
    const sampleRate=sonicMicCtx.sampleRate;
    const freqPerBin=sampleRate/SONIC_FFT_SIZE;
    console.log('[operator] MicCtx state:',sonicMicCtx.state,'sampleRate:',sampleRate,'freqPerBin:',freqPerBin.toFixed(2),'nyquist:',sampleRate/2);

    txt.textContent='EMITINDO...';
    sts.textContent='Encoste o celular no alto-falante üîä';
    console.log('[operator] Sonic ACTIVE ‚Äî emitting freq:',freq,'Hz, detecting range: 18000-20000Hz');

    // Keep alive
    sonicKeepAlive=setInterval(()=>{
      if(sonicEmitCtx&&sonicEmitCtx.state==='suspended'){sonicEmitCtx.resume();console.log('[operator] Resumed emitCtx')}
      if(sonicMicCtx&&sonicMicCtx.state==='suspended'){sonicMicCtx.resume();console.log('[operator] Resumed micCtx')}
    },3000);

    // 5. Detection loop ‚Äî operator mode: does NOT stop on detect, just cooldown
    let confirmHits=0,lastSnapped=0,cooldown=0,debugCounter=0;
    function detect(){
      if(!sonicActive)return;
      if(cooldown>0){cooldown--;sonicAnimFrame=requestAnimationFrame(detect);return}
      sonicAnalyser.getByteFrequencyData(dataArr);
      const minBin=Math.floor(18000/freqPerBin),maxBin=Math.ceil(20000/freqPerBin);
      let peakVal=0,peakBin=0;
      for(let i=minBin;i<=maxBin&&i<bufLen;i++){if(dataArr[i]>peakVal){peakVal=dataArr[i];peakBin=i}}

      // Log peak every ~2 seconds (120 frames) so we can see what mic picks up
      debugCounter++;
      if(debugCounter%120===0){
        const peakFreq=Math.round(peakBin*freqPerBin);
        console.log('[operator-mic] peak:',peakVal,'at',peakFreq,'Hz (bin:'+peakBin+') | threshold:',SONIC_DETECT_THRESHOLD,'| myFreq:',sonicMyFreq,'| emitCtx:',sonicEmitCtx?sonicEmitCtx.state:'null','| micCtx:',sonicMicCtx?sonicMicCtx.state:'null');
      }

      if(peakVal>=SONIC_DETECT_THRESHOLD){
        const snapped=Math.round(Math.round(peakBin*freqPerBin)/100)*100;
        if(snapped!==sonicMyFreq&&snapped>=18000&&snapped<=19900){
          if(snapped===lastSnapped)confirmHits++;else{confirmHits=1;lastSnapped=snapped}
          console.log('[operator] Hit! snapped:',snapped,'peak:',peakVal,'confirmHits:',confirmHits,'/',SONIC_CONFIRM_COUNT);
          if(confirmHits>=SONIC_CONFIRM_COUNT){
            // DETECTED! But don't stop ‚Äî operator keeps listening
            console.log('[operator] ‚òÖ DETECTED freq:',snapped,'Hz (peak:',peakVal,') ‚Äî sending sonic-detected');
            S.socket.emit('sonic-detected',{userId:S.userId,detectedFreq:snapped});
            confirmHits=0;lastSnapped=0;
            cooldown=90; // ~1.5s at 60fps
            // Flash green
            btn.classList.add('connected');
            setTimeout(()=>{if(homeSonicActive){btn.classList.remove('connected');btn.classList.add('energized')}},1200);
          }
        }
      }else if(confirmHits>0)confirmHits=Math.max(0,confirmHits-1);
      sonicAnimFrame=requestAnimationFrame(detect);
    }
    detect();

  }catch(e){
    console.error('Sonic error:',e);
    sts.textContent=e.name==='NotAllowedError'?'‚ö† Permiss√£o do microfone negada':'Erro: '+e.message;
    btn.classList.remove('energized');
    txt.textContent='TOUCH';
    stopHomeSonic();
  }
}

function stopSonicMode(){
  sonicActive=false;
  if(sonicOsc){try{sonicOsc.stop()}catch(e){}}
  if(sonicEmitCtx){try{sonicEmitCtx.close()}catch(e){}}
  if(sonicMicCtx){try{sonicMicCtx.close()}catch(e){}}
  if(sonicStream){sonicStream.getTracks().forEach(t=>t.stop())}
  if(sonicAnimFrame)cancelAnimationFrame(sonicAnimFrame);
  sonicOsc=null;sonicEmitCtx=null;sonicMicCtx=null;sonicStream=null;sonicAnalyser=null;sonicAnimFrame=null;sonicMyFreq=0;
  if(sonicKeepAlive){clearInterval(sonicKeepAlive);sonicKeepAlive=null}
  if(S.socket&&S.socket.connected)S.socket.emit('sonic-stop',{userId:S.userId});
}

function stopHomeSonic(){
  homeSonicActive=false;
  stopSonicMode();
  const btn=$('opTouchBtn'),txt=$('opBtnText'),sts=$('opStatus');
  const barsL=$('sonicBarsL'),barsR=$('sonicBarsR'),fire=$('fireOverlay');
  const si=$('sonicInstruct');
  btn.classList.remove('energized','connected');
  txt.textContent='TOUCH';
  sts.textContent='';sts.classList.remove('active');
  barsL.classList.remove('active');barsR.classList.remove('active');
  if(fire)fire.classList.remove('active');
  if(si)si.classList.remove('active');
}

// ‚ïê‚ïê‚ïê CHECK-IN HANDLER ‚ïê‚ïê‚ïê
function handleNewCheckin(d){
  addCheckinToList(d);
  addNodeToCanvas(d);
  playConnectionShow(d);
  playBeep();
}

function addCheckinToList(d){
  S.checkins.unshift(d);
  $('opCount').textContent=S.checkins.length;
  $('opListCount').textContent=S.checkins.length;
  $('opEmpty').style.display='none';
  const sts=$('opStatus');
  sts.textContent='‚úì '+(d.nickname||'Algu√©m')+' conectou!';
  setTimeout(()=>{if(homeSonicActive){sts.textContent='Encoste o celular no alto-falante üîä'}},3000);
  const list=$('opList');
  const item=document.createElement('div');item.className='op-checkin-item';
  const time=new Date(d.timestamp||Date.now());
  const ts=time.getHours().toString().padStart(2,'0')+':'+time.getMinutes().toString().padStart(2,'0');
  const col=d.color||nickColor(d.nickname||'?');
  item.innerHTML='<div class="op-ci-avatar" style="background:'+col+'">'+ini(d.nickname||'?')+'</div><div class="op-ci-info"><div class="op-ci-name">'+esc(d.nickname||'Visitante')+'</div><div class="op-ci-time">'+ts+'</div></div><div class="op-ci-badge">check-in</div>';
  list.prepend(item);
}

// ‚ïê‚ïê‚ïê CONNECTION SHOW ‚Äî lightning + shockwave ‚ïê‚ïê‚ïê
function playConnectionShow(d){
  const flash=$('opFlash');if(!flash)return;
  const W=window.innerWidth,H=window.innerHeight;
  flash.width=W;flash.height=H;flash.style.width=W+'px';flash.style.height=H+'px';flash.style.opacity='1';
  const c=flash.getContext('2d');
  const t0=performance.now(),dur=2800;
  function bolt(x0,y0,x1,y1){
    const pts=[{x:x0,y:y0}];const segs=5+Math.floor(Math.random()*5);
    for(let i=1;i<segs;i++){const t=i/segs;const spread=(1-Math.abs(t-.5)*2)*50;pts.push({x:x0+(x1-x0)*t+(Math.random()-.5)*spread,y:y0+(y1-y0)*t+(Math.random()-.5)*spread})}
    pts.push({x:x1,y:y1});return pts;
  }
  function drawB(pts,a,w){
    c.beginPath();c.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)c.lineTo(pts[i].x,pts[i].y);
    c.strokeStyle='rgba(52,211,153,'+(a*.4)+')';c.lineWidth=w*3;c.lineCap='round';c.stroke();
    c.beginPath();c.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)c.lineTo(pts[i].x,pts[i].y);
    c.strokeStyle='rgba(52,211,153,'+a+')';c.lineWidth=w;c.stroke();
    c.beginPath();c.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)c.lineTo(pts[i].x,pts[i].y);
    c.strokeStyle='rgba(255,255,255,'+(a*.9)+')';c.lineWidth=Math.max(.5,w*.3);c.stroke();
  }
  const sparks=[];for(let i=0;i<30;i++){const a=Math.random()*Math.PI*2;const sp=2+Math.random()*6;sparks.push({x:W/2,y:H/2,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,r:1+Math.random()*2,life:1})}
  let bolts=[],frame=0;
  function genBolts(){bolts=[];for(let i=0;i<6;i++){const a=Math.random()*Math.PI*2;const l=100+Math.random()*250;bolts.push(bolt(W/2,H/2,W/2+Math.cos(a)*l,H/2+Math.sin(a)*l))}}
  function animate(){
    const p=(performance.now()-t0)/dur;
    if(p>=1){c.clearRect(0,0,W,H);flash.style.opacity='0';return}
    c.clearRect(0,0,W,H);
    if(p<.3){const q=p/.3;c.fillStyle='rgba(255,255,255,'+Math.max(0,(1-q)*.5)+')';c.fillRect(0,0,W,H);
      const rr=q*Math.max(W,H)*.6;const ra=(1-q)*.6;c.beginPath();c.arc(W/2,H/2,rr,0,Math.PI*2);c.strokeStyle='rgba(52,211,153,'+ra+')';c.lineWidth=3+ra*8;c.stroke();
      const ig=c.createRadialGradient(W/2,H/2,0,W/2,H/2,rr*.6);ig.addColorStop(0,'rgba(52,211,153,'+(ra*.3)+')');ig.addColorStop(1,'transparent');c.fillStyle=ig;c.fillRect(0,0,W,H)}
    if(p>.05&&p<.6){if(frame%3===0)genBolts();const a=(1-(p-.05)/.55)*.8;bolts.forEach(b=>{drawB(b,a,1.5+Math.random())})}
    if(p<.8){sparks.forEach(s=>{s.x+=s.vx;s.y+=s.vy;s.vy+=.08;s.vx*=.99;s.life=Math.max(0,1-p/.8);
      if(s.life>0){c.beginPath();c.arc(s.x,s.y,s.r*s.life,0,Math.PI*2);c.fillStyle='rgba(52,211,153,'+s.life+')';c.fill();
        c.beginPath();c.moveTo(s.x,s.y);c.lineTo(s.x-s.vx*3,s.y-s.vy*3);c.strokeStyle='rgba(52,211,153,'+(s.life*.4)+')';c.lineWidth=s.r*.5;c.stroke()}})}
    if(p>.15){const tp=Math.min(1,(p-.15)/.3);const fo=p>.7?Math.max(0,1-(p-.7)/.3):1;
      c.save();c.globalAlpha=tp*fo;c.font='700 '+Math.min(28,W*.04)+'px Inter';c.textAlign='center';c.textBaseline='middle';
      c.fillStyle='#34d399';c.shadowColor='rgba(52,211,153,.6)';c.shadowBlur=20;
      c.fillText((d.nickname||'Visitante')+' ‚úì',W/2,H/2);c.restore()}
    frame++;requestAnimationFrame(animate);
  }
  genBolts();animate();
}

// ‚ïê‚ïê‚ïê LOAD EXISTING ‚ïê‚ïê‚ïê
async function loadExisting(){
  try{
    const r=await fetch('/api/operator/checkins/'+S.userId);const d=await r.json();
    if(d.checkins&&d.checkins.length>0){
      $('opEmpty').style.display='none';
      d.checkins.forEach(c=>{
        S.checkins.push(c);
        const list=$('opList');const item=document.createElement('div');
        item.className='op-checkin-item';item.style.animation='none';
        const time=new Date(c.timestamp);
        const ts=time.getHours().toString().padStart(2,'0')+':'+time.getMinutes().toString().padStart(2,'0');
        const col=c.withColor||nickColor(c.withName||'?');
        item.innerHTML='<div class="op-ci-avatar" style="background:'+col+'">'+ini(c.withName||'?')+'</div><div class="op-ci-info"><div class="op-ci-name">'+esc(c.withName||'Visitante')+'</div><div class="op-ci-time">'+ts+'</div></div><div class="op-ci-badge">check-in</div>';
        list.appendChild(item);
        addNodeToCanvas({nickname:c.withName,color:c.withColor},true);
      });
      $('opCount').textContent=S.checkins.length;$('opListCount').textContent=S.checkins.length;
    }
  }catch(e){}
}

// ‚ïê‚ïê‚ïê NETWORK CANVAS ‚ïê‚ïê‚ïê
let cvCtx=null,cvW=0,cvH=0,cvAnim=null;
const nodes=[],ambientP=[];

function initCanvas(){
  const cv=$('opCanvas');const rect=cv.parentElement.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  cvW=rect.width;cvH=rect.height;
  cv.width=cvW*dpr;cv.height=cvH*dpr;cv.style.width=cvW+'px';cv.style.height=cvH+'px';
  cvCtx=cv.getContext('2d');cvCtx.scale(dpr,dpr);
  for(let i=0;i<50;i++)ambientP.push({x:Math.random()*cvW,y:Math.random()*cvH,r:.5+Math.random()*1.5,vx:(Math.random()-.5)*.1,vy:(Math.random()-.5)*.1,a:.03+Math.random()*.12,phase:Math.random()*Math.PI*2});
  renderCanvas();
}

function addNodeToCanvas(d,instant){
  const idx=nodes.length;const ga=2.399963;const angle=idx*ga;
  const maxR=Math.min(cvW,cvH)*0.3;const dist=50+Math.sqrt(idx+1)*maxR*0.13;
  const cx=cvW/2,cy=cvH/2-20;
  nodes.push({x:cx+Math.cos(angle)*dist,y:cy+Math.sin(angle)*dist,r:instant?9:0,targetR:8+Math.random()*5,color:d.color||nickColor(d.nickname||'?'),name:d.nickname||'?',phase:Math.random()*Math.PI*2,glow:instant?0:1,entryAngle:angle,entryDist:dist,orbit:0,orbitV:.0003+Math.random()*.0003});
}

function renderCanvas(){
  if(!cvCtx)return;const c=cvCtx;c.clearRect(0,0,cvW,cvH);const t=Date.now()/1000;
  const cx=cvW/2,cy=cvH/2-20;
  // Ambient particles
  ambientP.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=cvW;if(p.x>cvW)p.x=0;if(p.y<0)p.y=cvH;if(p.y>cvH)p.y=0;
    c.beginPath();c.arc(p.x,p.y,p.r,0,Math.PI*2);c.fillStyle='rgba(255,255,255,'+Math.max(0,p.a+Math.sin(t*1.5+p.phase)*.03)+')';c.fill()});
  // Connection lines
  nodes.forEach(n=>{if(n.r<1)return;n.orbit+=n.orbitV;const a=n.entryAngle+n.orbit;n.x=cx+Math.cos(a)*n.entryDist;n.y=cy+Math.sin(a)*n.entryDist;
    const la=.06+Math.sin(t*.8+n.phase)*.03;c.beginPath();c.moveTo(cx,cy);c.lineTo(n.x,n.y);c.strokeStyle='rgba(99,102,241,'+la+')';c.lineWidth=.8;c.stroke();
    const pt=(t*.5+n.phase)%1;c.beginPath();c.arc(cx+(n.x-cx)*pt,cy+(n.y-cy)*pt,1.5,0,Math.PI*2);c.fillStyle='rgba(99,102,241,.25)';c.fill()});
  // Center node
  const cs=20+Math.sin(t*2)*1.5;
  c.beginPath();c.arc(cx,cy,cs,0,Math.PI*2);c.fillStyle=homeSonicActive?'#ff6b35':(S.userColor||'#6366f1');c.fill();c.strokeStyle='rgba(255,255,255,.15)';c.lineWidth=1.5;c.stroke();
  c.fillStyle='#fff';c.font='700 9px Inter';c.textAlign='center';c.textBaseline='middle';c.fillText(ini(S.userName||'OP'),cx,cy);
  // Person nodes
  nodes.forEach(n=>{if(n.r<n.targetR)n.r=Math.min(n.targetR,n.r+.3);const pulse=1+Math.sin(t*1.2+n.phase)*.04;const r=n.r*pulse;
    if(n.glow>0){const gr=r*5*n.glow;const g=c.createRadialGradient(n.x,n.y,0,n.x,n.y,gr);g.addColorStop(0,hexA(n.color,.3*n.glow));g.addColorStop(1,'rgba(0,0,0,0)');c.fillStyle=g;c.beginPath();c.arc(n.x,n.y,gr,0,Math.PI*2);c.fill();n.glow=Math.max(0,n.glow-.005)}
    c.beginPath();c.arc(n.x,n.y,r,0,Math.PI*2);c.fillStyle=n.color;c.fill();c.strokeStyle='rgba(255,255,255,.1)';c.lineWidth=.8;c.stroke();
    if(r>5){c.fillStyle='#fff';c.font='600 '+(r*.6)+'px Inter';c.textAlign='center';c.textBaseline='middle';c.fillText(ini(n.name),n.x,n.y+.5)}
    if(r>7){c.fillStyle='rgba(255,255,255,.25)';c.font='400 6.5px Inter';c.fillText(n.name.length>12?n.name.slice(0,12)+'‚Ä¶':n.name,n.x,n.y+r+9)}});
  cvAnim=requestAnimationFrame(renderCanvas);
}
window.addEventListener('resize',()=>{if($('opApp').style.display!=='none'){if(cvAnim)cancelAnimationFrame(cvAnim);initCanvas()}});

// ‚ïê‚ïê‚ïê AUDIO ‚ïê‚ïê‚ïê
function playBeep(){
  if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended')audioCtx.resume();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sine';
  const tm=audioCtx.currentTime;o.frequency.setValueAtTime(523,tm);o.frequency.linearRampToValueAtTime(659,tm+.08);o.frequency.linearRampToValueAtTime(784,tm+.16);o.frequency.linearRampToValueAtTime(1047,tm+.25);
  g.gain.setValueAtTime(.12,tm);g.gain.linearRampToValueAtTime(.18,tm+.15);g.gain.linearRampToValueAtTime(0,tm+.5);o.start(tm);o.stop(tm+.5);
}

// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function ini(n){if(!n)return'?';const p=n.trim().split(/\s+/);return p.length>1?(p[0][0]+p[1][0]).toUpperCase():n.slice(0,2).toUpperCase()}
function nickColor(n){let h=0;for(let i=0;i<n.length;i++)h=n.charCodeAt(i)+((h<<5)-h);return'hsl('+Math.abs(h%360)+',65%,45%)'}
function hexA(color,alpha){
  if(!color)return'rgba(99,102,241,'+alpha+')';
  if(color.startsWith('hsl'))return color.replace('hsl','hsla').replace(')',','+alpha+')');
  if(color.startsWith('#')){const h=color.replace('#','');return'rgba('+(parseInt(h.substr(0,2),16)||99)+','+(parseInt(h.substr(2,2),16)||102)+','+(parseInt(h.substr(4,2),16)||241)+','+alpha+')'}
  return'rgba(99,102,241,'+alpha+')';
}
</script>
</body>
</html>
